<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DeriveGeneric              #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies         #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE GADTs                      #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings          #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables        #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Marconi.ChainIndex.Indexers.ScriptTx</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../bytestring/html/src"><span class="hs-identifier">Data.ByteString</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">foldl'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">toList</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">catMaybes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier">Database.SQLite.Simple</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SQL</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier">Database.SQLite.Simple.FromField</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SQL</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier">Database.SQLite.Simple.ToField</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SQL</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Cardano.Api</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">BlockHeader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">ChainPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">ChainPoint</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">ChainPointAtGenesis</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Hash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier">SlotNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Cardano.Api</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Cardano.Api.Shelley</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Shelley</span></span><span>
</span><span id="line-21"></span><span class="hs-comment">-- TODO Remove the following dependencies (and also cardano-ledger-*</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- package dependencies in cabal file) when fromShelleyBasedScript is</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- exported from cardano-node PR:</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- https://github.com/input-output-hk/cardano-node/pull/4386</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier">Cardano.Ledger.Alonzo.Language</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Alonzo</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier">Cardano.Ledger.Alonzo.Scripts</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Alonzo</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Core</span></a></span><span> </span><span class="hs-keyword">qualified</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Crypto</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LedgerCrypto</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Keys</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LedgerShelley</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier">Cardano.Ledger.Shelley.Scripts</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LedgerShelley</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-shelley-ma/html/src"><span class="hs-identifier">Cardano.Ledger.ShelleyMA.Timelocks</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Timelock</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Orphans.html"><span class="hs-identifier">Marconi.ChainIndex.Orphans</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Types.html"><span class="hs-identifier">Marconi.ChainIndex.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Marconi.Core.Storable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Buffered</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">getStoredEvents</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">persistToStorage</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">HasPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">getPoint</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>                              </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">QueryInterval</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">QEverything</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">QInterval</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Queryable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">queryStorage</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>                              </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Resumable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">resumeFromStorage</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Rewindable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">rewindStorage</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableEvent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableMonad</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>                              </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorablePoint</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableQuery</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">emptyState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">filterWithQueryInterval</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Marconi.Core.Storable</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Storable</span></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-comment">{- The first thing that we need to define for a new indexer is the `handler` data
   type, meant as a wrapper for the connection type (in this case the SQLite
   connection).

   However this is a very good place to add some more configurations
   that the indexer may require (for example performance tuning settings). In our
   case we add the number of events that we want to return from the on-disk buffer -}</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">data</span><span> </span><span id="ScriptTxHandle"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-var">ScriptTxHandle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ScriptTxHandle"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-var">ScriptTxHandle</span></a></span></span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="hdlConnection"><span class="annot"><span class="annottext">ScriptTxHandle -&gt; Connection
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#hdlConnection"><span class="hs-identifier hs-var hs-var">hdlConnection</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-type">SQL.Connection</span></a></span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="hdlDepth"><span class="annot"><span class="annottext">ScriptTxHandle -&gt; Int
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#hdlDepth"><span class="hs-identifier hs-var hs-var">hdlDepth</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-comment">{- The next step is to define the data types that make up the indexer. There are
   5 of these and they depend on the handle that we previously defined. We make use
   of this semantic dependency by using type and data families that connect these
   types to the `handle` that was previously defined.

   If you want to consider semantics, you can think of the `handle` type as identifying
   both the database connection type and the database structure. Thinking of it this
   way makes the reason for the dependency clearer.

   The first type we introduce is the monad in which the database (and by extension,
   the indexer) runs. -}</span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="StorableMonad"><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">StorableMonad</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-comment">{- The next type we introduce is the type of events. Events are the data atoms that
   the indexer consumes. They depend on the `handle` because they need to eventually
   be persisted in the database, so the database has to be able to accomodate them.

   The original implementation used two spearate data structures for storing data
   in memory vs. on-disk. It has the advantage of a better usage of memory and the
   disadvantage of complicating the implementation quite a bit. I am leaving it as-is
   for now, as this is more of a tutorial implementation and complicating things
   may have some educational value. -}</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="StorableEvent"><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">StorableEvent</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ScriptTxEvent"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxEvent"><span class="hs-identifier hs-var">ScriptTxEvent</span></a></span></span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="txScripts"><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle
-&gt; [(TxCbor, [StorableQuery ScriptTxHandle])]
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#txScripts"><span class="hs-identifier hs-var hs-var">txScripts</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#TxCbor"><span class="hs-identifier hs-type">TxCbor</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="chainPoint"><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle -&gt; ChainPoint
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#chainPoint"><span class="hs-identifier hs-var hs-var">chainPoint</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ChainPoint</span></a></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679482524"><span id="local-6989586621679482526"><span id="local-6989586621679482528"><span class="annot"><span class="annottext">Int -&gt; StorableEvent ScriptTxHandle -&gt; ShowS
[StorableEvent ScriptTxHandle] -&gt; ShowS
StorableEvent ScriptTxHandle -&gt; String
(Int -&gt; StorableEvent ScriptTxHandle -&gt; ShowS)
-&gt; (StorableEvent ScriptTxHandle -&gt; String)
-&gt; ([StorableEvent ScriptTxHandle] -&gt; ShowS)
-&gt; Show (StorableEvent ScriptTxHandle)
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [StorableEvent ScriptTxHandle] -&gt; ShowS
$cshowList :: [StorableEvent ScriptTxHandle] -&gt; ShowS
show :: StorableEvent ScriptTxHandle -&gt; String
$cshow :: StorableEvent ScriptTxHandle -&gt; String
showsPrec :: Int -&gt; StorableEvent ScriptTxHandle -&gt; ShowS
$cshowsPrec :: Int -&gt; StorableEvent ScriptTxHandle -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">{- The resume and query functionality requires a way to specify points on the chain
   from which we want to resume, or points up to which we want to query. Next we
   define the types of these points. -}</span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="StorablePoint"><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">StorablePoint</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ChainPoint</span></a></span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-comment">-- We also need to know at which slot number an event was produced.</span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">HasPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ChainPoint</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-91"></span><span>  </span><span id="local-6989586621679482520"><span class="annot"><span class="annottext">getPoint :: StorableEvent ScriptTxHandle -&gt; ChainPoint
</span><a href="#local-6989586621679482520"><span class="hs-identifier hs-var hs-var hs-var hs-var">getPoint</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxEvent"><span class="hs-identifier hs-type">ScriptTxEvent</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679482519"><span class="annot"><a href="#local-6989586621679482519"><span class="hs-identifier hs-var">cp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679482519"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-comment">{- Next we begin to defined the types required for running queries. Both request and
   response types will depend naturally on the structure of the database, which is
   identified by our `handle`. First, lets define the type for queries (or requests). -}</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-keyword">newtype</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="StorableQuery"><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">StorableQuery</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ScriptTxAddress"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxAddress"><span class="hs-identifier hs-var">ScriptTxAddress</span></a></span></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Shelley.ScriptHash</span></a></span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679482512"><span id="local-6989586621679482514"><span id="local-6989586621679482516"><span class="annot"><span class="annottext">Int -&gt; StorableQuery ScriptTxHandle -&gt; ShowS
[StorableQuery ScriptTxHandle] -&gt; ShowS
StorableQuery ScriptTxHandle -&gt; String
(Int -&gt; StorableQuery ScriptTxHandle -&gt; ShowS)
-&gt; (StorableQuery ScriptTxHandle -&gt; String)
-&gt; ([StorableQuery ScriptTxHandle] -&gt; ShowS)
-&gt; Show (StorableQuery ScriptTxHandle)
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [StorableQuery ScriptTxHandle] -&gt; ShowS
$cshowList :: [StorableQuery ScriptTxHandle] -&gt; ShowS
show :: StorableQuery ScriptTxHandle -&gt; String
$cshow :: StorableQuery ScriptTxHandle -&gt; String
showsPrec :: Int -&gt; StorableQuery ScriptTxHandle -&gt; ShowS
$cshowsPrec :: Int -&gt; StorableQuery ScriptTxHandle -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679482508"><span id="local-6989586621679482510"><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
-&gt; StorableQuery ScriptTxHandle -&gt; Bool
(StorableQuery ScriptTxHandle
 -&gt; StorableQuery ScriptTxHandle -&gt; Bool)
-&gt; (StorableQuery ScriptTxHandle
    -&gt; StorableQuery ScriptTxHandle -&gt; Bool)
-&gt; Eq (StorableQuery ScriptTxHandle)
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: StorableQuery ScriptTxHandle
-&gt; StorableQuery ScriptTxHandle -&gt; Bool
$c/= :: StorableQuery ScriptTxHandle
-&gt; StorableQuery ScriptTxHandle -&gt; Bool
== :: StorableQuery ScriptTxHandle
-&gt; StorableQuery ScriptTxHandle -&gt; Bool
$c== :: StorableQuery ScriptTxHandle
-&gt; StorableQuery ScriptTxHandle -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">-- Now, we need one more type for the query results.</span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span class="hs-keyword">newtype</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="StorableResult"><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">StorableResult</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ScriptTxResult"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxResult"><span class="hs-identifier hs-var">ScriptTxResult</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#TxCbor"><span class="hs-identifier hs-type">TxCbor</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="hs-comment">-- Next, we define types required for the interaction with SQLite and the cardano</span><span>
</span><span id="line-105"></span><span class="hs-comment">-- blocks.</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="hs-keyword">newtype</span><span> </span><span id="Depth"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#Depth"><span class="hs-identifier hs-var">Depth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Depth"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#Depth"><span class="hs-identifier hs-var">Depth</span></a></span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span class="hs-keyword">newtype</span><span> </span><span id="TxCbor"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#TxCbor"><span class="hs-identifier hs-var">TxCbor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TxCbor"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#TxCbor"><span class="hs-identifier hs-var">TxCbor</span></a></span></span><span> </span><span class="annot"><a href="../../../../bytestring/html/src"><span class="hs-identifier hs-type">BS.ByteString</span></a></span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679482500"><span id="local-6989586621679482502"><span class="annot"><span class="annottext">TxCbor -&gt; TxCbor -&gt; Bool
(TxCbor -&gt; TxCbor -&gt; Bool)
-&gt; (TxCbor -&gt; TxCbor -&gt; Bool) -&gt; Eq TxCbor
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: TxCbor -&gt; TxCbor -&gt; Bool
$c/= :: TxCbor -&gt; TxCbor -&gt; Bool
== :: TxCbor -&gt; TxCbor -&gt; Bool
$c== :: TxCbor -&gt; TxCbor -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679482494"><span id="local-6989586621679482496"><span id="local-6989586621679482498"><span class="annot"><span class="annottext">Int -&gt; TxCbor -&gt; ShowS
[TxCbor] -&gt; ShowS
TxCbor -&gt; String
(Int -&gt; TxCbor -&gt; ShowS)
-&gt; (TxCbor -&gt; String) -&gt; ([TxCbor] -&gt; ShowS) -&gt; Show TxCbor
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [TxCbor] -&gt; ShowS
$cshowList :: [TxCbor] -&gt; ShowS
show :: TxCbor -&gt; String
$cshow :: TxCbor -&gt; String
showsPrec :: Int -&gt; TxCbor -&gt; ShowS
$cshowsPrec :: Int -&gt; TxCbor -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679482492"><span class="annot"><span class="annottext">TxCbor -&gt; SQLData
(TxCbor -&gt; SQLData) -&gt; ToField TxCbor
forall a. (a -&gt; SQLData) -&gt; ToField a
toField :: TxCbor -&gt; SQLData
$ctoField :: TxCbor -&gt; SQLData
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">SQL.ToField</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679482489"><span class="annot"><span class="annottext">FieldParser TxCbor
FieldParser TxCbor -&gt; FromField TxCbor
forall a. FieldParser a -&gt; FromField a
fromField :: FieldParser TxCbor
$cfromField :: FieldParser TxCbor
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">SQL.FromField</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="hs-keyword">type</span><span> </span><span id="ScriptTxIndexer"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxIndexer"><span class="hs-identifier hs-var">ScriptTxIndexer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Storable.State</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="hs-comment">-- * SQLite</span><span>
</span><span id="line-116"></span><span id="local-6989586621679482486"><span id="local-6989586621679482487"></span></span><span class="hs-keyword">data</span><span> </span><span id="ScriptTxRow"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-var">ScriptTxRow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ScriptTxRow"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-var">ScriptTxRow</span></a></span></span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="scriptAddress"><span class="annot"><span class="annottext">ScriptTxRow -&gt; StorableQuery ScriptTxHandle
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#scriptAddress"><span class="hs-identifier hs-var hs-var">scriptAddress</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="txCbor"><span class="annot"><span class="annottext">ScriptTxRow -&gt; TxCbor
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#txCbor"><span class="hs-identifier hs-var hs-var">txCbor</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#TxCbor"><span class="hs-identifier hs-type">TxCbor</span></a></span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="txSlot"><span class="annot"><span class="annottext">ScriptTxRow -&gt; SlotNo
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#txSlot"><span class="hs-identifier hs-var hs-var">txSlot</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">SlotNo</span></a></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="blockHash"><span class="annot"><span class="annottext">ScriptTxRow -&gt; Hash BlockHeader
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#blockHash"><span class="hs-identifier hs-var hs-var">blockHash</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Hash</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. ScriptTxRow -&gt; Rep ScriptTxRow x)
-&gt; (forall x. Rep ScriptTxRow x -&gt; ScriptTxRow)
-&gt; Generic ScriptTxRow
forall x. Rep ScriptTxRow x -&gt; ScriptTxRow
forall x. ScriptTxRow -&gt; Rep ScriptTxRow x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep ScriptTxRow x -&gt; ScriptTxRow
$cfrom :: forall x. ScriptTxRow -&gt; Rep ScriptTxRow x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-type">SQL.ToField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-124"></span><span>  </span><span id="local-6989586621679482476"><span class="annot"><span class="annottext">toField :: StorableQuery ScriptTxHandle -&gt; SQLData
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">toField</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxAddress"><span class="hs-identifier hs-type">ScriptTxAddress</span></a></span><span> </span><span id="local-6989586621679482474"><span class="annot"><a href="#local-6989586621679482474"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; SQLData
</span><a href="../../../../direct-sqlite/html/src"><span class="hs-identifier hs-var">SQL.SQLBlob</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; SQLData)
-&gt; (ScriptHash -&gt; ByteString) -&gt; ScriptHash -&gt; SQLData
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptHash -&gt; ByteString
forall a. SerialiseAsRawBytes a =&gt; a -&gt; ByteString
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.serialiseToRawBytes</span></a></span><span> </span><span class="annot"><span class="annottext">(ScriptHash -&gt; SQLData) -&gt; ScriptHash -&gt; SQLData
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptHash
</span><a href="#local-6989586621679482474"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-125"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-type">SQL.FromField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-126"></span><span>  </span><span id="local-6989586621679482469"><span class="annot"><span class="annottext">fromField :: FieldParser (StorableQuery ScriptTxHandle)
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromField</span></a></span></span><span> </span><span id="local-6989586621679482467"><span class="annot"><span class="annottext">Field
</span><a href="#local-6989586621679482467"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FieldParser ByteString
forall a. FromField a =&gt; FieldParser a
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.fromField</span></a></span><span> </span><span class="annot"><span class="annottext">Field
</span><a href="#local-6989586621679482467"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Ok ByteString
-&gt; (ByteString -&gt; Ok (StorableQuery ScriptTxHandle))
-&gt; Ok (StorableQuery ScriptTxHandle)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span>
</span><span id="line-127"></span><span>      </span><span class="hs-glyph">\</span><span id="local-6989586621679482466"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679482466"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ok (StorableQuery ScriptTxHandle)
-&gt; (ScriptHash -&gt; Ok (StorableQuery ScriptTxHandle))
-&gt; Maybe ScriptHash
-&gt; Ok (StorableQuery ScriptTxHandle)
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Ok (StorableQuery ScriptTxHandle)
</span><a href="#local-6989586621679482464"><span class="hs-identifier hs-var">cantDeserialise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle -&gt; Ok (StorableQuery ScriptTxHandle)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableQuery ScriptTxHandle -&gt; Ok (StorableQuery ScriptTxHandle))
-&gt; (ScriptHash -&gt; StorableQuery ScriptTxHandle)
-&gt; ScriptHash
-&gt; Ok (StorableQuery ScriptTxHandle)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptHash -&gt; StorableQuery ScriptTxHandle
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxAddress"><span class="hs-identifier hs-var">ScriptTxAddress</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe ScriptHash -&gt; Ok (StorableQuery ScriptTxHandle))
-&gt; Maybe ScriptHash -&gt; Ok (StorableQuery ScriptTxHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AsType ScriptHash -&gt; ByteString -&gt; Maybe ScriptHash
forall a.
SerialiseAsRawBytes a =&gt;
AsType a -&gt; ByteString -&gt; Maybe a
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.deserialiseFromRawBytes</span></a></span><span> </span><span class="annot"><span class="annottext">AsType ScriptHash
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.AsScriptHash</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679482466"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-129"></span><span>      </span><span id="local-6989586621679482464"><span class="annot"><span class="annottext">cantDeserialise :: Ok (StorableQuery ScriptTxHandle)
</span><a href="#local-6989586621679482464"><span class="hs-identifier hs-var hs-var">cantDeserialise</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; String -&gt; String -&gt; ResultError)
-&gt; Field -&gt; String -&gt; Ok (StorableQuery ScriptTxHandle)
forall a err.
(Typeable a, Exception err) =&gt;
(String -&gt; String -&gt; String -&gt; err) -&gt; Field -&gt; String -&gt; Ok a
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.returnError</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String -&gt; ResultError
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.ConversionFailed</span></a></span><span> </span><span class="annot"><span class="annottext">Field
</span><a href="#local-6989586621679482467"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot deserialise address.&quot;</span></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-type">SQL.ToRow</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-type">ScriptTxRow</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-132"></span><span>  </span><span id="local-6989586621679482457"><span class="annot"><span class="annottext">toRow :: ScriptTxRow -&gt; [SQLData]
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">toRow</span></a></span></span><span> </span><span id="local-6989586621679482455"><span class="annot"><span class="annottext">ScriptTxRow
</span><a href="#local-6989586621679482455"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle -&gt; SQLData
forall a. ToField a =&gt; a -&gt; SQLData
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.toField</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableQuery ScriptTxHandle -&gt; SQLData)
-&gt; StorableQuery ScriptTxHandle -&gt; SQLData
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxRow -&gt; StorableQuery ScriptTxHandle
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#scriptAddress"><span class="hs-identifier hs-var hs-var">scriptAddress</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxRow
</span><a href="#local-6989586621679482455"><span class="hs-identifier hs-var">o</span></a></span><span>
</span><span id="line-133"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TxCbor -&gt; SQLData
forall a. ToField a =&gt; a -&gt; SQLData
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.toField</span></a></span><span> </span><span class="annot"><span class="annottext">(TxCbor -&gt; SQLData) -&gt; TxCbor -&gt; SQLData
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxRow -&gt; TxCbor
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#txCbor"><span class="hs-identifier hs-var hs-var">txCbor</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxRow
</span><a href="#local-6989586621679482455"><span class="hs-identifier hs-var">o</span></a></span><span>
</span><span id="line-134"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SQLData
forall a. ToField a =&gt; a -&gt; SQLData
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.toField</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; SQLData) -&gt; SlotNo -&gt; SQLData
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxRow -&gt; SlotNo
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#txSlot"><span class="hs-identifier hs-var hs-var">txSlot</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxRow
</span><a href="#local-6989586621679482455"><span class="hs-identifier hs-var">o</span></a></span><span>
</span><span id="line-135"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader -&gt; SQLData
forall a. ToField a =&gt; a -&gt; SQLData
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.toField</span></a></span><span> </span><span class="annot"><span class="annottext">(Hash BlockHeader -&gt; SQLData) -&gt; Hash BlockHeader -&gt; SQLData
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxRow -&gt; Hash BlockHeader
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#blockHash"><span class="hs-identifier hs-var hs-var">blockHash</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxRow
</span><a href="#local-6989586621679482455"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span id="local-6989586621679482453"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-type">SQL.FromRow</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-type">ScriptTxRow</span></a></span></span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="hs-comment">-- * Indexer</span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span class="hs-keyword">type</span><span> </span><span id="Query"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#Query"><span class="hs-identifier hs-var">Query</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span>  </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span>
</span><span id="line-142"></span><span class="hs-keyword">type</span><span> </span><span id="Result"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#Result"><span class="hs-identifier hs-var">Result</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableResult</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#toUpdate"><span class="hs-identifier hs-type">toUpdate</span></a></span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679482448"><span class="annot"><a href="#local-6989586621679482448"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.IsCardanoEra</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679482448"><span class="hs-identifier hs-type">era</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.Tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679482448"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ChainPoint</span></a></span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span>
</span><span id="line-149"></span><span id="toUpdate"><span class="annot"><span class="annottext">toUpdate :: [Tx era] -&gt; ChainPoint -&gt; StorableEvent ScriptTxHandle
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#toUpdate"><span class="hs-identifier hs-var hs-var">toUpdate</span></a></span></span><span> </span><span id="local-6989586621679482446"><span class="annot"><span class="annottext">[Tx era]
</span><a href="#local-6989586621679482446"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(TxCbor, [StorableQuery ScriptTxHandle])]
-&gt; ChainPoint -&gt; StorableEvent ScriptTxHandle
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxEvent"><span class="hs-identifier hs-var">ScriptTxEvent</span></a></span><span> </span><span class="annot"><span class="annottext">[(TxCbor, [StorableQuery ScriptTxHandle])]
</span><a href="#local-6989586621679482445"><span class="hs-identifier hs-var">txScripts'</span></a></span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-151"></span><span>    </span><span id="local-6989586621679482445"><span class="annot"><span class="annottext">txScripts' :: [(TxCbor, [StorableQuery ScriptTxHandle])]
</span><a href="#local-6989586621679482445"><span class="hs-identifier hs-var hs-var">txScripts'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Tx era -&gt; (TxCbor, [StorableQuery ScriptTxHandle]))
-&gt; [Tx era] -&gt; [(TxCbor, [StorableQuery ScriptTxHandle])]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679482444"><span class="annot"><span class="annottext">Tx era
</span><a href="#local-6989586621679482444"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; TxCbor
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#TxCbor"><span class="hs-identifier hs-var">TxCbor</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; TxCbor) -&gt; ByteString -&gt; TxCbor
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tx era -&gt; ByteString
forall a. SerialiseAsCBOR a =&gt; a -&gt; ByteString
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.serialiseToCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Tx era
</span><a href="#local-6989586621679482444"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Tx era -&gt; [StorableQuery ScriptTxHandle]
forall era. Tx era -&gt; [StorableQuery ScriptTxHandle]
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#getTxScripts"><span class="hs-identifier hs-var">getTxScripts</span></a></span><span> </span><span class="annot"><span class="annottext">Tx era
</span><a href="#local-6989586621679482444"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Tx era]
</span><a href="#local-6989586621679482446"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#getTxBodyScripts"><span class="hs-identifier hs-type">getTxBodyScripts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679482641"><span class="annot"><a href="#local-6989586621679482641"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679482641"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-154"></span><span id="getTxBodyScripts"><span class="annot"><span class="annottext">getTxBodyScripts :: TxBody era -&gt; [StorableQuery ScriptTxHandle]
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#getTxBodyScripts"><span class="hs-identifier hs-var hs-var">getTxBodyScripts</span></a></span></span><span> </span><span id="local-6989586621679482440"><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679482440"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-155"></span><span>    </span><span class="annot"><a href="#local-6989586621679482439"><span class="hs-identifier hs-type">hashesMaybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ScriptHash</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-156"></span><span>    </span><span id="local-6989586621679482439"><span class="annot"><span class="annottext">hashesMaybe :: [Maybe ScriptHash]
</span><a href="#local-6989586621679482439"><span class="hs-identifier hs-var hs-var">hashesMaybe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679482440"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-157"></span><span>      </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Shelley.ShelleyTxBody</span></a></span><span> </span><span id="local-6989586621679482437"><span class="annot"><span class="annottext">ShelleyBasedEra era
</span><a href="#local-6989586621679482437"><span class="hs-identifier hs-var">shelleyBasedEra</span></a></span></span><span> </span><span class="annot"><span class="annottext">TxBody (ShelleyLedgerEra era)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679482436"><span class="annot"><span class="annottext">[Script (ShelleyLedgerEra era)]
</span><a href="#local-6989586621679482436"><span class="hs-identifier hs-var">scripts</span></a></span></span><span> </span><span class="annot"><span class="annottext">TxBodyScriptData era
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (AuxiliaryData (ShelleyLedgerEra era))
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TxScriptValidity era
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-158"></span><span>        </span><span class="annot"><span class="annottext">((Script (ShelleyLedgerEra era) -&gt; Maybe ScriptHash)
 -&gt; [Script (ShelleyLedgerEra era)] -&gt; [Maybe ScriptHash])
-&gt; [Script (ShelleyLedgerEra era)]
-&gt; (Script (ShelleyLedgerEra era) -&gt; Maybe ScriptHash)
-&gt; [Maybe ScriptHash]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">(Script (ShelleyLedgerEra era) -&gt; Maybe ScriptHash)
-&gt; [Script (ShelleyLedgerEra era)] -&gt; [Maybe ScriptHash]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">[Script (ShelleyLedgerEra era)]
</span><a href="#local-6989586621679482436"><span class="hs-identifier hs-var">scripts</span></a></span><span> </span><span class="annot"><span class="annottext">((Script (ShelleyLedgerEra era) -&gt; Maybe ScriptHash)
 -&gt; [Maybe ScriptHash])
-&gt; (Script (ShelleyLedgerEra era) -&gt; Maybe ScriptHash)
-&gt; [Maybe ScriptHash]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679482434"><span class="annot"><span class="annottext">Script (ShelleyLedgerEra era)
</span><a href="#local-6989586621679482434"><span class="hs-identifier hs-var">script</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-159"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ShelleyBasedEra era
-&gt; Script (ShelleyLedgerEra era) -&gt; ScriptInEra era
forall era.
ShelleyBasedEra era
-&gt; Script (ShelleyLedgerEra era) -&gt; ScriptInEra era
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#fromShelleyBasedScript"><span class="hs-identifier hs-var">fromShelleyBasedScript</span></a></span><span> </span><span class="annot"><span class="annottext">ShelleyBasedEra era
</span><a href="#local-6989586621679482437"><span class="hs-identifier hs-var">shelleyBasedEra</span></a></span><span> </span><span class="annot"><span class="annottext">Script (ShelleyLedgerEra era)
</span><a href="#local-6989586621679482434"><span class="hs-identifier hs-var">script</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-160"></span><span>            </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Shelley.ScriptInEra</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLanguageInEra lang era
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679482431"><span class="annot"><span class="annottext">Script lang
</span><a href="#local-6989586621679482431"><span class="hs-identifier hs-var">script'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ScriptHash -&gt; Maybe ScriptHash
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(ScriptHash -&gt; Maybe ScriptHash) -&gt; ScriptHash -&gt; Maybe ScriptHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Script lang -&gt; ScriptHash
forall lang. Script lang -&gt; ScriptHash
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.hashScript</span></a></span><span> </span><span class="annot"><span class="annottext">Script lang
</span><a href="#local-6989586621679482431"><span class="hs-identifier hs-var">script'</span></a></span><span>
</span><span id="line-161"></span><span>      </span><span class="annot"><span class="annottext">TxBody era
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Byron transactions have no scripts</span><span>
</span><span id="line-162"></span><span>    </span><span id="local-6989586621679482429"><span class="annot"><span class="annottext">hashes :: [ScriptHash]
</span><a href="#local-6989586621679482429"><span class="hs-identifier hs-var hs-var">hashes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe ScriptHash] -&gt; [ScriptHash]
forall a. [Maybe a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">catMaybes</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe ScriptHash]
</span><a href="#local-6989586621679482439"><span class="hs-identifier hs-var">hashesMaybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Shelley.ScriptHash</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(ScriptHash -&gt; StorableQuery ScriptTxHandle)
-&gt; [ScriptHash] -&gt; [StorableQuery ScriptTxHandle]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptHash -&gt; StorableQuery ScriptTxHandle
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxAddress"><span class="hs-identifier hs-var">ScriptTxAddress</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptHash]
</span><a href="#local-6989586621679482429"><span class="hs-identifier hs-var">hashes</span></a></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#getTxScripts"><span class="hs-identifier hs-type">getTxScripts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679482664"><span class="annot"><a href="#local-6989586621679482664"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.Tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679482664"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-166"></span><span id="getTxScripts"><span class="annot"><span class="annottext">getTxScripts :: Tx era -&gt; [StorableQuery ScriptTxHandle]
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#getTxScripts"><span class="hs-identifier hs-var hs-var">getTxScripts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.Tx</span></a></span><span> </span><span id="local-6989586621679482427"><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679482427"><span class="hs-identifier hs-var">txBody</span></a></span></span><span> </span><span id="local-6989586621679482426"><span class="annot"><span class="annottext">[KeyWitness era]
</span><a href="#local-6989586621679482426"><span class="hs-identifier hs-var">_ws</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxBody era -&gt; [StorableQuery ScriptTxHandle]
forall era. TxBody era -&gt; [StorableQuery ScriptTxHandle]
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#getTxBodyScripts"><span class="hs-identifier hs-var">getTxBodyScripts</span></a></span><span> </span><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679482427"><span class="hs-identifier hs-var">txBody</span></a></span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span class="hs-comment">{- Now that all connected data types have been defined, we go on to implement some
   of the type classes required for information storage and retrieval. -}</span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Buffered</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-comment">{- The data is buffered in memory. When the memory buffer is filled, we need to store
     it on disk. -}</span><span>
</span><span id="line-174"></span><span>  </span><span id="local-6989586621679482422"><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">persistToStorage</span></a></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Foldable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679482422"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679482422"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span></span><span>
</span><span id="line-179"></span><span>  </span><span id="local-6989586621679482421"><span class="annot"><span class="annottext">persistToStorage :: f (StorableEvent ScriptTxHandle)
-&gt; ScriptTxHandle -&gt; IO ScriptTxHandle
</span><a href="#local-6989586621679482421"><span class="hs-identifier hs-var hs-var hs-var hs-var">persistToStorage</span></a></span></span><span> </span><span id="local-6989586621679482420"><span class="annot"><span class="annottext">f (StorableEvent ScriptTxHandle)
</span><a href="#local-6989586621679482420"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621679482419"><span class="annot"><span class="annottext">ScriptTxHandle
</span><a href="#local-6989586621679482419"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679482418"><span class="annot"><span class="annottext">rows :: [ScriptTxRow]
</span><a href="#local-6989586621679482418"><span class="hs-identifier hs-var hs-var">rows</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([ScriptTxRow] -&gt; StorableEvent ScriptTxHandle -&gt; [ScriptTxRow])
-&gt; [ScriptTxRow]
-&gt; f (StorableEvent ScriptTxHandle)
-&gt; [ScriptTxRow]
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679482417"><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482417"><span class="hs-identifier hs-var">ea</span></a></span></span><span> </span><span id="local-6989586621679482416"><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle
</span><a href="#local-6989586621679482416"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482417"><span class="hs-identifier hs-var">ea</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow] -&gt; [ScriptTxRow] -&gt; [ScriptTxRow]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle -&gt; [ScriptTxRow]
</span><a href="#local-6989586621679482415"><span class="hs-identifier hs-var">flatten</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle
</span><a href="#local-6989586621679482416"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">f (StorableEvent ScriptTxHandle)
</span><a href="#local-6989586621679482420"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-181"></span><span>        </span><span id="local-6989586621679482414"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679482414"><span class="hs-identifier hs-var hs-var">c</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScriptTxHandle -&gt; Connection
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#hdlConnection"><span class="hs-identifier hs-var hs-var">hdlConnection</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxHandle
</span><a href="#local-6989586621679482419"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-182"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [ScriptTxRow] -&gt; IO ()
forall q. ToRow q =&gt; Connection -&gt; Query -&gt; [q] -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.executeMany</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482414"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-183"></span><span>      </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;INSERT INTO script_transactions (scriptAddress, txCbor, slotNo, blockHash) VALUES (?, ?, ?, ?)&quot;</span></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482418"><span class="hs-identifier hs-var">rows</span></a></span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><span class="annottext">ScriptTxHandle -&gt; IO ScriptTxHandle
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxHandle
</span><a href="#local-6989586621679482419"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-187"></span><span>      </span><span class="annot"><a href="#local-6989586621679482415"><span class="hs-identifier hs-type">flatten</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-type">ScriptTxRow</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-188"></span><span>      </span><span id="local-6989586621679482415"><span class="annot"><span class="annottext">flatten :: StorableEvent ScriptTxHandle -&gt; [ScriptTxRow]
</span><a href="#local-6989586621679482415"><span class="hs-identifier hs-var hs-var">flatten</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxEvent"><span class="hs-identifier hs-type">ScriptTxEvent</span></a></span><span> </span><span id="local-6989586621679482412"><span class="annot"><a href="#local-6989586621679482412"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ChainPoint</span></a></span><span> </span><span id="local-6989586621679482411"><span class="annot"><a href="#local-6989586621679482411"><span class="hs-identifier hs-var">sn</span></a></span></span><span> </span><span id="local-6989586621679482410"><span class="annot"><a href="#local-6989586621679482410"><span class="hs-identifier hs-var">hsh</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679482409"><span class="annot"><span class="annottext">TxCbor
</span><a href="#local-6989586621679482409"><span class="hs-identifier hs-var">tx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679482408"><span class="annot"><span class="annottext">[StorableQuery ScriptTxHandle]
</span><a href="#local-6989586621679482408"><span class="hs-identifier hs-var">scriptAddrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(TxCbor, [StorableQuery ScriptTxHandle])]
</span><a href="#local-6989586621679482412"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-190"></span><span>        </span><span id="local-6989586621679482407"><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
</span><a href="#local-6989586621679482407"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[StorableQuery ScriptTxHandle]
</span><a href="#local-6989586621679482408"><span class="hs-identifier hs-var">scriptAddrs</span></a></span><span>
</span><span id="line-191"></span><span>        </span><span class="annot"><span class="annottext">ScriptTxRow -&gt; [ScriptTxRow]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ScriptTxRow -&gt; [ScriptTxRow]) -&gt; ScriptTxRow -&gt; [ScriptTxRow]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxRow :: StorableQuery ScriptTxHandle
-&gt; TxCbor -&gt; SlotNo -&gt; Hash BlockHeader -&gt; ScriptTxRow
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-type">ScriptTxRow</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">scriptAddress :: StorableQuery ScriptTxHandle
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#scriptAddress"><span class="hs-identifier hs-var">scriptAddress</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
</span><a href="#local-6989586621679482407"><span class="hs-identifier hs-var">addr</span></a></span><span>
</span><span id="line-192"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">txCbor :: TxCbor
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#txCbor"><span class="hs-identifier hs-var">txCbor</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxCbor
</span><a href="#local-6989586621679482409"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-193"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">txSlot :: SlotNo
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#txSlot"><span class="hs-identifier hs-var">txSlot</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482411"><span class="hs-identifier hs-var">sn</span></a></span><span>
</span><span id="line-194"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blockHash :: Hash BlockHeader
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#blockHash"><span class="hs-identifier hs-var">blockHash</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679482410"><span class="hs-identifier hs-var">hsh</span></a></span><span>
</span><span id="line-195"></span><span>                           </span><span class="hs-special">}</span><span>
</span><span id="line-196"></span><span>      </span><span class="annot"><a href="#local-6989586621679482415"><span class="hs-identifier hs-var">flatten</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; [ScriptTxRow]
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;There should be no scripts in the genesis block.&quot;</span></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-comment">{- We want to potentially store data in two formats. The first one is similar (if
     not identical) to the format of data stored in memory; it should contain information
     that allows knowing at which point the data was generated.

     We use this first format to support rollbacks for disk data. The second format,
     which is not always necessary and does not have any predetermined structure,
     should be thought of as an aggregate of the previously produced events.

     For this indexer we don't really need an aggregate, so our &quot;aggregate&quot; has almost the same
     structure as the in-memory data. We pretend that there is an aggregate by
     segregating the data into two sections, by using the `hdlDiskStore` parameter. We
     take this approach because we don't want to return the entire database when this
     function is called, and we know that there is a point after which we will not
     see any rollbacks. -}</span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span>  </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">getStoredEvents</span></a></span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span>
</span><span id="line-215"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-216"></span><span>  </span><span id="local-6989586621679482405"><span class="annot"><span class="annottext">getStoredEvents :: ScriptTxHandle -&gt; IO [StorableEvent ScriptTxHandle]
</span><a href="#local-6989586621679482405"><span class="hs-identifier hs-var hs-var hs-var hs-var">getStoredEvents</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span id="local-6989586621679482404"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482404"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679482403"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679482403"><span class="hs-identifier hs-var">sz</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-217"></span><span>    </span><span id="local-6989586621679482402"><span class="annot"><span class="annottext">[[Integer]]
</span><a href="#local-6989586621679482402"><span class="hs-identifier hs-var">sns</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-218"></span><span>      </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; Only Int -&gt; IO [[Integer]]
forall q r.
(ToRow q, FromRow r) =&gt;
Connection -&gt; Query -&gt; q -&gt; IO [r]
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.query</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482404"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;SELECT slotNo FROM script_transactions GROUP BY slotNo ORDER BY slotNo DESC LIMIT ?&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Only Int
forall a. a -&gt; Only a
</span><a href="../../../../Only/html/src"><span class="hs-identifier hs-var">SQL.Only</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679482403"><span class="hs-identifier hs-var">sz</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-comment">-- Take the slot number of the sz'th slot</span><span>
</span><span id="line-220"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679482399"><span class="annot"><span class="annottext">sn :: Integer
</span><a href="#local-6989586621679482399"><span class="hs-identifier hs-var hs-var">sn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[[Integer]] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[[Integer]]
</span><a href="#local-6989586621679482402"><span class="hs-identifier hs-var">sns</span></a></span><span>
</span><span id="line-221"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-222"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[Integer] -&gt; Integer
forall a. [a] -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">head</span></a></span><span> </span><span class="annot"><span class="annottext">([Integer] -&gt; Integer)
-&gt; ([[Integer]] -&gt; [Integer]) -&gt; [[Integer]] -&gt; Integer
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[[Integer]] -&gt; [Integer]
forall a. [a] -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">last</span></a></span><span> </span><span class="annot"><span class="annottext">([[Integer]] -&gt; Integer) -&gt; [[Integer]] -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [[Integer]] -&gt; [[Integer]]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">take</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679482403"><span class="hs-identifier hs-var">sz</span></a></span><span> </span><span class="annot"><span class="annottext">[[Integer]]
</span><a href="#local-6989586621679482402"><span class="hs-identifier hs-var">sns</span></a></span><span>
</span><span id="line-223"></span><span>    </span><span id="local-6989586621679482394"><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482394"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; Only Integer -&gt; IO [ScriptTxRow]
forall q r.
(ToRow q, FromRow r) =&gt;
Connection -&gt; Query -&gt; q -&gt; IO [r]
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.query</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482404"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;SELECT scriptAddress, txCbor, slotNo, blockHash FROM script_transactions WHERE slotNo &gt;= ? ORDER BY slotNo DESC, txCbor, scriptAddress&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Only Integer
forall a. a -&gt; Only a
</span><a href="../../../../Only/html/src"><span class="hs-identifier hs-var">SQL.Only</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679482399"><span class="hs-identifier hs-var">sn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>    </span><span class="annot"><span class="annottext">[StorableEvent ScriptTxHandle] -&gt; IO [StorableEvent ScriptTxHandle]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">([StorableEvent ScriptTxHandle]
 -&gt; IO [StorableEvent ScriptTxHandle])
-&gt; [StorableEvent ScriptTxHandle]
-&gt; IO [StorableEvent ScriptTxHandle]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow] -&gt; [StorableEvent ScriptTxHandle]
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#asEvents"><span class="hs-identifier hs-var">asEvents</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482394"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="hs-comment">-- This function recomposes the in-memory format from the database records. This</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- function expectes it's first argument to be ordered by slotNo and txCbor for the</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- proper grouping of records.</span><span>
</span><span id="line-229"></span><span class="hs-comment">--</span><span>
</span><span id="line-230"></span><span class="hs-comment">-- TODO: There should be an easier lensy way of doing this.</span><span>
</span><span id="line-231"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#asEvents"><span class="hs-identifier hs-type">asEvents</span></a></span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-type">ScriptTxRow</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-234"></span><span id="asEvents"><span class="annot"><span class="annottext">asEvents :: [ScriptTxRow] -&gt; [StorableEvent ScriptTxHandle]
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#asEvents"><span class="hs-identifier hs-var hs-var">asEvents</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-235"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#asEvents"><span class="hs-identifier hs-var">asEvents</span></a></span><span> </span><span id="local-6989586621679482392"><span class="annot"><span class="annottext">rs :: [ScriptTxRow]
</span><a href="#local-6989586621679482392"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-type">ScriptTxRow</span></a></span><span> </span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TxCbor
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679482391"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482391"><span class="hs-identifier hs-var">sn</span></a></span></span><span> </span><span id="local-6989586621679482390"><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679482390"><span class="hs-identifier hs-var">hsh</span></a></span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-236"></span><span>   </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679482389"><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482389"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679482388"><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482388"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ScriptTxRow -&gt; Bool)
-&gt; [ScriptTxRow] -&gt; ([ScriptTxRow], [ScriptTxRow])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">span</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-type">ScriptTxRow</span></a></span><span> </span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TxCbor
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679482386"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482386"><span class="hs-identifier hs-var">sn'</span></a></span></span><span> </span><span id="local-6989586621679482385"><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679482385"><span class="hs-identifier hs-var">hsh'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482391"><span class="hs-identifier hs-var">sn</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482386"><span class="hs-identifier hs-var">sn'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679482390"><span class="hs-identifier hs-var">hsh</span></a></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader -&gt; Hash BlockHeader -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679482385"><span class="hs-identifier hs-var">hsh'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482392"><span class="hs-identifier hs-var">rs</span></a></span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow] -&gt; StorableEvent ScriptTxHandle
</span><a href="#local-6989586621679482383"><span class="hs-identifier hs-var">mkEvent</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482389"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle
-&gt; [StorableEvent ScriptTxHandle] -&gt; [StorableEvent ScriptTxHandle]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow] -&gt; [StorableEvent ScriptTxHandle]
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#asEvents"><span class="hs-identifier hs-var">asEvents</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482388"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-239"></span><span>    </span><span class="annot"><a href="#local-6989586621679482383"><span class="hs-identifier hs-type">mkEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-type">ScriptTxRow</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span>
</span><span id="line-240"></span><span>    </span><span id="local-6989586621679482383"><span class="annot"><span class="annottext">mkEvent :: [ScriptTxRow] -&gt; StorableEvent ScriptTxHandle
</span><a href="#local-6989586621679482383"><span class="hs-identifier hs-var hs-var">mkEvent</span></a></span></span><span> </span><span id="local-6989586621679482382"><span class="annot"><span class="annottext">rs' :: [ScriptTxRow]
</span><a href="#local-6989586621679482382"><span class="hs-identifier hs-var">rs'</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-type">ScriptTxRow</span></a></span><span> </span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TxCbor
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679482381"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482381"><span class="hs-identifier hs-var">sn'</span></a></span></span><span> </span><span id="local-6989586621679482380"><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679482380"><span class="hs-identifier hs-var">hsh'</span></a></span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-241"></span><span>       </span><span class="annot"><span class="annottext">ScriptTxEvent :: [(TxCbor, [StorableQuery ScriptTxHandle])]
-&gt; ChainPoint -&gt; StorableEvent ScriptTxHandle
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxEvent"><span class="hs-identifier hs-type">ScriptTxEvent</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">chainPoint :: ChainPoint
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#chainPoint"><span class="hs-identifier hs-var">chainPoint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Hash BlockHeader -&gt; ChainPoint
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">ChainPoint</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482381"><span class="hs-identifier hs-var">sn'</span></a></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679482380"><span class="hs-identifier hs-var">hsh'</span></a></span><span>
</span><span id="line-242"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">txScripts :: [(TxCbor, [StorableQuery ScriptTxHandle])]
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#txScripts"><span class="hs-identifier hs-var">txScripts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow] -&gt; [(TxCbor, [StorableQuery ScriptTxHandle])]
</span><a href="#local-6989586621679482379"><span class="hs-identifier hs-var">agScripts</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482382"><span class="hs-identifier hs-var">rs'</span></a></span><span>
</span><span id="line-243"></span><span>                     </span><span class="hs-special">}</span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><a href="#local-6989586621679482383"><span class="hs-identifier hs-var">mkEvent</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; StorableEvent ScriptTxHandle
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;We should always be called with a non-empty list&quot;</span></span><span>
</span><span id="line-245"></span><span>    </span><span class="annot"><a href="#local-6989586621679482379"><span class="hs-identifier hs-type">agScripts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-type">ScriptTxRow</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#TxCbor"><span class="hs-identifier hs-type">TxCbor</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-246"></span><span>    </span><span id="local-6989586621679482379"><span class="annot"><span class="annottext">agScripts :: [ScriptTxRow] -&gt; [(TxCbor, [StorableQuery ScriptTxHandle])]
</span><a href="#local-6989586621679482379"><span class="hs-identifier hs-var hs-var">agScripts</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-247"></span><span>    </span><span class="annot"><a href="#local-6989586621679482379"><span class="hs-identifier hs-var">agScripts</span></a></span><span> </span><span id="local-6989586621679482378"><span class="annot"><span class="annottext">rs' :: [ScriptTxRow]
</span><a href="#local-6989586621679482378"><span class="hs-identifier hs-var">rs'</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-type">ScriptTxRow</span></a></span><span> </span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679482377"><span class="annot"><span class="annottext">TxCbor
</span><a href="#local-6989586621679482377"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-248"></span><span>       </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679482376"><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482376"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679482375"><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482375"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ScriptTxRow -&gt; Bool)
-&gt; [ScriptTxRow] -&gt; ([ScriptTxRow], [ScriptTxRow])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">span</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-type">ScriptTxRow</span></a></span><span> </span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679482374"><span class="annot"><span class="annottext">TxCbor
</span><a href="#local-6989586621679482374"><span class="hs-identifier hs-var">tx'</span></a></span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxCbor
</span><a href="#local-6989586621679482377"><span class="hs-identifier hs-var">tx</span></a></span><span> </span><span class="annot"><span class="annottext">TxCbor -&gt; TxCbor -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">TxCbor
</span><a href="#local-6989586621679482374"><span class="hs-identifier hs-var">tx'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482378"><span class="hs-identifier hs-var">rs'</span></a></span><span>
</span><span id="line-249"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxCbor
</span><a href="#local-6989586621679482377"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(ScriptTxRow -&gt; StorableQuery ScriptTxHandle)
-&gt; [ScriptTxRow] -&gt; [StorableQuery ScriptTxHandle]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxRow -&gt; StorableQuery ScriptTxHandle
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#scriptAddress"><span class="hs-identifier hs-var hs-var">scriptAddress</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482376"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TxCbor, [StorableQuery ScriptTxHandle])
-&gt; [(TxCbor, [StorableQuery ScriptTxHandle])]
-&gt; [(TxCbor, [StorableQuery ScriptTxHandle])]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow] -&gt; [(TxCbor, [StorableQuery ScriptTxHandle])]
</span><a href="#local-6989586621679482379"><span class="hs-identifier hs-var">agScripts</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482375"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Queryable</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-252"></span><span>  </span><span id="local-6989586621679482371"><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">queryStorage</span></a></span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Foldable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679482371"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">QueryInterval</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ChainPoint</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679482371"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableResult</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-259"></span><span>  </span><span id="local-6989586621679482370"><span class="annot"><span class="annottext">queryStorage :: QueryInterval ChainPoint
-&gt; f (StorableEvent ScriptTxHandle)
-&gt; ScriptTxHandle
-&gt; StorableQuery ScriptTxHandle
-&gt; IO (StorableResult ScriptTxHandle)
</span><a href="#local-6989586621679482370"><span class="hs-identifier hs-var hs-var hs-var hs-var">queryStorage</span></a></span></span><span> </span><span id="local-6989586621679482369"><span class="annot"><span class="annottext">QueryInterval ChainPoint
</span><a href="#local-6989586621679482369"><span class="hs-identifier hs-var">qi</span></a></span></span><span> </span><span id="local-6989586621679482368"><span class="annot"><span class="annottext">f (StorableEvent ScriptTxHandle)
</span><a href="#local-6989586621679482368"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span id="local-6989586621679482367"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482367"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679482366"><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
</span><a href="#local-6989586621679482366"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-260"></span><span>    </span><span id="local-6989586621679482365"><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482365"><span class="hs-identifier hs-var">persisted</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxRow"><span class="hs-identifier hs-type">ScriptTxRow</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-261"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">QueryInterval ChainPoint
</span><a href="#local-6989586621679482369"><span class="hs-identifier hs-var">qi</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-262"></span><span>        </span><span class="annot"><span class="annottext">QueryInterval ChainPoint
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">QEverything</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Connection
-&gt; Query -&gt; Only (StorableQuery ScriptTxHandle) -&gt; IO [ScriptTxRow]
forall q r.
(ToRow q, FromRow r) =&gt;
Connection -&gt; Query -&gt; q -&gt; IO [r]
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.query</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482367"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-263"></span><span>          </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;SELECT scriptAddress, txCbor, slotNo, blockHash FROM script_transactions WHERE scriptAddress = ? ORDER BY slotNo ASC, txCbor, scriptAddress&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle -&gt; Only (StorableQuery ScriptTxHandle)
forall a. a -&gt; Only a
</span><a href="../../../../Only/html/src"><span class="hs-identifier hs-var">SQL.Only</span></a></span><span> </span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
</span><a href="#local-6989586621679482366"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>        </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">QInterval</span></a></span><span> </span><span class="annot"><span class="annottext">ChainPoint
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ChainPoint</span></a></span><span> </span><span id="local-6989586621679482364"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482364"><span class="hs-identifier hs-var">sn</span></a></span></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Connection
-&gt; Query
-&gt; (SlotNo, StorableQuery ScriptTxHandle)
-&gt; IO [ScriptTxRow]
forall q r.
(ToRow q, FromRow r) =&gt;
Connection -&gt; Query -&gt; q -&gt; IO [r]
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.query</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482367"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-265"></span><span>          </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;SELECT scriptAddress, txCbor, slotNo, blockHash FROM script_transactions WHERE slotNo &lt;= ? AND scriptAddress = ? ORDER BY slotNo ASC, txCbor, scriptAddress&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482364"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
</span><a href="#local-6989586621679482366"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>        </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">QInterval</span></a></span><span> </span><span class="annot"><span class="annottext">ChainPoint
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ChainPoint
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">ChainPointAtGenesis</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow] -&gt; IO [ScriptTxRow]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-comment">-- Note that ordering is quite important here, as the `filterWithQueryInterval`</span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-comment">-- function assumes events are ordered from oldest (the head) to most recent.</span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679482363"><span class="annot"><span class="annottext">updates :: [StorableEvent ScriptTxHandle]
</span><a href="#local-6989586621679482363"><span class="hs-identifier hs-var hs-var">updates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QueryInterval (StorablePoint ScriptTxHandle)
-&gt; [StorableEvent ScriptTxHandle] -&gt; [StorableEvent ScriptTxHandle]
forall h.
(HasPoint (StorableEvent h) (StorablePoint h),
 Ord (StorablePoint h)) =&gt;
QueryInterval (StorablePoint h)
-&gt; [StorableEvent h] -&gt; [StorableEvent h]
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">filterWithQueryInterval</span></a></span><span> </span><span class="annot"><span class="annottext">QueryInterval ChainPoint
QueryInterval (StorablePoint ScriptTxHandle)
</span><a href="#local-6989586621679482369"><span class="hs-identifier hs-var">qi</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ScriptTxRow] -&gt; [StorableEvent ScriptTxHandle]
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#asEvents"><span class="hs-identifier hs-var">asEvents</span></a></span><span> </span><span class="annot"><span class="annottext">[ScriptTxRow]
</span><a href="#local-6989586621679482365"><span class="hs-identifier hs-var">persisted</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent ScriptTxHandle]
-&gt; [StorableEvent ScriptTxHandle] -&gt; [StorableEvent ScriptTxHandle]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">f (StorableEvent ScriptTxHandle) -&gt; [StorableEvent ScriptTxHandle]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">f (StorableEvent ScriptTxHandle)
</span><a href="#local-6989586621679482368"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>    </span><span class="annot"><span class="annottext">StorableResult ScriptTxHandle -&gt; IO (StorableResult ScriptTxHandle)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableResult ScriptTxHandle
 -&gt; IO (StorableResult ScriptTxHandle))
-&gt; ([TxCbor] -&gt; StorableResult ScriptTxHandle)
-&gt; [TxCbor]
-&gt; IO (StorableResult ScriptTxHandle)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[TxCbor] -&gt; StorableResult ScriptTxHandle
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxResult"><span class="hs-identifier hs-var">ScriptTxResult</span></a></span><span> </span><span class="annot"><span class="annottext">([TxCbor] -&gt; IO (StorableResult ScriptTxHandle))
-&gt; [TxCbor] -&gt; IO (StorableResult ScriptTxHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
-&gt; [StorableEvent ScriptTxHandle] -&gt; [TxCbor]
</span><a href="#local-6989586621679482362"><span class="hs-identifier hs-var">filterByScriptAddress</span></a></span><span> </span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
</span><a href="#local-6989586621679482366"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent ScriptTxHandle]
</span><a href="#local-6989586621679482363"><span class="hs-identifier hs-var">updates</span></a></span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-273"></span><span>      </span><span class="annot"><a href="#local-6989586621679482362"><span class="hs-identifier hs-type">filterByScriptAddress</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#TxCbor"><span class="hs-identifier hs-type">TxCbor</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-274"></span><span>      </span><span id="local-6989586621679482362"><span class="annot"><span class="annottext">filterByScriptAddress :: StorableQuery ScriptTxHandle
-&gt; [StorableEvent ScriptTxHandle] -&gt; [TxCbor]
</span><a href="#local-6989586621679482362"><span class="hs-identifier hs-var hs-var">filterByScriptAddress</span></a></span></span><span> </span><span id="local-6989586621679482361"><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
</span><a href="#local-6989586621679482361"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span id="local-6989586621679482360"><span class="annot"><span class="annottext">[StorableEvent ScriptTxHandle]
</span><a href="#local-6989586621679482360"><span class="hs-identifier hs-var">updates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-275"></span><span>         </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxEvent"><span class="hs-identifier hs-type">ScriptTxEvent</span></a></span><span> </span><span id="local-6989586621679482359"><span class="annot"><a href="#local-6989586621679482359"><span class="hs-identifier hs-var">update</span></a></span></span><span> </span><span id="local-6989586621679482358"><span class="annot"><a href="#local-6989586621679482358"><span class="hs-identifier hs-var">_slotNo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[StorableEvent ScriptTxHandle]
</span><a href="#local-6989586621679482360"><span class="hs-identifier hs-var">updates</span></a></span><span>
</span><span id="line-276"></span><span>         </span><span class="annot"><span class="annottext">((TxCbor, [StorableQuery ScriptTxHandle]) -&gt; TxCbor)
-&gt; [(TxCbor, [StorableQuery ScriptTxHandle])] -&gt; [TxCbor]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(TxCbor, [StorableQuery ScriptTxHandle]) -&gt; TxCbor
forall a b. (a, b) -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">([(TxCbor, [StorableQuery ScriptTxHandle])] -&gt; [TxCbor])
-&gt; [(TxCbor, [StorableQuery ScriptTxHandle])] -&gt; [TxCbor]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((TxCbor, [StorableQuery ScriptTxHandle]) -&gt; Bool)
-&gt; [(TxCbor, [StorableQuery ScriptTxHandle])]
-&gt; [(TxCbor, [StorableQuery ScriptTxHandle])]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxCbor
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679482357"><span class="annot"><span class="annottext">[StorableQuery ScriptTxHandle]
</span><a href="#local-6989586621679482357"><span class="hs-identifier hs-var">addrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
</span><a href="#local-6989586621679482361"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="annot"><span class="annottext">StorableQuery ScriptTxHandle
-&gt; [StorableQuery ScriptTxHandle] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableQuery ScriptTxHandle]
</span><a href="#local-6989586621679482357"><span class="hs-identifier hs-var">addrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(TxCbor, [StorableQuery ScriptTxHandle])]
</span><a href="#local-6989586621679482359"><span class="hs-identifier hs-var">update</span></a></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Rewindable</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-279"></span><span>  </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">rewindStorage</span></a></span><span>
</span><span id="line-280"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ChainPoint</span></a></span><span>
</span><span id="line-281"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>  </span><span id="local-6989586621679482353"><span class="annot"><span class="annottext">rewindStorage :: ChainPoint -&gt; ScriptTxHandle -&gt; IO (Maybe ScriptTxHandle)
</span><a href="#local-6989586621679482353"><span class="hs-identifier hs-var hs-var hs-var hs-var">rewindStorage</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ChainPoint</span></a></span><span> </span><span id="local-6989586621679482352"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482352"><span class="hs-identifier hs-var">sn</span></a></span></span><span>   </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679482351"><span class="annot"><span class="annottext">h :: ScriptTxHandle
</span><a href="#local-6989586621679482351"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span id="local-6989586621679482350"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482350"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-284"></span><span>     </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; Only SlotNo -&gt; IO ()
forall q. ToRow q =&gt; Connection -&gt; Query -&gt; q -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482350"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;DELETE FROM script_transactions WHERE slotNo &gt; ?&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Only SlotNo
forall a. a -&gt; Only a
</span><a href="../../../../Only/html/src"><span class="hs-identifier hs-var">SQL.Only</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482352"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>     </span><span class="annot"><span class="annottext">Maybe ScriptTxHandle -&gt; IO (Maybe ScriptTxHandle)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe ScriptTxHandle -&gt; IO (Maybe ScriptTxHandle))
-&gt; Maybe ScriptTxHandle -&gt; IO (Maybe ScriptTxHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxHandle -&gt; Maybe ScriptTxHandle
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxHandle
</span><a href="#local-6989586621679482351"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-286"></span><span>  </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">rewindStorage</span></a></span><span> </span><span class="annot"><span class="annottext">ChainPoint
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">ChainPointAtGenesis</span></a></span><span> </span><span id="local-6989586621679482348"><span class="annot"><span class="annottext">h :: ScriptTxHandle
</span><a href="#local-6989586621679482348"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span id="local-6989586621679482347"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482347"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-287"></span><span>     </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482347"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;DELETE FROM script_transactions&quot;</span></span><span>
</span><span id="line-288"></span><span>     </span><span class="annot"><span class="annottext">Maybe ScriptTxHandle -&gt; IO (Maybe ScriptTxHandle)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe ScriptTxHandle -&gt; IO (Maybe ScriptTxHandle))
-&gt; Maybe ScriptTxHandle -&gt; IO (Maybe ScriptTxHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxHandle -&gt; Maybe ScriptTxHandle
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxHandle
</span><a href="#local-6989586621679482348"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="hs-comment">-- For resuming we need to provide a list of points where we can resume from.</span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Resumable</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTxHandle</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-294"></span><span>  </span><span id="local-6989586621679482343"><span class="annot"><span class="annottext">resumeFromStorage :: ScriptTxHandle
-&gt; StorableMonad ScriptTxHandle [StorablePoint ScriptTxHandle]
</span><a href="#local-6989586621679482343"><span class="hs-identifier hs-var hs-var hs-var hs-var">resumeFromStorage</span></a></span></span><span> </span><span id="local-6989586621679482342"><span class="annot"><span class="annottext">ScriptTxHandle
</span><a href="#local-6989586621679482342"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-295"></span><span>    </span><span id="local-6989586621679482341"><span class="annot"><span class="annottext">[StorableEvent ScriptTxHandle]
</span><a href="#local-6989586621679482341"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScriptTxHandle
-&gt; StorableMonad ScriptTxHandle [StorableEvent ScriptTxHandle]
forall h. Buffered h =&gt; h -&gt; StorableMonad h [StorableEvent h]
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.getStoredEvents</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxHandle
</span><a href="#local-6989586621679482342"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-comment">-- The ordering here matters. The node will try to find the first point in the</span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-comment">-- ledger, then move to the next and so on, so we will send the latest point</span><span>
</span><span id="line-298"></span><span>    </span><span class="hs-comment">-- first.</span><span>
</span><span id="line-299"></span><span>    </span><span class="annot"><span class="annottext">[ChainPoint] -&gt; IO [ChainPoint]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">([ChainPoint] -&gt; IO [ChainPoint])
-&gt; [ChainPoint] -&gt; IO [ChainPoint]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableEvent ScriptTxHandle -&gt; ChainPoint)
-&gt; [StorableEvent ScriptTxHandle] -&gt; [ChainPoint]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle -&gt; ChainPoint
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#chainPoint"><span class="hs-identifier hs-var hs-var">chainPoint</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent ScriptTxHandle]
</span><a href="#local-6989586621679482341"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainPoint] -&gt; [ChainPoint] -&gt; [ChainPoint]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ChainPoint
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">ChainPointAtGenesis</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#open"><span class="hs-identifier hs-type">open</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#Depth"><span class="hs-identifier hs-type">Depth</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxIndexer"><span class="hs-identifier hs-type">ScriptTxIndexer</span></a></span><span>
</span><span id="line-302"></span><span id="open"><span class="annot"><span class="annottext">open :: String -&gt; Depth -&gt; IO ScriptTxIndexer
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#open"><span class="hs-identifier hs-var hs-var">open</span></a></span></span><span> </span><span id="local-6989586621679482338"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679482338"><span class="hs-identifier hs-var">dbPath</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#Depth"><span class="hs-identifier hs-type">Depth</span></a></span><span> </span><span id="local-6989586621679482337"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679482337"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-303"></span><span>  </span><span id="local-6989586621679482336"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482336"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO Connection
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.open</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679482338"><span class="hs-identifier hs-var">dbPath</span></a></span><span>
</span><span id="line-304"></span><span>  </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482336"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;PRAGMA journal_mode=WAL&quot;</span></span><span>
</span><span id="line-305"></span><span>  </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482336"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;CREATE TABLE IF NOT EXISTS script_transactions (scriptAddress TEXT NOT NULL, txCbor BLOB NOT NULL, slotNo INT NOT NULL, blockHash BLOB NOT NULL)&quot;</span></span><span>
</span><span id="line-306"></span><span>  </span><span class="hs-comment">-- Add this index for normal queries.</span><span>
</span><span id="line-307"></span><span>  </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482336"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;CREATE INDEX IF NOT EXISTS script_address ON script_transactions (scriptAddress)&quot;</span></span><span>
</span><span id="line-308"></span><span>  </span><span class="hs-comment">-- Add this index for interval queries.</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482336"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;CREATE INDEX IF NOT EXISTS script_address_slot ON script_transactions (scriptAddress, slotNo)&quot;</span></span><span>
</span><span id="line-310"></span><span>  </span><span class="hs-comment">-- This index helps with group by</span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482336"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;CREATE INDEX IF NOT EXISTS script_grp ON script_transactions (slotNo)&quot;</span></span><span>
</span><span id="line-312"></span><span>  </span><span class="annot"><span class="annottext">Int
-&gt; ScriptTxHandle -&gt; StorableMonad ScriptTxHandle ScriptTxIndexer
forall h.
PrimMonad (StorableMonad h) =&gt;
Int -&gt; h -&gt; StorableMonad h (State h)
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">emptyState</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679482337"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Connection -&gt; Int -&gt; ScriptTxHandle
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-var">ScriptTxHandle</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679482336"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679482337"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span class="hs-comment">-- * Copy-paste</span><span>
</span><span id="line-315"></span><span class="hs-comment">--</span><span>
</span><span id="line-316"></span><span class="hs-comment">-- | TODO: Remove when the following function is exported from Cardano.Api.Script</span><span>
</span><span id="line-317"></span><span class="hs-comment">-- PR: https://github.com/input-output-hk/cardano-node/pull/4386</span><span>
</span><span id="line-318"></span><span id="local-6989586621679482650"><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#fromShelleyBasedScript"><span class="hs-identifier hs-type">fromShelleyBasedScript</span></a></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Shelley.ShelleyBasedEra</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679482650"><span class="hs-identifier hs-type">era</span></a></span><span>
</span><span id="line-319"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Cardano.Ledger.Core.Script</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Shelley.ShelleyLedgerEra</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679482650"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Shelley.ScriptInEra</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679482650"><span class="hs-identifier hs-type">era</span></a></span></span><span>
</span><span id="line-321"></span><span id="fromShelleyBasedScript"><span class="annot"><span class="annottext">fromShelleyBasedScript :: ShelleyBasedEra era
-&gt; Script (ShelleyLedgerEra era) -&gt; ScriptInEra era
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#fromShelleyBasedScript"><span class="hs-identifier hs-var hs-var">fromShelleyBasedScript</span></a></span></span><span> </span><span id="local-6989586621679482334"><span class="annot"><span class="annottext">ShelleyBasedEra era
</span><a href="#local-6989586621679482334"><span class="hs-identifier hs-var">era</span></a></span></span><span> </span><span id="local-6989586621679482333"><span class="annot"><span class="annottext">Script (ShelleyLedgerEra era)
</span><a href="#local-6989586621679482333"><span class="hs-identifier hs-var">script</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ShelleyBasedEra era
</span><a href="#local-6989586621679482334"><span class="hs-identifier hs-var">era</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-323"></span><span>    </span><span class="annot"><span class="annottext">ShelleyBasedEra era
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.ShelleyBasedEraShelley</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-324"></span><span>      </span><span class="annot"><span class="annottext">ScriptLanguageInEra SimpleScriptV1 ShelleyEra
-&gt; Script SimpleScriptV1 -&gt; ScriptInEra ShelleyEra
forall lang era.
ScriptLanguageInEra lang era -&gt; Script lang -&gt; ScriptInEra era
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.ScriptInEra</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLanguageInEra SimpleScriptV1 ShelleyEra
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScriptV1InShelley</span></a></span><span> </span><span class="annot"><span class="annottext">(Script SimpleScriptV1 -&gt; ScriptInEra ShelleyEra)
-&gt; Script SimpleScriptV1 -&gt; ScriptInEra ShelleyEra
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-325"></span><span>      </span><span class="annot"><span class="annottext">SimpleScriptVersion SimpleScriptV1
-&gt; SimpleScript SimpleScriptV1 -&gt; Script SimpleScriptV1
forall lang.
SimpleScriptVersion lang -&gt; SimpleScript lang -&gt; Script lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScript</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleScriptVersion SimpleScriptV1
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScriptV1</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleScript SimpleScriptV1 -&gt; Script SimpleScriptV1)
-&gt; SimpleScript SimpleScriptV1 -&gt; Script SimpleScriptV1
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-326"></span><span>      </span><span class="annot"><span class="annottext">MultiSig StandardCrypto -&gt; SimpleScript SimpleScriptV1
forall lang. MultiSig StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482328"><span class="hs-identifier hs-var">fromShelleyMultiSig</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSig StandardCrypto
Script (ShelleyLedgerEra era)
</span><a href="#local-6989586621679482333"><span class="hs-identifier hs-var">script</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">ShelleyBasedEra era
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.ShelleyBasedEraAllegra</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-328"></span><span>      </span><span class="annot"><span class="annottext">ScriptLanguageInEra SimpleScriptV2 AllegraEra
-&gt; Script SimpleScriptV2 -&gt; ScriptInEra AllegraEra
forall lang era.
ScriptLanguageInEra lang era -&gt; Script lang -&gt; ScriptInEra era
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.ScriptInEra</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLanguageInEra SimpleScriptV2 AllegraEra
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScriptV2InAllegra</span></a></span><span> </span><span class="annot"><span class="annottext">(Script SimpleScriptV2 -&gt; ScriptInEra AllegraEra)
-&gt; Script SimpleScriptV2 -&gt; ScriptInEra AllegraEra
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-329"></span><span>      </span><span class="annot"><span class="annottext">SimpleScriptVersion SimpleScriptV2
-&gt; SimpleScript SimpleScriptV2 -&gt; Script SimpleScriptV2
forall lang.
SimpleScriptVersion lang -&gt; SimpleScript lang -&gt; Script lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScript</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleScriptVersion SimpleScriptV2
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScriptV2</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleScript SimpleScriptV2 -&gt; Script SimpleScriptV2)
-&gt; SimpleScript SimpleScriptV2 -&gt; Script SimpleScriptV2
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-330"></span><span>      </span><span class="annot"><span class="annottext">TimeLocksSupported SimpleScriptV2
-&gt; Timelock StandardCrypto -&gt; SimpleScript SimpleScriptV2
forall lang.
TimeLocksSupported lang
-&gt; Timelock StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482324"><span class="hs-identifier hs-var">fromAllegraTimelock</span></a></span><span> </span><span class="annot"><span class="annottext">TimeLocksSupported SimpleScriptV2
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.TimeLocksInSimpleScriptV2</span></a></span><span> </span><span class="annot"><span class="annottext">Timelock StandardCrypto
Script (ShelleyLedgerEra era)
</span><a href="#local-6989586621679482333"><span class="hs-identifier hs-var">script</span></a></span><span>
</span><span id="line-331"></span><span>    </span><span class="annot"><span class="annottext">ShelleyBasedEra era
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.ShelleyBasedEraMary</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-332"></span><span>      </span><span class="annot"><span class="annottext">ScriptLanguageInEra SimpleScriptV2 MaryEra
-&gt; Script SimpleScriptV2 -&gt; ScriptInEra MaryEra
forall lang era.
ScriptLanguageInEra lang era -&gt; Script lang -&gt; ScriptInEra era
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.ScriptInEra</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLanguageInEra SimpleScriptV2 MaryEra
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScriptV2InMary</span></a></span><span> </span><span class="annot"><span class="annottext">(Script SimpleScriptV2 -&gt; ScriptInEra MaryEra)
-&gt; Script SimpleScriptV2 -&gt; ScriptInEra MaryEra
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-333"></span><span>      </span><span class="annot"><span class="annottext">SimpleScriptVersion SimpleScriptV2
-&gt; SimpleScript SimpleScriptV2 -&gt; Script SimpleScriptV2
forall lang.
SimpleScriptVersion lang -&gt; SimpleScript lang -&gt; Script lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScript</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleScriptVersion SimpleScriptV2
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScriptV2</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleScript SimpleScriptV2 -&gt; Script SimpleScriptV2)
-&gt; SimpleScript SimpleScriptV2 -&gt; Script SimpleScriptV2
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-334"></span><span>      </span><span class="annot"><span class="annottext">TimeLocksSupported SimpleScriptV2
-&gt; Timelock StandardCrypto -&gt; SimpleScript SimpleScriptV2
forall lang.
TimeLocksSupported lang
-&gt; Timelock StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482324"><span class="hs-identifier hs-var">fromAllegraTimelock</span></a></span><span> </span><span class="annot"><span class="annottext">TimeLocksSupported SimpleScriptV2
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.TimeLocksInSimpleScriptV2</span></a></span><span> </span><span class="annot"><span class="annottext">Timelock StandardCrypto
Script (ShelleyLedgerEra era)
</span><a href="#local-6989586621679482333"><span class="hs-identifier hs-var">script</span></a></span><span>
</span><span id="line-335"></span><span>    </span><span class="annot"><span class="annottext">ShelleyBasedEra era
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.ShelleyBasedEraAlonzo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-336"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Script (ShelleyLedgerEra era)
</span><a href="#local-6989586621679482333"><span class="hs-identifier hs-var">script</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-337"></span><span>        </span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier hs-type">Alonzo.TimelockScript</span></a></span><span> </span><span id="local-6989586621679482318"><span class="annot"><a href="#local-6989586621679482318"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-338"></span><span>          </span><span class="annot"><span class="annottext">ScriptLanguageInEra SimpleScriptV2 AlonzoEra
-&gt; Script SimpleScriptV2 -&gt; ScriptInEra AlonzoEra
forall lang era.
ScriptLanguageInEra lang era -&gt; Script lang -&gt; ScriptInEra era
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.ScriptInEra</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLanguageInEra SimpleScriptV2 AlonzoEra
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScriptV2InAlonzo</span></a></span><span> </span><span class="annot"><span class="annottext">(Script SimpleScriptV2 -&gt; ScriptInEra AlonzoEra)
-&gt; Script SimpleScriptV2 -&gt; ScriptInEra AlonzoEra
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-339"></span><span>          </span><span class="annot"><span class="annottext">SimpleScriptVersion SimpleScriptV2
-&gt; SimpleScript SimpleScriptV2 -&gt; Script SimpleScriptV2
forall lang.
SimpleScriptVersion lang -&gt; SimpleScript lang -&gt; Script lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScript</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleScriptVersion SimpleScriptV2
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScriptV2</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleScript SimpleScriptV2 -&gt; Script SimpleScriptV2)
-&gt; SimpleScript SimpleScriptV2 -&gt; Script SimpleScriptV2
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-340"></span><span>          </span><span class="annot"><span class="annottext">TimeLocksSupported SimpleScriptV2
-&gt; Timelock StandardCrypto -&gt; SimpleScript SimpleScriptV2
forall lang.
TimeLocksSupported lang
-&gt; Timelock StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482324"><span class="hs-identifier hs-var">fromAllegraTimelock</span></a></span><span> </span><span class="annot"><span class="annottext">TimeLocksSupported SimpleScriptV2
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.TimeLocksInSimpleScriptV2</span></a></span><span> </span><span class="annot"><span class="annottext">Timelock StandardCrypto
Timelock (Crypto (AlonzoEra StandardCrypto))
</span><a href="#local-6989586621679482318"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-341"></span><span>        </span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier hs-type">Alonzo.PlutusScript</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier hs-type">Alonzo.PlutusV1</span></a></span><span> </span><span id="local-6989586621679482314"><span class="annot"><a href="#local-6989586621679482314"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-342"></span><span>          </span><span class="annot"><span class="annottext">ScriptLanguageInEra PlutusScriptV1 AlonzoEra
-&gt; Script PlutusScriptV1 -&gt; ScriptInEra AlonzoEra
forall lang era.
ScriptLanguageInEra lang era -&gt; Script lang -&gt; ScriptInEra era
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.ScriptInEra</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLanguageInEra PlutusScriptV1 AlonzoEra
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.PlutusScriptV1InAlonzo</span></a></span><span> </span><span class="annot"><span class="annottext">(Script PlutusScriptV1 -&gt; ScriptInEra AlonzoEra)
-&gt; Script PlutusScriptV1 -&gt; ScriptInEra AlonzoEra
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-343"></span><span>          </span><span class="annot"><span class="annottext">PlutusScriptVersion PlutusScriptV1
-&gt; PlutusScript PlutusScriptV1 -&gt; Script PlutusScriptV1
forall lang.
PlutusScriptVersion lang -&gt; PlutusScript lang -&gt; Script lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.PlutusScript</span></a></span><span> </span><span class="annot"><span class="annottext">PlutusScriptVersion PlutusScriptV1
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.PlutusScriptV1</span></a></span><span> </span><span class="annot"><span class="annottext">(PlutusScript PlutusScriptV1 -&gt; Script PlutusScriptV1)
-&gt; PlutusScript PlutusScriptV1 -&gt; Script PlutusScriptV1
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-344"></span><span>          </span><span class="annot"><span class="annottext">ShortByteString -&gt; PlutusScript PlutusScriptV1
forall lang. ShortByteString -&gt; PlutusScript lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.PlutusScriptSerialised</span></a></span><span> </span><span class="annot"><span class="annottext">ShortByteString
</span><a href="#local-6989586621679482314"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-345"></span><span>        </span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier hs-type">Alonzo.PlutusScript</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier hs-type">Alonzo.PlutusV2</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-346"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ScriptInEra era
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;fromShelleyBasedScript: PlutusV2 not supported in Alonzo era&quot;</span></span><span>
</span><span id="line-347"></span><span>    </span><span class="annot"><span class="annottext">ShelleyBasedEra era
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.ShelleyBasedEraBabbage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-348"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Script (ShelleyLedgerEra era)
</span><a href="#local-6989586621679482333"><span class="hs-identifier hs-var">script</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-349"></span><span>        </span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier hs-type">Alonzo.TimelockScript</span></a></span><span> </span><span id="local-6989586621679482307"><span class="annot"><a href="#local-6989586621679482307"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-350"></span><span>          </span><span class="annot"><span class="annottext">ScriptLanguageInEra SimpleScriptV2 BabbageEra
-&gt; Script SimpleScriptV2 -&gt; ScriptInEra BabbageEra
forall lang era.
ScriptLanguageInEra lang era -&gt; Script lang -&gt; ScriptInEra era
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.ScriptInEra</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLanguageInEra SimpleScriptV2 BabbageEra
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScriptV2InBabbage</span></a></span><span> </span><span class="annot"><span class="annottext">(Script SimpleScriptV2 -&gt; ScriptInEra BabbageEra)
-&gt; Script SimpleScriptV2 -&gt; ScriptInEra BabbageEra
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-351"></span><span>          </span><span class="annot"><span class="annottext">SimpleScriptVersion SimpleScriptV2
-&gt; SimpleScript SimpleScriptV2 -&gt; Script SimpleScriptV2
forall lang.
SimpleScriptVersion lang -&gt; SimpleScript lang -&gt; Script lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScript</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleScriptVersion SimpleScriptV2
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.SimpleScriptV2</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleScript SimpleScriptV2 -&gt; Script SimpleScriptV2)
-&gt; SimpleScript SimpleScriptV2 -&gt; Script SimpleScriptV2
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-352"></span><span>          </span><span class="annot"><span class="annottext">TimeLocksSupported SimpleScriptV2
-&gt; Timelock StandardCrypto -&gt; SimpleScript SimpleScriptV2
forall lang.
TimeLocksSupported lang
-&gt; Timelock StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482324"><span class="hs-identifier hs-var">fromAllegraTimelock</span></a></span><span> </span><span class="annot"><span class="annottext">TimeLocksSupported SimpleScriptV2
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.TimeLocksInSimpleScriptV2</span></a></span><span> </span><span class="annot"><span class="annottext">Timelock StandardCrypto
Timelock (Crypto (BabbageEra StandardCrypto))
</span><a href="#local-6989586621679482307"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-353"></span><span>        </span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier hs-type">Alonzo.PlutusScript</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier hs-type">Alonzo.PlutusV1</span></a></span><span> </span><span id="local-6989586621679482305"><span class="annot"><a href="#local-6989586621679482305"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-354"></span><span>          </span><span class="annot"><span class="annottext">ScriptLanguageInEra PlutusScriptV1 BabbageEra
-&gt; Script PlutusScriptV1 -&gt; ScriptInEra BabbageEra
forall lang era.
ScriptLanguageInEra lang era -&gt; Script lang -&gt; ScriptInEra era
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.ScriptInEra</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLanguageInEra PlutusScriptV1 BabbageEra
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.PlutusScriptV1InBabbage</span></a></span><span> </span><span class="annot"><span class="annottext">(Script PlutusScriptV1 -&gt; ScriptInEra BabbageEra)
-&gt; Script PlutusScriptV1 -&gt; ScriptInEra BabbageEra
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-355"></span><span>          </span><span class="annot"><span class="annottext">PlutusScriptVersion PlutusScriptV1
-&gt; PlutusScript PlutusScriptV1 -&gt; Script PlutusScriptV1
forall lang.
PlutusScriptVersion lang -&gt; PlutusScript lang -&gt; Script lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.PlutusScript</span></a></span><span> </span><span class="annot"><span class="annottext">PlutusScriptVersion PlutusScriptV1
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.PlutusScriptV1</span></a></span><span> </span><span class="annot"><span class="annottext">(PlutusScript PlutusScriptV1 -&gt; Script PlutusScriptV1)
-&gt; PlutusScript PlutusScriptV1 -&gt; Script PlutusScriptV1
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-356"></span><span>          </span><span class="annot"><span class="annottext">ShortByteString -&gt; PlutusScript PlutusScriptV1
forall lang. ShortByteString -&gt; PlutusScript lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.PlutusScriptSerialised</span></a></span><span> </span><span class="annot"><span class="annottext">ShortByteString
</span><a href="#local-6989586621679482305"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-357"></span><span>        </span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier hs-type">Alonzo.PlutusScript</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier hs-type">Alonzo.PlutusV2</span></a></span><span> </span><span id="local-6989586621679482303"><span class="annot"><a href="#local-6989586621679482303"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-358"></span><span>          </span><span class="annot"><span class="annottext">ScriptLanguageInEra PlutusScriptV2 BabbageEra
-&gt; Script PlutusScriptV2 -&gt; ScriptInEra BabbageEra
forall lang era.
ScriptLanguageInEra lang era -&gt; Script lang -&gt; ScriptInEra era
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.ScriptInEra</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLanguageInEra PlutusScriptV2 BabbageEra
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.PlutusScriptV2InBabbage</span></a></span><span> </span><span class="annot"><span class="annottext">(Script PlutusScriptV2 -&gt; ScriptInEra BabbageEra)
-&gt; Script PlutusScriptV2 -&gt; ScriptInEra BabbageEra
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-359"></span><span>          </span><span class="annot"><span class="annottext">PlutusScriptVersion PlutusScriptV2
-&gt; PlutusScript PlutusScriptV2 -&gt; Script PlutusScriptV2
forall lang.
PlutusScriptVersion lang -&gt; PlutusScript lang -&gt; Script lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.PlutusScript</span></a></span><span> </span><span class="annot"><span class="annottext">PlutusScriptVersion PlutusScriptV2
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.PlutusScriptV2</span></a></span><span> </span><span class="annot"><span class="annottext">(PlutusScript PlutusScriptV2 -&gt; Script PlutusScriptV2)
-&gt; PlutusScript PlutusScriptV2 -&gt; Script PlutusScriptV2
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-360"></span><span>          </span><span class="annot"><span class="annottext">ShortByteString -&gt; PlutusScript PlutusScriptV2
forall lang. ShortByteString -&gt; PlutusScript lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.PlutusScriptSerialised</span></a></span><span> </span><span class="annot"><span class="annottext">ShortByteString
</span><a href="#local-6989586621679482303"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-363"></span><span>  </span><span id="local-6989586621679482578"><span class="annot"><a href="#local-6989586621679482324"><span class="hs-identifier hs-type">fromAllegraTimelock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Shelley.TimeLocksSupported</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679482578"><span class="hs-identifier hs-type">lang</span></a></span><span>
</span><span id="line-364"></span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-shelley-ma/html/src"><span class="hs-identifier hs-type">Timelock.Timelock</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">LedgerCrypto.StandardCrypto</span></a></span><span>
</span><span id="line-365"></span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Shelley.SimpleScript</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679482578"><span class="hs-identifier hs-type">lang</span></a></span></span><span>
</span><span id="line-366"></span><span>  </span><span id="local-6989586621679482324"><span class="annot"><span class="annottext">fromAllegraTimelock :: TimeLocksSupported lang
-&gt; Timelock StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482324"><span class="hs-identifier hs-var hs-var">fromAllegraTimelock</span></a></span></span><span> </span><span id="local-6989586621679482300"><span class="annot"><span class="annottext">TimeLocksSupported lang
</span><a href="#local-6989586621679482300"><span class="hs-identifier hs-var">timelocks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Timelock StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482299"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-367"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-368"></span><span>      </span><span id="local-6989586621679482299"><span class="annot"><span class="annottext">go :: Timelock StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482299"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-shelley-ma/html/src"><span class="hs-identifier hs-type">Timelock.RequireSignature</span></a></span><span> </span><span id="local-6989586621679482297"><span class="annot"><span class="annottext">KeyHash 'Witness StandardCrypto
</span><a href="#local-6989586621679482297"><span class="hs-identifier hs-var">kh</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash PaymentKey -&gt; SimpleScript lang
forall lang. Hash PaymentKey -&gt; SimpleScript lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.RequireSignature</span></a></span><span>
</span><span id="line-369"></span><span>                                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyHash 'Payment StandardCrypto -&gt; Hash PaymentKey
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.PaymentKeyHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyHash 'Witness StandardCrypto -&gt; KeyHash 'Payment StandardCrypto
forall (a :: KeyRole -&gt; * -&gt; *) (r :: KeyRole) crypto
       (r' :: KeyRole).
HasKeyRole a =&gt;
a r crypto -&gt; a r' crypto
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">LedgerShelley.coerceKeyRole</span></a></span><span> </span><span class="annot"><span class="annottext">KeyHash 'Witness StandardCrypto
</span><a href="#local-6989586621679482297"><span class="hs-identifier hs-var">kh</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>      </span><span class="annot"><a href="#local-6989586621679482299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-shelley-ma/html/src"><span class="hs-identifier hs-type">Timelock.RequireTimeExpire</span></a></span><span> </span><span id="local-6989586621679482292"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482292"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TimeLocksSupported lang -&gt; SlotNo -&gt; SimpleScript lang
forall lang. TimeLocksSupported lang -&gt; SlotNo -&gt; SimpleScript lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.RequireTimeBefore</span></a></span><span> </span><span class="annot"><span class="annottext">TimeLocksSupported lang
</span><a href="#local-6989586621679482300"><span class="hs-identifier hs-var">timelocks</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482292"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-371"></span><span>      </span><span class="annot"><a href="#local-6989586621679482299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-shelley-ma/html/src"><span class="hs-identifier hs-type">Timelock.RequireTimeStart</span></a></span><span>  </span><span id="local-6989586621679482289"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482289"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TimeLocksSupported lang -&gt; SlotNo -&gt; SimpleScript lang
forall lang. TimeLocksSupported lang -&gt; SlotNo -&gt; SimpleScript lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.RequireTimeAfter</span></a></span><span>  </span><span class="annot"><span class="annottext">TimeLocksSupported lang
</span><a href="#local-6989586621679482300"><span class="hs-identifier hs-var">timelocks</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679482289"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-372"></span><span>      </span><span class="annot"><a href="#local-6989586621679482299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-shelley-ma/html/src"><span class="hs-identifier hs-type">Timelock.RequireAllOf</span></a></span><span>      </span><span id="local-6989586621679482286"><span class="annot"><span class="annottext">StrictSeq (Timelock StandardCrypto)
</span><a href="#local-6989586621679482286"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SimpleScript lang] -&gt; SimpleScript lang
forall lang. [SimpleScript lang] -&gt; SimpleScript lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.RequireAllOf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Timelock StandardCrypto -&gt; SimpleScript lang)
-&gt; [Timelock StandardCrypto] -&gt; [SimpleScript lang]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Timelock StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictSeq (Timelock StandardCrypto) -&gt; [Timelock StandardCrypto]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq (Timelock StandardCrypto)
</span><a href="#local-6989586621679482286"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>      </span><span class="annot"><a href="#local-6989586621679482299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-shelley-ma/html/src"><span class="hs-identifier hs-type">Timelock.RequireAnyOf</span></a></span><span>      </span><span id="local-6989586621679482283"><span class="annot"><span class="annottext">StrictSeq (Timelock StandardCrypto)
</span><a href="#local-6989586621679482283"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SimpleScript lang] -&gt; SimpleScript lang
forall lang. [SimpleScript lang] -&gt; SimpleScript lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.RequireAnyOf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Timelock StandardCrypto -&gt; SimpleScript lang)
-&gt; [Timelock StandardCrypto] -&gt; [SimpleScript lang]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Timelock StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictSeq (Timelock StandardCrypto) -&gt; [Timelock StandardCrypto]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq (Timelock StandardCrypto)
</span><a href="#local-6989586621679482283"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>      </span><span class="annot"><a href="#local-6989586621679482299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-shelley-ma/html/src"><span class="hs-identifier hs-type">Timelock.RequireMOf</span></a></span><span>      </span><span id="local-6989586621679482280"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679482280"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679482279"><span class="annot"><span class="annottext">StrictSeq (Timelock StandardCrypto)
</span><a href="#local-6989586621679482279"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [SimpleScript lang] -&gt; SimpleScript lang
forall lang. Int -&gt; [SimpleScript lang] -&gt; SimpleScript lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.RequireMOf</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679482280"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Timelock StandardCrypto -&gt; SimpleScript lang)
-&gt; [Timelock StandardCrypto] -&gt; [SimpleScript lang]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Timelock StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482299"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictSeq (Timelock StandardCrypto) -&gt; [Timelock StandardCrypto]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq (Timelock StandardCrypto)
</span><a href="#local-6989586621679482279"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>
</span><span id="line-376"></span><span>  </span><span id="local-6989586621679482583"><span class="annot"><a href="#local-6989586621679482328"><span class="hs-identifier hs-type">fromShelleyMultiSig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier hs-type">LedgerShelley.MultiSig</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">LedgerCrypto.StandardCrypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Shelley.SimpleScript</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679482583"><span class="hs-identifier hs-type">lang</span></a></span></span><span>
</span><span id="line-377"></span><span>  </span><span id="local-6989586621679482328"><span class="annot"><span class="annottext">fromShelleyMultiSig :: MultiSig StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482328"><span class="hs-identifier hs-var hs-var">fromShelleyMultiSig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MultiSig StandardCrypto -&gt; SimpleScript lang
forall lang. MultiSig StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482277"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-378"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-379"></span><span>      </span><span id="local-6989586621679482277"><span class="annot"><span class="annottext">go :: MultiSig StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482277"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier hs-type">LedgerShelley.RequireSignature</span></a></span><span> </span><span id="local-6989586621679482275"><span class="annot"><span class="annottext">KeyHash 'Witness StandardCrypto
</span><a href="#local-6989586621679482275"><span class="hs-identifier hs-var">kh</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>                                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash PaymentKey -&gt; SimpleScript lang
forall lang. Hash PaymentKey -&gt; SimpleScript lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.RequireSignature</span></a></span><span>
</span><span id="line-381"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyHash 'Payment StandardCrypto -&gt; Hash PaymentKey
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.PaymentKeyHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyHash 'Witness StandardCrypto -&gt; KeyHash 'Payment StandardCrypto
forall (a :: KeyRole -&gt; * -&gt; *) (r :: KeyRole) crypto
       (r' :: KeyRole).
HasKeyRole a =&gt;
a r crypto -&gt; a r' crypto
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">LedgerShelley.coerceKeyRole</span></a></span><span> </span><span class="annot"><span class="annottext">KeyHash 'Witness StandardCrypto
</span><a href="#local-6989586621679482275"><span class="hs-identifier hs-var">kh</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-382"></span><span>      </span><span class="annot"><a href="#local-6989586621679482277"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier hs-type">LedgerShelley.RequireAllOf</span></a></span><span> </span><span id="local-6989586621679482273"><span class="annot"><span class="annottext">[MultiSig StandardCrypto]
</span><a href="#local-6989586621679482273"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SimpleScript lang] -&gt; SimpleScript lang
forall lang. [SimpleScript lang] -&gt; SimpleScript lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.RequireAllOf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(MultiSig StandardCrypto -&gt; SimpleScript lang)
-&gt; [MultiSig StandardCrypto] -&gt; [SimpleScript lang]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSig StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482277"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[MultiSig StandardCrypto]
</span><a href="#local-6989586621679482273"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>      </span><span class="annot"><a href="#local-6989586621679482277"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier hs-type">LedgerShelley.RequireAnyOf</span></a></span><span> </span><span id="local-6989586621679482271"><span class="annot"><span class="annottext">[MultiSig StandardCrypto]
</span><a href="#local-6989586621679482271"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SimpleScript lang] -&gt; SimpleScript lang
forall lang. [SimpleScript lang] -&gt; SimpleScript lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.RequireAnyOf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(MultiSig StandardCrypto -&gt; SimpleScript lang)
-&gt; [MultiSig StandardCrypto] -&gt; [SimpleScript lang]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSig StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482277"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[MultiSig StandardCrypto]
</span><a href="#local-6989586621679482271"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>      </span><span class="annot"><a href="#local-6989586621679482277"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier hs-type">LedgerShelley.RequireMOf</span></a></span><span> </span><span id="local-6989586621679482269"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679482269"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679482268"><span class="annot"><span class="annottext">[MultiSig StandardCrypto]
</span><a href="#local-6989586621679482268"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [SimpleScript lang] -&gt; SimpleScript lang
forall lang. Int -&gt; [SimpleScript lang] -&gt; SimpleScript lang
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">Shelley.RequireMOf</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679482269"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(MultiSig StandardCrypto -&gt; SimpleScript lang)
-&gt; [MultiSig StandardCrypto] -&gt; [SimpleScript lang]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSig StandardCrypto -&gt; SimpleScript lang
</span><a href="#local-6989586621679482277"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[MultiSig StandardCrypto]
</span><a href="#local-6989586621679482268"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-385"></span></pre></body></html>