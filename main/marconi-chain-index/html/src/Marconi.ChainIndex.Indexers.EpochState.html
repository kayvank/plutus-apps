<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds          #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances  #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GADTs              #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase         #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns     #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings  #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE QuasiQuotes        #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell    #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TupleSections      #-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-comment">-- | Module for indexing the stakepool delegation per epoch in the Cardano blockchain.</span><span>
</span><span id="line-13"></span><span class="hs-comment">--</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- This module will create the SQL tables:</span><span>
</span><span id="line-15"></span><span class="hs-comment">--</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- + table: epoch_sdd</span><span>
</span><span id="line-17"></span><span class="hs-comment">--</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-19"></span><span class="hs-comment">--    |---------+--------+----------+--------+-----------------+---------|</span><span>
</span><span id="line-20"></span><span class="hs-comment">--    | epochNo | poolId | lovelace | slotNo | blockHeaderHash | blockNo |</span><span>
</span><span id="line-21"></span><span class="hs-comment">--    |---------+--------+----------+--------+-----------------+---------|</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-23"></span><span class="hs-comment">--</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- + table: epoch_nonce</span><span>
</span><span id="line-25"></span><span class="hs-comment">--</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-27"></span><span class="hs-comment">--    |---------+-------+--------+-----------------+---------|</span><span>
</span><span id="line-28"></span><span class="hs-comment">--    | epochNo | nonce | slotNo | blockHeaderHash | blockNo |</span><span>
</span><span id="line-29"></span><span class="hs-comment">--    |---------+-------+--------+-----------------+---------|</span><span>
</span><span id="line-30"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-31"></span><span class="hs-comment">--</span><span>
</span><span id="line-32"></span><span class="hs-comment">-- To create those tables, we need to compute the `ExtLedgerState` from `ouroboros-network`</span><span>
</span><span id="line-33"></span><span class="hs-comment">-- (combination of `LedgerState, called `NewEpochState` in `cardano-ledger`, and the `HeaderState`)</span><span>
</span><span id="line-34"></span><span class="hs-comment">-- at each 'Rollforward' chain sync event. Using the `ExtLegderState`, we can easily compute the</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- epoch nonce as well as the stake pool delegation for that epoch.</span><span>
</span><span id="line-36"></span><span class="hs-comment">--</span><span>
</span><span id="line-37"></span><span class="hs-comment">-- The main issue with this indexer is that building the ExtLedgerState and saving it on disk for being</span><span>
</span><span id="line-38"></span><span class="hs-comment">-- able to resume is VERY resource intensive. Syncing time for this indexer is over 20h and uses</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- about ~16GB of RAM (which will keep increasing as the blockchain continues to grow).</span><span>
</span><span id="line-40"></span><span class="hs-comment">--</span><span>
</span><span id="line-41"></span><span class="hs-comment">-- Here is a synopsis of what this indexer does.</span><span>
</span><span id="line-42"></span><span class="hs-comment">--</span><span>
</span><span id="line-43"></span><span class="hs-comment">-- We assume that the construction of 'LedgerState' is done outside of this indexer (this module).</span><span>
</span><span id="line-44"></span><span class="hs-comment">--</span><span>
</span><span id="line-45"></span><span class="hs-comment">--   * the 'Storable.insert' function is called with the *last* event of an epoch (therefore, the</span><span>
</span><span id="line-46"></span><span class="hs-comment">--   last 'LedgerState' before starting a new epoch). We do that because we only care about the SDD</span><span>
</span><span id="line-47"></span><span class="hs-comment">--   (Stake Pool Delegation) from the last block before a new epoch.</span><span>
</span><span id="line-48"></span><span class="hs-comment">--</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- Once the 'Storable.StorableEvent' is stored on disk, we perform various steps:</span><span>
</span><span id="line-50"></span><span class="hs-comment">--</span><span>
</span><span id="line-51"></span><span class="hs-comment">--   1. we save the SDD for the current epoch in the `epoch_sdd` table</span><span>
</span><span id="line-52"></span><span class="hs-comment">--   2. we save the 'LedgerState's in the filesystem as binary files (the ledger state file path has</span><span>
</span><span id="line-53"></span><span class="hs-comment">--   the format: `ledgerState_&lt;SLOT_NO&gt;_&lt;BLOCK_HEADER_HASH&gt;_&lt;BLOCK_NO&gt;.bin`). We only store a</span><span>
</span><span id="line-54"></span><span class="hs-comment">--   'LedgerState' if it's rollbackable or if the last one of a given epoch. This step is necessary</span><span>
</span><span id="line-55"></span><span class="hs-comment">--   for resuming the indexer.</span><span>
</span><span id="line-56"></span><span class="hs-comment">--   3. we delete immutable 'LedgerState' binary files expect latest one (this step is necessary for</span><span>
</span><span id="line-57"></span><span class="hs-comment">--</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- The indexer provides the following queries:</span><span>
</span><span id="line-59"></span><span class="hs-comment">--</span><span>
</span><span id="line-60"></span><span class="hs-comment">--   * C.EpochNo -&gt; SDD (the actualy query that clients will be interested in)</span><span>
</span><span id="line-61"></span><span class="hs-comment">--   * C.ChainPoint -&gt; LedgerState (query that is necessary for resuming)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Marconi.ChainIndex.Indexers.EpochState</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * EpochStateIndex</span></span><span>
</span><span id="line-64"></span><span>    </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateIndex"><span class="hs-identifier">EpochStateIndex</span></a></span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier">EpochStateHandle</span></a></span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochSDDRow"><span class="hs-identifier">EpochSDDRow</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochNonceRow"><span class="hs-identifier">EpochNonceRow</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableEvent</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableQuery</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableResult</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#toStorableEvent"><span class="hs-identifier">toStorableEvent</span></a></span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#open"><span class="hs-identifier">open</span></a></span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#getEpochNo"><span class="hs-identifier">getEpochNo</span></a></span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Cardano.Api</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Cardano.Api.Shelley</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Coin</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ledger</span></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Compactible</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ledger</span></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Era</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ledger</span></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier">Cardano.Ledger.Shelley.API</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ledger</span></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-protocol-tpraos/html/src"><span class="hs-identifier">Cardano.Protocol.TPraos.API</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Shelley</span></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-protocol-tpraos/html/src"><span class="hs-identifier">Cardano.Protocol.TPraos.Rules.Tickn</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Shelley</span></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier">Cardano.Slotting.Slot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier">EpochNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cborg/html/src"><span class="hs-identifier">Codec.CBOR.Read</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cborg/html/src"><span class="hs-identifier">Codec.CBOR.Write</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">filterM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">forM_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">when</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier">Data.Aeson</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier">FromJSON</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier">parseJSON</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier">ToJSON</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier">toJSON</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier">Value</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier">Object</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier">object</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-operator">(.:)</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-operator">(.=)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../base16-bytestring/html/src"><span class="hs-identifier">Data.ByteString.Base16</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Base16</span></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../bytestring/html/src"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Coerce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier">coerce</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Data</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Proxy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Proxy</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">toList</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">List</span></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">catMaybes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">listToMaybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">mapMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Ord</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Down</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Down</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier">Data.Text.Encoding</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Tuple</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">swap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../vector-map/html/src"><span class="hs-identifier">Data.VMap</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VMap</span></span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier">Database.SQLite.Simple</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SQL</span></span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Orphans.html"><span class="hs-identifier">Marconi.ChainIndex.Orphans</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Types.html"><span class="hs-identifier">Marconi.ChainIndex.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Types.html#SecurityParam"><span class="hs-identifier">SecurityParam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Utils.html"><span class="hs-identifier">Marconi.ChainIndex.Utils</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Utils.html#isBlockRollbackable"><span class="hs-identifier">isBlockRollbackable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Marconi.Core.Storable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Buffered</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">persistToStorage</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">HasPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">getPoint</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">QueryInterval</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Queryable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">queryStorage</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-111"></span><span>                              </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Resumable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Rewindable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">rewindStorage</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">State</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableEvent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableMonad</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorablePoint</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-112"></span><span>                              </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableQuery</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">emptyState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Marconi.Core.Storable</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Storable</span></span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier">Ouroboros.Consensus.Cardano.Block</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">O</span></span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier">Ouroboros.Consensus.Config</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">O</span></span><span>
</span><span id="line-116"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier">Ouroboros.Consensus.HeaderValidation</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">O</span></span><span>
</span><span id="line-117"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">O</span></span><span>
</span><span id="line-118"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus-protocol/html/src"><span class="hs-identifier">Ouroboros.Consensus.Protocol.Praos</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">O</span></span><span>
</span><span id="line-119"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus-protocol/html/src"><span class="hs-identifier">Ouroboros.Consensus.Protocol.TPraos</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">O</span></span><span>
</span><span id="line-120"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus-shelley/html/src"><span class="hs-identifier">Ouroboros.Consensus.Shelley.Ledger</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">O</span></span><span>
</span><span id="line-121"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier">Ouroboros.Consensus.Storage.Serialisation</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">O</span></span><span>
</span><span id="line-122"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../directory/html/src"><span class="hs-identifier">System.Directory</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../directory/html/src"><span class="hs-identifier">listDirectory</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../directory/html/src"><span class="hs-identifier">removeFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../filepath/html/src"><span class="hs-identifier">System.FilePath</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../filepath/html/src"><span class="hs-identifier">dropExtension</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../filepath/html/src"><span class="hs-operator">(&lt;/&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../raw-strings-qq/html/src"><span class="hs-identifier">Text.RawString.QQ</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../raw-strings-qq/html/src"><span class="hs-identifier">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Text.Read</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">readMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-keyword">data</span><span> </span><span id="EpochStateHandle"><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-var">EpochStateHandle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EpochStateHandle"><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-var">EpochStateHandle</span></a></span></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="_epochStateHandleTopLevelCfg"><span class="annot"><span class="annottext">EpochStateHandle -&gt; TopLevelConfig (CardanoBlock StandardCrypto)
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#_epochStateHandleTopLevelCfg"><span class="hs-identifier hs-var hs-var">_epochStateHandleTopLevelCfg</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-type">O.TopLevelConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.CardanoBlock</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">O.StandardCrypto</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_epochStateHandleConnection"><span class="annot"><span class="annottext">EpochStateHandle -&gt; Connection
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#_epochStateHandleConnection"><span class="hs-identifier hs-var hs-var">_epochStateHandleConnection</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-type">SQL.Connection</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_epochStateHandleLedgerStateDirPath"><span class="annot"><span class="annottext">EpochStateHandle -&gt; FilePath
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#_epochStateHandleLedgerStateDirPath"><span class="hs-identifier hs-var hs-var">_epochStateHandleLedgerStateDirPath</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_epochStateHandleSecurityParam"><span class="annot"><span class="annottext">EpochStateHandle -&gt; SecurityParam
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#_epochStateHandleSecurityParam"><span class="hs-identifier hs-var hs-var">_epochStateHandleSecurityParam</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Marconi.ChainIndex.Types.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="StorableMonad"><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">StorableMonad</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="StorableEvent"><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">StorableEvent</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-137"></span><span>    </span><span id="EpochStateEvent"><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateEvent"><span class="hs-identifier hs-var">EpochStateEvent</span></a></span></span><span>
</span><span id="line-138"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="epochStateEventLedgerState"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
-&gt; Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventLedgerState"><span class="hs-identifier hs-var hs-var">epochStateEventLedgerState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-type">O.ExtLedgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-type">O.HardForkBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.CardanoEras</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">O.StandardCrypto</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="epochStateEventEpochNo"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; Maybe EpochNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventEpochNo"><span class="hs-identifier hs-var hs-var">epochStateEventEpochNo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.EpochNo</span></a></span><span>
</span><span id="line-140"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="epochStateEventNonce"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; Nonce
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventNonce"><span class="hs-identifier hs-var hs-var">epochStateEventNonce</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Ledger.Nonce</span></a></span><span>
</span><span id="line-141"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="epochStateEventSDD"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; Map PoolId Lovelace
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventSDD"><span class="hs-identifier hs-var hs-var">epochStateEventSDD</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.PoolId</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.Lovelace</span></a></span><span>
</span><span id="line-142"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="epochStateEventSlotNo"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; SlotNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventSlotNo"><span class="hs-identifier hs-var hs-var">epochStateEventSlotNo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.SlotNo</span></a></span><span>
</span><span id="line-143"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="epochStateEventBlockHeaderHash"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; Hash BlockHeader
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventBlockHeaderHash"><span class="hs-identifier hs-var hs-var">epochStateEventBlockHeaderHash</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.Hash</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.BlockHeader</span></a></span><span>
</span><span id="line-144"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="epochStateEventBlockNo"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; BlockNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventBlockNo"><span class="hs-identifier hs-var hs-var">epochStateEventBlockNo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.BlockNo</span></a></span><span>
</span><span id="line-145"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="epochStateEventChainTip"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; ChainTip
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventChainTip"><span class="hs-identifier hs-var hs-var">epochStateEventChainTip</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ChainTip</span></a></span><span> </span><span class="hs-comment">-- ^ Actual tip of the chain</span><span>
</span><span id="line-146"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="epochStateEventIsFirstEventOfEpoch"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; Bool
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventIsFirstEventOfEpoch"><span class="hs-identifier hs-var hs-var">epochStateEventIsFirstEventOfEpoch</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-147"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679484115"><span id="local-6989586621679484117"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
-&gt; StorableEvent EpochStateHandle -&gt; Bool
(StorableEvent EpochStateHandle
 -&gt; StorableEvent EpochStateHandle -&gt; Bool)
-&gt; (StorableEvent EpochStateHandle
    -&gt; StorableEvent EpochStateHandle -&gt; Bool)
-&gt; Eq (StorableEvent EpochStateHandle)
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: StorableEvent EpochStateHandle
-&gt; StorableEvent EpochStateHandle -&gt; Bool
$c/= :: StorableEvent EpochStateHandle
-&gt; StorableEvent EpochStateHandle -&gt; Bool
== :: StorableEvent EpochStateHandle
-&gt; StorableEvent EpochStateHandle -&gt; Bool
$c== :: StorableEvent EpochStateHandle
-&gt; StorableEvent EpochStateHandle -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679484108"><span id="local-6989586621679484110"><span id="local-6989586621679484112"><span class="annot"><span class="annottext">Int -&gt; StorableEvent EpochStateHandle -&gt; ShowS
[StorableEvent EpochStateHandle] -&gt; ShowS
StorableEvent EpochStateHandle -&gt; FilePath
(Int -&gt; StorableEvent EpochStateHandle -&gt; ShowS)
-&gt; (StorableEvent EpochStateHandle -&gt; FilePath)
-&gt; ([StorableEvent EpochStateHandle] -&gt; ShowS)
-&gt; Show (StorableEvent EpochStateHandle)
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; FilePath) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [StorableEvent EpochStateHandle] -&gt; ShowS
$cshowList :: [StorableEvent EpochStateHandle] -&gt; ShowS
show :: StorableEvent EpochStateHandle -&gt; FilePath
$cshow :: StorableEvent EpochStateHandle -&gt; FilePath
showsPrec :: Int -&gt; StorableEvent EpochStateHandle -&gt; ShowS
$cshowsPrec :: Int -&gt; StorableEvent EpochStateHandle -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="StorablePoint"><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">StorablePoint</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ChainPoint</span></a></span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">HasPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ChainPoint</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-153"></span><span>  </span><span id="local-6989586621679484104"><span class="annot"><span class="annottext">getPoint :: StorableEvent EpochStateHandle -&gt; ChainPoint
</span><a href="#local-6989586621679484104"><span class="hs-identifier hs-var hs-var hs-var hs-var">getPoint</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateEvent"><span class="hs-identifier hs-type">EpochStateEvent</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679484103"><span class="annot"><a href="#local-6989586621679484103"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679484102"><span class="annot"><a href="#local-6989586621679484102"><span class="hs-identifier hs-var">bhh</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Hash BlockHeader -&gt; ChainPoint
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.ChainPoint</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484103"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679484102"><span class="hs-identifier hs-var">bhh</span></a></span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="StorableQuery"><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">StorableQuery</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-156"></span><span>    </span><span id="SDDByEpochNoQuery"><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#SDDByEpochNoQuery"><span class="hs-identifier hs-var">SDDByEpochNoQuery</span></a></span></span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.EpochNo</span></a></span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="NonceByEpochNoQuery"><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#NonceByEpochNoQuery"><span class="hs-identifier hs-var">NonceByEpochNoQuery</span></a></span></span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.EpochNo</span></a></span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="LedgerStateAtPointQuery"><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#LedgerStateAtPointQuery"><span class="hs-identifier hs-var">LedgerStateAtPointQuery</span></a></span></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ChainPoint</span></a></span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="StorableResult"><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">StorableResult</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-161"></span><span>    </span><span id="SDDByEpochNoResult"><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#SDDByEpochNoResult"><span class="hs-identifier hs-var">SDDByEpochNoResult</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochSDDRow"><span class="hs-identifier hs-type">EpochSDDRow</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="NonceByEpochNoResult"><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#NonceByEpochNoResult"><span class="hs-identifier hs-var">NonceByEpochNoResult</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochNonceRow"><span class="hs-identifier hs-type">EpochNonceRow</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="LedgerStateAtPointResult"><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#LedgerStateAtPointResult"><span class="hs-identifier hs-var">LedgerStateAtPointResult</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-type">O.ExtLedgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.CardanoBlock</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">O.StandardCrypto</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679484091"><span id="local-6989586621679484093"><span class="annot"><span class="annottext">StorableResult EpochStateHandle
-&gt; StorableResult EpochStateHandle -&gt; Bool
(StorableResult EpochStateHandle
 -&gt; StorableResult EpochStateHandle -&gt; Bool)
-&gt; (StorableResult EpochStateHandle
    -&gt; StorableResult EpochStateHandle -&gt; Bool)
-&gt; Eq (StorableResult EpochStateHandle)
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: StorableResult EpochStateHandle
-&gt; StorableResult EpochStateHandle -&gt; Bool
$c/= :: StorableResult EpochStateHandle
-&gt; StorableResult EpochStateHandle -&gt; Bool
== :: StorableResult EpochStateHandle
-&gt; StorableResult EpochStateHandle -&gt; Bool
$c== :: StorableResult EpochStateHandle
-&gt; StorableResult EpochStateHandle -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679484085"><span id="local-6989586621679484087"><span id="local-6989586621679484089"><span class="annot"><span class="annottext">Int -&gt; StorableResult EpochStateHandle -&gt; ShowS
[StorableResult EpochStateHandle] -&gt; ShowS
StorableResult EpochStateHandle -&gt; FilePath
(Int -&gt; StorableResult EpochStateHandle -&gt; ShowS)
-&gt; (StorableResult EpochStateHandle -&gt; FilePath)
-&gt; ([StorableResult EpochStateHandle] -&gt; ShowS)
-&gt; Show (StorableResult EpochStateHandle)
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; FilePath) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [StorableResult EpochStateHandle] -&gt; ShowS
$cshowList :: [StorableResult EpochStateHandle] -&gt; ShowS
show :: StorableResult EpochStateHandle -&gt; FilePath
$cshow :: StorableResult EpochStateHandle -&gt; FilePath
showsPrec :: Int -&gt; StorableResult EpochStateHandle -&gt; ShowS
$cshowsPrec :: Int -&gt; StorableResult EpochStateHandle -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span class="hs-keyword">type</span><span> </span><span id="EpochStateIndex"><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateIndex"><span class="hs-identifier hs-var">EpochStateIndex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#toStorableEvent"><span class="hs-identifier hs-type">toStorableEvent</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-type">O.ExtLedgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-type">O.HardForkBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.CardanoEras</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">O.StandardCrypto</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.SlotNo</span></a></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.Hash</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.BlockHeader</span></a></span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.BlockNo</span></a></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ChainTip</span></a></span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Types.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-comment">-- ^ Is the last event of the current epoch</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span>
</span><span id="line-177"></span><span id="toStorableEvent"><span class="annot"><span class="annottext">toStorableEvent :: ExtLedgerState (CardanoBlock StandardCrypto)
-&gt; SlotNo
-&gt; Hash BlockHeader
-&gt; BlockNo
-&gt; ChainTip
-&gt; SecurityParam
-&gt; Bool
-&gt; StorableEvent EpochStateHandle
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#toStorableEvent"><span class="hs-identifier hs-var hs-var">toStorableEvent</span></a></span></span><span> </span><span id="local-6989586621679484084"><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679484084"><span class="hs-identifier hs-var">extLedgerState</span></a></span></span><span> </span><span id="local-6989586621679484083"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484083"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span id="local-6989586621679484082"><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679484082"><span class="hs-identifier hs-var">bhh</span></a></span></span><span> </span><span id="local-6989586621679484081"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679484081"><span class="hs-identifier hs-var">bn</span></a></span></span><span> </span><span id="local-6989586621679484080"><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484080"><span class="hs-identifier hs-var">chainTip</span></a></span></span><span> </span><span id="local-6989586621679484079"><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484079"><span class="hs-identifier hs-var">securityParam</span></a></span></span><span> </span><span id="local-6989586621679484078"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679484078"><span class="hs-identifier hs-var">isFirstEventOfEpoch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679484077"><span class="annot"><span class="annottext">doesStoreLedgerState :: Bool
</span><a href="#local-6989586621679484077"><span class="hs-identifier hs-var hs-var">doesStoreLedgerState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecurityParam -&gt; BlockNo -&gt; ChainTip -&gt; Bool
</span><a href="Marconi.ChainIndex.Utils.html#isBlockRollbackable"><span class="hs-identifier hs-var">isBlockRollbackable</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484079"><span class="hs-identifier hs-var">securityParam</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679484081"><span class="hs-identifier hs-var">bn</span></a></span><span> </span><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484080"><span class="hs-identifier hs-var">chainTip</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679484078"><span class="hs-identifier hs-var">isFirstEventOfEpoch</span></a></span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><span class="annottext">Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
-&gt; Maybe EpochNo
-&gt; Nonce
-&gt; Map PoolId Lovelace
-&gt; SlotNo
-&gt; Hash BlockHeader
-&gt; BlockNo
-&gt; ChainTip
-&gt; Bool
-&gt; StorableEvent EpochStateHandle
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateEvent"><span class="hs-identifier hs-var">EpochStateEvent</span></a></span><span>
</span><span id="line-180"></span><span>        </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679484077"><span class="hs-identifier hs-var">doesStoreLedgerState</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
-&gt; Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679484084"><span class="hs-identifier hs-var">extLedgerState</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto) -&gt; Maybe EpochNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#getEpochNo"><span class="hs-identifier hs-var">getEpochNo</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679484084"><span class="hs-identifier hs-var">extLedgerState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto) -&gt; Nonce
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#getEpochNonce"><span class="hs-identifier hs-var">getEpochNonce</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679484084"><span class="hs-identifier hs-var">extLedgerState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto) -&gt; Map PoolId Lovelace
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#getStakeMap"><span class="hs-identifier hs-var">getStakeMap</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679484084"><span class="hs-identifier hs-var">extLedgerState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>        </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484083"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-185"></span><span>        </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679484082"><span class="hs-identifier hs-var">bhh</span></a></span><span>
</span><span id="line-186"></span><span>        </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679484081"><span class="hs-identifier hs-var">bn</span></a></span><span>
</span><span id="line-187"></span><span>        </span><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484080"><span class="hs-identifier hs-var">chainTip</span></a></span><span>
</span><span id="line-188"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679484078"><span class="hs-identifier hs-var">isFirstEventOfEpoch</span></a></span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-comment">-- | From LedgerState, get epoch stake pool delegation: a mapping of pool ID to amount staked in</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- lovelace. We do this by getting the '_pstakeSet' stake snapshot and then use '_delegations' and</span><span>
</span><span id="line-192"></span><span class="hs-comment">-- '_stake' to resolve it into the desired mapping.</span><span>
</span><span id="line-193"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#getStakeMap"><span class="hs-identifier hs-type">getStakeMap</span></a></span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-type">O.ExtLedgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.CardanoBlock</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">O.StandardCrypto</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.PoolId</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.Lovelace</span></a></span><span>
</span><span id="line-196"></span><span id="getStakeMap"><span class="annot"><span class="annottext">getStakeMap :: ExtLedgerState (CardanoBlock StandardCrypto) -&gt; Map PoolId Lovelace
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#getStakeMap"><span class="hs-identifier hs-var hs-var">getStakeMap</span></a></span></span><span> </span><span id="local-6989586621679484073"><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679484073"><span class="hs-identifier hs-var">extLedgerState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
-&gt; LedgerState (CardanoBlock StandardCrypto)
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var hs-var">O.ledgerState</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679484073"><span class="hs-identifier hs-var">extLedgerState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-197"></span><span>  </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.LedgerStateByron</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState ByronBlock
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map PoolId Lovelace
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.LedgerStateShelley</span></a></span><span> </span><span id="local-6989586621679484069"><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (ShelleyEra StandardCrypto))
</span><a href="#local-6989586621679484069"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (ShelleyEra StandardCrypto))
-&gt; Map PoolId Lovelace
forall proto era c.
(c ~ Crypto era, c ~ StandardCrypto) =&gt;
LedgerState (ShelleyBlock proto era) -&gt; Map PoolId Lovelace
</span><a href="#local-6989586621679484068"><span class="hs-identifier hs-var">getStakeMapFromShelleyBlock</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (ShelleyEra StandardCrypto))
</span><a href="#local-6989586621679484069"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.LedgerStateAllegra</span></a></span><span> </span><span id="local-6989586621679484066"><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (AllegraEra StandardCrypto))
</span><a href="#local-6989586621679484066"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (AllegraEra StandardCrypto))
-&gt; Map PoolId Lovelace
forall proto era c.
(c ~ Crypto era, c ~ StandardCrypto) =&gt;
LedgerState (ShelleyBlock proto era) -&gt; Map PoolId Lovelace
</span><a href="#local-6989586621679484068"><span class="hs-identifier hs-var">getStakeMapFromShelleyBlock</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (AllegraEra StandardCrypto))
</span><a href="#local-6989586621679484066"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-200"></span><span>  </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.LedgerStateMary</span></a></span><span> </span><span id="local-6989586621679484064"><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (MaryEra StandardCrypto))
</span><a href="#local-6989586621679484064"><span class="hs-identifier hs-var">st</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (MaryEra StandardCrypto))
-&gt; Map PoolId Lovelace
forall proto era c.
(c ~ Crypto era, c ~ StandardCrypto) =&gt;
LedgerState (ShelleyBlock proto era) -&gt; Map PoolId Lovelace
</span><a href="#local-6989586621679484068"><span class="hs-identifier hs-var">getStakeMapFromShelleyBlock</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (MaryEra StandardCrypto))
</span><a href="#local-6989586621679484064"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.LedgerStateAlonzo</span></a></span><span> </span><span id="local-6989586621679484062"><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (AlonzoEra StandardCrypto))
</span><a href="#local-6989586621679484062"><span class="hs-identifier hs-var">st</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (AlonzoEra StandardCrypto))
-&gt; Map PoolId Lovelace
forall proto era c.
(c ~ Crypto era, c ~ StandardCrypto) =&gt;
LedgerState (ShelleyBlock proto era) -&gt; Map PoolId Lovelace
</span><a href="#local-6989586621679484068"><span class="hs-identifier hs-var">getStakeMapFromShelleyBlock</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (AlonzoEra StandardCrypto))
</span><a href="#local-6989586621679484062"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-202"></span><span>  </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.LedgerStateBabbage</span></a></span><span> </span><span id="local-6989586621679484060"><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (Praos StandardCrypto) (BabbageEra StandardCrypto))
</span><a href="#local-6989586621679484060"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (Praos StandardCrypto) (BabbageEra StandardCrypto))
-&gt; Map PoolId Lovelace
forall proto era c.
(c ~ Crypto era, c ~ StandardCrypto) =&gt;
LedgerState (ShelleyBlock proto era) -&gt; Map PoolId Lovelace
</span><a href="#local-6989586621679484068"><span class="hs-identifier hs-var">getStakeMapFromShelleyBlock</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (Praos StandardCrypto) (BabbageEra StandardCrypto))
</span><a href="#local-6989586621679484060"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-204"></span><span>    </span><span class="annot"><a href="#local-6989586621679484068"><span class="hs-identifier hs-type">getStakeMapFromShelleyBlock</span></a></span><span>
</span><span id="line-205"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679484408"><span class="annot"><a href="#local-6989586621679484408"><span class="hs-identifier hs-type">proto</span></a></span></span><span> </span><span id="local-6989586621679484410"><span class="annot"><a href="#local-6989586621679484410"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span id="local-6989586621679484411"><span class="annot"><a href="#local-6989586621679484411"><span class="hs-identifier hs-type">c</span></a></span></span><span>
</span><span id="line-206"></span><span>       </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679484411"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Ledger.Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679484410"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679484411"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">O.StandardCrypto</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-type">O.LedgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ouroboros-consensus-shelley/html/src"><span class="hs-identifier hs-type">O.ShelleyBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679484408"><span class="hs-identifier hs-type">proto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679484410"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.PoolId</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.Lovelace</span></a></span><span>
</span><span id="line-209"></span><span>    </span><span id="local-6989586621679484068"><span class="annot"><span class="annottext">getStakeMapFromShelleyBlock :: LedgerState (ShelleyBlock proto era) -&gt; Map PoolId Lovelace
</span><a href="#local-6989586621679484068"><span class="hs-identifier hs-var hs-var">getStakeMapFromShelleyBlock</span></a></span></span><span> </span><span id="local-6989586621679484059"><span class="annot"><span class="annottext">LedgerState (ShelleyBlock proto era)
</span><a href="#local-6989586621679484059"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map PoolId Lovelace
</span><a href="#local-6989586621679484058"><span class="hs-identifier hs-var">sdd</span></a></span><span>
</span><span id="line-210"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-211"></span><span>        </span><span id="local-6989586621679484057"><span class="annot"><span class="annottext">nes :: NewEpochState era
</span><a href="#local-6989586621679484057"><span class="hs-identifier hs-var hs-var">nes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerState (ShelleyBlock proto era) -&gt; NewEpochState era
forall proto era.
LedgerState (ShelleyBlock proto era) -&gt; NewEpochState era
</span><a href="../../../../ouroboros-consensus-shelley/html/src"><span class="hs-identifier hs-var hs-var">O.shelleyLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState (ShelleyBlock proto era)
</span><a href="#local-6989586621679484059"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier hs-type">Ledger.NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679484410"><span class="hs-identifier hs-type">era</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span>        </span><span id="local-6989586621679484055"><span class="annot"><span class="annottext">stakeSnapshot :: SnapShot c
</span><a href="#local-6989586621679484055"><span class="hs-identifier hs-var hs-var">stakeSnapshot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SnapShots c -&gt; SnapShot c
forall crypto. SnapShots crypto -&gt; SnapShot crypto
</span><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier hs-var hs-var">Ledger._pstakeSet</span></a></span><span> </span><span class="annot"><span class="annottext">(SnapShots c -&gt; SnapShot c)
-&gt; (NewEpochState era -&gt; SnapShots c)
-&gt; NewEpochState era
-&gt; SnapShot c
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era -&gt; SnapShots c
forall era. EpochState era -&gt; SnapShots (Crypto era)
</span><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier hs-var hs-var">Ledger.esSnapshots</span></a></span><span> </span><span class="annot"><span class="annottext">(EpochState era -&gt; SnapShots c)
-&gt; (NewEpochState era -&gt; EpochState era)
-&gt; NewEpochState era
-&gt; SnapShots c
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">NewEpochState era -&gt; EpochState era
forall era. NewEpochState era -&gt; EpochState era
</span><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier hs-var hs-var">Ledger.nesEs</span></a></span><span> </span><span class="annot"><span class="annottext">(NewEpochState era -&gt; SnapShot c)
-&gt; NewEpochState era -&gt; SnapShot c
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621679484057"><span class="hs-identifier hs-var">nes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier hs-type">Ledger.SnapShot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679484411"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span>        </span><span id="local-6989586621679484050"><span class="annot"><span class="annottext">stakes :: VMap VB VP (Credential 'Staking c) (CompactForm Coin)
</span><a href="#local-6989586621679484050"><span class="hs-identifier hs-var hs-var">stakes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stake c -&gt; VMap VB VP (Credential 'Staking c) (CompactForm Coin)
forall crypto.
Stake crypto
-&gt; VMap VB VP (Credential 'Staking crypto) (CompactForm Coin)
</span><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier hs-var hs-var">Ledger.unStake</span></a></span><span>
</span><span id="line-216"></span><span>               </span><span class="annot"><span class="annottext">(Stake c -&gt; VMap VB VP (Credential 'Staking c) (CompactForm Coin))
-&gt; Stake c -&gt; VMap VB VP (Credential 'Staking c) (CompactForm Coin)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SnapShot c -&gt; Stake c
forall crypto. SnapShot crypto -&gt; Stake crypto
</span><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier hs-var hs-var">Ledger._stake</span></a></span><span> </span><span class="annot"><span class="annottext">SnapShot c
</span><a href="#local-6989586621679484055"><span class="hs-identifier hs-var">stakeSnapshot</span></a></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span>        </span><span class="annot"><a href="#local-6989586621679484047"><span class="hs-identifier hs-type">delegations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../vector-map/html/src"><span class="hs-identifier hs-type">VMap.VMap</span></a></span><span> </span><span class="annot"><a href="../../../../vector-map/html/src"><span class="hs-identifier hs-type">VMap.VB</span></a></span><span> </span><span class="annot"><a href="../../../../vector-map/html/src"><span class="hs-identifier hs-type">VMap.VB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Ledger.Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Ledger.Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679484411"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Ledger.KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Ledger.StakePool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679484411"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>        </span><span id="local-6989586621679484047"><span class="annot"><span class="annottext">delegations :: VMap VB VB (Credential 'Staking c) (KeyHash 'StakePool c)
</span><a href="#local-6989586621679484047"><span class="hs-identifier hs-var hs-var">delegations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SnapShot c
-&gt; VMap VB VB (Credential 'Staking c) (KeyHash 'StakePool c)
forall crypto.
SnapShot crypto
-&gt; VMap
     VB VB (Credential 'Staking crypto) (KeyHash 'StakePool crypto)
</span><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier hs-var hs-var">Ledger._delegations</span></a></span><span> </span><span class="annot"><span class="annottext">SnapShot c
</span><a href="#local-6989586621679484055"><span class="hs-identifier hs-var">stakeSnapshot</span></a></span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span>        </span><span class="annot"><a href="#local-6989586621679484058"><span class="hs-identifier hs-type">sdd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.PoolId</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.Lovelace</span></a></span><span>
</span><span id="line-222"></span><span>        </span><span id="local-6989586621679484058"><span class="annot"><span class="annottext">sdd :: Map PoolId Lovelace
</span><a href="#local-6989586621679484058"><span class="hs-identifier hs-var hs-var">sdd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Lovelace -&gt; Lovelace -&gt; Lovelace)
-&gt; [(PoolId, Lovelace)] -&gt; Map PoolId Lovelace
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromListWith</span></a></span><span> </span><span class="annot"><span class="annottext">Lovelace -&gt; Lovelace -&gt; Lovelace
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">(+)</span></a></span><span>
</span><span id="line-223"></span><span>            </span><span class="annot"><span class="annottext">([(PoolId, Lovelace)] -&gt; Map PoolId Lovelace)
-&gt; [(PoolId, Lovelace)] -&gt; Map PoolId Lovelace
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((Lovelace, PoolId) -&gt; (PoolId, Lovelace))
-&gt; [(Lovelace, PoolId)] -&gt; [(PoolId, Lovelace)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Lovelace, PoolId) -&gt; (PoolId, Lovelace)
forall a b. (a, b) -&gt; (b, a)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">swap</span></a></span><span>
</span><span id="line-224"></span><span>            </span><span class="annot"><span class="annottext">([(Lovelace, PoolId)] -&gt; [(PoolId, Lovelace)])
-&gt; [(Lovelace, PoolId)] -&gt; [(PoolId, Lovelace)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe (Lovelace, PoolId)] -&gt; [(Lovelace, PoolId)]
forall a. [Maybe a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">catMaybes</span></a></span><span>
</span><span id="line-225"></span><span>            </span><span class="annot"><span class="annottext">([Maybe (Lovelace, PoolId)] -&gt; [(Lovelace, PoolId)])
-&gt; [Maybe (Lovelace, PoolId)] -&gt; [(Lovelace, PoolId)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">VMap VB VB (Credential 'Staking c) (Maybe (Lovelace, PoolId))
-&gt; [Maybe (Lovelace, PoolId)]
forall (vv :: * -&gt; *) v (kv :: * -&gt; *) k.
Vector vv v =&gt;
VMap kv vv k v -&gt; [v]
</span><a href="../../../../vector-map/html/src"><span class="hs-identifier hs-var">VMap.elems</span></a></span><span>
</span><span id="line-226"></span><span>            </span><span class="annot"><span class="annottext">(VMap VB VB (Credential 'Staking c) (Maybe (Lovelace, PoolId))
 -&gt; [Maybe (Lovelace, PoolId)])
-&gt; VMap VB VB (Credential 'Staking c) (Maybe (Lovelace, PoolId))
-&gt; [Maybe (Lovelace, PoolId)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Credential 'Staking c
 -&gt; KeyHash 'StakePool StandardCrypto -&gt; Maybe (Lovelace, PoolId))
-&gt; VMap
     VB VB (Credential 'Staking c) (KeyHash 'StakePool StandardCrypto)
-&gt; VMap VB VB (Credential 'Staking c) (Maybe (Lovelace, PoolId))
forall (kv :: * -&gt; *) k (vv :: * -&gt; *) a b.
(Vector kv k, Vector vv a, Vector vv b) =&gt;
(k -&gt; a -&gt; b) -&gt; VMap kv vv k a -&gt; VMap kv vv k b
</span><a href="../../../../vector-map/html/src"><span class="hs-identifier hs-var">VMap.mapWithKey</span></a></span><span>
</span><span id="line-227"></span><span>                </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679484041"><span class="annot"><span class="annottext">Credential 'Staking c
</span><a href="#local-6989586621679484041"><span class="hs-identifier hs-var">cred</span></a></span></span><span> </span><span id="local-6989586621679484040"><span class="annot"><span class="annottext">KeyHash 'StakePool StandardCrypto
</span><a href="#local-6989586621679484040"><span class="hs-identifier hs-var">spkHash</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-228"></span><span>                    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679484039"><span class="annot"><span class="annottext">CompactForm Coin
</span><a href="#local-6989586621679484039"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Lovelace
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.Lovelace</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Lovelace) -&gt; Integer -&gt; Lovelace
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Integer
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">coerce</span></a></span><span> </span><span class="annot"><span class="annottext">(Coin -&gt; Integer) -&gt; Coin -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CompactForm Coin -&gt; Coin
forall a. Compactible a =&gt; CompactForm a -&gt; a
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Ledger.fromCompact</span></a></span><span> </span><span class="annot"><span class="annottext">CompactForm Coin
</span><a href="#local-6989586621679484039"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-229"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">KeyHash 'StakePool StandardCrypto -&gt; PoolId
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.StakePoolKeyHash</span></a></span><span> </span><span class="annot"><span class="annottext">KeyHash 'StakePool StandardCrypto
</span><a href="#local-6989586621679484040"><span class="hs-identifier hs-var">spkHash</span></a></span><span>
</span><span id="line-230"></span><span>                           </span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>                    </span><span class="annot"><span class="annottext">(CompactForm Coin -&gt; (Lovelace, PoolId))
-&gt; Maybe (CompactForm Coin) -&gt; Maybe (Lovelace, PoolId)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking c
-&gt; VMap VB VP (Credential 'Staking c) (CompactForm Coin)
-&gt; Maybe (CompactForm Coin)
forall k (kv :: * -&gt; *) (vv :: * -&gt; *) v.
(Ord k, Vector kv k, Vector vv v) =&gt;
k -&gt; VMap kv vv k v -&gt; Maybe v
</span><a href="../../../../vector-map/html/src"><span class="hs-identifier hs-var">VMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking c
</span><a href="#local-6989586621679484041"><span class="hs-identifier hs-var">cred</span></a></span><span> </span><span class="annot"><span class="annottext">VMap VB VP (Credential 'Staking c) (CompactForm Coin)
</span><a href="#local-6989586621679484050"><span class="hs-identifier hs-var">stakes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>                </span><span class="annot"><span class="annottext">VMap VB VB (Credential 'Staking c) (KeyHash 'StakePool c)
VMap
  VB VB (Credential 'Staking c) (KeyHash 'StakePool StandardCrypto)
</span><a href="#local-6989586621679484047"><span class="hs-identifier hs-var">delegations</span></a></span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#getEpochNo"><span class="hs-identifier hs-type">getEpochNo</span></a></span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-type">O.ExtLedgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.CardanoBlock</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">O.StandardCrypto</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">EpochNo</span></a></span><span>
</span><span id="line-238"></span><span id="getEpochNo"><span class="annot"><span class="annottext">getEpochNo :: ExtLedgerState (CardanoBlock StandardCrypto) -&gt; Maybe EpochNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#getEpochNo"><span class="hs-identifier hs-var hs-var">getEpochNo</span></a></span></span><span> </span><span id="local-6989586621679484033"><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679484033"><span class="hs-identifier hs-var">extLedgerState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
-&gt; LedgerState (CardanoBlock StandardCrypto)
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var hs-var">O.ledgerState</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679484033"><span class="hs-identifier hs-var">extLedgerState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.LedgerStateByron</span></a></span><span> </span><span id="local-6989586621679484032"><span class="annot"><span class="annottext">LedgerState ByronBlock
</span><a href="#local-6989586621679484032"><span class="hs-identifier hs-var">_st</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe EpochNo
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-240"></span><span>  </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.LedgerStateShelley</span></a></span><span> </span><span id="local-6989586621679484031"><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (ShelleyEra StandardCrypto))
</span><a href="#local-6989586621679484031"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (ShelleyEra StandardCrypto))
-&gt; Maybe EpochNo
forall proto era.
LedgerState (ShelleyBlock proto era) -&gt; Maybe EpochNo
</span><a href="#local-6989586621679484030"><span class="hs-identifier hs-var">getEpochNoFromShelleyBlock</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (ShelleyEra StandardCrypto))
</span><a href="#local-6989586621679484031"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.LedgerStateAllegra</span></a></span><span> </span><span id="local-6989586621679484029"><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (AllegraEra StandardCrypto))
</span><a href="#local-6989586621679484029"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (AllegraEra StandardCrypto))
-&gt; Maybe EpochNo
forall proto era.
LedgerState (ShelleyBlock proto era) -&gt; Maybe EpochNo
</span><a href="#local-6989586621679484030"><span class="hs-identifier hs-var">getEpochNoFromShelleyBlock</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (AllegraEra StandardCrypto))
</span><a href="#local-6989586621679484029"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-242"></span><span>  </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.LedgerStateMary</span></a></span><span> </span><span id="local-6989586621679484028"><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (MaryEra StandardCrypto))
</span><a href="#local-6989586621679484028"><span class="hs-identifier hs-var">st</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (MaryEra StandardCrypto))
-&gt; Maybe EpochNo
forall proto era.
LedgerState (ShelleyBlock proto era) -&gt; Maybe EpochNo
</span><a href="#local-6989586621679484030"><span class="hs-identifier hs-var">getEpochNoFromShelleyBlock</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (MaryEra StandardCrypto))
</span><a href="#local-6989586621679484028"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-243"></span><span>  </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.LedgerStateAlonzo</span></a></span><span> </span><span id="local-6989586621679484027"><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (AlonzoEra StandardCrypto))
</span><a href="#local-6989586621679484027"><span class="hs-identifier hs-var">st</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (AlonzoEra StandardCrypto))
-&gt; Maybe EpochNo
forall proto era.
LedgerState (ShelleyBlock proto era) -&gt; Maybe EpochNo
</span><a href="#local-6989586621679484030"><span class="hs-identifier hs-var">getEpochNoFromShelleyBlock</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (TPraos StandardCrypto) (AlonzoEra StandardCrypto))
</span><a href="#local-6989586621679484027"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-244"></span><span>  </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.LedgerStateBabbage</span></a></span><span> </span><span id="local-6989586621679484026"><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (Praos StandardCrypto) (BabbageEra StandardCrypto))
</span><a href="#local-6989586621679484026"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (Praos StandardCrypto) (BabbageEra StandardCrypto))
-&gt; Maybe EpochNo
forall proto era.
LedgerState (ShelleyBlock proto era) -&gt; Maybe EpochNo
</span><a href="#local-6989586621679484030"><span class="hs-identifier hs-var">getEpochNoFromShelleyBlock</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState
  (ShelleyBlock (Praos StandardCrypto) (BabbageEra StandardCrypto))
</span><a href="#local-6989586621679484026"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-246"></span><span>    </span><span id="local-6989586621679484030"><span class="annot"><span class="annottext">getEpochNoFromShelleyBlock :: LedgerState (ShelleyBlock proto era) -&gt; Maybe EpochNo
</span><a href="#local-6989586621679484030"><span class="hs-identifier hs-var hs-var">getEpochNoFromShelleyBlock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; Maybe EpochNo
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(EpochNo -&gt; Maybe EpochNo)
-&gt; (LedgerState (ShelleyBlock proto era) -&gt; EpochNo)
-&gt; LedgerState (ShelleyBlock proto era)
-&gt; Maybe EpochNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">NewEpochState era -&gt; EpochNo
forall era. NewEpochState era -&gt; EpochNo
</span><a href="../../../../cardano-ledger-shelley/html/src"><span class="hs-identifier hs-var hs-var">Ledger.nesEL</span></a></span><span> </span><span class="annot"><span class="annottext">(NewEpochState era -&gt; EpochNo)
-&gt; (LedgerState (ShelleyBlock proto era) -&gt; NewEpochState era)
-&gt; LedgerState (ShelleyBlock proto era)
-&gt; EpochNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState (ShelleyBlock proto era) -&gt; NewEpochState era
forall proto era.
LedgerState (ShelleyBlock proto era) -&gt; NewEpochState era
</span><a href="../../../../ouroboros-consensus-shelley/html/src"><span class="hs-identifier hs-var hs-var">O.shelleyLedgerState</span></a></span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span id="local-6989586621679484023"><span id="local-6989586621679484024"></span></span><span class="hs-keyword">data</span><span> </span><span id="EpochSDDRow"><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochSDDRow"><span class="hs-identifier hs-var">EpochSDDRow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EpochSDDRow"><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochSDDRow"><span class="hs-identifier hs-var">EpochSDDRow</span></a></span></span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="epochSDDRowEpochNo"><span class="annot"><span class="annottext">EpochSDDRow -&gt; EpochNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochSDDRowEpochNo"><span class="hs-identifier hs-var hs-var">epochSDDRowEpochNo</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.EpochNo</span></a></span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="epochSDDRowPoolId"><span class="annot"><span class="annottext">EpochSDDRow -&gt; PoolId
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochSDDRowPoolId"><span class="hs-identifier hs-var hs-var">epochSDDRowPoolId</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.PoolId</span></a></span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="epochSDDRowLovelace"><span class="annot"><span class="annottext">EpochSDDRow -&gt; Lovelace
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochSDDRowLovelace"><span class="hs-identifier hs-var hs-var">epochSDDRowLovelace</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.Lovelace</span></a></span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="epochSDDRowSlotNo"><span class="annot"><span class="annottext">EpochSDDRow -&gt; SlotNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochSDDRowSlotNo"><span class="hs-identifier hs-var hs-var">epochSDDRowSlotNo</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.SlotNo</span></a></span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="epochSDDRowBlockHeaderHash"><span class="annot"><span class="annottext">EpochSDDRow -&gt; Hash BlockHeader
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochSDDRowBlockHeaderHash"><span class="hs-identifier hs-var hs-var">epochSDDRowBlockHeaderHash</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.Hash</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.BlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="epochSDDRowBlockNo"><span class="annot"><span class="annottext">EpochSDDRow -&gt; BlockNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochSDDRowBlockNo"><span class="hs-identifier hs-var hs-var">epochSDDRowBlockNo</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.BlockNo</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679484012"><span id="local-6989586621679484014"><span class="annot"><span class="annottext">EpochSDDRow -&gt; EpochSDDRow -&gt; Bool
(EpochSDDRow -&gt; EpochSDDRow -&gt; Bool)
-&gt; (EpochSDDRow -&gt; EpochSDDRow -&gt; Bool) -&gt; Eq EpochSDDRow
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: EpochSDDRow -&gt; EpochSDDRow -&gt; Bool
$c/= :: EpochSDDRow -&gt; EpochSDDRow -&gt; Bool
== :: EpochSDDRow -&gt; EpochSDDRow -&gt; Bool
$c== :: EpochSDDRow -&gt; EpochSDDRow -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483997"><span id="local-6989586621679483999"><span id="local-6989586621679484001"><span id="local-6989586621679484003"><span id="local-6989586621679484005"><span id="local-6989586621679484007"><span id="local-6989586621679484009"><span class="annot"><span class="annottext">Eq EpochSDDRow
Eq EpochSDDRow
-&gt; (EpochSDDRow -&gt; EpochSDDRow -&gt; Ordering)
-&gt; (EpochSDDRow -&gt; EpochSDDRow -&gt; Bool)
-&gt; (EpochSDDRow -&gt; EpochSDDRow -&gt; Bool)
-&gt; (EpochSDDRow -&gt; EpochSDDRow -&gt; Bool)
-&gt; (EpochSDDRow -&gt; EpochSDDRow -&gt; Bool)
-&gt; (EpochSDDRow -&gt; EpochSDDRow -&gt; EpochSDDRow)
-&gt; (EpochSDDRow -&gt; EpochSDDRow -&gt; EpochSDDRow)
-&gt; Ord EpochSDDRow
EpochSDDRow -&gt; EpochSDDRow -&gt; Bool
EpochSDDRow -&gt; EpochSDDRow -&gt; Ordering
EpochSDDRow -&gt; EpochSDDRow -&gt; EpochSDDRow
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: EpochSDDRow -&gt; EpochSDDRow -&gt; EpochSDDRow
$cmin :: EpochSDDRow -&gt; EpochSDDRow -&gt; EpochSDDRow
max :: EpochSDDRow -&gt; EpochSDDRow -&gt; EpochSDDRow
$cmax :: EpochSDDRow -&gt; EpochSDDRow -&gt; EpochSDDRow
&gt;= :: EpochSDDRow -&gt; EpochSDDRow -&gt; Bool
$c&gt;= :: EpochSDDRow -&gt; EpochSDDRow -&gt; Bool
&gt; :: EpochSDDRow -&gt; EpochSDDRow -&gt; Bool
$c&gt; :: EpochSDDRow -&gt; EpochSDDRow -&gt; Bool
&lt;= :: EpochSDDRow -&gt; EpochSDDRow -&gt; Bool
$c&lt;= :: EpochSDDRow -&gt; EpochSDDRow -&gt; Bool
&lt; :: EpochSDDRow -&gt; EpochSDDRow -&gt; Bool
$c&lt; :: EpochSDDRow -&gt; EpochSDDRow -&gt; Bool
compare :: EpochSDDRow -&gt; EpochSDDRow -&gt; Ordering
$ccompare :: EpochSDDRow -&gt; EpochSDDRow -&gt; Ordering
$cp1Ord :: Eq EpochSDDRow
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483990"><span id="local-6989586621679483992"><span id="local-6989586621679483994"><span class="annot"><span class="annottext">Int -&gt; EpochSDDRow -&gt; ShowS
[EpochSDDRow] -&gt; ShowS
EpochSDDRow -&gt; FilePath
(Int -&gt; EpochSDDRow -&gt; ShowS)
-&gt; (EpochSDDRow -&gt; FilePath)
-&gt; ([EpochSDDRow] -&gt; ShowS)
-&gt; Show EpochSDDRow
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; FilePath) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [EpochSDDRow] -&gt; ShowS
$cshowList :: [EpochSDDRow] -&gt; ShowS
show :: EpochSDDRow -&gt; FilePath
$cshow :: EpochSDDRow -&gt; FilePath
showsPrec :: Int -&gt; EpochSDDRow -&gt; ShowS
$cshowsPrec :: Int -&gt; EpochSDDRow -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. EpochSDDRow -&gt; Rep EpochSDDRow x)
-&gt; (forall x. Rep EpochSDDRow x -&gt; EpochSDDRow)
-&gt; Generic EpochSDDRow
forall x. Rep EpochSDDRow x -&gt; EpochSDDRow
forall x. EpochSDDRow -&gt; Rep EpochSDDRow x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep EpochSDDRow x -&gt; EpochSDDRow
$cfrom :: forall x. EpochSDDRow -&gt; Rep EpochSDDRow x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483985"><span class="annot"><span class="annottext">RowParser EpochSDDRow
RowParser EpochSDDRow -&gt; FromRow EpochSDDRow
forall a. RowParser a -&gt; FromRow a
fromRow :: RowParser EpochSDDRow
$cfromRow :: RowParser EpochSDDRow
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">SQL.FromRow</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483982"><span class="annot"><span class="annottext">EpochSDDRow -&gt; [SQLData]
(EpochSDDRow -&gt; [SQLData]) -&gt; ToRow EpochSDDRow
forall a. (a -&gt; [SQLData]) -&gt; ToRow a
toRow :: EpochSDDRow -&gt; [SQLData]
$ctoRow :: EpochSDDRow -&gt; [SQLData]
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">SQL.ToRow</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679483978"><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">FromJSON</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochSDDRow"><span class="hs-identifier hs-type">EpochSDDRow</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-258"></span><span>    </span><span id="local-6989586621679483976"><span class="annot"><span class="annottext">parseJSON :: Value -&gt; Parser EpochSDDRow
</span><a href="#local-6989586621679483976"><span class="hs-identifier hs-var hs-var hs-var hs-var">parseJSON</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">Object</span></a></span><span> </span><span id="local-6989586621679483975"><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679483975"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-259"></span><span>        </span><span class="annot"><span class="annottext">EpochNo
-&gt; PoolId
-&gt; Lovelace
-&gt; SlotNo
-&gt; Hash BlockHeader
-&gt; BlockNo
-&gt; EpochSDDRow
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochSDDRow"><span class="hs-identifier hs-var">EpochSDDRow</span></a></span><span>
</span><span id="line-260"></span><span>            </span><span class="annot"><span class="annottext">(EpochNo
 -&gt; PoolId
 -&gt; Lovelace
 -&gt; SlotNo
 -&gt; Hash BlockHeader
 -&gt; BlockNo
 -&gt; EpochSDDRow)
-&gt; Parser EpochNo
-&gt; Parser
     (PoolId
      -&gt; Lovelace
      -&gt; SlotNo
      -&gt; Hash BlockHeader
      -&gt; BlockNo
      -&gt; EpochSDDRow)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; EpochNo
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">C.EpochNo</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; EpochNo) -&gt; Parser Word64 -&gt; Parser EpochNo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679483975"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Key -&gt; Parser Word64
forall a. FromJSON a =&gt; Object -&gt; Key -&gt; Parser a
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.:</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;epochNo&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>            </span><span class="annot"><span class="annottext">Parser
  (PoolId
   -&gt; Lovelace
   -&gt; SlotNo
   -&gt; Hash BlockHeader
   -&gt; BlockNo
   -&gt; EpochSDDRow)
-&gt; Parser PoolId
-&gt; Parser
     (Lovelace -&gt; SlotNo -&gt; Hash BlockHeader -&gt; BlockNo -&gt; EpochSDDRow)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679483975"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Key -&gt; Parser PoolId
forall a. FromJSON a =&gt; Object -&gt; Key -&gt; Parser a
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.:</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;poolId&quot;</span></span><span>
</span><span id="line-262"></span><span>            </span><span class="annot"><span class="annottext">Parser
  (Lovelace -&gt; SlotNo -&gt; Hash BlockHeader -&gt; BlockNo -&gt; EpochSDDRow)
-&gt; Parser Lovelace
-&gt; Parser (SlotNo -&gt; Hash BlockHeader -&gt; BlockNo -&gt; EpochSDDRow)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679483975"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Key -&gt; Parser Lovelace
forall a. FromJSON a =&gt; Object -&gt; Key -&gt; Parser a
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.:</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;lovelace&quot;</span></span><span>
</span><span id="line-263"></span><span>            </span><span class="annot"><span class="annottext">Parser (SlotNo -&gt; Hash BlockHeader -&gt; BlockNo -&gt; EpochSDDRow)
-&gt; Parser SlotNo
-&gt; Parser (Hash BlockHeader -&gt; BlockNo -&gt; EpochSDDRow)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; SlotNo
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">C.SlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; SlotNo) -&gt; Parser Word64 -&gt; Parser SlotNo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679483975"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Key -&gt; Parser Word64
forall a. FromJSON a =&gt; Object -&gt; Key -&gt; Parser a
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.:</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;slotNo&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>            </span><span class="annot"><span class="annottext">Parser (Hash BlockHeader -&gt; BlockNo -&gt; EpochSDDRow)
-&gt; Parser (Hash BlockHeader) -&gt; Parser (BlockNo -&gt; EpochSDDRow)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679483975"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Key -&gt; Parser (Hash BlockHeader)
forall a. FromJSON a =&gt; Object -&gt; Key -&gt; Parser a
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.:</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;blockHeaderHash&quot;</span></span><span>
</span><span id="line-265"></span><span>            </span><span class="annot"><span class="annottext">Parser (BlockNo -&gt; EpochSDDRow)
-&gt; Parser BlockNo -&gt; Parser EpochSDDRow
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; BlockNo
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">C.BlockNo</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; BlockNo) -&gt; Parser Word64 -&gt; Parser BlockNo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679483975"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Key -&gt; Parser Word64
forall a. FromJSON a =&gt; Object -&gt; Key -&gt; Parser a
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.:</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;blockNo&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>    </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-var">parseJSON</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Parser EpochSDDRow
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679483965"><span id="local-6989586621679483967"><span id="local-6989586621679483969"><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">ToJSON</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochSDDRow"><span class="hs-identifier hs-type">EpochSDDRow</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-269"></span><span>  </span><span id="local-6989586621679483963"><span class="annot"><span class="annottext">toJSON :: EpochSDDRow -&gt; Value
</span><a href="#local-6989586621679483963"><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochSDDRow"><span class="hs-identifier hs-type">EpochSDDRow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.EpochNo</span></a></span><span> </span><span id="local-6989586621679483962"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483962"><span class="hs-identifier hs-var">epochNo</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>                      </span><span id="local-6989586621679483961"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621679483961"><span class="hs-identifier hs-var">poolId</span></a></span></span><span>
</span><span id="line-271"></span><span>                      </span><span id="local-6989586621679483960"><span class="annot"><span class="annottext">Lovelace
</span><a href="#local-6989586621679483960"><span class="hs-identifier hs-var">lovelace</span></a></span></span><span>
</span><span id="line-272"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.SlotNo</span></a></span><span> </span><span id="local-6989586621679483959"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483959"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>                      </span><span id="local-6989586621679483958"><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679483958"><span class="hs-identifier hs-var">blockHeaderHash</span></a></span></span><span>
</span><span id="line-274"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.BlockNo</span></a></span><span> </span><span id="local-6989586621679483957"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483957"><span class="hs-identifier hs-var">blockNo</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-275"></span><span>      </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><a href="../../../../aeson/html/src"><span class="hs-identifier hs-var">object</span></a></span><span>
</span><span id="line-276"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;epochNo&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Word64 -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483962"><span class="hs-identifier hs-var">epochNo</span></a></span><span>
</span><span id="line-277"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;poolId&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; PoolId -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621679483961"><span class="hs-identifier hs-var">poolId</span></a></span><span>
</span><span id="line-278"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;lovelace&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Lovelace -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">Lovelace
</span><a href="#local-6989586621679483960"><span class="hs-identifier hs-var">lovelace</span></a></span><span>
</span><span id="line-279"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;slotNo&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Word64 -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483959"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-280"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;blockHeaderHash&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Hash BlockHeader -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679483958"><span class="hs-identifier hs-var">blockHeaderHash</span></a></span><span>
</span><span id="line-281"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;blockNo&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Word64 -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483957"><span class="hs-identifier hs-var">blockNo</span></a></span><span>
</span><span id="line-282"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span class="hs-comment">-- | Get Nonce per epoch given an extended ledger state. The Nonce is only available starting at</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- Shelley era. Byron era has the neutral nonce.</span><span>
</span><span id="line-286"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#getEpochNonce"><span class="hs-identifier hs-type">getEpochNonce</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-type">O.ExtLedgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.CardanoBlock</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">O.StandardCrypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Ledger.Nonce</span></a></span><span>
</span><span id="line-287"></span><span id="getEpochNonce"><span class="annot"><span class="annottext">getEpochNonce :: ExtLedgerState (CardanoBlock StandardCrypto) -&gt; Nonce
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#getEpochNonce"><span class="hs-identifier hs-var hs-var">getEpochNonce</span></a></span></span><span> </span><span id="local-6989586621679483956"><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483956"><span class="hs-identifier hs-var">extLedgerState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HeaderState (CardanoBlock StandardCrypto)
-&gt; ChainDepState (BlockProtocol (CardanoBlock StandardCrypto))
forall blk. HeaderState blk -&gt; ChainDepState (BlockProtocol blk)
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var hs-var">O.headerStateChainDep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
-&gt; HeaderState (CardanoBlock StandardCrypto)
forall blk. ExtLedgerState blk -&gt; HeaderState blk
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var hs-var">O.headerState</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483956"><span class="hs-identifier hs-var">extLedgerState</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-289"></span><span>      </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.ChainDepStateByron</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Nonce
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Ledger.NeutralNonce</span></a></span><span>
</span><span id="line-290"></span><span>      </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.ChainDepStateShelley</span></a></span><span> </span><span id="local-6989586621679483950"><span class="annot"><a href="#local-6989586621679483950"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TPraosState StandardCrypto -&gt; Nonce
forall c. TPraosState c -&gt; Nonce
</span><a href="#local-6989586621679483949"><span class="hs-identifier hs-var">extractNonce</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDepState
  (BlockProtocol
     (ShelleyBlock (TPraos StandardCrypto) (ShelleyEra StandardCrypto)))
TPraosState StandardCrypto
</span><a href="#local-6989586621679483950"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-291"></span><span>      </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.ChainDepStateAllegra</span></a></span><span> </span><span id="local-6989586621679483947"><span class="annot"><a href="#local-6989586621679483947"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TPraosState StandardCrypto -&gt; Nonce
forall c. TPraosState c -&gt; Nonce
</span><a href="#local-6989586621679483949"><span class="hs-identifier hs-var">extractNonce</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDepState
  (BlockProtocol
     (ShelleyBlock (TPraos StandardCrypto) (AllegraEra StandardCrypto)))
TPraosState StandardCrypto
</span><a href="#local-6989586621679483947"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-292"></span><span>      </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.ChainDepStateMary</span></a></span><span> </span><span id="local-6989586621679483945"><span class="annot"><a href="#local-6989586621679483945"><span class="hs-identifier hs-var">st</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TPraosState StandardCrypto -&gt; Nonce
forall c. TPraosState c -&gt; Nonce
</span><a href="#local-6989586621679483949"><span class="hs-identifier hs-var">extractNonce</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDepState
  (BlockProtocol
     (ShelleyBlock (TPraos StandardCrypto) (MaryEra StandardCrypto)))
TPraosState StandardCrypto
</span><a href="#local-6989586621679483945"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-293"></span><span>      </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.ChainDepStateAlonzo</span></a></span><span> </span><span id="local-6989586621679483943"><span class="annot"><a href="#local-6989586621679483943"><span class="hs-identifier hs-var">st</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TPraosState StandardCrypto -&gt; Nonce
forall c. TPraosState c -&gt; Nonce
</span><a href="#local-6989586621679483949"><span class="hs-identifier hs-var">extractNonce</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDepState
  (BlockProtocol
     (ShelleyBlock (TPraos StandardCrypto) (AlonzoEra StandardCrypto)))
TPraosState StandardCrypto
</span><a href="#local-6989586621679483943"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-294"></span><span>      </span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.ChainDepStateBabbage</span></a></span><span> </span><span id="local-6989586621679483941"><span class="annot"><a href="#local-6989586621679483941"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PraosState StandardCrypto -&gt; Nonce
forall c. PraosState c -&gt; Nonce
</span><a href="#local-6989586621679483940"><span class="hs-identifier hs-var">extractNoncePraos</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDepState
  (BlockProtocol
     (ShelleyBlock (Praos StandardCrypto) (BabbageEra StandardCrypto)))
PraosState StandardCrypto
</span><a href="#local-6989586621679483941"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-296"></span><span>    </span><span id="local-6989586621679484303"><span class="annot"><a href="#local-6989586621679483949"><span class="hs-identifier hs-type">extractNonce</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus-protocol/html/src"><span class="hs-identifier hs-type">O.TPraosState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679484303"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Ledger.Nonce</span></a></span></span><span>
</span><span id="line-297"></span><span>    </span><span id="local-6989586621679483949"><span class="annot"><span class="annottext">extractNonce :: TPraosState c -&gt; Nonce
</span><a href="#local-6989586621679483949"><span class="hs-identifier hs-var hs-var">extractNonce</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-298"></span><span>      </span><span class="annot"><span class="annottext">TicknState -&gt; Nonce
</span><a href="../../../../cardano-protocol-tpraos/html/src"><span class="hs-identifier hs-var hs-var">Shelley.ticknStateEpochNonce</span></a></span><span> </span><span class="annot"><span class="annottext">(TicknState -&gt; Nonce)
-&gt; (TPraosState c -&gt; TicknState) -&gt; TPraosState c -&gt; Nonce
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDepState c -&gt; TicknState
forall crypto. ChainDepState crypto -&gt; TicknState
</span><a href="../../../../cardano-protocol-tpraos/html/src"><span class="hs-identifier hs-var hs-var">Shelley.csTickn</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDepState c -&gt; TicknState)
-&gt; (TPraosState c -&gt; ChainDepState c)
-&gt; TPraosState c
-&gt; TicknState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TPraosState c -&gt; ChainDepState c
forall c. TPraosState c -&gt; ChainDepState c
</span><a href="../../../../ouroboros-consensus-protocol/html/src"><span class="hs-identifier hs-var hs-var">O.tpraosStateChainDepState</span></a></span><span>
</span><span id="line-299"></span><span>
</span><span id="line-300"></span><span>    </span><span id="local-6989586621679484301"><span class="annot"><a href="#local-6989586621679483940"><span class="hs-identifier hs-type">extractNoncePraos</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus-protocol/html/src"><span class="hs-identifier hs-type">O.PraosState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679484301"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Ledger.Nonce</span></a></span></span><span>
</span><span id="line-301"></span><span>    </span><span id="local-6989586621679483940"><span class="annot"><span class="annottext">extractNoncePraos :: PraosState c -&gt; Nonce
</span><a href="#local-6989586621679483940"><span class="hs-identifier hs-var hs-var">extractNoncePraos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PraosState c -&gt; Nonce
forall c. PraosState c -&gt; Nonce
</span><a href="../../../../ouroboros-consensus-protocol/html/src"><span class="hs-identifier hs-var hs-var">O.praosStateEpochNonce</span></a></span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span id="local-6989586621679483934"><span id="local-6989586621679483935"></span></span><span class="hs-keyword">data</span><span> </span><span id="EpochNonceRow"><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochNonceRow"><span class="hs-identifier hs-var">EpochNonceRow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EpochNonceRow"><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochNonceRow"><span class="hs-identifier hs-var">EpochNonceRow</span></a></span></span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="epochNonceRowEpochNo"><span class="annot"><span class="annottext">EpochNonceRow -&gt; EpochNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochNonceRowEpochNo"><span class="hs-identifier hs-var hs-var">epochNonceRowEpochNo</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.EpochNo</span></a></span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="epochNonceRowNonce"><span class="annot"><span class="annottext">EpochNonceRow -&gt; Nonce
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochNonceRowNonce"><span class="hs-identifier hs-var hs-var">epochNonceRowNonce</span></a></span></span><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Ledger.Nonce</span></a></span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="epochNonceRowSlotNo"><span class="annot"><span class="annottext">EpochNonceRow -&gt; SlotNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochNonceRowSlotNo"><span class="hs-identifier hs-var hs-var">epochNonceRowSlotNo</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.SlotNo</span></a></span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="epochNonceRowBlockHeaderHash"><span class="annot"><span class="annottext">EpochNonceRow -&gt; Hash BlockHeader
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochNonceRowBlockHeaderHash"><span class="hs-identifier hs-var hs-var">epochNonceRowBlockHeaderHash</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.Hash</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.BlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="epochNonceRowBlockNo"><span class="annot"><span class="annottext">EpochNonceRow -&gt; BlockNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochNonceRowBlockNo"><span class="hs-identifier hs-var hs-var">epochNonceRowBlockNo</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.BlockNo</span></a></span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679483924"><span id="local-6989586621679483926"><span class="annot"><span class="annottext">EpochNonceRow -&gt; EpochNonceRow -&gt; Bool
(EpochNonceRow -&gt; EpochNonceRow -&gt; Bool)
-&gt; (EpochNonceRow -&gt; EpochNonceRow -&gt; Bool) -&gt; Eq EpochNonceRow
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: EpochNonceRow -&gt; EpochNonceRow -&gt; Bool
$c/= :: EpochNonceRow -&gt; EpochNonceRow -&gt; Bool
== :: EpochNonceRow -&gt; EpochNonceRow -&gt; Bool
$c== :: EpochNonceRow -&gt; EpochNonceRow -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483909"><span id="local-6989586621679483911"><span id="local-6989586621679483913"><span id="local-6989586621679483915"><span id="local-6989586621679483917"><span id="local-6989586621679483919"><span id="local-6989586621679483921"><span class="annot"><span class="annottext">Eq EpochNonceRow
Eq EpochNonceRow
-&gt; (EpochNonceRow -&gt; EpochNonceRow -&gt; Ordering)
-&gt; (EpochNonceRow -&gt; EpochNonceRow -&gt; Bool)
-&gt; (EpochNonceRow -&gt; EpochNonceRow -&gt; Bool)
-&gt; (EpochNonceRow -&gt; EpochNonceRow -&gt; Bool)
-&gt; (EpochNonceRow -&gt; EpochNonceRow -&gt; Bool)
-&gt; (EpochNonceRow -&gt; EpochNonceRow -&gt; EpochNonceRow)
-&gt; (EpochNonceRow -&gt; EpochNonceRow -&gt; EpochNonceRow)
-&gt; Ord EpochNonceRow
EpochNonceRow -&gt; EpochNonceRow -&gt; Bool
EpochNonceRow -&gt; EpochNonceRow -&gt; Ordering
EpochNonceRow -&gt; EpochNonceRow -&gt; EpochNonceRow
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: EpochNonceRow -&gt; EpochNonceRow -&gt; EpochNonceRow
$cmin :: EpochNonceRow -&gt; EpochNonceRow -&gt; EpochNonceRow
max :: EpochNonceRow -&gt; EpochNonceRow -&gt; EpochNonceRow
$cmax :: EpochNonceRow -&gt; EpochNonceRow -&gt; EpochNonceRow
&gt;= :: EpochNonceRow -&gt; EpochNonceRow -&gt; Bool
$c&gt;= :: EpochNonceRow -&gt; EpochNonceRow -&gt; Bool
&gt; :: EpochNonceRow -&gt; EpochNonceRow -&gt; Bool
$c&gt; :: EpochNonceRow -&gt; EpochNonceRow -&gt; Bool
&lt;= :: EpochNonceRow -&gt; EpochNonceRow -&gt; Bool
$c&lt;= :: EpochNonceRow -&gt; EpochNonceRow -&gt; Bool
&lt; :: EpochNonceRow -&gt; EpochNonceRow -&gt; Bool
$c&lt; :: EpochNonceRow -&gt; EpochNonceRow -&gt; Bool
compare :: EpochNonceRow -&gt; EpochNonceRow -&gt; Ordering
$ccompare :: EpochNonceRow -&gt; EpochNonceRow -&gt; Ordering
$cp1Ord :: Eq EpochNonceRow
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483903"><span id="local-6989586621679483905"><span id="local-6989586621679483907"><span class="annot"><span class="annottext">Int -&gt; EpochNonceRow -&gt; ShowS
[EpochNonceRow] -&gt; ShowS
EpochNonceRow -&gt; FilePath
(Int -&gt; EpochNonceRow -&gt; ShowS)
-&gt; (EpochNonceRow -&gt; FilePath)
-&gt; ([EpochNonceRow] -&gt; ShowS)
-&gt; Show EpochNonceRow
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; FilePath) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [EpochNonceRow] -&gt; ShowS
$cshowList :: [EpochNonceRow] -&gt; ShowS
show :: EpochNonceRow -&gt; FilePath
$cshow :: EpochNonceRow -&gt; FilePath
showsPrec :: Int -&gt; EpochNonceRow -&gt; ShowS
$cshowsPrec :: Int -&gt; EpochNonceRow -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. EpochNonceRow -&gt; Rep EpochNonceRow x)
-&gt; (forall x. Rep EpochNonceRow x -&gt; EpochNonceRow)
-&gt; Generic EpochNonceRow
forall x. Rep EpochNonceRow x -&gt; EpochNonceRow
forall x. EpochNonceRow -&gt; Rep EpochNonceRow x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep EpochNonceRow x -&gt; EpochNonceRow
$cfrom :: forall x. EpochNonceRow -&gt; Rep EpochNonceRow x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483899"><span class="annot"><span class="annottext">RowParser EpochNonceRow
RowParser EpochNonceRow -&gt; FromRow EpochNonceRow
forall a. RowParser a -&gt; FromRow a
fromRow :: RowParser EpochNonceRow
$cfromRow :: RowParser EpochNonceRow
</span><a href="#local-6989586621679483899"><span class="hs-identifier hs-var hs-var hs-var hs-var">SQL.FromRow</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483897"><span class="annot"><span class="annottext">EpochNonceRow -&gt; [SQLData]
(EpochNonceRow -&gt; [SQLData]) -&gt; ToRow EpochNonceRow
forall a. (a -&gt; [SQLData]) -&gt; ToRow a
toRow :: EpochNonceRow -&gt; [SQLData]
$ctoRow :: EpochNonceRow -&gt; [SQLData]
</span><a href="#local-6989586621679483897"><span class="hs-identifier hs-var hs-var hs-var hs-var">SQL.ToRow</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679483894"><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">FromJSON</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochNonceRow"><span class="hs-identifier hs-type">EpochNonceRow</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-312"></span><span>    </span><span id="local-6989586621679483893"><span class="annot"><span class="annottext">parseJSON :: Value -&gt; Parser EpochNonceRow
</span><a href="#local-6989586621679483893"><span class="hs-identifier hs-var hs-var hs-var hs-var">parseJSON</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">Object</span></a></span><span> </span><span id="local-6989586621679483892"><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679483892"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-313"></span><span>        </span><span class="annot"><span class="annottext">EpochNo
-&gt; Nonce -&gt; SlotNo -&gt; Hash BlockHeader -&gt; BlockNo -&gt; EpochNonceRow
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochNonceRow"><span class="hs-identifier hs-var">EpochNonceRow</span></a></span><span>
</span><span id="line-314"></span><span>            </span><span class="annot"><span class="annottext">(EpochNo
 -&gt; Nonce -&gt; SlotNo -&gt; Hash BlockHeader -&gt; BlockNo -&gt; EpochNonceRow)
-&gt; Parser EpochNo
-&gt; Parser
     (Nonce -&gt; SlotNo -&gt; Hash BlockHeader -&gt; BlockNo -&gt; EpochNonceRow)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; EpochNo
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">C.EpochNo</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; EpochNo) -&gt; Parser Word64 -&gt; Parser EpochNo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679483892"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Key -&gt; Parser Word64
forall a. FromJSON a =&gt; Object -&gt; Key -&gt; Parser a
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.:</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;epochNo&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>            </span><span class="annot"><span class="annottext">Parser
  (Nonce -&gt; SlotNo -&gt; Hash BlockHeader -&gt; BlockNo -&gt; EpochNonceRow)
-&gt; Parser Nonce
-&gt; Parser (SlotNo -&gt; Hash BlockHeader -&gt; BlockNo -&gt; EpochNonceRow)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash Blake2b_256 Nonce -&gt; Nonce
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Ledger.Nonce</span></a></span><span> </span><span class="annot"><span class="annottext">(Hash Blake2b_256 Nonce -&gt; Nonce)
-&gt; Parser (Hash Blake2b_256 Nonce) -&gt; Parser Nonce
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679483892"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Key -&gt; Parser (Hash Blake2b_256 Nonce)
forall a. FromJSON a =&gt; Object -&gt; Key -&gt; Parser a
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.:</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;nonce&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>            </span><span class="annot"><span class="annottext">Parser (SlotNo -&gt; Hash BlockHeader -&gt; BlockNo -&gt; EpochNonceRow)
-&gt; Parser SlotNo
-&gt; Parser (Hash BlockHeader -&gt; BlockNo -&gt; EpochNonceRow)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; SlotNo
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">C.SlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; SlotNo) -&gt; Parser Word64 -&gt; Parser SlotNo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679483892"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Key -&gt; Parser Word64
forall a. FromJSON a =&gt; Object -&gt; Key -&gt; Parser a
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.:</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;slotNo&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>            </span><span class="annot"><span class="annottext">Parser (Hash BlockHeader -&gt; BlockNo -&gt; EpochNonceRow)
-&gt; Parser (Hash BlockHeader) -&gt; Parser (BlockNo -&gt; EpochNonceRow)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679483892"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Key -&gt; Parser (Hash BlockHeader)
forall a. FromJSON a =&gt; Object -&gt; Key -&gt; Parser a
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.:</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;blockHeaderHash&quot;</span></span><span>
</span><span id="line-318"></span><span>            </span><span class="annot"><span class="annottext">Parser (BlockNo -&gt; EpochNonceRow)
-&gt; Parser BlockNo -&gt; Parser EpochNonceRow
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; BlockNo
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">C.BlockNo</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; BlockNo) -&gt; Parser Word64 -&gt; Parser BlockNo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621679483892"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Key -&gt; Parser Word64
forall a. FromJSON a =&gt; Object -&gt; Key -&gt; Parser a
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.:</span></a></span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;blockNo&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>    </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-var">parseJSON</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Parser EpochNonceRow
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679483884"><span id="local-6989586621679483886"><span id="local-6989586621679483888"><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">ToJSON</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochNonceRow"><span class="hs-identifier hs-type">EpochNonceRow</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-322"></span><span>  </span><span id="local-6989586621679483883"><span class="annot"><span class="annottext">toJSON :: EpochNonceRow -&gt; Value
</span><a href="#local-6989586621679483883"><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochNonceRow"><span class="hs-identifier hs-type">EpochNonceRow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.EpochNo</span></a></span><span> </span><span id="local-6989586621679483882"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483882"><span class="hs-identifier hs-var">epochNo</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>                        </span><span id="local-6989586621679483881"><span class="annot"><span class="annottext">Nonce
</span><a href="#local-6989586621679483881"><span class="hs-identifier hs-var">nonce</span></a></span></span><span>
</span><span id="line-324"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.SlotNo</span></a></span><span> </span><span id="local-6989586621679483880"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483880"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>                        </span><span id="local-6989586621679483879"><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679483879"><span class="hs-identifier hs-var">blockHeaderHash</span></a></span></span><span>
</span><span id="line-326"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.BlockNo</span></a></span><span> </span><span id="local-6989586621679483878"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483878"><span class="hs-identifier hs-var">blockNo</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-327"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679483877"><span class="annot"><span class="annottext">nonceValue :: Maybe (Hash Blake2b_256 Nonce)
</span><a href="#local-6989586621679483877"><span class="hs-identifier hs-var hs-var">nonceValue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Nonce
</span><a href="#local-6989586621679483881"><span class="hs-identifier hs-var">nonce</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="annot"><span class="annottext">Nonce
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Ledger.NeutralNonce</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Hash Blake2b_256 Nonce)
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-328"></span><span>                                     </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Ledger.Nonce</span></a></span><span> </span><span id="local-6989586621679483876"><span class="annot"><span class="annottext">Hash Blake2b_256 Nonce
</span><a href="#local-6989586621679483876"><span class="hs-identifier hs-var">n</span></a></span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Hash Blake2b_256 Nonce -&gt; Maybe (Hash Blake2b_256 Nonce)
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Hash Blake2b_256 Nonce
</span><a href="#local-6989586621679483876"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-329"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><a href="../../../../aeson/html/src"><span class="hs-identifier hs-var">object</span></a></span><span>
</span><span id="line-330"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;epochNo&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Word64 -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483882"><span class="hs-identifier hs-var">epochNo</span></a></span><span>
</span><span id="line-331"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;nonce&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Maybe (Hash Blake2b_256 Nonce) -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Hash Blake2b_256 Nonce)
</span><a href="#local-6989586621679483877"><span class="hs-identifier hs-var">nonceValue</span></a></span><span>
</span><span id="line-332"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;slotNo&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Word64 -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483880"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-333"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;blockHeaderHash&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Hash BlockHeader -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679483879"><span class="hs-identifier hs-var">blockHeaderHash</span></a></span><span>
</span><span id="line-334"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Key
</span><span class="hs-string">&quot;blockNo&quot;</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; Word64 -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Key -&gt; v -&gt; kv
</span><a href="../../../../aeson/html/src"><span class="hs-operator hs-var">.=</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483878"><span class="hs-identifier hs-var">blockNo</span></a></span><span>
</span><span id="line-335"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Buffered</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-338"></span><span>    </span><span class="hs-comment">-- We should only store on disk SDD from the last slot of each epoch.</span><span>
</span><span id="line-339"></span><span>    </span><span id="local-6989586621679483872"><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">persistToStorage</span></a></span><span>
</span><span id="line-340"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Foldable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679483872"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-341"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679483872"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span>
</span><span id="line-343"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span></span><span>
</span><span id="line-344"></span><span>    </span><span id="local-6989586621679483871"><span class="annot"><span class="annottext">persistToStorage :: f (StorableEvent EpochStateHandle)
-&gt; EpochStateHandle -&gt; IO EpochStateHandle
</span><a href="#local-6989586621679483871"><span class="hs-identifier hs-var hs-var hs-var hs-var">persistToStorage</span></a></span></span><span> </span><span id="local-6989586621679483870"><span class="annot"><span class="annottext">f (StorableEvent EpochStateHandle)
</span><a href="#local-6989586621679483870"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span id="local-6989586621679483869"><span class="annot"><span class="annottext">h :: EpochStateHandle
</span><a href="#local-6989586621679483869"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span id="local-6989586621679483868"><span class="annot"><span class="annottext">TopLevelConfig (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483868"><span class="hs-identifier hs-var">topLevelConfig</span></a></span></span><span> </span><span id="local-6989586621679483867"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483867"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679483866"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483866"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span></span><span> </span><span id="local-6989586621679483865"><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679483865"><span class="hs-identifier hs-var">securityParam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-345"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679483864"><span class="annot"><span class="annottext">eventsList :: [StorableEvent EpochStateHandle]
</span><a href="#local-6989586621679483864"><span class="hs-identifier hs-var hs-var">eventsList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">f (StorableEvent EpochStateHandle)
-&gt; [StorableEvent EpochStateHandle]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">f (StorableEvent EpochStateHandle)
</span><a href="#local-6989586621679483870"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span>        </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483867"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;BEGIN&quot;</span></span><span>
</span><span id="line-348"></span><span>        </span><span class="annot"><span class="annottext">[EpochSDDRow] -&gt; (EpochSDDRow -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StorableEvent EpochStateHandle -&gt; [EpochSDDRow])
-&gt; [StorableEvent EpochStateHandle] -&gt; [EpochSDDRow]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">concatMap</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; [EpochSDDRow]
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#eventToEpochSDDRows"><span class="hs-identifier hs-var">eventToEpochSDDRows</span></a></span><span> </span><span class="annot"><span class="annottext">([StorableEvent EpochStateHandle] -&gt; [EpochSDDRow])
-&gt; [StorableEvent EpochStateHandle] -&gt; [EpochSDDRow]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableEvent EpochStateHandle -&gt; Bool)
-&gt; [StorableEvent EpochStateHandle]
-&gt; [StorableEvent EpochStateHandle]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; Bool
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventIsFirstEventOfEpoch"><span class="hs-identifier hs-var hs-var">epochStateEventIsFirstEventOfEpoch</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent EpochStateHandle]
</span><a href="#local-6989586621679483864"><span class="hs-identifier hs-var">eventsList</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((EpochSDDRow -&gt; IO ()) -&gt; IO ())
-&gt; (EpochSDDRow -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679483860"><span class="annot"><span class="annottext">EpochSDDRow
</span><a href="#local-6989586621679483860"><span class="hs-identifier hs-var">row</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-349"></span><span>          </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; EpochSDDRow -&gt; IO ()
forall q. ToRow q =&gt; Connection -&gt; Query -&gt; q -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483867"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-350"></span><span>              </span><span class="annot"><span class="">[r|INSERT INTO epoch_sdd
                  ( epochNo
                  , poolId
                  , lovelace
                  , slotNo
                  , blockHeaderHash
                  , blockNo
                  ) VALUES (?, ?, ?, ?, ?, ?)|]</span></span><span> </span><span class="annot"><span class="annottext">EpochSDDRow
</span><a href="#local-6989586621679483860"><span class="hs-identifier hs-var">row</span></a></span><span>
</span><span id="line-358"></span><span>        </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483867"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;COMMIT&quot;</span></span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span>        </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483867"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;BEGIN&quot;</span></span><span>
</span><span id="line-361"></span><span>        </span><span class="annot"><span class="annottext">[EpochNonceRow] -&gt; (EpochNonceRow -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StorableEvent EpochStateHandle -&gt; Maybe EpochNonceRow)
-&gt; [StorableEvent EpochStateHandle] -&gt; [EpochNonceRow]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; Maybe EpochNonceRow
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#eventToEpochNonceRow"><span class="hs-identifier hs-var">eventToEpochNonceRow</span></a></span><span> </span><span class="annot"><span class="annottext">([StorableEvent EpochStateHandle] -&gt; [EpochNonceRow])
-&gt; [StorableEvent EpochStateHandle] -&gt; [EpochNonceRow]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableEvent EpochStateHandle -&gt; Bool)
-&gt; [StorableEvent EpochStateHandle]
-&gt; [StorableEvent EpochStateHandle]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; Bool
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventIsFirstEventOfEpoch"><span class="hs-identifier hs-var hs-var">epochStateEventIsFirstEventOfEpoch</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent EpochStateHandle]
</span><a href="#local-6989586621679483864"><span class="hs-identifier hs-var">eventsList</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((EpochNonceRow -&gt; IO ()) -&gt; IO ())
-&gt; (EpochNonceRow -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679483857"><span class="annot"><span class="annottext">EpochNonceRow
</span><a href="#local-6989586621679483857"><span class="hs-identifier hs-var">row</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-362"></span><span>          </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; EpochNonceRow -&gt; IO ()
forall q. ToRow q =&gt; Connection -&gt; Query -&gt; q -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483867"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-363"></span><span>              </span><span class="annot"><span class="">[r|INSERT INTO epoch_nonce
                  ( epochNo
                  , nonce
                  , slotNo
                  , blockHeaderHash
                  , blockNo
                  ) VALUES (?, ?, ?, ?, ?)|]</span></span><span> </span><span class="annot"><span class="annottext">EpochNonceRow
</span><a href="#local-6989586621679483857"><span class="hs-identifier hs-var">row</span></a></span><span>
</span><span id="line-370"></span><span>        </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483867"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;COMMIT&quot;</span></span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span>        </span><span class="hs-comment">-- We store the LedgerState if one of following conditions hold:</span><span>
</span><span id="line-373"></span><span>        </span><span class="hs-comment">--   * the LedgerState cannot be rollbacked and is the last of an epoch</span><span>
</span><span id="line-374"></span><span>        </span><span class="hs-comment">--   * the LedgerState can be rollbacked</span><span>
</span><span id="line-375"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679483856"><span class="annot"><span class="annottext">writeLedgerState :: ExtLedgerState (CardanoBlock StandardCrypto)
-&gt; SlotNo -&gt; Hash BlockHeader -&gt; BlockNo -&gt; Bool -&gt; IO ()
</span><a href="#local-6989586621679483856"><span class="hs-identifier hs-var hs-var">writeLedgerState</span></a></span></span><span> </span><span id="local-6989586621679483855"><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483855"><span class="hs-identifier hs-var">ledgerState</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.SlotNo</span></a></span><span> </span><span id="local-6989586621679483854"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483854"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679483853"><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679483853"><span class="hs-identifier hs-var">blockHeaderHash</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.BlockNo</span></a></span><span> </span><span id="local-6989586621679483852"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483852"><span class="hs-identifier hs-var">blockNo</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679483851"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679483851"><span class="hs-identifier hs-var">isRollbackable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-376"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679483850"><span class="annot"><span class="annottext">fname :: FilePath
</span><a href="#local-6989586621679483850"><span class="hs-identifier hs-var hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483866"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span><span>
</span><span id="line-377"></span><span>                        </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
</span><a href="../../../../filepath/html/src"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;ledgerState_&quot;</span></span><span>
</span><span id="line-378"></span><span>                         </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679483851"><span class="hs-identifier hs-var">isRollbackable</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;volatile_&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-379"></span><span>                         </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483854"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-380"></span><span>                         </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;_&quot;</span></span><span>
</span><span id="line-381"></span><span>                         </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; FilePath
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">Text.unpack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash BlockHeader -&gt; Text
forall a. SerialiseAsRawBytes a =&gt; a -&gt; Text
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.serialiseToRawBytesHexText</span></a></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679483853"><span class="hs-identifier hs-var">blockHeaderHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-382"></span><span>                         </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;_&quot;</span></span><span>
</span><span id="line-383"></span><span>                         </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679483852"><span class="hs-identifier hs-var">blockNo</span></a></span><span>
</span><span id="line-384"></span><span>                         </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;.bin&quot;</span></span><span>
</span><span id="line-385"></span><span>                </span><span class="hs-comment">-- TODO We should delete the file is the write operation was interrumpted by the</span><span>
</span><span id="line-386"></span><span>                </span><span class="hs-comment">-- user. Tried using something like `onException`, but it doesn't run the cleanup</span><span>
</span><span id="line-387"></span><span>                </span><span class="hs-comment">-- function. Not sure how to do the cleanup here without restoring doing it outside</span><span>
</span><span id="line-388"></span><span>                </span><span class="hs-comment">-- the thread where this indexer is running.</span><span>
</span><span id="line-389"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679483846"><span class="annot"><span class="annottext">codecConfig :: CodecConfig (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483846"><span class="hs-identifier hs-var hs-var">codecConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig (CardanoBlock StandardCrypto)
-&gt; CodecConfig (CardanoBlock StandardCrypto)
forall blk. TopLevelConfig blk -&gt; CodecConfig blk
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var">O.configCodec</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483868"><span class="hs-identifier hs-var">topLevelConfig</span></a></span><span>
</span><span id="line-390"></span><span>                </span><span class="annot"><span class="annottext">FilePath -&gt; ByteString -&gt; IO ()
</span><a href="../../../../bytestring/html/src"><span class="hs-identifier hs-var">BS.writeFile</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483850"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-391"></span><span>                    </span><span class="annot"><span class="annottext">(ByteString -&gt; IO ()) -&gt; ByteString -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; ByteString
</span><a href="../../../../cborg/html/src"><span class="hs-identifier hs-var">CBOR.toLazyByteString</span></a></span><span>
</span><span id="line-392"></span><span>                    </span><span class="annot"><span class="annottext">(Encoding -&gt; ByteString) -&gt; Encoding -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(LedgerState (CardanoBlock StandardCrypto) -&gt; Encoding)
-&gt; (ChainDepState (BlockProtocol (CardanoBlock StandardCrypto))
    -&gt; Encoding)
-&gt; (AnnTip (CardanoBlock StandardCrypto) -&gt; Encoding)
-&gt; ExtLedgerState (CardanoBlock StandardCrypto)
-&gt; Encoding
forall blk.
(LedgerState blk -&gt; Encoding)
-&gt; (ChainDepState (BlockProtocol blk) -&gt; Encoding)
-&gt; (AnnTip blk -&gt; Encoding)
-&gt; ExtLedgerState blk
-&gt; Encoding
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var">O.encodeExtLedgerState</span></a></span><span>
</span><span id="line-393"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodecConfig (CardanoBlock StandardCrypto)
-&gt; LedgerState (CardanoBlock StandardCrypto) -&gt; Encoding
forall blk a. EncodeDisk blk a =&gt; CodecConfig blk -&gt; a -&gt; Encoding
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var">O.encodeDisk</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483846"><span class="hs-identifier hs-var">codecConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodecConfig (CardanoBlock StandardCrypto)
-&gt; HardForkChainDepState
     (ByronBlock : CardanoShelleyEras StandardCrypto)
-&gt; Encoding
forall blk a. EncodeDisk blk a =&gt; CodecConfig blk -&gt; a -&gt; Encoding
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var">O.encodeDisk</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483846"><span class="hs-identifier hs-var">codecConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodecConfig (CardanoBlock StandardCrypto)
-&gt; AnnTip (CardanoBlock StandardCrypto) -&gt; Encoding
forall blk a. EncodeDisk blk a =&gt; CodecConfig blk -&gt; a -&gt; Encoding
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var">O.encodeDisk</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483846"><span class="hs-identifier hs-var">codecConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-396"></span><span>                        </span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483855"><span class="hs-identifier hs-var">ledgerState</span></a></span><span>
</span><span id="line-397"></span><span>        </span><span class="annot"><span class="annottext">[StorableEvent EpochStateHandle]
-&gt; (StorableEvent EpochStateHandle -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent EpochStateHandle]
</span><a href="#local-6989586621679483864"><span class="hs-identifier hs-var">eventsList</span></a></span><span>
</span><span id="line-398"></span><span>              </span><span class="annot"><span class="annottext">((StorableEvent EpochStateHandle -&gt; IO ()) -&gt; IO ())
-&gt; (StorableEvent EpochStateHandle -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateEvent"><span class="hs-identifier hs-type">EpochStateEvent</span></a></span><span>
</span><span id="line-399"></span><span>                    </span><span id="local-6989586621679483840"><span class="annot"><a href="#local-6989586621679483840"><span class="hs-identifier hs-var">maybeLedgerState</span></a></span></span><span>
</span><span id="line-400"></span><span>                    </span><span id="local-6989586621679483839"><span class="annot"><a href="#local-6989586621679483839"><span class="hs-identifier hs-var">maybeEpochNo</span></a></span></span><span>
</span><span id="line-401"></span><span>                    </span><span class="annot"><span class="hs-identifier">_</span></span><span>
</span><span id="line-402"></span><span>                    </span><span class="annot"><span class="hs-identifier">_</span></span><span>
</span><span id="line-403"></span><span>                    </span><span id="local-6989586621679483838"><span class="annot"><a href="#local-6989586621679483838"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span>
</span><span id="line-404"></span><span>                    </span><span id="local-6989586621679483837"><span class="annot"><a href="#local-6989586621679483837"><span class="hs-identifier hs-var">blockHeaderHash</span></a></span></span><span>
</span><span id="line-405"></span><span>                    </span><span id="local-6989586621679483836"><span class="annot"><a href="#local-6989586621679483836"><span class="hs-identifier hs-var">blockNo</span></a></span></span><span>
</span><span id="line-406"></span><span>                    </span><span id="local-6989586621679483835"><span class="annot"><a href="#local-6989586621679483835"><span class="hs-identifier hs-var">chainTip</span></a></span></span><span>
</span><span id="line-407"></span><span>                    </span><span id="local-6989586621679483834"><span class="annot"><a href="#local-6989586621679483834"><span class="hs-identifier hs-var">isFirstEventOfEpoch</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-408"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe EpochNo
</span><a href="#local-6989586621679483839"><span class="hs-identifier hs-var">maybeEpochNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
</span><a href="#local-6989586621679483840"><span class="hs-identifier hs-var">maybeLedgerState</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-409"></span><span>              </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679483833"><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483833"><span class="hs-identifier hs-var">ledgerState</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-410"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679483832"><span class="annot"><span class="annottext">isRollbackable :: Bool
</span><a href="#local-6989586621679483832"><span class="hs-identifier hs-var hs-var">isRollbackable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecurityParam -&gt; BlockNo -&gt; ChainTip -&gt; Bool
</span><a href="Marconi.ChainIndex.Utils.html#isBlockRollbackable"><span class="hs-identifier hs-var">isBlockRollbackable</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679483865"><span class="hs-identifier hs-var">securityParam</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679483836"><span class="hs-identifier hs-var">blockNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679483835"><span class="hs-identifier hs-var">chainTip</span></a></span><span>
</span><span id="line-411"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679483832"><span class="hs-identifier hs-var">isRollbackable</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679483834"><span class="hs-identifier hs-var">isFirstEventOfEpoch</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-412"></span><span>                    </span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
-&gt; SlotNo -&gt; Hash BlockHeader -&gt; BlockNo -&gt; Bool -&gt; IO ()
</span><a href="#local-6989586621679483856"><span class="hs-identifier hs-var">writeLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483833"><span class="hs-identifier hs-var">ledgerState</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483838"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679483837"><span class="hs-identifier hs-var">blockHeaderHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679483836"><span class="hs-identifier hs-var">blockNo</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679483832"><span class="hs-identifier hs-var">isRollbackable</span></a></span><span>
</span><span id="line-413"></span><span>              </span><span class="hs-comment">-- We don't store any 'LedgerState' if the era doesn't have epochs (Byron era) or if</span><span>
</span><span id="line-414"></span><span>              </span><span class="hs-comment">-- we don't have access to the 'LedgerState'.</span><span>
</span><span id="line-415"></span><span>              </span><span id="local-6989586621679483831"><span class="annot"><span class="annottext">(Maybe EpochNo,
 Maybe (ExtLedgerState (CardanoBlock StandardCrypto)))
</span><a href="#local-6989586621679483831"><span class="hs-identifier hs-var">_noLedgerStateOrEpochNo</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span>        </span><span class="hs-comment">-- Remove all immutable LedgerStates from the filesystem expect the most recent immutable</span><span>
</span><span id="line-418"></span><span>        </span><span class="hs-comment">-- one which is from the first slot of latest epoch.</span><span>
</span><span id="line-419"></span><span>        </span><span class="hs-comment">-- A 'LedgerState' is considered immutable if its 'blockNo' is '&lt; latestBlockNo - securityParam'.</span><span>
</span><span id="line-420"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[StorableEvent EpochStateHandle]
-&gt; Maybe (NonEmpty (StorableEvent EpochStateHandle))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">NE.nonEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent EpochStateHandle]
</span><a href="#local-6989586621679483864"><span class="hs-identifier hs-var">eventsList</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-421"></span><span>          </span><span class="annot"><span class="annottext">Maybe (NonEmpty (StorableEvent EpochStateHandle))
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>          </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679483829"><span class="annot"><span class="annottext">NonEmpty (StorableEvent EpochStateHandle)
</span><a href="#local-6989586621679483829"><span class="hs-identifier hs-var">nonEmptyEvents</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-423"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679483828"><span class="annot"><span class="annottext">chainTip :: ChainTip
</span><a href="#local-6989586621679483828"><span class="hs-identifier hs-var hs-var">chainTip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-424"></span><span>                      </span><span class="annot"><span class="annottext">NonEmpty ChainTip -&gt; ChainTip
forall a. NonEmpty a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">NE.head</span></a></span><span>
</span><span id="line-425"></span><span>                      </span><span class="annot"><span class="annottext">(NonEmpty ChainTip -&gt; ChainTip) -&gt; NonEmpty ChainTip -&gt; ChainTip
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainTip -&gt; Down (Maybe BlockNo))
-&gt; NonEmpty ChainTip -&gt; NonEmpty ChainTip
forall o a. Ord o =&gt; (a -&gt; o) -&gt; NonEmpty a -&gt; NonEmpty a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">NE.sortWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span> </span><span class="annot"><span class="annottext">ChainTip
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.ChainTipAtGenesis</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe BlockNo -&gt; Down (Maybe BlockNo)
forall a. a -&gt; Down a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Down</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe BlockNo
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">;</span><span>
</span><span id="line-426"></span><span>                                           </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ChainTip</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679483823"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679483823"><span class="hs-identifier hs-var">bn</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe BlockNo -&gt; Down (Maybe BlockNo)
forall a. a -&gt; Down a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Down</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockNo -&gt; Maybe BlockNo
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679483823"><span class="hs-identifier hs-var">bn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>                                    </span><span class="hs-special">)</span><span>
</span><span id="line-428"></span><span>                      </span><span class="annot"><span class="annottext">(NonEmpty ChainTip -&gt; NonEmpty ChainTip)
-&gt; NonEmpty ChainTip -&gt; NonEmpty ChainTip
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableEvent EpochStateHandle -&gt; ChainTip)
-&gt; NonEmpty (StorableEvent EpochStateHandle) -&gt; NonEmpty ChainTip
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; ChainTip
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventChainTip"><span class="hs-identifier hs-var hs-var">epochStateEventChainTip</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (StorableEvent EpochStateHandle)
</span><a href="#local-6989586621679483829"><span class="hs-identifier hs-var">nonEmptyEvents</span></a></span><span>
</span><span id="line-429"></span><span>
</span><span id="line-430"></span><span>              </span><span id="local-6989586621679483822"><span class="annot"><span class="annottext">[(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
</span><a href="#local-6989586621679483822"><span class="hs-identifier hs-var">ledgerStateFilePaths</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-431"></span><span>                  </span><span class="annot"><span class="annottext">(FilePath
 -&gt; Maybe (FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo)))
-&gt; [FilePath]
-&gt; [(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679483821"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483821"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">((Bool, SlotNo, Hash BlockHeader, BlockNo)
 -&gt; (FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo)))
-&gt; Maybe (Bool, SlotNo, Hash BlockHeader, BlockNo)
-&gt; Maybe (FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483821"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (Bool, SlotNo, Hash BlockHeader, BlockNo)
 -&gt; Maybe (FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo)))
-&gt; Maybe (Bool, SlotNo, Hash BlockHeader, BlockNo)
-&gt; Maybe (FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Maybe (Bool, SlotNo, Hash BlockHeader, BlockNo)
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#chainTipsFromLedgerStateFilePath"><span class="hs-identifier hs-var">chainTipsFromLedgerStateFilePath</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483821"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-432"></span><span>                  </span><span class="annot"><span class="annottext">([FilePath]
 -&gt; [(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))])
-&gt; IO [FilePath]
-&gt; IO [(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO [FilePath]
</span><a href="../../../../directory/html/src"><span class="hs-identifier hs-var">listDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483866"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span><span>
</span><span id="line-433"></span><span>
</span><span id="line-434"></span><span>              </span><span class="hs-comment">-- Delete volatile LedgerState which have become immutable.</span><span>
</span><span id="line-435"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679483819"><span class="annot"><span class="annottext">oldVolatileLedgerStateFilePaths :: [FilePath]
</span><a href="#local-6989586621679483819"><span class="hs-identifier hs-var hs-var">oldVolatileLedgerStateFilePaths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-436"></span><span>                      </span><span class="annot"><span class="annottext">((FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo)) -&gt; FilePath)
-&gt; [(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
-&gt; [FilePath]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo)) -&gt; FilePath
forall a b. (a, b) -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span>
</span><span id="line-437"></span><span>                      </span><span class="annot"><span class="annottext">([(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
 -&gt; [FilePath])
-&gt; [(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
-&gt; [FilePath]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo)) -&gt; Bool)
-&gt; [(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
-&gt; [(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679483818"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679483818"><span class="hs-identifier hs-var">isVolatile</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483817"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679483817"><span class="hs-identifier hs-var">blockNo</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-438"></span><span>                          </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679483818"><span class="hs-identifier hs-var">isVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SecurityParam -&gt; BlockNo -&gt; ChainTip -&gt; Bool
</span><a href="Marconi.ChainIndex.Utils.html#isBlockRollbackable"><span class="hs-identifier hs-var">isBlockRollbackable</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679483865"><span class="hs-identifier hs-var">securityParam</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679483817"><span class="hs-identifier hs-var">blockNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679483828"><span class="hs-identifier hs-var">chainTip</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>                      </span><span class="annot"><span class="annottext">[(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
</span><a href="#local-6989586621679483822"><span class="hs-identifier hs-var">ledgerStateFilePaths</span></a></span><span>
</span><span id="line-440"></span><span>              </span><span class="annot"><span class="annottext">[FilePath] -&gt; (FilePath -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679483819"><span class="hs-identifier hs-var">oldVolatileLedgerStateFilePaths</span></a></span><span> </span><span class="annot"><span class="annottext">((FilePath -&gt; IO ()) -&gt; IO ()) -&gt; (FilePath -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679483814"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483814"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="../../../../directory/html/src"><span class="hs-identifier hs-var">removeFile</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO ()) -&gt; FilePath -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483866"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
</span><a href="../../../../filepath/html/src"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483814"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span>              </span><span class="hs-comment">-- Delete all immutable LedgerStates expect the latest one</span><span>
</span><span id="line-443"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679483813"><span class="annot"><span class="annottext">immutableLedgerStateFilePaths :: [(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
</span><a href="#local-6989586621679483813"><span class="hs-identifier hs-var hs-var">immutableLedgerStateFilePaths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-444"></span><span>                      </span><span class="annot"><span class="annottext">((FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo)) -&gt; Bool)
-&gt; [(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
-&gt; [(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679483812"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679483812"><span class="hs-identifier hs-var">isVolatile</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679483812"><span class="hs-identifier hs-var">isVolatile</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
</span><a href="#local-6989586621679483822"><span class="hs-identifier hs-var">ledgerStateFilePaths</span></a></span><span>
</span><span id="line-445"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
-&gt; Maybe
     (NonEmpty (FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo)))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">NE.nonEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">[(FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))]
</span><a href="#local-6989586621679483813"><span class="hs-identifier hs-var">immutableLedgerStateFilePaths</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-446"></span><span>                </span><span class="annot"><span class="annottext">Maybe
  (NonEmpty (FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo)))
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679483811"><span class="annot"><span class="annottext">NonEmpty (FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))
</span><a href="#local-6989586621679483811"><span class="hs-identifier hs-var">nonEmptyLedgerStateFilePaths</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-448"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679483810"><span class="annot"><span class="annottext">oldImmutableLedgerStateFilePaths :: [FilePath]
</span><a href="#local-6989586621679483810"><span class="hs-identifier hs-var hs-var">oldImmutableLedgerStateFilePaths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-449"></span><span>                          </span><span class="annot"><span class="annottext">((FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool) -&gt; FilePath)
-&gt; [(FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)]
-&gt; [FilePath]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679483809"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483809"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(SlotNo, Hash BlockHeader, BlockNo)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483809"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-450"></span><span>                          </span><span class="annot"><span class="annottext">([(FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)]
 -&gt; [FilePath])
-&gt; [(FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)]
-&gt; [FilePath]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool) -&gt; Bool)
-&gt; [(FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)]
-&gt; [(FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(SlotNo, Hash BlockHeader, BlockNo)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483808"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679483808"><span class="hs-identifier hs-var">isImmutableBlock</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679483808"><span class="hs-identifier hs-var">isImmutableBlock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span>                          </span><span class="annot"><span class="annottext">([(FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)]
 -&gt; [(FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)])
-&gt; [(FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)]
-&gt; [(FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)
-&gt; [(FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)]
forall a. NonEmpty a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">NE.tail</span></a></span><span>
</span><span id="line-452"></span><span>                          </span><span class="annot"><span class="annottext">(NonEmpty (FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)
 -&gt; [(FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)])
-&gt; NonEmpty (FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)
-&gt; [(FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)
 -&gt; Down (BlockNo, Bool))
-&gt; NonEmpty (FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)
-&gt; NonEmpty (FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)
forall o a. Ord o =&gt; (a -&gt; o) -&gt; NonEmpty a -&gt; NonEmpty a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">NE.sortWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483806"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679483806"><span class="hs-identifier hs-var">blockNo</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483805"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679483805"><span class="hs-identifier hs-var">isImmutableBlock</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-453"></span><span>                              </span><span class="annot"><span class="annottext">(BlockNo, Bool) -&gt; Down (BlockNo, Bool)
forall a. a -&gt; Down a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Down</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679483806"><span class="hs-identifier hs-var">blockNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679483805"><span class="hs-identifier hs-var">isImmutableBlock</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-454"></span><span>                          </span><span class="annot"><span class="annottext">(NonEmpty (FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)
 -&gt; NonEmpty (FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool))
-&gt; NonEmpty (FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)
-&gt; NonEmpty (FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))
 -&gt; (FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool))
-&gt; NonEmpty (FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))
-&gt; NonEmpty (FilePath, (SlotNo, Hash BlockHeader, BlockNo), Bool)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679483804"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483804"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483803"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483803"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483802"><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679483802"><span class="hs-identifier hs-var">bhh</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483801"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679483801"><span class="hs-identifier hs-var">blockNo</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-455"></span><span>                              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483804"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-456"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483803"><span class="hs-identifier hs-var">slotNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679483802"><span class="hs-identifier hs-var">bhh</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679483801"><span class="hs-identifier hs-var">blockNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-457"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam -&gt; BlockNo -&gt; ChainTip -&gt; Bool
</span><a href="Marconi.ChainIndex.Utils.html#isBlockRollbackable"><span class="hs-identifier hs-var">isBlockRollbackable</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679483865"><span class="hs-identifier hs-var">securityParam</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679483801"><span class="hs-identifier hs-var">blockNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679483828"><span class="hs-identifier hs-var">chainTip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-458"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-459"></span><span>                          </span><span class="annot"><span class="annottext">NonEmpty (FilePath, (Bool, SlotNo, Hash BlockHeader, BlockNo))
</span><a href="#local-6989586621679483811"><span class="hs-identifier hs-var">nonEmptyLedgerStateFilePaths</span></a></span><span>
</span><span id="line-460"></span><span>                  </span><span class="annot"><span class="annottext">[FilePath] -&gt; (FilePath -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679483810"><span class="hs-identifier hs-var">oldImmutableLedgerStateFilePaths</span></a></span><span>
</span><span id="line-461"></span><span>                    </span><span class="annot"><span class="annottext">((FilePath -&gt; IO ()) -&gt; IO ()) -&gt; (FilePath -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679483800"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483800"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="../../../../directory/html/src"><span class="hs-identifier hs-var">removeFile</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO ()) -&gt; FilePath -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483866"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
</span><a href="../../../../filepath/html/src"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483800"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-462"></span><span>
</span><span id="line-463"></span><span>        </span><span class="annot"><span class="annottext">EpochStateHandle -&gt; IO EpochStateHandle
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">EpochStateHandle
</span><a href="#local-6989586621679483869"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-464"></span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-comment">-- | Buffering is not in use in this indexer and we don't need to retrieve stored events in our</span><span>
</span><span id="line-466"></span><span>    </span><span class="hs-comment">-- implementation. Therefore, this function returns an empty list.</span><span>
</span><span id="line-467"></span><span>    </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">getStoredEvents</span></a></span><span>
</span><span id="line-468"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span>
</span><span id="line-469"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-470"></span><span>    </span><span id="local-6989586621679483798"><span class="annot"><span class="annottext">getStoredEvents :: EpochStateHandle -&gt; IO [StorableEvent EpochStateHandle]
</span><a href="#local-6989586621679483798"><span class="hs-identifier hs-var hs-var hs-var hs-var">getStoredEvents</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-471"></span><span>        </span><span class="annot"><span class="annottext">[StorableEvent EpochStateHandle]
-&gt; IO [StorableEvent EpochStateHandle]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#eventToEpochSDDRows"><span class="hs-identifier hs-type">eventToEpochSDDRows</span></a></span><span>
</span><span id="line-474"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span>
</span><span id="line-475"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochSDDRow"><span class="hs-identifier hs-type">EpochSDDRow</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-476"></span><span id="eventToEpochSDDRows"><span class="annot"><span class="annottext">eventToEpochSDDRows :: StorableEvent EpochStateHandle -&gt; [EpochSDDRow]
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#eventToEpochSDDRows"><span class="hs-identifier hs-var hs-var">eventToEpochSDDRows</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateEvent"><span class="hs-identifier hs-type">EpochStateEvent</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679483797"><span class="annot"><a href="#local-6989586621679483797"><span class="hs-identifier hs-var">maybeEpochNo</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679483796"><span class="annot"><a href="#local-6989586621679483796"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679483795"><span class="annot"><a href="#local-6989586621679483795"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span id="local-6989586621679483794"><span class="annot"><a href="#local-6989586621679483794"><span class="hs-identifier hs-var">blockHeaderHash</span></a></span></span><span> </span><span id="local-6989586621679483793"><span class="annot"><a href="#local-6989586621679483793"><span class="hs-identifier hs-var">blockNo</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-477"></span><span>    </span><span class="annot"><span class="annottext">((PoolId, Lovelace) -&gt; Maybe EpochSDDRow)
-&gt; [(PoolId, Lovelace)] -&gt; [EpochSDDRow]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span>
</span><span id="line-478"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679483792"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621679483792"><span class="hs-identifier hs-var">keyHash</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483791"><span class="annot"><span class="annottext">Lovelace
</span><a href="#local-6989586621679483791"><span class="hs-identifier hs-var">lovelace</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-479"></span><span>            </span><span class="annot"><span class="annottext">(EpochNo -&gt; EpochSDDRow) -&gt; Maybe EpochNo -&gt; Maybe EpochSDDRow
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679483790"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679483790"><span class="hs-identifier hs-var">epochNo</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EpochNo
-&gt; PoolId
-&gt; Lovelace
-&gt; SlotNo
-&gt; Hash BlockHeader
-&gt; BlockNo
-&gt; EpochSDDRow
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochSDDRow"><span class="hs-identifier hs-var">EpochSDDRow</span></a></span><span>
</span><span id="line-480"></span><span>                                  </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679483790"><span class="hs-identifier hs-var">epochNo</span></a></span><span>
</span><span id="line-481"></span><span>                                  </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621679483792"><span class="hs-identifier hs-var">keyHash</span></a></span><span>
</span><span id="line-482"></span><span>                                  </span><span class="annot"><span class="annottext">Lovelace
</span><a href="#local-6989586621679483791"><span class="hs-identifier hs-var">lovelace</span></a></span><span>
</span><span id="line-483"></span><span>                                  </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483795"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-484"></span><span>                                  </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679483794"><span class="hs-identifier hs-var">blockHeaderHash</span></a></span><span>
</span><span id="line-485"></span><span>                                  </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679483793"><span class="hs-identifier hs-var">blockNo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe EpochNo
</span><a href="#local-6989586621679483797"><span class="hs-identifier hs-var">maybeEpochNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span>        </span><span class="annot"><span class="annottext">([(PoolId, Lovelace)] -&gt; [EpochSDDRow])
-&gt; [(PoolId, Lovelace)] -&gt; [EpochSDDRow]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map PoolId Lovelace -&gt; [(PoolId, Lovelace)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Map PoolId Lovelace
</span><a href="#local-6989586621679483796"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#eventToEpochNonceRow"><span class="hs-identifier hs-type">eventToEpochNonceRow</span></a></span><span>
</span><span id="line-489"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span>
</span><span id="line-490"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochNonceRow"><span class="hs-identifier hs-type">EpochNonceRow</span></a></span><span>
</span><span id="line-491"></span><span id="eventToEpochNonceRow"><span class="annot"><span class="annottext">eventToEpochNonceRow :: StorableEvent EpochStateHandle -&gt; Maybe EpochNonceRow
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#eventToEpochNonceRow"><span class="hs-identifier hs-var hs-var">eventToEpochNonceRow</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateEvent"><span class="hs-identifier hs-type">EpochStateEvent</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679483788"><span class="annot"><a href="#local-6989586621679483788"><span class="hs-identifier hs-var">maybeEpochNo</span></a></span></span><span> </span><span id="local-6989586621679483787"><span class="annot"><a href="#local-6989586621679483787"><span class="hs-identifier hs-var">nonce</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679483786"><span class="annot"><a href="#local-6989586621679483786"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span id="local-6989586621679483785"><span class="annot"><a href="#local-6989586621679483785"><span class="hs-identifier hs-var">blockHeaderHash</span></a></span></span><span> </span><span id="local-6989586621679483784"><span class="annot"><a href="#local-6989586621679483784"><span class="hs-identifier hs-var">blockNo</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-492"></span><span>    </span><span class="annot"><span class="annottext">(EpochNo -&gt; EpochNonceRow) -&gt; Maybe EpochNo -&gt; Maybe EpochNonceRow
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679483783"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679483783"><span class="hs-identifier hs-var">epochNo</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EpochNo
-&gt; Nonce -&gt; SlotNo -&gt; Hash BlockHeader -&gt; BlockNo -&gt; EpochNonceRow
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochNonceRow"><span class="hs-identifier hs-var">EpochNonceRow</span></a></span><span>
</span><span id="line-493"></span><span>                          </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679483783"><span class="hs-identifier hs-var">epochNo</span></a></span><span>
</span><span id="line-494"></span><span>                          </span><span class="annot"><span class="annottext">Nonce
</span><a href="#local-6989586621679483787"><span class="hs-identifier hs-var">nonce</span></a></span><span>
</span><span id="line-495"></span><span>                          </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483786"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-496"></span><span>                          </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679483785"><span class="hs-identifier hs-var">blockHeaderHash</span></a></span><span>
</span><span id="line-497"></span><span>                          </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679483784"><span class="hs-identifier hs-var">blockNo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe EpochNo
</span><a href="#local-6989586621679483788"><span class="hs-identifier hs-var">maybeEpochNo</span></a></span><span>
</span><span id="line-498"></span><span>
</span><span id="line-499"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Queryable</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-500"></span><span>    </span><span id="local-6989586621679483780"><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">queryStorage</span></a></span><span>
</span><span id="line-501"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Foldable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679483780"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-502"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">QueryInterval</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ChainPoint</span></a></span><span>
</span><span id="line-503"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679483780"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-504"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span>
</span><span id="line-505"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span>
</span><span id="line-506"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableResult</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span>    </span><span id="local-6989586621679483779"><span class="annot"><span class="annottext">queryStorage :: QueryInterval ChainPoint
-&gt; f (StorableEvent EpochStateHandle)
-&gt; EpochStateHandle
-&gt; StorableQuery EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
</span><a href="#local-6989586621679483779"><span class="hs-identifier hs-var hs-var hs-var hs-var">queryStorage</span></a></span></span><span> </span><span class="annot"><span class="annottext">QueryInterval ChainPoint
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679483778"><span class="annot"><span class="annottext">f (StorableEvent EpochStateHandle)
</span><a href="#local-6989586621679483778"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig (CardanoBlock StandardCrypto)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679483777"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483777"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#SDDByEpochNoQuery"><span class="hs-identifier hs-type">SDDByEpochNoQuery</span></a></span><span> </span><span id="local-6989586621679483776"><span class="annot"><a href="#local-6989586621679483776"><span class="hs-identifier hs-var">epochNo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-509"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(StorableEvent EpochStateHandle -&gt; Bool)
-&gt; [StorableEvent EpochStateHandle]
-&gt; Maybe (StorableEvent EpochStateHandle)
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">List.find</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679483774"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
</span><a href="#local-6989586621679483774"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; Maybe EpochNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventEpochNo"><span class="hs-identifier hs-var hs-var">epochStateEventEpochNo</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
</span><a href="#local-6989586621679483774"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EpochNo -&gt; Maybe EpochNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; Maybe EpochNo
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679483776"><span class="hs-identifier hs-var">epochNo</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f (StorableEvent EpochStateHandle)
-&gt; [StorableEvent EpochStateHandle]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">f (StorableEvent EpochStateHandle)
</span><a href="#local-6989586621679483778"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-510"></span><span>          </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679483773"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
</span><a href="#local-6989586621679483773"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-511"></span><span>              </span><span class="annot"><span class="annottext">StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableResult EpochStateHandle
 -&gt; IO (StorableResult EpochStateHandle))
-&gt; StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[EpochSDDRow] -&gt; StorableResult EpochStateHandle
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#SDDByEpochNoResult"><span class="hs-identifier hs-var">SDDByEpochNoResult</span></a></span><span> </span><span class="annot"><span class="annottext">([EpochSDDRow] -&gt; StorableResult EpochStateHandle)
-&gt; [EpochSDDRow] -&gt; StorableResult EpochStateHandle
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; [EpochSDDRow]
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#eventToEpochSDDRows"><span class="hs-identifier hs-var">eventToEpochSDDRows</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
</span><a href="#local-6989586621679483773"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-512"></span><span>          </span><span class="annot"><span class="annottext">Maybe (StorableEvent EpochStateHandle)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-513"></span><span>              </span><span id="local-6989586621679483772"><span class="annot"><span class="annottext">[EpochSDDRow]
</span><a href="#local-6989586621679483772"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochSDDRow"><span class="hs-identifier hs-type">EpochSDDRow</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; Only EpochNo -&gt; IO [EpochSDDRow]
forall q r.
(ToRow q, FromRow r) =&gt;
Connection -&gt; Query -&gt; q -&gt; IO [r]
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.query</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483777"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-514"></span><span>                  </span><span class="annot"><span class="">[r|SELECT epochNo, poolId, lovelace, slotNo, blockHeaderHash, blockNo
                     FROM epoch_sdd
                     WHERE epochNo = ?
                  |]</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpochNo -&gt; Only EpochNo
forall a. a -&gt; Only a
</span><a href="../../../../Only/html/src"><span class="hs-identifier hs-var">SQL.Only</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679483776"><span class="hs-identifier hs-var">epochNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-518"></span><span>              </span><span class="annot"><span class="annottext">StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableResult EpochStateHandle
 -&gt; IO (StorableResult EpochStateHandle))
-&gt; StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[EpochSDDRow] -&gt; StorableResult EpochStateHandle
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#SDDByEpochNoResult"><span class="hs-identifier hs-var">SDDByEpochNoResult</span></a></span><span> </span><span class="annot"><span class="annottext">[EpochSDDRow]
</span><a href="#local-6989586621679483772"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-519"></span><span>
</span><span id="line-520"></span><span>    </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">queryStorage</span></a></span><span> </span><span class="annot"><span class="annottext">QueryInterval ChainPoint
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679483769"><span class="annot"><span class="annottext">f (StorableEvent EpochStateHandle)
</span><a href="#local-6989586621679483769"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig (CardanoBlock StandardCrypto)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679483768"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483768"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#NonceByEpochNoQuery"><span class="hs-identifier hs-type">NonceByEpochNoQuery</span></a></span><span> </span><span id="local-6989586621679483767"><span class="annot"><a href="#local-6989586621679483767"><span class="hs-identifier hs-var">epochNo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-521"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(StorableEvent EpochStateHandle -&gt; Bool)
-&gt; [StorableEvent EpochStateHandle]
-&gt; Maybe (StorableEvent EpochStateHandle)
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">List.find</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679483766"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
</span><a href="#local-6989586621679483766"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; Maybe EpochNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventEpochNo"><span class="hs-identifier hs-var hs-var">epochStateEventEpochNo</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
</span><a href="#local-6989586621679483766"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EpochNo -&gt; Maybe EpochNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; Maybe EpochNo
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679483767"><span class="hs-identifier hs-var">epochNo</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f (StorableEvent EpochStateHandle)
-&gt; [StorableEvent EpochStateHandle]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">f (StorableEvent EpochStateHandle)
</span><a href="#local-6989586621679483769"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-522"></span><span>          </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679483765"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
</span><a href="#local-6989586621679483765"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-523"></span><span>              </span><span class="annot"><span class="annottext">StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableResult EpochStateHandle
 -&gt; IO (StorableResult EpochStateHandle))
-&gt; StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EpochNonceRow -&gt; StorableResult EpochStateHandle
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#NonceByEpochNoResult"><span class="hs-identifier hs-var">NonceByEpochNoResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe EpochNonceRow -&gt; StorableResult EpochStateHandle)
-&gt; Maybe EpochNonceRow -&gt; StorableResult EpochStateHandle
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; Maybe EpochNonceRow
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#eventToEpochNonceRow"><span class="hs-identifier hs-var">eventToEpochNonceRow</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
</span><a href="#local-6989586621679483765"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-524"></span><span>          </span><span class="annot"><span class="annottext">Maybe (StorableEvent EpochStateHandle)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-525"></span><span>              </span><span id="local-6989586621679483764"><span class="annot"><span class="annottext">[EpochNonceRow]
</span><a href="#local-6989586621679483764"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochNonceRow"><span class="hs-identifier hs-type">EpochNonceRow</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; Only EpochNo -&gt; IO [EpochNonceRow]
forall q r.
(ToRow q, FromRow r) =&gt;
Connection -&gt; Query -&gt; q -&gt; IO [r]
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.query</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483768"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-526"></span><span>                  </span><span class="annot"><span class="">[r|SELECT epochNo, nonce, slotNo, blockHeaderHash, blockNo
                     FROM epoch_nonce
                     WHERE epochNo = ?
                  |]</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpochNo -&gt; Only EpochNo
forall a. a -&gt; Only a
</span><a href="../../../../Only/html/src"><span class="hs-identifier hs-var">SQL.Only</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679483767"><span class="hs-identifier hs-var">epochNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-530"></span><span>              </span><span class="annot"><span class="annottext">StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableResult EpochStateHandle
 -&gt; IO (StorableResult EpochStateHandle))
-&gt; StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EpochNonceRow -&gt; StorableResult EpochStateHandle
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#NonceByEpochNoResult"><span class="hs-identifier hs-var">NonceByEpochNoResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe EpochNonceRow -&gt; StorableResult EpochStateHandle)
-&gt; Maybe EpochNonceRow -&gt; StorableResult EpochStateHandle
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[EpochNonceRow] -&gt; Maybe EpochNonceRow
forall a. [a] -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[EpochNonceRow]
</span><a href="#local-6989586621679483764"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span>    </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">queryStorage</span></a></span><span> </span><span class="annot"><span class="annottext">QueryInterval ChainPoint
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">f (StorableEvent EpochStateHandle)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#LedgerStateAtPointQuery"><span class="hs-identifier hs-type">LedgerStateAtPointQuery</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ChainPointAtGenesis</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-533"></span><span>        </span><span class="annot"><span class="annottext">StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableResult EpochStateHandle
 -&gt; IO (StorableResult EpochStateHandle))
-&gt; StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
-&gt; StorableResult EpochStateHandle
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#LedgerStateAtPointResult"><span class="hs-identifier hs-var">LedgerStateAtPointResult</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-534"></span><span>    </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">queryStorage</span></a></span><span>
</span><span id="line-535"></span><span>            </span><span class="annot"><span class="annottext">QueryInterval ChainPoint
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-536"></span><span>            </span><span id="local-6989586621679483762"><span class="annot"><span class="annottext">f (StorableEvent EpochStateHandle)
</span><a href="#local-6989586621679483762"><span class="hs-identifier hs-var">events</span></a></span></span><span>
</span><span id="line-537"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span id="local-6989586621679483761"><span class="annot"><span class="annottext">TopLevelConfig (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483761"><span class="hs-identifier hs-var">topLevelConfig</span></a></span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679483760"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483760"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-538"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#LedgerStateAtPointQuery"><span class="hs-identifier hs-type">LedgerStateAtPointQuery</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ChainPoint</span></a></span><span> </span><span id="local-6989586621679483759"><span class="annot"><a href="#local-6989586621679483759"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-539"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(StorableEvent EpochStateHandle -&gt; Bool)
-&gt; [StorableEvent EpochStateHandle]
-&gt; Maybe (StorableEvent EpochStateHandle)
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">List.find</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679483758"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
</span><a href="#local-6989586621679483758"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle -&gt; SlotNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventSlotNo"><span class="hs-identifier hs-var hs-var">epochStateEventSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
</span><a href="#local-6989586621679483758"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483759"><span class="hs-identifier hs-var">slotNo</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">f (StorableEvent EpochStateHandle)
-&gt; [StorableEvent EpochStateHandle]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">f (StorableEvent EpochStateHandle)
</span><a href="#local-6989586621679483762"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-540"></span><span>            </span><span class="annot"><span class="annottext">Maybe (StorableEvent EpochStateHandle)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-541"></span><span>                </span><span id="local-6989586621679483757"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679483757"><span class="hs-identifier hs-var">ledgerStateFilePaths</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO [FilePath]
</span><a href="../../../../directory/html/src"><span class="hs-identifier hs-var">listDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483760"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span><span>
</span><span id="line-542"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679483756"><span class="annot"><span class="annottext">ledgerStateFilePath :: Maybe FilePath
</span><a href="#local-6989586621679483756"><span class="hs-identifier hs-var hs-var">ledgerStateFilePath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-543"></span><span>                        </span><span class="annot"><span class="annottext">(FilePath -&gt; Bool) -&gt; [FilePath] -&gt; Maybe FilePath
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">List.find</span></a></span><span>
</span><span id="line-544"></span><span>                            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679483755"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483755"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">((Bool, SlotNo, Hash BlockHeader, BlockNo) -&gt; SlotNo)
-&gt; Maybe (Bool, SlotNo, Hash BlockHeader, BlockNo) -&gt; Maybe SlotNo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483754"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483754"><span class="hs-identifier hs-var">sn</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483754"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>                                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; Maybe (Bool, SlotNo, Hash BlockHeader, BlockNo)
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#chainTipsFromLedgerStateFilePath"><span class="hs-identifier hs-var">chainTipsFromLedgerStateFilePath</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483755"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe SlotNo -&gt; Maybe SlotNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Maybe SlotNo
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483759"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-546"></span><span>                            </span><span class="hs-special">)</span><span>
</span><span id="line-547"></span><span>                            </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679483757"><span class="hs-identifier hs-var">ledgerStateFilePaths</span></a></span><span>
</span><span id="line-548"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621679483756"><span class="hs-identifier hs-var">ledgerStateFilePath</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-549"></span><span>                  </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableResult EpochStateHandle
 -&gt; IO (StorableResult EpochStateHandle))
-&gt; StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
-&gt; StorableResult EpochStateHandle
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#LedgerStateAtPointResult"><span class="hs-identifier hs-var">LedgerStateAtPointResult</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-550"></span><span>                  </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679483753"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483753"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-551"></span><span>                      </span><span id="local-6989586621679483752"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679483752"><span class="hs-identifier hs-var">ledgerStateBs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ByteString
</span><a href="../../../../bytestring/html/src"><span class="hs-identifier hs-var">BS.readFile</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO ByteString) -&gt; FilePath -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483760"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
</span><a href="../../../../filepath/html/src"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483753"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-552"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679483750"><span class="annot"><span class="annottext">codecConfig :: CodecConfig (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483750"><span class="hs-identifier hs-var hs-var">codecConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig (CardanoBlock StandardCrypto)
-&gt; CodecConfig (CardanoBlock StandardCrypto)
forall blk. TopLevelConfig blk -&gt; CodecConfig blk
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var">O.configCodec</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483761"><span class="hs-identifier hs-var">topLevelConfig</span></a></span><span>
</span><span id="line-553"></span><span>                          </span><span id="local-6989586621679483749"><span class="annot"><span class="annottext">ledgerState :: Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
</span><a href="#local-6989586621679483749"><span class="hs-identifier hs-var hs-var">ledgerState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-554"></span><span>                              </span><span class="annot"><span class="annottext">(DeserialiseFailure
 -&gt; Maybe (ExtLedgerState (CardanoBlock StandardCrypto)))
-&gt; ((ByteString, ExtLedgerState (CardanoBlock StandardCrypto))
    -&gt; Maybe (ExtLedgerState (CardanoBlock StandardCrypto)))
-&gt; Either
     DeserialiseFailure
     (ByteString, ExtLedgerState (CardanoBlock StandardCrypto))
-&gt; Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">either</span></a></span><span>
</span><span id="line-555"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
-&gt; DeserialiseFailure
-&gt; Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-556"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState (CardanoBlock StandardCrypto)
-&gt; Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState (CardanoBlock StandardCrypto)
 -&gt; Maybe (ExtLedgerState (CardanoBlock StandardCrypto)))
-&gt; ((ByteString, ExtLedgerState (CardanoBlock StandardCrypto))
    -&gt; ExtLedgerState (CardanoBlock StandardCrypto))
-&gt; (ByteString, ExtLedgerState (CardanoBlock StandardCrypto))
-&gt; Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString, ExtLedgerState (CardanoBlock StandardCrypto))
-&gt; ExtLedgerState (CardanoBlock StandardCrypto)
forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span>                                </span><span class="annot"><span class="annottext">(Either
   DeserialiseFailure
   (ByteString, ExtLedgerState (CardanoBlock StandardCrypto))
 -&gt; Maybe (ExtLedgerState (CardanoBlock StandardCrypto)))
-&gt; Either
     DeserialiseFailure
     (ByteString, ExtLedgerState (CardanoBlock StandardCrypto))
-&gt; Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(forall s.
 Decoder s (ExtLedgerState (CardanoBlock StandardCrypto)))
-&gt; ByteString
-&gt; Either
     DeserialiseFailure
     (ByteString, ExtLedgerState (CardanoBlock StandardCrypto))
forall a.
(forall s. Decoder s a)
-&gt; ByteString -&gt; Either DeserialiseFailure (ByteString, a)
</span><a href="../../../../cborg/html/src"><span class="hs-identifier hs-var">CBOR.deserialiseFromBytes</span></a></span><span>
</span><span id="line-558"></span><span>                                    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(forall s. Decoder s (LedgerState (CardanoBlock StandardCrypto)))
-&gt; (forall s.
    Decoder
      s (ChainDepState (BlockProtocol (CardanoBlock StandardCrypto))))
-&gt; (forall s. Decoder s (AnnTip (CardanoBlock StandardCrypto)))
-&gt; forall s.
   Decoder s (ExtLedgerState (CardanoBlock StandardCrypto))
forall blk.
(forall s. Decoder s (LedgerState blk))
-&gt; (forall s. Decoder s (ChainDepState (BlockProtocol blk)))
-&gt; (forall s. Decoder s (AnnTip blk))
-&gt; forall s. Decoder s (ExtLedgerState blk)
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var">O.decodeExtLedgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodecConfig (CardanoBlock StandardCrypto)
-&gt; forall s. Decoder s (LedgerState (CardanoBlock StandardCrypto))
forall blk a.
DecodeDisk blk a =&gt;
CodecConfig blk -&gt; forall s. Decoder s a
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var">O.decodeDisk</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483750"><span class="hs-identifier hs-var">codecConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-559"></span><span>                                                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodecConfig (CardanoBlock StandardCrypto)
-&gt; forall s.
   Decoder
     s
     (HardForkChainDepState
        (ByronBlock : CardanoShelleyEras StandardCrypto))
forall blk a.
DecodeDisk blk a =&gt;
CodecConfig blk -&gt; forall s. Decoder s a
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var">O.decodeDisk</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483750"><span class="hs-identifier hs-var">codecConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span>                                                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodecConfig (CardanoBlock StandardCrypto)
-&gt; forall s. Decoder s (AnnTip (CardanoBlock StandardCrypto))
forall blk a.
DecodeDisk blk a =&gt;
CodecConfig blk -&gt; forall s. Decoder s a
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var">O.decodeDisk</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483750"><span class="hs-identifier hs-var">codecConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-561"></span><span>                                    </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679483752"><span class="hs-identifier hs-var">ledgerStateBs</span></a></span><span>
</span><span id="line-562"></span><span>                      </span><span class="annot"><span class="annottext">StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableResult EpochStateHandle
 -&gt; IO (StorableResult EpochStateHandle))
-&gt; StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
-&gt; StorableResult EpochStateHandle
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#LedgerStateAtPointResult"><span class="hs-identifier hs-var">LedgerStateAtPointResult</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
</span><a href="#local-6989586621679483749"><span class="hs-identifier hs-var">ledgerState</span></a></span><span>
</span><span id="line-563"></span><span>            </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679483743"><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
</span><a href="#local-6989586621679483743"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableResult EpochStateHandle
 -&gt; IO (StorableResult EpochStateHandle))
-&gt; StorableResult EpochStateHandle
-&gt; IO (StorableResult EpochStateHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
-&gt; StorableResult EpochStateHandle
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#LedgerStateAtPointResult"><span class="hs-identifier hs-var">LedgerStateAtPointResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
 -&gt; StorableResult EpochStateHandle)
-&gt; Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
-&gt; StorableResult EpochStateHandle
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
-&gt; Maybe (ExtLedgerState (CardanoBlock StandardCrypto))
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#epochStateEventLedgerState"><span class="hs-identifier hs-var hs-var">epochStateEventLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
</span><a href="#local-6989586621679483743"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-564"></span><span>
</span><span id="line-565"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Rewindable</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-566"></span><span>    </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">rewindStorage</span></a></span><span>
</span><span id="line-567"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ChainPoint</span></a></span><span>
</span><span id="line-568"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span>
</span><span id="line-569"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>    </span><span id="local-6989586621679483740"><span class="annot"><span class="annottext">rewindStorage :: ChainPoint -&gt; EpochStateHandle -&gt; IO (Maybe EpochStateHandle)
</span><a href="#local-6989586621679483740"><span class="hs-identifier hs-var hs-var hs-var hs-var">rewindStorage</span></a></span></span><span> </span><span class="annot"><span class="annottext">ChainPoint
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.ChainPointAtGenesis</span></a></span><span> </span><span id="local-6989586621679483739"><span class="annot"><span class="annottext">h :: EpochStateHandle
</span><a href="#local-6989586621679483739"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig (CardanoBlock StandardCrypto)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679483738"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483738"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679483737"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483737"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-571"></span><span>        </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483738"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;DELETE FROM epoch_sdd&quot;</span></span><span>
</span><span id="line-572"></span><span>        </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483738"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;DELETE FROM epoch_nonce&quot;</span></span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span>        </span><span id="local-6989586621679483736"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679483736"><span class="hs-identifier hs-var">ledgerStateFilePaths</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO [FilePath]
</span><a href="../../../../directory/html/src"><span class="hs-identifier hs-var">listDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483737"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span><span>
</span><span id="line-575"></span><span>        </span><span class="annot"><span class="annottext">[FilePath] -&gt; (FilePath -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679483736"><span class="hs-identifier hs-var">ledgerStateFilePaths</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679483735"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483735"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="../../../../directory/html/src"><span class="hs-identifier hs-var">removeFile</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO ()) -&gt; FilePath -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483737"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
</span><a href="../../../../filepath/html/src"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483735"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-576"></span><span>        </span><span class="annot"><span class="annottext">Maybe EpochStateHandle -&gt; IO (Maybe EpochStateHandle)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe EpochStateHandle -&gt; IO (Maybe EpochStateHandle))
-&gt; Maybe EpochStateHandle -&gt; IO (Maybe EpochStateHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">EpochStateHandle -&gt; Maybe EpochStateHandle
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">EpochStateHandle
</span><a href="#local-6989586621679483739"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-577"></span><span>    </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">rewindStorage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ChainPoint</span></a></span><span> </span><span id="local-6989586621679483734"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483734"><span class="hs-identifier hs-var">sn</span></a></span></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679483733"><span class="annot"><span class="annottext">h :: EpochStateHandle
</span><a href="#local-6989586621679483733"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig (CardanoBlock StandardCrypto)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679483732"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483732"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679483731"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483731"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-578"></span><span>        </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; Only SlotNo -&gt; IO ()
forall q. ToRow q =&gt; Connection -&gt; Query -&gt; q -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483732"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;DELETE FROM epoch_sdd WHERE slotNo &gt; ?&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Only SlotNo
forall a. a -&gt; Only a
</span><a href="../../../../Only/html/src"><span class="hs-identifier hs-var">SQL.Only</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483734"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-579"></span><span>        </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; Only SlotNo -&gt; IO ()
forall q. ToRow q =&gt; Connection -&gt; Query -&gt; q -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483732"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;DELETE FROM epoch_nonce WHERE slotNo &gt; ?&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Only SlotNo
forall a. a -&gt; Only a
</span><a href="../../../../Only/html/src"><span class="hs-identifier hs-var">SQL.Only</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483734"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-580"></span><span>
</span><span id="line-581"></span><span>        </span><span id="local-6989586621679483730"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679483730"><span class="hs-identifier hs-var">ledgerStateFilePaths</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO [FilePath]
</span><a href="../../../../directory/html/src"><span class="hs-identifier hs-var">listDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483731"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span><span>
</span><span id="line-582"></span><span>        </span><span class="annot"><span class="annottext">[FilePath] -&gt; (FilePath -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679483730"><span class="hs-identifier hs-var">ledgerStateFilePaths</span></a></span><span> </span><span class="annot"><span class="annottext">((FilePath -&gt; IO ()) -&gt; IO ()) -&gt; (FilePath -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679483729"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483729"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-583"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Maybe (Bool, SlotNo, Hash BlockHeader, BlockNo)
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#chainTipsFromLedgerStateFilePath"><span class="hs-identifier hs-var">chainTipsFromLedgerStateFilePath</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483729"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-584"></span><span>              </span><span class="annot"><span class="annottext">Maybe (Bool, SlotNo, Hash BlockHeader, BlockNo)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span>              </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483728"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483728"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483728"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483734"><span class="hs-identifier hs-var">sn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="../../../../directory/html/src"><span class="hs-identifier hs-var">removeFile</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO ()) -&gt; FilePath -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483731"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
</span><a href="../../../../filepath/html/src"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483729"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-586"></span><span>              </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool, SlotNo, Hash BlockHeader, BlockNo)
</span><span class="hs-identifier">_</span></span><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-587"></span><span>
</span><span id="line-588"></span><span>        </span><span class="annot"><span class="annottext">Maybe EpochStateHandle -&gt; IO (Maybe EpochStateHandle)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe EpochStateHandle -&gt; IO (Maybe EpochStateHandle))
-&gt; Maybe EpochStateHandle -&gt; IO (Maybe EpochStateHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">EpochStateHandle -&gt; Maybe EpochStateHandle
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">EpochStateHandle
</span><a href="#local-6989586621679483733"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Resumable</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-591"></span><span>    </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">resumeFromStorage</span></a></span><span>
</span><span id="line-592"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span>
</span><span id="line-593"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ChainPoint</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-594"></span><span>    </span><span id="local-6989586621679483723"><span class="annot"><span class="annottext">resumeFromStorage :: EpochStateHandle -&gt; IO [ChainPoint]
</span><a href="#local-6989586621679483723"><span class="hs-identifier hs-var hs-var hs-var hs-var">resumeFromStorage</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig (CardanoBlock StandardCrypto)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679483722"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483722"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679483721"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483721"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-595"></span><span>        </span><span id="local-6989586621679483720"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679483720"><span class="hs-identifier hs-var">ledgerStateFilepaths</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO [FilePath]
</span><a href="../../../../directory/html/src"><span class="hs-identifier hs-var">listDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483721"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span><span>
</span><span id="line-596"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679483719"><span class="annot"><span class="annottext">ledgerStateChainPoints :: [(SlotNo, Hash BlockHeader)]
</span><a href="#local-6989586621679483719"><span class="hs-identifier hs-var hs-var">ledgerStateChainPoints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-597"></span><span>                </span><span class="annot"><span class="annottext">((Bool, SlotNo, Hash BlockHeader, BlockNo)
 -&gt; (SlotNo, Hash BlockHeader))
-&gt; [(Bool, SlotNo, Hash BlockHeader, BlockNo)]
-&gt; [(SlotNo, Hash BlockHeader)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483718"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483718"><span class="hs-identifier hs-var">sn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483717"><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679483717"><span class="hs-identifier hs-var">bhh</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483718"><span class="hs-identifier hs-var">sn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679483717"><span class="hs-identifier hs-var">bhh</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-598"></span><span>                </span><span class="annot"><span class="annottext">([(Bool, SlotNo, Hash BlockHeader, BlockNo)]
 -&gt; [(SlotNo, Hash BlockHeader)])
-&gt; [(Bool, SlotNo, Hash BlockHeader, BlockNo)]
-&gt; [(SlotNo, Hash BlockHeader)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; Maybe (Bool, SlotNo, Hash BlockHeader, BlockNo))
-&gt; [FilePath] -&gt; [(Bool, SlotNo, Hash BlockHeader, BlockNo)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Maybe (Bool, SlotNo, Hash BlockHeader, BlockNo)
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#chainTipsFromLedgerStateFilePath"><span class="hs-identifier hs-var">chainTipsFromLedgerStateFilePath</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621679483720"><span class="hs-identifier hs-var">ledgerStateFilepaths</span></a></span><span>
</span><span id="line-599"></span><span>
</span><span id="line-600"></span><span>        </span><span id="local-6989586621679483716"><span class="annot"><span class="annottext">[(SlotNo, Hash BlockHeader)]
</span><a href="#local-6989586621679483716"><span class="hs-identifier hs-var">epochSDDChainPoints</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(((SlotNo, Hash BlockHeader) -&gt; IO Bool)
 -&gt; [(SlotNo, Hash BlockHeader)] -&gt; IO [(SlotNo, Hash BlockHeader)])
-&gt; [(SlotNo, Hash BlockHeader)]
-&gt; ((SlotNo, Hash BlockHeader) -&gt; IO Bool)
-&gt; IO [(SlotNo, Hash BlockHeader)]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">((SlotNo, Hash BlockHeader) -&gt; IO Bool)
-&gt; [(SlotNo, Hash BlockHeader)] -&gt; IO [(SlotNo, Hash BlockHeader)]
forall (m :: * -&gt; *) a.
Applicative m =&gt;
(a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filterM</span></a></span><span> </span><span class="annot"><span class="annottext">[(SlotNo, Hash BlockHeader)]
</span><a href="#local-6989586621679483719"><span class="hs-identifier hs-var">ledgerStateChainPoints</span></a></span><span> </span><span class="annot"><span class="annottext">(((SlotNo, Hash BlockHeader) -&gt; IO Bool)
 -&gt; IO [(SlotNo, Hash BlockHeader)])
-&gt; ((SlotNo, Hash BlockHeader) -&gt; IO Bool)
-&gt; IO [(SlotNo, Hash BlockHeader)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679483714"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483714"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-601"></span><span>            </span><span id="local-6989586621679483713"><span class="annot"><span class="annottext">[[SlotNo]]
</span><a href="#local-6989586621679483713"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.SlotNo</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; Only SlotNo -&gt; IO [[SlotNo]]
forall q r.
(ToRow q, FromRow r) =&gt;
Connection -&gt; Query -&gt; q -&gt; IO [r]
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.query</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483722"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-602"></span><span>                </span><span class="annot"><span class="">[r|SELECT slotNo
                   FROM epoch_sdd
                   WHERE slotNo = ? LIMIT 1 |]</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Only SlotNo
forall a. a -&gt; Only a
</span><a href="../../../../Only/html/src"><span class="hs-identifier hs-var">SQL.Only</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483714"><span class="hs-identifier hs-var">slotNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-605"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; IO Bool) -&gt; Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[[SlotNo]] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[[SlotNo]]
</span><a href="#local-6989586621679483713"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-606"></span><span>
</span><span id="line-607"></span><span>        </span><span id="local-6989586621679483711"><span class="annot"><span class="annottext">[(SlotNo, Hash BlockHeader)]
</span><a href="#local-6989586621679483711"><span class="hs-identifier hs-var">epochNonceChainPoints</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(((SlotNo, Hash BlockHeader) -&gt; IO Bool)
 -&gt; [(SlotNo, Hash BlockHeader)] -&gt; IO [(SlotNo, Hash BlockHeader)])
-&gt; [(SlotNo, Hash BlockHeader)]
-&gt; ((SlotNo, Hash BlockHeader) -&gt; IO Bool)
-&gt; IO [(SlotNo, Hash BlockHeader)]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">((SlotNo, Hash BlockHeader) -&gt; IO Bool)
-&gt; [(SlotNo, Hash BlockHeader)] -&gt; IO [(SlotNo, Hash BlockHeader)]
forall (m :: * -&gt; *) a.
Applicative m =&gt;
(a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filterM</span></a></span><span> </span><span class="annot"><span class="annottext">[(SlotNo, Hash BlockHeader)]
</span><a href="#local-6989586621679483719"><span class="hs-identifier hs-var">ledgerStateChainPoints</span></a></span><span> </span><span class="annot"><span class="annottext">(((SlotNo, Hash BlockHeader) -&gt; IO Bool)
 -&gt; IO [(SlotNo, Hash BlockHeader)])
-&gt; ((SlotNo, Hash BlockHeader) -&gt; IO Bool)
-&gt; IO [(SlotNo, Hash BlockHeader)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679483710"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483710"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-608"></span><span>            </span><span id="local-6989586621679483709"><span class="annot"><span class="annottext">[[SlotNo]]
</span><a href="#local-6989586621679483709"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.SlotNo</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; Only SlotNo -&gt; IO [[SlotNo]]
forall q r.
(ToRow q, FromRow r) =&gt;
Connection -&gt; Query -&gt; q -&gt; IO [r]
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.query</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483722"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-609"></span><span>                </span><span class="annot"><span class="">[r|SELECT slotNo
                   FROM epoch_nonce
                   WHERE slotNo = ? LIMIT 1 |]</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Only SlotNo
forall a. a -&gt; Only a
</span><a href="../../../../Only/html/src"><span class="hs-identifier hs-var">SQL.Only</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679483710"><span class="hs-identifier hs-var">slotNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-612"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; IO Bool) -&gt; Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[[SlotNo]] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[[SlotNo]]
</span><a href="#local-6989586621679483709"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679483708"><span class="annot"><span class="annottext">resumablePoints :: [(SlotNo, Hash BlockHeader)]
</span><a href="#local-6989586621679483708"><span class="hs-identifier hs-var hs-var">resumablePoints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set (SlotNo, Hash BlockHeader) -&gt; [(SlotNo, Hash BlockHeader)]
forall a. Set a -&gt; [a]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.toList</span></a></span><span>
</span><span id="line-615"></span><span>                            </span><span class="annot"><span class="annottext">(Set (SlotNo, Hash BlockHeader) -&gt; [(SlotNo, Hash BlockHeader)])
-&gt; Set (SlotNo, Hash BlockHeader) -&gt; [(SlotNo, Hash BlockHeader)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Set (SlotNo, Hash BlockHeader)
-&gt; Set (SlotNo, Hash BlockHeader) -&gt; Set (SlotNo, Hash BlockHeader)
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.intersection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(SlotNo, Hash BlockHeader)] -&gt; Set (SlotNo, Hash BlockHeader)
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[(SlotNo, Hash BlockHeader)]
</span><a href="#local-6989586621679483716"><span class="hs-identifier hs-var">epochSDDChainPoints</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-616"></span><span>                                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(SlotNo, Hash BlockHeader)] -&gt; Set (SlotNo, Hash BlockHeader)
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[(SlotNo, Hash BlockHeader)]
</span><a href="#local-6989586621679483711"><span class="hs-identifier hs-var">epochNonceChainPoints</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-617"></span><span>        </span><span class="annot"><span class="annottext">[ChainPoint] -&gt; IO [ChainPoint]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span>
</span><span id="line-618"></span><span>            </span><span class="annot"><span class="annottext">([ChainPoint] -&gt; IO [ChainPoint])
-&gt; [ChainPoint] -&gt; IO [ChainPoint]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainPoint -&gt; Down ChainPoint) -&gt; [ChainPoint] -&gt; [ChainPoint]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">List.sortOn</span></a></span><span> </span><span class="annot"><span class="annottext">ChainPoint -&gt; Down ChainPoint
forall a. a -&gt; Down a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Down</span></a></span><span>
</span><span id="line-619"></span><span>            </span><span class="annot"><span class="annottext">([ChainPoint] -&gt; [ChainPoint]) -&gt; [ChainPoint] -&gt; [ChainPoint]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((SlotNo, Hash BlockHeader) -&gt; ChainPoint)
-&gt; [(SlotNo, Hash BlockHeader)] -&gt; [ChainPoint]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SlotNo -&gt; Hash BlockHeader -&gt; ChainPoint)
-&gt; (SlotNo, Hash BlockHeader) -&gt; ChainPoint
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">uncurry</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Hash BlockHeader -&gt; ChainPoint
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.ChainPoint</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(SlotNo, Hash BlockHeader)]
</span><a href="#local-6989586621679483708"><span class="hs-identifier hs-var">resumablePoints</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainPoint] -&gt; [ChainPoint] -&gt; [ChainPoint]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ChainPoint
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.ChainPointAtGenesis</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-620"></span><span>
</span><span id="line-621"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#chainTipsFromLedgerStateFilePath"><span class="hs-identifier hs-type">chainTipsFromLedgerStateFilePath</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.SlotNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.Hash</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.BlockHeader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">C.BlockNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-622"></span><span id="chainTipsFromLedgerStateFilePath"><span class="annot"><span class="annottext">chainTipsFromLedgerStateFilePath :: FilePath -&gt; Maybe (Bool, SlotNo, Hash BlockHeader, BlockNo)
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#chainTipsFromLedgerStateFilePath"><span class="hs-identifier hs-var hs-var">chainTipsFromLedgerStateFilePath</span></a></span></span><span> </span><span id="local-6989586621679483702"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483702"><span class="hs-identifier hs-var">ledgerStateFilepath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-623"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; [Text]
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">Text.splitOn</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; Text
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">Text.pack</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; Text) -&gt; FilePath -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ShowS
</span><a href="../../../../filepath/html/src"><span class="hs-identifier hs-var">dropExtension</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483702"><span class="hs-identifier hs-var">ledgerStateFilepath</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-624"></span><span>      </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483699"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483699"><span class="hs-identifier hs-var">slotNoStr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483698"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483698"><span class="hs-identifier hs-var">bhhStr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483697"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483697"><span class="hs-identifier hs-var">blockNoStr</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-625"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">,</span><span class="annot"><span class="hs-special">,</span></span><span class="annot"><span class="hs-special">,</span></span><span class="hs-special">)</span><span>
</span><span id="line-626"></span><span>            </span><span class="annot"><span class="annottext">(SlotNo
 -&gt; Hash BlockHeader
 -&gt; BlockNo
 -&gt; (Bool, SlotNo, Hash BlockHeader, BlockNo))
-&gt; Maybe SlotNo
-&gt; Maybe
     (Hash BlockHeader
      -&gt; BlockNo -&gt; (Bool, SlotNo, Hash BlockHeader, BlockNo))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe SlotNo
</span><a href="#local-6989586621679483696"><span class="hs-identifier hs-var">parseSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483699"><span class="hs-identifier hs-var">slotNoStr</span></a></span><span>
</span><span id="line-627"></span><span>            </span><span class="annot"><span class="annottext">Maybe
  (Hash BlockHeader
   -&gt; BlockNo -&gt; (Bool, SlotNo, Hash BlockHeader, BlockNo))
-&gt; Maybe (Hash BlockHeader)
-&gt; Maybe (BlockNo -&gt; (Bool, SlotNo, Hash BlockHeader, BlockNo))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe (Hash BlockHeader)
forall b. SerialiseAsRawBytes b =&gt; Text -&gt; Maybe b
</span><a href="#local-6989586621679483695"><span class="hs-identifier hs-var">parseBlockHeaderHash</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483698"><span class="hs-identifier hs-var">bhhStr</span></a></span><span>
</span><span id="line-628"></span><span>            </span><span class="annot"><span class="annottext">Maybe (BlockNo -&gt; (Bool, SlotNo, Hash BlockHeader, BlockNo))
-&gt; Maybe BlockNo -&gt; Maybe (Bool, SlotNo, Hash BlockHeader, BlockNo)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe BlockNo
</span><a href="#local-6989586621679483694"><span class="hs-identifier hs-var">parseBlockNo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483697"><span class="hs-identifier hs-var">blockNoStr</span></a></span><span>
</span><span id="line-629"></span><span>      </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;volatile&quot;</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483693"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483693"><span class="hs-identifier hs-var">slotNoStr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483692"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483692"><span class="hs-identifier hs-var">bhhStr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679483691"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483691"><span class="hs-identifier hs-var">blockNoStr</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-630"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">,</span><span class="annot"><span class="hs-special">,</span></span><span class="annot"><span class="hs-special">,</span></span><span class="hs-special">)</span><span>
</span><span id="line-631"></span><span>            </span><span class="annot"><span class="annottext">(SlotNo
 -&gt; Hash BlockHeader
 -&gt; BlockNo
 -&gt; (Bool, SlotNo, Hash BlockHeader, BlockNo))
-&gt; Maybe SlotNo
-&gt; Maybe
     (Hash BlockHeader
      -&gt; BlockNo -&gt; (Bool, SlotNo, Hash BlockHeader, BlockNo))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe SlotNo
</span><a href="#local-6989586621679483696"><span class="hs-identifier hs-var">parseSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483693"><span class="hs-identifier hs-var">slotNoStr</span></a></span><span>
</span><span id="line-632"></span><span>            </span><span class="annot"><span class="annottext">Maybe
  (Hash BlockHeader
   -&gt; BlockNo -&gt; (Bool, SlotNo, Hash BlockHeader, BlockNo))
-&gt; Maybe (Hash BlockHeader)
-&gt; Maybe (BlockNo -&gt; (Bool, SlotNo, Hash BlockHeader, BlockNo))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe (Hash BlockHeader)
forall b. SerialiseAsRawBytes b =&gt; Text -&gt; Maybe b
</span><a href="#local-6989586621679483695"><span class="hs-identifier hs-var">parseBlockHeaderHash</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483692"><span class="hs-identifier hs-var">bhhStr</span></a></span><span>
</span><span id="line-633"></span><span>            </span><span class="annot"><span class="annottext">Maybe (BlockNo -&gt; (Bool, SlotNo, Hash BlockHeader, BlockNo))
-&gt; Maybe BlockNo -&gt; Maybe (Bool, SlotNo, Hash BlockHeader, BlockNo)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe BlockNo
</span><a href="#local-6989586621679483694"><span class="hs-identifier hs-var">parseBlockNo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483691"><span class="hs-identifier hs-var">blockNoStr</span></a></span><span>
</span><span id="line-634"></span><span>      </span><span id="local-6989586621679483690"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679483690"><span class="hs-identifier hs-var">_anyOtherFailure</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Bool, SlotNo, Hash BlockHeader, BlockNo)
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-635"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-636"></span><span>     </span><span id="local-6989586621679483696"><span class="annot"><span class="annottext">parseSlotNo :: Text -&gt; Maybe SlotNo
</span><a href="#local-6989586621679483696"><span class="hs-identifier hs-var hs-var">parseSlotNo</span></a></span></span><span> </span><span id="local-6989586621679483689"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483689"><span class="hs-identifier hs-var">slotNoStr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; SlotNo
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">C.SlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; SlotNo) -&gt; Maybe Word64 -&gt; Maybe SlotNo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Maybe Word64
forall a. Read a =&gt; FilePath -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">readMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; FilePath
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">Text.unpack</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483689"><span class="hs-identifier hs-var">slotNoStr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-637"></span><span>     </span><span id="local-6989586621679483695"><span class="annot"><span class="annottext">parseBlockHeaderHash :: Text -&gt; Maybe b
</span><a href="#local-6989586621679483695"><span class="hs-identifier hs-var hs-var">parseBlockHeaderHash</span></a></span></span><span> </span><span id="local-6989586621679483688"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483688"><span class="hs-identifier hs-var">bhhStr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-638"></span><span>          </span><span id="local-6989586621679483687"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679483687"><span class="hs-identifier hs-var">bhhBs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; Maybe ByteString)
-&gt; (ByteString -&gt; Maybe ByteString)
-&gt; Either FilePath ByteString
-&gt; Maybe ByteString
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ByteString -&gt; FilePath -&gt; Maybe ByteString
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Either FilePath ByteString -&gt; Maybe ByteString)
-&gt; Either FilePath ByteString -&gt; Maybe ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Either FilePath ByteString
</span><a href="../../../../base16-bytestring/html/src"><span class="hs-identifier hs-var">Base16.decode</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Either FilePath ByteString)
-&gt; ByteString -&gt; Either FilePath ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">Text.encodeUtf8</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483688"><span class="hs-identifier hs-var">bhhStr</span></a></span><span>
</span><span id="line-639"></span><span>          </span><span class="annot"><span class="annottext">AsType b -&gt; ByteString -&gt; Maybe b
forall a.
SerialiseAsRawBytes a =&gt;
AsType a -&gt; ByteString -&gt; Maybe a
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.deserialiseFromRawBytes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy b -&gt; AsType b
forall t. HasTypeProxy t =&gt; Proxy t -&gt; AsType t
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.proxyToAsType</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy b
forall k (t :: k). Proxy t
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Proxy</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679483687"><span class="hs-identifier hs-var">bhhBs</span></a></span><span>
</span><span id="line-640"></span><span>     </span><span id="local-6989586621679483694"><span class="annot"><span class="annottext">parseBlockNo :: Text -&gt; Maybe BlockNo
</span><a href="#local-6989586621679483694"><span class="hs-identifier hs-var hs-var">parseBlockNo</span></a></span></span><span> </span><span id="local-6989586621679483682"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483682"><span class="hs-identifier hs-var">blockNoStr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; BlockNo
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">C.BlockNo</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; BlockNo) -&gt; Maybe Word64 -&gt; Maybe BlockNo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Maybe Word64
forall a. Read a =&gt; FilePath -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">readMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; FilePath
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">Text.unpack</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679483682"><span class="hs-identifier hs-var">blockNoStr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-641"></span><span>
</span><span id="line-642"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#open"><span class="hs-identifier hs-type">open</span></a></span><span>
</span><span id="line-643"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-type">O.TopLevelConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ouroboros-consensus-cardano/html/src"><span class="hs-identifier hs-type">O.CardanoBlock</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">O.StandardCrypto</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-644"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-645"></span><span>  </span><span class="hs-comment">-- ^ SQLite database file path</span><span>
</span><span id="line-646"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-647"></span><span>  </span><span class="hs-comment">-- ^ Directory from which we will save the various 'LedgerState' as different points in time.</span><span>
</span><span id="line-648"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Types.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span>
</span><span id="line-649"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-650"></span><span id="open"><span class="annot"><span class="annottext">open :: TopLevelConfig (CardanoBlock StandardCrypto)
-&gt; FilePath
-&gt; FilePath
-&gt; SecurityParam
-&gt; IO (State EpochStateHandle)
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#open"><span class="hs-identifier hs-var hs-var">open</span></a></span></span><span> </span><span id="local-6989586621679483681"><span class="annot"><span class="annottext">TopLevelConfig (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483681"><span class="hs-identifier hs-var">topLevelConfig</span></a></span></span><span> </span><span id="local-6989586621679483680"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483680"><span class="hs-identifier hs-var">dbPath</span></a></span></span><span> </span><span id="local-6989586621679483679"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483679"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span></span><span> </span><span id="local-6989586621679483678"><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679483678"><span class="hs-identifier hs-var">securityParam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-651"></span><span>    </span><span id="local-6989586621679483677"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483677"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO Connection
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.open</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483680"><span class="hs-identifier hs-var">dbPath</span></a></span><span>
</span><span id="line-652"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483677"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><span class="hs-string">&quot;PRAGMA journal_mode=WAL&quot;</span></span><span>
</span><span id="line-653"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483677"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-654"></span><span>        </span><span class="annot"><span class="">[r|CREATE TABLE IF NOT EXISTS epoch_sdd
            ( epochNo INT NOT NULL
            , poolId BLOB NOT NULL
            , lovelace INT NOT NULL
            , slotNo INT NOT NULL
            , blockHeaderHash BLOB NOT NULL
            , blockNo INT NOT NULL
            )|]</span></span><span>
</span><span id="line-662"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><a href="../../../../sqlite-simple/html/src"><span class="hs-identifier hs-var">SQL.execute_</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483677"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-663"></span><span>        </span><span class="annot"><span class="">[r|CREATE TABLE IF NOT EXISTS epoch_nonce
            ( epochNo INT NOT NULL
            , nonce BLOB NOT NULL
            , slotNo INT NOT NULL
            , blockHeaderHash BLOB NOT NULL
            , blockNo INT NOT NULL
            )|]</span></span><span>
</span><span id="line-670"></span><span>    </span><span class="annot"><span class="annottext">Int
-&gt; EpochStateHandle
-&gt; StorableMonad EpochStateHandle (State EpochStateHandle)
forall h.
PrimMonad (StorableMonad h) =&gt;
Int -&gt; h -&gt; StorableMonad h (State h)
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">emptyState</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig (CardanoBlock StandardCrypto)
-&gt; Connection -&gt; FilePath -&gt; SecurityParam -&gt; EpochStateHandle
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-var">EpochStateHandle</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig (CardanoBlock StandardCrypto)
</span><a href="#local-6989586621679483681"><span class="hs-identifier hs-var">topLevelConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679483677"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679483679"><span class="hs-identifier hs-var">ledgerStateDirPath</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679483678"><span class="hs-identifier hs-var">securityParam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-671"></span></pre></body></html>