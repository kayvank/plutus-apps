<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes   #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances     #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE GADTs                 #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns        #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings     #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables   #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TupleSections         #-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Marconi.ChainIndex.Indexers</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Cardano.Api</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Block</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">BlockHeader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">BlockHeader</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">BlockInMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">BlockInMode</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">CardanoMode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>                    </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">ChainPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">ChainPoint</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">ChainPointAtGenesis</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Hash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">ScriptData</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier">SlotNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Tx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Tx</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">chainPointToSlotNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Cardano.Api</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Cardano.Api.Shelley</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.BM.Setup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">withTrace</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.BM.Trace</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">logError</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.BM.Tracing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">defaultConfigStdout</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier">Cardano.Ledger.Alonzo.TxWitness</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Alonzo</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier">Cardano.Streaming</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier">ChainSyncEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier">RollBackward</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier">RollForward</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier">ChainSyncEventException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier">NoIntersectionFound</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>                          </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier">withChainSyncEventStream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Concurrent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">MVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">forkIO</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">modifyMVar_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">newMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">readMVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Concurrent.MVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">modifyMVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Concurrent.QSemN</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">QSemN</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">newQSemN</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">signalQSemN</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">waitQSemN</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../stm/html/src"><span class="hs-identifier">Control.Concurrent.STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">atomically</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../stm/html/src"><span class="hs-identifier">Control.Concurrent.STM.TChan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../stm/html/src"><span class="hs-identifier">TChan</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../stm/html/src"><span class="hs-identifier">dupTChan</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../stm/html/src"><span class="hs-identifier">newBroadcastTChanIO</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../stm/html/src"><span class="hs-identifier">readTChan</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../stm/html/src"><span class="hs-identifier">writeTChan</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">catch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">Control.Lens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">view</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">Control.Lens.Operators</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-operator">(^.)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">forever</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">Control.Monad.Trans.Except</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">runExceptT</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">findIndex</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">foldl1'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">intersect</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">fromMaybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">mapMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TS</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.AddressDatum.html"><span class="hs-identifier">Marconi.ChainIndex.Indexers.AddressDatum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.AddressDatum.html#AddressDatumDepth"><span class="hs-identifier">AddressDatumDepth</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.AddressDatum.html#AddressDatumDepth"><span class="hs-identifier">AddressDatumDepth</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.AddressDatum.html#AddressDatumHandle"><span class="hs-identifier">AddressDatumHandle</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>                                                 </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.AddressDatum.html#AddressDatumIndex"><span class="hs-identifier">AddressDatumIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.AddressDatum.html"><span class="hs-identifier">Marconi.ChainIndex.Indexers.AddressDatum</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AddressDatum</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.Datum.html"><span class="hs-identifier">Marconi.ChainIndex.Indexers.Datum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.Datum.html#DatumIndex"><span class="hs-identifier">DatumIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.Datum.html"><span class="hs-identifier">Marconi.ChainIndex.Indexers.Datum</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Datum</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html"><span class="hs-identifier">Marconi.ChainIndex.Indexers.EpochState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier">EpochStateHandle</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateIndex"><span class="hs-identifier">EpochStateIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html"><span class="hs-identifier">Marconi.ChainIndex.Indexers.EpochState</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EpochState</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.MintBurn.html"><span class="hs-identifier">Marconi.ChainIndex.Indexers.MintBurn</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MintBurn</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html"><span class="hs-identifier">Marconi.ChainIndex.Indexers.ScriptTx</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ScriptTx</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.Utxo.html"><span class="hs-identifier">Marconi.ChainIndex.Indexers.Utxo</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Utxo</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Logging.html"><span class="hs-identifier">Marconi.ChainIndex.Logging</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Logging.html#logging"><span class="hs-identifier">logging</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Node.Client.GenesisConfig.html"><span class="hs-identifier">Marconi.ChainIndex.Node.Client.GenesisConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Node.Client.GenesisConfig.html#NetworkConfigFile"><span class="hs-identifier">NetworkConfigFile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Node.Client.GenesisConfig.html#NetworkConfigFile"><span class="hs-identifier">NetworkConfigFile</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Node.Client.GenesisConfig.html#initExtLedgerStateVar"><span class="hs-identifier">initExtLedgerStateVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>                                                     </span><span class="annot"><a href="Marconi.ChainIndex.Node.Client.GenesisConfig.html#mkProtocolInfoCardano"><span class="hs-identifier">mkProtocolInfoCardano</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Node.Client.GenesisConfig.html#readCardanoGenesisConfig"><span class="hs-identifier">readCardanoGenesisConfig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Node.Client.GenesisConfig.html#readNetworkConfig"><span class="hs-identifier">readNetworkConfig</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>                                                     </span><span class="annot"><a href="Marconi.ChainIndex.Node.Client.GenesisConfig.html#renderGenesisConfigError"><span class="hs-identifier">renderGenesisConfigError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Types.html"><span class="hs-identifier">Marconi.ChainIndex.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Types.html#SecurityParam"><span class="hs-identifier">SecurityParam</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Types.html#TargetAddresses"><span class="hs-identifier">TargetAddresses</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Utils.html"><span class="hs-identifier">Marconi.ChainIndex.Utils</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><a href="../../../../scientific/html/src"><span class="hs-identifier">Utils</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Marconi.Core.Index.VSplit</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ix</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Marconi.Core.Storable</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Storable</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Abstract</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">O</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">O</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier">Ouroboros.Consensus.Node</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">O</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../prettyprinter/html/src"><span class="hs-identifier">Prettyprinter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../prettyprinter/html/src"><span class="hs-identifier">defaultLayoutOptions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../prettyprinter/html/src"><span class="hs-identifier">layoutPretty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../prettyprinter/html/src"><span class="hs-identifier">pretty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../prettyprinter/html/src"><span class="hs-operator">(&lt;+&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../prettyprinter/html/src"><span class="hs-identifier">Prettyprinter.Render.Text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../prettyprinter/html/src"><span class="hs-identifier">renderStrict</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../streaming/html/src"><span class="hs-identifier">Streaming.Prelude</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../directory/html/src"><span class="hs-identifier">System.Directory</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../directory/html/src"><span class="hs-identifier">createDirectoryIfMissing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../filepath/html/src"><span class="hs-identifier">System.FilePath</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../filepath/html/src"><span class="hs-identifier">takeDirectory</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../filepath/html/src"><span class="hs-operator">(&lt;/&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-comment">-- DatumIndexer</span><span>
</span><span id="line-65"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#getDatums"><span class="hs-identifier hs-type">getDatums</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">CardanoMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">SlotNo</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Hash</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ScriptData</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ScriptData</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-66"></span><span id="getDatums"><span class="annot"><span class="annottext">getDatums :: BlockInMode CardanoMode
-&gt; [(SlotNo, (Hash ScriptData, ScriptData))]
</span><a href="Marconi.ChainIndex.Indexers.html#getDatums"><span class="hs-identifier hs-var hs-var">getDatums</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span> </span><span id="local-6989586621679484726"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484726"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679484725"><span class="annot"><span class="annottext">[Tx era]
</span><a href="#local-6989586621679484725"><span class="hs-identifier hs-var">txs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EraInMode era CardanoMode
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Tx era -&gt; [(SlotNo, (Hash ScriptData, ScriptData))])
-&gt; [Tx era] -&gt; [(SlotNo, (Hash ScriptData, ScriptData))]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">concatMap</span></a></span><span> </span><span class="annot"><span class="annottext">Tx era -&gt; [(SlotNo, (Hash ScriptData, ScriptData))]
forall era. Tx era -&gt; [(SlotNo, (Hash ScriptData, ScriptData))]
</span><a href="#local-6989586621679484723"><span class="hs-identifier hs-var">extractDatumsFromTx</span></a></span><span> </span><span class="annot"><span class="annottext">[Tx era]
</span><a href="#local-6989586621679484725"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-68"></span><span>        </span><span id="local-6989586621679485051"><span class="annot"><a href="#local-6989586621679484723"><span class="hs-identifier hs-type">extractDatumsFromTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679485051"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">SlotNo</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Hash</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ScriptData</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ScriptData</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-69"></span><span>        </span><span id="local-6989586621679484723"><span class="annot"><span class="annottext">extractDatumsFromTx :: Tx era -&gt; [(SlotNo, (Hash ScriptData, ScriptData))]
</span><a href="#local-6989586621679484723"><span class="hs-identifier hs-var hs-var">extractDatumsFromTx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Tx</span></a></span><span> </span><span id="local-6989586621679484722"><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679484722"><span class="hs-identifier hs-var">txBody</span></a></span></span><span> </span><span class="annot"><span class="annottext">[KeyWitness era]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-70"></span><span>            </span><span class="annot"><span class="annottext">((Hash ScriptData, ScriptData)
 -&gt; (SlotNo, (Hash ScriptData, ScriptData)))
-&gt; [(Hash ScriptData, ScriptData)]
-&gt; [(SlotNo, (Hash ScriptData, ScriptData))]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484726"><span class="hs-identifier hs-var">slotNo</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>            </span><span class="annot"><span class="annottext">([(Hash ScriptData, ScriptData)]
 -&gt; [(SlotNo, (Hash ScriptData, ScriptData))])
-&gt; (TxBody era -&gt; [(Hash ScriptData, ScriptData)])
-&gt; TxBody era
-&gt; [(SlotNo, (Hash ScriptData, ScriptData))]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Hash ScriptData) ScriptData -&gt; [(Hash ScriptData, ScriptData)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.assocs</span></a></span><span>
</span><span id="line-72"></span><span>            </span><span class="annot"><span class="annottext">(Map (Hash ScriptData) ScriptData
 -&gt; [(Hash ScriptData, ScriptData)])
-&gt; (TxBody era -&gt; Map (Hash ScriptData) ScriptData)
-&gt; TxBody era
-&gt; [(Hash ScriptData, ScriptData)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TxBody era -&gt; Map (Hash ScriptData) ScriptData
forall era. TxBody era -&gt; Map (Hash ScriptData) ScriptData
</span><a href="Marconi.ChainIndex.Indexers.html#scriptDataFromCardanoTxBody"><span class="hs-identifier hs-var">scriptDataFromCardanoTxBody</span></a></span><span>
</span><span id="line-73"></span><span>            </span><span class="annot"><span class="annottext">(TxBody era -&gt; [(SlotNo, (Hash ScriptData, ScriptData))])
-&gt; TxBody era -&gt; [(SlotNo, (Hash ScriptData, ScriptData))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679484722"><span class="hs-identifier hs-var">txBody</span></a></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span id="local-6989586621679485038"><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#scriptDataFromCardanoTxBody"><span class="hs-identifier hs-type">scriptDataFromCardanoTxBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679485038"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Hash</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ScriptData</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ScriptData</span></a></span></span><span>
</span><span id="line-76"></span><span id="scriptDataFromCardanoTxBody"><span class="annot"><span class="annottext">scriptDataFromCardanoTxBody :: TxBody era -&gt; Map (Hash ScriptData) ScriptData
</span><a href="Marconi.ChainIndex.Indexers.html#scriptDataFromCardanoTxBody"><span class="hs-identifier hs-var hs-var">scriptDataFromCardanoTxBody</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ShelleyTxBody</span></a></span><span> </span><span class="annot"><span class="annottext">ShelleyBasedEra era
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TxBody (ShelleyLedgerEra era)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Script (ShelleyLedgerEra era)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.TxBodyScriptData</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptDataSupportedInEra era
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679484716"><span class="annot"><span class="annottext">TxDats (ShelleyLedgerEra era)
</span><a href="#local-6989586621679484716"><span class="hs-identifier hs-var">dats</span></a></span></span><span> </span><span class="annot"><span class="annottext">Redeemers (ShelleyLedgerEra era)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (AuxiliaryData (ShelleyLedgerEra era))
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TxScriptValidity era
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-77"></span><span>    </span><span class="annot"><span class="annottext">TxDats (ShelleyLedgerEra era) -&gt; Map (Hash ScriptData) ScriptData
forall era. TxDats era -&gt; Map (Hash ScriptData) ScriptData
</span><a href="#local-6989586621679484715"><span class="hs-identifier hs-var">extractData</span></a></span><span> </span><span class="annot"><span class="annottext">TxDats (ShelleyLedgerEra era)
</span><a href="#local-6989586621679484716"><span class="hs-identifier hs-var">dats</span></a></span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-79"></span><span>    </span><span id="local-6989586621679485023"><span class="annot"><a href="#local-6989586621679484715"><span class="hs-identifier hs-type">extractData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier hs-type">Alonzo.TxDats</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679485023"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Hash</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ScriptData</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ScriptData</span></a></span></span><span>
</span><span id="line-80"></span><span>    </span><span id="local-6989586621679484715"><span class="annot"><span class="annottext">extractData :: TxDats era -&gt; Map (Hash ScriptData) ScriptData
</span><a href="#local-6989586621679484715"><span class="hs-identifier hs-var hs-var">extractData</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-alonzo/html/src"><span class="hs-identifier hs-type">Alonzo.TxDats'</span></a></span><span> </span><span id="local-6989586621679484713"><span class="annot"><span class="annottext">Map (DataHash (Crypto era)) (Data era)
</span><a href="#local-6989586621679484713"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-81"></span><span>      </span><span class="annot"><span class="annottext">[(Hash ScriptData, ScriptData)] -&gt; Map (Hash ScriptData) ScriptData
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span>
</span><span id="line-82"></span><span>      </span><span class="annot"><span class="annottext">([(Hash ScriptData, ScriptData)]
 -&gt; Map (Hash ScriptData) ScriptData)
-&gt; (Map (DataHash (Crypto era)) (Data era)
    -&gt; [(Hash ScriptData, ScriptData)])
-&gt; Map (DataHash (Crypto era)) (Data era)
-&gt; Map (Hash ScriptData) ScriptData
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Data era -&gt; (Hash ScriptData, ScriptData))
-&gt; [Data era] -&gt; [(Hash ScriptData, ScriptData)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679484711"><span class="annot"><span class="annottext">ScriptData
</span><a href="#local-6989586621679484711"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScriptData -&gt; Hash ScriptData
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.hashScriptData</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptData
</span><a href="#local-6989586621679484711"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ScriptData
</span><a href="#local-6989586621679484711"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ScriptData -&gt; (Hash ScriptData, ScriptData))
-&gt; (Data era -&gt; ScriptData)
-&gt; Data era
-&gt; (Hash ScriptData, ScriptData)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Data era -&gt; ScriptData
forall ledgerera. Data ledgerera -&gt; ScriptData
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.fromAlonzoData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>      </span><span class="annot"><span class="annottext">([Data era] -&gt; [(Hash ScriptData, ScriptData)])
-&gt; (Map (DataHash (Crypto era)) (Data era) -&gt; [Data era])
-&gt; Map (DataHash (Crypto era)) (Data era)
-&gt; [(Hash ScriptData, ScriptData)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map (DataHash (Crypto era)) (Data era) -&gt; [Data era]
forall k a. Map k a -&gt; [a]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.elems</span></a></span><span>
</span><span id="line-84"></span><span>      </span><span class="annot"><span class="annottext">(Map (DataHash (Crypto era)) (Data era)
 -&gt; Map (Hash ScriptData) ScriptData)
-&gt; Map (DataHash (Crypto era)) (Data era)
-&gt; Map (Hash ScriptData) ScriptData
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map (DataHash (Crypto era)) (Data era)
</span><a href="#local-6989586621679484713"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-85"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#scriptDataFromCardanoTxBody"><span class="hs-identifier hs-var">scriptDataFromCardanoTxBody</span></a></span><span> </span><span class="annot"><span class="annottext">TxBody era
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Hash ScriptData) ScriptData
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-comment">{- | The way we synchronise channel consumption is by waiting on a QSemN for each
     of the spawn indexers to finish processing the current event.

     The channel is used to transmit the next event to the listening indexers. Note
     that even if the channel is unbound it will actually only ever hold one event
     because it will be blocked until the processing of the event finishes on all
     indexers.

     The indexer count is where we save the number of running indexers so we know for
     how many we are waiting.
-}</span><span>
</span><span id="line-98"></span><span class="hs-keyword">data</span><span> </span><span id="Coordinator"><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-var">Coordinator</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Coordinator"><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-var">Coordinator</span></a></span></span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_channel"><span class="annot"><span class="annottext">Coordinator -&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="Marconi.ChainIndex.Indexers.html#_channel"><span class="hs-identifier hs-var hs-var">_channel</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../stm/html/src"><span class="hs-identifier hs-type">TChan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">ChainSyncEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">CardanoMode</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_barrier"><span class="annot"><span class="annottext">Coordinator -&gt; QSemN
</span><a href="Marconi.ChainIndex.Indexers.html#_barrier"><span class="hs-identifier hs-var hs-var">_barrier</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">QSemN</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_indexerCount"><span class="annot"><span class="annottext">Coordinator -&gt; Int
</span><a href="Marconi.ChainIndex.Indexers.html#_indexerCount"><span class="hs-identifier hs-var hs-var">_indexerCount</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#initialCoordinator"><span class="hs-identifier hs-type">initialCoordinator</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span>
</span><span id="line-105"></span><span id="initialCoordinator"><span class="annot"><span class="annottext">initialCoordinator :: Int -&gt; IO Coordinator
</span><a href="Marconi.ChainIndex.Indexers.html#initialCoordinator"><span class="hs-identifier hs-var hs-var">initialCoordinator</span></a></span></span><span> </span><span id="local-6989586621679484702"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679484702"><span class="hs-identifier hs-var">indexerCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-106"></span><span>  </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; QSemN -&gt; Int -&gt; Coordinator
</span><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-var">Coordinator</span></a></span><span> </span><span class="annot"><span class="annottext">(TChan (ChainSyncEvent (BlockInMode CardanoMode))
 -&gt; QSemN -&gt; Int -&gt; Coordinator)
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; IO (QSemN -&gt; Int -&gt; Coordinator)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a. IO (TChan a)
</span><a href="../../../../stm/html/src"><span class="hs-identifier hs-var">newBroadcastTChanIO</span></a></span><span>
</span><span id="line-107"></span><span>              </span><span class="annot"><span class="annottext">IO (QSemN -&gt; Int -&gt; Coordinator)
-&gt; IO QSemN -&gt; IO (Int -&gt; Coordinator)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO QSemN
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">newQSemN</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-108"></span><span>              </span><span class="annot"><span class="annottext">IO (Int -&gt; Coordinator) -&gt; IO Int -&gt; IO Coordinator
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO Int
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679484702"><span class="hs-identifier hs-var">indexerCount</span></a></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span class="hs-comment">-- The points should/could provide shared access to the indexers themselves. The result</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- is a list of points (rather than just one) since it offers more resume possibilities</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- to the node (in the unlikely case there were some rollbacks during downtime).</span><span>
</span><span id="line-113"></span><span class="hs-keyword">type</span><span> </span><span id="Worker"><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Worker"><span class="hs-identifier hs-var">Worker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Types.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Storable.StorablePoint</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTx.ScriptTxHandle</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#datumWorker"><span class="hs-identifier hs-type">datumWorker</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Worker"><span class="hs-identifier hs-type">Worker</span></a></span><span>
</span><span id="line-116"></span><span id="datumWorker"><span class="annot"><span class="annottext">datumWorker :: Worker
</span><a href="Marconi.ChainIndex.Indexers.html#datumWorker"><span class="hs-identifier hs-var hs-var">datumWorker</span></a></span></span><span> </span><span id="local-6989586621679484699"><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484699"><span class="hs-identifier hs-var">securityParam</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span class="hs-special">{</span><span id="local-6989586621679484698"><span class="annot"><span class="annottext">QSemN
_barrier :: QSemN
_barrier :: Coordinator -&gt; QSemN
</span><a href="#local-6989586621679484698"><span class="hs-identifier hs-var hs-var">_barrier</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679484697"><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
_channel :: TChan (ChainSyncEvent (BlockInMode CardanoMode))
_channel :: Coordinator -&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484697"><span class="hs-identifier hs-var hs-var">_channel</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679484696"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484696"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-117"></span><span>  </span><span id="local-6989586621679484695"><span class="annot"><span class="annottext">DatumIndex
</span><a href="#local-6989586621679484695"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Depth -&gt; IO DatumIndex
</span><a href="Marconi.ChainIndex.Indexers.Datum.html#open"><span class="hs-identifier hs-var">Datum.open</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484696"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Depth
</span><a href="Marconi.ChainIndex.Indexers.Datum.html#Depth"><span class="hs-identifier hs-var">Datum.Depth</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Depth) -&gt; Int -&gt; Depth
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484699"><span class="hs-identifier hs-var">securityParam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>  </span><span id="local-6989586621679484692"><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484692"><span class="hs-identifier hs-var">workerChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
 -&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; (TChan (ChainSyncEvent (BlockInMode CardanoMode))
    -&gt; STM (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a. TChan a -&gt; STM (TChan a)
</span><a href="../../../../stm/html/src"><span class="hs-identifier hs-var">dupTChan</span></a></span><span> </span><span class="annot"><span class="annottext">(TChan (ChainSyncEvent (BlockInMode CardanoMode))
 -&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484697"><span class="hs-identifier hs-var">_channel</span></a></span><span>
</span><span id="line-119"></span><span>  </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; (IO () -&gt; IO ThreadId) -&gt; IO () -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forkIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; DatumIndex -&gt; IO ()
</span><a href="#local-6989586621679484691"><span class="hs-identifier hs-var">innerLoop</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484692"><span class="hs-identifier hs-var">workerChannel</span></a></span><span> </span><span class="annot"><span class="annottext">DatumIndex
</span><a href="#local-6989586621679484695"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-120"></span><span>  </span><span class="annot"><span class="annottext">[ChainPoint] -&gt; IO [ChainPoint]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ChainPoint
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">ChainPointAtGenesis</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-122"></span><span>    </span><span class="annot"><a href="#local-6989586621679484691"><span class="hs-identifier hs-type">innerLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../stm/html/src"><span class="hs-identifier hs-type">TChan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">ChainSyncEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">CardanoMode</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.Datum.html#DatumIndex"><span class="hs-identifier hs-type">DatumIndex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span>    </span><span id="local-6989586621679484691"><span class="annot"><span class="annottext">innerLoop :: TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; DatumIndex -&gt; IO ()
</span><a href="#local-6989586621679484691"><span class="hs-identifier hs-var hs-var">innerLoop</span></a></span></span><span> </span><span id="local-6989586621679484690"><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484690"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span id="local-6989586621679484689"><span class="annot"><span class="annottext">DatumIndex
</span><a href="#local-6989586621679484689"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-124"></span><span>      </span><span class="annot"><span class="annottext">QSemN -&gt; Int -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">signalQSemN</span></a></span><span> </span><span class="annot"><span class="annottext">QSemN
</span><a href="#local-6989586621679484698"><span class="hs-identifier hs-var">_barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-125"></span><span>      </span><span id="local-6989586621679484688"><span class="annot"><span class="annottext">ChainSyncEvent (BlockInMode CardanoMode)
</span><a href="#local-6989586621679484688"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (ChainSyncEvent (BlockInMode CardanoMode))
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (ChainSyncEvent (BlockInMode CardanoMode))
 -&gt; IO (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; STM (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (ChainSyncEvent (BlockInMode CardanoMode))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; STM (ChainSyncEvent (BlockInMode CardanoMode))
forall a. TChan a -&gt; STM a
</span><a href="../../../../stm/html/src"><span class="hs-identifier hs-var">readTChan</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484690"><span class="hs-identifier hs-var">ch</span></a></span><span>
</span><span id="line-126"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainSyncEvent (BlockInMode CardanoMode)
</span><a href="#local-6989586621679484688"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-127"></span><span>        </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">RollForward</span></a></span><span> </span><span id="local-6989586621679484687"><span class="annot"><span class="annottext">BlockInMode CardanoMode
</span><a href="#local-6989586621679484687"><span class="hs-identifier hs-var">blk</span></a></span></span><span> </span><span id="local-6989586621679484686"><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484686"><span class="hs-identifier hs-var">_ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-128"></span><span>          </span><span class="annot"><span class="annottext">[(SlotNo, (Hash ScriptData, ScriptData))]
-&gt; DatumIndex -&gt; IO DatumIndex
forall (m :: * -&gt; *) h (v :: * -&gt; *) e n q r.
(Monad m, PrimMonad m, MVector (Mutable v) e) =&gt;
e -&gt; SplitIndex m h v e n q r -&gt; m (SplitIndex m h v e n q r)
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Ix.insert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockInMode CardanoMode
-&gt; [(SlotNo, (Hash ScriptData, ScriptData))]
</span><a href="Marconi.ChainIndex.Indexers.html#getDatums"><span class="hs-identifier hs-var">getDatums</span></a></span><span> </span><span class="annot"><span class="annottext">BlockInMode CardanoMode
</span><a href="#local-6989586621679484687"><span class="hs-identifier hs-var">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DatumIndex
</span><a href="#local-6989586621679484689"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">IO DatumIndex -&gt; (DatumIndex -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; DatumIndex -&gt; IO ()
</span><a href="#local-6989586621679484691"><span class="hs-identifier hs-var">innerLoop</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484690"><span class="hs-identifier hs-var">ch</span></a></span><span>
</span><span id="line-129"></span><span>        </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">RollBackward</span></a></span><span> </span><span id="local-6989586621679484684"><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679484684"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span id="local-6989586621679484683"><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484683"><span class="hs-identifier hs-var">_ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>          </span><span id="local-6989586621679484682"><span class="annot"><span class="annottext">[[(SlotNo, (Hash ScriptData, ScriptData))]]
</span><a href="#local-6989586621679484682"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Storage Vector IO [(SlotNo, (Hash ScriptData, ScriptData))]
-&gt; IO [[(SlotNo, (Hash ScriptData, ScriptData))]]
forall (v :: * -&gt; *) (m :: * -&gt; *) e.
(MVector (Mutable v) e, PrimMonad m, Show e) =&gt;
Storage v m e -&gt; m [e]
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Ix.getEvents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DatumIndex
</span><a href="#local-6989586621679484689"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">DatumIndex
-&gt; Getting
     (Storage Vector IO [(SlotNo, (Hash ScriptData, ScriptData))])
     DatumIndex
     (Storage Vector IO [(SlotNo, (Hash ScriptData, ScriptData))])
-&gt; Storage Vector IO [(SlotNo, (Hash ScriptData, ScriptData))]
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting
  (Storage Vector IO [(SlotNo, (Hash ScriptData, ScriptData))])
  DatumIndex
  (Storage Vector IO [(SlotNo, (Hash ScriptData, ScriptData))])
forall (m :: * -&gt; *) h (v :: * -&gt; *) e n q r.
Lens' (SplitIndex m h v e n q r) (Storage v m e)
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Ix.storage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>          </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; DatumIndex -&gt; IO ()
</span><a href="#local-6989586621679484691"><span class="hs-identifier hs-var">innerLoop</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484690"><span class="hs-identifier hs-var">ch</span></a></span><span> </span><span class="annot"><span class="annottext">(DatumIndex -&gt; IO ()) -&gt; DatumIndex -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-132"></span><span>            </span><span class="annot"><span class="annottext">DatumIndex -&gt; Maybe DatumIndex -&gt; DatumIndex
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">DatumIndex
</span><a href="#local-6989586621679484689"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe DatumIndex -&gt; DatumIndex) -&gt; Maybe DatumIndex -&gt; DatumIndex
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>              </span><span id="local-6989586621679484679"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484679"><span class="hs-identifier hs-var">slot</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChainPoint -&gt; Maybe SlotNo
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">chainPointToSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679484684"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-134"></span><span>              </span><span id="local-6989586621679484678"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679484678"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([(SlotNo, (Hash ScriptData, ScriptData))] -&gt; Bool)
-&gt; [[(SlotNo, (Hash ScriptData, ScriptData))]] -&gt; Maybe Int
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Maybe Int
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">findIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((SlotNo, (Hash ScriptData, ScriptData)) -&gt; Bool)
-&gt; [(SlotNo, (Hash ScriptData, ScriptData))] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">any</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679484676"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484676"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Hash ScriptData, ScriptData)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484676"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484679"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[[(SlotNo, (Hash ScriptData, ScriptData))]]
</span><a href="#local-6989586621679484682"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-135"></span><span>              </span><span class="annot"><span class="annottext">Int -&gt; DatumIndex -&gt; Maybe DatumIndex
forall (v :: * -&gt; *) e (m :: * -&gt; *) h n q r.
MVector (Mutable v) e =&gt;
Int -&gt; SplitIndex m h v e n q r -&gt; Maybe (SplitIndex m h v e n q r)
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Ix.rewind</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679484678"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">DatumIndex
</span><a href="#local-6989586621679484689"><span class="hs-identifier hs-var">index</span></a></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#utxoWorker_"><span class="hs-identifier hs-type">utxoWorker_</span></a></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.Utxo.html#UtxoIndexer"><span class="hs-identifier hs-type">Utxo.UtxoIndexer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ callback function used in the queryApi thread, needs to be non-blocking</span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.Utxo.html#Depth"><span class="hs-identifier hs-type">Utxo.Depth</span></a></span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Types.html#TargetAddresses"><span class="hs-identifier hs-type">TargetAddresses</span></a></span><span>        </span><span class="hs-comment">-- ^ Target addresses to filter for</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../stm/html/src"><span class="hs-identifier hs-type">TChan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">ChainSyncEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">CardanoMode</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.Utxo.html#UtxoIndexer"><span class="hs-identifier hs-type">Utxo.UtxoIndexer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span id="utxoWorker_"><span class="annot"><span class="annottext">utxoWorker_ :: (UtxoIndexer -&gt; IO ())
-&gt; Depth
-&gt; Maybe TargetAddresses
-&gt; Coordinator
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; FilePath
-&gt; IO (IO (), MVar UtxoIndexer)
</span><a href="Marconi.ChainIndex.Indexers.html#utxoWorker_"><span class="hs-identifier hs-var hs-var">utxoWorker_</span></a></span></span><span> </span><span id="local-6989586621679484672"><span class="annot"><span class="annottext">UtxoIndexer -&gt; IO ()
</span><a href="#local-6989586621679484672"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span id="local-6989586621679484671"><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621679484671"><span class="hs-identifier hs-var">depth</span></a></span></span><span> </span><span id="local-6989586621679484670"><span class="annot"><span class="annottext">Maybe TargetAddresses
</span><a href="#local-6989586621679484670"><span class="hs-identifier hs-var">maybeTargetAddresses</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span class="hs-special">{</span><span id="local-6989586621679484669"><span class="annot"><span class="annottext">QSemN
_barrier :: QSemN
_barrier :: Coordinator -&gt; QSemN
</span><a href="#local-6989586621679484669"><span class="hs-identifier hs-var hs-var">_barrier</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679484668"><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484668"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span id="local-6989586621679484667"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484667"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-146"></span><span>  </span><span id="local-6989586621679484666"><span class="annot"><span class="annottext">UtxoIndexer
</span><a href="#local-6989586621679484666"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Depth -&gt; Bool -&gt; IO UtxoIndexer
</span><a href="Marconi.ChainIndex.Indexers.Utxo.html#open"><span class="hs-identifier hs-var">Utxo.open</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484667"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621679484671"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="hs-comment">-- open SQLite with depth=depth and DO NOT perform SQLite vacuum</span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-comment">-- TODO consider adding a CLI param to allow user to perfomr Vaccum or not.</span><span>
</span><span id="line-148"></span><span>  </span><span id="local-6989586621679484664"><span class="annot"><span class="annottext">MVar UtxoIndexer
</span><a href="#local-6989586621679484664"><span class="hs-identifier hs-var">mIndexer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UtxoIndexer -&gt; IO (MVar UtxoIndexer)
forall a. a -&gt; IO (MVar a)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">newMVar</span></a></span><span> </span><span class="annot"><span class="annottext">UtxoIndexer
</span><a href="#local-6989586621679484666"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-149"></span><span>  </span><span class="annot"><span class="annottext">(IO (), MVar UtxoIndexer) -&gt; IO (IO (), MVar UtxoIndexer)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar UtxoIndexer -&gt; IO ()
</span><a href="#local-6989586621679484663"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">MVar UtxoIndexer
</span><a href="#local-6989586621679484664"><span class="hs-identifier hs-var">mIndexer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MVar UtxoIndexer
</span><a href="#local-6989586621679484664"><span class="hs-identifier hs-var">mIndexer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><a href="#local-6989586621679484663"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.Utxo.html#UtxoIndexer"><span class="hs-identifier hs-type">Utxo.UtxoIndexer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>    </span><span id="local-6989586621679484663"><span class="annot"><span class="annottext">loop :: MVar UtxoIndexer -&gt; IO ()
</span><a href="#local-6989586621679484663"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621679484662"><span class="annot"><span class="annottext">MVar UtxoIndexer
</span><a href="#local-6989586621679484662"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-153"></span><span>      </span><span class="annot"><span class="annottext">QSemN -&gt; Int -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">signalQSemN</span></a></span><span> </span><span class="annot"><span class="annottext">QSemN
</span><a href="#local-6989586621679484669"><span class="hs-identifier hs-var">_barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-154"></span><span>      </span><span class="annot"><span class="annottext">MVar UtxoIndexer -&gt; IO UtxoIndexer
forall a. MVar a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">readMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar UtxoIndexer
</span><a href="#local-6989586621679484662"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">IO UtxoIndexer -&gt; (UtxoIndexer -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">UtxoIndexer -&gt; IO ()
</span><a href="#local-6989586621679484672"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="hs-comment">-- refresh the query STM/CPS with new storage pointers/counters state</span><span>
</span><span id="line-155"></span><span>      </span><span id="local-6989586621679484661"><span class="annot"><span class="annottext">ChainSyncEvent (BlockInMode CardanoMode)
</span><a href="#local-6989586621679484661"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (ChainSyncEvent (BlockInMode CardanoMode))
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (ChainSyncEvent (BlockInMode CardanoMode))
 -&gt; IO (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; (TChan (ChainSyncEvent (BlockInMode CardanoMode))
    -&gt; STM (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (ChainSyncEvent (BlockInMode CardanoMode))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; STM (ChainSyncEvent (BlockInMode CardanoMode))
forall a. TChan a -&gt; STM a
</span><a href="../../../../stm/html/src"><span class="hs-identifier hs-var">readTChan</span></a></span><span> </span><span class="annot"><span class="annottext">(TChan (ChainSyncEvent (BlockInMode CardanoMode))
 -&gt; IO (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (ChainSyncEvent (BlockInMode CardanoMode))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484668"><span class="hs-identifier hs-var">ch</span></a></span><span>
</span><span id="line-156"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainSyncEvent (BlockInMode CardanoMode)
</span><a href="#local-6989586621679484661"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-157"></span><span>        </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">RollForward</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span id="local-6989586621679484660"><span class="annot"><span class="annottext">Block era
</span><a href="#local-6989586621679484660"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="annot"><span class="annottext">EraInMode era CardanoMode
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679484659"><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484659"><span class="hs-identifier hs-var">_ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-158"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679484658"><span class="annot"><span class="annottext">utxoEvents :: StorableEvent UtxoHandle
</span><a href="#local-6989586621679484658"><span class="hs-identifier hs-var hs-var">utxoEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe TargetAddresses -&gt; Block era -&gt; StorableEvent UtxoHandle
forall era.
IsCardanoEra era =&gt;
Maybe TargetAddresses -&gt; Block era -&gt; StorableEvent UtxoHandle
</span><a href="Marconi.ChainIndex.Indexers.Utxo.html#getUtxoEventsFromBlock"><span class="hs-identifier hs-var">Utxo.getUtxoEventsFromBlock</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TargetAddresses
</span><a href="#local-6989586621679484670"><span class="hs-identifier hs-var">maybeTargetAddresses</span></a></span><span> </span><span class="annot"><span class="annottext">Block era
</span><a href="#local-6989586621679484660"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-159"></span><span>            </span><span class="annot"><span class="annottext">MVar UtxoIndexer -&gt; (UtxoIndexer -&gt; IO UtxoIndexer) -&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar UtxoIndexer
</span><a href="#local-6989586621679484662"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StorableEvent UtxoHandle
-&gt; UtxoIndexer -&gt; StorableMonad UtxoHandle UtxoIndexer
forall h.
(Buffered h, PrimMonad (StorableMonad h)) =&gt;
StorableEvent h -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.insert</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent UtxoHandle
</span><a href="#local-6989586621679484658"><span class="hs-identifier hs-var">utxoEvents</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>            </span><span class="annot"><span class="annottext">MVar UtxoIndexer -&gt; IO ()
</span><a href="#local-6989586621679484663"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">MVar UtxoIndexer
</span><a href="#local-6989586621679484662"><span class="hs-identifier hs-var">index</span></a></span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span>        </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">RollBackward</span></a></span><span> </span><span id="local-6989586621679484655"><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679484655"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span id="local-6989586621679484654"><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484654"><span class="hs-identifier hs-var">_ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-163"></span><span>          </span><span class="annot"><span class="annottext">MVar UtxoIndexer -&gt; (UtxoIndexer -&gt; IO UtxoIndexer) -&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar UtxoIndexer
</span><a href="#local-6989586621679484662"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">((UtxoIndexer -&gt; IO UtxoIndexer) -&gt; IO ())
-&gt; (UtxoIndexer -&gt; IO UtxoIndexer) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679484653"><span class="annot"><span class="annottext">UtxoIndexer
</span><a href="#local-6989586621679484653"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UtxoIndexer -&gt; Maybe UtxoIndexer -&gt; UtxoIndexer
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">UtxoIndexer
</span><a href="#local-6989586621679484653"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe UtxoIndexer -&gt; UtxoIndexer)
-&gt; IO (Maybe UtxoIndexer) -&gt; IO UtxoIndexer
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint UtxoHandle
-&gt; UtxoIndexer -&gt; StorableMonad UtxoHandle (Maybe UtxoIndexer)
forall h.
(Rewindable h, HasPoint (StorableEvent h) (StorablePoint h),
 PrimMonad (StorableMonad h), Ord (StorablePoint h)) =&gt;
StorablePoint h -&gt; State h -&gt; StorableMonad h (Maybe (State h))
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.rewind</span></a></span><span> </span><span class="annot"><span class="annottext">ChainPoint
StorablePoint UtxoHandle
</span><a href="#local-6989586621679484655"><span class="hs-identifier hs-var">cp</span></a></span><span> </span><span class="annot"><span class="annottext">UtxoIndexer
</span><a href="#local-6989586621679484653"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-164"></span><span>          </span><span class="annot"><span class="annottext">MVar UtxoIndexer -&gt; IO ()
</span><a href="#local-6989586621679484663"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">MVar UtxoIndexer
</span><a href="#local-6989586621679484662"><span class="hs-identifier hs-var">index</span></a></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#utxoWorker"><span class="hs-identifier hs-type">utxoWorker</span></a></span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.Utxo.html#UtxoIndexer"><span class="hs-identifier hs-type">Utxo.UtxoIndexer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ callback function used in the queryApi thread</span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Types.html#TargetAddresses"><span class="hs-identifier hs-type">TargetAddresses</span></a></span><span>        </span><span class="hs-comment">-- ^ Target addresses to filter for</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Worker"><span class="hs-identifier hs-type">Worker</span></a></span><span>
</span><span id="line-170"></span><span id="utxoWorker"><span class="annot"><span class="annottext">utxoWorker :: (UtxoIndexer -&gt; IO ()) -&gt; Maybe TargetAddresses -&gt; Worker
</span><a href="Marconi.ChainIndex.Indexers.html#utxoWorker"><span class="hs-identifier hs-var hs-var">utxoWorker</span></a></span></span><span> </span><span id="local-6989586621679484650"><span class="annot"><span class="annottext">UtxoIndexer -&gt; IO ()
</span><a href="#local-6989586621679484650"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span id="local-6989586621679484649"><span class="annot"><span class="annottext">Maybe TargetAddresses
</span><a href="#local-6989586621679484649"><span class="hs-identifier hs-var">maybeTargetAddresses</span></a></span></span><span> </span><span id="local-6989586621679484648"><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484648"><span class="hs-identifier hs-var">securityParam</span></a></span></span><span> </span><span id="local-6989586621679484647"><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484647"><span class="hs-identifier hs-var">coordinator</span></a></span></span><span> </span><span id="local-6989586621679484646"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484646"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>  </span><span id="local-6989586621679484645"><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484645"><span class="hs-identifier hs-var">workerChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
 -&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; (TChan (ChainSyncEvent (BlockInMode CardanoMode))
    -&gt; STM (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a. TChan a -&gt; STM (TChan a)
</span><a href="../../../../stm/html/src"><span class="hs-identifier hs-var">dupTChan</span></a></span><span> </span><span class="annot"><span class="annottext">(TChan (ChainSyncEvent (BlockInMode CardanoMode))
 -&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator -&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="Marconi.ChainIndex.Indexers.html#_channel"><span class="hs-identifier hs-var hs-var">_channel</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484647"><span class="hs-identifier hs-var">coordinator</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679484644"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679484644"><span class="hs-identifier hs-var">loop</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679484643"><span class="annot"><span class="annottext">MVar UtxoIndexer
</span><a href="#local-6989586621679484643"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(UtxoIndexer -&gt; IO ())
-&gt; Depth
-&gt; Maybe TargetAddresses
-&gt; Coordinator
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; FilePath
-&gt; IO (IO (), MVar UtxoIndexer)
</span><a href="Marconi.ChainIndex.Indexers.html#utxoWorker_"><span class="hs-identifier hs-var">utxoWorker_</span></a></span><span> </span><span class="annot"><span class="annottext">UtxoIndexer -&gt; IO ()
</span><a href="#local-6989586621679484650"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Depth
</span><a href="Marconi.ChainIndex.Indexers.Utxo.html#Depth"><span class="hs-identifier hs-var">Utxo.Depth</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Depth) -&gt; Int -&gt; Depth
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484648"><span class="hs-identifier hs-var">securityParam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe TargetAddresses
</span><a href="#local-6989586621679484649"><span class="hs-identifier hs-var">maybeTargetAddresses</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484647"><span class="hs-identifier hs-var">coordinator</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484645"><span class="hs-identifier hs-var">workerChannel</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484646"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-173"></span><span>  </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; (IO () -&gt; IO ThreadId) -&gt; IO () -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forkIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679484644"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><span class="annottext">MVar UtxoIndexer -&gt; IO UtxoIndexer
forall a. MVar a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">readMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar UtxoIndexer
</span><a href="#local-6989586621679484643"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">IO UtxoIndexer
-&gt; (UtxoIndexer -&gt; IO [ChainPoint]) -&gt; IO [ChainPoint]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">UtxoHandle -&gt; IO [ChainPoint]
forall h. Resumable h =&gt; h -&gt; StorableMonad h [StorablePoint h]
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.resumeFromStorage</span></a></span><span> </span><span class="annot"><span class="annottext">(UtxoHandle -&gt; IO [ChainPoint])
-&gt; (UtxoIndexer -&gt; UtxoHandle) -&gt; UtxoIndexer -&gt; IO [ChainPoint]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting UtxoHandle UtxoIndexer UtxoHandle
-&gt; UtxoIndexer -&gt; UtxoHandle
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">Getting UtxoHandle UtxoIndexer UtxoHandle
forall h. Lens' (State h) h
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.handle</span></a></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#addressDatumWorker"><span class="hs-identifier hs-type">addressDatumWorker</span></a></span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Storable.StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.AddressDatum.html#AddressDatumHandle"><span class="hs-identifier hs-type">AddressDatumHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Types.html#TargetAddresses"><span class="hs-identifier hs-type">TargetAddresses</span></a></span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Worker"><span class="hs-identifier hs-type">Worker</span></a></span><span>
</span><span id="line-180"></span><span id="addressDatumWorker"><span class="annot"><span class="annottext">addressDatumWorker :: (StorableEvent AddressDatumHandle -&gt; IO [()])
-&gt; Maybe TargetAddresses -&gt; Worker
</span><a href="Marconi.ChainIndex.Indexers.html#addressDatumWorker"><span class="hs-identifier hs-var hs-var">addressDatumWorker</span></a></span></span><span> </span><span id="local-6989586621679484638"><span class="annot"><span class="annottext">StorableEvent AddressDatumHandle -&gt; IO [()]
</span><a href="#local-6989586621679484638"><span class="hs-identifier hs-var">onInsert</span></a></span></span><span> </span><span id="local-6989586621679484637"><span class="annot"><span class="annottext">Maybe TargetAddresses
</span><a href="#local-6989586621679484637"><span class="hs-identifier hs-var">targetAddresses</span></a></span></span><span> </span><span id="local-6989586621679484636"><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484636"><span class="hs-identifier hs-var">securityParam</span></a></span></span><span> </span><span id="local-6989586621679484635"><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484635"><span class="hs-identifier hs-var">coordinator</span></a></span></span><span> </span><span id="local-6989586621679484634"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484634"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-181"></span><span>  </span><span id="local-6989586621679484633"><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484633"><span class="hs-identifier hs-var">workerChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
 -&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; (TChan (ChainSyncEvent (BlockInMode CardanoMode))
    -&gt; STM (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a. TChan a -&gt; STM (TChan a)
</span><a href="../../../../stm/html/src"><span class="hs-identifier hs-var">dupTChan</span></a></span><span> </span><span class="annot"><span class="annottext">(TChan (ChainSyncEvent (BlockInMode CardanoMode))
 -&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator -&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="Marconi.ChainIndex.Indexers.html#_channel"><span class="hs-identifier hs-var hs-var">_channel</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484635"><span class="hs-identifier hs-var">coordinator</span></a></span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679484632"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679484632"><span class="hs-identifier hs-var">loop</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679484631"><span class="annot"><span class="annottext">MVar AddressDatumIndex
</span><a href="#local-6989586621679484631"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-183"></span><span>      </span><span class="annot"><span class="annottext">(StorableEvent AddressDatumHandle -&gt; IO [()])
-&gt; Maybe TargetAddresses
-&gt; AddressDatumDepth
-&gt; Coordinator
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; FilePath
-&gt; IO (IO (), MVar AddressDatumIndex)
</span><a href="Marconi.ChainIndex.Indexers.html#addressDatumWorker_"><span class="hs-identifier hs-var">addressDatumWorker_</span></a></span><span>
</span><span id="line-184"></span><span>        </span><span class="annot"><span class="annottext">StorableEvent AddressDatumHandle -&gt; IO [()]
</span><a href="#local-6989586621679484638"><span class="hs-identifier hs-var">onInsert</span></a></span><span>
</span><span id="line-185"></span><span>        </span><span class="annot"><span class="annottext">Maybe TargetAddresses
</span><a href="#local-6989586621679484637"><span class="hs-identifier hs-var">targetAddresses</span></a></span><span>
</span><span id="line-186"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; AddressDatumDepth
</span><a href="Marconi.ChainIndex.Indexers.AddressDatum.html#AddressDatumDepth"><span class="hs-identifier hs-var">AddressDatumDepth</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; AddressDatumDepth) -&gt; Int -&gt; AddressDatumDepth
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484636"><span class="hs-identifier hs-var">securityParam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>        </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484635"><span class="hs-identifier hs-var">coordinator</span></a></span><span>
</span><span id="line-188"></span><span>        </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484633"><span class="hs-identifier hs-var">workerChannel</span></a></span><span>
</span><span id="line-189"></span><span>        </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484634"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-190"></span><span>  </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; (IO () -&gt; IO ThreadId) -&gt; IO () -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forkIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679484632"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-191"></span><span>  </span><span class="annot"><span class="annottext">MVar AddressDatumIndex -&gt; IO AddressDatumIndex
forall a. MVar a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">readMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AddressDatumIndex
</span><a href="#local-6989586621679484631"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">IO AddressDatumIndex
-&gt; (AddressDatumIndex -&gt; IO [ChainPoint]) -&gt; IO [ChainPoint]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">AddressDatumHandle -&gt; IO [ChainPoint]
forall h. Resumable h =&gt; h -&gt; StorableMonad h [StorablePoint h]
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.resumeFromStorage</span></a></span><span> </span><span class="annot"><span class="annottext">(AddressDatumHandle -&gt; IO [ChainPoint])
-&gt; (AddressDatumIndex -&gt; AddressDatumHandle)
-&gt; AddressDatumIndex
-&gt; IO [ChainPoint]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting AddressDatumHandle AddressDatumIndex AddressDatumHandle
-&gt; AddressDatumIndex -&gt; AddressDatumHandle
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">Getting AddressDatumHandle AddressDatumIndex AddressDatumHandle
forall h. Lens' (State h) h
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.handle</span></a></span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#addressDatumWorker_"><span class="hs-identifier hs-type">addressDatumWorker_</span></a></span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Storable.StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.AddressDatum.html#AddressDatumHandle"><span class="hs-identifier hs-type">AddressDatumHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Types.html#TargetAddresses"><span class="hs-identifier hs-type">TargetAddresses</span></a></span><span>  </span><span class="hs-comment">-- ^ Target addresses to filter for</span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.AddressDatum.html#AddressDatumDepth"><span class="hs-identifier hs-type">AddressDatumDepth</span></a></span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../stm/html/src"><span class="hs-identifier hs-type">TChan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">ChainSyncEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">CardanoMode</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.AddressDatum.html#AddressDatumIndex"><span class="hs-identifier hs-type">AddressDatumIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span id="addressDatumWorker_"><span class="annot"><span class="annottext">addressDatumWorker_ :: (StorableEvent AddressDatumHandle -&gt; IO [()])
-&gt; Maybe TargetAddresses
-&gt; AddressDatumDepth
-&gt; Coordinator
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; FilePath
-&gt; IO (IO (), MVar AddressDatumIndex)
</span><a href="Marconi.ChainIndex.Indexers.html#addressDatumWorker_"><span class="hs-identifier hs-var hs-var">addressDatumWorker_</span></a></span></span><span> </span><span id="local-6989586621679484629"><span class="annot"><span class="annottext">StorableEvent AddressDatumHandle -&gt; IO [()]
</span><a href="#local-6989586621679484629"><span class="hs-identifier hs-var">onInsert</span></a></span></span><span> </span><span id="local-6989586621679484628"><span class="annot"><span class="annottext">Maybe TargetAddresses
</span><a href="#local-6989586621679484628"><span class="hs-identifier hs-var">targetAddresses</span></a></span></span><span> </span><span id="local-6989586621679484627"><span class="annot"><span class="annottext">AddressDatumDepth
</span><a href="#local-6989586621679484627"><span class="hs-identifier hs-var">depth</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span class="hs-special">{</span><span id="local-6989586621679484626"><span class="annot"><span class="annottext">QSemN
_barrier :: QSemN
_barrier :: Coordinator -&gt; QSemN
</span><a href="#local-6989586621679484626"><span class="hs-identifier hs-var hs-var">_barrier</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679484625"><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484625"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span id="local-6989586621679484624"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484624"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-202"></span><span>    </span><span id="local-6989586621679484623"><span class="annot"><span class="annottext">AddressDatumIndex
</span><a href="#local-6989586621679484623"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; AddressDatumDepth -&gt; IO AddressDatumIndex
</span><a href="Marconi.ChainIndex.Indexers.AddressDatum.html#open"><span class="hs-identifier hs-var">AddressDatum.open</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484624"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">AddressDatumDepth
</span><a href="#local-6989586621679484627"><span class="hs-identifier hs-var">depth</span></a></span><span>
</span><span id="line-203"></span><span>    </span><span id="local-6989586621679484621"><span class="annot"><span class="annottext">MVar AddressDatumIndex
</span><a href="#local-6989586621679484621"><span class="hs-identifier hs-var">mIndex</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AddressDatumIndex -&gt; IO (MVar AddressDatumIndex)
forall a. a -&gt; IO (MVar a)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">newMVar</span></a></span><span> </span><span class="annot"><span class="annottext">AddressDatumIndex
</span><a href="#local-6989586621679484623"><span class="hs-identifier hs-var">index</span></a></span><span>
</span><span id="line-204"></span><span>    </span><span class="annot"><span class="annottext">(IO (), MVar AddressDatumIndex)
-&gt; IO (IO (), MVar AddressDatumIndex)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar AddressDatumIndex -&gt; IO ()
</span><a href="#local-6989586621679484620"><span class="hs-identifier hs-var">innerLoop</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AddressDatumIndex
</span><a href="#local-6989586621679484621"><span class="hs-identifier hs-var">mIndex</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MVar AddressDatumIndex
</span><a href="#local-6989586621679484621"><span class="hs-identifier hs-var">mIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><a href="#local-6989586621679484620"><span class="hs-identifier hs-type">innerLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.AddressDatum.html#AddressDatumIndex"><span class="hs-identifier hs-type">AddressDatumIndex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>    </span><span id="local-6989586621679484620"><span class="annot"><span class="annottext">innerLoop :: MVar AddressDatumIndex -&gt; IO ()
</span><a href="#local-6989586621679484620"><span class="hs-identifier hs-var hs-var">innerLoop</span></a></span></span><span> </span><span id="local-6989586621679484619"><span class="annot"><span class="annottext">MVar AddressDatumIndex
</span><a href="#local-6989586621679484619"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>      </span><span class="annot"><span class="annottext">QSemN -&gt; Int -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">signalQSemN</span></a></span><span> </span><span class="annot"><span class="annottext">QSemN
</span><a href="#local-6989586621679484626"><span class="hs-identifier hs-var">_barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-209"></span><span>      </span><span id="local-6989586621679484618"><span class="annot"><span class="annottext">ChainSyncEvent (BlockInMode CardanoMode)
</span><a href="#local-6989586621679484618"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (ChainSyncEvent (BlockInMode CardanoMode))
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (ChainSyncEvent (BlockInMode CardanoMode))
 -&gt; IO (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; STM (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (ChainSyncEvent (BlockInMode CardanoMode))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; STM (ChainSyncEvent (BlockInMode CardanoMode))
forall a. TChan a -&gt; STM a
</span><a href="../../../../stm/html/src"><span class="hs-identifier hs-var">readTChan</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484625"><span class="hs-identifier hs-var">ch</span></a></span><span>
</span><span id="line-210"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainSyncEvent (BlockInMode CardanoMode)
</span><a href="#local-6989586621679484618"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-211"></span><span>        </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">RollForward</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span> </span><span id="local-6989586621679484617"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484617"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span id="local-6989586621679484616"><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679484616"><span class="hs-identifier hs-var">bh</span></a></span></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679484615"><span class="annot"><span class="annottext">[Tx era]
</span><a href="#local-6989586621679484615"><span class="hs-identifier hs-var">txs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EraInMode era CardanoMode
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChainTip
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-212"></span><span>            </span><span class="hs-comment">-- TODO Redo. Inefficient filtering</span><span>
</span><span id="line-213"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679484614"><span class="annot"><span class="annottext">addressFilter :: Maybe (Address ShelleyAddr -&gt; Bool)
</span><a href="#local-6989586621679484614"><span class="hs-identifier hs-var hs-var">addressFilter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-214"></span><span>                    </span><span class="annot"><span class="annottext">(TargetAddresses -&gt; Address ShelleyAddr -&gt; Bool)
-&gt; Maybe TargetAddresses -&gt; Maybe (Address ShelleyAddr -&gt; Bool)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Address ShelleyAddr -&gt; TargetAddresses -&gt; Bool)
-&gt; TargetAddresses -&gt; Address ShelleyAddr -&gt; Bool
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">Address ShelleyAddr -&gt; TargetAddresses -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">elem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span>                         </span><span class="annot"><span class="annottext">Maybe TargetAddresses
</span><a href="#local-6989586621679484628"><span class="hs-identifier hs-var">targetAddresses</span></a></span><span>
</span><span id="line-216"></span><span>                </span><span id="local-6989586621679484611"><span class="annot"><span class="annottext">addressDatumIndexEvent :: StorableEvent AddressDatumHandle
</span><a href="#local-6989586621679484611"><span class="hs-identifier hs-var hs-var">addressDatumIndexEvent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-217"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (Address ShelleyAddr -&gt; Bool)
-&gt; [Tx era] -&gt; ChainPoint -&gt; StorableEvent AddressDatumHandle
forall era.
Maybe (Address ShelleyAddr -&gt; Bool)
-&gt; [Tx era] -&gt; ChainPoint -&gt; StorableEvent AddressDatumHandle
</span><a href="Marconi.ChainIndex.Indexers.AddressDatum.html#toAddressDatumIndexEvent"><span class="hs-identifier hs-var">AddressDatum.toAddressDatumIndexEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Address ShelleyAddr -&gt; Bool)
</span><a href="#local-6989586621679484614"><span class="hs-identifier hs-var">addressFilter</span></a></span><span> </span><span class="annot"><span class="annottext">[Tx era]
</span><a href="#local-6989586621679484615"><span class="hs-identifier hs-var">txs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Hash BlockHeader -&gt; ChainPoint
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.ChainPoint</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484617"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679484616"><span class="hs-identifier hs-var">bh</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>            </span><span class="annot"><span class="annottext">MVar AddressDatumIndex
-&gt; (AddressDatumIndex -&gt; IO AddressDatumIndex) -&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AddressDatumIndex
</span><a href="#local-6989586621679484619"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StorableEvent AddressDatumHandle
-&gt; AddressDatumIndex
-&gt; StorableMonad AddressDatumHandle AddressDatumIndex
forall h.
(Buffered h, PrimMonad (StorableMonad h)) =&gt;
StorableEvent h -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.insert</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent AddressDatumHandle
</span><a href="#local-6989586621679484611"><span class="hs-identifier hs-var">addressDatumIndexEvent</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>            </span><span class="annot"><span class="annottext">IO [()] -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO [()] -&gt; IO ()) -&gt; IO [()] -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent AddressDatumHandle -&gt; IO [()]
</span><a href="#local-6989586621679484629"><span class="hs-identifier hs-var">onInsert</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent AddressDatumHandle
</span><a href="#local-6989586621679484611"><span class="hs-identifier hs-var">addressDatumIndexEvent</span></a></span><span>
</span><span id="line-220"></span><span>            </span><span class="annot"><span class="annottext">MVar AddressDatumIndex -&gt; IO ()
</span><a href="#local-6989586621679484620"><span class="hs-identifier hs-var">innerLoop</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AddressDatumIndex
</span><a href="#local-6989586621679484619"><span class="hs-identifier hs-var">index</span></a></span><span>
</span><span id="line-221"></span><span>        </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">RollBackward</span></a></span><span> </span><span id="local-6989586621679484609"><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679484609"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span id="local-6989586621679484608"><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484608"><span class="hs-identifier hs-var">_ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-222"></span><span>          </span><span class="annot"><span class="annottext">MVar AddressDatumIndex
-&gt; (AddressDatumIndex -&gt; IO AddressDatumIndex) -&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AddressDatumIndex
</span><a href="#local-6989586621679484619"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">((AddressDatumIndex -&gt; IO AddressDatumIndex) -&gt; IO ())
-&gt; (AddressDatumIndex -&gt; IO AddressDatumIndex) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679484607"><span class="annot"><span class="annottext">AddressDatumIndex
</span><a href="#local-6989586621679484607"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AddressDatumIndex -&gt; Maybe AddressDatumIndex -&gt; AddressDatumIndex
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">AddressDatumIndex
</span><a href="#local-6989586621679484607"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe AddressDatumIndex -&gt; AddressDatumIndex)
-&gt; IO (Maybe AddressDatumIndex) -&gt; IO AddressDatumIndex
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint AddressDatumHandle
-&gt; AddressDatumIndex
-&gt; StorableMonad AddressDatumHandle (Maybe AddressDatumIndex)
forall h.
(Rewindable h, HasPoint (StorableEvent h) (StorablePoint h),
 PrimMonad (StorableMonad h), Ord (StorablePoint h)) =&gt;
StorablePoint h -&gt; State h -&gt; StorableMonad h (Maybe (State h))
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.rewind</span></a></span><span> </span><span class="annot"><span class="annottext">ChainPoint
StorablePoint AddressDatumHandle
</span><a href="#local-6989586621679484609"><span class="hs-identifier hs-var">cp</span></a></span><span> </span><span class="annot"><span class="annottext">AddressDatumIndex
</span><a href="#local-6989586621679484607"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-223"></span><span>          </span><span class="annot"><span class="annottext">MVar AddressDatumIndex -&gt; IO ()
</span><a href="#local-6989586621679484620"><span class="hs-identifier hs-var">innerLoop</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AddressDatumIndex
</span><a href="#local-6989586621679484619"><span class="hs-identifier hs-var">index</span></a></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="hs-comment">-- * ScriptTx indexer</span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#scriptTxWorker_"><span class="hs-identifier hs-type">scriptTxWorker_</span></a></span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Storable.StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTx.ScriptTxHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#Depth"><span class="hs-identifier hs-type">ScriptTx.Depth</span></a></span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../stm/html/src"><span class="hs-identifier hs-type">TChan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">ChainSyncEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">CardanoMode</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxIndexer"><span class="hs-identifier hs-type">ScriptTx.ScriptTxIndexer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span id="scriptTxWorker_"><span class="annot"><span class="annottext">scriptTxWorker_ :: (StorableEvent ScriptTxHandle -&gt; IO [()])
-&gt; Depth
-&gt; Coordinator
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; FilePath
-&gt; IO (IO (), MVar ScriptTxIndexer)
</span><a href="Marconi.ChainIndex.Indexers.html#scriptTxWorker_"><span class="hs-identifier hs-var hs-var">scriptTxWorker_</span></a></span></span><span> </span><span id="local-6989586621679484605"><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle -&gt; IO [()]
</span><a href="#local-6989586621679484605"><span class="hs-identifier hs-var">onInsert</span></a></span></span><span> </span><span id="local-6989586621679484604"><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621679484604"><span class="hs-identifier hs-var">depth</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span class="hs-special">{</span><span id="local-6989586621679484603"><span class="annot"><span class="annottext">QSemN
_barrier :: QSemN
_barrier :: Coordinator -&gt; QSemN
</span><a href="#local-6989586621679484603"><span class="hs-identifier hs-var hs-var">_barrier</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679484602"><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484602"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span id="local-6989586621679484601"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484601"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-235"></span><span>  </span><span id="local-6989586621679484600"><span class="annot"><span class="annottext">ScriptTxIndexer
</span><a href="#local-6989586621679484600"><span class="hs-identifier hs-var">indexer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Depth -&gt; IO ScriptTxIndexer
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#open"><span class="hs-identifier hs-var">ScriptTx.open</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484601"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621679484604"><span class="hs-identifier hs-var">depth</span></a></span><span>
</span><span id="line-236"></span><span>  </span><span id="local-6989586621679484598"><span class="annot"><span class="annottext">MVar ScriptTxIndexer
</span><a href="#local-6989586621679484598"><span class="hs-identifier hs-var">mIndexer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScriptTxIndexer -&gt; IO (MVar ScriptTxIndexer)
forall a. a -&gt; IO (MVar a)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">newMVar</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxIndexer
</span><a href="#local-6989586621679484600"><span class="hs-identifier hs-var">indexer</span></a></span><span>
</span><span id="line-237"></span><span>  </span><span class="annot"><span class="annottext">(IO (), MVar ScriptTxIndexer) -&gt; IO (IO (), MVar ScriptTxIndexer)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar ScriptTxIndexer -&gt; IO ()
</span><a href="#local-6989586621679484597"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ScriptTxIndexer
</span><a href="#local-6989586621679484598"><span class="hs-identifier hs-var">mIndexer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MVar ScriptTxIndexer
</span><a href="#local-6989586621679484598"><span class="hs-identifier hs-var">mIndexer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-239"></span><span>    </span><span class="annot"><a href="#local-6989586621679484597"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxIndexer"><span class="hs-identifier hs-type">ScriptTx.ScriptTxIndexer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>    </span><span id="local-6989586621679484597"><span class="annot"><span class="annottext">loop :: MVar ScriptTxIndexer -&gt; IO ()
</span><a href="#local-6989586621679484597"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621679484596"><span class="annot"><span class="annottext">MVar ScriptTxIndexer
</span><a href="#local-6989586621679484596"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-241"></span><span>      </span><span class="annot"><span class="annottext">QSemN -&gt; Int -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">signalQSemN</span></a></span><span> </span><span class="annot"><span class="annottext">QSemN
</span><a href="#local-6989586621679484603"><span class="hs-identifier hs-var">_barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-242"></span><span>      </span><span id="local-6989586621679484595"><span class="annot"><span class="annottext">ChainSyncEvent (BlockInMode CardanoMode)
</span><a href="#local-6989586621679484595"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (ChainSyncEvent (BlockInMode CardanoMode))
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (ChainSyncEvent (BlockInMode CardanoMode))
 -&gt; IO (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; STM (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (ChainSyncEvent (BlockInMode CardanoMode))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; STM (ChainSyncEvent (BlockInMode CardanoMode))
forall a. TChan a -&gt; STM a
</span><a href="../../../../stm/html/src"><span class="hs-identifier hs-var">readTChan</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484602"><span class="hs-identifier hs-var">ch</span></a></span><span>
</span><span id="line-243"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainSyncEvent (BlockInMode CardanoMode)
</span><a href="#local-6989586621679484595"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-244"></span><span>        </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">RollForward</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679484594"><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span> </span><span id="local-6989586621679484593"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484593"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span id="local-6989586621679484592"><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679484592"><span class="hs-identifier hs-var">hsh</span></a></span></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679484591"><span class="annot"><span class="annottext">[Tx era]
</span><a href="#local-6989586621679484591"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679484594"><span class="hs-identifier hs-type">era</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EraInMode era CardanoMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">CardanoMode</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679484590"><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484590"><span class="hs-identifier hs-var">_ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-245"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679484589"><span class="annot"><span class="annottext">u :: StorableEvent ScriptTxHandle
</span><a href="#local-6989586621679484589"><span class="hs-identifier hs-var hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Tx era] -&gt; ChainPoint -&gt; StorableEvent ScriptTxHandle
forall era.
IsCardanoEra era =&gt;
[Tx era] -&gt; ChainPoint -&gt; StorableEvent ScriptTxHandle
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#toUpdate"><span class="hs-identifier hs-var">ScriptTx.toUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">[Tx era]
</span><a href="#local-6989586621679484591"><span class="hs-identifier hs-var">txs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Hash BlockHeader -&gt; ChainPoint
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">ChainPoint</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484593"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679484592"><span class="hs-identifier hs-var">hsh</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>          </span><span class="annot"><span class="annottext">MVar ScriptTxIndexer
-&gt; (ScriptTxIndexer -&gt; IO ScriptTxIndexer) -&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ScriptTxIndexer
</span><a href="#local-6989586621679484596"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle
-&gt; ScriptTxIndexer -&gt; StorableMonad ScriptTxHandle ScriptTxIndexer
forall h.
(Buffered h, PrimMonad (StorableMonad h)) =&gt;
StorableEvent h -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.insert</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle
</span><a href="#local-6989586621679484589"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>          </span><span class="annot"><span class="annottext">IO [()] -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO [()] -&gt; IO ()) -&gt; IO [()] -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle -&gt; IO [()]
</span><a href="#local-6989586621679484605"><span class="hs-identifier hs-var">onInsert</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle
</span><a href="#local-6989586621679484589"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-248"></span><span>          </span><span class="annot"><span class="annottext">MVar ScriptTxIndexer -&gt; IO ()
</span><a href="#local-6989586621679484597"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ScriptTxIndexer
</span><a href="#local-6989586621679484596"><span class="hs-identifier hs-var">index</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span>        </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">RollBackward</span></a></span><span> </span><span id="local-6989586621679484587"><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679484587"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span id="local-6989586621679484586"><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484586"><span class="hs-identifier hs-var">_ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>          </span><span class="annot"><span class="annottext">MVar ScriptTxIndexer
-&gt; (ScriptTxIndexer -&gt; IO ScriptTxIndexer) -&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ScriptTxIndexer
</span><a href="#local-6989586621679484596"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">((ScriptTxIndexer -&gt; IO ScriptTxIndexer) -&gt; IO ())
-&gt; (ScriptTxIndexer -&gt; IO ScriptTxIndexer) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679484585"><span class="annot"><span class="annottext">ScriptTxIndexer
</span><a href="#local-6989586621679484585"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ScriptTxIndexer -&gt; Maybe ScriptTxIndexer -&gt; ScriptTxIndexer
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxIndexer
</span><a href="#local-6989586621679484585"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe ScriptTxIndexer -&gt; ScriptTxIndexer)
-&gt; IO (Maybe ScriptTxIndexer) -&gt; IO ScriptTxIndexer
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint ScriptTxHandle
-&gt; ScriptTxIndexer
-&gt; StorableMonad ScriptTxHandle (Maybe ScriptTxIndexer)
forall h.
(Rewindable h, HasPoint (StorableEvent h) (StorablePoint h),
 PrimMonad (StorableMonad h), Ord (StorablePoint h)) =&gt;
StorablePoint h -&gt; State h -&gt; StorableMonad h (Maybe (State h))
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.rewind</span></a></span><span> </span><span class="annot"><span class="annottext">ChainPoint
StorablePoint ScriptTxHandle
</span><a href="#local-6989586621679484587"><span class="hs-identifier hs-var">cp</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxIndexer
</span><a href="#local-6989586621679484585"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-252"></span><span>          </span><span class="annot"><span class="annottext">MVar ScriptTxIndexer -&gt; IO ()
</span><a href="#local-6989586621679484597"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ScriptTxIndexer
</span><a href="#local-6989586621679484596"><span class="hs-identifier hs-var">index</span></a></span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#scriptTxWorker"><span class="hs-identifier hs-type">scriptTxWorker</span></a></span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Storable.StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#ScriptTxHandle"><span class="hs-identifier hs-type">ScriptTx.ScriptTxHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Worker"><span class="hs-identifier hs-type">Worker</span></a></span><span>
</span><span id="line-257"></span><span id="scriptTxWorker"><span class="annot"><span class="annottext">scriptTxWorker :: (StorableEvent ScriptTxHandle -&gt; IO [()]) -&gt; Worker
</span><a href="Marconi.ChainIndex.Indexers.html#scriptTxWorker"><span class="hs-identifier hs-var hs-var">scriptTxWorker</span></a></span></span><span> </span><span id="local-6989586621679484583"><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle -&gt; IO [()]
</span><a href="#local-6989586621679484583"><span class="hs-identifier hs-var">onInsert</span></a></span></span><span> </span><span id="local-6989586621679484582"><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484582"><span class="hs-identifier hs-var">securityParam</span></a></span></span><span> </span><span id="local-6989586621679484581"><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484581"><span class="hs-identifier hs-var">coordinator</span></a></span></span><span> </span><span id="local-6989586621679484580"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484580"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-258"></span><span>  </span><span id="local-6989586621679484579"><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484579"><span class="hs-identifier hs-var">workerChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
 -&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; (TChan (ChainSyncEvent (BlockInMode CardanoMode))
    -&gt; STM (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a. TChan a -&gt; STM (TChan a)
</span><a href="../../../../stm/html/src"><span class="hs-identifier hs-var">dupTChan</span></a></span><span> </span><span class="annot"><span class="annottext">(TChan (ChainSyncEvent (BlockInMode CardanoMode))
 -&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator -&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="Marconi.ChainIndex.Indexers.html#_channel"><span class="hs-identifier hs-var hs-var">_channel</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484581"><span class="hs-identifier hs-var">coordinator</span></a></span><span>
</span><span id="line-259"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679484578"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679484578"><span class="hs-identifier hs-var">loop</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679484577"><span class="annot"><span class="annottext">MVar ScriptTxIndexer
</span><a href="#local-6989586621679484577"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(StorableEvent ScriptTxHandle -&gt; IO [()])
-&gt; Depth
-&gt; Coordinator
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; FilePath
-&gt; IO (IO (), MVar ScriptTxIndexer)
</span><a href="Marconi.ChainIndex.Indexers.html#scriptTxWorker_"><span class="hs-identifier hs-var">scriptTxWorker_</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent ScriptTxHandle -&gt; IO [()]
</span><a href="#local-6989586621679484583"><span class="hs-identifier hs-var">onInsert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Depth
</span><a href="Marconi.ChainIndex.Indexers.ScriptTx.html#Depth"><span class="hs-identifier hs-var">ScriptTx.Depth</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Depth) -&gt; Int -&gt; Depth
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484582"><span class="hs-identifier hs-var">securityParam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484581"><span class="hs-identifier hs-var">coordinator</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484579"><span class="hs-identifier hs-var">workerChannel</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484580"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-260"></span><span>  </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; (IO () -&gt; IO ThreadId) -&gt; IO () -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forkIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679484578"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-261"></span><span>  </span><span class="annot"><span class="annottext">MVar ScriptTxIndexer -&gt; IO ScriptTxIndexer
forall a. MVar a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">readMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ScriptTxIndexer
</span><a href="#local-6989586621679484577"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">IO ScriptTxIndexer
-&gt; (ScriptTxIndexer -&gt; IO [ChainPoint]) -&gt; IO [ChainPoint]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTxHandle -&gt; IO [ChainPoint]
forall h. Resumable h =&gt; h -&gt; StorableMonad h [StorablePoint h]
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.resumeFromStorage</span></a></span><span> </span><span class="annot"><span class="annottext">(ScriptTxHandle -&gt; IO [ChainPoint])
-&gt; (ScriptTxIndexer -&gt; ScriptTxHandle)
-&gt; ScriptTxIndexer
-&gt; IO [ChainPoint]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting ScriptTxHandle ScriptTxIndexer ScriptTxHandle
-&gt; ScriptTxIndexer -&gt; ScriptTxHandle
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">Getting ScriptTxHandle ScriptTxIndexer ScriptTxHandle
forall h. Lens' (State h) h
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.handle</span></a></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span class="hs-comment">-- * Epoch state indexer</span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span id="local-6989586621679484842"><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#epochStateWorker_"><span class="hs-identifier hs-type">epochStateWorker_</span></a></span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Storable.State</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Storable.StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Types.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../stm/html/src"><span class="hs-identifier hs-type">TChan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">ChainSyncEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">CardanoMode</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679484842"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateIndex"><span class="hs-identifier hs-type">EpochStateIndex</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-273"></span><span id="epochStateWorker_"><span class="annot"><span class="annottext">epochStateWorker_ :: FilePath
-&gt; ((State EpochStateHandle, StorableEvent EpochStateHandle)
    -&gt; IO ())
-&gt; SecurityParam
-&gt; Coordinator
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; FilePath
-&gt; IO (IO b, MVar (State EpochStateHandle))
</span><a href="Marconi.ChainIndex.Indexers.html#epochStateWorker_"><span class="hs-identifier hs-var hs-var">epochStateWorker_</span></a></span></span><span>
</span><span id="line-274"></span><span>        </span><span id="local-6989586621679484574"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484574"><span class="hs-identifier hs-var">nodeConfigPath</span></a></span></span><span>
</span><span id="line-275"></span><span>        </span><span id="local-6989586621679484573"><span class="annot"><span class="annottext">(State EpochStateHandle, StorableEvent EpochStateHandle) -&gt; IO ()
</span><a href="#local-6989586621679484573"><span class="hs-identifier hs-var">onInsert</span></a></span></span><span>
</span><span id="line-276"></span><span>        </span><span id="local-6989586621679484572"><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484572"><span class="hs-identifier hs-var">securityParam</span></a></span></span><span>
</span><span id="line-277"></span><span>        </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span class="hs-special">{</span><span id="local-6989586621679484571"><span class="annot"><span class="annottext">QSemN
_barrier :: QSemN
_barrier :: Coordinator -&gt; QSemN
</span><a href="#local-6989586621679484571"><span class="hs-identifier hs-var hs-var">_barrier</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-278"></span><span>        </span><span id="local-6989586621679484570"><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484570"><span class="hs-identifier hs-var">ch</span></a></span></span><span>
</span><span id="line-279"></span><span>        </span><span id="local-6989586621679484569"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484569"><span class="hs-identifier hs-var">dbPath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-280"></span><span>    </span><span id="local-6989586621679484568"><span class="annot"><span class="annottext">Either Text NodeConfig
</span><a href="#local-6989586621679484568"><span class="hs-identifier hs-var">nodeConfigE</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExceptT Text IO NodeConfig -&gt; IO (Either Text NodeConfig)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT Text IO NodeConfig -&gt; IO (Either Text NodeConfig))
-&gt; ExceptT Text IO NodeConfig -&gt; IO (Either Text NodeConfig)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NetworkConfigFile -&gt; ExceptT Text IO NodeConfig
</span><a href="Marconi.ChainIndex.Node.Client.GenesisConfig.html#readNetworkConfig"><span class="hs-identifier hs-var">readNetworkConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; NetworkConfigFile
</span><a href="Marconi.ChainIndex.Node.Client.GenesisConfig.html#NetworkConfigFile"><span class="hs-identifier hs-var">NetworkConfigFile</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484574"><span class="hs-identifier hs-var">nodeConfigPath</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>    </span><span id="local-6989586621679484567"><span class="annot"><span class="annottext">NodeConfig
</span><a href="#local-6989586621679484567"><span class="hs-identifier hs-var">nodeConfig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; IO NodeConfig)
-&gt; (NodeConfig -&gt; IO NodeConfig)
-&gt; Either Text NodeConfig
-&gt; IO NodeConfig
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; IO NodeConfig
forall a. HasCallStack =&gt; FilePath -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO NodeConfig)
-&gt; (Text -&gt; FilePath) -&gt; Text -&gt; IO NodeConfig
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NodeConfig -&gt; IO NodeConfig
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Either Text NodeConfig
</span><a href="#local-6989586621679484568"><span class="hs-identifier hs-var">nodeConfigE</span></a></span><span>
</span><span id="line-282"></span><span>    </span><span id="local-6989586621679484563"><span class="annot"><span class="annottext">Either GenesisConfigError GenesisConfig
</span><a href="#local-6989586621679484563"><span class="hs-identifier hs-var">genesisConfigE</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExceptT GenesisConfigError IO GenesisConfig
-&gt; IO (Either GenesisConfigError GenesisConfig)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT GenesisConfigError IO GenesisConfig
 -&gt; IO (Either GenesisConfigError GenesisConfig))
-&gt; ExceptT GenesisConfigError IO GenesisConfig
-&gt; IO (Either GenesisConfigError GenesisConfig)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NodeConfig -&gt; ExceptT GenesisConfigError IO GenesisConfig
</span><a href="Marconi.ChainIndex.Node.Client.GenesisConfig.html#readCardanoGenesisConfig"><span class="hs-identifier hs-var">readCardanoGenesisConfig</span></a></span><span> </span><span class="annot"><span class="annottext">NodeConfig
</span><a href="#local-6989586621679484567"><span class="hs-identifier hs-var">nodeConfig</span></a></span><span>
</span><span id="line-283"></span><span>    </span><span id="local-6989586621679484562"><span class="annot"><span class="annottext">GenesisConfig
</span><a href="#local-6989586621679484562"><span class="hs-identifier hs-var">genesisConfig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(GenesisConfigError -&gt; IO GenesisConfig)
-&gt; (GenesisConfig -&gt; IO GenesisConfig)
-&gt; Either GenesisConfigError GenesisConfig
-&gt; IO GenesisConfig
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; IO GenesisConfig
forall a. HasCallStack =&gt; FilePath -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO GenesisConfig)
-&gt; (GenesisConfigError -&gt; FilePath)
-&gt; GenesisConfigError
-&gt; IO GenesisConfig
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; FilePath)
-&gt; (GenesisConfigError -&gt; Text) -&gt; GenesisConfigError -&gt; FilePath
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">GenesisConfigError -&gt; Text
</span><a href="Marconi.ChainIndex.Node.Client.GenesisConfig.html#renderGenesisConfigError"><span class="hs-identifier hs-var">renderGenesisConfigError</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">GenesisConfig -&gt; IO GenesisConfig
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Either GenesisConfigError GenesisConfig
</span><a href="#local-6989586621679484563"><span class="hs-identifier hs-var">genesisConfigE</span></a></span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679484561"><span class="annot"><span class="annottext">initialLedgerState :: ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484561"><span class="hs-identifier hs-var hs-var">initialLedgerState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenesisConfig
-&gt; ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="Marconi.ChainIndex.Node.Client.GenesisConfig.html#initExtLedgerStateVar"><span class="hs-identifier hs-var">initExtLedgerStateVar</span></a></span><span> </span><span class="annot"><span class="annottext">GenesisConfig
</span><a href="#local-6989586621679484562"><span class="hs-identifier hs-var">genesisConfig</span></a></span><span>
</span><span id="line-286"></span><span>        </span><span id="local-6989586621679484560"><span class="annot"><span class="annottext">topLevelConfig :: TopLevelConfig (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484560"><span class="hs-identifier hs-var hs-var">topLevelConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolInfo IO (HardForkBlock (CardanoEras StandardCrypto))
-&gt; TopLevelConfig (HardForkBlock (CardanoEras StandardCrypto))
forall (m :: * -&gt; *) b. ProtocolInfo m b -&gt; TopLevelConfig b
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var hs-var">O.pInfoConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenesisConfig
-&gt; ProtocolInfo IO (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="Marconi.ChainIndex.Node.Client.GenesisConfig.html#mkProtocolInfoCardano"><span class="hs-identifier hs-var">mkProtocolInfoCardano</span></a></span><span> </span><span class="annot"><span class="annottext">GenesisConfig
</span><a href="#local-6989586621679484562"><span class="hs-identifier hs-var">genesisConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>        </span><span id="local-6989586621679484558"><span class="annot"><span class="annottext">hfLedgerConfig :: ExtLedgerCfg (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484558"><span class="hs-identifier hs-var hs-var">hfLedgerConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig (HardForkBlock (CardanoEras StandardCrypto))
-&gt; ExtLedgerCfg (HardForkBlock (CardanoEras StandardCrypto))
forall blk. TopLevelConfig blk -&gt; ExtLedgerCfg blk
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var">O.ExtLedgerCfg</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484560"><span class="hs-identifier hs-var">topLevelConfig</span></a></span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679484556"><span class="annot"><span class="annottext">ledgerStateDir :: FilePath
</span><a href="#local-6989586621679484556"><span class="hs-identifier hs-var hs-var">ledgerStateDir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath
</span><a href="../../../../filepath/html/src"><span class="hs-identifier hs-var">takeDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484569"><span class="hs-identifier hs-var">dbPath</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><a href="../../../../filepath/html/src"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;ledgerStates&quot;</span></span><span>
</span><span id="line-290"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; FilePath -&gt; IO ()
</span><a href="../../../../directory/html/src"><span class="hs-identifier hs-var">createDirectoryIfMissing</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484556"><span class="hs-identifier hs-var">ledgerStateDir</span></a></span><span>
</span><span id="line-291"></span><span>    </span><span id="local-6989586621679484555"><span class="annot"><span class="annottext">MVar (State EpochStateHandle)
</span><a href="#local-6989586621679484555"><span class="hs-identifier hs-var">indexerMVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State EpochStateHandle -&gt; IO (MVar (State EpochStateHandle))
forall a. a -&gt; IO (MVar a)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">newMVar</span></a></span><span> </span><span class="annot"><span class="annottext">(State EpochStateHandle -&gt; IO (MVar (State EpochStateHandle)))
-&gt; IO (State EpochStateHandle)
-&gt; IO (MVar (State EpochStateHandle))
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig (HardForkBlock (CardanoEras StandardCrypto))
-&gt; FilePath
-&gt; FilePath
-&gt; SecurityParam
-&gt; IO (State EpochStateHandle)
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#open"><span class="hs-identifier hs-var">EpochState.open</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484560"><span class="hs-identifier hs-var">topLevelConfig</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484569"><span class="hs-identifier hs-var">dbPath</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484556"><span class="hs-identifier hs-var">ledgerStateDir</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484572"><span class="hs-identifier hs-var">securityParam</span></a></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679484552"><span class="annot"><span class="annottext">loop :: ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
-&gt; Maybe EpochNo -&gt; Maybe EpochNo -&gt; IO b
</span><a href="#local-6989586621679484552"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621679484551"><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484551"><span class="hs-identifier hs-var">currentLedgerState</span></a></span></span><span> </span><span id="local-6989586621679484550"><span class="annot"><span class="annottext">Maybe EpochNo
</span><a href="#local-6989586621679484550"><span class="hs-identifier hs-var">currentEpochNo</span></a></span></span><span> </span><span id="local-6989586621679484549"><span class="annot"><span class="annottext">Maybe EpochNo
</span><a href="#local-6989586621679484549"><span class="hs-identifier hs-var">previousEpochNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-294"></span><span>            </span><span class="annot"><span class="annottext">QSemN -&gt; Int -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">signalQSemN</span></a></span><span> </span><span class="annot"><span class="annottext">QSemN
</span><a href="#local-6989586621679484571"><span class="hs-identifier hs-var">_barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-295"></span><span>            </span><span id="local-6989586621679484548"><span class="annot"><span class="annottext">ChainSyncEvent (BlockInMode CardanoMode)
</span><a href="#local-6989586621679484548"><span class="hs-identifier hs-var">chainSyncEvent</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (ChainSyncEvent (BlockInMode CardanoMode))
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (ChainSyncEvent (BlockInMode CardanoMode))
 -&gt; IO (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; STM (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (ChainSyncEvent (BlockInMode CardanoMode))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; STM (ChainSyncEvent (BlockInMode CardanoMode))
forall a. TChan a -&gt; STM a
</span><a href="../../../../stm/html/src"><span class="hs-identifier hs-var">readTChan</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484570"><span class="hs-identifier hs-var">ch</span></a></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span>            </span><span id="local-6989586621679484547"><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484547"><span class="hs-identifier hs-var">newLedgerState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainSyncEvent (BlockInMode CardanoMode)
</span><a href="#local-6989586621679484548"><span class="hs-identifier hs-var">chainSyncEvent</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-298"></span><span>              </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">RollForward</span></a></span><span> </span><span id="local-6989586621679484546"><span class="annot"><span class="annottext">blockInMode :: BlockInMode CardanoMode
</span><a href="#local-6989586621679484546"><span class="hs-identifier hs-var">blockInMode</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.BlockInMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.BlockHeader</span></a></span><span> </span><span id="local-6989586621679484545"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484545"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span id="local-6989586621679484544"><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679484544"><span class="hs-identifier hs-var">bh</span></a></span></span><span> </span><span id="local-6989586621679484543"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679484543"><span class="hs-identifier hs-var">bn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Tx era]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EraInMode era CardanoMode
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679484542"><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484542"><span class="hs-identifier hs-var">chainTip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-299"></span><span>                  </span><span class="hs-comment">-- If the block is rollbackable, we always store the LedgerState. If the block is</span><span>
</span><span id="line-300"></span><span>                  </span><span class="hs-comment">-- immutable, we only store it right at the beginning of a new epoch.</span><span>
</span><span id="line-301"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679484541"><span class="annot"><span class="annottext">isFirstEventOfEpoch :: Bool
</span><a href="#local-6989586621679484541"><span class="hs-identifier hs-var hs-var">isFirstEventOfEpoch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe EpochNo
</span><a href="#local-6989586621679484550"><span class="hs-identifier hs-var">currentEpochNo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EpochNo -&gt; Maybe EpochNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EpochNo
</span><a href="#local-6989586621679484549"><span class="hs-identifier hs-var">previousEpochNo</span></a></span><span>
</span><span id="line-302"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679484539"><span class="annot"><span class="annottext">storableEvent :: StorableEvent EpochStateHandle
</span><a href="#local-6989586621679484539"><span class="hs-identifier hs-var hs-var">storableEvent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-303"></span><span>                          </span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
-&gt; SlotNo
-&gt; Hash BlockHeader
-&gt; BlockNo
-&gt; ChainTip
-&gt; SecurityParam
-&gt; Bool
-&gt; StorableEvent EpochStateHandle
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#toStorableEvent"><span class="hs-identifier hs-var">EpochState.toStorableEvent</span></a></span><span>
</span><span id="line-304"></span><span>                            </span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484551"><span class="hs-identifier hs-var">currentLedgerState</span></a></span><span>
</span><span id="line-305"></span><span>                            </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679484545"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-306"></span><span>                            </span><span class="annot"><span class="annottext">Hash BlockHeader
</span><a href="#local-6989586621679484544"><span class="hs-identifier hs-var">bh</span></a></span><span>
</span><span id="line-307"></span><span>                            </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679484543"><span class="hs-identifier hs-var">bn</span></a></span><span>
</span><span id="line-308"></span><span>                            </span><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484542"><span class="hs-identifier hs-var">chainTip</span></a></span><span>
</span><span id="line-309"></span><span>                            </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484572"><span class="hs-identifier hs-var">securityParam</span></a></span><span>
</span><span id="line-310"></span><span>                            </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679484541"><span class="hs-identifier hs-var">isFirstEventOfEpoch</span></a></span><span>
</span><span id="line-311"></span><span>                  </span><span id="local-6989586621679484537"><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484537"><span class="hs-identifier hs-var">newIndexer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-312"></span><span>                      </span><span class="annot"><span class="annottext">MVar (State EpochStateHandle)
-&gt; (State EpochStateHandle
    -&gt; IO (State EpochStateHandle, State EpochStateHandle))
-&gt; IO (State EpochStateHandle)
forall a b. MVar a -&gt; (a -&gt; IO (a, b)) -&gt; IO b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (State EpochStateHandle)
</span><a href="#local-6989586621679484555"><span class="hs-identifier hs-var">indexerMVar</span></a></span><span>
</span><span id="line-313"></span><span>                        </span><span class="annot"><span class="annottext">((State EpochStateHandle
  -&gt; IO (State EpochStateHandle, State EpochStateHandle))
 -&gt; IO (State EpochStateHandle))
-&gt; (State EpochStateHandle
    -&gt; IO (State EpochStateHandle, State EpochStateHandle))
-&gt; IO (State EpochStateHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679484536"><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484536"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(State EpochStateHandle
 -&gt; (State EpochStateHandle, State EpochStateHandle))
-&gt; IO (State EpochStateHandle)
-&gt; IO (State EpochStateHandle, State EpochStateHandle)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679484535"><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484535"><span class="hs-identifier hs-var">newIdx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484535"><span class="hs-identifier hs-var">newIdx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484535"><span class="hs-identifier hs-var">newIdx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (State EpochStateHandle)
 -&gt; IO (State EpochStateHandle, State EpochStateHandle))
-&gt; IO (State EpochStateHandle)
-&gt; IO (State EpochStateHandle, State EpochStateHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
-&gt; State EpochStateHandle
-&gt; StorableMonad EpochStateHandle (State EpochStateHandle)
forall h.
(Buffered h, PrimMonad (StorableMonad h)) =&gt;
StorableEvent h -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.insert</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
</span><a href="#local-6989586621679484539"><span class="hs-identifier hs-var">storableEvent</span></a></span><span> </span><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484536"><span class="hs-identifier hs-var">idx</span></a></span><span>
</span><span id="line-314"></span><span>                  </span><span class="annot"><span class="annottext">(State EpochStateHandle, StorableEvent EpochStateHandle) -&gt; IO ()
</span><a href="#local-6989586621679484573"><span class="hs-identifier hs-var">onInsert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484537"><span class="hs-identifier hs-var">newIndexer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StorableEvent EpochStateHandle
</span><a href="#local-6989586621679484539"><span class="hs-identifier hs-var">storableEvent</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span>                  </span><span class="hs-comment">-- Compute new LedgerState given block and old LedgerState</span><span>
</span><span id="line-317"></span><span>                  </span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
-&gt; IO (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
 -&gt; IO
      (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))))
-&gt; ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
-&gt; IO (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerResult
  (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
  (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
-&gt; ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
forall l a. LedgerResult l a -&gt; a
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var hs-var">O.lrResult</span></a></span><span>
</span><span id="line-318"></span><span>                       </span><span class="annot"><span class="annottext">(LedgerResult
   (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
   (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
 -&gt; ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
-&gt; LedgerResult
     (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
     (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
-&gt; ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerCfg
  (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
-&gt; HardForkBlock (CardanoEras StandardCrypto)
-&gt; ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
-&gt; LedgerResult
     (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
     (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
forall l blk.
ApplyBlock l blk =&gt;
LedgerCfg l -&gt; blk -&gt; l -&gt; LedgerResult l l
</span><a href="../../../../ouroboros-consensus/html/src"><span class="hs-identifier hs-var">O.tickThenReapplyLedgerResult</span></a></span><span>
</span><span id="line-319"></span><span>                            </span><span class="annot"><span class="annottext">ExtLedgerCfg (HardForkBlock (CardanoEras StandardCrypto))
LedgerCfg
  (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
</span><a href="#local-6989586621679484558"><span class="hs-identifier hs-var">hfLedgerConfig</span></a></span><span>
</span><span id="line-320"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockInMode CardanoMode
-&gt; HardForkBlock (CardanoEras StandardCrypto)
forall mode block.
(ConsensusBlockForMode mode ~ block,
 LedgerSupportsProtocol
   (ShelleyBlock
      (TPraos StandardCrypto) (ShelleyEra StandardCrypto))) =&gt;
BlockInMode mode -&gt; block
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.toConsensusBlock</span></a></span><span> </span><span class="annot"><span class="annottext">BlockInMode CardanoMode
</span><a href="#local-6989586621679484546"><span class="hs-identifier hs-var">blockInMode</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span>                            </span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484551"><span class="hs-identifier hs-var">currentLedgerState</span></a></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span>              </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">RollBackward</span></a></span><span> </span><span class="annot"><span class="annottext">ChainPoint
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.ChainPointAtGenesis</span></a></span><span> </span><span id="local-6989586621679484531"><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484531"><span class="hs-identifier hs-var">_ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-324"></span><span>                  </span><span class="annot"><span class="annottext">MVar (State EpochStateHandle)
-&gt; (State EpochStateHandle -&gt; IO (State EpochStateHandle)) -&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (State EpochStateHandle)
</span><a href="#local-6989586621679484555"><span class="hs-identifier hs-var">indexerMVar</span></a></span><span> </span><span class="annot"><span class="annottext">((State EpochStateHandle -&gt; IO (State EpochStateHandle)) -&gt; IO ())
-&gt; (State EpochStateHandle -&gt; IO (State EpochStateHandle)) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679484530"><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484530"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State EpochStateHandle
-&gt; Maybe (State EpochStateHandle) -&gt; State EpochStateHandle
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484530"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (State EpochStateHandle) -&gt; State EpochStateHandle)
-&gt; IO (Maybe (State EpochStateHandle))
-&gt; IO (State EpochStateHandle)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint EpochStateHandle
-&gt; State EpochStateHandle
-&gt; StorableMonad EpochStateHandle (Maybe (State EpochStateHandle))
forall h.
(Rewindable h, HasPoint (StorableEvent h) (StorablePoint h),
 PrimMonad (StorableMonad h), Ord (StorablePoint h)) =&gt;
StorablePoint h -&gt; State h -&gt; StorableMonad h (Maybe (State h))
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.rewind</span></a></span><span> </span><span class="annot"><span class="annottext">ChainPoint
StorablePoint EpochStateHandle
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.ChainPointAtGenesis</span></a></span><span> </span><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484530"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-325"></span><span>                  </span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
-&gt; IO (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484561"><span class="hs-identifier hs-var">initialLedgerState</span></a></span><span>
</span><span id="line-326"></span><span>              </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">RollBackward</span></a></span><span> </span><span id="local-6989586621679484529"><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679484529"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span id="local-6989586621679484528"><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484528"><span class="hs-identifier hs-var">_ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-327"></span><span>                  </span><span class="annot"><span class="annottext">MVar (State EpochStateHandle)
-&gt; (State EpochStateHandle
    -&gt; IO
         (State EpochStateHandle,
          ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))))
-&gt; IO (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
forall a b. MVar a -&gt; (a -&gt; IO (a, b)) -&gt; IO b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (State EpochStateHandle)
</span><a href="#local-6989586621679484555"><span class="hs-identifier hs-var">indexerMVar</span></a></span><span> </span><span class="annot"><span class="annottext">((State EpochStateHandle
  -&gt; IO
       (State EpochStateHandle,
        ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))))
 -&gt; IO
      (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))))
-&gt; (State EpochStateHandle
    -&gt; IO
         (State EpochStateHandle,
          ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))))
-&gt; IO (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679484527"><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484527"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>                  </span><span id="local-6989586621679484526"><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484526"><span class="hs-identifier hs-var">newIndex</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State EpochStateHandle
-&gt; Maybe (State EpochStateHandle) -&gt; State EpochStateHandle
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484527"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (State EpochStateHandle) -&gt; State EpochStateHandle)
-&gt; IO (Maybe (State EpochStateHandle))
-&gt; IO (State EpochStateHandle)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint EpochStateHandle
-&gt; State EpochStateHandle
-&gt; StorableMonad EpochStateHandle (Maybe (State EpochStateHandle))
forall h.
(Rewindable h, HasPoint (StorableEvent h) (StorablePoint h),
 PrimMonad (StorableMonad h), Ord (StorablePoint h)) =&gt;
StorablePoint h -&gt; State h -&gt; StorableMonad h (Maybe (State h))
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.rewind</span></a></span><span> </span><span class="annot"><span class="annottext">ChainPoint
StorablePoint EpochStateHandle
</span><a href="#local-6989586621679484529"><span class="hs-identifier hs-var">cp</span></a></span><span> </span><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484527"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-329"></span><span>                  </span><span class="hs-comment">-- We query the LedgerState from disk at the point where we need to rollback to.</span><span>
</span><span id="line-330"></span><span>                  </span><span class="hs-comment">-- For that to work, we need to be sure that any volatile LedgerState are stored</span><span>
</span><span id="line-331"></span><span>                  </span><span class="hs-comment">-- on disk. For immutable LedgerStates, they are only stored on disk at the first</span><span>
</span><span id="line-332"></span><span>                  </span><span class="hs-comment">-- slot of an epoch.</span><span>
</span><span id="line-333"></span><span>                  </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#LedgerStateAtPointResult"><span class="hs-identifier hs-type">EpochState.LedgerStateAtPointResult</span></a></span><span> </span><span id="local-6989586621679484524"><span class="annot"><a href="#local-6989586621679484524"><span class="hs-identifier hs-var">maybeLedgerState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-334"></span><span>                      </span><span class="annot"><span class="annottext">QueryInterval (StorablePoint EpochStateHandle)
-&gt; State EpochStateHandle
-&gt; StorableQuery EpochStateHandle
-&gt; StorableMonad EpochStateHandle (StorableResult EpochStateHandle)
forall h.
(HasPoint (StorableEvent h) (StorablePoint h),
 Ord (StorablePoint h), Queryable h, PrimMonad (StorableMonad h)) =&gt;
QueryInterval (StorablePoint h)
-&gt; State h -&gt; StorableQuery h -&gt; StorableMonad h (StorableResult h)
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.query</span></a></span><span> </span><span class="annot"><span class="annottext">QueryInterval (StorablePoint EpochStateHandle)
forall p. QueryInterval p
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.QEverything</span></a></span><span> </span><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484526"><span class="hs-identifier hs-var">newIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainPoint -&gt; StorableQuery EpochStateHandle
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#LedgerStateAtPointQuery"><span class="hs-identifier hs-var">EpochState.LedgerStateAtPointQuery</span></a></span><span> </span><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679484529"><span class="hs-identifier hs-var">cp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-335"></span><span>                  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
</span><a href="#local-6989586621679484524"><span class="hs-identifier hs-var">maybeLedgerState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-336"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-337"></span><span>                        </span><span class="annot"><span class="annottext">FilePath
-&gt; IO
     (State EpochStateHandle,
      ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
forall a. HasCallStack =&gt; FilePath -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Could not find LedgerState from which to rollback from in EpochState indexer. Should not happen!&quot;</span></span><span>
</span><span id="line-338"></span><span>                    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679484520"><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484520"><span class="hs-identifier hs-var">ledgerState</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-339"></span><span>                        </span><span class="annot"><span class="annottext">(State EpochStateHandle,
 ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
-&gt; IO
     (State EpochStateHandle,
      ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State EpochStateHandle
</span><a href="#local-6989586621679484526"><span class="hs-identifier hs-var">newIndex</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484520"><span class="hs-identifier hs-var">ledgerState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>            </span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
-&gt; Maybe EpochNo -&gt; Maybe EpochNo -&gt; IO b
</span><a href="#local-6989586621679484552"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484547"><span class="hs-identifier hs-var">newLedgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
-&gt; Maybe EpochNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#getEpochNo"><span class="hs-identifier hs-var">EpochState.getEpochNo</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484547"><span class="hs-identifier hs-var">newLedgerState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe EpochNo
</span><a href="#local-6989586621679484550"><span class="hs-identifier hs-var">currentEpochNo</span></a></span><span>
</span><span id="line-342"></span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><span class="annottext">(IO b, MVar (State EpochStateHandle))
-&gt; IO (IO b, MVar (State EpochStateHandle))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
-&gt; Maybe EpochNo -&gt; Maybe EpochNo -&gt; IO b
</span><a href="#local-6989586621679484552"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484561"><span class="hs-identifier hs-var">initialLedgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
-&gt; Maybe EpochNo
</span><a href="Marconi.ChainIndex.Indexers.EpochState.html#getEpochNo"><span class="hs-identifier hs-var">EpochState.getEpochNo</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState (HardForkBlock (CardanoEras StandardCrypto))
</span><a href="#local-6989586621679484561"><span class="hs-identifier hs-var">initialLedgerState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe EpochNo
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MVar (State EpochStateHandle)
</span><a href="#local-6989586621679484555"><span class="hs-identifier hs-var">indexerMVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#epochStateWorker"><span class="hs-identifier hs-type">epochStateWorker</span></a></span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-347"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Storable.State</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Storable.StorableEvent</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.EpochState.html#EpochStateHandle"><span class="hs-identifier hs-type">EpochStateHandle</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Worker"><span class="hs-identifier hs-type">Worker</span></a></span><span>
</span><span id="line-349"></span><span id="epochStateWorker"><span class="annot"><span class="annottext">epochStateWorker :: FilePath
-&gt; ((State EpochStateHandle, StorableEvent EpochStateHandle)
    -&gt; IO ())
-&gt; Worker
</span><a href="Marconi.ChainIndex.Indexers.html#epochStateWorker"><span class="hs-identifier hs-var hs-var">epochStateWorker</span></a></span></span><span> </span><span id="local-6989586621679484517"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484517"><span class="hs-identifier hs-var">nodeConfigPath</span></a></span></span><span> </span><span id="local-6989586621679484516"><span class="annot"><span class="annottext">(State EpochStateHandle, StorableEvent EpochStateHandle) -&gt; IO ()
</span><a href="#local-6989586621679484516"><span class="hs-identifier hs-var">onInsert</span></a></span></span><span> </span><span id="local-6989586621679484515"><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484515"><span class="hs-identifier hs-var">securityParam</span></a></span></span><span> </span><span id="local-6989586621679484514"><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484514"><span class="hs-identifier hs-var">coordinator</span></a></span></span><span> </span><span id="local-6989586621679484513"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484513"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-350"></span><span>  </span><span id="local-6989586621679484512"><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484512"><span class="hs-identifier hs-var">workerChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
 -&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; (TChan (ChainSyncEvent (BlockInMode CardanoMode))
    -&gt; STM (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a. TChan a -&gt; STM (TChan a)
</span><a href="../../../../stm/html/src"><span class="hs-identifier hs-var">dupTChan</span></a></span><span> </span><span class="annot"><span class="annottext">(TChan (ChainSyncEvent (BlockInMode CardanoMode))
 -&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator -&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="Marconi.ChainIndex.Indexers.html#_channel"><span class="hs-identifier hs-var hs-var">_channel</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484514"><span class="hs-identifier hs-var">coordinator</span></a></span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679484511"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679484511"><span class="hs-identifier hs-var">loop</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679484510"><span class="annot"><span class="annottext">MVar (State EpochStateHandle)
</span><a href="#local-6989586621679484510"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-352"></span><span>      </span><span class="annot"><span class="annottext">FilePath
-&gt; ((State EpochStateHandle, StorableEvent EpochStateHandle)
    -&gt; IO ())
-&gt; SecurityParam
-&gt; Coordinator
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; FilePath
-&gt; IO (IO (), MVar (State EpochStateHandle))
forall b.
FilePath
-&gt; ((State EpochStateHandle, StorableEvent EpochStateHandle)
    -&gt; IO ())
-&gt; SecurityParam
-&gt; Coordinator
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; FilePath
-&gt; IO (IO b, MVar (State EpochStateHandle))
</span><a href="Marconi.ChainIndex.Indexers.html#epochStateWorker_"><span class="hs-identifier hs-var">epochStateWorker_</span></a></span><span>
</span><span id="line-353"></span><span>        </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484517"><span class="hs-identifier hs-var">nodeConfigPath</span></a></span><span>
</span><span id="line-354"></span><span>        </span><span class="annot"><span class="annottext">(State EpochStateHandle, StorableEvent EpochStateHandle) -&gt; IO ()
</span><a href="#local-6989586621679484516"><span class="hs-identifier hs-var">onInsert</span></a></span><span>
</span><span id="line-355"></span><span>        </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484515"><span class="hs-identifier hs-var">securityParam</span></a></span><span>
</span><span id="line-356"></span><span>        </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484514"><span class="hs-identifier hs-var">coordinator</span></a></span><span>
</span><span id="line-357"></span><span>        </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484512"><span class="hs-identifier hs-var">workerChannel</span></a></span><span>
</span><span id="line-358"></span><span>        </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484513"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-359"></span><span>  </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; IO ThreadId -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forkIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679484511"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-360"></span><span>  </span><span class="annot"><span class="annottext">MVar (State EpochStateHandle) -&gt; IO (State EpochStateHandle)
forall a. MVar a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">readMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (State EpochStateHandle)
</span><a href="#local-6989586621679484510"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">IO (State EpochStateHandle)
-&gt; (State EpochStateHandle -&gt; IO [ChainPoint]) -&gt; IO [ChainPoint]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">EpochStateHandle -&gt; IO [ChainPoint]
forall h. Resumable h =&gt; h -&gt; StorableMonad h [StorablePoint h]
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.resumeFromStorage</span></a></span><span> </span><span class="annot"><span class="annottext">(EpochStateHandle -&gt; IO [ChainPoint])
-&gt; (State EpochStateHandle -&gt; EpochStateHandle)
-&gt; State EpochStateHandle
-&gt; IO [ChainPoint]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting EpochStateHandle (State EpochStateHandle) EpochStateHandle
-&gt; State EpochStateHandle -&gt; EpochStateHandle
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">Getting EpochStateHandle (State EpochStateHandle) EpochStateHandle
forall h. Lens' (State h) h
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.handle</span></a></span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span class="hs-comment">-- * Mint/burn indexer</span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span id="local-6989586621679484834"><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#mintBurnWorker_"><span class="hs-identifier hs-type">mintBurnWorker_</span></a></span><span>
</span><span id="line-365"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Types.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span>
</span><span id="line-366"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.MintBurn.html#TxMintEvent"><span class="hs-identifier hs-type">MintBurn.TxMintEvent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span>
</span><span id="line-368"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../stm/html/src"><span class="hs-identifier hs-type">TChan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">ChainSyncEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">CardanoMode</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679484834"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.MintBurn.html#MintBurnIndexer"><span class="hs-identifier hs-type">MintBurn.MintBurnIndexer</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-371"></span><span id="mintBurnWorker_"><span class="annot"><span class="annottext">mintBurnWorker_ :: SecurityParam
-&gt; (TxMintEvent -&gt; IO ())
-&gt; Coordinator
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; FilePath
-&gt; IO (IO b, MVar MintBurnIndexer)
</span><a href="Marconi.ChainIndex.Indexers.html#mintBurnWorker_"><span class="hs-identifier hs-var hs-var">mintBurnWorker_</span></a></span></span><span> </span><span id="local-6989586621679484508"><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484508"><span class="hs-identifier hs-var">securityParam</span></a></span></span><span> </span><span id="local-6989586621679484507"><span class="annot"><span class="annottext">TxMintEvent -&gt; IO ()
</span><a href="#local-6989586621679484507"><span class="hs-identifier hs-var">onInsert</span></a></span></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span class="hs-special">{</span><span id="local-6989586621679484506"><span class="annot"><span class="annottext">QSemN
_barrier :: QSemN
_barrier :: Coordinator -&gt; QSemN
</span><a href="#local-6989586621679484506"><span class="hs-identifier hs-var hs-var">_barrier</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679484505"><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484505"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span id="local-6989586621679484504"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484504"><span class="hs-identifier hs-var">dbPath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-372"></span><span>  </span><span id="local-6989586621679484503"><span class="annot"><span class="annottext">MVar MintBurnIndexer
</span><a href="#local-6989586621679484503"><span class="hs-identifier hs-var">indexerMVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MintBurnIndexer -&gt; IO (MVar MintBurnIndexer)
forall a. a -&gt; IO (MVar a)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">newMVar</span></a></span><span> </span><span class="annot"><span class="annottext">(MintBurnIndexer -&gt; IO (MVar MintBurnIndexer))
-&gt; IO MintBurnIndexer -&gt; IO (MVar MintBurnIndexer)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; SecurityParam -&gt; IO MintBurnIndexer
</span><a href="Marconi.ChainIndex.Indexers.MintBurn.html#open"><span class="hs-identifier hs-var">MintBurn.open</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484504"><span class="hs-identifier hs-var">dbPath</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484508"><span class="hs-identifier hs-var">securityParam</span></a></span><span>
</span><span id="line-373"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-374"></span><span>    </span><span id="local-6989586621679484501"><span class="annot"><span class="annottext">loop :: IO b
</span><a href="#local-6989586621679484501"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forever</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO b) -&gt; IO () -&gt; IO b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-375"></span><span>      </span><span class="annot"><span class="annottext">QSemN -&gt; Int -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">signalQSemN</span></a></span><span> </span><span class="annot"><span class="annottext">QSemN
</span><a href="#local-6989586621679484506"><span class="hs-identifier hs-var">_barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-376"></span><span>      </span><span id="local-6989586621679484500"><span class="annot"><span class="annottext">ChainSyncEvent (BlockInMode CardanoMode)
</span><a href="#local-6989586621679484500"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (ChainSyncEvent (BlockInMode CardanoMode))
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (ChainSyncEvent (BlockInMode CardanoMode))
 -&gt; IO (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; STM (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (ChainSyncEvent (BlockInMode CardanoMode))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; STM (ChainSyncEvent (BlockInMode CardanoMode))
forall a. TChan a -&gt; STM a
</span><a href="../../../../stm/html/src"><span class="hs-identifier hs-var">readTChan</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484505"><span class="hs-identifier hs-var">ch</span></a></span><span>
</span><span id="line-377"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainSyncEvent (BlockInMode CardanoMode)
</span><a href="#local-6989586621679484500"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-378"></span><span>        </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">RollForward</span></a></span><span> </span><span id="local-6989586621679484499"><span class="annot"><span class="annottext">BlockInMode CardanoMode
</span><a href="#local-6989586621679484499"><span class="hs-identifier hs-var">blockInMode</span></a></span></span><span> </span><span id="local-6989586621679484498"><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484498"><span class="hs-identifier hs-var">_ct</span></a></span></span><span>
</span><span id="line-379"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679484497"><span class="annot"><span class="annottext">TxMintEvent
</span><a href="#local-6989586621679484497"><span class="hs-identifier hs-var">event'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlockInMode CardanoMode -&gt; Maybe TxMintEvent
</span><a href="Marconi.ChainIndex.Indexers.MintBurn.html#toUpdate"><span class="hs-identifier hs-var">MintBurn.toUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">BlockInMode CardanoMode
</span><a href="#local-6989586621679484499"><span class="hs-identifier hs-var">blockInMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-380"></span><span>              </span><span class="annot"><span class="annottext">MVar MintBurnIndexer
-&gt; (MintBurnIndexer -&gt; IO MintBurnIndexer) -&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MintBurnIndexer
</span><a href="#local-6989586621679484503"><span class="hs-identifier hs-var">indexerMVar</span></a></span><span> </span><span class="annot"><span class="annottext">((MintBurnIndexer -&gt; IO MintBurnIndexer) -&gt; IO ())
-&gt; (MintBurnIndexer -&gt; IO MintBurnIndexer) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent MintBurnHandle
-&gt; MintBurnIndexer -&gt; StorableMonad MintBurnHandle MintBurnIndexer
forall h.
(Buffered h, PrimMonad (StorableMonad h)) =&gt;
StorableEvent h -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.insert</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableEvent MintBurnHandle
 -&gt; MintBurnIndexer -&gt; StorableMonad MintBurnHandle MintBurnIndexer)
-&gt; StorableEvent MintBurnHandle
-&gt; MintBurnIndexer
-&gt; StorableMonad MintBurnHandle MintBurnIndexer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxMintEvent -&gt; StorableEvent MintBurnHandle
</span><a href="Marconi.ChainIndex.Indexers.MintBurn.html#MintBurnEvent"><span class="hs-identifier hs-var">MintBurn.MintBurnEvent</span></a></span><span> </span><span class="annot"><span class="annottext">TxMintEvent
</span><a href="#local-6989586621679484497"><span class="hs-identifier hs-var">event'</span></a></span><span>
</span><span id="line-381"></span><span>              </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxMintEvent -&gt; IO ()
</span><a href="#local-6989586621679484507"><span class="hs-identifier hs-var">onInsert</span></a></span><span> </span><span class="annot"><span class="annottext">TxMintEvent
</span><a href="#local-6989586621679484497"><span class="hs-identifier hs-var">event'</span></a></span><span>
</span><span id="line-382"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>        </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">RollBackward</span></a></span><span> </span><span id="local-6989586621679484494"><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679484494"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span id="local-6989586621679484493"><span class="annot"><span class="annottext">ChainTip
</span><a href="#local-6989586621679484493"><span class="hs-identifier hs-var">_ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-384"></span><span>          </span><span class="annot"><span class="annottext">MVar MintBurnIndexer
-&gt; (MintBurnIndexer -&gt; IO MintBurnIndexer) -&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MintBurnIndexer
</span><a href="#local-6989586621679484503"><span class="hs-identifier hs-var">indexerMVar</span></a></span><span> </span><span class="annot"><span class="annottext">((MintBurnIndexer -&gt; IO MintBurnIndexer) -&gt; IO ())
-&gt; (MintBurnIndexer -&gt; IO MintBurnIndexer) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679484492"><span class="annot"><span class="annottext">MintBurnIndexer
</span><a href="#local-6989586621679484492"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MintBurnIndexer -&gt; Maybe MintBurnIndexer -&gt; MintBurnIndexer
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">MintBurnIndexer
</span><a href="#local-6989586621679484492"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe MintBurnIndexer -&gt; MintBurnIndexer)
-&gt; IO (Maybe MintBurnIndexer) -&gt; IO MintBurnIndexer
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint MintBurnHandle
-&gt; MintBurnIndexer
-&gt; StorableMonad MintBurnHandle (Maybe MintBurnIndexer)
forall h.
(Rewindable h, HasPoint (StorableEvent h) (StorablePoint h),
 PrimMonad (StorableMonad h), Ord (StorablePoint h)) =&gt;
StorablePoint h -&gt; State h -&gt; StorableMonad h (Maybe (State h))
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.rewind</span></a></span><span> </span><span class="annot"><span class="annottext">ChainPoint
StorablePoint MintBurnHandle
</span><a href="#local-6989586621679484494"><span class="hs-identifier hs-var">cp</span></a></span><span> </span><span class="annot"><span class="annottext">MintBurnIndexer
</span><a href="#local-6989586621679484492"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-385"></span><span>  </span><span class="annot"><span class="annottext">(IO b, MVar MintBurnIndexer) -&gt; IO (IO b, MVar MintBurnIndexer)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO b
</span><a href="#local-6989586621679484501"><span class="hs-identifier hs-var">loop</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MVar MintBurnIndexer
</span><a href="#local-6989586621679484503"><span class="hs-identifier hs-var">indexerMVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#mintBurnWorker"><span class="hs-identifier hs-type">mintBurnWorker</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.MintBurn.html#TxMintEvent"><span class="hs-identifier hs-type">MintBurn.TxMintEvent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Worker"><span class="hs-identifier hs-type">Worker</span></a></span><span>
</span><span id="line-388"></span><span id="mintBurnWorker"><span class="annot"><span class="annottext">mintBurnWorker :: (TxMintEvent -&gt; IO ()) -&gt; Worker
</span><a href="Marconi.ChainIndex.Indexers.html#mintBurnWorker"><span class="hs-identifier hs-var hs-var">mintBurnWorker</span></a></span></span><span> </span><span id="local-6989586621679484490"><span class="annot"><span class="annottext">TxMintEvent -&gt; IO ()
</span><a href="#local-6989586621679484490"><span class="hs-identifier hs-var">onInsert</span></a></span></span><span> </span><span id="local-6989586621679484489"><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484489"><span class="hs-identifier hs-var">securityParam</span></a></span></span><span> </span><span id="local-6989586621679484488"><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484488"><span class="hs-identifier hs-var">coordinator</span></a></span></span><span> </span><span id="local-6989586621679484487"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484487"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-389"></span><span>  </span><span id="local-6989586621679484486"><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484486"><span class="hs-identifier hs-var">workerChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
 -&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; (TChan (ChainSyncEvent (BlockInMode CardanoMode))
    -&gt; STM (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; STM (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a. TChan a -&gt; STM (TChan a)
</span><a href="../../../../stm/html/src"><span class="hs-identifier hs-var">dupTChan</span></a></span><span> </span><span class="annot"><span class="annottext">(TChan (ChainSyncEvent (BlockInMode CardanoMode))
 -&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode))))
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; IO (TChan (ChainSyncEvent (BlockInMode CardanoMode)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator -&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="Marconi.ChainIndex.Indexers.html#_channel"><span class="hs-identifier hs-var hs-var">_channel</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484488"><span class="hs-identifier hs-var">coordinator</span></a></span><span>
</span><span id="line-390"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679484485"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679484485"><span class="hs-identifier hs-var">loop</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679484484"><span class="annot"><span class="annottext">MVar MintBurnIndexer
</span><a href="#local-6989586621679484484"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SecurityParam
-&gt; (TxMintEvent -&gt; IO ())
-&gt; Coordinator
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; FilePath
-&gt; IO (IO (), MVar MintBurnIndexer)
forall b.
SecurityParam
-&gt; (TxMintEvent -&gt; IO ())
-&gt; Coordinator
-&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; FilePath
-&gt; IO (IO b, MVar MintBurnIndexer)
</span><a href="Marconi.ChainIndex.Indexers.html#mintBurnWorker_"><span class="hs-identifier hs-var">mintBurnWorker_</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484489"><span class="hs-identifier hs-var">securityParam</span></a></span><span> </span><span class="annot"><span class="annottext">TxMintEvent -&gt; IO ()
</span><a href="#local-6989586621679484490"><span class="hs-identifier hs-var">onInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484488"><span class="hs-identifier hs-var">coordinator</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484486"><span class="hs-identifier hs-var">workerChannel</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484487"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-391"></span><span>  </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; IO ThreadId -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forkIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679484485"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-392"></span><span>  </span><span class="annot"><span class="annottext">MVar MintBurnIndexer -&gt; IO MintBurnIndexer
forall a. MVar a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">readMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MintBurnIndexer
</span><a href="#local-6989586621679484484"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">IO MintBurnIndexer
-&gt; (MintBurnIndexer -&gt; IO [ChainPoint]) -&gt; IO [ChainPoint]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">MintBurnHandle -&gt; IO [ChainPoint]
forall h. Resumable h =&gt; h -&gt; StorableMonad h [StorablePoint h]
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.resumeFromStorage</span></a></span><span> </span><span class="annot"><span class="annottext">(MintBurnHandle -&gt; IO [ChainPoint])
-&gt; (MintBurnIndexer -&gt; MintBurnHandle)
-&gt; MintBurnIndexer
-&gt; IO [ChainPoint]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting MintBurnHandle MintBurnIndexer MintBurnHandle
-&gt; MintBurnIndexer -&gt; MintBurnHandle
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">Getting MintBurnHandle MintBurnIndexer MintBurnHandle
forall h. Lens' (State h) h
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">Storable.handle</span></a></span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#initializeIndexers"><span class="hs-identifier hs-type">initializeIndexers</span></a></span><span>
</span><span id="line-395"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Types.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span>
</span><span id="line-396"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Worker"><span class="hs-identifier hs-type">Worker</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-397"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ChainPoint</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span id="initializeIndexers"><span class="annot"><span class="annottext">initializeIndexers :: SecurityParam
-&gt; [(Worker, FilePath)] -&gt; IO ([ChainPoint], Coordinator)
</span><a href="Marconi.ChainIndex.Indexers.html#initializeIndexers"><span class="hs-identifier hs-var hs-var">initializeIndexers</span></a></span></span><span> </span><span id="local-6989586621679484482"><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484482"><span class="hs-identifier hs-var">securityParam</span></a></span></span><span> </span><span id="local-6989586621679484481"><span class="annot"><span class="annottext">[(Worker, FilePath)]
</span><a href="#local-6989586621679484481"><span class="hs-identifier hs-var">indexers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-399"></span><span>  </span><span id="local-6989586621679484480"><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484480"><span class="hs-identifier hs-var">coordinator</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO Coordinator
</span><a href="Marconi.ChainIndex.Indexers.html#initialCoordinator"><span class="hs-identifier hs-var">initialCoordinator</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; IO Coordinator) -&gt; Int -&gt; IO Coordinator
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[(SecurityParam -&gt; Coordinator -&gt; FilePath -&gt; IO [ChainPoint],
  FilePath)]
-&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[(SecurityParam -&gt; Coordinator -&gt; FilePath -&gt; IO [ChainPoint],
  FilePath)]
[(Worker, FilePath)]
</span><a href="#local-6989586621679484481"><span class="hs-identifier hs-var">indexers</span></a></span><span>
</span><span id="line-400"></span><span>  </span><span id="local-6989586621679484478"><span class="annot"><span class="annottext">[[ChainPoint]]
</span><a href="#local-6989586621679484478"><span class="hs-identifier hs-var">startingPoints</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((SecurityParam -&gt; Coordinator -&gt; FilePath -&gt; IO [ChainPoint],
  FilePath)
 -&gt; IO [ChainPoint])
-&gt; [(SecurityParam -&gt; Coordinator -&gt; FilePath -&gt; IO [ChainPoint],
     FilePath)]
-&gt; IO [[ChainPoint]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679484476"><span class="annot"><span class="annottext">SecurityParam -&gt; Coordinator -&gt; FilePath -&gt; IO [ChainPoint]
</span><a href="#local-6989586621679484476"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679484475"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484475"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SecurityParam -&gt; Coordinator -&gt; FilePath -&gt; IO [ChainPoint]
</span><a href="#local-6989586621679484476"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484482"><span class="hs-identifier hs-var">securityParam</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484480"><span class="hs-identifier hs-var">coordinator</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484475"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(SecurityParam -&gt; Coordinator -&gt; FilePath -&gt; IO [ChainPoint],
  FilePath)]
[(Worker, FilePath)]
</span><a href="#local-6989586621679484481"><span class="hs-identifier hs-var">indexers</span></a></span><span>
</span><span id="line-401"></span><span>  </span><span class="hs-comment">-- We want to use the set of points that are common to all indexers</span><span>
</span><span id="line-402"></span><span>  </span><span class="hs-comment">-- giving priority to recent ones.</span><span>
</span><span id="line-403"></span><span>  </span><span class="annot"><span class="annottext">([ChainPoint], Coordinator) -&gt; IO ([ChainPoint], Coordinator)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">([ChainPoint] -&gt; [ChainPoint] -&gt; [ChainPoint])
-&gt; [[ChainPoint]] -&gt; [ChainPoint]
forall a. (a -&gt; a -&gt; a) -&gt; [a] -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldl1'</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainPoint] -&gt; [ChainPoint] -&gt; [ChainPoint]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">intersect</span></a></span><span> </span><span class="annot"><span class="annottext">[[ChainPoint]]
</span><a href="#local-6989586621679484478"><span class="hs-identifier hs-var">startingPoints</span></a></span><span>
</span><span id="line-404"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484480"><span class="hs-identifier hs-var">coordinator</span></a></span><span>
</span><span id="line-405"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span id="local-6989586621679484800"><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#mkIndexerStream"><span class="hs-identifier hs-type">mkIndexerStream</span></a></span><span>
</span><span id="line-408"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span>
</span><span id="line-409"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../streaming/html/src"><span class="hs-identifier hs-type">S.Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../streaming/html/src"><span class="hs-identifier hs-type">S.Of</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">ChainSyncEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">CardanoMode</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679484800"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-410"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-411"></span><span id="mkIndexerStream"><span class="annot"><span class="annottext">mkIndexerStream :: Coordinator
-&gt; Stream (Of (ChainSyncEvent (BlockInMode CardanoMode))) IO r
-&gt; IO ()
</span><a href="Marconi.ChainIndex.Indexers.html#mkIndexerStream"><span class="hs-identifier hs-var hs-var">mkIndexerStream</span></a></span></span><span> </span><span id="local-6989586621679484473"><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484473"><span class="hs-identifier hs-var">coordinator</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coordinator
 -&gt; ChainSyncEvent (BlockInMode CardanoMode) -&gt; IO Coordinator)
-&gt; IO Coordinator
-&gt; (Coordinator -&gt; IO ())
-&gt; Stream (Of (ChainSyncEvent (BlockInMode CardanoMode))) IO r
-&gt; IO ()
forall (m :: * -&gt; *) x a b r.
Monad m =&gt;
(x -&gt; a -&gt; m x) -&gt; m x -&gt; (x -&gt; m b) -&gt; Stream (Of a) m r -&gt; m b
</span><a href="../../../../streaming/html/src"><span class="hs-identifier hs-var">S.foldM_</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator
-&gt; ChainSyncEvent (BlockInMode CardanoMode) -&gt; IO Coordinator
</span><a href="#local-6989586621679484471"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">IO Coordinator
</span><a href="#local-6989586621679484470"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator -&gt; IO ()
</span><a href="#local-6989586621679484469"><span class="hs-identifier hs-var">finish</span></a></span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-413"></span><span>    </span><span class="annot"><a href="#local-6989586621679484470"><span class="hs-identifier hs-type">initial</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span>
</span><span id="line-414"></span><span>    </span><span id="local-6989586621679484470"><span class="annot"><span class="annottext">initial :: IO Coordinator
</span><a href="#local-6989586621679484470"><span class="hs-identifier hs-var hs-var">initial</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coordinator -&gt; IO Coordinator
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484473"><span class="hs-identifier hs-var">coordinator</span></a></span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span>    </span><span class="annot"><a href="#local-6989586621679484471"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-type">ChainSyncEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">BlockInMode</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">CardanoMode</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span>
</span><span id="line-417"></span><span>    </span><span id="local-6989586621679484471"><span class="annot"><span class="annottext">step :: Coordinator
-&gt; ChainSyncEvent (BlockInMode CardanoMode) -&gt; IO Coordinator
</span><a href="#local-6989586621679484471"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679484468"><span class="annot"><span class="annottext">c :: Coordinator
</span><a href="#local-6989586621679484468"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span class="hs-special">{</span><span id="local-6989586621679484467"><span class="annot"><span class="annottext">QSemN
_barrier :: QSemN
_barrier :: Coordinator -&gt; QSemN
</span><a href="#local-6989586621679484467"><span class="hs-identifier hs-var hs-var">_barrier</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679484466"><span class="annot"><span class="annottext">Int
_indexerCount :: Int
_indexerCount :: Coordinator -&gt; Int
</span><a href="#local-6989586621679484466"><span class="hs-identifier hs-var hs-var">_indexerCount</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679484465"><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
_channel :: TChan (ChainSyncEvent (BlockInMode CardanoMode))
_channel :: Coordinator -&gt; TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484465"><span class="hs-identifier hs-var hs-var">_channel</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679484464"><span class="annot"><span class="annottext">ChainSyncEvent (BlockInMode CardanoMode)
</span><a href="#local-6989586621679484464"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-418"></span><span>      </span><span class="annot"><span class="annottext">QSemN -&gt; Int -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">waitQSemN</span></a></span><span> </span><span class="annot"><span class="annottext">QSemN
</span><a href="#local-6989586621679484467"><span class="hs-identifier hs-var">_barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679484466"><span class="hs-identifier hs-var">_indexerCount</span></a></span><span>
</span><span id="line-419"></span><span>      </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
-&gt; ChainSyncEvent (BlockInMode CardanoMode) -&gt; STM ()
forall a. TChan a -&gt; a -&gt; STM ()
</span><a href="../../../../stm/html/src"><span class="hs-identifier hs-var">writeTChan</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (ChainSyncEvent (BlockInMode CardanoMode))
</span><a href="#local-6989586621679484465"><span class="hs-identifier hs-var">_channel</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncEvent (BlockInMode CardanoMode)
</span><a href="#local-6989586621679484464"><span class="hs-identifier hs-var">event</span></a></span><span>
</span><span id="line-420"></span><span>      </span><span class="annot"><span class="annottext">Coordinator -&gt; IO Coordinator
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484468"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-421"></span><span>
</span><span id="line-422"></span><span>    </span><span class="annot"><a href="#local-6989586621679484469"><span class="hs-identifier hs-type">finish</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Coordinator"><span class="hs-identifier hs-type">Coordinator</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>    </span><span id="local-6989586621679484469"><span class="annot"><span class="annottext">finish :: Coordinator -&gt; IO ()
</span><a href="#local-6989586621679484469"><span class="hs-identifier hs-var hs-var">finish</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coordinator
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#runIndexers"><span class="hs-identifier hs-type">runIndexers</span></a></span><span>
</span><span id="line-426"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-427"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.NetworkId</span></a></span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ChainPoint</span></a></span><span>
</span><span id="line-429"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">TS.Text</span></a></span><span>
</span><span id="line-430"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.ChainIndex.Indexers.html#Worker"><span class="hs-identifier hs-type">Worker</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-431"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-432"></span><span id="runIndexers"><span class="annot"><span class="annottext">runIndexers :: FilePath
-&gt; NetworkId
-&gt; ChainPoint
-&gt; Text
-&gt; [(Worker, Maybe FilePath)]
-&gt; IO ()
</span><a href="Marconi.ChainIndex.Indexers.html#runIndexers"><span class="hs-identifier hs-var hs-var">runIndexers</span></a></span></span><span> </span><span id="local-6989586621679484462"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484462"><span class="hs-identifier hs-var">socketPath</span></a></span></span><span> </span><span id="local-6989586621679484461"><span class="annot"><span class="annottext">NetworkId
</span><a href="#local-6989586621679484461"><span class="hs-identifier hs-var">networkId</span></a></span></span><span> </span><span id="local-6989586621679484460"><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679484460"><span class="hs-identifier hs-var">cliChainPoint</span></a></span></span><span> </span><span id="local-6989586621679484459"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679484459"><span class="hs-identifier hs-var">traceName</span></a></span></span><span> </span><span id="local-6989586621679484458"><span class="annot"><span class="annottext">[(Worker, Maybe FilePath)]
</span><a href="#local-6989586621679484458"><span class="hs-identifier hs-var">list</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-433"></span><span>  </span><span id="local-6989586621679484457"><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484457"><span class="hs-identifier hs-var">securityParam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NetworkId -&gt; FilePath -&gt; IO SecurityParam
</span><a href="Marconi.ChainIndex.Utils.html#querySecurityParam"><span class="hs-identifier hs-var">Utils.querySecurityParam</span></a></span><span> </span><span class="annot"><span class="annottext">NetworkId
</span><a href="#local-6989586621679484461"><span class="hs-identifier hs-var">networkId</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484462"><span class="hs-identifier hs-var">socketPath</span></a></span><span>
</span><span id="line-434"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679484455"><span class="annot"><span class="annottext">[ChainPoint]
</span><a href="#local-6989586621679484455"><span class="hs-identifier hs-var">returnedCp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679484454"><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484454"><span class="hs-identifier hs-var">coordinator</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SecurityParam
-&gt; [(Worker, FilePath)] -&gt; IO ([ChainPoint], Coordinator)
</span><a href="Marconi.ChainIndex.Indexers.html#initializeIndexers"><span class="hs-identifier hs-var">initializeIndexers</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679484457"><span class="hs-identifier hs-var">securityParam</span></a></span><span> </span><span class="annot"><span class="annottext">([(Worker, FilePath)] -&gt; IO ([ChainPoint], Coordinator))
-&gt; [(Worker, FilePath)] -&gt; IO ([ChainPoint], Coordinator)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((SecurityParam -&gt; Coordinator -&gt; FilePath -&gt; IO [ChainPoint],
  Maybe FilePath)
 -&gt; Maybe
      (SecurityParam -&gt; Coordinator -&gt; FilePath -&gt; IO [ChainPoint],
       FilePath))
-&gt; [(SecurityParam -&gt; Coordinator -&gt; FilePath -&gt; IO [ChainPoint],
     Maybe FilePath)]
-&gt; [(SecurityParam -&gt; Coordinator -&gt; FilePath -&gt; IO [ChainPoint],
     FilePath)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(SecurityParam -&gt; Coordinator -&gt; FilePath -&gt; IO [ChainPoint],
 Maybe FilePath)
-&gt; Maybe
     (SecurityParam -&gt; Coordinator -&gt; FilePath -&gt; IO [ChainPoint],
      FilePath)
forall (t :: * -&gt; *) (f :: * -&gt; *) a.
(Traversable t, Applicative f) =&gt;
t (f a) -&gt; f (t a)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">sequenceA</span></a></span><span> </span><span class="annot"><span class="annottext">[(SecurityParam -&gt; Coordinator -&gt; FilePath -&gt; IO [ChainPoint],
  Maybe FilePath)]
[(Worker, Maybe FilePath)]
</span><a href="#local-6989586621679484458"><span class="hs-identifier hs-var">list</span></a></span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span>  </span><span class="hs-comment">-- If the user specifies the chain point then use that,</span><span>
</span><span id="line-437"></span><span>  </span><span class="hs-comment">-- otherwise use what the indexers provide.</span><span>
</span><span id="line-438"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679484452"><span class="annot"><span class="annottext">chainPoints :: [ChainPoint]
</span><a href="#local-6989586621679484452"><span class="hs-identifier hs-var hs-var">chainPoints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679484460"><span class="hs-identifier hs-var">cliChainPoint</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-439"></span><span>        </span><span class="annot"><span class="annottext">ChainPoint
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">C.ChainPointAtGenesis</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ChainPoint]
</span><a href="#local-6989586621679484455"><span class="hs-identifier hs-var">returnedCp</span></a></span><span>
</span><span id="line-440"></span><span>        </span><span id="local-6989586621679484451"><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679484451"><span class="hs-identifier hs-var">cliCp</span></a></span></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679484451"><span class="hs-identifier hs-var">cliCp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span>  </span><span id="local-6989586621679484450"><span class="annot"><span class="annottext">Configuration
</span><a href="#local-6989586621679484450"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Configuration
</span><span class="hs-identifier hs-var">defaultConfigStdout</span></span><span>
</span><span id="line-443"></span><span>  </span><span class="annot"><span class="annottext">Configuration -&gt; Text -&gt; (Trace IO Text -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a t.
(MonadIO m, MonadMask m, ToJSON a, FromJSON a, ToObject a) =&gt;
Configuration -&gt; Text -&gt; (Trace m a -&gt; m t) -&gt; m t
</span><span class="hs-identifier hs-var">withTrace</span></span><span> </span><span class="annot"><span class="annottext">Configuration
</span><a href="#local-6989586621679484450"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679484459"><span class="hs-identifier hs-var">traceName</span></a></span><span> </span><span class="annot"><span class="annottext">((Trace IO Text -&gt; IO ()) -&gt; IO ())
-&gt; (Trace IO Text -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679484449"><span class="annot"><span class="annottext">Trace IO Text
</span><a href="#local-6989586621679484449"><span class="hs-identifier hs-var">trace</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-444"></span><span>      </span><span id="local-6989586621679484448"><span class="annot"><span class="annottext">io :: IO ()
</span><a href="#local-6989586621679484448"><span class="hs-identifier hs-var hs-var">io</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath
-&gt; NetworkId
-&gt; [ChainPoint]
-&gt; (Stream (Of (ChainSyncEvent (BlockInMode CardanoMode))) IO Any
    -&gt; IO ())
-&gt; IO ()
forall r b.
FilePath
-&gt; NetworkId
-&gt; [ChainPoint]
-&gt; (Stream (Of (ChainSyncEvent (BlockInMode CardanoMode))) IO r
    -&gt; IO b)
-&gt; IO b
</span><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-var">withChainSyncEventStream</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679484462"><span class="hs-identifier hs-var">socketPath</span></a></span><span> </span><span class="annot"><span class="annottext">NetworkId
</span><a href="#local-6989586621679484461"><span class="hs-identifier hs-var">networkId</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainPoint]
</span><a href="#local-6989586621679484452"><span class="hs-identifier hs-var">chainPoints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coordinator
-&gt; Stream (Of (ChainSyncEvent (BlockInMode CardanoMode))) IO Any
-&gt; IO ()
forall r.
Coordinator
-&gt; Stream (Of (ChainSyncEvent (BlockInMode CardanoMode))) IO r
-&gt; IO ()
</span><a href="Marconi.ChainIndex.Indexers.html#mkIndexerStream"><span class="hs-identifier hs-var">mkIndexerStream</span></a></span><span> </span><span class="annot"><span class="annottext">Coordinator
</span><a href="#local-6989586621679484454"><span class="hs-identifier hs-var">coordinator</span></a></span><span> </span><span class="annot"><span class="annottext">(Stream (Of (ChainSyncEvent (BlockInMode CardanoMode))) IO Any
 -&gt; IO ())
-&gt; (Stream (Of (ChainSyncEvent (BlockInMode CardanoMode))) IO Any
    -&gt; Stream (Of (ChainSyncEvent (BlockInMode CardanoMode))) IO Any)
-&gt; Stream (Of (ChainSyncEvent (BlockInMode CardanoMode))) IO Any
-&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Trace IO Text
-&gt; Stream (Of (ChainSyncEvent (BlockInMode CardanoMode))) IO Any
-&gt; Stream (Of (ChainSyncEvent (BlockInMode CardanoMode))) IO Any
forall r.
Trace IO Text
-&gt; Stream (Of (ChainSyncEvent (BlockInMode CardanoMode))) IO r
-&gt; Stream (Of (ChainSyncEvent (BlockInMode CardanoMode))) IO r
</span><a href="Marconi.ChainIndex.Logging.html#logging"><span class="hs-identifier hs-var">logging</span></a></span><span> </span><span class="annot"><span class="annottext">Trace IO Text
</span><a href="#local-6989586621679484449"><span class="hs-identifier hs-var">trace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span>      </span><span id="local-6989586621679484447"><span class="annot"><span class="annottext">handleException :: ChainSyncEventException -&gt; IO ()
</span><a href="#local-6989586621679484447"><span class="hs-identifier hs-var hs-var">handleException</span></a></span></span><span> </span><span class="annot"><span class="annottext">ChainSyncEventException
</span><a href="../../../../cardano-streaming/html/src"><span class="hs-identifier hs-var">NoIntersectionFound</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-446"></span><span>        </span><span class="annot"><span class="annottext">Trace IO Text -&gt; Text -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Trace m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">logError</span></span><span> </span><span class="annot"><span class="annottext">Trace IO Text
</span><a href="#local-6989586621679484449"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; IO ()) -&gt; Text -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-447"></span><span>          </span><span class="annot"><span class="annottext">SimpleDocStream Any -&gt; Text
forall ann. SimpleDocStream ann -&gt; Text
</span><a href="../../../../prettyprinter/html/src"><span class="hs-identifier hs-var">renderStrict</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleDocStream Any -&gt; Text) -&gt; SimpleDocStream Any -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-448"></span><span>            </span><span class="annot"><span class="annottext">LayoutOptions -&gt; Doc Any -&gt; SimpleDocStream Any
forall ann. LayoutOptions -&gt; Doc ann -&gt; SimpleDocStream ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-identifier hs-var">layoutPretty</span></a></span><span> </span><span class="annot"><span class="annottext">LayoutOptions
</span><a href="../../../../prettyprinter/html/src"><span class="hs-identifier hs-var">defaultLayoutOptions</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc Any -&gt; SimpleDocStream Any) -&gt; Doc Any -&gt; SimpleDocStream Any
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-449"></span><span>              </span><span class="annot"><span class="annottext">Doc Any
</span><span class="hs-string">&quot;No intersection found when looking for the chain point&quot;</span></span><span>
</span><span id="line-450"></span><span>              </span><span class="annot"><span class="annottext">Doc Any -&gt; Doc Any -&gt; Doc Any
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainPoint] -&gt; Doc Any
forall a ann. Pretty a =&gt; a -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainPoint]
</span><a href="#local-6989586621679484452"><span class="hs-identifier hs-var">chainPoints</span></a></span><span> </span><span class="annot"><span class="annottext">Doc Any -&gt; Doc Any -&gt; Doc Any
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Doc Any
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-451"></span><span>              </span><span class="annot"><span class="annottext">Doc Any -&gt; Doc Any -&gt; Doc Any
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Doc Any
</span><span class="hs-string">&quot;Please check the slot number and the block hash do belong to the chain&quot;</span></span><span>
</span><span id="line-452"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679484448"><span class="hs-identifier hs-var">io</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; (ChainSyncEventException -&gt; IO ()) -&gt; IO ()
forall e a. Exception e =&gt; IO a -&gt; (e -&gt; IO a) -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`catch`</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncEventException -&gt; IO ()
</span><a href="#local-6989586621679484447"><span class="hs-identifier hs-var">handleException</span></a></span><span>
</span><span id="line-453"></span></pre></body></html>