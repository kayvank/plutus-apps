<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-comment">-- | In-memory TLS session manager.</span><span>
</span><span id="line-5"></span><span class="hs-comment">--</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- * Limitation: you can set the maximum size of the session data database.</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- * Automatic pruning: old session data over their lifetime are pruned automatically.</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- * Energy saving: no dedicate pruning thread is running when the size of session data database is zero.</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- * (Replay resistance: each session data is used at most once to prevent replay attacks against 0RTT early data of TLS 1.3.)</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.TLS.SessionManager</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Network.TLS.SessionManager.html#Config"><span class="hs-identifier">Config</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#defaultConfig"><span class="hs-identifier">defaultConfig</span></a></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#newSessionManager"><span class="hs-identifier">newSessionManager</span></a></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../basement/html/src"><span class="hs-identifier">Basement.Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../basement/html/src"><span class="hs-identifier">Block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../memory/html/src"><span class="hs-identifier">Data.ByteArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../memory/html/src"><span class="hs-identifier">convert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">assert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../auto-update/html/src"><span class="hs-identifier">Control.Reaper</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../bytestring/html/src"><span class="hs-identifier">Data.ByteString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../bytestring/html/src"><span class="hs-identifier">ByteString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.IORef</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../psqueues/html/src"><span class="hs-identifier">Data.OrdPSQ</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../psqueues/html/src"><span class="hs-identifier">OrdPSQ</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../psqueues/html/src"><span class="hs-identifier">Data.OrdPSQ</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Q</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier">Network.TLS</span></a></span><span class="hs-cpp">
#if !MIN_VERSION_tls(1,5,0)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network.TLS.Compression</span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../clock/html/src"><span class="hs-identifier">System.Clock</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Imports.html"><span class="hs-identifier">Network.TLS.Imports</span></a></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-comment">-- | Configuration for session managers.</span><span>
</span><span id="line-36"></span><span class="hs-keyword">data</span><span> </span><span id="Config"><span class="annot"><a href="Network.TLS.SessionManager.html#Config"><span class="hs-identifier hs-var">Config</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Config"><span class="annot"><a href="Network.TLS.SessionManager.html#Config"><span class="hs-identifier hs-var">Config</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-comment">-- | Ticket lifetime in seconds.</span><span>
</span><span id="line-38"></span><span>      </span><span id="ticketLifetime"><span class="annot"><span class="annottext">Config -&gt; Int
</span><a href="Network.TLS.SessionManager.html#ticketLifetime"><span class="hs-identifier hs-var hs-var">ticketLifetime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-comment">-- | Pruning delay in seconds. This is set to 'reaperDelay'.</span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pruningDelay"><span class="annot"><span class="annottext">Config -&gt; Int
</span><a href="Network.TLS.SessionManager.html#pruningDelay"><span class="hs-identifier hs-var hs-var">pruningDelay</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-comment">-- | The limit size of session data entries.</span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dbMaxSize"><span class="annot"><span class="annottext">Config -&gt; Int
</span><a href="Network.TLS.SessionManager.html#dbMaxSize"><span class="hs-identifier hs-var hs-var">dbMaxSize</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-comment">-- | Lifetime: 1 day , delay: 10 minutes, max size: 1000 entries.</span><span>
</span><span id="line-46"></span><span class="annot"><a href="Network.TLS.SessionManager.html#defaultConfig"><span class="hs-identifier hs-type">defaultConfig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span>
</span><span id="line-47"></span><span id="defaultConfig"><span class="annot"><span class="annottext">defaultConfig :: Config
</span><a href="Network.TLS.SessionManager.html#defaultConfig"><span class="hs-identifier hs-var hs-var">defaultConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config :: Int -&gt; Int -&gt; Int -&gt; Config
</span><a href="Network.TLS.SessionManager.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-48"></span><span>      </span><span class="annot"><span class="annottext">ticketLifetime :: Int
</span><a href="Network.TLS.SessionManager.html#ticketLifetime"><span class="hs-identifier hs-var">ticketLifetime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">86400</span></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pruningDelay :: Int
</span><a href="Network.TLS.SessionManager.html#pruningDelay"><span class="hs-identifier hs-var">pruningDelay</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">6000</span></span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dbMaxSize :: Int
</span><a href="Network.TLS.SessionManager.html#dbMaxSize"><span class="hs-identifier hs-var">dbMaxSize</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1000</span></span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="annot"><a href="Network.TLS.SessionManager.html#toKey"><span class="hs-identifier hs-type">toKey</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../bytestring/html/src"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../basement/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word8</span></a></span><span>
</span><span id="line-56"></span><span id="toKey"><span class="annot"><span class="annottext">toKey :: ByteString -&gt; Block Word8
</span><a href="Network.TLS.SessionManager.html#toKey"><span class="hs-identifier hs-var hs-var">toKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Block Word8
forall bin bout.
(ByteArrayAccess bin, ByteArray bout) =&gt;
bin -&gt; bout
</span><a href="../../../../memory/html/src"><span class="hs-identifier hs-var">convert</span></a></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="annot"><a href="Network.TLS.SessionManager.html#toValue"><span class="hs-identifier hs-type">toValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">SessionData</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#SessionDataCopy"><span class="hs-identifier hs-type">SessionDataCopy</span></a></span><span class="hs-cpp">
#if MIN_VERSION_tls(1,5,0)
</span><span class="hs-cpp">#if MIN_VERSION_tls(1,5,3)
</span><span id="toValue"><span class="annot"><span class="annottext">toValue :: SessionData -&gt; SessionDataCopy
</span><a href="Network.TLS.SessionManager.html#toValue"><span class="hs-identifier hs-var hs-var">toValue</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">SessionData</span></a></span><span> </span><span id="local-6989586621679074868"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679074868"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679074867"><span class="annot"><span class="annottext">CipherID
</span><a href="#local-6989586621679074867"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679074866"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679074866"><span class="hs-identifier hs-var">comp</span></a></span></span><span> </span><span id="local-6989586621679074865"><span class="annot"><span class="annottext">Maybe HostName
</span><a href="#local-6989586621679074865"><span class="hs-identifier hs-var">msni</span></a></span></span><span> </span><span id="local-6989586621679074864"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679074864"><span class="hs-identifier hs-var">sec</span></a></span></span><span> </span><span id="local-6989586621679074863"><span class="annot"><span class="annottext">Maybe Group
</span><a href="#local-6989586621679074863"><span class="hs-identifier hs-var">mg</span></a></span></span><span> </span><span id="local-6989586621679074862"><span class="annot"><span class="annottext">Maybe TLS13TicketInfo
</span><a href="#local-6989586621679074862"><span class="hs-identifier hs-var">mti</span></a></span></span><span> </span><span id="local-6989586621679074861"><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679074861"><span class="hs-identifier hs-var">malpn</span></a></span></span><span> </span><span id="local-6989586621679074860"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679074860"><span class="hs-identifier hs-var">siz</span></a></span></span><span> </span><span id="local-6989586621679074859"><span class="annot"><span class="annottext">[SessionFlag]
</span><a href="#local-6989586621679074859"><span class="hs-identifier hs-var">flg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><span class="annottext">Version
-&gt; CipherID
-&gt; Word8
-&gt; Maybe HostName
-&gt; Block Word8
-&gt; Maybe Group
-&gt; Maybe TLS13TicketInfo
-&gt; Maybe (Block Word8)
-&gt; Int
-&gt; [SessionFlag]
-&gt; SessionDataCopy
</span><a href="Network.TLS.SessionManager.html#SessionDataCopy"><span class="hs-identifier hs-var">SessionDataCopy</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679074868"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">CipherID
</span><a href="#local-6989586621679074867"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679074866"><span class="hs-identifier hs-var">comp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe HostName
</span><a href="#local-6989586621679074865"><span class="hs-identifier hs-var">msni</span></a></span><span> </span><span class="annot"><span class="annottext">Block Word8
</span><a href="#local-6989586621679074857"><span class="hs-identifier hs-var">sec'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Group
</span><a href="#local-6989586621679074863"><span class="hs-identifier hs-var">mg</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TLS13TicketInfo
</span><a href="#local-6989586621679074862"><span class="hs-identifier hs-var">mti</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Block Word8)
</span><a href="#local-6989586621679074856"><span class="hs-identifier hs-var">malpn'</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679074860"><span class="hs-identifier hs-var">siz</span></a></span><span> </span><span class="annot"><span class="annottext">[SessionFlag]
</span><a href="#local-6989586621679074859"><span class="hs-identifier hs-var">flg</span></a></span><span class="hs-cpp">
#else
</span><span class="hs-identifier">toValue</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">SessionData</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-identifier">cid</span><span> </span><span class="hs-identifier">comp</span><span> </span><span class="hs-identifier">msni</span><span> </span><span class="hs-identifier">sec</span><span> </span><span class="hs-identifier">mg</span><span> </span><span class="hs-identifier">mti</span><span> </span><span class="hs-identifier">malpn</span><span> </span><span class="hs-identifier">siz</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-identifier">SessionDataCopy</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-identifier">cid</span><span> </span><span class="hs-identifier">comp</span><span> </span><span class="hs-identifier">msni</span><span> </span><span class="hs-identifier">sec'</span><span> </span><span class="hs-identifier">mg</span><span> </span><span class="hs-identifier">mti</span><span> </span><span class="hs-identifier">malpn'</span><span> </span><span class="hs-identifier">siz</span><span class="hs-cpp">
#endif
</span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679074857"><span class="annot"><span class="annottext">sec' :: Block Word8
</span><a href="#local-6989586621679074857"><span class="hs-identifier hs-var hs-var">sec'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Block Word8
forall bin bout.
(ByteArrayAccess bin, ByteArray bout) =&gt;
bin -&gt; bout
</span><a href="../../../../memory/html/src"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679074864"><span class="hs-identifier hs-var">sec</span></a></span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679074856"><span class="annot"><span class="annottext">malpn' :: Maybe (Block Word8)
</span><a href="#local-6989586621679074856"><span class="hs-identifier hs-var hs-var">malpn'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Block Word8
forall bin bout.
(ByteArrayAccess bin, ByteArray bout) =&gt;
bin -&gt; bout
</span><a href="../../../../memory/html/src"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Block Word8)
-&gt; Maybe ByteString -&gt; Maybe (Block Word8)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679074861"><span class="hs-identifier hs-var">malpn</span></a></span><span class="hs-cpp">
#else
</span><span class="hs-identifier">toValue</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">SessionData</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-identifier">cid</span><span> </span><span class="hs-identifier">comp</span><span> </span><span class="hs-identifier">msni</span><span> </span><span class="hs-identifier">sec</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-identifier">SessionDataCopy</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-identifier">cid</span><span> </span><span class="hs-identifier">comp</span><span> </span><span class="hs-identifier">msni</span><span> </span><span class="hs-identifier">sec'</span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-identifier">sec'</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">convert</span><span> </span><span class="hs-identifier">sec</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-77"></span><span class="annot"><a href="Network.TLS.SessionManager.html#fromValue"><span class="hs-identifier hs-type">fromValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#SessionDataCopy"><span class="hs-identifier hs-type">SessionDataCopy</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">SessionData</span></a></span><span class="hs-cpp">
#if MIN_VERSION_tls(1,5,0)
</span><span class="hs-cpp">#if MIN_VERSION_tls(1,5,3)
</span><span id="fromValue"><span class="annot"><span class="annottext">fromValue :: SessionDataCopy -&gt; SessionData
</span><a href="Network.TLS.SessionManager.html#fromValue"><span class="hs-identifier hs-var hs-var">fromValue</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.SessionManager.html#SessionDataCopy"><span class="hs-identifier hs-type">SessionDataCopy</span></a></span><span> </span><span id="local-6989586621679074853"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679074853"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679074852"><span class="annot"><span class="annottext">CipherID
</span><a href="#local-6989586621679074852"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679074851"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679074851"><span class="hs-identifier hs-var">comp</span></a></span></span><span> </span><span id="local-6989586621679074850"><span class="annot"><span class="annottext">Maybe HostName
</span><a href="#local-6989586621679074850"><span class="hs-identifier hs-var">msni</span></a></span></span><span> </span><span id="local-6989586621679074849"><span class="annot"><span class="annottext">Block Word8
</span><a href="#local-6989586621679074849"><span class="hs-identifier hs-var">sec'</span></a></span></span><span> </span><span id="local-6989586621679074848"><span class="annot"><span class="annottext">Maybe Group
</span><a href="#local-6989586621679074848"><span class="hs-identifier hs-var">mg</span></a></span></span><span> </span><span id="local-6989586621679074847"><span class="annot"><span class="annottext">Maybe TLS13TicketInfo
</span><a href="#local-6989586621679074847"><span class="hs-identifier hs-var">mti</span></a></span></span><span> </span><span id="local-6989586621679074846"><span class="annot"><span class="annottext">Maybe (Block Word8)
</span><a href="#local-6989586621679074846"><span class="hs-identifier hs-var">malpn'</span></a></span></span><span> </span><span id="local-6989586621679074845"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679074845"><span class="hs-identifier hs-var">siz</span></a></span></span><span> </span><span id="local-6989586621679074844"><span class="annot"><span class="annottext">[SessionFlag]
</span><a href="#local-6989586621679074844"><span class="hs-identifier hs-var">flg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-81"></span><span>    </span><span class="annot"><span class="annottext">Version
-&gt; CipherID
-&gt; Word8
-&gt; Maybe HostName
-&gt; ByteString
-&gt; Maybe Group
-&gt; Maybe TLS13TicketInfo
-&gt; Maybe ByteString
-&gt; Int
-&gt; [SessionFlag]
-&gt; SessionData
</span><a href="../../../../tls/html/src"><span class="hs-identifier hs-var">SessionData</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679074853"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">CipherID
</span><a href="#local-6989586621679074852"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679074851"><span class="hs-identifier hs-var">comp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe HostName
</span><a href="#local-6989586621679074850"><span class="hs-identifier hs-var">msni</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679074843"><span class="hs-identifier hs-var">sec</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Group
</span><a href="#local-6989586621679074848"><span class="hs-identifier hs-var">mg</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TLS13TicketInfo
</span><a href="#local-6989586621679074847"><span class="hs-identifier hs-var">mti</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679074842"><span class="hs-identifier hs-var">malpn</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679074845"><span class="hs-identifier hs-var">siz</span></a></span><span> </span><span class="annot"><span class="annottext">[SessionFlag]
</span><a href="#local-6989586621679074844"><span class="hs-identifier hs-var">flg</span></a></span><span class="hs-cpp">
#else
</span><span class="hs-identifier">fromValue</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">SessionDataCopy</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-identifier">cid</span><span> </span><span class="hs-identifier">comp</span><span> </span><span class="hs-identifier">msni</span><span> </span><span class="hs-identifier">sec'</span><span> </span><span class="hs-identifier">mg</span><span> </span><span class="hs-identifier">mti</span><span> </span><span class="hs-identifier">malpn'</span><span> </span><span class="hs-identifier">siz</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-identifier">SessionData</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-identifier">cid</span><span> </span><span class="hs-identifier">comp</span><span> </span><span class="hs-identifier">msni</span><span> </span><span class="hs-identifier">sec</span><span> </span><span class="hs-identifier">mg</span><span> </span><span class="hs-identifier">mti</span><span> </span><span class="hs-identifier">malpn</span><span> </span><span class="hs-identifier">siz</span><span class="hs-cpp">
#endif
</span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679074843"><span class="annot"><span class="annottext">sec :: ByteString
</span><a href="#local-6989586621679074843"><span class="hs-identifier hs-var hs-var">sec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Block Word8 -&gt; ByteString
forall bin bout.
(ByteArrayAccess bin, ByteArray bout) =&gt;
bin -&gt; bout
</span><a href="../../../../memory/html/src"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="annot"><span class="annottext">Block Word8
</span><a href="#local-6989586621679074849"><span class="hs-identifier hs-var">sec'</span></a></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679074842"><span class="annot"><span class="annottext">malpn :: Maybe ByteString
</span><a href="#local-6989586621679074842"><span class="hs-identifier hs-var hs-var">malpn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Block Word8 -&gt; ByteString
forall bin bout.
(ByteArrayAccess bin, ByteArray bout) =&gt;
bin -&gt; bout
</span><a href="../../../../memory/html/src"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="annot"><span class="annottext">(Block Word8 -&gt; ByteString)
-&gt; Maybe (Block Word8) -&gt; Maybe ByteString
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Block Word8)
</span><a href="#local-6989586621679074846"><span class="hs-identifier hs-var">malpn'</span></a></span><span class="hs-cpp">
#else
</span><span class="hs-identifier">fromValue</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">SessionDataCopy</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-identifier">cid</span><span> </span><span class="hs-identifier">comp</span><span> </span><span class="hs-identifier">msni</span><span> </span><span class="hs-identifier">sec'</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-identifier">SessionData</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-identifier">cid</span><span> </span><span class="hs-identifier">comp</span><span> </span><span class="hs-identifier">msni</span><span> </span><span class="hs-identifier">sec</span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-identifier">sec</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">convert</span><span> </span><span class="hs-identifier">sec'</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-96"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="hs-keyword">type</span><span> </span><span id="SessionIDCopy"><span class="annot"><a href="Network.TLS.SessionManager.html#SessionIDCopy"><span class="hs-identifier hs-var">SessionIDCopy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../basement/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word8</span></a></span><span>
</span><span id="line-99"></span><span class="hs-keyword">data</span><span> </span><span id="SessionDataCopy"><span class="annot"><a href="Network.TLS.SessionManager.html#SessionDataCopy"><span class="hs-identifier hs-var">SessionDataCopy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SessionDataCopy"><span class="annot"><a href="Network.TLS.SessionManager.html#SessionDataCopy"><span class="hs-identifier hs-var">SessionDataCopy</span></a></span></span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-comment">{- ssVersion     -}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">Version</span></a></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-comment">{- ssCipher      -}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">CipherID</span></a></span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-comment">{- ssCompression -}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">CompressionID</span></a></span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-comment">{- ssClientSNI   -}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">HostName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-comment">{- ssSecret      -}</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../basement/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word8</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#if MIN_VERSION_tls(1,5,0)
</span><span>    </span><span class="hs-comment">{- ssGroup       -}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">Group</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-comment">{- ssTicketInfo  -}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">TLS13TicketInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-comment">{- ssALPN        -}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../basement/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word8</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-comment">{- ssMaxEarlyDataSize -}</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">#if MIN_VERSION_tls(1,5,3)
</span><span>    </span><span class="hs-comment">{- ssFlags       -}</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">SessionFlag</span></a></span><span class="hs-special">]</span><span class="hs-cpp">
#endif
</span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679074834"><span id="local-6989586621679074836"><span id="local-6989586621679074838"><span class="annot"><span class="annottext">Int -&gt; SessionDataCopy -&gt; ShowS
[SessionDataCopy] -&gt; ShowS
SessionDataCopy -&gt; HostName
(Int -&gt; SessionDataCopy -&gt; ShowS)
-&gt; (SessionDataCopy -&gt; HostName)
-&gt; ([SessionDataCopy] -&gt; ShowS)
-&gt; Show SessionDataCopy
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; HostName) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SessionDataCopy] -&gt; ShowS
$cshowList :: [SessionDataCopy] -&gt; ShowS
show :: SessionDataCopy -&gt; HostName
$cshow :: SessionDataCopy -&gt; HostName
showsPrec :: Int -&gt; SessionDataCopy -&gt; ShowS
$cshowsPrec :: Int -&gt; SessionDataCopy -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span id="local-6989586621679074829"><span id="local-6989586621679074831"><span class="annot"><span class="annottext">SessionDataCopy -&gt; SessionDataCopy -&gt; Bool
(SessionDataCopy -&gt; SessionDataCopy -&gt; Bool)
-&gt; (SessionDataCopy -&gt; SessionDataCopy -&gt; Bool)
-&gt; Eq SessionDataCopy
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: SessionDataCopy -&gt; SessionDataCopy -&gt; Bool
$c/= :: SessionDataCopy -&gt; SessionDataCopy -&gt; Bool
== :: SessionDataCopy -&gt; SessionDataCopy -&gt; Bool
$c== :: SessionDataCopy -&gt; SessionDataCopy -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-keyword">type</span><span> </span><span id="Sec"><span class="annot"><a href="Network.TLS.SessionManager.html#Sec"><span class="hs-identifier hs-var">Sec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Int64</span></a></span><span>
</span><span id="line-117"></span><span class="hs-keyword">type</span><span> </span><span id="Value"><span class="annot"><a href="Network.TLS.SessionManager.html#Value"><span class="hs-identifier hs-var">Value</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.SessionManager.html#SessionDataCopy"><span class="hs-identifier hs-type">SessionDataCopy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#Availability"><span class="hs-identifier hs-type">Availability</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span class="hs-keyword">type</span><span> </span><span id="DB"><span class="annot"><a href="Network.TLS.SessionManager.html#DB"><span class="hs-identifier hs-var">DB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-type">OrdPSQ</span></a></span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#SessionIDCopy"><span class="hs-identifier hs-type">SessionIDCopy</span></a></span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#Sec"><span class="hs-identifier hs-type">Sec</span></a></span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#Value"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-119"></span><span class="hs-keyword">type</span><span> </span><span id="Item"><span class="annot"><a href="Network.TLS.SessionManager.html#Item"><span class="hs-identifier hs-var">Item</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.SessionManager.html#SessionIDCopy"><span class="hs-identifier hs-type">SessionIDCopy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#Sec"><span class="hs-identifier hs-type">Sec</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#Value"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#Operation"><span class="hs-identifier hs-type">Operation</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-keyword">data</span><span> </span><span id="Operation"><span class="annot"><a href="Network.TLS.SessionManager.html#Operation"><span class="hs-identifier hs-var">Operation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Add"><span class="annot"><a href="Network.TLS.SessionManager.html#Add"><span class="hs-identifier hs-var">Add</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Del"><span class="annot"><a href="Network.TLS.SessionManager.html#Del"><span class="hs-identifier hs-var">Del</span></a></span></span><span>
</span><span id="line-122"></span><span class="hs-keyword">data</span><span> </span><span id="Use"><span class="annot"><a href="Network.TLS.SessionManager.html#Use"><span class="hs-identifier hs-var">Use</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SingleUse"><span class="annot"><a href="Network.TLS.SessionManager.html#SingleUse"><span class="hs-identifier hs-var">SingleUse</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="MultipleUse"><span class="annot"><a href="Network.TLS.SessionManager.html#MultipleUse"><span class="hs-identifier hs-var">MultipleUse</span></a></span></span><span>
</span><span id="line-123"></span><span class="hs-keyword">data</span><span> </span><span id="Availability"><span class="annot"><a href="Network.TLS.SessionManager.html#Availability"><span class="hs-identifier hs-var">Availability</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Fresh"><span class="annot"><a href="Network.TLS.SessionManager.html#Fresh"><span class="hs-identifier hs-var">Fresh</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Used"><span class="annot"><a href="Network.TLS.SessionManager.html#Used"><span class="hs-identifier hs-var">Used</span></a></span></span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-comment">-- | Creating an in-memory session manager.</span><span>
</span><span id="line-128"></span><span class="annot"><a href="Network.TLS.SessionManager.html#newSessionManager"><span class="hs-identifier hs-type">newSessionManager</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">SessionManager</span></a></span><span>
</span><span id="line-129"></span><span id="newSessionManager"><span class="annot"><span class="annottext">newSessionManager :: Config -&gt; IO SessionManager
</span><a href="Network.TLS.SessionManager.html#newSessionManager"><span class="hs-identifier hs-var hs-var">newSessionManager</span></a></span></span><span> </span><span id="local-6989586621679074819"><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679074819"><span class="hs-identifier hs-var">conf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679074818"><span class="annot"><span class="annottext">lifetime :: Sec
</span><a href="#local-6989586621679074818"><span class="hs-identifier hs-var hs-var">lifetime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Sec
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Sec) -&gt; Int -&gt; Sec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Config -&gt; Int
</span><a href="Network.TLS.SessionManager.html#ticketLifetime"><span class="hs-identifier hs-var hs-var">ticketLifetime</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679074819"><span class="hs-identifier hs-var">conf</span></a></span><span>
</span><span id="line-131"></span><span>        </span><span id="local-6989586621679074817"><span class="annot"><span class="annottext">maxsiz :: Int
</span><a href="#local-6989586621679074817"><span class="hs-identifier hs-var hs-var">maxsiz</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config -&gt; Int
</span><a href="Network.TLS.SessionManager.html#dbMaxSize"><span class="hs-identifier hs-var hs-var">dbMaxSize</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679074819"><span class="hs-identifier hs-var">conf</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span id="local-6989586621679074816"><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
</span><a href="#local-6989586621679074816"><span class="hs-identifier hs-var">reaper</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaperSettings
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
-&gt; IO
     (Reaper
        (OrdPSQ (Block Word8) Sec Value)
        (Block Word8, Sec, Value, Operation))
forall workload item.
ReaperSettings workload item -&gt; IO (Reaper workload item)
</span><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-var">mkReaper</span></a></span><span> </span><span class="annot"><span class="annottext">ReaperSettings [Any] Any
forall item. ReaperSettings [item] item
</span><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-var">defaultReaperSettings</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-133"></span><span>          </span><span class="annot"><span class="annottext">reaperEmpty :: OrdPSQ (Block Word8) Sec Value
</span><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-var">reaperEmpty</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
forall k p v. OrdPSQ k p v
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.empty</span></a></span><span>
</span><span id="line-134"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">reaperCons :: (Block Word8, Sec, Value, Operation)
-&gt; OrdPSQ (Block Word8) Sec Value -&gt; OrdPSQ (Block Word8) Sec Value
</span><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-var">reaperCons</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; (Block Word8, Sec, Value, Operation)
-&gt; OrdPSQ (Block Word8) Sec Value
-&gt; OrdPSQ (Block Word8) Sec Value
</span><a href="Network.TLS.SessionManager.html#cons"><span class="hs-identifier hs-var">cons</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679074817"><span class="hs-identifier hs-var">maxsiz</span></a></span><span>
</span><span id="line-135"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">reaperAction :: OrdPSQ (Block Word8) Sec Value
-&gt; IO
     (OrdPSQ (Block Word8) Sec Value -&gt; OrdPSQ (Block Word8) Sec Value)
</span><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-var">reaperAction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
-&gt; IO
     (OrdPSQ (Block Word8) Sec Value -&gt; OrdPSQ (Block Word8) Sec Value)
</span><a href="Network.TLS.SessionManager.html#clean"><span class="hs-identifier hs-var">clean</span></a></span><span>
</span><span id="line-136"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">reaperNull :: OrdPSQ (Block Word8) Sec Value -&gt; Bool
</span><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-var">reaperNull</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value -&gt; Bool
forall k p v. OrdPSQ k p v -&gt; Bool
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.null</span></a></span><span>
</span><span id="line-137"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">reaperDelay :: Int
</span><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-var">reaperDelay</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config -&gt; Int
</span><a href="Network.TLS.SessionManager.html#pruningDelay"><span class="hs-identifier hs-var hs-var">pruningDelay</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679074819"><span class="hs-identifier hs-var">conf</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1000000</span></span><span>
</span><span id="line-138"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-139"></span><span>    </span><span class="annot"><span class="annottext">SessionManager -&gt; IO SessionManager
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">SessionManager :: (ByteString -&gt; IO (Maybe SessionData))
-&gt; (ByteString -&gt; IO (Maybe SessionData))
-&gt; (ByteString -&gt; SessionData -&gt; IO ())
-&gt; (ByteString -&gt; IO ())
-&gt; SessionManager
</span><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">SessionManager</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-140"></span><span>        </span><span class="annot"><span class="annottext">sessionResume :: ByteString -&gt; IO (Maybe SessionData)
</span><a href="../../../../tls/html/src"><span class="hs-identifier hs-var">sessionResume</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
-&gt; Use -&gt; ByteString -&gt; IO (Maybe SessionData)
</span><a href="Network.TLS.SessionManager.html#resume"><span class="hs-identifier hs-var">resume</span></a></span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
</span><a href="#local-6989586621679074816"><span class="hs-identifier hs-var">reaper</span></a></span><span> </span><span class="annot"><span class="annottext">Use
</span><a href="Network.TLS.SessionManager.html#MultipleUse"><span class="hs-identifier hs-var">MultipleUse</span></a></span><span class="hs-cpp">
#if MIN_VERSION_tls(1,5,0)
</span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sessionResumeOnlyOnce :: ByteString -&gt; IO (Maybe SessionData)
</span><a href="../../../../tls/html/src"><span class="hs-identifier hs-var">sessionResumeOnlyOnce</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
-&gt; Use -&gt; ByteString -&gt; IO (Maybe SessionData)
</span><a href="Network.TLS.SessionManager.html#resume"><span class="hs-identifier hs-var">resume</span></a></span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
</span><a href="#local-6989586621679074816"><span class="hs-identifier hs-var">reaper</span></a></span><span> </span><span class="annot"><span class="annottext">Use
</span><a href="Network.TLS.SessionManager.html#SingleUse"><span class="hs-identifier hs-var">SingleUse</span></a></span><span class="hs-cpp">
#endif
</span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sessionEstablish :: ByteString -&gt; SessionData -&gt; IO ()
</span><a href="../../../../tls/html/src"><span class="hs-identifier hs-var">sessionEstablish</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
-&gt; Sec -&gt; ByteString -&gt; SessionData -&gt; IO ()
</span><a href="Network.TLS.SessionManager.html#establish"><span class="hs-identifier hs-var">establish</span></a></span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
</span><a href="#local-6989586621679074816"><span class="hs-identifier hs-var">reaper</span></a></span><span> </span><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074818"><span class="hs-identifier hs-var">lifetime</span></a></span><span>
</span><span id="line-145"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sessionInvalidate :: ByteString -&gt; IO ()
</span><a href="../../../../tls/html/src"><span class="hs-identifier hs-var">sessionInvalidate</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
-&gt; ByteString -&gt; IO ()
</span><a href="Network.TLS.SessionManager.html#invalidate"><span class="hs-identifier hs-var">invalidate</span></a></span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
</span><a href="#local-6989586621679074816"><span class="hs-identifier hs-var">reaper</span></a></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span class="annot"><a href="Network.TLS.SessionManager.html#cons"><span class="hs-identifier hs-type">cons</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#Item"><span class="hs-identifier hs-type">Item</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span>
</span><span id="line-150"></span><span id="cons"><span class="annot"><span class="annottext">cons :: Int
-&gt; (Block Word8, Sec, Value, Operation)
-&gt; OrdPSQ (Block Word8) Sec Value
-&gt; OrdPSQ (Block Word8) Sec Value
</span><a href="Network.TLS.SessionManager.html#cons"><span class="hs-identifier hs-var hs-var">cons</span></a></span></span><span> </span><span id="local-6989586621679074795"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679074795"><span class="hs-identifier hs-var">lim</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679074794"><span class="annot"><span class="annottext">Block Word8
</span><a href="#local-6989586621679074794"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679074793"><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074793"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679074792"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679074792"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Operation
</span><a href="Network.TLS.SessionManager.html#Add"><span class="hs-identifier hs-var">Add</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679074791"><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074791"><span class="hs-identifier hs-var">db</span></a></span></span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679074795"><span class="hs-identifier hs-var">lim</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
forall k p v. OrdPSQ k p v
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.empty</span></a></span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value -&gt; Int
forall k p v. OrdPSQ k p v -&gt; Int
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.size</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074791"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679074795"><span class="hs-identifier hs-var">lim</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
-&gt; Maybe (Block Word8, Sec, Value, OrdPSQ (Block Word8) Sec Value)
forall k p v.
(Ord k, Ord p) =&gt;
OrdPSQ k p v -&gt; Maybe (k, p, v, OrdPSQ k p v)
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.minView</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074791"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-153"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Block Word8, Sec, Value, OrdPSQ (Block Word8) Sec Value)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; OrdPSQ (Block Word8) Sec Value -&gt; OrdPSQ (Block Word8) Sec Value
forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="annot"><span class="annottext">(OrdPSQ (Block Word8) Sec Value -&gt; OrdPSQ (Block Word8) Sec Value)
-&gt; OrdPSQ (Block Word8) Sec Value -&gt; OrdPSQ (Block Word8) Sec Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Block Word8
-&gt; Sec
-&gt; Value
-&gt; OrdPSQ (Block Word8) Sec Value
-&gt; OrdPSQ (Block Word8) Sec Value
forall k p v.
(Ord k, Ord p) =&gt;
k -&gt; p -&gt; v -&gt; OrdPSQ k p v -&gt; OrdPSQ k p v
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Block Word8
</span><a href="#local-6989586621679074794"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074793"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679074792"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
forall k p v. OrdPSQ k p v
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.empty</span></a></span><span>
</span><span id="line-154"></span><span>      </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Block Word8
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Sec
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679074786"><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074786"><span class="hs-identifier hs-var">db'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Block Word8
-&gt; Sec
-&gt; Value
-&gt; OrdPSQ (Block Word8) Sec Value
-&gt; OrdPSQ (Block Word8) Sec Value
forall k p v.
(Ord k, Ord p) =&gt;
k -&gt; p -&gt; v -&gt; OrdPSQ k p v -&gt; OrdPSQ k p v
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Block Word8
</span><a href="#local-6989586621679074794"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074793"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679074792"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074786"><span class="hs-identifier hs-var">db'</span></a></span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Block Word8
-&gt; Sec
-&gt; Value
-&gt; OrdPSQ (Block Word8) Sec Value
-&gt; OrdPSQ (Block Word8) Sec Value
forall k p v.
(Ord k, Ord p) =&gt;
k -&gt; p -&gt; v -&gt; OrdPSQ k p v -&gt; OrdPSQ k p v
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Block Word8
</span><a href="#local-6989586621679074794"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074793"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679074792"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074791"><span class="hs-identifier hs-var">db</span></a></span><span>
</span><span id="line-156"></span><span class="annot"><a href="Network.TLS.SessionManager.html#cons"><span class="hs-identifier hs-var">cons</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">(</span><span id="local-6989586621679074785"><span class="annot"><span class="annottext">Block Word8
</span><a href="#local-6989586621679074785"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Sec
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Operation
</span><a href="Network.TLS.SessionManager.html#Del"><span class="hs-identifier hs-var">Del</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679074784"><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074784"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Block Word8
-&gt; OrdPSQ (Block Word8) Sec Value -&gt; OrdPSQ (Block Word8) Sec Value
forall k p v. (Ord k, Ord p) =&gt; k -&gt; OrdPSQ k p v -&gt; OrdPSQ k p v
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.delete</span></a></span><span> </span><span class="annot"><span class="annottext">Block Word8
</span><a href="#local-6989586621679074785"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074784"><span class="hs-identifier hs-var">db</span></a></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span class="annot"><a href="Network.TLS.SessionManager.html#clean"><span class="hs-identifier hs-type">clean</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.SessionManager.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span id="clean"><span class="annot"><span class="annottext">clean :: OrdPSQ (Block Word8) Sec Value
-&gt; IO
     (OrdPSQ (Block Word8) Sec Value -&gt; OrdPSQ (Block Word8) Sec Value)
</span><a href="Network.TLS.SessionManager.html#clean"><span class="hs-identifier hs-var hs-var">clean</span></a></span></span><span> </span><span id="local-6989586621679074782"><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074782"><span class="hs-identifier hs-var">olddb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-160"></span><span>    </span><span id="local-6989586621679074781"><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074781"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TimeSpec -&gt; Sec
</span><a href="../../../../clock/html/src"><span class="hs-identifier hs-var hs-var">C.sec</span></a></span><span> </span><span class="annot"><span class="annottext">(TimeSpec -&gt; Sec) -&gt; IO TimeSpec -&gt; IO Sec
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Clock -&gt; IO TimeSpec
</span><a href="../../../../clock/html/src"><span class="hs-identifier hs-var">C.getTime</span></a></span><span> </span><span class="annot"><span class="annottext">Clock
</span><a href="../../../../clock/html/src"><span class="hs-identifier hs-var">C.Monotonic</span></a></span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679074777"><span class="annot"><span class="annottext">pruned :: OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074777"><span class="hs-identifier hs-var hs-var">pruned</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([(Block Word8, Sec, Value)], OrdPSQ (Block Word8) Sec Value)
-&gt; OrdPSQ (Block Word8) Sec Value
forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">(([(Block Word8, Sec, Value)], OrdPSQ (Block Word8) Sec Value)
 -&gt; OrdPSQ (Block Word8) Sec Value)
-&gt; ([(Block Word8, Sec, Value)], OrdPSQ (Block Word8) Sec Value)
-&gt; OrdPSQ (Block Word8) Sec Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Sec
-&gt; OrdPSQ (Block Word8) Sec Value
-&gt; ([(Block Word8, Sec, Value)], OrdPSQ (Block Word8) Sec Value)
forall k p v.
(Ord k, Ord p) =&gt;
p -&gt; OrdPSQ k p v -&gt; ([(k, p, v)], OrdPSQ k p v)
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.atMostView</span></a></span><span> </span><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074781"><span class="hs-identifier hs-var">currentTime</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074782"><span class="hs-identifier hs-var">olddb</span></a></span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><span class="annottext">(OrdPSQ (Block Word8) Sec Value -&gt; OrdPSQ (Block Word8) Sec Value)
-&gt; IO
     (OrdPSQ (Block Word8) Sec Value -&gt; OrdPSQ (Block Word8) Sec Value)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">((OrdPSQ (Block Word8) Sec Value -&gt; OrdPSQ (Block Word8) Sec Value)
 -&gt; IO
      (OrdPSQ (Block Word8) Sec Value -&gt; OrdPSQ (Block Word8) Sec Value))
-&gt; (OrdPSQ (Block Word8) Sec Value
    -&gt; OrdPSQ (Block Word8) Sec Value)
-&gt; IO
     (OrdPSQ (Block Word8) Sec Value -&gt; OrdPSQ (Block Word8) Sec Value)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
-&gt; OrdPSQ (Block Word8) Sec Value -&gt; OrdPSQ (Block Word8) Sec Value
forall k p v.
(Ord k, Ord p) =&gt;
OrdPSQ k p v -&gt; OrdPSQ k p v -&gt; OrdPSQ k p v
</span><a href="#local-6989586621679074775"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074777"><span class="hs-identifier hs-var">pruned</span></a></span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-164"></span><span>    </span><span id="local-6989586621679074774"><span class="annot"><span class="annottext">ins :: OrdPSQ k p v -&gt; (k, p, v) -&gt; OrdPSQ k p v
</span><a href="#local-6989586621679074774"><span class="hs-identifier hs-var hs-var">ins</span></a></span></span><span> </span><span id="local-6989586621679074773"><span class="annot"><span class="annottext">OrdPSQ k p v
</span><a href="#local-6989586621679074773"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679074772"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621679074772"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679074771"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679074771"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679074770"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679074770"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">k -&gt; p -&gt; v -&gt; OrdPSQ k p v -&gt; OrdPSQ k p v
forall k p v.
(Ord k, Ord p) =&gt;
k -&gt; p -&gt; v -&gt; OrdPSQ k p v -&gt; OrdPSQ k p v
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.insert</span></a></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621679074772"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679074771"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679074770"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ k p v
</span><a href="#local-6989586621679074773"><span class="hs-identifier hs-var">db</span></a></span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-comment">-- There is not 'merge' API.</span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-comment">-- We hope that newdb is smaller than pruned.</span><span>
</span><span id="line-167"></span><span>    </span><span id="local-6989586621679074775"><span class="annot"><span class="annottext">merge :: OrdPSQ k p v -&gt; OrdPSQ k p v -&gt; OrdPSQ k p v
</span><a href="#local-6989586621679074775"><span class="hs-identifier hs-var hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621679074769"><span class="annot"><span class="annottext">OrdPSQ k p v
</span><a href="#local-6989586621679074769"><span class="hs-identifier hs-var">pruned</span></a></span></span><span> </span><span id="local-6989586621679074768"><span class="annot"><span class="annottext">OrdPSQ k p v
</span><a href="#local-6989586621679074768"><span class="hs-identifier hs-var">newdb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OrdPSQ k p v -&gt; (k, p, v) -&gt; OrdPSQ k p v)
-&gt; OrdPSQ k p v -&gt; [(k, p, v)] -&gt; OrdPSQ k p v
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ k p v -&gt; (k, p, v) -&gt; OrdPSQ k p v
forall k p v.
(Ord k, Ord p) =&gt;
OrdPSQ k p v -&gt; (k, p, v) -&gt; OrdPSQ k p v
</span><a href="#local-6989586621679074774"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ k p v
</span><a href="#local-6989586621679074769"><span class="hs-identifier hs-var">pruned</span></a></span><span> </span><span class="annot"><span class="annottext">[(k, p, v)]
</span><a href="#local-6989586621679074766"><span class="hs-identifier hs-var">entries</span></a></span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-169"></span><span>        </span><span id="local-6989586621679074766"><span class="annot"><span class="annottext">entries :: [(k, p, v)]
</span><a href="#local-6989586621679074766"><span class="hs-identifier hs-var hs-var">entries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdPSQ k p v -&gt; [(k, p, v)]
forall k p v. OrdPSQ k p v -&gt; [(k, p, v)]
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.toList</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ k p v
</span><a href="#local-6989586621679074768"><span class="hs-identifier hs-var">newdb</span></a></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="annot"><a href="Network.TLS.SessionManager.html#establish"><span class="hs-identifier hs-type">establish</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-type">Reaper</span></a></span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#Item"><span class="hs-identifier hs-type">Item</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#Sec"><span class="hs-identifier hs-type">Sec</span></a></span><span>
</span><span id="line-174"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">SessionID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">SessionData</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span id="establish"><span class="annot"><span class="annottext">establish :: Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
-&gt; Sec -&gt; ByteString -&gt; SessionData -&gt; IO ()
</span><a href="Network.TLS.SessionManager.html#establish"><span class="hs-identifier hs-var hs-var">establish</span></a></span></span><span> </span><span id="local-6989586621679074763"><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
</span><a href="#local-6989586621679074763"><span class="hs-identifier hs-var">reaper</span></a></span></span><span> </span><span id="local-6989586621679074762"><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074762"><span class="hs-identifier hs-var">lifetime</span></a></span></span><span> </span><span id="local-6989586621679074761"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679074761"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679074760"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679074760"><span class="hs-identifier hs-var">sd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-176"></span><span>    </span><span id="local-6989586621679074759"><span class="annot"><span class="annottext">IORef Availability
</span><a href="#local-6989586621679074759"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Availability -&gt; IO (IORef Availability)
forall a. a -&gt; IO (IORef a)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">Availability
</span><a href="Network.TLS.SessionManager.html#Fresh"><span class="hs-identifier hs-var">Fresh</span></a></span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679074757"><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074757"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sec -&gt; Sec -&gt; Sec
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074762"><span class="hs-identifier hs-var">lifetime</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Sec -&gt; Sec) -&gt; (TimeSpec -&gt; Sec) -&gt; TimeSpec -&gt; Sec
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TimeSpec -&gt; Sec
</span><a href="../../../../clock/html/src"><span class="hs-identifier hs-var hs-var">C.sec</span></a></span><span> </span><span class="annot"><span class="annottext">(TimeSpec -&gt; Sec) -&gt; IO TimeSpec -&gt; IO Sec
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Clock -&gt; IO TimeSpec
</span><a href="../../../../clock/html/src"><span class="hs-identifier hs-var">C.getTime</span></a></span><span> </span><span class="annot"><span class="annottext">Clock
</span><a href="../../../../clock/html/src"><span class="hs-identifier hs-var">C.Monotonic</span></a></span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679074754"><span class="annot"><span class="annottext">v :: Value
</span><a href="#local-6989586621679074754"><span class="hs-identifier hs-var hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SessionDataCopy
</span><a href="#local-6989586621679074753"><span class="hs-identifier hs-var">sd'</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">IORef Availability
</span><a href="#local-6989586621679074759"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
-&gt; (Block Word8, Sec, Value, Operation) -&gt; IO ()
forall workload item. Reaper workload item -&gt; item -&gt; IO ()
</span><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-var hs-var">reaperAdd</span></a></span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
</span><a href="#local-6989586621679074763"><span class="hs-identifier hs-var">reaper</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Block Word8
</span><a href="#local-6989586621679074751"><span class="hs-identifier hs-var">k'</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074757"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679074754"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Operation
</span><a href="Network.TLS.SessionManager.html#Add"><span class="hs-identifier hs-var">Add</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679074751"><span class="annot"><span class="annottext">k' :: Block Word8
</span><a href="#local-6989586621679074751"><span class="hs-identifier hs-var hs-var">k'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Block Word8
</span><a href="Network.TLS.SessionManager.html#toKey"><span class="hs-identifier hs-var">toKey</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679074761"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679074753"><span class="annot"><span class="annottext">sd' :: SessionDataCopy
</span><a href="#local-6989586621679074753"><span class="hs-identifier hs-var hs-var">sd'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; SessionDataCopy
</span><a href="Network.TLS.SessionManager.html#toValue"><span class="hs-identifier hs-var">toValue</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679074760"><span class="hs-identifier hs-var">sd</span></a></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span class="annot"><a href="Network.TLS.SessionManager.html#resume"><span class="hs-identifier hs-type">resume</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-type">Reaper</span></a></span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#Item"><span class="hs-identifier hs-type">Item</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#Use"><span class="hs-identifier hs-type">Use</span></a></span><span>
</span><span id="line-185"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">SessionID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">SessionData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span id="resume"><span class="annot"><span class="annottext">resume :: Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
-&gt; Use -&gt; ByteString -&gt; IO (Maybe SessionData)
</span><a href="Network.TLS.SessionManager.html#resume"><span class="hs-identifier hs-var hs-var">resume</span></a></span></span><span> </span><span id="local-6989586621679074750"><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
</span><a href="#local-6989586621679074750"><span class="hs-identifier hs-var">reaper</span></a></span></span><span> </span><span id="local-6989586621679074749"><span class="annot"><span class="annottext">Use
</span><a href="#local-6989586621679074749"><span class="hs-identifier hs-var">use</span></a></span></span><span> </span><span id="local-6989586621679074748"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679074748"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-187"></span><span>    </span><span id="local-6989586621679074747"><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074747"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
-&gt; IO (OrdPSQ (Block Word8) Sec Value)
forall workload item. Reaper workload item -&gt; IO workload
</span><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-var hs-var">reaperRead</span></a></span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
</span><a href="#local-6989586621679074750"><span class="hs-identifier hs-var">reaper</span></a></span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Block Word8 -&gt; OrdPSQ (Block Word8) Sec Value -&gt; Maybe (Sec, Value)
forall k p v. Ord k =&gt; k -&gt; OrdPSQ k p v -&gt; Maybe (p, v)
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Block Word8
</span><a href="#local-6989586621679074744"><span class="hs-identifier hs-var">k'</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074747"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-189"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Sec, Value)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe SessionData -&gt; IO (Maybe SessionData)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SessionData
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-190"></span><span>      </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679074743"><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074743"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679074742"><span class="annot"><span class="annottext">v :: Value
</span><a href="#local-6989586621679074742"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679074741"><span class="annot"><span class="annottext">SessionDataCopy
</span><a href="#local-6989586621679074741"><span class="hs-identifier hs-var">sd</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679074740"><span class="annot"><span class="annottext">IORef Availability
</span><a href="#local-6989586621679074740"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-191"></span><span>           </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Use
</span><a href="#local-6989586621679074749"><span class="hs-identifier hs-var">use</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-192"></span><span>               </span><span class="annot"><span class="annottext">Use
</span><a href="Network.TLS.SessionManager.html#SingleUse"><span class="hs-identifier hs-var">SingleUse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-193"></span><span>                   </span><span id="local-6989586621679074739"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679074739"><span class="hs-identifier hs-var">available</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Availability
-&gt; (Availability -&gt; (Availability, Bool)) -&gt; IO Bool
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Availability
</span><a href="#local-6989586621679074740"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Availability -&gt; (Availability, Bool)
</span><a href="#local-6989586621679074737"><span class="hs-identifier hs-var">check</span></a></span><span>
</span><span id="line-194"></span><span>                   </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
-&gt; (Block Word8, Sec, Value, Operation) -&gt; IO ()
forall workload item. Reaper workload item -&gt; item -&gt; IO ()
</span><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-var hs-var">reaperAdd</span></a></span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
</span><a href="#local-6989586621679074750"><span class="hs-identifier hs-var">reaper</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Block Word8
</span><a href="#local-6989586621679074744"><span class="hs-identifier hs-var">k'</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074743"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679074742"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Operation
</span><a href="Network.TLS.SessionManager.html#Del"><span class="hs-identifier hs-var">Del</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>                   </span><span class="annot"><span class="annottext">Maybe SessionData -&gt; IO (Maybe SessionData)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe SessionData -&gt; IO (Maybe SessionData))
-&gt; Maybe SessionData -&gt; IO (Maybe SessionData)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679074739"><span class="hs-identifier hs-var">available</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; Maybe SessionData
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SessionDataCopy -&gt; SessionData
</span><a href="Network.TLS.SessionManager.html#fromValue"><span class="hs-identifier hs-var">fromValue</span></a></span><span> </span><span class="annot"><span class="annottext">SessionDataCopy
</span><a href="#local-6989586621679074741"><span class="hs-identifier hs-var">sd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe SessionData
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-196"></span><span>               </span><span class="annot"><span class="annottext">Use
</span><a href="Network.TLS.SessionManager.html#MultipleUse"><span class="hs-identifier hs-var">MultipleUse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe SessionData -&gt; IO (Maybe SessionData)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe SessionData -&gt; IO (Maybe SessionData))
-&gt; Maybe SessionData -&gt; IO (Maybe SessionData)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; Maybe SessionData
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SessionDataCopy -&gt; SessionData
</span><a href="Network.TLS.SessionManager.html#fromValue"><span class="hs-identifier hs-var">fromValue</span></a></span><span> </span><span class="annot"><span class="annottext">SessionDataCopy
</span><a href="#local-6989586621679074741"><span class="hs-identifier hs-var">sd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-198"></span><span>    </span><span id="local-6989586621679074737"><span class="annot"><span class="annottext">check :: Availability -&gt; (Availability, Bool)
</span><a href="#local-6989586621679074737"><span class="hs-identifier hs-var hs-var">check</span></a></span></span><span> </span><span class="annot"><span class="annottext">Availability
</span><a href="Network.TLS.SessionManager.html#Fresh"><span class="hs-identifier hs-var">Fresh</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Availability
</span><a href="Network.TLS.SessionManager.html#Used"><span class="hs-identifier hs-var">Used</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>    </span><span class="annot"><a href="#local-6989586621679074737"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Availability
</span><a href="Network.TLS.SessionManager.html#Used"><span class="hs-identifier hs-var">Used</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Availability
</span><a href="Network.TLS.SessionManager.html#Used"><span class="hs-identifier hs-var">Used</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679074744"><span class="annot"><span class="annottext">k' :: Block Word8
</span><a href="#local-6989586621679074744"><span class="hs-identifier hs-var hs-var">k'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Block Word8
</span><a href="Network.TLS.SessionManager.html#toKey"><span class="hs-identifier hs-var">toKey</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679074748"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="annot"><a href="Network.TLS.SessionManager.html#invalidate"><span class="hs-identifier hs-type">invalidate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-type">Reaper</span></a></span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="annot"><a href="Network.TLS.SessionManager.html#Item"><span class="hs-identifier hs-type">Item</span></a></span><span>
</span><span id="line-203"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../tls/html/src"><span class="hs-identifier hs-type">SessionID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span id="invalidate"><span class="annot"><span class="annottext">invalidate :: Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
-&gt; ByteString -&gt; IO ()
</span><a href="Network.TLS.SessionManager.html#invalidate"><span class="hs-identifier hs-var hs-var">invalidate</span></a></span></span><span> </span><span id="local-6989586621679074736"><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
</span><a href="#local-6989586621679074736"><span class="hs-identifier hs-var">reaper</span></a></span></span><span> </span><span id="local-6989586621679074735"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679074735"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-205"></span><span>    </span><span id="local-6989586621679074734"><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074734"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
-&gt; IO (OrdPSQ (Block Word8) Sec Value)
forall workload item. Reaper workload item -&gt; IO workload
</span><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-var hs-var">reaperRead</span></a></span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
</span><a href="#local-6989586621679074736"><span class="hs-identifier hs-var">reaper</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Block Word8 -&gt; OrdPSQ (Block Word8) Sec Value -&gt; Maybe (Sec, Value)
forall k p v. Ord k =&gt; k -&gt; OrdPSQ k p v -&gt; Maybe (p, v)
</span><a href="../../../../psqueues/html/src"><span class="hs-identifier hs-var">Q.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Block Word8
</span><a href="#local-6989586621679074733"><span class="hs-identifier hs-var">k'</span></a></span><span> </span><span class="annot"><span class="annottext">OrdPSQ (Block Word8) Sec Value
</span><a href="#local-6989586621679074734"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-207"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Sec, Value)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>      </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679074732"><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074732"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679074731"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679074731"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
-&gt; (Block Word8, Sec, Value, Operation) -&gt; IO ()
forall workload item. Reaper workload item -&gt; item -&gt; IO ()
</span><a href="../../../../auto-update/html/src"><span class="hs-identifier hs-var hs-var">reaperAdd</span></a></span><span> </span><span class="annot"><span class="annottext">Reaper
  (OrdPSQ (Block Word8) Sec Value)
  (Block Word8, Sec, Value, Operation)
</span><a href="#local-6989586621679074736"><span class="hs-identifier hs-var">reaper</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Block Word8
</span><a href="#local-6989586621679074733"><span class="hs-identifier hs-var">k'</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Sec
</span><a href="#local-6989586621679074732"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621679074731"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Operation
</span><a href="Network.TLS.SessionManager.html#Del"><span class="hs-identifier hs-var">Del</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679074733"><span class="annot"><span class="annottext">k' :: Block Word8
</span><a href="#local-6989586621679074733"><span class="hs-identifier hs-var hs-var">k'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Block Word8
</span><a href="Network.TLS.SessionManager.html#toKey"><span class="hs-identifier hs-var">toKey</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679074735"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-211"></span></pre></body></html>