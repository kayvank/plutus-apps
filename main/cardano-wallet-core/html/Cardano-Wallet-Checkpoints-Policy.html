<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Cardano.Wallet.Checkpoints.Policy</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">cardano-wallet-core-2022.7.1: The Wallet Backend for a Cardano node.</span><ul class="links" id="page-menu"><li><a href="src/Cardano.Wallet.Checkpoints.Policy.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th valign="top">Copyright</th><td>&#169; 2022 IOHK</td></tr><tr><th>License</th><td>Apache-2.0</td></tr><tr><th>Safe Haskell</th><td>Safe-Inferred</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Cardano.Wallet.Checkpoints.Policy</p></div><div id="table-of-contents"><div id="contents-list"><p class="caption" onclick="window.scrollTo(0,0)">Contents</p><ul><li><a href="#g:1">Construction</a></li><li><a href="#g:2">Internal invariants</a></li></ul></div></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Abstract data type that describes a policy for keeping and discarding
 checkpoints. To be used with the <code>Checkpoints</code> type.</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><span class="keyword">type</span> <a href="#t:BlockHeight">BlockHeight</a> = <a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#t:Integer" title="Distribution.Compat.Prelude.Internal">Integer</a></li><li class="src short"><span class="keyword">data</span> <a href="#t:CheckpointPolicy">CheckpointPolicy</a></li><li class="src short"><a href="#v:nextCheckpoint">nextCheckpoint</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#t:Maybe" title="Distribution.Compat.Prelude.Internal">Maybe</a> <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a></li><li class="src short"><a href="#v:keepWhereTip">keepWhereTip</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#t:Bool" title="Distribution.Compat.Prelude.Internal">Bool</a></li><li class="src short"><a href="#v:toListAtTip">toListAtTip</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; [<a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a>]</li><li class="src short"><a href="#v:atGenesis">atGenesis</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a></li><li class="src short"><a href="#v:atTip">atTip</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a></li><li class="src short"><a href="#v:trailingArithmetic">trailingArithmetic</a> :: <a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#t:Integer" title="Distribution.Compat.Prelude.Internal">Integer</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a></li><li class="src short"><a href="#v:sparseArithmetic">sparseArithmetic</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a></li><li class="src short"><a href="#v:defaultPolicy">defaultPolicy</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a></li><li class="src short"><a href="#v:gapSize">gapSize</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#t:Integer" title="Distribution.Compat.Prelude.Internal">Integer</a></li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:BlockHeight" class="def">BlockHeight</a> = <a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#t:Integer" title="Distribution.Compat.Prelude.Internal">Integer</a> <a href="src/Cardano.Wallet.Checkpoints.Policy.html#BlockHeight" class="link">Source</a> <a href="#t:BlockHeight" class="selflink">#</a></p></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:CheckpointPolicy" class="def">CheckpointPolicy</a> <a href="src/Cardano.Wallet.Checkpoints.Policy.html#CheckpointPolicy" class="link">Source</a> <a href="#t:CheckpointPolicy" class="selflink">#</a></p><div class="doc"><dl><dt>CheckpointPolicy</dt><dd></dd></dl><p>To save memory and time, we do not store every checkpoint.
Instead, a <code><a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a></code> determines which checkpoints
to store and which ones to discard.
The <code>extendAndPrune</code> functions consults such a policy and
drops checkpoints as it deems necessary.</p><p>A <code><a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a></code> determines whether a checkpoint is worth storing
only based on its block height. The boolean</p><p>keepWhereTip policy tip blockheight</p><p>indicates whether the checkpoint should be stored (<code><a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#v:True" title="Distribution.Compat.Prelude.Internal">True</a></code>) or
not (<code><a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#v:False" title="Distribution.Compat.Prelude.Internal">False</a></code>).
It is important that this function does not oscillate:
If <code>blockheight &lt;= tip</code>, the function result may change from <code><a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#v:True" title="Distribution.Compat.Prelude.Internal">True</a></code>
to <code><a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#v:False" title="Distribution.Compat.Prelude.Internal">False</a></code> as the <code>tip</code> increases, but not the other way round.
This is because we can only create checkpoints the first time we
read the corresponding block.</p><p>TODO:
The <code>Checkpoints</code> collection currently relies on <code>Slot</code> instead
of <code><a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a></code> to store checkpoints. We need to better integrate
this with <code><a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a></code>.</p><p>I (Heinrich) actually prefer <code>Slot</code>. However, not every slot contains a block,
and we would lose too many checkpoints if we based the decision of
whether to keep a checkpoint or not based on the slot number alone.
In contrast, block height is &quot;dense&quot;.</p></div><div class="subs instances"><h4 class="instances details-toggle-control details-toggle" data-details-id="i:CheckpointPolicy">Instances</h4><details id="i:CheckpointPolicy" open="open"><summary class="hide-when-js-enabled">Instances details</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:CheckpointPolicy:Semigroup:1"></span> <a href="../../Cabal/html/Distribution-Compat-Semigroup.html#t:Semigroup" title="Distribution.Compat.Semigroup">Semigroup</a> <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a></span> <a href="src/Cardano.Wallet.Checkpoints.Policy.html#line-105" class="link">Source</a> <a href="#t:CheckpointPolicy" class="selflink">#</a></td><td class="doc"><p>The combination of two <code><a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a></code> makes a checkpoint
 where at least one of the policies wants to make a checkpoint.</p></td></tr><tr><td colspan="2"><details id="i:id:CheckpointPolicy:Semigroup:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Cardano-Wallet-Checkpoints-Policy.html">Cardano.Wallet.Checkpoints.Policy</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:-60--62-">(&lt;&gt;)</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> <a href="../../ghc/html/libraries/base-4.14.3.0/src" class="link">Source</a> <a href="#v:-60--62-" class="selflink">#</a></p><p class="src"><a href="#v:sconcat">sconcat</a> :: <a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#t:NonEmpty" title="Distribution.Compat.Prelude.Internal">NonEmpty</a> <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> <a href="../../ghc/html/libraries/base-4.14.3.0/src" class="link">Source</a> <a href="#v:sconcat" class="selflink">#</a></p><p class="src"><a href="#v:stimes">stimes</a> :: <a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#t:Integral" title="Distribution.Compat.Prelude.Internal">Integral</a> b =&gt; b -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> <a href="../../ghc/html/libraries/base-4.14.3.0/src" class="link">Source</a> <a href="#v:stimes" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:CheckpointPolicy:Monoid:2"></span> <a href="../../Cabal/html/Distribution-Compat-Semigroup.html#t:Monoid" title="Distribution.Compat.Semigroup">Monoid</a> <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a></span> <a href="src/Cardano.Wallet.Checkpoints.Policy.html#line-113" class="link">Source</a> <a href="#t:CheckpointPolicy" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:CheckpointPolicy:Monoid:2"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Cardano-Wallet-Checkpoints-Policy.html">Cardano.Wallet.Checkpoints.Policy</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:mempty">mempty</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> <a href="../../ghc/html/libraries/base-4.14.3.0/src" class="link">Source</a> <a href="#v:mempty" class="selflink">#</a></p><p class="src"><a href="#v:mappend">mappend</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> <a href="../../ghc/html/libraries/base-4.14.3.0/src" class="link">Source</a> <a href="#v:mappend" class="selflink">#</a></p><p class="src"><a href="#v:mconcat">mconcat</a> :: [<a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a>] -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> <a href="../../ghc/html/libraries/base-4.14.3.0/src" class="link">Source</a> <a href="#v:mconcat" class="selflink">#</a></p></div></details></td></tr></table></details></div></div><div class="top"><p class="src"><a id="v:nextCheckpoint" class="def">nextCheckpoint</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#t:Maybe" title="Distribution.Compat.Prelude.Internal">Maybe</a> <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> <a href="src/Cardano.Wallet.Checkpoints.Policy.html#nextCheckpoint" class="link">Source</a> <a href="#v:nextCheckpoint" class="selflink">#</a></p><div class="doc"><p>Assuming that the tip of the chain is at block height <code>tip</code>,
 <code>nextCheckpoint policy tip height</code> returns the smallest
 <code>height'</code> satisfying @height' &gt;= height#
 at which the next checkpoint is to be made.</p></div></div><div class="top"><p class="src"><a id="v:keepWhereTip" class="def">keepWhereTip</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#t:Bool" title="Distribution.Compat.Prelude.Internal">Bool</a> <a href="src/Cardano.Wallet.Checkpoints.Policy.html#keepWhereTip" class="link">Source</a> <a href="#v:keepWhereTip" class="selflink">#</a></p><div class="doc"><p>Assuming that the tip of the chain is at block height <code>tip</code>,
 the value <code>keepWhereTip policy tip height</code>
 indicates whether a checkpoint should (<code><a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#v:True" title="Distribution.Compat.Prelude.Internal">True</a></code>) or should not (<code><a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#v:False" title="Distribution.Compat.Prelude.Internal">False</a></code>)
 be stored at <code>height</code>.</p></div></div><div class="top"><p class="src"><a id="v:toListAtTip" class="def">toListAtTip</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; [<a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a>] <a href="src/Cardano.Wallet.Checkpoints.Policy.html#toListAtTip" class="link">Source</a> <a href="#v:toListAtTip" class="selflink">#</a></p><div class="doc"><p>List all checkpoints for a given tip.</p></div></div><a href="#g:1" id="g:1"><h1>Construction</h1></a><div class="top"><p class="src"><a id="v:atGenesis" class="def">atGenesis</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> <a href="src/Cardano.Wallet.Checkpoints.Policy.html#atGenesis" class="link">Source</a> <a href="#v:atGenesis" class="selflink">#</a></p><div class="doc"><p>The <code><a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a></code> that keeps only the genesis block.</p></div></div><div class="top"><p class="src"><a id="v:atTip" class="def">atTip</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> <a href="src/Cardano.Wallet.Checkpoints.Policy.html#atTip" class="link">Source</a> <a href="#v:atTip" class="selflink">#</a></p><div class="doc"><p>The <code><a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a></code> that only keeps the tip of the chain.</p></div></div><div class="top"><p class="src"><a id="v:trailingArithmetic" class="def">trailingArithmetic</a> :: <a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#t:Integer" title="Distribution.Compat.Prelude.Internal">Integer</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> <a href="src/Cardano.Wallet.Checkpoints.Policy.html#trailingArithmetic" class="link">Source</a> <a href="#v:trailingArithmetic" class="selflink">#</a></p><div class="doc"><p><code>trailingArithmetic n height</code> keeps <code>n</code> checkpoints
 at block heights that are multiples of <code>height</code>
 and which are closest to the tip of the chain.
 (Fewer than <code>n</code> checkpoints are kept while the chain is too short
 to accommodate all checkpoints.)</p></div></div><div class="top"><p class="src"><a id="v:sparseArithmetic" class="def">sparseArithmetic</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> <a href="src/Cardano.Wallet.Checkpoints.Policy.html#sparseArithmetic" class="link">Source</a> <a href="#v:sparseArithmetic" class="selflink">#</a></p><div class="doc"><p>Note [sparseArithmeticPolicy]</p><p>The <code><a href="Cardano-Wallet-Checkpoints-Policy.html#v:sparseArithmetic" title="Cardano.Wallet.Checkpoints.Policy">sparseArithmetic</a></code> checkpoint policy contains essentially two
sets of checkpoints: One fairly dense set near the tip of the chain
in order to handle frequent potential rollbacks, and one sparse
set that spans the entire epoch stability window. These two sets
are arranged as arithmetic sequences.</p><p>This policy is motivated by the following observations:</p><ul><li>We can't rollback for more than `k = epochStability` blocks in the past</li><li>It is pretty fast to re-sync a few hundred blocks</li><li>Small rollbacks near the tip may occur more often than long ones</li></ul><p>Hence, we should strive to</p><ul><li>Prune any checkpoint that are more than <code>k</code> blocks in the past</li><li>Keep only one checkpoint every <code>largeGap</code> ~100 blocks</li><li>But still keep ~10 most recent checkpoints to cope with small rollbacks.</li></ul><p>Roughly, the <code><a href="Cardano-Wallet-Checkpoints-Policy.html#v:sparseArithmetic" title="Cardano.Wallet.Checkpoints.Policy">sparseArithmetic</a></code></p><p>0 ..... N*largeGap .... (N+1)*largeGap .. .. M*smallGap (M+1)*smallGap tip
        |_______________________________________________________________|
                 epochStability</p><p>Note: In the event where chain following &quot;fails completely&quot; (because, for
example, the node has switch to a different chain, different by more than <code>k</code>),
we have no choice but rolling back from genesis.
Therefore, we need to keep the very first checkpoint in the database, no
matter what.</p></div></div><div class="top"><p class="src"><a id="v:defaultPolicy" class="def">defaultPolicy</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a> <a href="src/Cardano.Wallet.Checkpoints.Policy.html#defaultPolicy" class="link">Source</a> <a href="#v:defaultPolicy" class="selflink">#</a></p><div class="doc"><p>A sensible default checkpoint policy; currently <code><a href="Cardano-Wallet-Checkpoints-Policy.html#v:sparseArithmetic" title="Cardano.Wallet.Checkpoints.Policy">sparseArithmetic</a></code>.</p></div></div><div class="top"><p class="src"><a id="v:gapSize" class="def">gapSize</a> :: <a href="Cardano-Wallet-Checkpoints-Policy.html#t:BlockHeight" title="Cardano.Wallet.Checkpoints.Policy">BlockHeight</a> -&gt; <a href="../../Cabal/html/Distribution-Compat-Prelude-Internal.html#t:Integer" title="Distribution.Compat.Prelude.Internal">Integer</a> <a href="src/Cardano.Wallet.Checkpoints.Policy.html#gapSize" class="link">Source</a> <a href="#v:gapSize" class="selflink">#</a></p><div class="doc"><p>A reasonable gap size used internally in <code>sparseArithmeticPolicy</code>.</p><p><code>Reasonable</code> means that it's not _too frequent_ and it's not too large. A
value that is too small in front of k would require generating much more
checkpoints than necessary.</p><p>A value that is larger than <code>k</code> may have dramatic consequences in case of
deep rollbacks.</p><p>As a middle ground, we current choose `k / 3`, which is justified by:</p><ul><li>The current bandwidth of the network layer (several thousands blocks per seconds)</li><li>The current value of k = 2160</li></ul><p>So, `k / 3` = 720, which corresponds to around a second of time needed to catch
up in case of large rollbacks (if our local node has caught up already).</p></div></div><a href="#g:2" id="g:2"><h1>Internal invariants</h1></a><div class="doc"><p>Internal invariants of the <code><a href="Cardano-Wallet-Checkpoints-Policy.html#t:CheckpointPolicy" title="Cardano.Wallet.Checkpoints.Policy">CheckpointPolicy</a></code> type:</p><ul><li><code>prop_monotonicHeight</code> &#8212; <code><a href="Cardano-Wallet-Checkpoints-Policy.html#v:nextCheckpoint" title="Cardano.Wallet.Checkpoints.Policy">nextCheckpoint</a></code> returns the same height
  for all heights between a given height and the height returned.</li><li>prop_monotonicTip' &#8212; when increasing the <code>tip</code> height, <code><a href="Cardano-Wallet-Checkpoints-Policy.html#v:nextCheckpoint" title="Cardano.Wallet.Checkpoints.Policy">nextCheckpoint</a></code>
  will never return a blockheight that is smaller.</li></ul></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.24.2</p></div></body></html>