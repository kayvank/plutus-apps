<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DuplicateRecordFields #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE OverloadedLabels #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-orphans #-}</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- Copyright: &#169; 2021 IOHK</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- License: Apache-2.0</span><span>
</span><span id="line-21"></span><span class="hs-comment">--</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- 'Store' implementations that can store various wallet types</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- in an SQLite database using `persistent`.</span><span>
</span><span id="line-24"></span><span class="hs-comment">--</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- FIXME LATER during ADP-1043:</span><span>
</span><span id="line-26"></span><span class="hs-comment">--</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- * Inline the contents of this module into its new name</span><span>
</span><span id="line-28"></span><span class="hs-comment">--   &quot;Cardano.Wallet.DB.Sqlite.Stores&quot;</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Cardano.Wallet.DB.Store.Checkpoints</span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkStoreWallets"><span class="hs-identifier">mkStoreWallets</span></a></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier">PersistAddressBook</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#blockHeaderFromEntity"><span class="hs-identifier">blockHeaderFromEntity</span></a></span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Testing</span></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkStoreWallet"><span class="hs-identifier">mkStoreWallet</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Prelude</span></a></span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier">Cardano.Address.Derivation</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier">XPub</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier">Cardano.Address.Script</span></a></span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier">Cosigner</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier">ScriptTemplate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html"><span class="hs-identifier">Cardano.DB.Sqlite</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#dbChunked"><span class="hs-identifier">dbChunked</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Address.Book.html"><span class="hs-identifier">Cardano.Wallet.Address.Book</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#AddressBookIso"><span class="hs-identifier">AddressBookIso</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#Discoveries"><span class="hs-identifier">Discoveries</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#Prologue"><span class="hs-identifier">Prologue</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#SeqAddressMap"><span class="hs-identifier">SeqAddressMap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#SharedAddressMap"><span class="hs-identifier">SharedAddressMap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html"><span class="hs-identifier">Cardano.Wallet.Checkpoints</span></a></span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#DeltaCheckpoints"><span class="hs-identifier">DeltaCheckpoints</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#DeltasCheckpoints"><span class="hs-identifier">DeltasCheckpoints</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#loadCheckpoints"><span class="hs-identifier">loadCheckpoints</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.html"><span class="hs-identifier">Cardano.Wallet.DB</span></a></span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.html#ErrBadFormat"><span class="hs-identifier">ErrBadFormat</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html"><span class="hs-identifier">Cardano.Wallet.DB.Sqlite.Schema</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Checkpoint"><span class="hs-identifier">Checkpoint</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CosignerKey"><span class="hs-identifier">CosignerKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">EntityField</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">Key</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndState"><span class="hs-identifier">RndState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndStateAddress"><span class="hs-identifier">RndStateAddress</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndStatePendingAddress"><span class="hs-identifier">RndStatePendingAddress</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqState"><span class="hs-identifier">SeqState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddress"><span class="hs-identifier">SeqStateAddress</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStatePendingIx"><span class="hs-identifier">SeqStatePendingIx</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SharedState"><span class="hs-identifier">SharedState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SharedStatePendingIx"><span class="hs-identifier">SharedStatePendingIx</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UTxO"><span class="hs-identifier">UTxO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UTxOToken"><span class="hs-identifier">UTxOToken</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Wallet"><span class="hs-identifier">Wallet</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html"><span class="hs-identifier">Cardano.Wallet.DB.Sqlite.Types</span></a></span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#BlockId"><span class="hs-identifier">BlockId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#HDPassphrase"><span class="hs-identifier">HDPassphrase</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#TxId"><span class="hs-identifier">TxId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#fromMaybeHash"><span class="hs-identifier">fromMaybeHash</span></a></span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#hashOfNoParent"><span class="hs-identifier">hashOfNoParent</span></a></span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#toMaybeHash"><span class="hs-identifier">toMaybeHash</span></a></span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html"><span class="hs-identifier">Cardano.Wallet.DB.WalletState</span></a></span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier">DeltaMap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#DeltaWalletState"><span class="hs-identifier">DeltaWalletState</span></a></span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#DeltaWalletState1"><span class="hs-identifier">DeltaWalletState1</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#WalletCheckpoint"><span class="hs-identifier">WalletCheckpoint</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#WalletState"><span class="hs-identifier">WalletState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#getSlot"><span class="hs-identifier">getSlot</span></a></span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html"><span class="hs-identifier">Cardano.Wallet.Primitive.AddressDerivation</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Depth"><span class="hs-identifier">Depth</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#MkKeyFingerprint"><span class="hs-identifier">MkKeyFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PaymentAddress"><span class="hs-identifier">PaymentAddress</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPublicKey"><span class="hs-identifier">PersistPublicKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Role"><span class="hs-identifier">Role</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#SoftDerivation"><span class="hs-identifier">SoftDerivation</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#WalletKey"><span class="hs-identifier">WalletKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#roleVal"><span class="hs-identifier">roleVal</span></a></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.SharedKey.html"><span class="hs-identifier">Cardano.Wallet.Primitive.AddressDerivation.SharedKey</span></a></span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.SharedKey.html#SharedKey"><span class="hs-identifier">SharedKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html"><span class="hs-identifier">Cardano.Wallet.Primitive.AddressDiscovery</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier">PendingIxs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#pendingIxsFromList"><span class="hs-identifier">pendingIxsFromList</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#pendingIxsToList"><span class="hs-identifier">pendingIxsToList</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html"><span class="hs-identifier">Cardano.Wallet.Primitive.AddressDiscovery.Shared</span></a></span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#CredentialType"><span class="hs-identifier">CredentialType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.TokenBundle.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.TokenBundle</span></a></span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.TokenBundle.html#TokenBundle"><span class="hs-identifier">TokenBundle</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.TokenMap.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.TokenMap</span></a></span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.TokenMap.html#AssetId"><span class="hs-identifier">AssetId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">forM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">forM_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">unless</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">void</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">when</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">Control.Monad.Trans.Class</span></a></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">lift</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">Control.Monad.Trans.Except</span></a></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">ExceptT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">runExceptT</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">Control.Monad.Trans.Maybe</span></a></span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">MaybeT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Bifunctor</span></a></span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">bimap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">second</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier">Data.DBVar</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier">Store</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Functor</span></a></span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&lt;&amp;&gt;)</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../generic-lens/html/src"><span class="hs-identifier">Data.Generics.Internal.VL.Lens</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../generic-lens/html/src"><span class="hs-identifier">view</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../generic-lens/html/src"><span class="hs-operator">(^.)</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Kind</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier">Type</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Map</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">fromJust</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">isJust</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">isNothing</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Proxy</span></a></span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Proxy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Quantity.html"><span class="hs-identifier">Data.Quantity</span></a></span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier">Quantity</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Type.Equality</span></a></span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(==)</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Typeable</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Typeable</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">Database.Persist.Sql</span></a></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">Entity</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">SelectOpt</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">deleteWhere</span></a></span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">insertMany_</span></a></span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">insert_</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">repsert</span></a></span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">selectFirst</span></a></span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">selectList</span></a></span><span>
</span><span id="line-151"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-operator">(!=.)</span></a></span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-operator">(/&lt;-.)</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-operator">(==.)</span></a></span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-operator">(&gt;.)</span></a></span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../persistent-sqlite/html/src"><span class="hs-identifier">Database.Persist.Sqlite</span></a></span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">SqlPersistT</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../unliftio/html/src"><span class="hs-identifier">UnliftIO.Exception</span></a></span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">toException</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html"><span class="hs-identifier">Cardano.Wallet.Primitive.AddressDerivation</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-162"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Random.html"><span class="hs-identifier">Cardano.Wallet.Primitive.AddressDiscovery.Random</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Rnd</span></span><span>
</span><span id="line-163"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html"><span class="hs-identifier">Cardano.Wallet.Primitive.AddressDiscovery.Sequential</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Seq</span></span><span>
</span><span id="line-164"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html"><span class="hs-identifier">Cardano.Wallet.Primitive.AddressDiscovery.Shared</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Shared</span></span><span>
</span><span id="line-165"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-166"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.Address</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-167"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Coin.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.Coin</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-168"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.TokenBundle.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.TokenBundle</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TokenBundle</span></span><span>
</span><span id="line-169"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.Tx</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-170"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.UTxO.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.UTxO</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-171"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Merge.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-172"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    WalletState Store
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-177"></span><span class="hs-comment">-- | Store for 'WalletState' of multiple different wallets.</span><span>
</span><span id="line-178"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkStoreWallets"><span class="hs-identifier hs-type">mkStoreWallets</span></a></span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682486464"><span class="annot"><a href="#local-6989586621682486464"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621682486463"><span class="annot"><a href="#local-6989586621682486463"><span class="hs-identifier hs-type">key</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486464"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682486463"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-type">DeltaMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486463"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#DeltaWalletState"><span class="hs-identifier hs-type">DeltaWalletState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486464"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span id="mkStoreWallets"><span class="annot"><span class="annottext">mkStoreWallets :: Store (SqlPersistT IO) (DeltaMap key (DeltaWalletState s))
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkStoreWallets"><span class="hs-identifier hs-var hs-var">mkStoreWallets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store :: forall (m :: * -&gt; *) da.
m (Either SomeException (Base da))
-&gt; (Base da -&gt; m ()) -&gt; (Base da -&gt; da -&gt; m ()) -&gt; Store m da
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-type">Store</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">loadS :: SqlPersistT
  IO
  (Either SomeException (Base (DeltaMap key (DeltaWalletState s))))
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">loadS</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">ReaderT
  SqlBackend IO (Either SomeException (Map WalletId (WalletState s)))
SqlPersistT
  IO
  (Either SomeException (Base (DeltaMap key (DeltaWalletState s))))
</span><a href="#local-6989586621682486460"><span class="hs-identifier hs-var">load</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">writeS :: Base (DeltaMap key (DeltaWalletState s)) -&gt; SqlPersistT IO ()
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">writeS</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">Base (DeltaMap key (DeltaWalletState s)) -&gt; SqlPersistT IO ()
forall a. a
</span><a href="#local-6989586621682486458"><span class="hs-identifier hs-var">write</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">updateS :: Base (DeltaMap key (DeltaWalletState s))
-&gt; DeltaMap key (DeltaWalletState s) -&gt; SqlPersistT IO ()
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">updateS</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">Base (DeltaMap key (DeltaWalletState s))
-&gt; DeltaMap key (DeltaWalletState s) -&gt; SqlPersistT IO ()
forall s p.
PersistAddressBook s =&gt;
p -&gt; DeltaMap WalletId (DeltaWalletState s) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486456"><span class="hs-identifier hs-var">update</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-184"></span><span>    </span><span id="local-6989586621682486458"><span class="annot"><span class="annottext">write :: a
</span><a href="#local-6989586621682486458"><span class="hs-identifier hs-var hs-var">write</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; a
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;mkStoreWalletsCheckpoints: not implemented&quot;</span></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span>    </span><span id="local-6989586621682486456"><span class="annot"><span class="annottext">update :: p -&gt; DeltaMap WalletId (DeltaWalletState s) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486456"><span class="hs-identifier hs-var hs-var">update</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-type">Insert</span></a></span><span> </span><span id="local-6989586621682486453"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486453"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682486452"><span class="annot"><span class="annottext">Base (DeltaWalletState s)
</span><a href="#local-6989586621682486452"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-187"></span><span>        </span><span class="annot"><span class="annottext">Store (SqlPersistT IO) (DeltaWalletState s)
-&gt; Base (DeltaWalletState s) -&gt; SqlPersistT IO ()
forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; m ()
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var hs-var">writeS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; Store (SqlPersistT IO) (DeltaWalletState s)
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; Store (SqlPersistT IO) (DeltaWalletState s)
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkStoreWallet"><span class="hs-identifier hs-var">mkStoreWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486453"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Base (DeltaWalletState s)
</span><a href="#local-6989586621682486452"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-188"></span><span>    </span><span class="annot"><a href="#local-6989586621682486456"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-type">Delete</span></a></span><span> </span><span id="local-6989586621682486450"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486450"><span class="hs-identifier hs-var">wid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>        </span><span class="hs-comment">-- FIXME LATER during ADP-1043:</span><span>
</span><span id="line-190"></span><span>        </span><span class="hs-comment">--  Deleting an entry in the Checkpoint table</span><span>
</span><span id="line-191"></span><span>        </span><span class="hs-comment">--  will trigger a delete cascade. We want this cascade</span><span>
</span><span id="line-192"></span><span>        </span><span class="hs-comment">--  to be explicit in our code.</span><span>
</span><span id="line-193"></span><span>        </span><span class="annot"><span class="annottext">[Filter Checkpoint] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointWalletId"><span class="hs-identifier hs-var">CheckpointWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId -&gt; WalletId -&gt; Filter Checkpoint
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486450"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><a href="#local-6989586621682486456"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-type">Adjust</span></a></span><span> </span><span id="local-6989586621682486447"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486447"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682486446"><span class="annot"><span class="annottext">DeltaWalletState s
</span><a href="#local-6989586621682486446"><span class="hs-identifier hs-var">da</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-195"></span><span>        </span><span class="annot"><span class="annottext">Store (SqlPersistT IO) (DeltaWalletState s)
-&gt; Base (DeltaWalletState s)
-&gt; DeltaWalletState s
-&gt; SqlPersistT IO ()
forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; da -&gt; m ()
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var hs-var">updateS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; Store (SqlPersistT IO) (DeltaWalletState s)
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; Store (SqlPersistT IO) (DeltaWalletState s)
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkStoreWallet"><span class="hs-identifier hs-var">mkStoreWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486447"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Base (DeltaWalletState s)
forall a. HasCallStack =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">undefined</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaWalletState s
</span><a href="#local-6989586621682486446"><span class="hs-identifier hs-var">da</span></a></span><span>
</span><span id="line-196"></span><span>        </span><span class="hs-comment">-- FIXME LATER during ADP-1043:</span><span>
</span><span id="line-197"></span><span>        </span><span class="hs-comment">--   Remove 'undefined'.</span><span>
</span><span id="line-198"></span><span>        </span><span class="hs-comment">--   Probably needs a change to 'Data.DBVar.updateS'</span><span>
</span><span id="line-199"></span><span>        </span><span class="hs-comment">--   to take a 'Maybe a' as parameter instead of an 'a'.</span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span>    </span><span id="local-6989586621682486460"><span class="annot"><span class="annottext">load :: ReaderT
  SqlBackend IO (Either SomeException (Map WalletId (WalletState s)))
</span><a href="#local-6989586621682486460"><span class="hs-identifier hs-var hs-var">load</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-202"></span><span>        </span><span id="local-6989586621682486444"><span class="annot"><span class="annottext">[WalletId]
</span><a href="#local-6989586621682486444"><span class="hs-identifier hs-var">wids</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Entity Wallet -&gt; WalletId) -&gt; [Entity Wallet] -&gt; [WalletId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((WalletId -&gt; Const WalletId WalletId)
 -&gt; Wallet -&gt; Const WalletId Wallet)
-&gt; Wallet -&gt; WalletId
forall a s. ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; s -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;walId&quot;
  ((WalletId -&gt; Const WalletId WalletId)
   -&gt; Wallet -&gt; Const WalletId Wallet)
(WalletId -&gt; Const WalletId WalletId)
-&gt; Wallet -&gt; Const WalletId Wallet
</span><a href="#local-6989586621682486443"><span class="hs-var">#walId</span></a></span><span> </span><span class="annot"><span class="annottext">(Wallet -&gt; WalletId)
-&gt; (Entity Wallet -&gt; Wallet) -&gt; Entity Wallet -&gt; WalletId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity Wallet -&gt; Wallet
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Entity Wallet] -&gt; [WalletId])
-&gt; ReaderT SqlBackend IO [Entity Wallet]
-&gt; ReaderT SqlBackend IO [WalletId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO [Entity Wallet]
</span><a href="#local-6989586621682486439"><span class="hs-identifier hs-var">selectAll</span></a></span><span>
</span><span id="line-203"></span><span>        </span><span class="annot"><span class="annottext">ExceptT
  SomeException (SqlPersistT IO) (Map WalletId (WalletState s))
-&gt; ReaderT
     SqlBackend IO (Either SomeException (Map WalletId (WalletState s)))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   SomeException (SqlPersistT IO) (Map WalletId (WalletState s))
 -&gt; ReaderT
      SqlBackend
      IO
      (Either SomeException (Map WalletId (WalletState s))))
-&gt; ExceptT
     SomeException (SqlPersistT IO) (Map WalletId (WalletState s))
-&gt; ReaderT
     SqlBackend IO (Either SomeException (Map WalletId (WalletState s)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-204"></span><span>            </span><span id="local-6989586621682486438"><span class="annot"><span class="annottext">[WalletState s]
</span><a href="#local-6989586621682486438"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[WalletId]
-&gt; (WalletId
    -&gt; ExceptT SomeException (SqlPersistT IO) (WalletState s))
-&gt; ExceptT SomeException (SqlPersistT IO) [WalletState s]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM</span></a></span><span> </span><span class="annot"><span class="annottext">[WalletId]
</span><a href="#local-6989586621682486444"><span class="hs-identifier hs-var">wids</span></a></span><span> </span><span class="annot"><span class="annottext">((WalletId
  -&gt; ExceptT SomeException (SqlPersistT IO) (WalletState s))
 -&gt; ExceptT SomeException (SqlPersistT IO) [WalletState s])
-&gt; (WalletId
    -&gt; ExceptT SomeException (SqlPersistT IO) (WalletState s))
-&gt; ExceptT SomeException (SqlPersistT IO) [WalletState s]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either SomeException (WalletState s))
-&gt; ExceptT SomeException (SqlPersistT IO) (WalletState s)
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either SomeException (WalletState s))
 -&gt; ExceptT SomeException (SqlPersistT IO) (WalletState s))
-&gt; (WalletId
    -&gt; ReaderT SqlBackend IO (Either SomeException (WalletState s)))
-&gt; WalletId
-&gt; ExceptT SomeException (SqlPersistT IO) (WalletState s)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Store (SqlPersistT IO) (DeltaWalletState s)
-&gt; ReaderT SqlBackend IO (Either SomeException (WalletState s))
forall (m :: * -&gt; *) da.
Store m da -&gt; m (Either SomeException (Base da))
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var hs-var">loadS</span></a></span><span> </span><span class="annot"><span class="annottext">(Store (SqlPersistT IO) (DeltaWalletState s)
 -&gt; ReaderT SqlBackend IO (Either SomeException (WalletState s)))
-&gt; (WalletId -&gt; Store (SqlPersistT IO) (DeltaWalletState s))
-&gt; WalletId
-&gt; ReaderT SqlBackend IO (Either SomeException (WalletState s))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; Store (SqlPersistT IO) (DeltaWalletState s)
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; Store (SqlPersistT IO) (DeltaWalletState s)
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkStoreWallet"><span class="hs-identifier hs-var">mkStoreWallet</span></a></span><span>
</span><span id="line-205"></span><span>            </span><span class="annot"><span class="annottext">Map WalletId (WalletState s)
-&gt; ExceptT
     SomeException (SqlPersistT IO) (Map WalletId (WalletState s))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Map WalletId (WalletState s)
 -&gt; ExceptT
      SomeException (SqlPersistT IO) (Map WalletId (WalletState s)))
-&gt; Map WalletId (WalletState s)
-&gt; ExceptT
     SomeException (SqlPersistT IO) (Map WalletId (WalletState s))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[(WalletId, WalletState s)] -&gt; Map WalletId (WalletState s)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[WalletId] -&gt; [WalletState s] -&gt; [(WalletId, WalletState s)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">zip</span></a></span><span> </span><span class="annot"><span class="annottext">[WalletId]
</span><a href="#local-6989586621682486444"><span class="hs-identifier hs-var">wids</span></a></span><span> </span><span class="annot"><span class="annottext">[WalletState s]
</span><a href="#local-6989586621682486438"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-207"></span><span>        </span><span class="annot"><a href="#local-6989586621682486439"><span class="hs-identifier hs-type">selectAll</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Entity</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Wallet"><span class="hs-identifier hs-type">Wallet</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-208"></span><span>        </span><span id="local-6989586621682486439"><span class="annot"><span class="annottext">selectAll :: ReaderT SqlBackend IO [Entity Wallet]
</span><a href="#local-6989586621682486439"><span class="hs-identifier hs-var hs-var">selectAll</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Filter Wallet]
-&gt; [SelectOpt Wallet] -&gt; ReaderT SqlBackend IO [Entity Wallet]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span class="hs-comment">-- | Store for 'WalletState' of a single wallet.</span><span>
</span><span id="line-211"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkStoreWallet"><span class="hs-identifier hs-type">mkStoreWallet</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682486877"><span class="annot"><a href="#local-6989586621682486877"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486877"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#DeltaWalletState"><span class="hs-identifier hs-type">DeltaWalletState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486877"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span id="mkStoreWallet"><span class="annot"><span class="annottext">mkStoreWallet :: WalletId -&gt; Store (SqlPersistT IO) (DeltaWalletState s)
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkStoreWallet"><span class="hs-identifier hs-var hs-var">mkStoreWallet</span></a></span></span><span> </span><span id="local-6989586621682486435"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486435"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><span class="annottext">Store :: forall (m :: * -&gt; *) da.
m (Either SomeException (Base da))
-&gt; (Base da -&gt; m ()) -&gt; (Base da -&gt; da -&gt; m ()) -&gt; Store m da
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-type">Store</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">loadS :: SqlPersistT IO (Either SomeException (Base (DeltaWalletState s)))
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">loadS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Either SomeException (Base (DeltaWalletState s)))
ReaderT SqlBackend IO (Either SomeException (WalletState s))
</span><a href="#local-6989586621682486434"><span class="hs-identifier hs-var">load</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">writeS :: Base (DeltaWalletState s) -&gt; SqlPersistT IO ()
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">writeS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Base (DeltaWalletState s) -&gt; SqlPersistT IO ()
WalletState s -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486433"><span class="hs-identifier hs-var">write</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">updateS :: Base (DeltaWalletState s)
-&gt; DeltaWalletState s -&gt; SqlPersistT IO ()
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Base (DeltaWalletState s)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DeltaWalletState s -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486432"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-218"></span><span>    </span><span id="local-6989586621682486431"><span class="annot"><span class="annottext">storeCheckpoints :: Store (SqlPersistT IO) (DeltasCheckpoints (WalletCheckpoint s))
</span><a href="#local-6989586621682486431"><span class="hs-identifier hs-var hs-var">storeCheckpoints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; Store (SqlPersistT IO) (DeltasCheckpoints (WalletCheckpoint s))
forall s.
PersistAddressBook s =&gt;
WalletId
-&gt; Store (SqlPersistT IO) (DeltasCheckpoints (WalletCheckpoint s))
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkStoreCheckpoints"><span class="hs-identifier hs-var">mkStoreCheckpoints</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486435"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span>    </span><span id="local-6989586621682486434"><span class="annot"><span class="annottext">load :: ReaderT SqlBackend IO (Either SomeException (WalletState s))
</span><a href="#local-6989586621682486434"><span class="hs-identifier hs-var hs-var">load</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-221"></span><span>        </span><span id="local-6989586621682486429"><span class="annot"><span class="annottext">Either SomeException (Prologue s)
</span><a href="#local-6989586621682486429"><span class="hs-identifier hs-var">eprologue</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either SomeException (Prologue s)
-&gt; (Prologue s -&gt; Either SomeException (Prologue s))
-&gt; Maybe (Prologue s)
-&gt; Either SomeException (Prologue s)
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; Either SomeException (Prologue s)
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; Either SomeException (Prologue s))
-&gt; SomeException -&gt; Either SomeException (Prologue s)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrBadFormat -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toException</span></a></span><span> </span><span class="annot"><span class="annottext">ErrBadFormat
</span><a href="Cardano.Wallet.DB.html#ErrBadFormatAddressPrologue"><span class="hs-identifier hs-var">ErrBadFormatAddressPrologue</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Prologue s -&gt; Either SomeException (Prologue s)
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span>
</span><span id="line-222"></span><span>            </span><span class="annot"><span class="annottext">(Maybe (Prologue s) -&gt; Either SomeException (Prologue s))
-&gt; ReaderT SqlBackend IO (Maybe (Prologue s))
-&gt; ReaderT SqlBackend IO (Either SomeException (Prologue s))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ReaderT SqlBackend IO (Maybe (Prologue s))
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; SqlPersistT IO (Maybe (Prologue s))
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#loadPrologue"><span class="hs-identifier hs-var">loadPrologue</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486435"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-223"></span><span>        </span><span id="local-6989586621682486425"><span class="annot"><span class="annottext">Either SomeException (Checkpoints (WalletCheckpoint s))
</span><a href="#local-6989586621682486425"><span class="hs-identifier hs-var">echeckpoints</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Store (SqlPersistT IO) (DeltasCheckpoints (WalletCheckpoint s))
-&gt; SqlPersistT
     IO
     (Either
        SomeException (Base (DeltasCheckpoints (WalletCheckpoint s))))
forall (m :: * -&gt; *) da.
Store m da -&gt; m (Either SomeException (Base da))
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var hs-var">loadS</span></a></span><span> </span><span class="annot"><span class="annottext">Store (SqlPersistT IO) (DeltasCheckpoints (WalletCheckpoint s))
</span><a href="#local-6989586621682486431"><span class="hs-identifier hs-var">storeCheckpoints</span></a></span><span>
</span><span id="line-224"></span><span>        </span><span class="annot"><span class="annottext">Either SomeException (WalletState s)
-&gt; ReaderT SqlBackend IO (Either SomeException (WalletState s))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (WalletState s)
 -&gt; ReaderT SqlBackend IO (Either SomeException (WalletState s)))
-&gt; Either SomeException (WalletState s)
-&gt; ReaderT SqlBackend IO (Either SomeException (WalletState s))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Prologue s -&gt; Checkpoints (WalletCheckpoint s) -&gt; WalletState s
forall s.
Prologue s -&gt; Checkpoints (WalletCheckpoint s) -&gt; WalletState s
</span><a href="Cardano.Wallet.DB.WalletState.html#WalletState"><span class="hs-identifier hs-var">WalletState</span></a></span><span> </span><span class="annot"><span class="annottext">(Prologue s -&gt; Checkpoints (WalletCheckpoint s) -&gt; WalletState s)
-&gt; Either SomeException (Prologue s)
-&gt; Either
     SomeException (Checkpoints (WalletCheckpoint s) -&gt; WalletState s)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Either SomeException (Prologue s)
</span><a href="#local-6989586621682486429"><span class="hs-identifier hs-var">eprologue</span></a></span><span> </span><span class="annot"><span class="annottext">Either
  SomeException (Checkpoints (WalletCheckpoint s) -&gt; WalletState s)
-&gt; Either SomeException (Checkpoints (WalletCheckpoint s))
-&gt; Either SomeException (WalletState s)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Either SomeException (Checkpoints (WalletCheckpoint s))
</span><a href="#local-6989586621682486425"><span class="hs-identifier hs-var">echeckpoints</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span>    </span><span id="local-6989586621682486433"><span class="annot"><span class="annottext">write :: WalletState s -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486433"><span class="hs-identifier hs-var hs-var">write</span></a></span></span><span> </span><span id="local-6989586621682486423"><span class="annot"><span class="annottext">WalletState s
</span><a href="#local-6989586621682486423"><span class="hs-identifier hs-var">wallet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-227"></span><span>        </span><span class="annot"><span class="annottext">WalletId -&gt; Prologue s -&gt; SqlPersistT IO ()
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; Prologue s -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertPrologue"><span class="hs-identifier hs-var">insertPrologue</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486435"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletState s
</span><a href="#local-6989586621682486423"><span class="hs-identifier hs-var">wallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletState s
-&gt; ((Prologue s -&gt; Const (Prologue s) (Prologue s))
    -&gt; WalletState s -&gt; Const (Prologue s) (WalletState s))
-&gt; Prologue s
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;prologue&quot;
  ((Prologue s -&gt; Const (Prologue s) (Prologue s))
   -&gt; WalletState s -&gt; Const (Prologue s) (WalletState s))
(Prologue s -&gt; Const (Prologue s) (Prologue s))
-&gt; WalletState s -&gt; Const (Prologue s) (WalletState s)
</span><a href="#local-6989586621682486421"><span class="hs-var">#prologue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span>        </span><span class="annot"><span class="annottext">Store (SqlPersistT IO) (DeltasCheckpoints (WalletCheckpoint s))
-&gt; Base (DeltasCheckpoints (WalletCheckpoint s))
-&gt; SqlPersistT IO ()
forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; m ()
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var hs-var">writeS</span></a></span><span> </span><span class="annot"><span class="annottext">Store (SqlPersistT IO) (DeltasCheckpoints (WalletCheckpoint s))
</span><a href="#local-6989586621682486431"><span class="hs-identifier hs-var">storeCheckpoints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletState s
</span><a href="#local-6989586621682486423"><span class="hs-identifier hs-var">wallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletState s
-&gt; ((Checkpoints (WalletCheckpoint s)
     -&gt; Const
          (Checkpoints (WalletCheckpoint s))
          (Checkpoints (WalletCheckpoint s)))
    -&gt; WalletState s
    -&gt; Const (Checkpoints (WalletCheckpoint s)) (WalletState s))
-&gt; Checkpoints (WalletCheckpoint s)
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;checkpoints&quot;
  ((Checkpoints (WalletCheckpoint s)
    -&gt; Const
         (Checkpoints (WalletCheckpoint s))
         (Checkpoints (WalletCheckpoint s)))
   -&gt; WalletState s
   -&gt; Const (Checkpoints (WalletCheckpoint s)) (WalletState s))
(Checkpoints (WalletCheckpoint s)
 -&gt; Const
      (Checkpoints (WalletCheckpoint s))
      (Checkpoints (WalletCheckpoint s)))
-&gt; WalletState s
-&gt; Const (Checkpoints (WalletCheckpoint s)) (WalletState s)
</span><a href="#local-6989586621682486420"><span class="hs-var">#checkpoints</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span>    </span><span id="local-6989586621682486432"><span class="annot"><span class="annottext">update :: DeltaWalletState s -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486432"><span class="hs-identifier hs-var hs-var">update</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-231"></span><span>         </span><span class="hs-comment">-- first update in list is last to be applied!</span><span>
</span><span id="line-232"></span><span>        </span><span class="annot"><span class="annottext">(DeltaWalletState1 s -&gt; SqlPersistT IO ())
-&gt; DeltaWalletState s -&gt; SqlPersistT IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaWalletState1 s -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486418"><span class="hs-identifier hs-var">update1</span></a></span><span> </span><span class="annot"><span class="annottext">(DeltaWalletState s -&gt; SqlPersistT IO ())
-&gt; (DeltaWalletState s -&gt; DeltaWalletState s)
-&gt; DeltaWalletState s
-&gt; SqlPersistT IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaWalletState s -&gt; DeltaWalletState s
forall a. [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">reverse</span></a></span><span>
</span><span id="line-233"></span><span>    </span><span id="local-6989586621682486418"><span class="annot"><span class="annottext">update1 :: DeltaWalletState1 s -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486418"><span class="hs-identifier hs-var hs-var">update1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#ReplacePrologue"><span class="hs-identifier hs-type">ReplacePrologue</span></a></span><span> </span><span id="local-6989586621682486415"><span class="annot"><span class="annottext">Prologue s
</span><a href="#local-6989586621682486415"><span class="hs-identifier hs-var">prologue</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-234"></span><span>        </span><span class="annot"><span class="annottext">WalletId -&gt; Prologue s -&gt; SqlPersistT IO ()
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; Prologue s -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertPrologue"><span class="hs-identifier hs-var">insertPrologue</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486435"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Prologue s
</span><a href="#local-6989586621682486415"><span class="hs-identifier hs-var">prologue</span></a></span><span>
</span><span id="line-235"></span><span>    </span><span class="annot"><a href="#local-6989586621682486418"><span class="hs-identifier hs-var">update1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#UpdateCheckpoints"><span class="hs-identifier hs-type">UpdateCheckpoints</span></a></span><span> </span><span id="local-6989586621682486413"><span class="annot"><span class="annottext">DeltasCheckpoints (WalletCheckpoint s)
</span><a href="#local-6989586621682486413"><span class="hs-identifier hs-var">delta</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-236"></span><span>        </span><span class="hs-comment">-- FIXME LATER during ADP-1043: remove 'undefined'</span><span>
</span><span id="line-237"></span><span>        </span><span class="annot"><span class="annottext">Store (SqlPersistT IO) (DeltasCheckpoints (WalletCheckpoint s))
-&gt; Base (DeltasCheckpoints (WalletCheckpoint s))
-&gt; DeltasCheckpoints (WalletCheckpoint s)
-&gt; SqlPersistT IO ()
forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; da -&gt; m ()
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var hs-var">updateS</span></a></span><span> </span><span class="annot"><span class="annottext">Store (SqlPersistT IO) (DeltasCheckpoints (WalletCheckpoint s))
</span><a href="#local-6989586621682486431"><span class="hs-identifier hs-var">storeCheckpoints</span></a></span><span> </span><span class="annot"><span class="annottext">Base (DeltasCheckpoints (WalletCheckpoint s))
forall a. HasCallStack =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">undefined</span></a></span><span> </span><span class="annot"><span class="annottext">DeltasCheckpoints (WalletCheckpoint s)
</span><a href="#local-6989586621682486413"><span class="hs-identifier hs-var">delta</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="hs-comment">-- | Store for the 'Checkpoints' belonging to a 'WalletState'.</span><span>
</span><span id="line-240"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkStoreCheckpoints"><span class="hs-identifier hs-type">mkStoreCheckpoints</span></a></span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682486813"><span class="annot"><a href="#local-6989586621682486813"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486813"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#DeltasCheckpoints"><span class="hs-identifier hs-type">DeltasCheckpoints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#WalletCheckpoint"><span class="hs-identifier hs-type">WalletCheckpoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486813"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span id="mkStoreCheckpoints"><span class="annot"><span class="annottext">mkStoreCheckpoints :: WalletId
-&gt; Store (SqlPersistT IO) (DeltasCheckpoints (WalletCheckpoint s))
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkStoreCheckpoints"><span class="hs-identifier hs-var hs-var">mkStoreCheckpoints</span></a></span></span><span> </span><span id="local-6989586621682486412"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486412"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-245"></span><span>    </span><span class="annot"><span class="annottext">Store :: forall (m :: * -&gt; *) da.
m (Either SomeException (Base da))
-&gt; (Base da -&gt; m ()) -&gt; (Base da -&gt; da -&gt; m ()) -&gt; Store m da
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-type">Store</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">loadS :: SqlPersistT
  IO
  (Either
     SomeException (Base (DeltasCheckpoints (WalletCheckpoint s))))
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">loadS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SqlPersistT
  IO
  (Either
     SomeException (Base (DeltasCheckpoints (WalletCheckpoint s))))
ReaderT
  SqlBackend
  IO
  (Either SomeException (Checkpoints (WalletCheckpoint s)))
</span><a href="#local-6989586621682486411"><span class="hs-identifier hs-var">load</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">writeS :: Base (DeltasCheckpoints (WalletCheckpoint s)) -&gt; SqlPersistT IO ()
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">writeS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Base (DeltasCheckpoints (WalletCheckpoint s)) -&gt; SqlPersistT IO ()
Checkpoints (WalletCheckpoint s) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486410"><span class="hs-identifier hs-var">write</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">updateS :: Base (DeltasCheckpoints (WalletCheckpoint s))
-&gt; DeltasCheckpoints (WalletCheckpoint s) -&gt; SqlPersistT IO ()
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Base (DeltasCheckpoints (WalletCheckpoint s))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DeltasCheckpoints (WalletCheckpoint s) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486409"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-247"></span><span>    </span><span id="local-6989586621682486411"><span class="annot"><span class="annottext">load :: ReaderT
  SqlBackend
  IO
  (Either SomeException (Checkpoints (WalletCheckpoint s)))
</span><a href="#local-6989586621682486411"><span class="hs-identifier hs-var hs-var">load</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ErrBadFormat -&gt; SomeException)
-&gt; ([(Slot, WalletCheckpoint s)]
    -&gt; Checkpoints (WalletCheckpoint s))
-&gt; Either ErrBadFormat [(Slot, WalletCheckpoint s)]
-&gt; Either SomeException (Checkpoints (WalletCheckpoint s))
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">bimap</span></a></span><span> </span><span class="annot"><span class="annottext">ErrBadFormat -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toException</span></a></span><span> </span><span class="annot"><span class="annottext">[(Slot, WalletCheckpoint s)] -&gt; Checkpoints (WalletCheckpoint s)
forall a. [(Slot, a)] -&gt; Checkpoints a
</span><a href="Cardano.Wallet.Checkpoints.html#loadCheckpoints"><span class="hs-identifier hs-var">loadCheckpoints</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrBadFormat [(Slot, WalletCheckpoint s)]
 -&gt; Either SomeException (Checkpoints (WalletCheckpoint s)))
-&gt; ReaderT
     SqlBackend IO (Either ErrBadFormat [(Slot, WalletCheckpoint s)])
-&gt; ReaderT
     SqlBackend
     IO
     (Either SomeException (Checkpoints (WalletCheckpoint s)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; ReaderT
     SqlBackend IO (Either ErrBadFormat [(Slot, WalletCheckpoint s)])
forall s.
PersistAddressBook s =&gt;
WalletId
-&gt; SqlPersistT
     IO (Either ErrBadFormat [(Slot, WalletCheckpoint s)])
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectAllCheckpoints"><span class="hs-identifier hs-var">selectAllCheckpoints</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486412"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span>    </span><span id="local-6989586621682486410"><span class="annot"><span class="annottext">write :: Checkpoints (WalletCheckpoint s) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486410"><span class="hs-identifier hs-var hs-var">write</span></a></span></span><span> </span><span id="local-6989586621682486407"><span class="annot"><span class="annottext">Checkpoints (WalletCheckpoint s)
</span><a href="#local-6989586621682486407"><span class="hs-identifier hs-var">cps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Slot, WalletCheckpoint s)]
-&gt; ((Slot, WalletCheckpoint s) -&gt; SqlPersistT IO ())
-&gt; SqlPersistT IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Slot (WalletCheckpoint s) -&gt; [(Slot, WalletCheckpoint s)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Slot (WalletCheckpoint s) -&gt; [(Slot, WalletCheckpoint s)])
-&gt; Map Slot (WalletCheckpoint s) -&gt; [(Slot, WalletCheckpoint s)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoints (WalletCheckpoint s)
</span><a href="#local-6989586621682486407"><span class="hs-identifier hs-var">cps</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoints (WalletCheckpoint s)
-&gt; ((Map Slot (WalletCheckpoint s)
     -&gt; Const
          (Map Slot (WalletCheckpoint s)) (Map Slot (WalletCheckpoint s)))
    -&gt; Checkpoints (WalletCheckpoint s)
    -&gt; Const
         (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s)))
-&gt; Map Slot (WalletCheckpoint s)
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;checkpoints&quot;
  ((Map Slot (WalletCheckpoint s)
    -&gt; Const
         (Map Slot (WalletCheckpoint s)) (Map Slot (WalletCheckpoint s)))
   -&gt; Checkpoints (WalletCheckpoint s)
   -&gt; Const
        (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s)))
(Map Slot (WalletCheckpoint s)
 -&gt; Const
      (Map Slot (WalletCheckpoint s)) (Map Slot (WalletCheckpoint s)))
-&gt; Checkpoints (WalletCheckpoint s)
-&gt; Const
     (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s))
</span><a href="#local-6989586621682486405"><span class="hs-var">#checkpoints</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Slot, WalletCheckpoint s) -&gt; SqlPersistT IO ())
 -&gt; SqlPersistT IO ())
-&gt; ((Slot, WalletCheckpoint s) -&gt; SqlPersistT IO ())
-&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621682486404"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682486404"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682486403"><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682486403"><span class="hs-identifier hs-var">cp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-250"></span><span>            </span><span class="annot"><span class="annottext">DeltaCheckpoints (WalletCheckpoint s) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486402"><span class="hs-identifier hs-var">update1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slot -&gt; WalletCheckpoint s -&gt; DeltaCheckpoints (WalletCheckpoint s)
forall a. Slot -&gt; a -&gt; DeltaCheckpoints a
</span><a href="Cardano.Wallet.Checkpoints.html#PutCheckpoint"><span class="hs-identifier hs-var">PutCheckpoint</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682486404"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682486403"><span class="hs-identifier hs-var">cp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span>         </span><span class="hs-comment">-- first update in list is the last to be applied!</span><span>
</span><span id="line-253"></span><span>    </span><span id="local-6989586621682486409"><span class="annot"><span class="annottext">update :: DeltasCheckpoints (WalletCheckpoint s) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486409"><span class="hs-identifier hs-var hs-var">update</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DeltaCheckpoints (WalletCheckpoint s) -&gt; SqlPersistT IO ())
-&gt; DeltasCheckpoints (WalletCheckpoint s) -&gt; SqlPersistT IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaCheckpoints (WalletCheckpoint s) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486402"><span class="hs-identifier hs-var">update1</span></a></span><span> </span><span class="annot"><span class="annottext">(DeltasCheckpoints (WalletCheckpoint s) -&gt; SqlPersistT IO ())
-&gt; (DeltasCheckpoints (WalletCheckpoint s)
    -&gt; DeltasCheckpoints (WalletCheckpoint s))
-&gt; DeltasCheckpoints (WalletCheckpoint s)
-&gt; SqlPersistT IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DeltasCheckpoints (WalletCheckpoint s)
-&gt; DeltasCheckpoints (WalletCheckpoint s)
forall a. [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">reverse</span></a></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span>    </span><span id="local-6989586621682486402"><span class="annot"><span class="annottext">update1 :: DeltaCheckpoints (WalletCheckpoint s) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486402"><span class="hs-identifier hs-var hs-var">update1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#PutCheckpoint"><span class="hs-identifier hs-type">PutCheckpoint</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682486400"><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682486400"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-256"></span><span>        </span><span class="annot"><span class="annottext">WalletId -&gt; WalletCheckpoint s -&gt; SqlPersistT IO ()
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; WalletCheckpoint s -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertCheckpoint"><span class="hs-identifier hs-var">insertCheckpoint</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486412"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682486400"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-257"></span><span>    </span><span class="annot"><a href="#local-6989586621682486402"><span class="hs-identifier hs-var">update1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#RollbackTo"><span class="hs-identifier hs-type">RollbackTo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">W.At</span></a></span><span> </span><span id="local-6989586621682486396"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486396"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-258"></span><span>        </span><span class="annot"><span class="annottext">[Filter Checkpoint] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointWalletId"><span class="hs-identifier hs-var">CheckpointWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId -&gt; WalletId -&gt; Filter Checkpoint
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486412"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointSlot"><span class="hs-identifier hs-var">CheckpointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint SlotNo -&gt; SlotNo -&gt; Filter Checkpoint
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">&gt;.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486396"><span class="hs-identifier hs-var">slot</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-259"></span><span>    </span><span class="annot"><a href="#local-6989586621682486402"><span class="hs-identifier hs-var">update1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#RollbackTo"><span class="hs-identifier hs-type">RollbackTo</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">W.Origin</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-260"></span><span>        </span><span class="annot"><span class="annottext">[Filter Checkpoint] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span>
</span><span id="line-261"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointWalletId"><span class="hs-identifier hs-var">CheckpointWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId -&gt; WalletId -&gt; Filter Checkpoint
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486412"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-262"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint BlockId
forall typ. (typ ~ BlockId) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointParentHash"><span class="hs-identifier hs-var">CheckpointParentHash</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint BlockId -&gt; BlockId -&gt; Filter Checkpoint
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">!=.</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;BlockHeader&quot; -&gt; BlockId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#BlockId"><span class="hs-identifier hs-var">BlockId</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;BlockHeader&quot;
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#hashOfNoParent"><span class="hs-identifier hs-var">hashOfNoParent</span></a></span><span>
</span><span id="line-263"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-264"></span><span>    </span><span class="annot"><a href="#local-6989586621682486402"><span class="hs-identifier hs-var">update1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#RestrictTo"><span class="hs-identifier hs-type">RestrictTo</span></a></span><span> </span><span id="local-6989586621682486390"><span class="annot"><span class="annottext">[Slot]
</span><a href="#local-6989586621682486390"><span class="hs-identifier hs-var">pts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-265"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486389"><span class="annot"><span class="annottext">points :: [Slot]
</span><a href="#local-6989586621682486389"><span class="hs-identifier hs-var hs-var">points</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Slot
forall t. WithOrigin t
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">W.Origin</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; [Slot] -&gt; [Slot]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[Slot]
</span><a href="#local-6989586621682486390"><span class="hs-identifier hs-var">pts</span></a></span><span>
</span><span id="line-266"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486388"><span class="annot"><span class="annottext">pseudoSlot :: Slot -&gt; SlotNo
</span><a href="#local-6989586621682486388"><span class="hs-identifier hs-var hs-var">pseudoSlot</span></a></span></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">W.Origin</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; SlotNo
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">W.SlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-267"></span><span>            </span><span class="annot"><a href="#local-6989586621682486388"><span class="hs-identifier hs-var">pseudoSlot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">W.At</span></a></span><span> </span><span id="local-6989586621682486386"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486386"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486386"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-268"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486385"><span class="annot"><span class="annottext">slots :: [SlotNo]
</span><a href="#local-6989586621682486385"><span class="hs-identifier hs-var hs-var">slots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Slot -&gt; SlotNo) -&gt; [Slot] -&gt; [SlotNo]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; SlotNo
</span><a href="#local-6989586621682486388"><span class="hs-identifier hs-var">pseudoSlot</span></a></span><span> </span><span class="annot"><span class="annottext">[Slot]
</span><a href="#local-6989586621682486389"><span class="hs-identifier hs-var">points</span></a></span><span>
</span><span id="line-269"></span><span>        </span><span class="annot"><span class="annottext">[Filter Checkpoint] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointWalletId"><span class="hs-identifier hs-var">CheckpointWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId -&gt; WalletId -&gt; Filter Checkpoint
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486412"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointSlot"><span class="hs-identifier hs-var">CheckpointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint SlotNo -&gt; [SlotNo] -&gt; Filter Checkpoint
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; [typ] -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">/&lt;-.</span></a></span><span> </span><span class="annot"><span class="annottext">[SlotNo]
</span><a href="#local-6989586621682486385"><span class="hs-identifier hs-var">slots</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span>        </span><span class="hs-comment">-- We may have to delete the checkpoint at SlotNo 0 that is not genesis.</span><span>
</span><span id="line-272"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486384"><span class="annot"><span class="annottext">slot0 :: Slot
</span><a href="#local-6989586621682486384"><span class="hs-identifier hs-var hs-var">slot0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Slot
forall t. t -&gt; WithOrigin t
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">W.At</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; Slot) -&gt; SlotNo -&gt; Slot
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; SlotNo
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">W.SlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-273"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; SqlPersistT IO () -&gt; SqlPersistT IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682486384"><span class="hs-identifier hs-var">slot0</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; [Slot] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="annot"><span class="annottext">[Slot]
</span><a href="#local-6989586621682486389"><span class="hs-identifier hs-var">points</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SqlPersistT IO () -&gt; SqlPersistT IO ())
-&gt; SqlPersistT IO () -&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-274"></span><span>            </span><span class="annot"><span class="annottext">[Filter Checkpoint] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span>
</span><span id="line-275"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointWalletId"><span class="hs-identifier hs-var">CheckpointWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId -&gt; WalletId -&gt; Filter Checkpoint
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486412"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-276"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointSlot"><span class="hs-identifier hs-var">CheckpointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint SlotNo -&gt; SlotNo -&gt; Filter Checkpoint
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; SlotNo
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">W.SlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-277"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint BlockId
forall typ. (typ ~ BlockId) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointParentHash"><span class="hs-identifier hs-var">CheckpointParentHash</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint BlockId -&gt; BlockId -&gt; Filter Checkpoint
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">!=.</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;BlockHeader&quot; -&gt; BlockId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#BlockId"><span class="hs-identifier hs-var">BlockId</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;BlockHeader&quot;
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#hashOfNoParent"><span class="hs-identifier hs-var">hashOfNoParent</span></a></span><span>
</span><span id="line-278"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Database operations
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-283"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectAllCheckpoints"><span class="hs-identifier hs-type">selectAllCheckpoints</span></a></span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682486782"><span class="annot"><a href="#local-6989586621682486782"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486782"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-286"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.html#ErrBadFormat"><span class="hs-identifier hs-type">ErrBadFormat</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Slot"><span class="hs-identifier hs-type">W.Slot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#WalletCheckpoint"><span class="hs-identifier hs-type">WalletCheckpoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486782"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span id="selectAllCheckpoints"><span class="annot"><span class="annottext">selectAllCheckpoints :: WalletId
-&gt; SqlPersistT
     IO (Either ErrBadFormat [(Slot, WalletCheckpoint s)])
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectAllCheckpoints"><span class="hs-identifier hs-var hs-var">selectAllCheckpoints</span></a></span></span><span> </span><span id="local-6989586621682486382"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486382"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>    </span><span id="local-6989586621682486381"><span class="annot"><span class="annottext">[Checkpoint]
</span><a href="#local-6989586621682486381"><span class="hs-identifier hs-var">cpRefs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Entity Checkpoint -&gt; Checkpoint)
-&gt; [Entity Checkpoint] -&gt; [Checkpoint]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Entity Checkpoint -&gt; Checkpoint
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">([Entity Checkpoint] -&gt; [Checkpoint])
-&gt; ReaderT SqlBackend IO [Entity Checkpoint]
-&gt; ReaderT SqlBackend IO [Checkpoint]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter Checkpoint]
-&gt; [SelectOpt Checkpoint]
-&gt; ReaderT SqlBackend IO [Entity Checkpoint]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-289"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointWalletId"><span class="hs-identifier hs-var">CheckpointWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId -&gt; WalletId -&gt; Filter Checkpoint
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486382"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-290"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint SlotNo -&gt; SelectOpt Checkpoint
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Desc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointSlot"><span class="hs-identifier hs-var">CheckpointSlot</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-291"></span><span>    </span><span id="local-6989586621682486379"><span class="annot"><span class="annottext">[(Slot, WalletCheckpoint s)]
</span><a href="#local-6989586621682486379"><span class="hs-identifier hs-var">cps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Checkpoint]
-&gt; (Checkpoint -&gt; ReaderT SqlBackend IO (Slot, WalletCheckpoint s))
-&gt; ReaderT SqlBackend IO [(Slot, WalletCheckpoint s)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM</span></a></span><span> </span><span class="annot"><span class="annottext">[Checkpoint]
</span><a href="#local-6989586621682486381"><span class="hs-identifier hs-var">cpRefs</span></a></span><span> </span><span class="annot"><span class="annottext">((Checkpoint -&gt; ReaderT SqlBackend IO (Slot, WalletCheckpoint s))
 -&gt; ReaderT SqlBackend IO [(Slot, WalletCheckpoint s)])
-&gt; (Checkpoint -&gt; ReaderT SqlBackend IO (Slot, WalletCheckpoint s))
-&gt; ReaderT SqlBackend IO [(Slot, WalletCheckpoint s)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682486378"><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486378"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-292"></span><span>        </span><span class="hs-comment">-- FIXME during APD-1043: Internal consistency of this table?</span><span>
</span><span id="line-293"></span><span>        </span><span id="local-6989586621682486377"><span class="annot"><span class="annottext">([UTxO], [UTxOToken])
</span><a href="#local-6989586621682486377"><span class="hs-identifier hs-var">utxo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Checkpoint -&gt; SqlPersistT IO ([UTxO], [UTxOToken])
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectUTxO"><span class="hs-identifier hs-var">selectUTxO</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486378"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-294"></span><span>        </span><span id="local-6989586621682486375"><span class="annot"><span class="annottext">Discoveries s
</span><a href="#local-6989586621682486375"><span class="hs-identifier hs-var">discoveries</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; SlotNo -&gt; SqlPersistT IO (Discoveries s)
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; SlotNo -&gt; SqlPersistT IO (Discoveries s)
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#loadDiscoveries"><span class="hs-identifier hs-var">loadDiscoveries</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486382"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Checkpoint -&gt; SlotNo
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#checkpointSlot"><span class="hs-identifier hs-var hs-var">checkpointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486378"><span class="hs-identifier hs-var">cp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486372"><span class="annot"><span class="annottext">c :: WalletCheckpoint s
</span><a href="#local-6989586621682486372"><span class="hs-identifier hs-var hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Checkpoint
-&gt; ([UTxO], [UTxOToken]) -&gt; Discoveries s -&gt; WalletCheckpoint s
forall s.
Checkpoint
-&gt; ([UTxO], [UTxOToken]) -&gt; Discoveries s -&gt; WalletCheckpoint s
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#checkpointFromEntity"><span class="hs-identifier hs-var">checkpointFromEntity</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486782"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486378"><span class="hs-identifier hs-var">cp</span></a></span><span> </span><span class="annot"><span class="annottext">([UTxO], [UTxOToken])
</span><a href="#local-6989586621682486377"><span class="hs-identifier hs-var">utxo</span></a></span><span> </span><span class="annot"><span class="annottext">Discoveries s
</span><a href="#local-6989586621682486375"><span class="hs-identifier hs-var">discoveries</span></a></span><span>
</span><span id="line-296"></span><span>        </span><span class="annot"><span class="annottext">(Slot, WalletCheckpoint s)
-&gt; ReaderT SqlBackend IO (Slot, WalletCheckpoint s)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletCheckpoint s -&gt; Slot
forall s. WalletCheckpoint s -&gt; Slot
</span><a href="Cardano.Wallet.DB.WalletState.html#getSlot"><span class="hs-identifier hs-var">getSlot</span></a></span><span> </span><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682486372"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682486372"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>    </span><span class="annot"><span class="annottext">Either ErrBadFormat [(Slot, WalletCheckpoint s)]
-&gt; SqlPersistT
     IO (Either ErrBadFormat [(Slot, WalletCheckpoint s)])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrBadFormat [(Slot, WalletCheckpoint s)]
 -&gt; SqlPersistT
      IO (Either ErrBadFormat [(Slot, WalletCheckpoint s)]))
-&gt; Either ErrBadFormat [(Slot, WalletCheckpoint s)]
-&gt; SqlPersistT
     IO (Either ErrBadFormat [(Slot, WalletCheckpoint s)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[(Slot, WalletCheckpoint s)]
</span><a href="#local-6989586621682486379"><span class="hs-identifier hs-var">cps</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-298"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ErrBadFormat -&gt; Either ErrBadFormat [(Slot, WalletCheckpoint s)]
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">ErrBadFormat
</span><a href="Cardano.Wallet.DB.html#ErrBadFormatCheckpoints"><span class="hs-identifier hs-var">ErrBadFormatCheckpoints</span></a></span><span>
</span><span id="line-299"></span><span>        </span><span class="annot"><span class="annottext">[(Slot, WalletCheckpoint s)]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(Slot, WalletCheckpoint s)]
-&gt; Either ErrBadFormat [(Slot, WalletCheckpoint s)]
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">[(Slot, WalletCheckpoint s)]
</span><a href="#local-6989586621682486379"><span class="hs-identifier hs-var">cps</span></a></span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectUTxO"><span class="hs-identifier hs-type">selectUTxO</span></a></span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Checkpoint"><span class="hs-identifier hs-type">Checkpoint</span></a></span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UTxOToken"><span class="hs-identifier hs-type">UTxOToken</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span id="selectUTxO"><span class="annot"><span class="annottext">selectUTxO :: Checkpoint -&gt; SqlPersistT IO ([UTxO], [UTxOToken])
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectUTxO"><span class="hs-identifier hs-var hs-var">selectUTxO</span></a></span></span><span> </span><span id="local-6989586621682486369"><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486369"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621682486368"><span class="annot"><span class="annottext">[UTxO]
</span><a href="#local-6989586621682486368"><span class="hs-identifier hs-var">coins</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Entity UTxO -&gt; UTxO) -&gt; [Entity UTxO] -&gt; [UTxO]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Entity UTxO -&gt; UTxO
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">([Entity UTxO] -&gt; [UTxO])
-&gt; ReaderT SqlBackend IO [Entity UTxO]
-&gt; ReaderT SqlBackend IO [UTxO]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-307"></span><span>        </span><span class="annot"><span class="annottext">[Filter UTxO]
-&gt; [SelectOpt UTxO] -&gt; ReaderT SqlBackend IO [Entity UTxO]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-308"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField UTxO WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField UTxO typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UtxoWalletId"><span class="hs-identifier hs-var">UtxoWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField UTxO WalletId -&gt; WalletId -&gt; Filter UTxO
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint -&gt; WalletId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#checkpointWalletId"><span class="hs-identifier hs-var hs-var">checkpointWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486369"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-309"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField UTxO SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField UTxO typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UtxoSlot"><span class="hs-identifier hs-var">UtxoSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField UTxO SlotNo -&gt; SlotNo -&gt; Filter UTxO
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint -&gt; SlotNo
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#checkpointSlot"><span class="hs-identifier hs-var hs-var">checkpointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486369"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-310"></span><span>            </span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-311"></span><span>    </span><span id="local-6989586621682486364"><span class="annot"><span class="annottext">[UTxOToken]
</span><a href="#local-6989586621682486364"><span class="hs-identifier hs-var">tokens</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Entity UTxOToken -&gt; UTxOToken)
-&gt; [Entity UTxOToken] -&gt; [UTxOToken]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Entity UTxOToken -&gt; UTxOToken
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">([Entity UTxOToken] -&gt; [UTxOToken])
-&gt; ReaderT SqlBackend IO [Entity UTxOToken]
-&gt; ReaderT SqlBackend IO [UTxOToken]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-312"></span><span>        </span><span class="annot"><span class="annottext">[Filter UTxOToken]
-&gt; [SelectOpt UTxOToken]
-&gt; ReaderT SqlBackend IO [Entity UTxOToken]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-313"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField UTxOToken WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField UTxOToken typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UtxoTokenWalletId"><span class="hs-identifier hs-var">UtxoTokenWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField UTxOToken WalletId -&gt; WalletId -&gt; Filter UTxOToken
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint -&gt; WalletId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#checkpointWalletId"><span class="hs-identifier hs-var hs-var">checkpointWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486369"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-314"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField UTxOToken SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField UTxOToken typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UtxoTokenSlot"><span class="hs-identifier hs-var">UtxoTokenSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField UTxOToken SlotNo -&gt; SlotNo -&gt; Filter UTxOToken
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint -&gt; SlotNo
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#checkpointSlot"><span class="hs-identifier hs-var hs-var">checkpointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486369"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-315"></span><span>            </span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-316"></span><span>    </span><span class="annot"><span class="annottext">([UTxO], [UTxOToken]) -&gt; SqlPersistT IO ([UTxO], [UTxOToken])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[UTxO]
</span><a href="#local-6989586621682486368"><span class="hs-identifier hs-var">coins</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[UTxOToken]
</span><a href="#local-6989586621682486364"><span class="hs-identifier hs-var">tokens</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertCheckpoint"><span class="hs-identifier hs-type">insertCheckpoint</span></a></span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682486773"><span class="annot"><a href="#local-6989586621682486773"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486773"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#WalletCheckpoint"><span class="hs-identifier hs-type">WalletCheckpoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486773"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span id="insertCheckpoint"><span class="annot"><span class="annottext">insertCheckpoint :: WalletId -&gt; WalletCheckpoint s -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertCheckpoint"><span class="hs-identifier hs-var hs-var">insertCheckpoint</span></a></span></span><span> </span><span id="local-6989586621682486361"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486361"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682486360"><span class="annot"><span class="annottext">wallet :: WalletCheckpoint s
</span><a href="#local-6989586621682486360"><span class="hs-identifier hs-var">wallet</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#WalletCheckpoint"><span class="hs-identifier hs-type">WalletCheckpoint</span></a></span><span> </span><span id="local-6989586621682486358"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682486358"><span class="hs-identifier hs-var">currentTip</span></a></span></span><span> </span><span class="annot"><span class="annottext">UTxO
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682486357"><span class="annot"><span class="annottext">Discoveries s
</span><a href="#local-6989586621682486357"><span class="hs-identifier hs-var">discoveries</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682486356"><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486356"><span class="hs-identifier hs-var">cp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682486355"><span class="annot"><span class="annottext">[UTxO]
</span><a href="#local-6989586621682486355"><span class="hs-identifier hs-var">utxo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682486354"><span class="annot"><span class="annottext">[UTxOToken]
</span><a href="#local-6989586621682486354"><span class="hs-identifier hs-var">utxoTokens</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; WalletCheckpoint s -&gt; (Checkpoint, [UTxO], [UTxOToken])
forall s.
WalletId -&gt; WalletCheckpoint s -&gt; (Checkpoint, [UTxO], [UTxOToken])
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkCheckpointEntity"><span class="hs-identifier hs-var">mkCheckpointEntity</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486361"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682486360"><span class="hs-identifier hs-var">wallet</span></a></span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486352"><span class="annot"><span class="annottext">sl :: SlotNo
</span><a href="#local-6989586621682486352"><span class="hs-identifier hs-var hs-var">sl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682486358"><span class="hs-identifier hs-var">currentTip</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
-&gt; ((SlotNo -&gt; Const SlotNo SlotNo)
    -&gt; BlockHeader -&gt; Const SlotNo BlockHeader)
-&gt; SlotNo
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;slotNo&quot;
  ((SlotNo -&gt; Const SlotNo SlotNo)
   -&gt; BlockHeader -&gt; Const SlotNo BlockHeader)
(SlotNo -&gt; Const SlotNo SlotNo)
-&gt; BlockHeader -&gt; Const SlotNo BlockHeader
</span><a href="#local-6989586621682486351"><span class="hs-var">#slotNo</span></a></span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><span class="annottext">[Filter Checkpoint] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointWalletId"><span class="hs-identifier hs-var">CheckpointWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId -&gt; WalletId -&gt; Filter Checkpoint
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486361"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointSlot"><span class="hs-identifier hs-var">CheckpointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint SlotNo -&gt; SlotNo -&gt; Filter Checkpoint
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486352"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">Checkpoint -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insert_</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486356"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-328"></span><span>    </span><span class="annot"><span class="annottext">([UTxO] -&gt; SqlPersistT IO ()) -&gt; [UTxO] -&gt; SqlPersistT IO ()
forall record b.
PersistEntity record =&gt;
([record] -&gt; SqlPersistT IO b) -&gt; [record] -&gt; SqlPersistT IO ()
</span><a href="Cardano.DB.Sqlite.html#dbChunked"><span class="hs-identifier hs-var">dbChunked</span></a></span><span> </span><span class="annot"><span class="annottext">[UTxO] -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insertMany_</span></a></span><span> </span><span class="annot"><span class="annottext">[UTxO]
</span><a href="#local-6989586621682486355"><span class="hs-identifier hs-var">utxo</span></a></span><span>
</span><span id="line-329"></span><span>    </span><span class="annot"><span class="annottext">([UTxOToken] -&gt; SqlPersistT IO ())
-&gt; [UTxOToken] -&gt; SqlPersistT IO ()
forall record b.
PersistEntity record =&gt;
([record] -&gt; SqlPersistT IO b) -&gt; [record] -&gt; SqlPersistT IO ()
</span><a href="Cardano.DB.Sqlite.html#dbChunked"><span class="hs-identifier hs-var">dbChunked</span></a></span><span> </span><span class="annot"><span class="annottext">[UTxOToken] -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insertMany_</span></a></span><span> </span><span class="annot"><span class="annottext">[UTxOToken]
</span><a href="#local-6989586621682486354"><span class="hs-identifier hs-var">utxoTokens</span></a></span><span>
</span><span id="line-330"></span><span>    </span><span class="annot"><span class="annottext">WalletId -&gt; SlotNo -&gt; Discoveries s -&gt; SqlPersistT IO ()
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; SlotNo -&gt; Discoveries s -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertDiscoveries"><span class="hs-identifier hs-var">insertDiscoveries</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486361"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486352"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">Discoveries s
</span><a href="#local-6989586621682486357"><span class="hs-identifier hs-var">discoveries</span></a></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Database type conversions
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-335"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#blockHeaderFromEntity"><span class="hs-identifier hs-type">blockHeaderFromEntity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Checkpoint"><span class="hs-identifier hs-type">Checkpoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">W.BlockHeader</span></a></span><span>
</span><span id="line-336"></span><span id="blockHeaderFromEntity"><span class="annot"><span class="annottext">blockHeaderFromEntity :: Checkpoint -&gt; BlockHeader
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#blockHeaderFromEntity"><span class="hs-identifier hs-var hs-var">blockHeaderFromEntity</span></a></span></span><span> </span><span id="local-6989586621682486349"><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486349"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader :: SlotNo
-&gt; Quantity &quot;block&quot; Word32
-&gt; Hash &quot;BlockHeader&quot;
-&gt; Maybe (Hash &quot;BlockHeader&quot;)
-&gt; BlockHeader
</span><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">W.BlockHeader</span></a></span><span>
</span><span id="line-337"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:slotNo:BlockHeader :: SlotNo
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AslotNo%3ABlockHeader"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Checkpoint -&gt; SlotNo
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#checkpointSlot"><span class="hs-identifier hs-var hs-var">checkpointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486349"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-338"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:blockHeight:BlockHeader :: Quantity &quot;block&quot; Word32
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AblockHeight%3ABlockHeader"><span class="hs-identifier hs-var">blockHeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Quantity &quot;block&quot; Word32
forall (unit :: Symbol) a. a -&gt; Quantity unit a
</span><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-var">Quantity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Checkpoint -&gt; Word32
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#checkpointBlockHeight"><span class="hs-identifier hs-var hs-var">checkpointBlockHeight</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486349"><span class="hs-identifier hs-var">cp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:headerHash:BlockHeader :: Hash &quot;BlockHeader&quot;
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AheaderHash%3ABlockHeader"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockId -&gt; Hash &quot;BlockHeader&quot;
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#getBlockId"><span class="hs-identifier hs-var hs-var">getBlockId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Checkpoint -&gt; BlockId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#checkpointHeaderHash"><span class="hs-identifier hs-var hs-var">checkpointHeaderHash</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486349"><span class="hs-identifier hs-var">cp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:parentHeaderHash:BlockHeader :: Maybe (Hash &quot;BlockHeader&quot;)
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AparentHeaderHash%3ABlockHeader"><span class="hs-identifier hs-var">parentHeaderHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockId -&gt; Maybe (Hash &quot;BlockHeader&quot;)
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#toMaybeHash"><span class="hs-identifier hs-var">toMaybeHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Checkpoint -&gt; BlockId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#checkpointParentHash"><span class="hs-identifier hs-var hs-var">checkpointParentHash</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486349"><span class="hs-identifier hs-var">cp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-342"></span><span>
</span><span id="line-343"></span><span id="local-6989586621682486745"><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkCheckpointEntity"><span class="hs-identifier hs-type">mkCheckpointEntity</span></a></span><span>
</span><span id="line-344"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-345"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#WalletCheckpoint"><span class="hs-identifier hs-type">WalletCheckpoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486745"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Checkpoint"><span class="hs-identifier hs-type">Checkpoint</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UTxOToken"><span class="hs-identifier hs-type">UTxOToken</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-347"></span><span id="mkCheckpointEntity"><span class="annot"><span class="annottext">mkCheckpointEntity :: WalletId -&gt; WalletCheckpoint s -&gt; (Checkpoint, [UTxO], [UTxOToken])
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkCheckpointEntity"><span class="hs-identifier hs-var hs-var">mkCheckpointEntity</span></a></span></span><span> </span><span id="local-6989586621682486338"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486338"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#WalletCheckpoint"><span class="hs-identifier hs-type">WalletCheckpoint</span></a></span><span> </span><span id="local-6989586621682486337"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682486337"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span id="local-6989586621682486336"><span class="annot"><span class="annottext">UTxO
</span><a href="#local-6989586621682486336"><span class="hs-identifier hs-var">wutxo</span></a></span></span><span> </span><span class="annot"><span class="annottext">Discoveries s
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-348"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486335"><span class="hs-identifier hs-var">cp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[UTxO]
</span><a href="#local-6989586621682486334"><span class="hs-identifier hs-var">utxo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[UTxOToken]
</span><a href="#local-6989586621682486333"><span class="hs-identifier hs-var">utxoTokens</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-350"></span><span>    </span><span id="local-6989586621682486332"><span class="annot"><span class="annottext">sl :: SlotNo
</span><a href="#local-6989586621682486332"><span class="hs-identifier hs-var hs-var">sl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682486337"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
-&gt; ((SlotNo -&gt; Const SlotNo SlotNo)
    -&gt; BlockHeader -&gt; Const SlotNo BlockHeader)
-&gt; SlotNo
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;slotNo&quot;
  ((SlotNo -&gt; Const SlotNo SlotNo)
   -&gt; BlockHeader -&gt; Const SlotNo BlockHeader)
(SlotNo -&gt; Const SlotNo SlotNo)
-&gt; BlockHeader -&gt; Const SlotNo BlockHeader
</span><a href="#local-6989586621682486331"><span class="hs-var">#slotNo</span></a></span><span>
</span><span id="line-351"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-type">Quantity</span></a></span><span> </span><span id="local-6989586621682486330"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486330"><span class="hs-identifier hs-var">bh</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682486337"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
-&gt; ((Quantity &quot;block&quot; Word32
     -&gt; Const (Quantity &quot;block&quot; Word32) (Quantity &quot;block&quot; Word32))
    -&gt; BlockHeader -&gt; Const (Quantity &quot;block&quot; Word32) BlockHeader)
-&gt; Quantity &quot;block&quot; Word32
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;blockHeight&quot;
  ((Quantity &quot;block&quot; Word32
    -&gt; Const (Quantity &quot;block&quot; Word32) (Quantity &quot;block&quot; Word32))
   -&gt; BlockHeader -&gt; Const (Quantity &quot;block&quot; Word32) BlockHeader)
(Quantity &quot;block&quot; Word32
 -&gt; Const (Quantity &quot;block&quot; Word32) (Quantity &quot;block&quot; Word32))
-&gt; BlockHeader -&gt; Const (Quantity &quot;block&quot; Word32) BlockHeader
</span><a href="#local-6989586621682486329"><span class="hs-var">#blockHeight</span></a></span><span>
</span><span id="line-352"></span><span>    </span><span id="local-6989586621682486335"><span class="annot"><span class="annottext">cp :: Checkpoint
</span><a href="#local-6989586621682486335"><span class="hs-identifier hs-var hs-var">cp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Checkpoint :: WalletId -&gt; SlotNo -&gt; BlockId -&gt; BlockId -&gt; Word32 -&gt; Checkpoint
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Checkpoint"><span class="hs-identifier hs-type">Checkpoint</span></a></span><span>
</span><span id="line-353"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">checkpointWalletId :: WalletId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#checkpointWalletId"><span class="hs-identifier hs-var">checkpointWalletId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486338"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-354"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">checkpointSlot :: SlotNo
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#checkpointSlot"><span class="hs-identifier hs-var">checkpointSlot</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486332"><span class="hs-identifier hs-var">sl</span></a></span><span>
</span><span id="line-355"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">checkpointParentHash :: BlockId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#checkpointParentHash"><span class="hs-identifier hs-var">checkpointParentHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Hash &quot;BlockHeader&quot;) -&gt; BlockId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#fromMaybeHash"><span class="hs-identifier hs-var">fromMaybeHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682486337"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
-&gt; ((Maybe (Hash &quot;BlockHeader&quot;)
     -&gt; Const (Maybe (Hash &quot;BlockHeader&quot;)) (Maybe (Hash &quot;BlockHeader&quot;)))
    -&gt; BlockHeader -&gt; Const (Maybe (Hash &quot;BlockHeader&quot;)) BlockHeader)
-&gt; Maybe (Hash &quot;BlockHeader&quot;)
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;parentHeaderHash&quot;
  ((Maybe (Hash &quot;BlockHeader&quot;)
    -&gt; Const (Maybe (Hash &quot;BlockHeader&quot;)) (Maybe (Hash &quot;BlockHeader&quot;)))
   -&gt; BlockHeader -&gt; Const (Maybe (Hash &quot;BlockHeader&quot;)) BlockHeader)
(Maybe (Hash &quot;BlockHeader&quot;)
 -&gt; Const (Maybe (Hash &quot;BlockHeader&quot;)) (Maybe (Hash &quot;BlockHeader&quot;)))
-&gt; BlockHeader -&gt; Const (Maybe (Hash &quot;BlockHeader&quot;)) BlockHeader
</span><a href="#local-6989586621682486327"><span class="hs-var">#parentHeaderHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">checkpointHeaderHash :: BlockId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#checkpointHeaderHash"><span class="hs-identifier hs-var">checkpointHeaderHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash &quot;BlockHeader&quot; -&gt; BlockId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#BlockId"><span class="hs-identifier hs-var">BlockId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682486337"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
-&gt; ((Hash &quot;BlockHeader&quot;
     -&gt; Const (Hash &quot;BlockHeader&quot;) (Hash &quot;BlockHeader&quot;))
    -&gt; BlockHeader -&gt; Const (Hash &quot;BlockHeader&quot;) BlockHeader)
-&gt; Hash &quot;BlockHeader&quot;
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;headerHash&quot;
  ((Hash &quot;BlockHeader&quot;
    -&gt; Const (Hash &quot;BlockHeader&quot;) (Hash &quot;BlockHeader&quot;))
   -&gt; BlockHeader -&gt; Const (Hash &quot;BlockHeader&quot;) BlockHeader)
(Hash &quot;BlockHeader&quot;
 -&gt; Const (Hash &quot;BlockHeader&quot;) (Hash &quot;BlockHeader&quot;))
-&gt; BlockHeader -&gt; Const (Hash &quot;BlockHeader&quot;) BlockHeader
</span><a href="#local-6989586621682486326"><span class="hs-var">#headerHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">checkpointBlockHeight :: Word32
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#checkpointBlockHeight"><span class="hs-identifier hs-var">checkpointBlockHeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486330"><span class="hs-identifier hs-var">bh</span></a></span><span>
</span><span id="line-358"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-359"></span><span>    </span><span id="local-6989586621682486334"><span class="annot"><span class="annottext">utxo :: [UTxO]
</span><a href="#local-6989586621682486334"><span class="hs-identifier hs-var hs-var">utxo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-360"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; SlotNo -&gt; TxId -&gt; Word32 -&gt; Address -&gt; Coin -&gt; UTxO
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UTxO"><span class="hs-identifier hs-var">UTxO</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486338"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486332"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash &quot;Tx&quot; -&gt; TxId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#TxId"><span class="hs-identifier hs-var">TxId</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682486323"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486322"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682486321"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TokenBundle -&gt; Coin
</span><a href="Cardano.Wallet.Primitive.Types.TokenBundle.html#getCoin"><span class="hs-identifier hs-var">TokenBundle.getCoin</span></a></span><span> </span><span class="annot"><span class="annottext">TokenBundle
</span><a href="#local-6989586621682486319"><span class="hs-identifier hs-var">tokens</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxIn"><span class="hs-identifier hs-type">W.TxIn</span></a></span><span> </span><span id="local-6989586621682486323"><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682486323"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span id="local-6989586621682486322"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486322"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxOut"><span class="hs-identifier hs-type">W.TxOut</span></a></span><span> </span><span id="local-6989586621682486321"><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682486321"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span id="local-6989586621682486319"><span class="annot"><span class="annottext">TokenBundle
</span><a href="#local-6989586621682486319"><span class="hs-identifier hs-var">tokens</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(TxIn, TxOut)]
</span><a href="#local-6989586621682486316"><span class="hs-identifier hs-var">utxoMap</span></a></span><span>
</span><span id="line-362"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-363"></span><span>    </span><span id="local-6989586621682486333"><span class="annot"><span class="annottext">utxoTokens :: [UTxOToken]
</span><a href="#local-6989586621682486333"><span class="hs-identifier hs-var hs-var">utxoTokens</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-364"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; SlotNo
-&gt; TxId
-&gt; Word32
-&gt; TokenPolicyId
-&gt; TokenName
-&gt; TokenQuantity
-&gt; UTxOToken
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UTxOToken"><span class="hs-identifier hs-var">UTxOToken</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486338"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486332"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash &quot;Tx&quot; -&gt; TxId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#TxId"><span class="hs-identifier hs-var">TxId</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682486314"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486313"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">TokenPolicyId
</span><a href="#local-6989586621682486312"><span class="hs-identifier hs-var">policy</span></a></span><span> </span><span class="annot"><span class="annottext">TokenName
</span><a href="#local-6989586621682486311"><span class="hs-identifier hs-var">token</span></a></span><span> </span><span class="annot"><span class="annottext">TokenQuantity
</span><a href="#local-6989586621682486310"><span class="hs-identifier hs-var">quantity</span></a></span><span>
</span><span id="line-365"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxIn"><span class="hs-identifier hs-type">W.TxIn</span></a></span><span> </span><span id="local-6989586621682486314"><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682486314"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span id="local-6989586621682486313"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486313"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxOut"><span class="hs-identifier hs-type">W.TxOut</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621682486309"><span class="annot"><span class="annottext">TokenBundle
$sel:tokens:TxOut :: TxOut -&gt; TokenBundle
tokens :: TokenBundle
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#%24sel%3Atokens%3ATxOut"><span class="hs-identifier hs-var hs-var">tokens</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(TxIn, TxOut)]
</span><a href="#local-6989586621682486316"><span class="hs-identifier hs-var">utxoMap</span></a></span><span>
</span><span id="line-366"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486307"><span class="annot"><span class="annottext">tokenList :: [(AssetId, TokenQuantity)]
</span><a href="#local-6989586621682486307"><span class="hs-identifier hs-var hs-var">tokenList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coin, [(AssetId, TokenQuantity)]) -&gt; [(AssetId, TokenQuantity)]
forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TokenBundle -&gt; (Coin, [(AssetId, TokenQuantity)])
</span><a href="Cardano.Wallet.Primitive.Types.TokenBundle.html#toFlatList"><span class="hs-identifier hs-var">TokenBundle.toFlatList</span></a></span><span> </span><span class="annot"><span class="annottext">TokenBundle
</span><a href="#local-6989586621682486309"><span class="hs-identifier hs-var">tokens</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.TokenMap.html#AssetId"><span class="hs-identifier hs-type">AssetId</span></a></span><span> </span><span id="local-6989586621682486312"><span class="annot"><span class="annottext">TokenPolicyId
</span><a href="#local-6989586621682486312"><span class="hs-identifier hs-var">policy</span></a></span></span><span> </span><span id="local-6989586621682486311"><span class="annot"><span class="annottext">TokenName
</span><a href="#local-6989586621682486311"><span class="hs-identifier hs-var">token</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682486310"><span class="annot"><span class="annottext">TokenQuantity
</span><a href="#local-6989586621682486310"><span class="hs-identifier hs-var">quantity</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(AssetId, TokenQuantity)]
</span><a href="#local-6989586621682486307"><span class="hs-identifier hs-var">tokenList</span></a></span><span>
</span><span id="line-368"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-369"></span><span>    </span><span id="local-6989586621682486316"><span class="annot"><span class="annottext">utxoMap :: [(TxIn, TxOut)]
</span><a href="#local-6989586621682486316"><span class="hs-identifier hs-var hs-var">utxoMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map TxIn TxOut -&gt; [(TxIn, TxOut)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.assocs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UTxO -&gt; Map TxIn TxOut
</span><a href="Cardano.Wallet.Primitive.Types.UTxO.html#unUTxO"><span class="hs-identifier hs-var hs-var">W.unUTxO</span></a></span><span> </span><span class="annot"><span class="annottext">UTxO
</span><a href="#local-6989586621682486336"><span class="hs-identifier hs-var">wutxo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>
</span><span id="line-371"></span><span class="hs-comment">-- note: TxIn records must already be sorted by order</span><span>
</span><span id="line-372"></span><span class="hs-comment">-- and TxOut records must already by sorted by index.</span><span>
</span><span id="line-373"></span><span id="local-6989586621682486754"><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#checkpointFromEntity"><span class="hs-identifier hs-type">checkpointFromEntity</span></a></span><span>
</span><span id="line-374"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Checkpoint"><span class="hs-identifier hs-type">Checkpoint</span></a></span><span>
</span><span id="line-375"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UTxOToken"><span class="hs-identifier hs-type">UTxOToken</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#Discoveries"><span class="hs-identifier hs-type">Discoveries</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486754"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-377"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#WalletCheckpoint"><span class="hs-identifier hs-type">WalletCheckpoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486754"><span class="hs-identifier hs-type">s</span></a></span></span><span>
</span><span id="line-378"></span><span id="checkpointFromEntity"><span class="annot"><span class="annottext">checkpointFromEntity :: Checkpoint
-&gt; ([UTxO], [UTxOToken]) -&gt; Discoveries s -&gt; WalletCheckpoint s
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#checkpointFromEntity"><span class="hs-identifier hs-var hs-var">checkpointFromEntity</span></a></span></span><span> </span><span id="local-6989586621682486302"><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486302"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682486301"><span class="annot"><span class="annottext">[UTxO]
</span><a href="#local-6989586621682486301"><span class="hs-identifier hs-var">coins</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682486300"><span class="annot"><span class="annottext">[UTxOToken]
</span><a href="#local-6989586621682486300"><span class="hs-identifier hs-var">tokens</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-379"></span><span>    </span><span class="annot"><span class="annottext">BlockHeader -&gt; UTxO -&gt; Discoveries s -&gt; WalletCheckpoint s
forall s.
BlockHeader -&gt; UTxO -&gt; Discoveries s -&gt; WalletCheckpoint s
</span><a href="Cardano.Wallet.DB.WalletState.html#WalletCheckpoint"><span class="hs-identifier hs-var">WalletCheckpoint</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682486299"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">UTxO
</span><a href="#local-6989586621682486298"><span class="hs-identifier hs-var">utxo</span></a></span><span>
</span><span id="line-380"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-381"></span><span>    </span><span id="local-6989586621682486299"><span class="annot"><span class="annottext">header :: BlockHeader
</span><a href="#local-6989586621682486299"><span class="hs-identifier hs-var hs-var">header</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Checkpoint -&gt; BlockHeader
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#blockHeaderFromEntity"><span class="hs-identifier hs-var">blockHeaderFromEntity</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint
</span><a href="#local-6989586621682486302"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-382"></span><span>
</span><span id="line-383"></span><span>    </span><span id="local-6989586621682486298"><span class="annot"><span class="annottext">utxo :: UTxO
</span><a href="#local-6989586621682486298"><span class="hs-identifier hs-var hs-var">utxo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map TxIn TxOut -&gt; UTxO
</span><a href="Cardano.Wallet.Primitive.Types.UTxO.html#UTxO"><span class="hs-identifier hs-var">W.UTxO</span></a></span><span> </span><span class="annot"><span class="annottext">(Map TxIn TxOut -&gt; UTxO) -&gt; Map TxIn TxOut -&gt; UTxO
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleWhenMissing TxIn (Address, Coin) TxOut
-&gt; SimpleWhenMissing TxIn TokenBundle TxOut
-&gt; SimpleWhenMatched TxIn (Address, Coin) TokenBundle TxOut
-&gt; Map TxIn (Address, Coin)
-&gt; Map TxIn TokenBundle
-&gt; Map TxIn TxOut
forall k a c b.
Ord k =&gt;
SimpleWhenMissing k a c
-&gt; SimpleWhenMissing k b c
-&gt; SimpleWhenMatched k a b c
-&gt; Map k a
-&gt; Map k b
-&gt; Map k c
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.merge</span></a></span><span>
</span><span id="line-384"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TxIn -&gt; (Address, Coin) -&gt; TxOut)
-&gt; SimpleWhenMissing TxIn (Address, Coin) TxOut
forall (f :: * -&gt; *) k x y.
Applicative f =&gt;
(k -&gt; x -&gt; y) -&gt; WhenMissing f k x y
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.mapMissing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Address, Coin) -&gt; TxOut) -&gt; TxIn -&gt; (Address, Coin) -&gt; TxOut
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">(Address, Coin) -&gt; TxOut
</span><a href="#local-6989586621682486293"><span class="hs-identifier hs-var">mkFromCoin</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- No assets, only coins</span><span>
</span><span id="line-385"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimpleWhenMissing TxIn TokenBundle TxOut
forall (f :: * -&gt; *) k x y. Applicative f =&gt; WhenMissing f k x y
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.dropMissing</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Only assets, impossible.</span><span>
</span><span id="line-386"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TxIn -&gt; (Address, Coin) -&gt; TokenBundle -&gt; TxOut)
-&gt; SimpleWhenMatched TxIn (Address, Coin) TokenBundle TxOut
forall (f :: * -&gt; *) k x y z.
Applicative f =&gt;
(k -&gt; x -&gt; y -&gt; z) -&gt; WhenMatched f k x y z
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.zipWithMatched</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Address, Coin) -&gt; TokenBundle -&gt; TxOut)
-&gt; TxIn -&gt; (Address, Coin) -&gt; TokenBundle -&gt; TxOut
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">(Address, Coin) -&gt; TokenBundle -&gt; TxOut
</span><a href="#local-6989586621682486290"><span class="hs-identifier hs-var">mkFromBoth</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Both assets and coins</span><span>
</span><span id="line-387"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(TxIn, (Address, Coin))] -&gt; Map TxIn (Address, Coin)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span>
</span><span id="line-388"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash &quot;Tx&quot; -&gt; Word32 -&gt; TxIn
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxIn"><span class="hs-identifier hs-var">W.TxIn</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682486289"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486288"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682486287"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621682486286"><span class="hs-identifier hs-var">coin</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-389"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#TxId"><span class="hs-identifier hs-type">TxId</span></a></span><span> </span><span id="local-6989586621682486289"><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682486289"><span class="hs-identifier hs-var">input</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682486288"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486288"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span id="local-6989586621682486287"><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682486287"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span id="local-6989586621682486286"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621682486286"><span class="hs-identifier hs-var">coin</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[UTxO]
</span><a href="#local-6989586621682486301"><span class="hs-identifier hs-var">coins</span></a></span><span>
</span><span id="line-390"></span><span>            </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-391"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TokenBundle -&gt; TokenBundle -&gt; TokenBundle)
-&gt; [(TxIn, TokenBundle)] -&gt; Map TxIn TokenBundle
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromListWith</span></a></span><span> </span><span class="annot"><span class="annottext">TokenBundle -&gt; TokenBundle -&gt; TokenBundle
</span><a href="Cardano.Wallet.Primitive.Types.TokenBundle.html#add"><span class="hs-identifier hs-var">TokenBundle.add</span></a></span><span>
</span><span id="line-392"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash &quot;Tx&quot; -&gt; Word32 -&gt; TxIn
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxIn"><span class="hs-identifier hs-var">W.TxIn</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682486283"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486282"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UTxOToken -&gt; TokenBundle
</span><a href="#local-6989586621682486281"><span class="hs-identifier hs-var">mkTokenEntry</span></a></span><span> </span><span class="annot"><span class="annottext">UTxOToken
</span><a href="#local-6989586621682486280"><span class="hs-identifier hs-var">token</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682486280"><span class="annot"><span class="annottext">token :: UTxOToken
</span><a href="#local-6989586621682486280"><span class="hs-identifier hs-var">token</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#UTxOToken"><span class="hs-identifier hs-type">UTxOToken</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#TxId"><span class="hs-identifier hs-type">TxId</span></a></span><span> </span><span id="local-6989586621682486283"><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682486283"><span class="hs-identifier hs-var">input</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682486282"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486282"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="annot"><span class="annottext">TokenPolicyId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TokenName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TokenQuantity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[UTxOToken]
</span><a href="#local-6989586621682486300"><span class="hs-identifier hs-var">tokens</span></a></span><span>
</span><span id="line-394"></span><span>            </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span>    </span><span class="annot"><a href="#local-6989586621682486293"><span class="hs-identifier hs-type">mkFromCoin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">W.Address</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Coin.html#Coin"><span class="hs-identifier hs-type">W.Coin</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxOut"><span class="hs-identifier hs-type">W.TxOut</span></a></span><span>
</span><span id="line-397"></span><span>    </span><span id="local-6989586621682486293"><span class="annot"><span class="annottext">mkFromCoin :: (Address, Coin) -&gt; TxOut
</span><a href="#local-6989586621682486293"><span class="hs-identifier hs-var hs-var">mkFromCoin</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682486279"><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682486279"><span class="hs-identifier hs-var">addr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682486278"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621682486278"><span class="hs-identifier hs-var">coin</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-398"></span><span>        </span><span class="annot"><span class="annottext">Address -&gt; TokenBundle -&gt; TxOut
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxOut"><span class="hs-identifier hs-var">W.TxOut</span></a></span><span> </span><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682486279"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin -&gt; TokenBundle
</span><a href="Cardano.Wallet.Primitive.Types.TokenBundle.html#fromCoin"><span class="hs-identifier hs-var">TokenBundle.fromCoin</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621682486278"><span class="hs-identifier hs-var">coin</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span>    </span><span class="annot"><a href="#local-6989586621682486290"><span class="hs-identifier hs-type">mkFromBoth</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">W.Address</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Coin.html#Coin"><span class="hs-identifier hs-type">W.Coin</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.TokenBundle.html#TokenBundle"><span class="hs-identifier hs-type">TokenBundle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxOut"><span class="hs-identifier hs-type">W.TxOut</span></a></span><span>
</span><span id="line-401"></span><span>    </span><span id="local-6989586621682486290"><span class="annot"><span class="annottext">mkFromBoth :: (Address, Coin) -&gt; TokenBundle -&gt; TxOut
</span><a href="#local-6989586621682486290"><span class="hs-identifier hs-var hs-var">mkFromBoth</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682486276"><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682486276"><span class="hs-identifier hs-var">addr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682486275"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621682486275"><span class="hs-identifier hs-var">coin</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682486274"><span class="annot"><span class="annottext">TokenBundle
</span><a href="#local-6989586621682486274"><span class="hs-identifier hs-var">bundle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-402"></span><span>        </span><span class="annot"><span class="annottext">Address -&gt; TokenBundle -&gt; TxOut
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxOut"><span class="hs-identifier hs-var">W.TxOut</span></a></span><span> </span><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682486276"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TokenBundle -&gt; TokenBundle -&gt; TokenBundle
</span><a href="Cardano.Wallet.Primitive.Types.TokenBundle.html#add"><span class="hs-identifier hs-var">TokenBundle.add</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin -&gt; TokenBundle
</span><a href="Cardano.Wallet.Primitive.Types.TokenBundle.html#fromCoin"><span class="hs-identifier hs-var">TokenBundle.fromCoin</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621682486275"><span class="hs-identifier hs-var">coin</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TokenBundle
</span><a href="#local-6989586621682486274"><span class="hs-identifier hs-var">bundle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span>    </span><span id="local-6989586621682486281"><span class="annot"><span class="annottext">mkTokenEntry :: UTxOToken -&gt; TokenBundle
</span><a href="#local-6989586621682486281"><span class="hs-identifier hs-var hs-var">mkTokenEntry</span></a></span></span><span> </span><span id="local-6989586621682486273"><span class="annot"><span class="annottext">UTxOToken
</span><a href="#local-6989586621682486273"><span class="hs-identifier hs-var">token</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; [(AssetId, TokenQuantity)] -&gt; TokenBundle
</span><a href="Cardano.Wallet.Primitive.Types.TokenBundle.html#fromFlatList"><span class="hs-identifier hs-var">TokenBundle.fromFlatList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural -&gt; Coin
</span><a href="Cardano.Wallet.Primitive.Types.Coin.html#Coin"><span class="hs-identifier hs-var">W.Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TokenPolicyId -&gt; TokenName -&gt; AssetId
</span><a href="Cardano.Wallet.Primitive.Types.TokenMap.html#AssetId"><span class="hs-identifier hs-var">AssetId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UTxOToken -&gt; TokenPolicyId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#utxoTokenPolicyId"><span class="hs-identifier hs-var hs-var">utxoTokenPolicyId</span></a></span><span> </span><span class="annot"><span class="annottext">UTxOToken
</span><a href="#local-6989586621682486273"><span class="hs-identifier hs-var">token</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UTxOToken -&gt; TokenName
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#utxoTokenName"><span class="hs-identifier hs-var hs-var">utxoTokenName</span></a></span><span> </span><span class="annot"><span class="annottext">UTxOToken
</span><a href="#local-6989586621682486273"><span class="hs-identifier hs-var">token</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UTxOToken -&gt; TokenQuantity
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#utxoTokenQuantity"><span class="hs-identifier hs-var hs-var">utxoTokenQuantity</span></a></span><span> </span><span class="annot"><span class="annottext">UTxOToken
</span><a href="#local-6989586621682486273"><span class="hs-identifier hs-var">token</span></a></span><span>
</span><span id="line-407"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    AddressBook storage
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-413"></span><span class="hs-comment">-- | Functions for saving / loading the wallet's address book to / from SQLite</span><span>
</span><span id="line-414"></span><span class="hs-keyword">class</span><span> </span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#AddressBookIso"><span class="hs-identifier hs-type">AddressBookIso</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486804"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="PersistAddressBook"><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-var">PersistAddressBook</span></a></span></span><span> </span><span id="local-6989586621682486804"><span class="annot"><a href="#local-6989586621682486804"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-415"></span><span>    </span><span id="insertPrologue"><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertPrologue"><span class="hs-identifier hs-type">insertPrologue</span></a></span></span><span>
</span><span id="line-416"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#Prologue"><span class="hs-identifier hs-type">Prologue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486804"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>    </span><span id="insertDiscoveries"><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertDiscoveries"><span class="hs-identifier hs-type">insertDiscoveries</span></a></span></span><span>
</span><span id="line-418"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">W.SlotNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#Discoveries"><span class="hs-identifier hs-type">Discoveries</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486804"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span>    </span><span id="loadPrologue"><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#loadPrologue"><span class="hs-identifier hs-type">loadPrologue</span></a></span></span><span>
</span><span id="line-421"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#Prologue"><span class="hs-identifier hs-type">Prologue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486804"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>    </span><span id="loadDiscoveries"><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#loadDiscoveries"><span class="hs-identifier hs-type">loadDiscoveries</span></a></span></span><span>
</span><span id="line-423"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">W.SlotNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#Discoveries"><span class="hs-identifier hs-type">Discoveries</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486804"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Sequential address book storage
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-428"></span><span class="hs-comment">-- piggy-back on SeqState existing instance, to simulate the same behavior.</span><span>
</span><span id="line-429"></span><span id="local-6989586621682486265"><span id="local-6989586621682486266"><span id="local-6989586621682486267"><span class="hs-keyword">instance</span><span>
</span><span id="line-430"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#SeqState"><span class="hs-identifier hs-type">Seq.SeqState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486267"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486266"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682486266"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-type">==</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.SharedKey.html#SharedKey"><span class="hs-identifier hs-type">SharedKey</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">False</span></a></span><span>
</span><span id="line-432"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#SeqState"><span class="hs-identifier hs-type">Seq.SeqState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486267"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486266"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#SeqAnyState"><span class="hs-identifier hs-type">Seq.SeqAnyState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486267"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486266"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486265"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-436"></span><span>    </span><span id="local-6989586621682486258"><span class="annot"><span class="annottext">insertPrologue :: WalletId -&gt; Prologue (SeqAnyState n k p) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486258"><span class="hs-identifier hs-var hs-var hs-var hs-var">insertPrologue</span></a></span></span><span> </span><span id="local-6989586621682486257"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486257"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#PS"><span class="hs-identifier hs-type">PS</span></a></span><span> </span><span id="local-6989586621682486255"><span class="annot"><a href="#local-6989586621682486255"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; Prologue (SeqState n k) -&gt; SqlPersistT IO ()
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; Prologue s -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertPrologue"><span class="hs-identifier hs-var">insertPrologue</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486257"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Prologue (SeqState n k)
</span><a href="#local-6989586621682486255"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-437"></span><span>    </span><span id="local-6989586621682486254"><span class="annot"><span class="annottext">insertDiscoveries :: WalletId
-&gt; SlotNo -&gt; Discoveries (SeqAnyState n k p) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486254"><span class="hs-identifier hs-var hs-var hs-var hs-var">insertDiscoveries</span></a></span></span><span> </span><span id="local-6989586621682486253"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486253"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682486252"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486252"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#DS"><span class="hs-identifier hs-type">DS</span></a></span><span> </span><span id="local-6989586621682486250"><span class="annot"><a href="#local-6989586621682486250"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; SlotNo -&gt; Discoveries (SeqState n k) -&gt; SqlPersistT IO ()
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; SlotNo -&gt; Discoveries s -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertDiscoveries"><span class="hs-identifier hs-var">insertDiscoveries</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486253"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486252"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">Discoveries (SeqState n k)
</span><a href="#local-6989586621682486250"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-438"></span><span>    </span><span id="local-6989586621682486249"><span class="annot"><span class="annottext">loadPrologue :: WalletId -&gt; SqlPersistT IO (Maybe (Prologue (SeqAnyState n k p)))
</span><a href="#local-6989586621682486249"><span class="hs-identifier hs-var hs-var hs-var hs-var">loadPrologue</span></a></span></span><span> </span><span id="local-6989586621682486248"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486248"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Prologue (SeqState n k) -&gt; Prologue (SeqAnyState n k p))
-&gt; Maybe (Prologue (SeqState n k))
-&gt; Maybe (Prologue (SeqAnyState n k p))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Prologue (SeqState n k) -&gt; Prologue (SeqAnyState n k p)
forall (n :: NetworkDiscriminant) (key :: Depth -&gt; * -&gt; *)
       (p :: Nat).
Prologue (SeqState n key) -&gt; Prologue (SeqAnyState n key p)
</span><a href="Cardano.Wallet.Address.Book.html#PS"><span class="hs-identifier hs-var">PS</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Prologue (SeqState n k))
 -&gt; Maybe (Prologue (SeqAnyState n k p)))
-&gt; ReaderT SqlBackend IO (Maybe (Prologue (SeqState n k)))
-&gt; SqlPersistT IO (Maybe (Prologue (SeqAnyState n k p)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ReaderT SqlBackend IO (Maybe (Prologue (SeqState n k)))
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; SqlPersistT IO (Maybe (Prologue s))
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#loadPrologue"><span class="hs-identifier hs-var">loadPrologue</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486248"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-439"></span><span>    </span><span id="local-6989586621682486247"><span class="annot"><span class="annottext">loadDiscoveries :: WalletId
-&gt; SlotNo -&gt; SqlPersistT IO (Discoveries (SeqAnyState n k p))
</span><a href="#local-6989586621682486247"><span class="hs-identifier hs-var hs-var hs-var hs-var">loadDiscoveries</span></a></span></span><span> </span><span id="local-6989586621682486246"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486246"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682486245"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486245"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Discoveries (SeqState n k) -&gt; Discoveries (SeqAnyState n k p)
forall (n :: NetworkDiscriminant) (key :: Depth -&gt; * -&gt; *)
       (p :: Nat).
Discoveries (SeqState n key) -&gt; Discoveries (SeqAnyState n key p)
</span><a href="Cardano.Wallet.Address.Book.html#DS"><span class="hs-identifier hs-var">DS</span></a></span><span> </span><span class="annot"><span class="annottext">(Discoveries (SeqState n k) -&gt; Discoveries (SeqAnyState n k p))
-&gt; ReaderT SqlBackend IO (Discoveries (SeqState n k))
-&gt; SqlPersistT IO (Discoveries (SeqAnyState n k p))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; SlotNo -&gt; ReaderT SqlBackend IO (Discoveries (SeqState n k))
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; SlotNo -&gt; SqlPersistT IO (Discoveries s)
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#loadDiscoveries"><span class="hs-identifier hs-var">loadDiscoveries</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486246"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486245"><span class="hs-identifier hs-var">sl</span></a></span></span></span></span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span id="local-6989586621682486243"><span id="local-6989586621682486244"><span class="hs-keyword">instance</span><span>
</span><span id="line-442"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPublicKey"><span class="hs-identifier hs-type">PersistPublicKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682486244"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AccountK"><span class="hs-identifier hs-type">AccountK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPublicKey"><span class="hs-identifier hs-type">PersistPublicKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682486244"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPublicKey"><span class="hs-identifier hs-type">PersistPublicKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682486244"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PolicyK"><span class="hs-identifier hs-type">PolicyK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#MkKeyFingerprint"><span class="hs-identifier hs-type">MkKeyFingerprint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486244"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486243"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682486244"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PaymentAddress"><span class="hs-identifier hs-type">PaymentAddress</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486243"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486244"><span class="hs-identifier hs-type">key</span></a></span><span>
</span><span id="line-447"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#SoftDerivation"><span class="hs-identifier hs-type">SoftDerivation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486244"><span class="hs-identifier hs-type">key</span></a></span><span>
</span><span id="line-448"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Typeable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486243"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-449"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682486244"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-type">==</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.SharedKey.html#SharedKey"><span class="hs-identifier hs-type">SharedKey</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">False</span></a></span><span>
</span><span id="line-450"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#SeqState"><span class="hs-identifier hs-type">Seq.SeqState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486243"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486244"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#SeqState"><span class="hs-identifier hs-type">Seq.SeqState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486243"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486244"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span>    </span><span id="local-6989586621682486237"><span class="annot"><span class="annottext">insertPrologue :: WalletId -&gt; Prologue (SeqState n key) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486237"><span class="hs-identifier hs-var hs-var hs-var hs-var">insertPrologue</span></a></span></span><span> </span><span id="local-6989586621682486236"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486236"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#SeqPrologue"><span class="hs-identifier hs-type">SeqPrologue</span></a></span><span> </span><span id="local-6989586621682486234"><span class="annot"><a href="#local-6989586621682486234"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-454"></span><span>        </span><span class="annot"><span class="annottext">Key SeqState -&gt; SeqState -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
Key record -&gt; record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">repsert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; Key SeqState
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateKey"><span class="hs-identifier hs-var">SeqStateKey</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486236"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SeqState -&gt; SqlPersistT IO ()) -&gt; SeqState -&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState :: WalletId
-&gt; AddressPoolGap
-&gt; AddressPoolGap
-&gt; ByteString
-&gt; Maybe ByteString
-&gt; ByteString
-&gt; DerivationPrefix
-&gt; SeqState
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqState"><span class="hs-identifier hs-type">SeqState</span></a></span><span>
</span><span id="line-455"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">seqStateWalletId :: WalletId
</span><a href="#local-6989586621682486231"><span class="hs-identifier hs-var">seqStateWalletId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486236"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-456"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">seqStateExternalGap :: AddressPoolGap
</span><a href="#local-6989586621682486230"><span class="hs-identifier hs-var">seqStateExternalGap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SeqAddressPool 'UtxoExternal key -&gt; AddressPoolGap
forall (c :: Role) (k :: Depth -&gt; * -&gt; *).
SeqAddressPool c k -&gt; AddressPoolGap
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#getGap"><span class="hs-identifier hs-var">Seq.getGap</span></a></span><span> </span><span class="annot"><span class="annottext">(SeqAddressPool 'UtxoExternal key -&gt; AddressPoolGap)
-&gt; SeqAddressPool 'UtxoExternal key -&gt; AddressPoolGap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState n key -&gt; SeqAddressPool 'UtxoExternal key
forall (n :: NetworkDiscriminant) (k :: Depth -&gt; * -&gt; *).
SeqState n k -&gt; SeqAddressPool 'UtxoExternal k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#externalPool"><span class="hs-identifier hs-var hs-var">Seq.externalPool</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState n key
</span><a href="#local-6989586621682486234"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-457"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">seqStateInternalGap :: AddressPoolGap
</span><a href="#local-6989586621682486227"><span class="hs-identifier hs-var">seqStateInternalGap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SeqAddressPool 'UtxoInternal key -&gt; AddressPoolGap
forall (c :: Role) (k :: Depth -&gt; * -&gt; *).
SeqAddressPool c k -&gt; AddressPoolGap
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#getGap"><span class="hs-identifier hs-var">Seq.getGap</span></a></span><span> </span><span class="annot"><span class="annottext">(SeqAddressPool 'UtxoInternal key -&gt; AddressPoolGap)
-&gt; SeqAddressPool 'UtxoInternal key -&gt; AddressPoolGap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState n key -&gt; SeqAddressPool 'UtxoInternal key
forall (n :: NetworkDiscriminant) (k :: Depth -&gt; * -&gt; *).
SeqState n k -&gt; SeqAddressPool 'UtxoInternal k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#internalPool"><span class="hs-identifier hs-var hs-var">Seq.internalPool</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState n key
</span><a href="#local-6989586621682486234"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-458"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">seqStateAccountXPub :: ByteString
</span><a href="#local-6989586621682486225"><span class="hs-identifier hs-var">seqStateAccountXPub</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">key 'AccountK XPub -&gt; ByteString
forall (key :: * -&gt; *).
PersistPublicKey key =&gt;
key XPub -&gt; ByteString
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#serializeXPub"><span class="hs-identifier hs-var">serializeXPub</span></a></span><span> </span><span class="annot"><span class="annottext">(key 'AccountK XPub -&gt; ByteString)
-&gt; key 'AccountK XPub -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState n key -&gt; key 'AccountK XPub
forall (n :: NetworkDiscriminant) (k :: Depth -&gt; * -&gt; *).
SeqState n k -&gt; k 'AccountK XPub
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#accountXPub"><span class="hs-identifier hs-var hs-var">Seq.accountXPub</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState n key
</span><a href="#local-6989586621682486234"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-459"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">seqStatePolicyXPub :: Maybe ByteString
</span><a href="#local-6989586621682486222"><span class="hs-identifier hs-var">seqStatePolicyXPub</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">key 'PolicyK XPub -&gt; ByteString
forall (key :: * -&gt; *).
PersistPublicKey key =&gt;
key XPub -&gt; ByteString
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#serializeXPub"><span class="hs-identifier hs-var">serializeXPub</span></a></span><span> </span><span class="annot"><span class="annottext">(key 'PolicyK XPub -&gt; ByteString)
-&gt; Maybe (key 'PolicyK XPub) -&gt; Maybe ByteString
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState n key -&gt; Maybe (key 'PolicyK XPub)
forall (n :: NetworkDiscriminant) (k :: Depth -&gt; * -&gt; *).
SeqState n k -&gt; Maybe (k 'PolicyK XPub)
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#policyXPub"><span class="hs-identifier hs-var hs-var">Seq.policyXPub</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState n key
</span><a href="#local-6989586621682486234"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-460"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">seqStateRewardXPub :: ByteString
</span><a href="#local-6989586621682486220"><span class="hs-identifier hs-var">seqStateRewardXPub</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">key 'AddressK XPub -&gt; ByteString
forall (key :: * -&gt; *).
PersistPublicKey key =&gt;
key XPub -&gt; ByteString
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#serializeXPub"><span class="hs-identifier hs-var">serializeXPub</span></a></span><span> </span><span class="annot"><span class="annottext">(key 'AddressK XPub -&gt; ByteString)
-&gt; key 'AddressK XPub -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState n key -&gt; key 'AddressK XPub
forall (n :: NetworkDiscriminant) (k :: Depth -&gt; * -&gt; *).
SeqState n k -&gt; k 'AddressK XPub
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#rewardAccountKey"><span class="hs-identifier hs-var hs-var">Seq.rewardAccountKey</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState n key
</span><a href="#local-6989586621682486234"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-461"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">seqStateDerivationPrefix :: DerivationPrefix
</span><a href="#local-6989586621682486218"><span class="hs-identifier hs-var">seqStateDerivationPrefix</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SeqState n key -&gt; DerivationPrefix
forall (n :: NetworkDiscriminant) (k :: Depth -&gt; * -&gt; *).
SeqState n k -&gt; DerivationPrefix
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#derivationPrefix"><span class="hs-identifier hs-var hs-var">Seq.derivationPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState n key
</span><a href="#local-6989586621682486234"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-462"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-463"></span><span>        </span><span class="annot"><span class="annottext">[Filter SeqStatePendingIx] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField SeqStatePendingIx WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField SeqStatePendingIx typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStatePendingWalletId"><span class="hs-identifier hs-var">SeqStatePendingWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SeqStatePendingIx WalletId
-&gt; WalletId -&gt; Filter SeqStatePendingIx
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486236"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-464"></span><span>        </span><span class="annot"><span class="annottext">([SeqStatePendingIx] -&gt; SqlPersistT IO ())
-&gt; [SeqStatePendingIx] -&gt; SqlPersistT IO ()
forall record b.
PersistEntity record =&gt;
([record] -&gt; SqlPersistT IO b) -&gt; [record] -&gt; SqlPersistT IO ()
</span><a href="Cardano.DB.Sqlite.html#dbChunked"><span class="hs-identifier hs-var">dbChunked</span></a></span><span>
</span><span id="line-465"></span><span>            </span><span class="annot"><span class="annottext">[SeqStatePendingIx] -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insertMany_</span></a></span><span>
</span><span id="line-466"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; PendingIxs 'AddressK -&gt; [SeqStatePendingIx]
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkSeqStatePendingIxs"><span class="hs-identifier hs-var">mkSeqStatePendingIxs</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486236"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">(PendingIxs 'AddressK -&gt; [SeqStatePendingIx])
-&gt; PendingIxs 'AddressK -&gt; [SeqStatePendingIx]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState n key -&gt; PendingIxs 'AddressK
forall (n :: NetworkDiscriminant) (k :: Depth -&gt; * -&gt; *).
SeqState n k -&gt; PendingIxs 'AddressK
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#pendingChangeIxs"><span class="hs-identifier hs-var hs-var">Seq.pendingChangeIxs</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState n key
</span><a href="#local-6989586621682486234"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span>    </span><span id="local-6989586621682486213"><span class="annot"><span class="annottext">insertDiscoveries :: WalletId
-&gt; SlotNo -&gt; Discoveries (SeqState n key) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486213"><span class="hs-identifier hs-var hs-var hs-var hs-var">insertDiscoveries</span></a></span></span><span> </span><span id="local-6989586621682486212"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486212"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682486211"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486211"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#SeqDiscoveries"><span class="hs-identifier hs-type">SeqDiscoveries</span></a></span><span> </span><span id="local-6989586621682486209"><span class="annot"><a href="#local-6989586621682486209"><span class="hs-identifier hs-var">ints</span></a></span></span><span> </span><span id="local-6989586621682486208"><span class="annot"><a href="#local-6989586621682486208"><span class="hs-identifier hs-var">exts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-469"></span><span>        </span><span class="annot"><span class="annottext">WalletId
-&gt; SlotNo -&gt; SeqAddressMap 'UtxoInternal key -&gt; SqlPersistT IO ()
forall (n :: NetworkDiscriminant) (c :: Role)
       (key :: Depth -&gt; * -&gt; *).
(PaymentAddress n key, Typeable c) =&gt;
WalletId -&gt; SlotNo -&gt; SeqAddressMap c key -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertSeqAddressMap"><span class="hs-identifier hs-var">insertSeqAddressMap</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486243"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486212"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486211"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">SeqAddressMap 'UtxoInternal key
</span><a href="#local-6989586621682486209"><span class="hs-identifier hs-var">ints</span></a></span><span>
</span><span id="line-470"></span><span>        </span><span class="annot"><span class="annottext">WalletId
-&gt; SlotNo -&gt; SeqAddressMap 'UtxoExternal key -&gt; SqlPersistT IO ()
forall (n :: NetworkDiscriminant) (c :: Role)
       (key :: Depth -&gt; * -&gt; *).
(PaymentAddress n key, Typeable c) =&gt;
WalletId -&gt; SlotNo -&gt; SeqAddressMap c key -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertSeqAddressMap"><span class="hs-identifier hs-var">insertSeqAddressMap</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486243"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486212"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486211"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">SeqAddressMap 'UtxoExternal key
</span><a href="#local-6989586621682486208"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-471"></span><span>
</span><span id="line-472"></span><span>    </span><span id="local-6989586621682486206"><span class="annot"><span class="annottext">loadPrologue :: WalletId -&gt; SqlPersistT IO (Maybe (Prologue (SeqState n key)))
</span><a href="#local-6989586621682486206"><span class="hs-identifier hs-var hs-var hs-var hs-var">loadPrologue</span></a></span></span><span> </span><span id="local-6989586621682486205"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486205"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeT (SqlPersistT IO) (Prologue (SeqState n key))
-&gt; SqlPersistT IO (Maybe (Prologue (SeqState n key)))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var hs-var">runMaybeT</span></a></span><span> </span><span class="annot"><span class="annottext">(MaybeT (SqlPersistT IO) (Prologue (SeqState n key))
 -&gt; SqlPersistT IO (Maybe (Prologue (SeqState n key))))
-&gt; MaybeT (SqlPersistT IO) (Prologue (SeqState n key))
-&gt; SqlPersistT IO (Maybe (Prologue (SeqState n key)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-473"></span><span>        </span><span id="local-6989586621682486203"><span class="annot"><span class="annottext">Entity SeqState
</span><a href="#local-6989586621682486203"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Maybe (Entity SeqState))
-&gt; MaybeT (SqlPersistT IO) (Entity SeqState)
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">MaybeT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Maybe (Entity SeqState))
 -&gt; MaybeT (SqlPersistT IO) (Entity SeqState))
-&gt; ReaderT SqlBackend IO (Maybe (Entity SeqState))
-&gt; MaybeT (SqlPersistT IO) (Entity SeqState)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter SeqState]
-&gt; [SelectOpt SeqState]
-&gt; ReaderT SqlBackend IO (Maybe (Entity SeqState))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField SeqState WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField SeqState typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateWalletId"><span class="hs-identifier hs-var">SeqStateWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SeqState WalletId -&gt; WalletId -&gt; Filter SeqState
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486205"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-474"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqState"><span class="hs-identifier hs-type">SeqState</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682486200"><span class="annot"><span class="annottext">AddressPoolGap
</span><a href="#local-6989586621682486200"><span class="hs-identifier hs-var">eGap</span></a></span></span><span> </span><span id="local-6989586621682486199"><span class="annot"><span class="annottext">AddressPoolGap
</span><a href="#local-6989586621682486199"><span class="hs-identifier hs-var">iGap</span></a></span></span><span> </span><span id="local-6989586621682486198"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682486198"><span class="hs-identifier hs-var">accountBytes</span></a></span></span><span> </span><span id="local-6989586621682486197"><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621682486197"><span class="hs-identifier hs-var">policyBytes</span></a></span></span><span> </span><span id="local-6989586621682486196"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682486196"><span class="hs-identifier hs-var">rewardBytes</span></a></span></span><span> </span><span id="local-6989586621682486195"><span class="annot"><span class="annottext">DerivationPrefix
</span><a href="#local-6989586621682486195"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-475"></span><span>                </span><span class="annot"><span class="annottext">Entity SeqState -&gt; SeqState
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">Entity SeqState
</span><a href="#local-6989586621682486203"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-476"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486194"><span class="annot"><span class="annottext">accountXPub :: key 'AccountK XPub
</span><a href="#local-6989586621682486194"><span class="hs-identifier hs-var hs-var">accountXPub</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; key 'AccountK XPub
forall (key :: * -&gt; *).
PersistPublicKey key =&gt;
ByteString -&gt; key XPub
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#unsafeDeserializeXPub"><span class="hs-identifier hs-var">unsafeDeserializeXPub</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682486198"><span class="hs-identifier hs-var">accountBytes</span></a></span><span>
</span><span id="line-477"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486192"><span class="annot"><span class="annottext">rewardXPub :: key 'AddressK XPub
</span><a href="#local-6989586621682486192"><span class="hs-identifier hs-var hs-var">rewardXPub</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; key 'AddressK XPub
forall (key :: * -&gt; *).
PersistPublicKey key =&gt;
ByteString -&gt; key XPub
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#unsafeDeserializeXPub"><span class="hs-identifier hs-var">unsafeDeserializeXPub</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682486196"><span class="hs-identifier hs-var">rewardBytes</span></a></span><span>
</span><span id="line-478"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486191"><span class="annot"><span class="annottext">policyXPub :: Maybe (key 'PolicyK XPub)
</span><a href="#local-6989586621682486191"><span class="hs-identifier hs-var hs-var">policyXPub</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; key 'PolicyK XPub
forall (key :: * -&gt; *).
PersistPublicKey key =&gt;
ByteString -&gt; key XPub
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#unsafeDeserializeXPub"><span class="hs-identifier hs-var">unsafeDeserializeXPub</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; key 'PolicyK XPub)
-&gt; Maybe ByteString -&gt; Maybe (key 'PolicyK XPub)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621682486197"><span class="hs-identifier hs-var">policyBytes</span></a></span><span>
</span><span id="line-479"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486190"><span class="annot"><span class="annottext">intPool :: SeqAddressPool 'UtxoInternal key
</span><a href="#local-6989586621682486190"><span class="hs-identifier hs-var hs-var">intPool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">key 'AccountK XPub
-&gt; AddressPoolGap -&gt; SeqAddressPool 'UtxoInternal key
forall (n :: NetworkDiscriminant) (c :: Role)
       (key :: Depth -&gt; * -&gt; *).
(SupportsDiscovery n key, Typeable c) =&gt;
key 'AccountK XPub -&gt; AddressPoolGap -&gt; SeqAddressPool c key
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#newSeqAddressPool"><span class="hs-identifier hs-var">Seq.newSeqAddressPool</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486243"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><span class="annottext">key 'AccountK XPub
</span><a href="#local-6989586621682486194"><span class="hs-identifier hs-var">accountXPub</span></a></span><span> </span><span class="annot"><span class="annottext">AddressPoolGap
</span><a href="#local-6989586621682486199"><span class="hs-identifier hs-var">iGap</span></a></span><span>
</span><span id="line-480"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486188"><span class="annot"><span class="annottext">extPool :: SeqAddressPool 'UtxoExternal key
</span><a href="#local-6989586621682486188"><span class="hs-identifier hs-var hs-var">extPool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">key 'AccountK XPub
-&gt; AddressPoolGap -&gt; SeqAddressPool 'UtxoExternal key
forall (n :: NetworkDiscriminant) (c :: Role)
       (key :: Depth -&gt; * -&gt; *).
(SupportsDiscovery n key, Typeable c) =&gt;
key 'AccountK XPub -&gt; AddressPoolGap -&gt; SeqAddressPool c key
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#newSeqAddressPool"><span class="hs-identifier hs-var">Seq.newSeqAddressPool</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486243"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><span class="annottext">key 'AccountK XPub
</span><a href="#local-6989586621682486194"><span class="hs-identifier hs-var">accountXPub</span></a></span><span> </span><span class="annot"><span class="annottext">AddressPoolGap
</span><a href="#local-6989586621682486200"><span class="hs-identifier hs-var">eGap</span></a></span><span>
</span><span id="line-481"></span><span>        </span><span id="local-6989586621682486187"><span class="annot"><span class="annottext">PendingIxs 'AddressK
</span><a href="#local-6989586621682486187"><span class="hs-identifier hs-var">pendingChangeIxs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (PendingIxs 'AddressK)
-&gt; MaybeT (SqlPersistT IO) (PendingIxs 'AddressK)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (PendingIxs 'AddressK)
 -&gt; MaybeT (SqlPersistT IO) (PendingIxs 'AddressK))
-&gt; ReaderT SqlBackend IO (PendingIxs 'AddressK)
-&gt; MaybeT (SqlPersistT IO) (PendingIxs 'AddressK)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ReaderT SqlBackend IO (PendingIxs 'AddressK)
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectSeqStatePendingIxs"><span class="hs-identifier hs-var">selectSeqStatePendingIxs</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486205"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-482"></span><span>        </span><span class="annot"><span class="annottext">Prologue (SeqState n key)
-&gt; MaybeT (SqlPersistT IO) (Prologue (SeqState n key))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Prologue (SeqState n key)
 -&gt; MaybeT (SqlPersistT IO) (Prologue (SeqState n key)))
-&gt; Prologue (SeqState n key)
-&gt; MaybeT (SqlPersistT IO) (Prologue (SeqState n key))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SeqState n key -&gt; Prologue (SeqState n key)
forall (n :: NetworkDiscriminant) (key :: Depth -&gt; * -&gt; *).
SeqState n key -&gt; Prologue (SeqState n key)
</span><a href="Cardano.Wallet.Address.Book.html#SeqPrologue"><span class="hs-identifier hs-var">SeqPrologue</span></a></span><span> </span><span class="annot"><span class="annottext">(SeqState n key -&gt; Prologue (SeqState n key))
-&gt; SeqState n key -&gt; Prologue (SeqState n key)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SeqAddressPool 'UtxoInternal key
-&gt; SeqAddressPool 'UtxoExternal key
-&gt; PendingIxs 'AddressK
-&gt; key 'AccountK XPub
-&gt; Maybe (key 'PolicyK XPub)
-&gt; key 'AddressK XPub
-&gt; DerivationPrefix
-&gt; SeqState n key
forall (n :: NetworkDiscriminant) (k :: Depth -&gt; * -&gt; *).
SeqAddressPool 'UtxoInternal k
-&gt; SeqAddressPool 'UtxoExternal k
-&gt; PendingIxs 'AddressK
-&gt; k 'AccountK XPub
-&gt; Maybe (k 'PolicyK XPub)
-&gt; k 'AddressK XPub
-&gt; DerivationPrefix
-&gt; SeqState n k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#SeqState"><span class="hs-identifier hs-var">Seq.SeqState</span></a></span><span>
</span><span id="line-483"></span><span>            </span><span class="annot"><span class="annottext">SeqAddressPool 'UtxoInternal key
</span><a href="#local-6989586621682486190"><span class="hs-identifier hs-var">intPool</span></a></span><span>
</span><span id="line-484"></span><span>            </span><span class="annot"><span class="annottext">SeqAddressPool 'UtxoExternal key
</span><a href="#local-6989586621682486188"><span class="hs-identifier hs-var">extPool</span></a></span><span>
</span><span id="line-485"></span><span>            </span><span class="annot"><span class="annottext">PendingIxs 'AddressK
</span><a href="#local-6989586621682486187"><span class="hs-identifier hs-var">pendingChangeIxs</span></a></span><span>
</span><span id="line-486"></span><span>            </span><span class="annot"><span class="annottext">key 'AccountK XPub
</span><a href="#local-6989586621682486194"><span class="hs-identifier hs-var">accountXPub</span></a></span><span>
</span><span id="line-487"></span><span>            </span><span class="annot"><span class="annottext">Maybe (key 'PolicyK XPub)
</span><a href="#local-6989586621682486191"><span class="hs-identifier hs-var">policyXPub</span></a></span><span>
</span><span id="line-488"></span><span>            </span><span class="annot"><span class="annottext">key 'AddressK XPub
</span><a href="#local-6989586621682486192"><span class="hs-identifier hs-var">rewardXPub</span></a></span><span>
</span><span id="line-489"></span><span>            </span><span class="annot"><span class="annottext">DerivationPrefix
</span><a href="#local-6989586621682486195"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span>    </span><span id="local-6989586621682486184"><span class="annot"><span class="annottext">loadDiscoveries :: WalletId -&gt; SlotNo -&gt; SqlPersistT IO (Discoveries (SeqState n key))
</span><a href="#local-6989586621682486184"><span class="hs-identifier hs-var hs-var hs-var hs-var">loadDiscoveries</span></a></span></span><span> </span><span id="local-6989586621682486183"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486183"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682486182"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486182"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-492"></span><span>        </span><span class="annot"><span class="annottext">SeqAddressMap 'UtxoInternal key
-&gt; SeqAddressMap 'UtxoExternal key -&gt; Discoveries (SeqState n key)
forall (n :: NetworkDiscriminant) (key :: Depth -&gt; * -&gt; *).
SeqAddressMap 'UtxoInternal key
-&gt; SeqAddressMap 'UtxoExternal key -&gt; Discoveries (SeqState n key)
</span><a href="Cardano.Wallet.Address.Book.html#SeqDiscoveries"><span class="hs-identifier hs-var">SeqDiscoveries</span></a></span><span>
</span><span id="line-493"></span><span>            </span><span class="annot"><span class="annottext">(SeqAddressMap 'UtxoInternal key
 -&gt; SeqAddressMap 'UtxoExternal key -&gt; Discoveries (SeqState n key))
-&gt; ReaderT SqlBackend IO (SeqAddressMap 'UtxoInternal key)
-&gt; ReaderT
     SqlBackend
     IO
     (SeqAddressMap 'UtxoExternal key -&gt; Discoveries (SeqState n key))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; SlotNo
-&gt; ReaderT SqlBackend IO (SeqAddressMap 'UtxoInternal key)
forall (c :: Role) (key :: Depth -&gt; * -&gt; *).
(MkKeyFingerprint key Address, Typeable c) =&gt;
WalletId -&gt; SlotNo -&gt; SqlPersistT IO (SeqAddressMap c key)
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectSeqAddressMap"><span class="hs-identifier hs-var">selectSeqAddressMap</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486183"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486182"><span class="hs-identifier hs-var">sl</span></a></span><span>
</span><span id="line-494"></span><span>            </span><span class="annot"><span class="annottext">ReaderT
  SqlBackend
  IO
  (SeqAddressMap 'UtxoExternal key -&gt; Discoveries (SeqState n key))
-&gt; ReaderT SqlBackend IO (SeqAddressMap 'UtxoExternal key)
-&gt; SqlPersistT IO (Discoveries (SeqState n key))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; SlotNo
-&gt; ReaderT SqlBackend IO (SeqAddressMap 'UtxoExternal key)
forall (c :: Role) (key :: Depth -&gt; * -&gt; *).
(MkKeyFingerprint key Address, Typeable c) =&gt;
WalletId -&gt; SlotNo -&gt; SqlPersistT IO (SeqAddressMap c key)
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectSeqAddressMap"><span class="hs-identifier hs-var">selectSeqAddressMap</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486183"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486182"><span class="hs-identifier hs-var">sl</span></a></span></span></span><span>
</span><span id="line-495"></span><span>
</span><span id="line-496"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkSeqStatePendingIxs"><span class="hs-identifier hs-type">mkSeqStatePendingIxs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-type">PendingIxs</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStatePendingIx"><span class="hs-identifier hs-type">SeqStatePendingIx</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-497"></span><span id="mkSeqStatePendingIxs"><span class="annot"><span class="annottext">mkSeqStatePendingIxs :: WalletId -&gt; PendingIxs 'AddressK -&gt; [SeqStatePendingIx]
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkSeqStatePendingIxs"><span class="hs-identifier hs-var hs-var">mkSeqStatePendingIxs</span></a></span></span><span> </span><span id="local-6989586621682486180"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486180"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-498"></span><span>    </span><span class="annot"><span class="annottext">(Index 'Soft 'AddressK -&gt; SeqStatePendingIx)
-&gt; [Index 'Soft 'AddressK] -&gt; [SeqStatePendingIx]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; Word32 -&gt; SeqStatePendingIx
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStatePendingIx"><span class="hs-identifier hs-var">SeqStatePendingIx</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486180"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; SeqStatePendingIx)
-&gt; (Index 'Soft 'AddressK -&gt; Word32)
-&gt; Index 'Soft 'AddressK
-&gt; SeqStatePendingIx
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Word32
forall (derivationType :: DerivationType) (level :: Depth).
Index derivationType level -&gt; Word32
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#getIndex"><span class="hs-identifier hs-var hs-var">W.getIndex</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Index 'Soft 'AddressK] -&gt; [SeqStatePendingIx])
-&gt; (PendingIxs 'AddressK -&gt; [Index 'Soft 'AddressK])
-&gt; PendingIxs 'AddressK
-&gt; [SeqStatePendingIx]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">PendingIxs 'AddressK -&gt; [Index 'Soft 'AddressK]
forall (k :: Depth). PendingIxs k -&gt; [Index 'Soft k]
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#pendingIxsToList"><span class="hs-identifier hs-var hs-var">pendingIxsToList</span></a></span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectSeqStatePendingIxs"><span class="hs-identifier hs-type">selectSeqStatePendingIxs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-type">PendingIxs</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-501"></span><span id="selectSeqStatePendingIxs"><span class="annot"><span class="annottext">selectSeqStatePendingIxs :: WalletId -&gt; ReaderT SqlBackend IO (PendingIxs 'AddressK)
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectSeqStatePendingIxs"><span class="hs-identifier hs-var hs-var">selectSeqStatePendingIxs</span></a></span></span><span> </span><span id="local-6989586621682486177"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486177"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-502"></span><span>    </span><span class="annot"><span class="annottext">[Index 'Soft 'AddressK] -&gt; PendingIxs 'AddressK
forall (k :: Depth). [Index 'Soft k] -&gt; PendingIxs k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#pendingIxsFromList"><span class="hs-identifier hs-var">pendingIxsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Index 'Soft 'AddressK] -&gt; PendingIxs 'AddressK)
-&gt; ([Entity SeqStatePendingIx] -&gt; [Index 'Soft 'AddressK])
-&gt; [Entity SeqStatePendingIx]
-&gt; PendingIxs 'AddressK
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[Entity SeqStatePendingIx] -&gt; [Index 'Soft 'AddressK]
forall (derivationType :: DerivationType) (level :: Depth).
[Entity SeqStatePendingIx] -&gt; [Index derivationType level]
</span><a href="#local-6989586621682486176"><span class="hs-identifier hs-var">fromRes</span></a></span><span> </span><span class="annot"><span class="annottext">([Entity SeqStatePendingIx] -&gt; PendingIxs 'AddressK)
-&gt; ReaderT SqlBackend IO [Entity SeqStatePendingIx]
-&gt; ReaderT SqlBackend IO (PendingIxs 'AddressK)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter SeqStatePendingIx]
-&gt; [SelectOpt SeqStatePendingIx]
-&gt; ReaderT SqlBackend IO [Entity SeqStatePendingIx]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-503"></span><span>        </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField SeqStatePendingIx WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField SeqStatePendingIx typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStatePendingWalletId"><span class="hs-identifier hs-var">SeqStatePendingWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SeqStatePendingIx WalletId
-&gt; WalletId -&gt; Filter SeqStatePendingIx
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486177"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-504"></span><span>        </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField SeqStatePendingIx Word32 -&gt; SelectOpt SeqStatePendingIx
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Desc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SeqStatePendingIx Word32
forall typ. (typ ~ Word32) =&gt; EntityField SeqStatePendingIx typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStatePendingIxIndex"><span class="hs-identifier hs-var">SeqStatePendingIxIndex</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-505"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-506"></span><span>    </span><span id="local-6989586621682486176"><span class="annot"><span class="annottext">fromRes :: [Entity SeqStatePendingIx] -&gt; [Index derivationType level]
</span><a href="#local-6989586621682486176"><span class="hs-identifier hs-var hs-var">fromRes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Entity SeqStatePendingIx -&gt; Index derivationType level)
-&gt; [Entity SeqStatePendingIx] -&gt; [Index derivationType level]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Index derivationType level
forall (derivationType :: DerivationType) (level :: Depth).
Word32 -&gt; Index derivationType level
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-var">W.Index</span></a></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; Index derivationType level)
-&gt; (Entity SeqStatePendingIx -&gt; Word32)
-&gt; Entity SeqStatePendingIx
-&gt; Index derivationType level
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">SeqStatePendingIx -&gt; Word32
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#seqStatePendingIxIndex"><span class="hs-identifier hs-var hs-var">seqStatePendingIxIndex</span></a></span><span> </span><span class="annot"><span class="annottext">(SeqStatePendingIx -&gt; Word32)
-&gt; (Entity SeqStatePendingIx -&gt; SeqStatePendingIx)
-&gt; Entity SeqStatePendingIx
-&gt; Word32
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity SeqStatePendingIx -&gt; SeqStatePendingIx
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertSeqAddressMap"><span class="hs-identifier hs-type">insertSeqAddressMap</span></a></span><span>
</span><span id="line-509"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682486648"><span class="annot"><a href="#local-6989586621682486648"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span id="local-6989586621682486646"><span class="annot"><a href="#local-6989586621682486646"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span id="local-6989586621682486647"><span class="annot"><a href="#local-6989586621682486647"><span class="hs-identifier hs-type">key</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PaymentAddress"><span class="hs-identifier hs-type">PaymentAddress</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486648"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486647"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Typeable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486646"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-510"></span><span>    </span><span class="hs-glyph">=&gt;</span><span>  </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">W.SlotNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#SeqAddressMap"><span class="hs-identifier hs-type">SeqAddressMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486646"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486647"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-511"></span><span id="insertSeqAddressMap"><span class="annot"><span class="annottext">insertSeqAddressMap :: WalletId -&gt; SlotNo -&gt; SeqAddressMap c key -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertSeqAddressMap"><span class="hs-identifier hs-var hs-var">insertSeqAddressMap</span></a></span></span><span> </span><span id="local-6989586621682486172"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486172"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682486171"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486171"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#SeqAddressMap"><span class="hs-identifier hs-type">SeqAddressMap</span></a></span><span> </span><span id="local-6989586621682486169"><span class="annot"><span class="annottext">Map
  (KeyFingerprint &quot;payment&quot; key)
  (Index 'Soft 'AddressK, AddressState)
</span><a href="#local-6989586621682486169"><span class="hs-identifier hs-var">pool</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO () -&gt; SqlPersistT IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(SqlPersistT IO () -&gt; SqlPersistT IO ())
-&gt; SqlPersistT IO () -&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-512"></span><span>    </span><span class="annot"><span class="annottext">([SeqStateAddress] -&gt; SqlPersistT IO ())
-&gt; [SeqStateAddress] -&gt; SqlPersistT IO ()
forall record b.
PersistEntity record =&gt;
([record] -&gt; SqlPersistT IO b) -&gt; [record] -&gt; SqlPersistT IO ()
</span><a href="Cardano.DB.Sqlite.html#dbChunked"><span class="hs-identifier hs-var">dbChunked</span></a></span><span> </span><span class="annot"><span class="annottext">[SeqStateAddress] -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insertMany_</span></a></span><span>
</span><span id="line-513"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; SlotNo
-&gt; Address
-&gt; Word32
-&gt; Role
-&gt; AddressState
-&gt; SeqStateAddress
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddress"><span class="hs-identifier hs-var">SeqStateAddress</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486172"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486171"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyFingerprint &quot;payment&quot; key -&gt; Address
forall (network :: NetworkDiscriminant) (key :: Depth -&gt; * -&gt; *).
PaymentAddress network key =&gt;
KeyFingerprint &quot;payment&quot; key -&gt; Address
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#liftPaymentAddress"><span class="hs-identifier hs-var">liftPaymentAddress</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486648"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><span class="annottext">KeyFingerprint &quot;payment&quot; key
</span><a href="#local-6989586621682486166"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-514"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Word32
forall (derivationType :: DerivationType) (level :: Depth).
Index derivationType level -&gt; Word32
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#getIndex"><span class="hs-identifier hs-var hs-var">W.getIndex</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682486165"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Typeable c =&gt; Role
forall (c :: Role). Typeable c =&gt; Role
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#roleVal"><span class="hs-identifier hs-var">roleVal</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486646"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AddressState
</span><a href="#local-6989586621682486164"><span class="hs-identifier hs-var">status</span></a></span><span>
</span><span id="line-515"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682486166"><span class="annot"><span class="annottext">KeyFingerprint &quot;payment&quot; key
</span><a href="#local-6989586621682486166"><span class="hs-identifier hs-var">addr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682486165"><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682486165"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682486164"><span class="annot"><span class="annottext">AddressState
</span><a href="#local-6989586621682486164"><span class="hs-identifier hs-var">status</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map
  (KeyFingerprint &quot;payment&quot; key)
  (Index 'Soft 'AddressK, AddressState)
-&gt; [(KeyFingerprint &quot;payment&quot; key,
     (Index 'Soft 'AddressK, AddressState))]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (KeyFingerprint &quot;payment&quot; key)
  (Index 'Soft 'AddressK, AddressState)
</span><a href="#local-6989586621682486169"><span class="hs-identifier hs-var">pool</span></a></span><span>
</span><span id="line-516"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span class="hs-comment">-- MkKeyFingerprint key (Proxy n, key 'AddressK XPub)</span><span>
</span><span id="line-519"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectSeqAddressMap"><span class="hs-identifier hs-type">selectSeqAddressMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682486625"><span class="annot"><a href="#local-6989586621682486625"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682486626"><span class="annot"><a href="#local-6989586621682486626"><span class="hs-identifier hs-type">key</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-520"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#MkKeyFingerprint"><span class="hs-identifier hs-type">MkKeyFingerprint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486626"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">W.Address</span></a></span><span>
</span><span id="line-521"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Typeable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486625"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-522"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">W.SlotNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#SeqAddressMap"><span class="hs-identifier hs-type">SeqAddressMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486625"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486626"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-523"></span><span id="selectSeqAddressMap"><span class="annot"><span class="annottext">selectSeqAddressMap :: WalletId -&gt; SlotNo -&gt; SqlPersistT IO (SeqAddressMap c key)
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectSeqAddressMap"><span class="hs-identifier hs-var hs-var">selectSeqAddressMap</span></a></span></span><span> </span><span id="local-6989586621682486163"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486163"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682486162"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486162"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-524"></span><span>    </span><span class="annot"><span class="annottext">Map
  (KeyFingerprint &quot;payment&quot; key)
  (Index 'Soft 'AddressK, AddressState)
-&gt; SeqAddressMap c key
forall (c :: Role) (key :: Depth -&gt; * -&gt; *).
Map
  (KeyFingerprint &quot;payment&quot; key)
  (Index 'Soft 'AddressK, AddressState)
-&gt; SeqAddressMap c key
</span><a href="Cardano.Wallet.Address.Book.html#SeqAddressMap"><span class="hs-identifier hs-var">SeqAddressMap</span></a></span><span> </span><span class="annot"><span class="annottext">(Map
   (KeyFingerprint &quot;payment&quot; key)
   (Index 'Soft 'AddressK, AddressState)
 -&gt; SeqAddressMap c key)
-&gt; ([Entity SeqStateAddress]
    -&gt; Map
         (KeyFingerprint &quot;payment&quot; key)
         (Index 'Soft 'AddressK, AddressState))
-&gt; [Entity SeqStateAddress]
-&gt; SeqAddressMap c key
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[(KeyFingerprint &quot;payment&quot; key,
  (Index 'Soft 'AddressK, AddressState))]
-&gt; Map
     (KeyFingerprint &quot;payment&quot; key)
     (Index 'Soft 'AddressK, AddressState)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(KeyFingerprint &quot;payment&quot; key,
   (Index 'Soft 'AddressK, AddressState))]
 -&gt; Map
      (KeyFingerprint &quot;payment&quot; key)
      (Index 'Soft 'AddressK, AddressState))
-&gt; ([Entity SeqStateAddress]
    -&gt; [(KeyFingerprint &quot;payment&quot; key,
         (Index 'Soft 'AddressK, AddressState))])
-&gt; [Entity SeqStateAddress]
-&gt; Map
     (KeyFingerprint &quot;payment&quot; key)
     (Index 'Soft 'AddressK, AddressState)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Entity SeqStateAddress
 -&gt; (KeyFingerprint &quot;payment&quot; key,
     (Index 'Soft 'AddressK, AddressState)))
-&gt; [Entity SeqStateAddress]
-&gt; [(KeyFingerprint &quot;payment&quot; key,
     (Index 'Soft 'AddressK, AddressState))]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SeqStateAddress
-&gt; (KeyFingerprint &quot;payment&quot; key,
    (Index 'Soft 'AddressK, AddressState))
</span><a href="#local-6989586621682486161"><span class="hs-identifier hs-var">toTriple</span></a></span><span> </span><span class="annot"><span class="annottext">(SeqStateAddress
 -&gt; (KeyFingerprint &quot;payment&quot; key,
     (Index 'Soft 'AddressK, AddressState)))
-&gt; (Entity SeqStateAddress -&gt; SeqStateAddress)
-&gt; Entity SeqStateAddress
-&gt; (KeyFingerprint &quot;payment&quot; key,
    (Index 'Soft 'AddressK, AddressState))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity SeqStateAddress -&gt; SeqStateAddress
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Entity SeqStateAddress] -&gt; SeqAddressMap c key)
-&gt; ReaderT SqlBackend IO [Entity SeqStateAddress]
-&gt; SqlPersistT IO (SeqAddressMap c key)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter SeqStateAddress]
-&gt; [SelectOpt SeqStateAddress]
-&gt; ReaderT SqlBackend IO [Entity SeqStateAddress]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-525"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField SeqStateAddress typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddressWalletId"><span class="hs-identifier hs-var">SeqStateAddressWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress WalletId
-&gt; WalletId -&gt; Filter SeqStateAddress
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486163"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-526"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField SeqStateAddress typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddressSlot"><span class="hs-identifier hs-var">SeqStateAddressSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress SlotNo
-&gt; SlotNo -&gt; Filter SeqStateAddress
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486162"><span class="hs-identifier hs-var">sl</span></a></span><span>
</span><span id="line-527"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress Role
forall typ. (typ ~ Role) =&gt; EntityField SeqStateAddress typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddressRole"><span class="hs-identifier hs-var">SeqStateAddressRole</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress Role -&gt; Role -&gt; Filter SeqStateAddress
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">Typeable c =&gt; Role
forall (c :: Role). Typeable c =&gt; Role
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#roleVal"><span class="hs-identifier hs-var">roleVal</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486625"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-528"></span><span>        </span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField SeqStateAddress Word32 -&gt; SelectOpt SeqStateAddress
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Asc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress Word32
forall typ. (typ ~ Word32) =&gt; EntityField SeqStateAddress typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddressIndex"><span class="hs-identifier hs-var">SeqStateAddressIndex</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-529"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-530"></span><span>    </span><span id="local-6989586621682486161"><span class="annot"><span class="annottext">toTriple :: SeqStateAddress
-&gt; (KeyFingerprint &quot;payment&quot; key,
    (Index 'Soft 'AddressK, AddressState))
</span><a href="#local-6989586621682486161"><span class="hs-identifier hs-var hs-var">toTriple</span></a></span></span><span> </span><span id="local-6989586621682486155"><span class="annot"><span class="annottext">SeqStateAddress
</span><a href="#local-6989586621682486155"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-531"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Address -&gt; KeyFingerprint &quot;payment&quot; key
forall (k :: Depth -&gt; * -&gt; *) from.
(HasCallStack, MkKeyFingerprint k from) =&gt;
from -&gt; KeyFingerprint &quot;payment&quot; k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Sequential.html#unsafePaymentKeyFingerprint"><span class="hs-identifier hs-var">Seq.unsafePaymentKeyFingerprint</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486626"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SeqStateAddress -&gt; Address
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#seqStateAddressAddress"><span class="hs-identifier hs-var hs-var">seqStateAddressAddress</span></a></span><span> </span><span class="annot"><span class="annottext">SeqStateAddress
</span><a href="#local-6989586621682486155"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-532"></span><span>        </span><span class="hs-special">,</span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; Int -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toEnum</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Index 'Soft 'AddressK) -&gt; Int -&gt; Index 'Soft 'AddressK
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; Int) -&gt; Word32 -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SeqStateAddress -&gt; Word32
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#seqStateAddressIndex"><span class="hs-identifier hs-var hs-var">seqStateAddressIndex</span></a></span><span> </span><span class="annot"><span class="annottext">SeqStateAddress
</span><a href="#local-6989586621682486155"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-533"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SeqStateAddress -&gt; AddressState
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#seqStateAddressStatus"><span class="hs-identifier hs-var hs-var">seqStateAddressStatus</span></a></span><span> </span><span class="annot"><span class="annottext">SeqStateAddress
</span><a href="#local-6989586621682486155"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-534"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-535"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-536"></span><span>
</span><span id="line-537"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Shared key address book storage
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-540"></span><span id="local-6989586621682486148"><span id="local-6989586621682486149"><span class="hs-keyword">instance</span><span>
</span><span id="line-541"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPublicKey"><span class="hs-identifier hs-type">PersistPublicKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682486149"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AccountK"><span class="hs-identifier hs-type">AccountK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-542"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#SupportsDiscovery"><span class="hs-identifier hs-type">Shared.SupportsDiscovery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486148"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486149"><span class="hs-identifier hs-type">key</span></a></span><span>
</span><span id="line-543"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#WalletKey"><span class="hs-identifier hs-type">WalletKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486149"><span class="hs-identifier hs-type">key</span></a></span><span>
</span><span id="line-544"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682486149"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.SharedKey.html#SharedKey"><span class="hs-identifier hs-type">SharedKey</span></a></span><span>
</span><span id="line-545"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#SharedState"><span class="hs-identifier hs-type">Shared.SharedState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486148"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486149"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-546"></span><span>
</span><span id="line-547"></span><span>    </span><span id="local-6989586621682486142"><span class="annot"><span class="annottext">insertPrologue :: WalletId -&gt; Prologue (SharedState n key) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486142"><span class="hs-identifier hs-var hs-var hs-var hs-var">insertPrologue</span></a></span></span><span> </span><span id="local-6989586621682486141"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486141"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#SharedPrologue"><span class="hs-identifier hs-type">SharedPrologue</span></a></span><span> </span><span id="local-6989586621682486139"><span class="annot"><a href="#local-6989586621682486139"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-548"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#SharedState"><span class="hs-identifier hs-type">Shared.SharedState</span></a></span><span> </span><span id="local-6989586621682486137"><span class="annot"><span class="annottext">DerivationPrefix
</span><a href="#local-6989586621682486137"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span id="local-6989586621682486136"><span class="annot"><span class="annottext">key 'AccountK XPub
</span><a href="#local-6989586621682486136"><span class="hs-identifier hs-var">accXPub</span></a></span></span><span> </span><span id="local-6989586621682486135"><span class="annot"><span class="annottext">ScriptTemplate
</span><a href="#local-6989586621682486135"><span class="hs-identifier hs-var">pTemplate</span></a></span></span><span> </span><span id="local-6989586621682486134"><span class="annot"><span class="annottext">Maybe ScriptTemplate
</span><a href="#local-6989586621682486134"><span class="hs-identifier hs-var">dTemplateM</span></a></span></span><span> </span><span id="local-6989586621682486133"><span class="annot"><span class="annottext">AddressPoolGap
</span><a href="#local-6989586621682486133"><span class="hs-identifier hs-var">gap</span></a></span></span><span> </span><span id="local-6989586621682486132"><span class="annot"><span class="annottext">Readiness (SharedAddressPools key)
</span><a href="#local-6989586621682486132"><span class="hs-identifier hs-var">readiness</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SharedState n key
</span><a href="#local-6989586621682486139"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-549"></span><span>        </span><span class="annot"><span class="annottext">DerivationPrefix
-&gt; key 'AccountK XPub
-&gt; AddressPoolGap
-&gt; ScriptTemplate
-&gt; Maybe ScriptTemplate
-&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486131"><span class="hs-identifier hs-var">insertSharedState</span></a></span><span> </span><span class="annot"><span class="annottext">DerivationPrefix
</span><a href="#local-6989586621682486137"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">key 'AccountK XPub
</span><a href="#local-6989586621682486136"><span class="hs-identifier hs-var">accXPub</span></a></span><span> </span><span class="annot"><span class="annottext">AddressPoolGap
</span><a href="#local-6989586621682486133"><span class="hs-identifier hs-var">gap</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTemplate
</span><a href="#local-6989586621682486135"><span class="hs-identifier hs-var">pTemplate</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ScriptTemplate
</span><a href="#local-6989586621682486134"><span class="hs-identifier hs-var">dTemplateM</span></a></span><span>
</span><span id="line-550"></span><span>        </span><span class="annot"><span class="annottext">Map Cosigner XPub -&gt; CredentialType -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486130"><span class="hs-identifier hs-var">insertCosigner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScriptTemplate -&gt; Map Cosigner XPub
</span><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier hs-var hs-var">cosigners</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTemplate
</span><a href="#local-6989586621682486135"><span class="hs-identifier hs-var">pTemplate</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CredentialType
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#Payment"><span class="hs-identifier hs-var">Payment</span></a></span><span>
</span><span id="line-551"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; SqlPersistT IO () -&gt; SqlPersistT IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ScriptTemplate -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ScriptTemplate
</span><a href="#local-6989586621682486134"><span class="hs-identifier hs-var">dTemplateM</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SqlPersistT IO () -&gt; SqlPersistT IO ())
-&gt; SqlPersistT IO () -&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-552"></span><span>            </span><span class="annot"><span class="annottext">Map Cosigner XPub -&gt; CredentialType -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486130"><span class="hs-identifier hs-var">insertCosigner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Map Cosigner XPub) -&gt; Map Cosigner XPub
forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromJust</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Map Cosigner XPub) -&gt; Map Cosigner XPub)
-&gt; Maybe (Map Cosigner XPub) -&gt; Map Cosigner XPub
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTemplate -&gt; Map Cosigner XPub
</span><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier hs-var hs-var">cosigners</span></a></span><span> </span><span class="annot"><span class="annottext">(ScriptTemplate -&gt; Map Cosigner XPub)
-&gt; Maybe ScriptTemplate -&gt; Maybe (Map Cosigner XPub)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ScriptTemplate
</span><a href="#local-6989586621682486134"><span class="hs-identifier hs-var">dTemplateM</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CredentialType
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#Delegation"><span class="hs-identifier hs-var">Delegation</span></a></span><span>
</span><span id="line-553"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; SqlPersistT IO () -&gt; SqlPersistT IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Readiness (SharedAddressPools key)
forall a. Readiness a
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#Pending"><span class="hs-identifier hs-var">Shared.Pending</span></a></span><span> </span><span class="annot"><span class="annottext">Readiness (SharedAddressPools key)
-&gt; Readiness (SharedAddressPools key) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Readiness (SharedAddressPools key)
</span><a href="#local-6989586621682486132"><span class="hs-identifier hs-var">readiness</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SqlPersistT IO () -&gt; SqlPersistT IO ())
-&gt; SqlPersistT IO () -&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-554"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#Active"><span class="hs-identifier hs-type">Shared.Active</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#SharedAddressPools"><span class="hs-identifier hs-type">Shared.SharedAddressPools</span></a></span><span> </span><span class="annot"><span class="annottext">SharedAddressPool 'UtxoExternal key
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SharedAddressPool 'UtxoInternal key
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682486123"><span class="annot"><span class="annottext">PendingIxs 'ScriptK
</span><a href="#local-6989586621682486123"><span class="hs-identifier hs-var">pendingIxs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-555"></span><span>                    </span><span class="annot"><span class="annottext">Readiness (SharedAddressPools key)
</span><a href="#local-6989586621682486132"><span class="hs-identifier hs-var">readiness</span></a></span><span>
</span><span id="line-556"></span><span>            </span><span class="annot"><span class="annottext">[Filter SharedStatePendingIx] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField SharedStatePendingIx WalletId
forall typ.
(typ ~ WalletId) =&gt;
EntityField SharedStatePendingIx typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SharedStatePendingWalletId"><span class="hs-identifier hs-var">SharedStatePendingWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SharedStatePendingIx WalletId
-&gt; WalletId -&gt; Filter SharedStatePendingIx
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486141"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-557"></span><span>            </span><span class="annot"><span class="annottext">([SharedStatePendingIx] -&gt; SqlPersistT IO ())
-&gt; [SharedStatePendingIx] -&gt; SqlPersistT IO ()
forall record b.
PersistEntity record =&gt;
([record] -&gt; SqlPersistT IO b) -&gt; [record] -&gt; SqlPersistT IO ()
</span><a href="Cardano.DB.Sqlite.html#dbChunked"><span class="hs-identifier hs-var">dbChunked</span></a></span><span> </span><span class="annot"><span class="annottext">[SharedStatePendingIx] -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insertMany_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PendingIxs 'ScriptK -&gt; [SharedStatePendingIx]
</span><a href="#local-6989586621682486121"><span class="hs-identifier hs-var">mkSharedStatePendingIxs</span></a></span><span> </span><span class="annot"><span class="annottext">PendingIxs 'ScriptK
</span><a href="#local-6989586621682486123"><span class="hs-identifier hs-var">pendingIxs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-558"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-559"></span><span>        </span><span id="local-6989586621682486131"><span class="annot"><span class="annottext">insertSharedState :: DerivationPrefix
-&gt; key 'AccountK XPub
-&gt; AddressPoolGap
-&gt; ScriptTemplate
-&gt; Maybe ScriptTemplate
-&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486131"><span class="hs-identifier hs-var hs-var">insertSharedState</span></a></span></span><span> </span><span id="local-6989586621682486120"><span class="annot"><span class="annottext">DerivationPrefix
</span><a href="#local-6989586621682486120"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span id="local-6989586621682486119"><span class="annot"><span class="annottext">key 'AccountK XPub
</span><a href="#local-6989586621682486119"><span class="hs-identifier hs-var">accXPub</span></a></span></span><span> </span><span id="local-6989586621682486118"><span class="annot"><span class="annottext">AddressPoolGap
</span><a href="#local-6989586621682486118"><span class="hs-identifier hs-var">gap</span></a></span></span><span> </span><span id="local-6989586621682486117"><span class="annot"><span class="annottext">ScriptTemplate
</span><a href="#local-6989586621682486117"><span class="hs-identifier hs-var">pTemplate</span></a></span></span><span> </span><span id="local-6989586621682486116"><span class="annot"><span class="annottext">Maybe ScriptTemplate
</span><a href="#local-6989586621682486116"><span class="hs-identifier hs-var">dTemplateM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-560"></span><span>            </span><span class="annot"><span class="annottext">[Filter SharedState] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField SharedState WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField SharedState typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SharedStateWalletId"><span class="hs-identifier hs-var">SharedStateWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SharedState WalletId -&gt; WalletId -&gt; Filter SharedState
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486141"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-561"></span><span>            </span><span class="annot"><span class="annottext">SharedState -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insert_</span></a></span><span> </span><span class="annot"><span class="annottext">(SharedState -&gt; SqlPersistT IO ())
-&gt; SharedState -&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SharedState :: WalletId
-&gt; ByteString
-&gt; AddressPoolGap
-&gt; Script Cosigner
-&gt; Maybe (Script Cosigner)
-&gt; DerivationPrefix
-&gt; SharedState
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SharedState"><span class="hs-identifier hs-type">SharedState</span></a></span><span>
</span><span id="line-562"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sharedStateWalletId :: WalletId
</span><a href="#local-6989586621682486113"><span class="hs-identifier hs-var">sharedStateWalletId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486141"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-563"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sharedStateAccountXPub :: ByteString
</span><a href="#local-6989586621682486112"><span class="hs-identifier hs-var">sharedStateAccountXPub</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">key 'AccountK XPub -&gt; ByteString
forall (key :: * -&gt; *).
PersistPublicKey key =&gt;
key XPub -&gt; ByteString
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#serializeXPub"><span class="hs-identifier hs-var">serializeXPub</span></a></span><span> </span><span class="annot"><span class="annottext">key 'AccountK XPub
</span><a href="#local-6989586621682486119"><span class="hs-identifier hs-var">accXPub</span></a></span><span>
</span><span id="line-564"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sharedStateScriptGap :: AddressPoolGap
</span><a href="#local-6989586621682486111"><span class="hs-identifier hs-var">sharedStateScriptGap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AddressPoolGap
</span><a href="#local-6989586621682486118"><span class="hs-identifier hs-var">gap</span></a></span><span>
</span><span id="line-565"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sharedStatePaymentScript :: Script Cosigner
</span><a href="#local-6989586621682486110"><span class="hs-identifier hs-var">sharedStatePaymentScript</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScriptTemplate -&gt; Script Cosigner
</span><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier hs-var hs-var">template</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTemplate
</span><a href="#local-6989586621682486117"><span class="hs-identifier hs-var">pTemplate</span></a></span><span>
</span><span id="line-566"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sharedStateDelegationScript :: Maybe (Script Cosigner)
</span><a href="#local-6989586621682486108"><span class="hs-identifier hs-var">sharedStateDelegationScript</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScriptTemplate -&gt; Script Cosigner
</span><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier hs-var hs-var">template</span></a></span><span> </span><span class="annot"><span class="annottext">(ScriptTemplate -&gt; Script Cosigner)
-&gt; Maybe ScriptTemplate -&gt; Maybe (Script Cosigner)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ScriptTemplate
</span><a href="#local-6989586621682486116"><span class="hs-identifier hs-var">dTemplateM</span></a></span><span>
</span><span id="line-567"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sharedStateDerivationPrefix :: DerivationPrefix
</span><a href="#local-6989586621682486107"><span class="hs-identifier hs-var">sharedStateDerivationPrefix</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DerivationPrefix
</span><a href="#local-6989586621682486120"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-568"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-569"></span><span>
</span><span id="line-570"></span><span>        </span><span id="local-6989586621682486130"><span class="annot"><span class="annottext">insertCosigner :: Map Cosigner XPub -&gt; CredentialType -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486130"><span class="hs-identifier hs-var hs-var">insertCosigner</span></a></span></span><span> </span><span id="local-6989586621682486106"><span class="annot"><span class="annottext">Map Cosigner XPub
</span><a href="#local-6989586621682486106"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621682486105"><span class="annot"><span class="annottext">CredentialType
</span><a href="#local-6989586621682486105"><span class="hs-identifier hs-var">cred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-571"></span><span>            </span><span class="annot"><span class="annottext">[Filter CosignerKey] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField CosignerKey WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField CosignerKey typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CosignerKeyWalletId"><span class="hs-identifier hs-var">CosignerKeyWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField CosignerKey WalletId -&gt; WalletId -&gt; Filter CosignerKey
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486141"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField CosignerKey CredentialType
forall typ. (typ ~ CredentialType) =&gt; EntityField CosignerKey typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CosignerKeyCredential"><span class="hs-identifier hs-var">CosignerKeyCredential</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField CosignerKey CredentialType
-&gt; CredentialType -&gt; Filter CosignerKey
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">CredentialType
</span><a href="#local-6989586621682486105"><span class="hs-identifier hs-var">cred</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-572"></span><span>            </span><span class="annot"><span class="annottext">([CosignerKey] -&gt; SqlPersistT IO ())
-&gt; [CosignerKey] -&gt; SqlPersistT IO ()
forall record b.
PersistEntity record =&gt;
([record] -&gt; SqlPersistT IO b) -&gt; [record] -&gt; SqlPersistT IO ()
</span><a href="Cardano.DB.Sqlite.html#dbChunked"><span class="hs-identifier hs-var">dbChunked</span></a></span><span> </span><span class="annot"><span class="annottext">[CosignerKey] -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insertMany_</span></a></span><span>
</span><span id="line-573"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; CredentialType -&gt; ByteString -&gt; Word8 -&gt; CosignerKey
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CosignerKey"><span class="hs-identifier hs-var">CosignerKey</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486141"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">CredentialType
</span><a href="#local-6989586621682486105"><span class="hs-identifier hs-var">cred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PersistPublicKey (key 'AccountK) =&gt;
key 'AccountK XPub -&gt; ByteString
forall (key :: * -&gt; *).
PersistPublicKey key =&gt;
key XPub -&gt; ByteString
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#serializeXPub"><span class="hs-identifier hs-var">serializeXPub</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682486149"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AccountK"><span class="hs-identifier hs-type">AccountK</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(key 'AccountK XPub -&gt; ByteString)
-&gt; key 'AccountK XPub -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">XPub -&gt; key 'AccountK XPub
forall (key :: Depth -&gt; * -&gt; *) raw (depth :: Depth).
WalletKey key =&gt;
raw -&gt; key depth raw
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#liftRawKey"><span class="hs-identifier hs-var">liftRawKey</span></a></span><span> </span><span class="annot"><span class="annottext">XPub
</span><a href="#local-6989586621682486100"><span class="hs-identifier hs-var">xpub</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621682486099"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-574"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier hs-type">Cosigner</span></a></span><span> </span><span id="local-6989586621682486099"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621682486099"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621682486100"><span class="annot"><span class="annottext">XPub
</span><a href="#local-6989586621682486100"><span class="hs-identifier hs-var">xpub</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map Cosigner XPub -&gt; [(Cosigner, XPub)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.assocs</span></a></span><span> </span><span class="annot"><span class="annottext">Map Cosigner XPub
</span><a href="#local-6989586621682486106"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-575"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-576"></span><span>
</span><span id="line-577"></span><span>        </span><span class="annot"><a href="#local-6989586621682486121"><span class="hs-identifier hs-type">mkSharedStatePendingIxs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-type">PendingIxs</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#ScriptK"><span class="hs-identifier hs-type">ScriptK</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SharedStatePendingIx"><span class="hs-identifier hs-type">SharedStatePendingIx</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-578"></span><span>        </span><span id="local-6989586621682486121"><span class="annot"><span class="annottext">mkSharedStatePendingIxs :: PendingIxs 'ScriptK -&gt; [SharedStatePendingIx]
</span><a href="#local-6989586621682486121"><span class="hs-identifier hs-var hs-var">mkSharedStatePendingIxs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-579"></span><span>            </span><span class="annot"><span class="annottext">(Index 'Soft 'ScriptK -&gt; SharedStatePendingIx)
-&gt; [Index 'Soft 'ScriptK] -&gt; [SharedStatePendingIx]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; Word32 -&gt; SharedStatePendingIx
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SharedStatePendingIx"><span class="hs-identifier hs-var">SharedStatePendingIx</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486141"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; SharedStatePendingIx)
-&gt; (Index 'Soft 'ScriptK -&gt; Word32)
-&gt; Index 'Soft 'ScriptK
-&gt; SharedStatePendingIx
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'ScriptK -&gt; Word32
forall (derivationType :: DerivationType) (level :: Depth).
Index derivationType level -&gt; Word32
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#getIndex"><span class="hs-identifier hs-var hs-var">W.getIndex</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Index 'Soft 'ScriptK] -&gt; [SharedStatePendingIx])
-&gt; (PendingIxs 'ScriptK -&gt; [Index 'Soft 'ScriptK])
-&gt; PendingIxs 'ScriptK
-&gt; [SharedStatePendingIx]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">PendingIxs 'ScriptK -&gt; [Index 'Soft 'ScriptK]
forall (k :: Depth). PendingIxs k -&gt; [Index 'Soft k]
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#pendingIxsToList"><span class="hs-identifier hs-var hs-var">pendingIxsToList</span></a></span><span>
</span><span id="line-580"></span><span>
</span><span id="line-581"></span><span>    </span><span id="local-6989586621682486096"><span class="annot"><span class="annottext">insertDiscoveries :: WalletId
-&gt; SlotNo -&gt; Discoveries (SharedState n key) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486096"><span class="hs-identifier hs-var hs-var hs-var hs-var">insertDiscoveries</span></a></span></span><span> </span><span id="local-6989586621682486095"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486095"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682486094"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486094"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span id="local-6989586621682486093"><span class="annot"><span class="annottext">Discoveries (SharedState n key)
</span><a href="#local-6989586621682486093"><span class="hs-identifier hs-var">sharedDiscoveries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-582"></span><span>        </span><span class="annot"><span class="annottext">([SeqStateAddress] -&gt; SqlPersistT IO ())
-&gt; [SeqStateAddress] -&gt; SqlPersistT IO ()
forall record b.
PersistEntity record =&gt;
([record] -&gt; SqlPersistT IO b) -&gt; [record] -&gt; SqlPersistT IO ()
</span><a href="Cardano.DB.Sqlite.html#dbChunked"><span class="hs-identifier hs-var">dbChunked</span></a></span><span> </span><span class="annot"><span class="annottext">[SeqStateAddress] -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insertMany_</span></a></span><span>
</span><span id="line-583"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; SlotNo
-&gt; Address
-&gt; Word32
-&gt; Role
-&gt; AddressState
-&gt; SeqStateAddress
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddress"><span class="hs-identifier hs-var">SeqStateAddress</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486095"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486094"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682486092"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486091"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#UtxoExternal"><span class="hs-identifier hs-var">UtxoExternal</span></a></span><span> </span><span class="annot"><span class="annottext">AddressState
</span><a href="#local-6989586621682486090"><span class="hs-identifier hs-var">status</span></a></span><span>
</span><span id="line-584"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682486091"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486091"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682486092"><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682486092"><span class="hs-identifier hs-var">addr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682486090"><span class="annot"><span class="annottext">AddressState
</span><a href="#local-6989586621682486090"><span class="hs-identifier hs-var">status</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((KeyFingerprint &quot;payment&quot; key,
  (Index 'Soft 'ScriptK, AddressState))
 -&gt; (Word32, Address, AddressState))
-&gt; [(KeyFingerprint &quot;payment&quot; key,
     (Index 'Soft 'ScriptK, AddressState))]
-&gt; [(Word32, Address, AddressState)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(KeyFingerprint &quot;payment&quot; key,
 (Index 'Soft 'ScriptK, AddressState))
-&gt; (Word32, Address, AddressState)
</span><a href="#local-6989586621682486089"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="annot"><span class="annottext">([(KeyFingerprint &quot;payment&quot; key,
   (Index 'Soft 'ScriptK, AddressState))]
 -&gt; [(Word32, Address, AddressState)])
-&gt; [(KeyFingerprint &quot;payment&quot; key,
     (Index 'Soft 'ScriptK, AddressState))]
-&gt; [(Word32, Address, AddressState)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (KeyFingerprint &quot;payment&quot; key) (Index 'Soft 'ScriptK, AddressState)
-&gt; [(KeyFingerprint &quot;payment&quot; key,
     (Index 'Soft 'ScriptK, AddressState))]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (KeyFingerprint &quot;payment&quot; key) (Index 'Soft 'ScriptK, AddressState)
</span><a href="#local-6989586621682486088"><span class="hs-identifier hs-var">extAddrs</span></a></span><span>
</span><span id="line-585"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-586"></span><span>        </span><span class="annot"><span class="annottext">([SeqStateAddress] -&gt; SqlPersistT IO ())
-&gt; [SeqStateAddress] -&gt; SqlPersistT IO ()
forall record b.
PersistEntity record =&gt;
([record] -&gt; SqlPersistT IO b) -&gt; [record] -&gt; SqlPersistT IO ()
</span><a href="Cardano.DB.Sqlite.html#dbChunked"><span class="hs-identifier hs-var">dbChunked</span></a></span><span> </span><span class="annot"><span class="annottext">[SeqStateAddress] -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insertMany_</span></a></span><span>
</span><span id="line-587"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; SlotNo
-&gt; Address
-&gt; Word32
-&gt; Role
-&gt; AddressState
-&gt; SeqStateAddress
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddress"><span class="hs-identifier hs-var">SeqStateAddress</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486095"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486094"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682486087"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486086"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#UtxoInternal"><span class="hs-identifier hs-var">UtxoInternal</span></a></span><span> </span><span class="annot"><span class="annottext">AddressState
</span><a href="#local-6989586621682486085"><span class="hs-identifier hs-var">status</span></a></span><span>
</span><span id="line-588"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682486086"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486086"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682486087"><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682486087"><span class="hs-identifier hs-var">addr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682486085"><span class="annot"><span class="annottext">AddressState
</span><a href="#local-6989586621682486085"><span class="hs-identifier hs-var">status</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((KeyFingerprint &quot;payment&quot; key,
  (Index 'Soft 'ScriptK, AddressState))
 -&gt; (Word32, Address, AddressState))
-&gt; [(KeyFingerprint &quot;payment&quot; key,
     (Index 'Soft 'ScriptK, AddressState))]
-&gt; [(Word32, Address, AddressState)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(KeyFingerprint &quot;payment&quot; key,
 (Index 'Soft 'ScriptK, AddressState))
-&gt; (Word32, Address, AddressState)
</span><a href="#local-6989586621682486089"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="annot"><span class="annottext">([(KeyFingerprint &quot;payment&quot; key,
   (Index 'Soft 'ScriptK, AddressState))]
 -&gt; [(Word32, Address, AddressState)])
-&gt; [(KeyFingerprint &quot;payment&quot; key,
     (Index 'Soft 'ScriptK, AddressState))]
-&gt; [(Word32, Address, AddressState)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (KeyFingerprint &quot;payment&quot; key) (Index 'Soft 'ScriptK, AddressState)
-&gt; [(KeyFingerprint &quot;payment&quot; key,
     (Index 'Soft 'ScriptK, AddressState))]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (KeyFingerprint &quot;payment&quot; key) (Index 'Soft 'ScriptK, AddressState)
</span><a href="#local-6989586621682486084"><span class="hs-identifier hs-var">intAddrs</span></a></span><span>
</span><span id="line-589"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-590"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-591"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#SharedDiscoveries"><span class="hs-identifier hs-type">SharedDiscoveries</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#SharedAddressMap"><span class="hs-identifier hs-type">SharedAddressMap</span></a></span><span> </span><span id="local-6989586621682486088"><span class="annot"><a href="#local-6989586621682486088"><span class="hs-identifier hs-var">extAddrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#SharedAddressMap"><span class="hs-identifier hs-type">SharedAddressMap</span></a></span><span> </span><span id="local-6989586621682486084"><span class="annot"><a href="#local-6989586621682486084"><span class="hs-identifier hs-var">intAddrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-592"></span><span>            </span><span class="annot"><span class="annottext">Discoveries (SharedState n key)
</span><a href="#local-6989586621682486093"><span class="hs-identifier hs-var">sharedDiscoveries</span></a></span><span>
</span><span id="line-593"></span><span>        </span><span id="local-6989586621682486089"><span class="annot"><span class="annottext">convert :: (KeyFingerprint &quot;payment&quot; key,
 (Index 'Soft 'ScriptK, AddressState))
-&gt; (Word32, Address, AddressState)
</span><a href="#local-6989586621682486089"><span class="hs-identifier hs-var hs-var">convert</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682486081"><span class="annot"><span class="annottext">KeyFingerprint &quot;payment&quot; key
</span><a href="#local-6989586621682486081"><span class="hs-identifier hs-var">addr</span></a></span></span><span class="hs-special">,</span><span class="hs-special">(</span><span id="local-6989586621682486080"><span class="annot"><span class="annottext">Index 'Soft 'ScriptK
</span><a href="#local-6989586621682486080"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682486079"><span class="annot"><span class="annottext">AddressState
</span><a href="#local-6989586621682486079"><span class="hs-identifier hs-var">status</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-594"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Word32) -&gt; Int -&gt; Word32
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'ScriptK -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromEnum</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'ScriptK
</span><a href="#local-6989586621682486080"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">KeyFingerprint &quot;payment&quot; key -&gt; Address
forall (n :: NetworkDiscriminant) (k :: Depth -&gt; * -&gt; *).
Typeable n =&gt;
KeyFingerprint &quot;payment&quot; k -&gt; Address
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#liftPaymentAddress"><span class="hs-identifier hs-var">Shared.liftPaymentAddress</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486148"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><span class="annottext">KeyFingerprint &quot;payment&quot; key
</span><a href="#local-6989586621682486081"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AddressState
</span><a href="#local-6989586621682486079"><span class="hs-identifier hs-var">status</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span>    </span><span id="local-6989586621682486076"><span class="annot"><span class="annottext">loadPrologue :: WalletId -&gt; SqlPersistT IO (Maybe (Prologue (SharedState n key)))
</span><a href="#local-6989586621682486076"><span class="hs-identifier hs-var hs-var hs-var hs-var">loadPrologue</span></a></span></span><span> </span><span id="local-6989586621682486075"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486075"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeT (SqlPersistT IO) (Prologue (SharedState n key))
-&gt; SqlPersistT IO (Maybe (Prologue (SharedState n key)))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var hs-var">runMaybeT</span></a></span><span> </span><span class="annot"><span class="annottext">(MaybeT (SqlPersistT IO) (Prologue (SharedState n key))
 -&gt; SqlPersistT IO (Maybe (Prologue (SharedState n key))))
-&gt; MaybeT (SqlPersistT IO) (Prologue (SharedState n key))
-&gt; SqlPersistT IO (Maybe (Prologue (SharedState n key)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-597"></span><span>        </span><span id="local-6989586621682486074"><span class="annot"><span class="annottext">Entity SharedState
</span><a href="#local-6989586621682486074"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Maybe (Entity SharedState))
-&gt; MaybeT (SqlPersistT IO) (Entity SharedState)
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">MaybeT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Maybe (Entity SharedState))
 -&gt; MaybeT (SqlPersistT IO) (Entity SharedState))
-&gt; ReaderT SqlBackend IO (Maybe (Entity SharedState))
-&gt; MaybeT (SqlPersistT IO) (Entity SharedState)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter SharedState]
-&gt; [SelectOpt SharedState]
-&gt; ReaderT SqlBackend IO (Maybe (Entity SharedState))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField SharedState WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField SharedState typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SharedStateWalletId"><span class="hs-identifier hs-var">SharedStateWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SharedState WalletId -&gt; WalletId -&gt; Filter SharedState
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486075"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-598"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SharedState"><span class="hs-identifier hs-type">SharedState</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682486073"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682486073"><span class="hs-identifier hs-var">accountBytes</span></a></span></span><span> </span><span id="local-6989586621682486072"><span class="annot"><span class="annottext">AddressPoolGap
</span><a href="#local-6989586621682486072"><span class="hs-identifier hs-var">gap</span></a></span></span><span> </span><span id="local-6989586621682486071"><span class="annot"><span class="annottext">Script Cosigner
</span><a href="#local-6989586621682486071"><span class="hs-identifier hs-var">pScript</span></a></span></span><span> </span><span id="local-6989586621682486070"><span class="annot"><span class="annottext">Maybe (Script Cosigner)
</span><a href="#local-6989586621682486070"><span class="hs-identifier hs-var">dScriptM</span></a></span></span><span> </span><span id="local-6989586621682486069"><span class="annot"><span class="annottext">DerivationPrefix
</span><a href="#local-6989586621682486069"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Entity SharedState -&gt; SharedState
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">Entity SharedState
</span><a href="#local-6989586621682486074"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-599"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486068"><span class="annot"><span class="annottext">accXPub :: key 'AccountK XPub
</span><a href="#local-6989586621682486068"><span class="hs-identifier hs-var hs-var">accXPub</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; key 'AccountK XPub
forall (key :: * -&gt; *).
PersistPublicKey key =&gt;
ByteString -&gt; key XPub
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#unsafeDeserializeXPub"><span class="hs-identifier hs-var">unsafeDeserializeXPub</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682486073"><span class="hs-identifier hs-var">accountBytes</span></a></span><span>
</span><span id="line-600"></span><span>        </span><span id="local-6989586621682486067"><span class="annot"><span class="annottext">[(Cosigner, key 'AccountK XPub)]
</span><a href="#local-6989586621682486067"><span class="hs-identifier hs-var">pCosigners</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO [(Cosigner, key 'AccountK XPub)]
-&gt; MaybeT (SqlPersistT IO) [(Cosigner, key 'AccountK XPub)]
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO [(Cosigner, key 'AccountK XPub)]
 -&gt; MaybeT (SqlPersistT IO) [(Cosigner, key 'AccountK XPub)])
-&gt; ReaderT SqlBackend IO [(Cosigner, key 'AccountK XPub)]
-&gt; MaybeT (SqlPersistT IO) [(Cosigner, key 'AccountK XPub)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; CredentialType
-&gt; ReaderT SqlBackend IO [(Cosigner, key 'AccountK XPub)]
forall (k :: Depth -&gt; * -&gt; *).
PersistPublicKey (k 'AccountK) =&gt;
WalletId
-&gt; CredentialType -&gt; SqlPersistT IO [(Cosigner, k 'AccountK XPub)]
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectCosigners"><span class="hs-identifier hs-var">selectCosigners</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486149"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486075"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">CredentialType
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#Payment"><span class="hs-identifier hs-var">Payment</span></a></span><span>
</span><span id="line-601"></span><span>        </span><span id="local-6989586621682486065"><span class="annot"><span class="annottext">[(Cosigner, key 'AccountK XPub)]
</span><a href="#local-6989586621682486065"><span class="hs-identifier hs-var">dCosigners</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO [(Cosigner, key 'AccountK XPub)]
-&gt; MaybeT (SqlPersistT IO) [(Cosigner, key 'AccountK XPub)]
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO [(Cosigner, key 'AccountK XPub)]
 -&gt; MaybeT (SqlPersistT IO) [(Cosigner, key 'AccountK XPub)])
-&gt; ReaderT SqlBackend IO [(Cosigner, key 'AccountK XPub)]
-&gt; MaybeT (SqlPersistT IO) [(Cosigner, key 'AccountK XPub)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; CredentialType
-&gt; ReaderT SqlBackend IO [(Cosigner, key 'AccountK XPub)]
forall (k :: Depth -&gt; * -&gt; *).
PersistPublicKey (k 'AccountK) =&gt;
WalletId
-&gt; CredentialType -&gt; SqlPersistT IO [(Cosigner, k 'AccountK XPub)]
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectCosigners"><span class="hs-identifier hs-var">selectCosigners</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486149"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486075"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">CredentialType
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#Delegation"><span class="hs-identifier hs-var">Delegation</span></a></span><span>
</span><span id="line-602"></span><span>
</span><span id="line-603"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486064"><span class="annot"><span class="annottext">prepareKeys :: [(a, key depth c)] -&gt; [(a, c)]
</span><a href="#local-6989586621682486064"><span class="hs-identifier hs-var hs-var">prepareKeys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((a, key depth c) -&gt; (a, c)) -&gt; [(a, key depth c)] -&gt; [(a, c)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(key depth c -&gt; c) -&gt; (a, key depth c) -&gt; (a, c)
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">second</span></a></span><span> </span><span class="annot"><span class="annottext">key depth c -&gt; c
forall (key :: Depth -&gt; * -&gt; *) (depth :: Depth) raw.
WalletKey key =&gt;
key depth raw -&gt; raw
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#getRawKey"><span class="hs-identifier hs-var">getRawKey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-604"></span><span>            </span><span id="local-6989586621682486062"><span class="annot"><span class="annottext">pTemplate :: ScriptTemplate
</span><a href="#local-6989586621682486062"><span class="hs-identifier hs-var hs-var">pTemplate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Cosigner XPub -&gt; Script Cosigner -&gt; ScriptTemplate
</span><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier hs-var">ScriptTemplate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Cosigner, XPub)] -&gt; Map Cosigner XPub
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(Cosigner, XPub)] -&gt; Map Cosigner XPub)
-&gt; [(Cosigner, XPub)] -&gt; Map Cosigner XPub
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[(Cosigner, key 'AccountK XPub)] -&gt; [(Cosigner, XPub)]
forall a (depth :: Depth) c. [(a, key depth c)] -&gt; [(a, c)]
</span><a href="#local-6989586621682486064"><span class="hs-identifier hs-var">prepareKeys</span></a></span><span> </span><span class="annot"><span class="annottext">[(Cosigner, key 'AccountK XPub)]
</span><a href="#local-6989586621682486067"><span class="hs-identifier hs-var">pCosigners</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Script Cosigner
</span><a href="#local-6989586621682486071"><span class="hs-identifier hs-var">pScript</span></a></span><span>
</span><span id="line-605"></span><span>            </span><span id="local-6989586621682486060"><span class="annot"><span class="annottext">dTemplateM :: Maybe ScriptTemplate
</span><a href="#local-6989586621682486060"><span class="hs-identifier hs-var hs-var">dTemplateM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Cosigner XPub -&gt; Script Cosigner -&gt; ScriptTemplate
</span><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier hs-var">ScriptTemplate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Cosigner, XPub)] -&gt; Map Cosigner XPub
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(Cosigner, XPub)] -&gt; Map Cosigner XPub)
-&gt; [(Cosigner, XPub)] -&gt; Map Cosigner XPub
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[(Cosigner, key 'AccountK XPub)] -&gt; [(Cosigner, XPub)]
forall a (depth :: Depth) c. [(a, key depth c)] -&gt; [(a, c)]
</span><a href="#local-6989586621682486064"><span class="hs-identifier hs-var">prepareKeys</span></a></span><span> </span><span class="annot"><span class="annottext">[(Cosigner, key 'AccountK XPub)]
</span><a href="#local-6989586621682486065"><span class="hs-identifier hs-var">dCosigners</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Script Cosigner -&gt; ScriptTemplate)
-&gt; Maybe (Script Cosigner) -&gt; Maybe ScriptTemplate
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Script Cosigner)
</span><a href="#local-6989586621682486070"><span class="hs-identifier hs-var">dScriptM</span></a></span><span>
</span><span id="line-606"></span><span>            </span><span id="local-6989586621682486059"><span class="annot"><span class="annottext">mkSharedState :: Readiness (SharedAddressPools key) -&gt; SharedState n key
</span><a href="#local-6989586621682486059"><span class="hs-identifier hs-var hs-var">mkSharedState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DerivationPrefix
-&gt; key 'AccountK XPub
-&gt; ScriptTemplate
-&gt; Maybe ScriptTemplate
-&gt; AddressPoolGap
-&gt; Readiness (SharedAddressPools key)
-&gt; SharedState n key
forall (n :: NetworkDiscriminant) (k :: Depth -&gt; * -&gt; *).
DerivationPrefix
-&gt; k 'AccountK XPub
-&gt; ScriptTemplate
-&gt; Maybe ScriptTemplate
-&gt; AddressPoolGap
-&gt; Readiness (SharedAddressPools k)
-&gt; SharedState n k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#SharedState"><span class="hs-identifier hs-var">Shared.SharedState</span></a></span><span> </span><span class="annot"><span class="annottext">DerivationPrefix
</span><a href="#local-6989586621682486069"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">key 'AccountK XPub
</span><a href="#local-6989586621682486068"><span class="hs-identifier hs-var">accXPub</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTemplate
</span><a href="#local-6989586621682486062"><span class="hs-identifier hs-var">pTemplate</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ScriptTemplate
</span><a href="#local-6989586621682486060"><span class="hs-identifier hs-var">dTemplateM</span></a></span><span> </span><span class="annot"><span class="annottext">AddressPoolGap
</span><a href="#local-6989586621682486072"><span class="hs-identifier hs-var">gap</span></a></span><span>
</span><span id="line-607"></span><span>        </span><span id="local-6989586621682486058"><span class="annot"><span class="annottext">PendingIxs 'ScriptK
</span><a href="#local-6989586621682486058"><span class="hs-identifier hs-var">pendingIxs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (PendingIxs 'ScriptK)
-&gt; MaybeT (SqlPersistT IO) (PendingIxs 'ScriptK)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (PendingIxs 'ScriptK)
</span><a href="#local-6989586621682486057"><span class="hs-identifier hs-var">selectSharedStatePendingIxs</span></a></span><span>
</span><span id="line-608"></span><span>        </span><span id="local-6989586621682486056"><span class="annot"><span class="annottext">SharedState n key
</span><a href="#local-6989586621682486056"><span class="hs-identifier hs-var">prologue</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (SharedState n key)
-&gt; MaybeT (SqlPersistT IO) (SharedState n key)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (SharedState n key)
 -&gt; MaybeT (SqlPersistT IO) (SharedState n key))
-&gt; ReaderT SqlBackend IO (SharedState n key)
-&gt; MaybeT (SqlPersistT IO) (SharedState n key)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO Bool
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#multisigPoolAbsent"><span class="hs-identifier hs-var">multisigPoolAbsent</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486075"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO Bool
-&gt; (Bool -&gt; SharedState n key)
-&gt; ReaderT SqlBackend IO (SharedState n key)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&amp;&gt;</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-609"></span><span>            </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="annot"><span class="annottext">Readiness (SharedAddressPools key) -&gt; SharedState n key
</span><a href="#local-6989586621682486059"><span class="hs-identifier hs-var">mkSharedState</span></a></span><span> </span><span class="annot"><span class="annottext">Readiness (SharedAddressPools key)
forall a. Readiness a
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#Pending"><span class="hs-identifier hs-var">Shared.Pending</span></a></span><span>
</span><span id="line-610"></span><span>            </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Readiness (SharedAddressPools key) -&gt; SharedState n key
</span><a href="#local-6989586621682486059"><span class="hs-identifier hs-var">mkSharedState</span></a></span><span> </span><span class="annot"><span class="annottext">(Readiness (SharedAddressPools key) -&gt; SharedState n key)
-&gt; Readiness (SharedAddressPools key) -&gt; SharedState n key
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SharedAddressPools key -&gt; Readiness (SharedAddressPools key)
forall a. a -&gt; Readiness a
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#Active"><span class="hs-identifier hs-var">Shared.Active</span></a></span><span> </span><span class="annot"><span class="annottext">(SharedAddressPools key -&gt; Readiness (SharedAddressPools key))
-&gt; SharedAddressPools key -&gt; Readiness (SharedAddressPools key)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SharedAddressPool 'UtxoExternal key
-&gt; SharedAddressPool 'UtxoInternal key
-&gt; PendingIxs 'ScriptK
-&gt; SharedAddressPools key
forall (key :: Depth -&gt; * -&gt; *).
SharedAddressPool 'UtxoExternal key
-&gt; SharedAddressPool 'UtxoInternal key
-&gt; PendingIxs 'ScriptK
-&gt; SharedAddressPools key
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#SharedAddressPools"><span class="hs-identifier hs-var">Shared.SharedAddressPools</span></a></span><span>
</span><span id="line-611"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddressPoolGap
-&gt; ScriptTemplate
-&gt; Maybe ScriptTemplate
-&gt; SharedAddressPool 'UtxoExternal key
forall (n :: NetworkDiscriminant) (c :: Role)
       (key :: Depth -&gt; * -&gt; *).
(key ~ SharedKey, SupportsDiscovery n key, Typeable c) =&gt;
AddressPoolGap
-&gt; ScriptTemplate
-&gt; Maybe ScriptTemplate
-&gt; SharedAddressPool c key
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#newSharedAddressPool"><span class="hs-identifier hs-var">Shared.newSharedAddressPool</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486148"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#UtxoExternal"><span class="hs-identifier hs-type">UtxoExternal</span></a></span><span> </span><span class="annot"><span class="annottext">AddressPoolGap
</span><a href="#local-6989586621682486072"><span class="hs-identifier hs-var">gap</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTemplate
</span><a href="#local-6989586621682486062"><span class="hs-identifier hs-var">pTemplate</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ScriptTemplate
</span><a href="#local-6989586621682486060"><span class="hs-identifier hs-var">dTemplateM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-612"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddressPoolGap
-&gt; ScriptTemplate
-&gt; Maybe ScriptTemplate
-&gt; SharedAddressPool 'UtxoInternal key
forall (n :: NetworkDiscriminant) (c :: Role)
       (key :: Depth -&gt; * -&gt; *).
(key ~ SharedKey, SupportsDiscovery n key, Typeable c) =&gt;
AddressPoolGap
-&gt; ScriptTemplate
-&gt; Maybe ScriptTemplate
-&gt; SharedAddressPool c key
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#newSharedAddressPool"><span class="hs-identifier hs-var">Shared.newSharedAddressPool</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486148"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#UtxoInternal"><span class="hs-identifier hs-type">UtxoInternal</span></a></span><span> </span><span class="annot"><span class="annottext">AddressPoolGap
</span><a href="#local-6989586621682486072"><span class="hs-identifier hs-var">gap</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTemplate
</span><a href="#local-6989586621682486062"><span class="hs-identifier hs-var">pTemplate</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ScriptTemplate
</span><a href="#local-6989586621682486060"><span class="hs-identifier hs-var">dTemplateM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-613"></span><span>                </span><span class="annot"><span class="annottext">PendingIxs 'ScriptK
</span><a href="#local-6989586621682486058"><span class="hs-identifier hs-var">pendingIxs</span></a></span><span>
</span><span id="line-614"></span><span>        </span><span class="annot"><span class="annottext">Prologue (SharedState n key)
-&gt; MaybeT (SqlPersistT IO) (Prologue (SharedState n key))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Prologue (SharedState n key)
 -&gt; MaybeT (SqlPersistT IO) (Prologue (SharedState n key)))
-&gt; Prologue (SharedState n key)
-&gt; MaybeT (SqlPersistT IO) (Prologue (SharedState n key))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SharedState n key -&gt; Prologue (SharedState n key)
forall (n :: NetworkDiscriminant) (key :: Depth -&gt; * -&gt; *).
SharedState n key -&gt; Prologue (SharedState n key)
</span><a href="Cardano.Wallet.Address.Book.html#SharedPrologue"><span class="hs-identifier hs-var">SharedPrologue</span></a></span><span> </span><span class="annot"><span class="annottext">SharedState n key
</span><a href="#local-6989586621682486056"><span class="hs-identifier hs-var">prologue</span></a></span><span>
</span><span id="line-615"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-616"></span><span>        </span><span class="annot"><a href="#local-6989586621682486057"><span class="hs-identifier hs-type">selectSharedStatePendingIxs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-type">PendingIxs</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#ScriptK"><span class="hs-identifier hs-type">ScriptK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-617"></span><span>        </span><span id="local-6989586621682486057"><span class="annot"><span class="annottext">selectSharedStatePendingIxs :: ReaderT SqlBackend IO (PendingIxs 'ScriptK)
</span><a href="#local-6989586621682486057"><span class="hs-identifier hs-var hs-var">selectSharedStatePendingIxs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-618"></span><span>            </span><span class="annot"><span class="annottext">[Index 'Soft 'ScriptK] -&gt; PendingIxs 'ScriptK
forall (k :: Depth). [Index 'Soft k] -&gt; PendingIxs k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#pendingIxsFromList"><span class="hs-identifier hs-var">pendingIxsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Index 'Soft 'ScriptK] -&gt; PendingIxs 'ScriptK)
-&gt; ([Entity SharedStatePendingIx] -&gt; [Index 'Soft 'ScriptK])
-&gt; [Entity SharedStatePendingIx]
-&gt; PendingIxs 'ScriptK
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[Entity SharedStatePendingIx] -&gt; [Index 'Soft 'ScriptK]
forall (derivationType :: DerivationType) (level :: Depth).
[Entity SharedStatePendingIx] -&gt; [Index derivationType level]
</span><a href="#local-6989586621682486053"><span class="hs-identifier hs-var">fromRes</span></a></span><span> </span><span class="annot"><span class="annottext">([Entity SharedStatePendingIx] -&gt; PendingIxs 'ScriptK)
-&gt; ReaderT SqlBackend IO [Entity SharedStatePendingIx]
-&gt; ReaderT SqlBackend IO (PendingIxs 'ScriptK)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter SharedStatePendingIx]
-&gt; [SelectOpt SharedStatePendingIx]
-&gt; ReaderT SqlBackend IO [Entity SharedStatePendingIx]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-619"></span><span>                </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField SharedStatePendingIx WalletId
forall typ.
(typ ~ WalletId) =&gt;
EntityField SharedStatePendingIx typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SharedStatePendingWalletId"><span class="hs-identifier hs-var">SharedStatePendingWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SharedStatePendingIx WalletId
-&gt; WalletId -&gt; Filter SharedStatePendingIx
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486075"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-620"></span><span>                </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField SharedStatePendingIx Word32
-&gt; SelectOpt SharedStatePendingIx
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Desc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SharedStatePendingIx Word32
forall typ. (typ ~ Word32) =&gt; EntityField SharedStatePendingIx typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SharedStatePendingIxIndex"><span class="hs-identifier hs-var">SharedStatePendingIxIndex</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-621"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-622"></span><span>              </span><span id="local-6989586621682486053"><span class="annot"><span class="annottext">fromRes :: [Entity SharedStatePendingIx] -&gt; [Index derivationType level]
</span><a href="#local-6989586621682486053"><span class="hs-identifier hs-var hs-var">fromRes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Entity SharedStatePendingIx -&gt; Index derivationType level)
-&gt; [Entity SharedStatePendingIx] -&gt; [Index derivationType level]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Index derivationType level
forall (derivationType :: DerivationType) (level :: Depth).
Word32 -&gt; Index derivationType level
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-var">W.Index</span></a></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; Index derivationType level)
-&gt; (Entity SharedStatePendingIx -&gt; Word32)
-&gt; Entity SharedStatePendingIx
-&gt; Index derivationType level
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">SharedStatePendingIx -&gt; Word32
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#sharedStatePendingIxIndex"><span class="hs-identifier hs-var hs-var">sharedStatePendingIxIndex</span></a></span><span> </span><span class="annot"><span class="annottext">(SharedStatePendingIx -&gt; Word32)
-&gt; (Entity SharedStatePendingIx -&gt; SharedStatePendingIx)
-&gt; Entity SharedStatePendingIx
-&gt; Word32
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity SharedStatePendingIx -&gt; SharedStatePendingIx
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-623"></span><span>
</span><span id="line-624"></span><span>    </span><span id="local-6989586621682486050"><span class="annot"><span class="annottext">loadDiscoveries :: WalletId
-&gt; SlotNo -&gt; SqlPersistT IO (Discoveries (SharedState n key))
</span><a href="#local-6989586621682486050"><span class="hs-identifier hs-var hs-var hs-var hs-var">loadDiscoveries</span></a></span></span><span> </span><span id="local-6989586621682486049"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486049"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682486048"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486048"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-625"></span><span>        </span><span id="local-6989586621682486047"><span class="annot"><span class="annottext">SharedAddressMap 'UtxoExternal key
</span><a href="#local-6989586621682486047"><span class="hs-identifier hs-var">extAddrMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (c :: Role) (k :: Depth -&gt; * -&gt; *).
(MkKeyFingerprint k Address, Typeable c) =&gt;
SqlPersistT IO (SharedAddressMap c k)
forall (k :: Depth -&gt; * -&gt; *).
(MkKeyFingerprint k Address, Typeable 'UtxoExternal) =&gt;
SqlPersistT IO (SharedAddressMap 'UtxoExternal k)
</span><a href="#local-6989586621682486046"><span class="hs-identifier hs-var">loadAddresses</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#UtxoExternal"><span class="hs-identifier hs-type">UtxoExternal</span></a></span><span>
</span><span id="line-626"></span><span>        </span><span id="local-6989586621682486045"><span class="annot"><span class="annottext">SharedAddressMap 'UtxoInternal key
</span><a href="#local-6989586621682486045"><span class="hs-identifier hs-var">intAddrMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (c :: Role) (k :: Depth -&gt; * -&gt; *).
(MkKeyFingerprint k Address, Typeable c) =&gt;
SqlPersistT IO (SharedAddressMap c k)
forall (k :: Depth -&gt; * -&gt; *).
(MkKeyFingerprint k Address, Typeable 'UtxoInternal) =&gt;
SqlPersistT IO (SharedAddressMap 'UtxoInternal k)
</span><a href="#local-6989586621682486046"><span class="hs-identifier hs-var">loadAddresses</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#UtxoInternal"><span class="hs-identifier hs-type">UtxoInternal</span></a></span><span>
</span><span id="line-627"></span><span>        </span><span class="annot"><span class="annottext">Discoveries (SharedState n key)
-&gt; SqlPersistT IO (Discoveries (SharedState n key))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Discoveries (SharedState n key)
 -&gt; SqlPersistT IO (Discoveries (SharedState n key)))
-&gt; Discoveries (SharedState n key)
-&gt; SqlPersistT IO (Discoveries (SharedState n key))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SharedAddressMap 'UtxoExternal key
-&gt; SharedAddressMap 'UtxoInternal key
-&gt; Discoveries (SharedState n key)
forall (n :: NetworkDiscriminant) (key :: Depth -&gt; * -&gt; *).
SharedAddressMap 'UtxoExternal key
-&gt; SharedAddressMap 'UtxoInternal key
-&gt; Discoveries (SharedState n key)
</span><a href="Cardano.Wallet.Address.Book.html#SharedDiscoveries"><span class="hs-identifier hs-var">SharedDiscoveries</span></a></span><span> </span><span class="annot"><span class="annottext">SharedAddressMap 'UtxoExternal key
</span><a href="#local-6989586621682486047"><span class="hs-identifier hs-var">extAddrMap</span></a></span><span> </span><span class="annot"><span class="annottext">SharedAddressMap 'UtxoInternal key
</span><a href="#local-6989586621682486045"><span class="hs-identifier hs-var">intAddrMap</span></a></span><span>
</span><span id="line-628"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-629"></span><span>        </span><span class="annot"><a href="#local-6989586621682486046"><span class="hs-identifier hs-type">loadAddresses</span></a></span><span>
</span><span id="line-630"></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682486543"><span class="annot"><a href="#local-6989586621682486543"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682486544"><span class="annot"><a href="#local-6989586621682486544"><span class="hs-identifier hs-type">k</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Depth"><span class="hs-identifier hs-type">Depth</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><span id="line-631"></span><span>               </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#MkKeyFingerprint"><span class="hs-identifier hs-type">MkKeyFingerprint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486544"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">W.Address</span></a></span><span>
</span><span id="line-632"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Typeable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486543"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-633"></span><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#SharedAddressMap"><span class="hs-identifier hs-type">SharedAddressMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486543"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486544"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-634"></span><span>        </span><span id="local-6989586621682486046"><span class="annot"><span class="annottext">loadAddresses :: SqlPersistT IO (SharedAddressMap c k)
</span><a href="#local-6989586621682486046"><span class="hs-identifier hs-var hs-var">loadAddresses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-635"></span><span>            </span><span id="local-6989586621682486044"><span class="annot"><span class="annottext">[SeqStateAddress]
</span><a href="#local-6989586621682486044"><span class="hs-identifier hs-var">addrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Entity SeqStateAddress -&gt; SeqStateAddress)
-&gt; [Entity SeqStateAddress] -&gt; [SeqStateAddress]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Entity SeqStateAddress -&gt; SeqStateAddress
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">([Entity SeqStateAddress] -&gt; [SeqStateAddress])
-&gt; ReaderT SqlBackend IO [Entity SeqStateAddress]
-&gt; ReaderT SqlBackend IO [SeqStateAddress]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter SeqStateAddress]
-&gt; [SelectOpt SeqStateAddress]
-&gt; ReaderT SqlBackend IO [Entity SeqStateAddress]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-636"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField SeqStateAddress typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddressWalletId"><span class="hs-identifier hs-var">SeqStateAddressWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress WalletId
-&gt; WalletId -&gt; Filter SeqStateAddress
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486049"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-637"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField SeqStateAddress typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddressSlot"><span class="hs-identifier hs-var">SeqStateAddressSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress SlotNo
-&gt; SlotNo -&gt; Filter SeqStateAddress
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486048"><span class="hs-identifier hs-var">sl</span></a></span><span>
</span><span id="line-638"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress Role
forall typ. (typ ~ Role) =&gt; EntityField SeqStateAddress typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddressRole"><span class="hs-identifier hs-var">SeqStateAddressRole</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress Role -&gt; Role -&gt; Filter SeqStateAddress
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">Typeable c =&gt; Role
forall (c :: Role). Typeable c =&gt; Role
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#roleVal"><span class="hs-identifier hs-var">roleVal</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682486543"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-639"></span><span>                </span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField SeqStateAddress Word32 -&gt; SelectOpt SeqStateAddress
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Asc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress Word32
forall typ. (typ ~ Word32) =&gt; EntityField SeqStateAddress typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddressIndex"><span class="hs-identifier hs-var">SeqStateAddressIndex</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-640"></span><span>            </span><span class="annot"><span class="annottext">SharedAddressMap c k -&gt; SqlPersistT IO (SharedAddressMap c k)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(SharedAddressMap c k -&gt; SqlPersistT IO (SharedAddressMap c k))
-&gt; SharedAddressMap c k -&gt; SqlPersistT IO (SharedAddressMap c k)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (KeyFingerprint &quot;payment&quot; k) (Index 'Soft 'ScriptK, AddressState)
-&gt; SharedAddressMap c k
forall (c :: Role) (key :: Depth -&gt; * -&gt; *).
Map
  (KeyFingerprint &quot;payment&quot; key) (Index 'Soft 'ScriptK, AddressState)
-&gt; SharedAddressMap c key
</span><a href="Cardano.Wallet.Address.Book.html#SharedAddressMap"><span class="hs-identifier hs-var">SharedAddressMap</span></a></span><span> </span><span class="annot"><span class="annottext">(Map
   (KeyFingerprint &quot;payment&quot; k) (Index 'Soft 'ScriptK, AddressState)
 -&gt; SharedAddressMap c k)
-&gt; Map
     (KeyFingerprint &quot;payment&quot; k) (Index 'Soft 'ScriptK, AddressState)
-&gt; SharedAddressMap c k
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[(KeyFingerprint &quot;payment&quot; k,
  (Index 'Soft 'ScriptK, AddressState))]
-&gt; Map
     (KeyFingerprint &quot;payment&quot; k) (Index 'Soft 'ScriptK, AddressState)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span>
</span><span id="line-641"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyFingerprint &quot;payment&quot; k
</span><a href="#local-6989586621682486043"><span class="hs-identifier hs-var">fingerprint</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Index 'Soft 'ScriptK
forall a. Enum a =&gt; Int -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toEnum</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Index 'Soft 'ScriptK) -&gt; Int -&gt; Index 'Soft 'ScriptK
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486042"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AddressState
</span><a href="#local-6989586621682486041"><span class="hs-identifier hs-var">status</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-642"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddress"><span class="hs-identifier hs-type">SeqStateAddress</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682486040"><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682486040"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span id="local-6989586621682486042"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486042"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682486041"><span class="annot"><span class="annottext">AddressState
</span><a href="#local-6989586621682486041"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SeqStateAddress]
</span><a href="#local-6989586621682486044"><span class="hs-identifier hs-var">addrs</span></a></span><span>
</span><span id="line-643"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621682486043"><span class="annot"><span class="annottext">KeyFingerprint &quot;payment&quot; k
</span><a href="#local-6989586621682486043"><span class="hs-identifier hs-var">fingerprint</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Address
-&gt; Either
     (ErrMkKeyFingerprint k Address) (KeyFingerprint &quot;payment&quot; k)
forall (key :: Depth -&gt; * -&gt; *) from.
MkKeyFingerprint key from =&gt;
from
-&gt; Either
     (ErrMkKeyFingerprint key from) (KeyFingerprint &quot;payment&quot; key)
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#paymentKeyFingerprint"><span class="hs-identifier hs-var">paymentKeyFingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682486040"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-644"></span><span>                </span><span class="hs-special">]</span></span></span><span>
</span><span id="line-645"></span><span>
</span><span id="line-646"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectCosigners"><span class="hs-identifier hs-type">selectCosigners</span></a></span><span>
</span><span id="line-647"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682486567"><span class="annot"><a href="#local-6989586621682486567"><span class="hs-identifier hs-type">k</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPublicKey"><span class="hs-identifier hs-type">PersistPublicKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682486567"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AccountK"><span class="hs-identifier hs-type">AccountK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-648"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-649"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Shared.html#CredentialType"><span class="hs-identifier hs-type">CredentialType</span></a></span><span>
</span><span id="line-650"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier hs-type">Cosigner</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682486567"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AccountK"><span class="hs-identifier hs-type">AccountK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-651"></span><span id="selectCosigners"><span class="annot"><span class="annottext">selectCosigners :: WalletId
-&gt; CredentialType -&gt; SqlPersistT IO [(Cosigner, k 'AccountK XPub)]
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectCosigners"><span class="hs-identifier hs-var hs-var">selectCosigners</span></a></span></span><span> </span><span id="local-6989586621682486038"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486038"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682486037"><span class="annot"><span class="annottext">CredentialType
</span><a href="#local-6989586621682486037"><span class="hs-identifier hs-var">cred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-652"></span><span>    </span><span class="annot"><span class="annottext">(Entity CosignerKey -&gt; (Cosigner, k 'AccountK XPub))
-&gt; [Entity CosignerKey] -&gt; [(Cosigner, k 'AccountK XPub)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CosignerKey -&gt; (Cosigner, k 'AccountK XPub)
forall (key :: * -&gt; *).
PersistPublicKey key =&gt;
CosignerKey -&gt; (Cosigner, key XPub)
</span><a href="#local-6989586621682486036"><span class="hs-identifier hs-var">cosignerFromEntity</span></a></span><span> </span><span class="annot"><span class="annottext">(CosignerKey -&gt; (Cosigner, k 'AccountK XPub))
-&gt; (Entity CosignerKey -&gt; CosignerKey)
-&gt; Entity CosignerKey
-&gt; (Cosigner, k 'AccountK XPub)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity CosignerKey -&gt; CosignerKey
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Entity CosignerKey] -&gt; [(Cosigner, k 'AccountK XPub)])
-&gt; ReaderT SqlBackend IO [Entity CosignerKey]
-&gt; SqlPersistT IO [(Cosigner, k 'AccountK XPub)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter CosignerKey]
-&gt; [SelectOpt CosignerKey]
-&gt; ReaderT SqlBackend IO [Entity CosignerKey]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-653"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField CosignerKey WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField CosignerKey typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CosignerKeyWalletId"><span class="hs-identifier hs-var">CosignerKeyWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField CosignerKey WalletId -&gt; WalletId -&gt; Filter CosignerKey
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486038"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-654"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField CosignerKey CredentialType
forall typ. (typ ~ CredentialType) =&gt; EntityField CosignerKey typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CosignerKeyCredential"><span class="hs-identifier hs-var">CosignerKeyCredential</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField CosignerKey CredentialType
-&gt; CredentialType -&gt; Filter CosignerKey
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">CredentialType
</span><a href="#local-6989586621682486037"><span class="hs-identifier hs-var">cred</span></a></span><span>
</span><span id="line-655"></span><span>        </span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-656"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-657"></span><span>   </span><span id="local-6989586621682486036"><span class="annot"><span class="annottext">cosignerFromEntity :: CosignerKey -&gt; (Cosigner, key XPub)
</span><a href="#local-6989586621682486036"><span class="hs-identifier hs-var hs-var">cosignerFromEntity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CosignerKey"><span class="hs-identifier hs-type">CosignerKey</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CredentialType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682486035"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682486035"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621682486034"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621682486034"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-658"></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Cosigner
</span><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier hs-var">Cosigner</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621682486034"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; key XPub
forall (key :: * -&gt; *).
PersistPublicKey key =&gt;
ByteString -&gt; key XPub
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#unsafeDeserializeXPub"><span class="hs-identifier hs-var">unsafeDeserializeXPub</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682486035"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-659"></span><span>
</span><span id="line-660"></span><span class="hs-comment">-- | Check whether we have ever stored checkpoints for a multi-signature pool</span><span>
</span><span id="line-661"></span><span class="hs-comment">--</span><span>
</span><span id="line-662"></span><span class="hs-comment">-- FIXME during APD-1043:</span><span>
</span><span id="line-663"></span><span class="hs-comment">-- Whether the 'SharedState' is 'Pending' or 'Active' should be apparent</span><span>
</span><span id="line-664"></span><span class="hs-comment">-- from the data in the table corresponding to the 'Prologue'.</span><span>
</span><span id="line-665"></span><span class="hs-comment">-- Testing whether the table corresponding to 'Discoveries' is present</span><span>
</span><span id="line-666"></span><span class="hs-comment">-- or absent is a nice idea, but it ultimately complicates the separation</span><span>
</span><span id="line-667"></span><span class="hs-comment">-- between Prologue and Discoveries.</span><span>
</span><span id="line-668"></span><span class="hs-comment">-- Solution: Add a 'Ready' column in the next version of the database format.</span><span>
</span><span id="line-669"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#multisigPoolAbsent"><span class="hs-identifier hs-type">multisigPoolAbsent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-670"></span><span id="multisigPoolAbsent"><span class="annot"><span class="annottext">multisigPoolAbsent :: WalletId -&gt; SqlPersistT IO Bool
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#multisigPoolAbsent"><span class="hs-identifier hs-var hs-var">multisigPoolAbsent</span></a></span></span><span> </span><span id="local-6989586621682486033"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486033"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-671"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Entity SeqStateAddress) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">isNothing</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Entity SeqStateAddress) -&gt; Bool)
-&gt; ReaderT SqlBackend IO (Maybe (Entity SeqStateAddress))
-&gt; SqlPersistT IO Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter SeqStateAddress]
-&gt; [SelectOpt SeqStateAddress]
-&gt; ReaderT SqlBackend IO (Maybe (Entity SeqStateAddress))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span>
</span><span id="line-672"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField SeqStateAddress typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddressWalletId"><span class="hs-identifier hs-var">SeqStateAddressWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress WalletId
-&gt; WalletId -&gt; Filter SeqStateAddress
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486033"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-673"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress Role
forall typ. (typ ~ Role) =&gt; EntityField SeqStateAddress typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#SeqStateAddressRole"><span class="hs-identifier hs-var">SeqStateAddressRole</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField SeqStateAddress Role -&gt; Role -&gt; Filter SeqStateAddress
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#UtxoExternal"><span class="hs-identifier hs-var">UtxoExternal</span></a></span><span>
</span><span id="line-674"></span><span>        </span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-675"></span><span>
</span><span id="line-676"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    HD Random address book storage
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-679"></span><span class="hs-comment">-- piggy-back on RndState existing instance, to simulate the same behavior.</span><span>
</span><span id="line-680"></span><span id="local-6989586621682486031"><span id="local-6989586621682486032"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Random.html#RndAnyState"><span class="hs-identifier hs-type">Rnd.RndAnyState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486032"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486031"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-681"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-682"></span><span>    </span><span id="local-6989586621682486025"><span class="annot"><span class="annottext">insertPrologue :: WalletId -&gt; Prologue (RndAnyState n p) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486025"><span class="hs-identifier hs-var hs-var hs-var hs-var">insertPrologue</span></a></span></span><span> </span><span id="local-6989586621682486024"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486024"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#PR"><span class="hs-identifier hs-type">PR</span></a></span><span> </span><span id="local-6989586621682486022"><span class="annot"><a href="#local-6989586621682486022"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; Prologue (RndState n) -&gt; SqlPersistT IO ()
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; Prologue s -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertPrologue"><span class="hs-identifier hs-var">insertPrologue</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486024"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Prologue (RndState n)
</span><a href="#local-6989586621682486022"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-683"></span><span>    </span><span id="local-6989586621682486021"><span class="annot"><span class="annottext">insertDiscoveries :: WalletId
-&gt; SlotNo -&gt; Discoveries (RndAnyState n p) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486021"><span class="hs-identifier hs-var hs-var hs-var hs-var">insertDiscoveries</span></a></span></span><span> </span><span id="local-6989586621682486020"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486020"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682486019"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486019"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#DR"><span class="hs-identifier hs-type">DR</span></a></span><span> </span><span id="local-6989586621682486017"><span class="annot"><a href="#local-6989586621682486017"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; SlotNo -&gt; Discoveries (RndState n) -&gt; SqlPersistT IO ()
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; SlotNo -&gt; Discoveries s -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertDiscoveries"><span class="hs-identifier hs-var">insertDiscoveries</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486020"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486019"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">Discoveries (RndState n)
</span><a href="#local-6989586621682486017"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-684"></span><span>    </span><span id="local-6989586621682486016"><span class="annot"><span class="annottext">loadPrologue :: WalletId -&gt; SqlPersistT IO (Maybe (Prologue (RndAnyState n p)))
</span><a href="#local-6989586621682486016"><span class="hs-identifier hs-var hs-var hs-var hs-var">loadPrologue</span></a></span></span><span> </span><span id="local-6989586621682486015"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486015"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Prologue (RndState n) -&gt; Prologue (RndAnyState n p))
-&gt; Maybe (Prologue (RndState n))
-&gt; Maybe (Prologue (RndAnyState n p))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Prologue (RndState n) -&gt; Prologue (RndAnyState n p)
forall (n :: NetworkDiscriminant) (p :: Nat).
Prologue (RndState n) -&gt; Prologue (RndAnyState n p)
</span><a href="Cardano.Wallet.Address.Book.html#PR"><span class="hs-identifier hs-var">PR</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Prologue (RndState n))
 -&gt; Maybe (Prologue (RndAnyState n p)))
-&gt; ReaderT SqlBackend IO (Maybe (Prologue (RndState n)))
-&gt; SqlPersistT IO (Maybe (Prologue (RndAnyState n p)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ReaderT SqlBackend IO (Maybe (Prologue (RndState n)))
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; SqlPersistT IO (Maybe (Prologue s))
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#loadPrologue"><span class="hs-identifier hs-var">loadPrologue</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486015"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-685"></span><span>    </span><span id="local-6989586621682486014"><span class="annot"><span class="annottext">loadDiscoveries :: WalletId
-&gt; SlotNo -&gt; SqlPersistT IO (Discoveries (RndAnyState n p))
</span><a href="#local-6989586621682486014"><span class="hs-identifier hs-var hs-var hs-var hs-var">loadDiscoveries</span></a></span></span><span> </span><span id="local-6989586621682486013"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486013"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682486012"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486012"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Discoveries (RndState n) -&gt; Discoveries (RndAnyState n p)
forall (n :: NetworkDiscriminant) (p :: Nat).
Discoveries (RndState n) -&gt; Discoveries (RndAnyState n p)
</span><a href="Cardano.Wallet.Address.Book.html#DR"><span class="hs-identifier hs-var">DR</span></a></span><span> </span><span class="annot"><span class="annottext">(Discoveries (RndState n) -&gt; Discoveries (RndAnyState n p))
-&gt; ReaderT SqlBackend IO (Discoveries (RndState n))
-&gt; SqlPersistT IO (Discoveries (RndAnyState n p))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; SlotNo -&gt; ReaderT SqlBackend IO (Discoveries (RndState n))
forall s.
PersistAddressBook s =&gt;
WalletId -&gt; SlotNo -&gt; SqlPersistT IO (Discoveries s)
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#loadDiscoveries"><span class="hs-identifier hs-var">loadDiscoveries</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486013"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682486012"><span class="hs-identifier hs-var">sl</span></a></span></span></span><span>
</span><span id="line-686"></span><span>
</span><span id="line-687"></span><span class="hs-comment">-- | Persisting 'RndState' requires that the wallet root key has already been</span><span>
</span><span id="line-688"></span><span class="hs-comment">-- added to the database with 'putPrivateKey'. Unlike sequential AD, random</span><span>
</span><span id="line-689"></span><span class="hs-comment">-- address discovery requires a root key to recognize addresses.</span><span>
</span><span id="line-690"></span><span id="local-6989586621682486011"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Random.html#RndState"><span class="hs-identifier hs-type">Rnd.RndState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682486011"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-691"></span><span>    </span><span id="local-6989586621682486005"><span class="annot"><span class="annottext">insertPrologue :: WalletId -&gt; Prologue (RndState n) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682486005"><span class="hs-identifier hs-var hs-var hs-var hs-var">insertPrologue</span></a></span></span><span> </span><span id="local-6989586621682486004"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486004"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#RndPrologue"><span class="hs-identifier hs-type">RndPrologue</span></a></span><span> </span><span id="local-6989586621682486002"><span class="annot"><a href="#local-6989586621682486002"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-692"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682486001"><span class="annot"><span class="annottext">ix :: Word32
</span><a href="#local-6989586621682486001"><span class="hs-identifier hs-var hs-var">ix</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Index 'Hardened 'AccountK -&gt; Word32
forall (derivationType :: DerivationType) (level :: Depth).
Index derivationType level -&gt; Word32
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#getIndex"><span class="hs-identifier hs-var hs-var">W.getIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RndState n
</span><a href="#local-6989586621682486002"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">RndState n
-&gt; ((Index 'Hardened 'AccountK
     -&gt; Const (Index 'Hardened 'AccountK) (Index 'Hardened 'AccountK))
    -&gt; RndState n -&gt; Const (Index 'Hardened 'AccountK) (RndState n))
-&gt; Index 'Hardened 'AccountK
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;accountIndex&quot;
  ((Index 'Hardened 'AccountK
    -&gt; Const (Index 'Hardened 'AccountK) (Index 'Hardened 'AccountK))
   -&gt; RndState n -&gt; Const (Index 'Hardened 'AccountK) (RndState n))
(Index 'Hardened 'AccountK
 -&gt; Const (Index 'Hardened 'AccountK) (Index 'Hardened 'AccountK))
-&gt; RndState n -&gt; Const (Index 'Hardened 'AccountK) (RndState n)
</span><a href="#local-6989586621682486000"><span class="hs-var">#accountIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-693"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682485999"><span class="annot"><span class="annottext">gen :: StdGen
</span><a href="#local-6989586621682485999"><span class="hs-identifier hs-var hs-var">gen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RndState n
</span><a href="#local-6989586621682486002"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">RndState n
-&gt; ((StdGen -&gt; Const StdGen StdGen)
    -&gt; RndState n -&gt; Const StdGen (RndState n))
-&gt; StdGen
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;gen&quot;
  ((StdGen -&gt; Const StdGen StdGen)
   -&gt; RndState n -&gt; Const StdGen (RndState n))
(StdGen -&gt; Const StdGen StdGen)
-&gt; RndState n -&gt; Const StdGen (RndState n)
</span><a href="#local-6989586621682485998"><span class="hs-var">#gen</span></a></span><span>
</span><span id="line-694"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682485997"><span class="annot"><span class="annottext">pwd :: Passphrase &quot;addr-derivation-payload&quot;
</span><a href="#local-6989586621682485997"><span class="hs-identifier hs-var hs-var">pwd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RndState n
</span><a href="#local-6989586621682486002"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">RndState n
-&gt; ((Passphrase &quot;addr-derivation-payload&quot;
     -&gt; Const
          (Passphrase &quot;addr-derivation-payload&quot;)
          (Passphrase &quot;addr-derivation-payload&quot;))
    -&gt; RndState n
    -&gt; Const (Passphrase &quot;addr-derivation-payload&quot;) (RndState n))
-&gt; Passphrase &quot;addr-derivation-payload&quot;
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;hdPassphrase&quot;
  ((Passphrase &quot;addr-derivation-payload&quot;
    -&gt; Const
         (Passphrase &quot;addr-derivation-payload&quot;)
         (Passphrase &quot;addr-derivation-payload&quot;))
   -&gt; RndState n
   -&gt; Const (Passphrase &quot;addr-derivation-payload&quot;) (RndState n))
(Passphrase &quot;addr-derivation-payload&quot;
 -&gt; Const
      (Passphrase &quot;addr-derivation-payload&quot;)
      (Passphrase &quot;addr-derivation-payload&quot;))
-&gt; RndState n
-&gt; Const (Passphrase &quot;addr-derivation-payload&quot;) (RndState n)
</span><a href="#local-6989586621682485996"><span class="hs-var">#hdPassphrase</span></a></span><span>
</span><span id="line-695"></span><span>        </span><span class="annot"><span class="annottext">Key RndState -&gt; RndState -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
Key record -&gt; record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">repsert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; Key RndState
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndStateKey"><span class="hs-identifier hs-var">RndStateKey</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486004"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; Word32 -&gt; StdGen -&gt; HDPassphrase -&gt; RndState
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndState"><span class="hs-identifier hs-var">RndState</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486004"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682486001"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621682485999"><span class="hs-identifier hs-var">gen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Passphrase &quot;addr-derivation-payload&quot; -&gt; HDPassphrase
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#HDPassphrase"><span class="hs-identifier hs-var">HDPassphrase</span></a></span><span> </span><span class="annot"><span class="annottext">Passphrase &quot;addr-derivation-payload&quot;
</span><a href="#local-6989586621682485997"><span class="hs-identifier hs-var">pwd</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-696"></span><span>        </span><span class="annot"><span class="annottext">WalletId -&gt; Map DerivationPath Address -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertRndStatePending"><span class="hs-identifier hs-var">insertRndStatePending</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682486004"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RndState n
</span><a href="#local-6989586621682486002"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">RndState n
-&gt; ((Map DerivationPath Address
     -&gt; Const (Map DerivationPath Address) (Map DerivationPath Address))
    -&gt; RndState n -&gt; Const (Map DerivationPath Address) (RndState n))
-&gt; Map DerivationPath Address
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;pendingAddresses&quot;
  ((Map DerivationPath Address
    -&gt; Const (Map DerivationPath Address) (Map DerivationPath Address))
   -&gt; RndState n -&gt; Const (Map DerivationPath Address) (RndState n))
(Map DerivationPath Address
 -&gt; Const (Map DerivationPath Address) (Map DerivationPath Address))
-&gt; RndState n -&gt; Const (Map DerivationPath Address) (RndState n)
</span><a href="#local-6989586621682485991"><span class="hs-var">#pendingAddresses</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-697"></span><span>
</span><span id="line-698"></span><span>    </span><span id="local-6989586621682485990"><span class="annot"><span class="annottext">insertDiscoveries :: WalletId -&gt; SlotNo -&gt; Discoveries (RndState n) -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682485990"><span class="hs-identifier hs-var hs-var hs-var hs-var">insertDiscoveries</span></a></span></span><span> </span><span id="local-6989586621682485989"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682485989"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682485988"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682485988"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Address.Book.html#RndDiscoveries"><span class="hs-identifier hs-type">RndDiscoveries</span></a></span><span> </span><span id="local-6989586621682485986"><span class="annot"><a href="#local-6989586621682485986"><span class="hs-identifier hs-var">addresses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-699"></span><span>        </span><span class="annot"><span class="annottext">([RndStateAddress] -&gt; SqlPersistT IO ())
-&gt; [RndStateAddress] -&gt; SqlPersistT IO ()
forall record b.
PersistEntity record =&gt;
([record] -&gt; SqlPersistT IO b) -&gt; [record] -&gt; SqlPersistT IO ()
</span><a href="Cardano.DB.Sqlite.html#dbChunked"><span class="hs-identifier hs-var">dbChunked</span></a></span><span> </span><span class="annot"><span class="annottext">[RndStateAddress] -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insertMany_</span></a></span><span>
</span><span id="line-700"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; SlotNo
-&gt; Word32
-&gt; Word32
-&gt; Address
-&gt; AddressState
-&gt; RndStateAddress
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndStateAddress"><span class="hs-identifier hs-var">RndStateAddress</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682485989"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682485988"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485984"><span class="hs-identifier hs-var">accIx</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485983"><span class="hs-identifier hs-var">addrIx</span></a></span><span> </span><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682485982"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="annot"><span class="annottext">AddressState
</span><a href="#local-6989586621682485981"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-701"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">W.Index</span></a></span><span> </span><span id="local-6989586621682485984"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485984"><span class="hs-identifier hs-var">accIx</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">W.Index</span></a></span><span> </span><span id="local-6989586621682485983"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485983"><span class="hs-identifier hs-var">addrIx</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682485982"><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682485982"><span class="hs-identifier hs-var">addr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682485981"><span class="annot"><span class="annottext">AddressState
</span><a href="#local-6989586621682485981"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-702"></span><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map DerivationPath (Address, AddressState)
-&gt; [(DerivationPath, (Address, AddressState))]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.assocs</span></a></span><span> </span><span class="annot"><span class="annottext">Map DerivationPath (Address, AddressState)
</span><a href="#local-6989586621682485986"><span class="hs-identifier hs-var">addresses</span></a></span><span>
</span><span id="line-703"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-704"></span><span>
</span><span id="line-705"></span><span>    </span><span id="local-6989586621682485980"><span class="annot"><span class="annottext">loadPrologue :: WalletId -&gt; SqlPersistT IO (Maybe (Prologue (RndState n)))
</span><a href="#local-6989586621682485980"><span class="hs-identifier hs-var hs-var hs-var hs-var">loadPrologue</span></a></span></span><span> </span><span id="local-6989586621682485979"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682485979"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeT (SqlPersistT IO) (Prologue (RndState n))
-&gt; SqlPersistT IO (Maybe (Prologue (RndState n)))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var hs-var">runMaybeT</span></a></span><span> </span><span class="annot"><span class="annottext">(MaybeT (SqlPersistT IO) (Prologue (RndState n))
 -&gt; SqlPersistT IO (Maybe (Prologue (RndState n))))
-&gt; MaybeT (SqlPersistT IO) (Prologue (RndState n))
-&gt; SqlPersistT IO (Maybe (Prologue (RndState n)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-706"></span><span>        </span><span id="local-6989586621682485978"><span class="annot"><span class="annottext">Entity RndState
</span><a href="#local-6989586621682485978"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Maybe (Entity RndState))
-&gt; MaybeT (SqlPersistT IO) (Entity RndState)
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">MaybeT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Maybe (Entity RndState))
 -&gt; MaybeT (SqlPersistT IO) (Entity RndState))
-&gt; ReaderT SqlBackend IO (Maybe (Entity RndState))
-&gt; MaybeT (SqlPersistT IO) (Entity RndState)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter RndState]
-&gt; [SelectOpt RndState]
-&gt; ReaderT SqlBackend IO (Maybe (Entity RndState))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span>
</span><span id="line-707"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField RndState WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField RndState typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndStateWalletId"><span class="hs-identifier hs-var">RndStateWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField RndState WalletId -&gt; WalletId -&gt; Filter RndState
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682485979"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-708"></span><span>            </span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-709"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndState"><span class="hs-identifier hs-type">RndState</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682485976"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485976"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span id="local-6989586621682485975"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621682485975"><span class="hs-identifier hs-var">gen</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#HDPassphrase"><span class="hs-identifier hs-type">HDPassphrase</span></a></span><span> </span><span id="local-6989586621682485974"><span class="annot"><span class="annottext">Passphrase &quot;addr-derivation-payload&quot;
</span><a href="#local-6989586621682485974"><span class="hs-identifier hs-var">pwd</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Entity RndState -&gt; RndState
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">Entity RndState
</span><a href="#local-6989586621682485978"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-710"></span><span>        </span><span id="local-6989586621682485973"><span class="annot"><span class="annottext">Map DerivationPath Address
</span><a href="#local-6989586621682485973"><span class="hs-identifier hs-var">pendingAddresses</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Map DerivationPath Address)
-&gt; MaybeT (SqlPersistT IO) (Map DerivationPath Address)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Map DerivationPath Address)
 -&gt; MaybeT (SqlPersistT IO) (Map DerivationPath Address))
-&gt; ReaderT SqlBackend IO (Map DerivationPath Address)
-&gt; MaybeT (SqlPersistT IO) (Map DerivationPath Address)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ReaderT SqlBackend IO (Map DerivationPath Address)
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectRndStatePending"><span class="hs-identifier hs-var">selectRndStatePending</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682485979"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-711"></span><span>        </span><span class="annot"><span class="annottext">Prologue (RndState n)
-&gt; MaybeT (SqlPersistT IO) (Prologue (RndState n))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Prologue (RndState n)
 -&gt; MaybeT (SqlPersistT IO) (Prologue (RndState n)))
-&gt; Prologue (RndState n)
-&gt; MaybeT (SqlPersistT IO) (Prologue (RndState n))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RndState n -&gt; Prologue (RndState n)
forall (n :: NetworkDiscriminant).
RndState n -&gt; Prologue (RndState n)
</span><a href="Cardano.Wallet.Address.Book.html#RndPrologue"><span class="hs-identifier hs-var">RndPrologue</span></a></span><span> </span><span class="annot"><span class="annottext">(RndState n -&gt; Prologue (RndState n))
-&gt; RndState n -&gt; Prologue (RndState n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RndState :: forall (network :: NetworkDiscriminant).
Passphrase &quot;addr-derivation-payload&quot;
-&gt; Index 'Hardened 'AccountK
-&gt; Map DerivationPath (Address, AddressState)
-&gt; Map DerivationPath Address
-&gt; StdGen
-&gt; RndState network
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.Random.html#RndState"><span class="hs-identifier hs-type">Rnd.RndState</span></a></span><span>
</span><span id="line-712"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">hdPassphrase :: Passphrase &quot;addr-derivation-payload&quot;
</span><a href="#local-6989586621682485970"><span class="hs-identifier hs-var">hdPassphrase</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Passphrase &quot;addr-derivation-payload&quot;
</span><a href="#local-6989586621682485974"><span class="hs-identifier hs-var">pwd</span></a></span><span>
</span><span id="line-713"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">accountIndex :: Index 'Hardened 'AccountK
</span><a href="#local-6989586621682485969"><span class="hs-identifier hs-var">accountIndex</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Index 'Hardened 'AccountK
forall (derivationType :: DerivationType) (level :: Depth).
Word32 -&gt; Index derivationType level
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-var">W.Index</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485976"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-714"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">discoveredAddresses :: Map DerivationPath (Address, AddressState)
</span><a href="#local-6989586621682485968"><span class="hs-identifier hs-var">discoveredAddresses</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map DerivationPath (Address, AddressState)
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-715"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pendingAddresses :: Map DerivationPath Address
</span><a href="#local-6989586621682485966"><span class="hs-identifier hs-var">pendingAddresses</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map DerivationPath Address
</span><a href="#local-6989586621682485973"><span class="hs-identifier hs-var">pendingAddresses</span></a></span><span>
</span><span id="line-716"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">gen :: StdGen
</span><a href="#local-6989586621682485965"><span class="hs-identifier hs-var">gen</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621682485975"><span class="hs-identifier hs-var">gen</span></a></span><span>
</span><span id="line-717"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-718"></span><span>
</span><span id="line-719"></span><span>    </span><span id="local-6989586621682485964"><span class="annot"><span class="annottext">loadDiscoveries :: WalletId -&gt; SlotNo -&gt; SqlPersistT IO (Discoveries (RndState n))
</span><a href="#local-6989586621682485964"><span class="hs-identifier hs-var hs-var hs-var hs-var">loadDiscoveries</span></a></span></span><span> </span><span id="local-6989586621682485963"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682485963"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682485962"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682485962"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-720"></span><span>        </span><span id="local-6989586621682485961"><span class="annot"><span class="annottext">[(DerivationPath, (Address, AddressState))]
</span><a href="#local-6989586621682485961"><span class="hs-identifier hs-var">addrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Entity RndStateAddress
 -&gt; (DerivationPath, (Address, AddressState)))
-&gt; [Entity RndStateAddress]
-&gt; [(DerivationPath, (Address, AddressState))]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RndStateAddress -&gt; (DerivationPath, (Address, AddressState))
forall (derivationType :: DerivationType) (level :: Depth)
       (derivationType :: DerivationType) (level :: Depth).
RndStateAddress
-&gt; ((Index derivationType level, Index derivationType level),
    (Address, AddressState))
</span><a href="#local-6989586621682485960"><span class="hs-identifier hs-var">assocFromEntity</span></a></span><span> </span><span class="annot"><span class="annottext">(RndStateAddress -&gt; (DerivationPath, (Address, AddressState)))
-&gt; (Entity RndStateAddress -&gt; RndStateAddress)
-&gt; Entity RndStateAddress
-&gt; (DerivationPath, (Address, AddressState))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity RndStateAddress -&gt; RndStateAddress
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Entity RndStateAddress]
 -&gt; [(DerivationPath, (Address, AddressState))])
-&gt; ReaderT SqlBackend IO [Entity RndStateAddress]
-&gt; ReaderT
     SqlBackend IO [(DerivationPath, (Address, AddressState))]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter RndStateAddress]
-&gt; [SelectOpt RndStateAddress]
-&gt; ReaderT SqlBackend IO [Entity RndStateAddress]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-721"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField RndStateAddress WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField RndStateAddress typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndStateAddressWalletId"><span class="hs-identifier hs-var">RndStateAddressWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField RndStateAddress WalletId
-&gt; WalletId -&gt; Filter RndStateAddress
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682485963"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-722"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField RndStateAddress SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField RndStateAddress typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndStateAddressSlot"><span class="hs-identifier hs-var">RndStateAddressSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField RndStateAddress SlotNo
-&gt; SlotNo -&gt; Filter RndStateAddress
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682485962"><span class="hs-identifier hs-var">sl</span></a></span><span>
</span><span id="line-723"></span><span>            </span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-724"></span><span>        </span><span class="annot"><span class="annottext">Discoveries (RndState n)
-&gt; SqlPersistT IO (Discoveries (RndState n))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Discoveries (RndState n)
 -&gt; SqlPersistT IO (Discoveries (RndState n)))
-&gt; Discoveries (RndState n)
-&gt; SqlPersistT IO (Discoveries (RndState n))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map DerivationPath (Address, AddressState)
-&gt; Discoveries (RndState n)
forall (n :: NetworkDiscriminant).
Map DerivationPath (Address, AddressState)
-&gt; Discoveries (RndState n)
</span><a href="Cardano.Wallet.Address.Book.html#RndDiscoveries"><span class="hs-identifier hs-var">RndDiscoveries</span></a></span><span> </span><span class="annot"><span class="annottext">(Map DerivationPath (Address, AddressState)
 -&gt; Discoveries (RndState n))
-&gt; Map DerivationPath (Address, AddressState)
-&gt; Discoveries (RndState n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[(DerivationPath, (Address, AddressState))]
-&gt; Map DerivationPath (Address, AddressState)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[(DerivationPath, (Address, AddressState))]
</span><a href="#local-6989586621682485961"><span class="hs-identifier hs-var">addrs</span></a></span><span>
</span><span id="line-725"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-726"></span><span>        </span><span id="local-6989586621682485960"><span class="annot"><span class="annottext">assocFromEntity :: RndStateAddress
-&gt; ((Index derivationType level, Index derivationType level),
    (Address, AddressState))
</span><a href="#local-6989586621682485960"><span class="hs-identifier hs-var hs-var">assocFromEntity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndStateAddress"><span class="hs-identifier hs-type">RndStateAddress</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682485957"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485957"><span class="hs-identifier hs-var">accIx</span></a></span></span><span> </span><span id="local-6989586621682485956"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485956"><span class="hs-identifier hs-var">addrIx</span></a></span></span><span> </span><span id="local-6989586621682485955"><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682485955"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span id="local-6989586621682485954"><span class="annot"><span class="annottext">AddressState
</span><a href="#local-6989586621682485954"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-727"></span><span>            </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Index derivationType level
forall (derivationType :: DerivationType) (level :: Depth).
Word32 -&gt; Index derivationType level
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-var">W.Index</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485957"><span class="hs-identifier hs-var">accIx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Index derivationType level
forall (derivationType :: DerivationType) (level :: Depth).
Word32 -&gt; Index derivationType level
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-var">W.Index</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485956"><span class="hs-identifier hs-var">addrIx</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682485955"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AddressState
</span><a href="#local-6989586621682485954"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-728"></span><span>
</span><span id="line-729"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertRndStatePending"><span class="hs-identifier hs-type">insertRndStatePending</span></a></span><span>
</span><span id="line-730"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-731"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Random.html#DerivationPath"><span class="hs-identifier hs-type">Rnd.DerivationPath</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">W.Address</span></a></span><span>
</span><span id="line-732"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-733"></span><span id="insertRndStatePending"><span class="annot"><span class="annottext">insertRndStatePending :: WalletId -&gt; Map DerivationPath Address -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#insertRndStatePending"><span class="hs-identifier hs-var hs-var">insertRndStatePending</span></a></span></span><span> </span><span id="local-6989586621682485953"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682485953"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682485952"><span class="annot"><span class="annottext">Map DerivationPath Address
</span><a href="#local-6989586621682485952"><span class="hs-identifier hs-var">addresses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-734"></span><span>    </span><span class="annot"><span class="annottext">[Filter RndStatePendingAddress] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField RndStatePendingAddress WalletId
forall typ.
(typ ~ WalletId) =&gt;
EntityField RndStatePendingAddress typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndStatePendingAddressWalletId"><span class="hs-identifier hs-var">RndStatePendingAddressWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField RndStatePendingAddress WalletId
-&gt; WalletId -&gt; Filter RndStatePendingAddress
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682485953"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-735"></span><span>    </span><span class="annot"><span class="annottext">([RndStatePendingAddress] -&gt; SqlPersistT IO ())
-&gt; [RndStatePendingAddress] -&gt; SqlPersistT IO ()
forall record b.
PersistEntity record =&gt;
([record] -&gt; SqlPersistT IO b) -&gt; [record] -&gt; SqlPersistT IO ()
</span><a href="Cardano.DB.Sqlite.html#dbChunked"><span class="hs-identifier hs-var">dbChunked</span></a></span><span> </span><span class="annot"><span class="annottext">[RndStatePendingAddress] -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insertMany_</span></a></span><span>
</span><span id="line-736"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; Word32 -&gt; Word32 -&gt; Address -&gt; RndStatePendingAddress
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndStatePendingAddress"><span class="hs-identifier hs-var">RndStatePendingAddress</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682485953"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485949"><span class="hs-identifier hs-var">accIx</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485948"><span class="hs-identifier hs-var">addrIx</span></a></span><span> </span><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682485947"><span class="hs-identifier hs-var">addr</span></a></span><span>
</span><span id="line-737"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">W.Index</span></a></span><span> </span><span id="local-6989586621682485949"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485949"><span class="hs-identifier hs-var">accIx</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">W.Index</span></a></span><span> </span><span id="local-6989586621682485948"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485948"><span class="hs-identifier hs-var">addrIx</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621682485947"><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682485947"><span class="hs-identifier hs-var">addr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map DerivationPath Address -&gt; [(DerivationPath, Address)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.assocs</span></a></span><span> </span><span class="annot"><span class="annottext">Map DerivationPath Address
</span><a href="#local-6989586621682485952"><span class="hs-identifier hs-var">addresses</span></a></span><span>
</span><span id="line-738"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-739"></span><span>
</span><span id="line-740"></span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectRndStatePending"><span class="hs-identifier hs-type">selectRndStatePending</span></a></span><span>
</span><span id="line-741"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-742"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.Random.html#DerivationPath"><span class="hs-identifier hs-type">Rnd.DerivationPath</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">W.Address</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-743"></span><span id="selectRndStatePending"><span class="annot"><span class="annottext">selectRndStatePending :: WalletId -&gt; ReaderT SqlBackend IO (Map DerivationPath Address)
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#selectRndStatePending"><span class="hs-identifier hs-var hs-var">selectRndStatePending</span></a></span></span><span> </span><span id="local-6989586621682485946"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682485946"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-744"></span><span>    </span><span id="local-6989586621682485945"><span class="annot"><span class="annottext">[RndStatePendingAddress]
</span><a href="#local-6989586621682485945"><span class="hs-identifier hs-var">addrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Entity RndStatePendingAddress -&gt; RndStatePendingAddress)
-&gt; [Entity RndStatePendingAddress] -&gt; [RndStatePendingAddress]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Entity RndStatePendingAddress -&gt; RndStatePendingAddress
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">([Entity RndStatePendingAddress] -&gt; [RndStatePendingAddress])
-&gt; ReaderT SqlBackend IO [Entity RndStatePendingAddress]
-&gt; ReaderT SqlBackend IO [RndStatePendingAddress]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter RndStatePendingAddress]
-&gt; [SelectOpt RndStatePendingAddress]
-&gt; ReaderT SqlBackend IO [Entity RndStatePendingAddress]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-745"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField RndStatePendingAddress WalletId
forall typ.
(typ ~ WalletId) =&gt;
EntityField RndStatePendingAddress typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndStatePendingAddressWalletId"><span class="hs-identifier hs-var">RndStatePendingAddressWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField RndStatePendingAddress WalletId
-&gt; WalletId -&gt; Filter RndStatePendingAddress
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682485946"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-746"></span><span>        </span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-747"></span><span>    </span><span class="annot"><span class="annottext">Map DerivationPath Address
-&gt; ReaderT SqlBackend IO (Map DerivationPath Address)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Map DerivationPath Address
 -&gt; ReaderT SqlBackend IO (Map DerivationPath Address))
-&gt; Map DerivationPath Address
-&gt; ReaderT SqlBackend IO (Map DerivationPath Address)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[(DerivationPath, Address)] -&gt; Map DerivationPath Address
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(DerivationPath, Address)] -&gt; Map DerivationPath Address)
-&gt; [(DerivationPath, Address)] -&gt; Map DerivationPath Address
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(RndStatePendingAddress -&gt; (DerivationPath, Address))
-&gt; [RndStatePendingAddress] -&gt; [(DerivationPath, Address)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">RndStatePendingAddress -&gt; (DerivationPath, Address)
forall (derivationType :: DerivationType) (level :: Depth)
       (derivationType :: DerivationType) (level :: Depth).
RndStatePendingAddress
-&gt; ((Index derivationType level, Index derivationType level),
    Address)
</span><a href="#local-6989586621682485944"><span class="hs-identifier hs-var">assocFromEntity</span></a></span><span> </span><span class="annot"><span class="annottext">[RndStatePendingAddress]
</span><a href="#local-6989586621682485945"><span class="hs-identifier hs-var">addrs</span></a></span><span>
</span><span id="line-748"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-749"></span><span>    </span><span id="local-6989586621682485944"><span class="annot"><span class="annottext">assocFromEntity :: RndStatePendingAddress
-&gt; ((Index derivationType level, Index derivationType level),
    Address)
</span><a href="#local-6989586621682485944"><span class="hs-identifier hs-var hs-var">assocFromEntity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RndStatePendingAddress"><span class="hs-identifier hs-type">RndStatePendingAddress</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682485943"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485943"><span class="hs-identifier hs-var">accIx</span></a></span></span><span> </span><span id="local-6989586621682485942"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485942"><span class="hs-identifier hs-var">addrIx</span></a></span></span><span> </span><span id="local-6989586621682485941"><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682485941"><span class="hs-identifier hs-var">addr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-750"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Index derivationType level
forall (derivationType :: DerivationType) (level :: Depth).
Word32 -&gt; Index derivationType level
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-var">W.Index</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485943"><span class="hs-identifier hs-var">accIx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Index derivationType level
forall (derivationType :: DerivationType) (level :: Depth).
Word32 -&gt; Index derivationType level
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-var">W.Index</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682485942"><span class="hs-identifier hs-var">addrIx</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682485941"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-751"></span></pre></body></html>