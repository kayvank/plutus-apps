<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DerivingVia #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-comment">-- | Module for `DelegationState`.</span><span>
</span><span id="line-14"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Cardano.Wallet.Primitive.Delegation.State</span><span>
</span><span id="line-15"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Creation</span></span><span>
</span><span id="line-16"></span><span>      </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier">DelegationState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#initialDelegationState"><span class="hs-identifier">initialDelegationState</span></a></span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Operations</span></span><span>
</span><span id="line-20"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#presentableKeys"><span class="hs-identifier">presentableKeys</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#usableKeys"><span class="hs-identifier">usableKeys</span></a></span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#activeKeys"><span class="hs-identifier">activeKeys</span></a></span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><span class="hs-comment">-- * For Testing</span></span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#keyAtIx"><span class="hs-identifier">keyAtIx</span></a></span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#lastActiveIx"><span class="hs-identifier">lastActiveIx</span></a></span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#PointerUTxO"><span class="hs-identifier">PointerUTxO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#State"><span class="hs-identifier">State</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Key0Status"><span class="hs-identifier">Key0Status</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Chain following model</span></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier">Tx</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Cert"><span class="hs-identifier">Cert</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#applyTx"><span class="hs-identifier">applyTx</span></a></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#setPortfolioOf"><span class="hs-identifier">setPortfolioOf</span></a></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Prelude</span></a></span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier">Cardano.Crypto.Wallet</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier">XPub</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html"><span class="hs-identifier">Cardano.Wallet.Primitive.AddressDerivation</span></a></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Depth"><span class="hs-identifier">Depth</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#DerivationType"><span class="hs-identifier">DerivationType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier">Index</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#MkKeyFingerprint"><span class="hs-identifier">MkKeyFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#paymentKeyFingerprint"><span class="hs-identifier">paymentKeyFingerprint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Role"><span class="hs-identifier">Role</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#SoftDerivation"><span class="hs-identifier">SoftDerivation</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#ToRewardAccount"><span class="hs-identifier">ToRewardAccount</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.Address</span></a></span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier">Address</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Coin.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.Coin</span></a></span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Coin.html#Coin"><span class="hs-identifier">Coin</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Hash.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.Hash</span></a></span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Hash.html#Hash"><span class="hs-identifier">Hash</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.RewardAccount.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.RewardAccount</span></a></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.RewardAccount.html#RewardAccount"><span class="hs-identifier">RewardAccount</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.Tx</span></a></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxIn"><span class="hs-identifier">TxIn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxOut"><span class="hs-identifier">TxOut</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier">Control.DeepSeq</span></a></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier">NFData</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">maybeToList</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../quiet/html/src"><span class="hs-identifier">Quiet</span></a></span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../quiet/html/src"><span class="hs-identifier">Quiet</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.TokenBundle.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.TokenBundle</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TB</span></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- Delegation State</span><span>
</span><span id="line-75"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-comment">-- | Delegation state</span><span>
</span><span id="line-78"></span><span class="hs-comment">--</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- === Goals</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- 1. Allow a wallet to have an arbitrary number of stake keys</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- 2. Ensure those stake keys can be automatically discovered on-chain</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- 3. Ensure the wallet is always aware of all stake keys it registers, even in</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- the case of concurrent user actions on multiple wallet instances, and old</span><span>
</span><span id="line-84"></span><span class="hs-comment">-- wallet software.</span><span>
</span><span id="line-85"></span><span class="hs-comment">--</span><span>
</span><span id="line-86"></span><span class="hs-comment">--</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- === How</span><span>
</span><span id="line-88"></span><span class="hs-comment">--</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- We track a consecutive range of keys that is extended with delegation of the</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- next unused key, and shrunk with key de-registration. We use a `PointerUTxO`</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- to ensure that transactions changing the state can't be accepted to the</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- ledger in any other order than intended. We also need some special care</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- regarding stake key 0, which old wallet software could try to de-register.</span><span>
</span><span id="line-94"></span><span class="hs-comment">--</span><span>
</span><span id="line-95"></span><span class="hs-comment">-- === Diagram</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- Diagram of states, where the list denotes active (registered /and/ delegating)</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- keys.</span><span>
</span><span id="line-98"></span><span class="hs-comment">--</span><span>
</span><span id="line-99"></span><span class="hs-comment">-- Here we assume the minUTxOValue is 1 ada.</span><span>
</span><span id="line-100"></span><span class="hs-comment">--</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- Note that intermediate steps for the `PointerUTxO` should be skipped within a</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- transaction.</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- E.g. to transition from [] to [0,1,2] we should deposit 1 ada to key 3,</span><span>
</span><span id="line-104"></span><span class="hs-comment">-- skipping key 2.</span><span>
</span><span id="line-105"></span><span class="hs-comment">--</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- See the implementation of `setPortfolioOf` and `applyTx` for more details.</span><span>
</span><span id="line-107"></span><span class="hs-comment">--</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- &#9484;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9488;           &#9484;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9488;                     &#9484;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9488;            &#9484;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9488;</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- &#9474;                    &#9474;           &#9474;                    &#9474;                     &#9474;                    &#9474;            &#9474;                     &#9474;</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- &#9474;                    &#9474;           &#9474;                    &#9474;       Pointer       &#9474;                    &#9474;            &#9474;                     &#9474;</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- &#9474;                    &#9474;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9654;&#9474;                    &#9474; &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;deposit&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9654;&#9474;                    &#9474; &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9654; &#9474;                     &#9474; &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9654;</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- &#9474;                    &#9474;           &#9474;                    &#9474;                     &#9474;       [0,1]        &#9474;            &#9474;       [0,1,2]       &#9474;</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- &#9474;         []         &#9474;           &#9474;        [0]         &#9474;                     &#9474;1 ada held by key 2 &#9474;            &#9474; 1 ada held by key 3 &#9474;</span><span>
</span><span id="line-115"></span><span class="hs-comment">-- &#9474;                    &#9474;           &#9474;                    &#9474;                     &#9474;                    &#9474;            &#9474;                     &#9474;</span><span>
</span><span id="line-116"></span><span class="hs-comment">-- &#9474;                    &#9474;           &#9474;                    &#9474;       Pointer       &#9474;                    &#9474;            &#9474;                     &#9474;</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- &#9474;                    &#9474;&#9664;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9474;                    &#9474; &#9664;&#9472;&#9472;&#9472;&#9472;&#9472;deposit &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9474;                    &#9474;&#9664;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472; &#9474;                     &#9474;&#9664;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</span><span>
</span><span id="line-118"></span><span class="hs-comment">-- &#9474;                    &#9474;           &#9474;                    &#9474;       returned      &#9474;                    &#9474;            &#9474;                     &#9474;</span><span>
</span><span id="line-119"></span><span class="hs-comment">-- &#9492;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9496;&#9664;&#9472;&#9472;&#9488;       &#9492;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9496;                     &#9492;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9650;            &#9650;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9650;            &#9650;</span><span>
</span><span id="line-120"></span><span class="hs-comment">--                          &#9492;&#9472;&#9472;&#9472;&#9488;                                                     &#9474;       &#9650;     &#9492;&#9472;&#9488;         &#9484;&#9496;      &#9474;       &#9650;      &#9492;&#9472;&#9488;         &#9484;&#9496;</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- Normal states                &#9492;&#9472;&#9472;&#9472;&#9488;                                                 &#9474;       &#9474;       &#9492;&#9472;&#9488;     &#9484;&#9472;&#9496;       &#9474;       &#9474;        &#9492;&#9472;&#9488;     &#9484;&#9472;&#9496;</span><span>
</span><span id="line-122"></span><span class="hs-comment">--                                  &#9492;&#9472;&#9472;&#9472;&#9488;                                             &#9474;       &#9474;         &#9492;&#9472;&#9488; &#9484;&#9472;&#9496;         &#9474;       &#9474;          &#9492;&#9472;&#9488; &#9484;&#9472;&#9496;</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- &#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9492;&#9472;&#9472;&#9472;&#9488;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9474;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9474;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9474; &#9474;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9474;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9474;&#9587;&#9587;&#9587;&#9587;&#9587;&#9587;&#9654;     &#9500;&#9472;&#9508;</span><span>
</span><span id="line-124"></span><span class="hs-comment">--                                          &#9492;&#9472;&#9472;&#9472;&#9488;                                     &#9474;       &#9474;         &#9484;&#9472;&#9496; &#9492;&#9472;&#9488;         &#9474;       &#9474;          &#9484;&#9472;&#9496; &#9492;&#9472;&#9488;</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- States caused by                             &#9492;&#9472;&#9472;&#9472;&#9472;&#9488;Pointer                         &#9660;       &#9474;       &#9484;&#9472;&#9496;     &#9492;&#9472;&#9488;       &#9660;       &#9474;        &#9484;&#9472;&#9496;     &#9492;&#9472;&#9488;</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- old wallet                                        &#9492;deposit                  &#9484;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9488;&#9472;&#9496;         &#9492;&#9516;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9488;&#9472;&#9496;         &#9492;&#9472;</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- de-registering                                     returned&#9472;&#9488;               &#9474;                    &#9474;            &#9474;                     &#9474;</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- stake-key 0                                                 &#9492;&#9472;&#9472;&#9472;&#9472;&#9488;          &#9474;                    &#9474; &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9654; &#9474;                     &#9474; &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9654;</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- of multi-stake                                                   &#9492;&#9472;&#9472;&#9472;&#9472;&#9488;     &#9474;                    &#9474;            &#9474;                     &#9474;</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- key wallet                                                            &#9492;&#9472;&#9472;&#9472;&#9472; &#9474;        [1]         &#9474;            &#9474;        [1,2]        &#9474;</span><span>
</span><span id="line-131"></span><span class="hs-comment">--                                                                             &#9474;1 ada held by key 2 &#9474;            &#9474; 1 ada held by key 3 &#9474;</span><span>
</span><span id="line-132"></span><span class="hs-comment">--                                                                             &#9474;                    &#9474;            &#9474;                     &#9474;</span><span>
</span><span id="line-133"></span><span class="hs-comment">--                                                                             &#9474;                    &#9474;&#9664;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472; &#9474;                     &#9474;&#9664;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</span><span>
</span><span id="line-134"></span><span class="hs-comment">--                                                                             &#9474;                    &#9474;            &#9474;                     &#9474;</span><span>
</span><span id="line-135"></span><span class="hs-comment">--                                                                             &#9474;                    &#9474;            &#9474;                     &#9474;</span><span>
</span><span id="line-136"></span><span class="hs-comment">--                                                                             &#9492;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9496;            &#9492;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9496;</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-138"></span><span id="local-6989586621682433203"><span id="local-6989586621682433204"></span></span><span class="hs-keyword">data</span><span> </span><span id="DelegationState"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-var">DelegationState</span></a></span></span><span> </span><span id="local-6989586621682433316"><span class="annot"><a href="#local-6989586621682433316"><span class="hs-identifier hs-type">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DelegationState"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-var">DelegationState</span></a></span></span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | The account public key from which the stake keys should be derived.</span><span>
</span><span id="line-140"></span><span>      </span><span id="rewardAccountKey"><span class="annot"><span class="annottext">DelegationState k -&gt; k 'AccountK XPub
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#rewardAccountKey"><span class="hs-identifier hs-var hs-var">rewardAccountKey</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621682433316"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AccountK"><span class="hs-identifier hs-type">AccountK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="state"><span class="annot"><span class="annottext">DelegationState k -&gt; State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#state"><span class="hs-identifier hs-var hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#State"><span class="hs-identifier hs-type">State</span></a></span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. DelegationState k -&gt; Rep (DelegationState k) x)
-&gt; (forall x. Rep (DelegationState k) x -&gt; DelegationState k)
-&gt; Generic (DelegationState k)
forall x. Rep (DelegationState k) x -&gt; DelegationState k
forall x. DelegationState k -&gt; Rep (DelegationState k) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (k :: Depth -&gt; * -&gt; *) x.
Rep (DelegationState k) x -&gt; DelegationState k
forall (k :: Depth -&gt; * -&gt; *) x.
DelegationState k -&gt; Rep (DelegationState k) x
$cto :: forall (k :: Depth -&gt; * -&gt; *) x.
Rep (DelegationState k) x -&gt; DelegationState k
$cfrom :: forall (k :: Depth -&gt; * -&gt; *) x.
DelegationState k -&gt; Rep (DelegationState k) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="hs-comment">-- | Construct the initial delegation state.</span><span>
</span><span id="line-145"></span><span id="local-6989586621682433196"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#initialDelegationState"><span class="hs-identifier hs-type">initialDelegationState</span></a></span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621682433196"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AccountK"><span class="hs-identifier hs-type">AccountK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433196"><span class="hs-identifier hs-type">k</span></a></span></span><span>
</span><span id="line-148"></span><span id="initialDelegationState"><span class="annot"><span class="annottext">initialDelegationState :: k 'AccountK XPub -&gt; DelegationState k
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#initialDelegationState"><span class="hs-identifier hs-var hs-var">initialDelegationState</span></a></span></span><span> </span><span id="local-6989586621682433195"><span class="annot"><span class="annottext">k 'AccountK XPub
</span><a href="#local-6989586621682433195"><span class="hs-identifier hs-var">accK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">k 'AccountK XPub -&gt; State -&gt; DelegationState k
forall (k :: Depth -&gt; * -&gt; *).
k 'AccountK XPub -&gt; State -&gt; DelegationState k
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-var">DelegationState</span></a></span><span> </span><span class="annot"><span class="annottext">k 'AccountK XPub
</span><a href="#local-6989586621682433195"><span class="hs-identifier hs-var">accK</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#Zero"><span class="hs-identifier hs-var">Zero</span></a></span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span class="hs-comment">-- | The internal state, without the account key.</span><span>
</span><span id="line-151"></span><span class="hs-comment">--</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- TODO: Perhaps we should model this as</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- @S = S1 * S2, where S1 = Bool, S2 = ix * UTxOPointer@ - having two</span><span>
</span><span id="line-154"></span><span class="hs-comment">-- &quot;concurrent&quot; states tracking stake keys, where the first one is identical to</span><span>
</span><span id="line-155"></span><span class="hs-comment">-- legacy single-stake key wallets.</span><span>
</span><span id="line-156"></span><span class="hs-comment">--</span><span>
</span><span id="line-157"></span><span class="hs-comment">-- Maybe that would help simplify `applyTx` and `setPortfolioOf`...</span><span>
</span><span id="line-158"></span><span id="local-6989586621682433192"><span id="local-6989586621682433193"></span></span><span class="hs-keyword">data</span><span> </span><span id="State"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#State"><span class="hs-identifier hs-var">State</span></a></span></span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-comment">-- | No active stake keys. The initial state of a new wallet.</span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="Zero"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Zero"><span class="hs-identifier hs-var">Zero</span></a></span></span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-comment">-- | The first stake-key (index 0) is registered and either delegating or</span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-comment">-- about to be delegating.</span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="One"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#One"><span class="hs-identifier hs-var">One</span></a></span></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-comment">-- | There is more than one active stake keys. Can only be reached using</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-comment">-- wallets with support for multiple stake keys.</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="More"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#More"><span class="hs-identifier hs-var">More</span></a></span></span><span>
</span><span id="line-169"></span><span>        </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Soft"><span class="hs-identifier hs-type">Soft</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>          </span><span class="hs-comment">-- nextKeyIx - the ix of the next unused key</span><span>
</span><span id="line-171"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#PointerUTxO"><span class="hs-identifier hs-type">PointerUTxO</span></a></span><span>
</span><span id="line-172"></span><span>          </span><span class="hs-comment">-- ^ pointer utxo that need to be spent when changing state.</span><span>
</span><span id="line-173"></span><span>        </span><span class="hs-glyph">!</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Key0Status"><span class="hs-identifier hs-type">Key0Status</span></a></span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682433186"><span id="local-6989586621682433188"><span class="annot"><span class="annottext">State -&gt; State -&gt; Bool
(State -&gt; State -&gt; Bool) -&gt; (State -&gt; State -&gt; Bool) -&gt; Eq State
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: State -&gt; State -&gt; Bool
$c/= :: State -&gt; State -&gt; Bool
== :: State -&gt; State -&gt; Bool
$c== :: State -&gt; State -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682433179"><span id="local-6989586621682433181"><span id="local-6989586621682433183"><span class="annot"><span class="annottext">Int -&gt; State -&gt; ShowS
[State] -&gt; ShowS
State -&gt; String
(Int -&gt; State -&gt; ShowS)
-&gt; (State -&gt; String) -&gt; ([State] -&gt; ShowS) -&gt; Show State
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [State] -&gt; ShowS
$cshowList :: [State] -&gt; ShowS
show :: State -&gt; String
$cshow :: State -&gt; String
showsPrec :: Int -&gt; State -&gt; ShowS
$cshowsPrec :: Int -&gt; State -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. State -&gt; Rep State x)
-&gt; (forall x. Rep State x -&gt; State) -&gt; Generic State
forall x. Rep State x -&gt; State
forall x. State -&gt; Rep State x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep State x -&gt; State
$cfrom :: forall x. State -&gt; Rep State x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682433174"><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#State"><span class="hs-identifier hs-type">State</span></a></span></span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="hs-comment">-- | Is key 0 still registered? For compatibility with</span><span>
</span><span id="line-179"></span><span class="hs-comment">-- single-stake-key wallets, we need to track this.</span><span>
</span><span id="line-180"></span><span class="hs-comment">--</span><span>
</span><span id="line-181"></span><span class="hs-comment">-- &gt;&gt;&gt; activeKeys (More (toEnum 3) p ValidKey0)</span><span>
</span><span id="line-182"></span><span class="hs-comment">-- [0, 1, 2]</span><span>
</span><span id="line-183"></span><span class="hs-comment">--</span><span>
</span><span id="line-184"></span><span class="hs-comment">-- &gt;&gt;&gt; activeKeys (More (toEnum 3) p MissingKey0)</span><span>
</span><span id="line-185"></span><span class="hs-comment">-- [1, 2]</span><span>
</span><span id="line-186"></span><span class="hs-comment">--</span><span>
</span><span id="line-187"></span><span class="hs-comment">-- (pseudocode; requires a bit more boilerplate to compile)</span><span>
</span><span id="line-188"></span><span class="hs-comment">--</span><span>
</span><span id="line-189"></span><span class="hs-comment">-- See the implementation of @applyTx@ for how it is used.</span><span>
</span><span id="line-190"></span><span id="local-6989586621682433171"><span id="local-6989586621682433172"></span></span><span class="hs-keyword">data</span><span> </span><span id="Key0Status"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Key0Status"><span class="hs-identifier hs-var">Key0Status</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ValidKey0"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#ValidKey0"><span class="hs-identifier hs-var">ValidKey0</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="MissingKey0"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#MissingKey0"><span class="hs-identifier hs-var">MissingKey0</span></a></span></span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682433165"><span id="local-6989586621682433167"><span class="annot"><span class="annottext">Key0Status -&gt; Key0Status -&gt; Bool
(Key0Status -&gt; Key0Status -&gt; Bool)
-&gt; (Key0Status -&gt; Key0Status -&gt; Bool) -&gt; Eq Key0Status
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Key0Status -&gt; Key0Status -&gt; Bool
$c/= :: Key0Status -&gt; Key0Status -&gt; Bool
== :: Key0Status -&gt; Key0Status -&gt; Bool
$c== :: Key0Status -&gt; Key0Status -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682433159"><span id="local-6989586621682433161"><span id="local-6989586621682433163"><span class="annot"><span class="annottext">Int -&gt; Key0Status -&gt; ShowS
[Key0Status] -&gt; ShowS
Key0Status -&gt; String
(Int -&gt; Key0Status -&gt; ShowS)
-&gt; (Key0Status -&gt; String)
-&gt; ([Key0Status] -&gt; ShowS)
-&gt; Show Key0Status
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Key0Status] -&gt; ShowS
$cshowList :: [Key0Status] -&gt; ShowS
show :: Key0Status -&gt; String
$cshow :: Key0Status -&gt; String
showsPrec :: Int -&gt; Key0Status -&gt; ShowS
$cshowsPrec :: Int -&gt; Key0Status -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. Key0Status -&gt; Rep Key0Status x)
-&gt; (forall x. Rep Key0Status x -&gt; Key0Status) -&gt; Generic Key0Status
forall x. Rep Key0Status x -&gt; Key0Status
forall x. Key0Status -&gt; Rep Key0Status x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep Key0Status x -&gt; Key0Status
$cfrom :: forall x. Key0Status -&gt; Rep Key0Status x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682433155"><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Key0Status"><span class="hs-identifier hs-type">Key0Status</span></a></span></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span id="local-6989586621682433154"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682433152"><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682433154"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AccountK"><span class="hs-identifier hs-type">AccountK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682433154"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433154"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span id="local-6989586621682433145"><span id="local-6989586621682433147"><span id="local-6989586621682433149"><span id="local-6989586621682433151"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682433151"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AccountK"><span class="hs-identifier hs-type">AccountK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682433151"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433151"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span id="local-6989586621682433140"><span id="local-6989586621682433142"><span id="local-6989586621682433144"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682433144"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AccountK"><span class="hs-identifier hs-type">AccountK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682433144"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433144"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span id="local-6989586621682433256"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#keyAtIx"><span class="hs-identifier hs-type">keyAtIx</span></a></span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#SoftDerivation"><span class="hs-identifier hs-type">SoftDerivation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433256"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433256"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Soft"><span class="hs-identifier hs-type">Soft</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682433256"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span></span><span>
</span><span id="line-213"></span><span id="keyAtIx"><span class="annot"><span class="annottext">keyAtIx :: DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#keyAtIx"><span class="hs-identifier hs-var hs-var">keyAtIx</span></a></span></span><span> </span><span id="local-6989586621682433139"><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433139"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">k 'AccountK XPub
-&gt; Role -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
forall (key :: Depth -&gt; * -&gt; *).
SoftDerivation key =&gt;
key 'AccountK XPub
-&gt; Role -&gt; Index 'Soft 'AddressK -&gt; key 'AddressK XPub
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#deriveAddressPublicKey"><span class="hs-identifier hs-var">deriveAddressPublicKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DelegationState k -&gt; k 'AccountK XPub
forall (k :: Depth -&gt; * -&gt; *).
DelegationState k -&gt; k 'AccountK XPub
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#rewardAccountKey"><span class="hs-identifier hs-var hs-var">rewardAccountKey</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433139"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#MutableAccount"><span class="hs-identifier hs-var">MutableAccount</span></a></span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span id="local-6989586621682433289"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#nextKeyIx"><span class="hs-identifier hs-type">nextKeyIx</span></a></span><span>
</span><span id="line-216"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433289"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-217"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Soft"><span class="hs-identifier hs-type">Soft</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span></span><span>
</span><span id="line-218"></span><span id="nextKeyIx"><span class="annot"><span class="annottext">nextKeyIx :: DelegationState k -&gt; Index 'Soft 'AddressK
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#nextKeyIx"><span class="hs-identifier hs-var hs-var">nextKeyIx</span></a></span></span><span> </span><span id="local-6989586621682433135"><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433135"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; State
forall (k :: Depth -&gt; * -&gt; *). DelegationState k -&gt; State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#state"><span class="hs-identifier hs-var hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433135"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-219"></span><span>    </span><span class="annot"><span class="annottext">State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#Zero"><span class="hs-identifier hs-var">Zero</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
forall a. Bounded a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">minBound</span></a></span><span>
</span><span id="line-220"></span><span>    </span><span class="annot"><span class="annottext">State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#One"><span class="hs-identifier hs-var">One</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">succ</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
forall a. Bounded a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">minBound</span></a></span><span>
</span><span id="line-221"></span><span>    </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#More"><span class="hs-identifier hs-type">More</span></a></span><span> </span><span id="local-6989586621682433132"><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433132"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="annot"><span class="annottext">PointerUTxO
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Key0Status
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433132"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span id="local-6989586621682433220"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#lastActiveIx"><span class="hs-identifier hs-type">lastActiveIx</span></a></span><span>
</span><span id="line-224"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433220"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-225"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Soft"><span class="hs-identifier hs-type">Soft</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-226"></span><span id="lastActiveIx"><span class="annot"><span class="annottext">lastActiveIx :: DelegationState k -&gt; Maybe (Index 'Soft 'AddressK)
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#lastActiveIx"><span class="hs-identifier hs-var hs-var">lastActiveIx</span></a></span></span><span> </span><span id="local-6989586621682433131"><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433131"><span class="hs-identifier hs-var">s</span></a></span></span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK
forall (k :: Depth -&gt; * -&gt; *).
DelegationState k -&gt; Index 'Soft 'AddressK
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#nextKeyIx"><span class="hs-identifier hs-var">nextKeyIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433131"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
forall a. Bounded a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">minBound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Index 'Soft 'AddressK)
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Maybe (Index 'Soft 'AddressK)
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Index 'Soft 'AddressK -&gt; Maybe (Index 'Soft 'AddressK))
-&gt; Index 'Soft 'AddressK -&gt; Maybe (Index 'Soft 'AddressK)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">(Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK)
-&gt; Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK
forall (k :: Depth -&gt; * -&gt; *).
DelegationState k -&gt; Index 'Soft 'AddressK
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#nextKeyIx"><span class="hs-identifier hs-var">nextKeyIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433131"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span id="local-6989586621682433128"><span id="local-6989586621682433129"></span></span><span class="hs-keyword">data</span><span> </span><span id="PointerUTxO"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#PointerUTxO"><span class="hs-identifier hs-var">PointerUTxO</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PointerUTxO"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#PointerUTxO"><span class="hs-identifier hs-var">PointerUTxO</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="pTxIn"><span class="annot"><span class="annottext">PointerUTxO -&gt; TxIn
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#pTxIn"><span class="hs-identifier hs-var hs-var">pTxIn</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxIn"><span class="hs-identifier hs-type">TxIn</span></a></span><span class="hs-special">,</span><span> </span><span id="pCoin"><span class="annot"><span class="annottext">PointerUTxO -&gt; Coin
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#pCoin"><span class="hs-identifier hs-var hs-var">pCoin</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Coin.html#Coin"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. PointerUTxO -&gt; Rep PointerUTxO x)
-&gt; (forall x. Rep PointerUTxO x -&gt; PointerUTxO)
-&gt; Generic PointerUTxO
forall x. Rep PointerUTxO x -&gt; PointerUTxO
forall x. PointerUTxO -&gt; Rep PointerUTxO x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep PointerUTxO x -&gt; PointerUTxO
$cfrom :: forall x. PointerUTxO -&gt; Rep PointerUTxO x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682433119"><span id="local-6989586621682433121"><span class="annot"><span class="annottext">PointerUTxO -&gt; PointerUTxO -&gt; Bool
(PointerUTxO -&gt; PointerUTxO -&gt; Bool)
-&gt; (PointerUTxO -&gt; PointerUTxO -&gt; Bool) -&gt; Eq PointerUTxO
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PointerUTxO -&gt; PointerUTxO -&gt; Bool
$c/= :: PointerUTxO -&gt; PointerUTxO -&gt; Bool
== :: PointerUTxO -&gt; PointerUTxO -&gt; Bool
$c== :: PointerUTxO -&gt; PointerUTxO -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682433113"><span id="local-6989586621682433115"><span id="local-6989586621682433117"><span class="annot"><span class="annottext">Int -&gt; PointerUTxO -&gt; ShowS
[PointerUTxO] -&gt; ShowS
PointerUTxO -&gt; String
(Int -&gt; PointerUTxO -&gt; ShowS)
-&gt; (PointerUTxO -&gt; String)
-&gt; ([PointerUTxO] -&gt; ShowS)
-&gt; Show PointerUTxO
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PointerUTxO] -&gt; ShowS
$cshowList :: [PointerUTxO] -&gt; ShowS
show :: PointerUTxO -&gt; String
$cshow :: PointerUTxO -&gt; String
showsPrec :: Int -&gt; PointerUTxO -&gt; ShowS
$cshowsPrec :: Int -&gt; PointerUTxO -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span id="local-6989586621682433111"><span class="annot"><span class="annottext">PointerUTxO -&gt; ()
(PointerUTxO -&gt; ()) -&gt; NFData PointerUTxO
forall a. (a -&gt; ()) -&gt; NFData a
rnf :: PointerUTxO -&gt; ()
$crnf :: PointerUTxO -&gt; ()
</span><a href="#local-6989586621682433111"><span class="hs-identifier hs-var hs-var hs-var hs-var">NFData</span></a></span></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="hs-comment">-- | Returns the index corresponding to the payment key the `PointerUTxO`</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- should be locked with for a portfolio of a given size @n@.</span><span>
</span><span id="line-236"></span><span class="hs-comment">--</span><span>
</span><span id="line-237"></span><span class="hs-comment">-- In our current implementation we require the `PointerUTxO` to be created in</span><span>
</span><span id="line-238"></span><span class="hs-comment">-- the @[0] -&gt; [0,1] transition@, i.e. @nextKeyIx 1 -&gt; nextKeyIx 2@.</span><span>
</span><span id="line-239"></span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#pointerIx"><span class="hs-identifier hs-type">pointerIx</span></a></span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Soft"><span class="hs-identifier hs-type">Soft</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span id="pointerIx"><span class="annot"><span class="annottext">pointerIx :: Int -&gt; Maybe (Index 'Soft 'AddressK)
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#pointerIx"><span class="hs-identifier hs-var hs-var">pointerIx</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Index 'Soft 'AddressK)
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-243"></span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#pointerIx"><span class="hs-identifier hs-var">pointerIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Index 'Soft 'AddressK)
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-244"></span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#pointerIx"><span class="hs-identifier hs-var">pointerIx</span></a></span><span> </span><span id="local-6989586621682433109"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682433109"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Maybe (Index 'Soft 'AddressK)
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Index 'Soft 'AddressK -&gt; Maybe (Index 'Soft 'AddressK))
-&gt; Index 'Soft 'AddressK -&gt; Maybe (Index 'Soft 'AddressK)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; Int -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toEnum</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682433109"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span class="hs-comment">-- | Retrieve the `PointerUTxO` from a `DelegationState` if it has one.</span><span>
</span><span id="line-247"></span><span id="local-6989586621682433258"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#pointer"><span class="hs-identifier hs-type">pointer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433258"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#PointerUTxO"><span class="hs-identifier hs-type">PointerUTxO</span></a></span></span><span>
</span><span id="line-248"></span><span id="pointer"><span class="annot"><span class="annottext">pointer :: DelegationState k -&gt; Maybe PointerUTxO
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#pointer"><span class="hs-identifier hs-var hs-var">pointer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><span class="annottext">k 'AccountK XPub
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#More"><span class="hs-identifier hs-type">More</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682433106"><span class="annot"><span class="annottext">PointerUTxO
</span><a href="#local-6989586621682433106"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">Key0Status
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PointerUTxO -&gt; Maybe PointerUTxO
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">PointerUTxO
</span><a href="#local-6989586621682433106"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-249"></span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#pointer"><span class="hs-identifier hs-var">pointer</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe PointerUTxO
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-252"></span><span class="hs-comment">-- Chain</span><span>
</span><span id="line-253"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span class="hs-comment">-- | A transaction type specific to `DelegationState`.</span><span>
</span><span id="line-256"></span><span class="hs-comment">--</span><span>
</span><span id="line-257"></span><span class="hs-comment">-- Intended to be converted both from and to a more real transaction type.</span><span>
</span><span id="line-258"></span><span class="hs-comment">--</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- When constructing a real transaction from `Tx`, these `outputs`</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- should appear before other outputs. In the theoretical event that there's</span><span>
</span><span id="line-261"></span><span class="hs-comment">-- also a user-specified output with the same payment key as the pointer output,</span><span>
</span><span id="line-262"></span><span class="hs-comment">-- `applyTx` will track the first one as the new pointer.</span><span>
</span><span id="line-263"></span><span id="local-6989586621682433104"><span id="local-6989586621682433105"></span></span><span class="hs-keyword">data</span><span> </span><span id="Tx"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier hs-var">Tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Tx"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier hs-var">Tx</span></a></span></span><span>
</span><span id="line-264"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="certs"><span class="annot"><span class="annottext">Tx -&gt; [Cert]
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#certs"><span class="hs-identifier hs-var hs-var">certs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Cert"><span class="hs-identifier hs-type">Cert</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="inputs"><span class="annot"><span class="annottext">Tx -&gt; [(TxIn, Coin)]
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#inputs"><span class="hs-identifier hs-var hs-var">inputs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxIn"><span class="hs-identifier hs-type">TxIn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Coin.html#Coin"><span class="hs-identifier hs-type">Coin</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-266"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="outputs"><span class="annot"><span class="annottext">Tx -&gt; [TxOut]
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#outputs"><span class="hs-identifier hs-var hs-var">outputs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxOut"><span class="hs-identifier hs-type">TxOut</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682433096"><span id="local-6989586621682433098"><span class="annot"><span class="annottext">Tx -&gt; Tx -&gt; Bool
(Tx -&gt; Tx -&gt; Bool) -&gt; (Tx -&gt; Tx -&gt; Bool) -&gt; Eq Tx
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Tx -&gt; Tx -&gt; Bool
$c/= :: Tx -&gt; Tx -&gt; Bool
== :: Tx -&gt; Tx -&gt; Bool
$c== :: Tx -&gt; Tx -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. Tx -&gt; Rep Tx x)
-&gt; (forall x. Rep Tx x -&gt; Tx) -&gt; Generic Tx
forall x. Rep Tx x -&gt; Tx
forall x. Tx -&gt; Rep Tx x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep Tx x -&gt; Tx
$cfrom :: forall x. Tx -&gt; Rep Tx x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621682433088"><span id="local-6989586621682433090"><span id="local-6989586621682433092"><span class="annot"><span class="annottext">Int -&gt; Tx -&gt; ShowS
[Tx] -&gt; ShowS
Tx -&gt; String
(Int -&gt; Tx -&gt; ShowS)
-&gt; (Tx -&gt; String) -&gt; ([Tx] -&gt; ShowS) -&gt; Show Tx
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Tx] -&gt; ShowS
$cshowList :: [Tx] -&gt; ShowS
show :: Tx -&gt; String
$cshow :: Tx -&gt; String
showsPrec :: Int -&gt; Tx -&gt; ShowS
$cshowsPrec :: Int -&gt; Tx -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../quiet/html/src"><span class="hs-identifier hs-type">Quiet</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier hs-type">Tx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682433083"><span id="local-6989586621682433085"><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Semigroup</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier hs-type">Tx</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier hs-type">Tx</span></a></span><span> </span><span id="local-6989586621682433081"><span class="annot"><span class="annottext">[Cert]
</span><a href="#local-6989586621682433081"><span class="hs-identifier hs-var">cs1</span></a></span></span><span> </span><span id="local-6989586621682433080"><span class="annot"><span class="annottext">[(TxIn, Coin)]
</span><a href="#local-6989586621682433080"><span class="hs-identifier hs-var">is1</span></a></span></span><span> </span><span id="local-6989586621682433079"><span class="annot"><span class="annottext">[TxOut]
</span><a href="#local-6989586621682433079"><span class="hs-identifier hs-var">os1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682433078"><span class="annot"><span class="annottext">&lt;&gt; :: Tx -&gt; Tx -&gt; Tx
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var hs-var hs-var hs-var">&lt;&gt;</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier hs-type">Tx</span></a></span><span> </span><span id="local-6989586621682433077"><span class="annot"><span class="annottext">[Cert]
</span><a href="#local-6989586621682433077"><span class="hs-identifier hs-var">cs2</span></a></span></span><span> </span><span id="local-6989586621682433076"><span class="annot"><span class="annottext">[(TxIn, Coin)]
</span><a href="#local-6989586621682433076"><span class="hs-identifier hs-var">is2</span></a></span></span><span> </span><span id="local-6989586621682433075"><span class="annot"><span class="annottext">[TxOut]
</span><a href="#local-6989586621682433075"><span class="hs-identifier hs-var">os2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-273"></span><span>        </span><span class="annot"><span class="annottext">[Cert] -&gt; [(TxIn, Coin)] -&gt; [TxOut] -&gt; Tx
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier hs-var">Tx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Cert]
</span><a href="#local-6989586621682433081"><span class="hs-identifier hs-var">cs1</span></a></span><span> </span><span class="annot"><span class="annottext">[Cert] -&gt; [Cert] -&gt; [Cert]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Cert]
</span><a href="#local-6989586621682433077"><span class="hs-identifier hs-var">cs2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(TxIn, Coin)]
</span><a href="#local-6989586621682433080"><span class="hs-identifier hs-var">is1</span></a></span><span> </span><span class="annot"><span class="annottext">[(TxIn, Coin)] -&gt; [(TxIn, Coin)] -&gt; [(TxIn, Coin)]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[(TxIn, Coin)]
</span><a href="#local-6989586621682433076"><span class="hs-identifier hs-var">is2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TxOut]
</span><a href="#local-6989586621682433079"><span class="hs-identifier hs-var">os1</span></a></span><span> </span><span class="annot"><span class="annottext">[TxOut] -&gt; [TxOut] -&gt; [TxOut]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TxOut]
</span><a href="#local-6989586621682433075"><span class="hs-identifier hs-var">os2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span id="local-6989586621682433073"><span id="local-6989586621682433074"></span></span><span class="hs-keyword">data</span><span> </span><span id="Cert"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Cert"><span class="hs-identifier hs-var">Cert</span></a></span></span><span>
</span><span id="line-276"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="RegisterKey"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#RegisterKey"><span class="hs-identifier hs-var">RegisterKey</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.RewardAccount.html#RewardAccount"><span class="hs-identifier hs-type">RewardAccount</span></a></span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="Delegate"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Delegate"><span class="hs-identifier hs-var">Delegate</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.RewardAccount.html#RewardAccount"><span class="hs-identifier hs-type">RewardAccount</span></a></span><span>
</span><span id="line-278"></span><span>      </span><span class="hs-comment">-- ^ Which pool we're delegating to is here (and for now) irrelevant.</span><span>
</span><span id="line-279"></span><span>      </span><span class="hs-comment">-- The main thing is that there exists a witness on-chain for this stake</span><span>
</span><span id="line-280"></span><span>      </span><span class="hs-comment">-- key (registration certs don't require witnesses)</span><span>
</span><span id="line-281"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-282"></span><span>      </span><span class="hs-comment">-- TODO: We may also want to add the PoolId here.</span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="DeRegisterKey"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DeRegisterKey"><span class="hs-identifier hs-var">DeRegisterKey</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.RewardAccount.html#RewardAccount"><span class="hs-identifier hs-type">RewardAccount</span></a></span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682433066"><span id="local-6989586621682433068"><span class="annot"><span class="annottext">Cert -&gt; Cert -&gt; Bool
(Cert -&gt; Cert -&gt; Bool) -&gt; (Cert -&gt; Cert -&gt; Bool) -&gt; Eq Cert
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Cert -&gt; Cert -&gt; Bool
$c/= :: Cert -&gt; Cert -&gt; Bool
== :: Cert -&gt; Cert -&gt; Bool
$c== :: Cert -&gt; Cert -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682433060"><span id="local-6989586621682433062"><span id="local-6989586621682433064"><span class="annot"><span class="annottext">Int -&gt; Cert -&gt; ShowS
[Cert] -&gt; ShowS
Cert -&gt; String
(Int -&gt; Cert -&gt; ShowS)
-&gt; (Cert -&gt; String) -&gt; ([Cert] -&gt; ShowS) -&gt; Show Cert
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Cert] -&gt; ShowS
$cshowList :: [Cert] -&gt; ShowS
show :: Cert -&gt; String
$cshow :: Cert -&gt; String
showsPrec :: Int -&gt; Cert -&gt; ShowS
$cshowsPrec :: Int -&gt; Cert -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. Cert -&gt; Rep Cert x)
-&gt; (forall x. Rep Cert x -&gt; Cert) -&gt; Generic Cert
forall x. Rep Cert x -&gt; Cert
forall x. Cert -&gt; Rep Cert x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep Cert x -&gt; Cert
$cfrom :: forall x. Cert -&gt; Rep Cert x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span class="hs-comment">-- | Given a `DelegationState`, produce a `Tx` registering or de-registering</span><span>
</span><span id="line-287"></span><span class="hs-comment">-- stake-keys, in order to have @n@ stake-keys.</span><span>
</span><span id="line-288"></span><span class="hs-comment">--</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- E.g. @setPortfolioOf s0 _ _ 2@ creates a tx which after application causes</span><span>
</span><span id="line-290"></span><span class="hs-comment">-- the state to have @activeKeys == [0,1]@</span><span>
</span><span id="line-291"></span><span class="hs-comment">--</span><span>
</span><span id="line-292"></span><span class="hs-comment">-- Returns @Nothing@ if the target @n@ is already reached.</span><span>
</span><span id="line-293"></span><span id="local-6989586621682433057"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#setPortfolioOf"><span class="hs-identifier hs-type">setPortfolioOf</span></a></span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#SoftDerivation"><span class="hs-identifier hs-type">SoftDerivation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433057"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#ToRewardAccount"><span class="hs-identifier hs-type">ToRewardAccount</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433057"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433057"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Coin.html#Coin"><span class="hs-identifier hs-type">Coin</span></a></span><span>
</span><span id="line-297"></span><span>        </span><span class="hs-comment">-- ^ minUTxOVal</span><span>
</span><span id="line-298"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682433057"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>        </span><span class="hs-comment">-- ^ A way to construct an Address</span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.RewardAccount.html#RewardAccount"><span class="hs-identifier hs-type">RewardAccount</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>        </span><span class="hs-comment">-- ^ Whether or not the key is registered.</span><span>
</span><span id="line-302"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-303"></span><span>        </span><span class="hs-comment">-- TODO: Need a Set or Map for the real implementation with LSQ.</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-305"></span><span>        </span><span class="hs-comment">-- ^ Target number of stake keys.</span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier hs-type">Tx</span></a></span></span><span>
</span><span id="line-307"></span><span id="setPortfolioOf"><span class="annot"><span class="annottext">setPortfolioOf :: DelegationState k
-&gt; Coin
-&gt; (k 'AddressK XPub -&gt; Address)
-&gt; (RewardAccount -&gt; Bool)
-&gt; Int
-&gt; Maybe Tx
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#setPortfolioOf"><span class="hs-identifier hs-var hs-var">setPortfolioOf</span></a></span></span><span> </span><span id="local-6989586621682433056"><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433056"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span id="local-6989586621682433055"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621682433055"><span class="hs-identifier hs-var">minUTxOVal</span></a></span></span><span> </span><span id="local-6989586621682433054"><span class="annot"><span class="annottext">k 'AddressK XPub -&gt; Address
</span><a href="#local-6989586621682433054"><span class="hs-identifier hs-var">mkAddress</span></a></span></span><span> </span><span id="local-6989586621682433053"><span class="annot"><span class="annottext">RewardAccount -&gt; Bool
</span><a href="#local-6989586621682433053"><span class="hs-identifier hs-var">isReg</span></a></span></span><span> </span><span id="local-6989586621682433052"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682433052"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-308"></span><span>    </span><span class="annot"><span class="annottext">Maybe Tx
</span><a href="#local-6989586621682433051"><span class="hs-identifier hs-var">repairKey0IfNeededTx</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Tx -&gt; Maybe Tx -&gt; Maybe Tx
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Tx
</span><a href="#local-6989586621682433050"><span class="hs-identifier hs-var">changeStateTx</span></a></span><span>
</span><span id="line-309"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-comment">-- The `changeStateTx` calculation assumes that key 0 is registered. If it</span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-comment">-- is not, we fix it here.</span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-comment">-- At some point we will need to take a `Set PoolId` instead of `n`. If</span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-comment">-- we're in the state of key 1 and 2 delegating to pools B and C</span><span>
</span><span id="line-315"></span><span>    </span><span class="hs-comment">-- respectively, we likely want:</span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-comment">-- - `setPortfolio [A,B,C]` to delegate key 0 to A, instead of key 3.</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-comment">-- - `setPortfolio [B,C]` to replace key 2 with key 0</span><span>
</span><span id="line-318"></span><span>    </span><span class="annot"><a href="#local-6989586621682433051"><span class="hs-identifier hs-type">repairKey0IfNeededTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier hs-type">Tx</span></a></span><span>
</span><span id="line-319"></span><span>    </span><span id="local-6989586621682433051"><span class="annot"><span class="annottext">repairKey0IfNeededTx :: Maybe Tx
</span><a href="#local-6989586621682433051"><span class="hs-identifier hs-var hs-var">repairKey0IfNeededTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">State -&gt; [Cert]
</span><a href="#local-6989586621682433049"><span class="hs-identifier hs-var">repairKey0</span></a></span><span> </span><span class="annot"><span class="annottext">(State -&gt; [Cert]) -&gt; State -&gt; [Cert]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; State
forall (k :: Depth -&gt; * -&gt; *). DelegationState k -&gt; State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#state"><span class="hs-identifier hs-var hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433056"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-320"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Tx
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-321"></span><span>        </span><span id="local-6989586621682433048"><span class="annot"><span class="annottext">[Cert]
</span><a href="#local-6989586621682433048"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tx -&gt; Maybe Tx
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Tx -&gt; Maybe Tx) -&gt; Tx -&gt; Maybe Tx
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Cert] -&gt; [(TxIn, Coin)] -&gt; [TxOut] -&gt; Tx
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier hs-var">Tx</span></a></span><span> </span><span class="annot"><span class="annottext">[Cert]
</span><a href="#local-6989586621682433048"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-322"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-323"></span><span>        </span><span id="local-6989586621682433049"><span class="annot"><span class="annottext">repairKey0 :: State -&gt; [Cert]
</span><a href="#local-6989586621682433049"><span class="hs-identifier hs-var hs-var">repairKey0</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#More"><span class="hs-identifier hs-type">More</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PointerUTxO
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Key0Status
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#MissingKey0"><span class="hs-identifier hs-var">MissingKey0</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682433052"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Index 'Soft 'AddressK] -&gt; [Cert]
</span><a href="#local-6989586621682433046"><span class="hs-identifier hs-var">deleg</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
forall a. Bounded a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">minBound</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-324"></span><span>        </span><span class="annot"><a href="#local-6989586621682433049"><span class="hs-identifier hs-var">repairKey0</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><a href="#local-6989586621682433050"><span class="hs-identifier hs-type">changeStateTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier hs-type">Tx</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span id="local-6989586621682433050"><span class="annot"><span class="annottext">changeStateTx :: Maybe Tx
</span><a href="#local-6989586621682433050"><span class="hs-identifier hs-var hs-var">changeStateTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Cert] -&gt; Maybe Tx
</span><a href="#local-6989586621682433045"><span class="hs-identifier hs-var">txWithCerts</span></a></span><span> </span><span class="annot"><span class="annottext">([Cert] -&gt; Maybe Tx) -&gt; [Cert] -&gt; Maybe Tx
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">compare</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; Int -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toEnum</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682433052"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK
forall (k :: Depth -&gt; * -&gt; *).
DelegationState k -&gt; Index 'Soft 'AddressK
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#nextKeyIx"><span class="hs-identifier hs-var">nextKeyIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433056"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-328"></span><span>        </span><span class="annot"><span class="annottext">Ordering
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">GT</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Index 'Soft 'AddressK] -&gt; [Cert]
</span><a href="#local-6989586621682433046"><span class="hs-identifier hs-var">deleg</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK
forall (k :: Depth -&gt; * -&gt; *).
DelegationState k -&gt; Index 'Soft 'AddressK
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#nextKeyIx"><span class="hs-identifier hs-var">nextKeyIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433056"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; Int -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toEnum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682433052"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-329"></span><span>        </span><span class="annot"><span class="annottext">Ordering
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">EQ</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-330"></span><span>        </span><span class="annot"><span class="annottext">Ordering
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">LT</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Index 'Soft 'AddressK] -&gt; [Cert]
</span><a href="#local-6989586621682433043"><span class="hs-identifier hs-var">dereg</span></a></span><span> </span><span class="annot"><span class="annottext">([Index 'Soft 'AddressK] -&gt; [Cert])
-&gt; [Index 'Soft 'AddressK] -&gt; [Cert]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Index 'Soft 'AddressK] -&gt; [Index 'Soft 'AddressK]
forall a. [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; Int -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toEnum</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682433052"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">(Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK)
-&gt; Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK
forall (k :: Depth -&gt; * -&gt; *).
DelegationState k -&gt; Index 'Soft 'AddressK
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#nextKeyIx"><span class="hs-identifier hs-var">nextKeyIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433056"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-333"></span><span>        </span><span id="local-6989586621682433045"><span class="annot"><span class="annottext">txWithCerts :: [Cert] -&gt; Maybe Tx
</span><a href="#local-6989586621682433045"><span class="hs-identifier hs-var hs-var">txWithCerts</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Tx
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-334"></span><span>        </span><span class="annot"><a href="#local-6989586621682433045"><span class="hs-identifier hs-var">txWithCerts</span></a></span><span> </span><span id="local-6989586621682433041"><span class="annot"><span class="annottext">[Cert]
</span><a href="#local-6989586621682433041"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tx -&gt; Maybe Tx
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Tx -&gt; Maybe Tx) -&gt; Tx -&gt; Maybe Tx
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tx :: [Cert] -&gt; [(TxIn, Coin)] -&gt; [TxOut] -&gt; Tx
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier hs-type">Tx</span></a></span><span>
</span><span id="line-335"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">certs :: [Cert]
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#certs"><span class="hs-identifier hs-var">certs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Cert]
</span><a href="#local-6989586621682433041"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-336"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inputs :: [(TxIn, Coin)]
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#inputs"><span class="hs-identifier hs-var">inputs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (TxIn, Coin) -&gt; [(TxIn, Coin)]
forall a. Maybe a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybeToList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PointerUTxO -&gt; (TxIn, Coin)
</span><a href="#local-6989586621682433040"><span class="hs-identifier hs-var">mkTxIn</span></a></span><span> </span><span class="annot"><span class="annottext">(PointerUTxO -&gt; (TxIn, Coin))
-&gt; Maybe PointerUTxO -&gt; Maybe (TxIn, Coin)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Maybe PointerUTxO
forall (k :: Depth -&gt; * -&gt; *).
DelegationState k -&gt; Maybe PointerUTxO
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#pointer"><span class="hs-identifier hs-var">pointer</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433056"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">outputs :: [TxOut]
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#outputs"><span class="hs-identifier hs-var">outputs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe TxOut -&gt; [TxOut]
forall a. Maybe a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybeToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe TxOut -&gt; [TxOut]) -&gt; Maybe TxOut -&gt; [TxOut]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-338"></span><span>                </span><span class="hs-comment">-- Note that this is the only place where we move the pointer.</span><span>
</span><span id="line-339"></span><span>                </span><span class="hs-comment">-- I.e. repairKey0IfNeededTx won't do it on its own.</span><span>
</span><span id="line-340"></span><span>                </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682433038"><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433038"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Address -&gt; TokenBundle -&gt; TxOut
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxOut"><span class="hs-identifier hs-var">TxOut</span></a></span><span>
</span><span id="line-341"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">k 'AddressK XPub -&gt; Address
</span><a href="#local-6989586621682433054"><span class="hs-identifier hs-var">mkAddress</span></a></span><span> </span><span class="annot"><span class="annottext">(k 'AddressK XPub -&gt; Address) -&gt; k 'AddressK XPub -&gt; Address
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
forall (k :: Depth -&gt; * -&gt; *).
SoftDerivation k =&gt;
DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#keyAtIx"><span class="hs-identifier hs-var">keyAtIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433056"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433038"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin -&gt; TokenBundle
</span><a href="Cardano.Wallet.Primitive.Types.TokenBundle.html#fromCoin"><span class="hs-identifier hs-var">TB.fromCoin</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621682433055"><span class="hs-identifier hs-var">minUTxOVal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>                </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Index 'Soft 'AddressK -&gt; TxOut)
-&gt; Maybe (Index 'Soft 'AddressK) -&gt; Maybe TxOut
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe (Index 'Soft 'AddressK)
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#pointerIx"><span class="hs-identifier hs-var">pointerIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682433052"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-344"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-345"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-346"></span><span>            </span><span id="local-6989586621682433040"><span class="annot"><span class="annottext">mkTxIn :: PointerUTxO -&gt; (TxIn, Coin)
</span><a href="#local-6989586621682433040"><span class="hs-identifier hs-var hs-var">mkTxIn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#PointerUTxO"><span class="hs-identifier hs-type">PointerUTxO</span></a></span><span> </span><span id="local-6989586621682433035"><span class="annot"><span class="annottext">TxIn
</span><a href="#local-6989586621682433035"><span class="hs-identifier hs-var">txIx</span></a></span></span><span> </span><span id="local-6989586621682433034"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621682433034"><span class="hs-identifier hs-var">coin</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxIn
</span><a href="#local-6989586621682433035"><span class="hs-identifier hs-var">txIx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621682433034"><span class="hs-identifier hs-var">coin</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>            </span><span class="hs-comment">-- Note: If c &gt; minUTxOVal we need to rely on the wallet to return the</span><span>
</span><span id="line-348"></span><span>            </span><span class="hs-comment">-- difference to the user as change.</span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span>    </span><span class="annot"><a href="#local-6989586621682433046"><span class="hs-identifier hs-type">deleg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Soft"><span class="hs-identifier hs-type">Soft</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Cert"><span class="hs-identifier hs-type">Cert</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-351"></span><span>    </span><span id="local-6989586621682433046"><span class="annot"><span class="annottext">deleg :: [Index 'Soft 'AddressK] -&gt; [Cert]
</span><a href="#local-6989586621682433046"><span class="hs-identifier hs-var hs-var">deleg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Index 'Soft 'AddressK]
-&gt; (Index 'Soft 'AddressK -&gt; [Cert]) -&gt; [Cert]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682433033"><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433033"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-352"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">RewardAccount -&gt; Bool
</span><a href="#local-6989586621682433053"><span class="hs-identifier hs-var">isReg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; RewardAccount
</span><a href="#local-6989586621682433032"><span class="hs-identifier hs-var">acct</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433033"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">RewardAccount -&gt; Cert
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#Delegate"><span class="hs-identifier hs-var">Delegate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; RewardAccount
</span><a href="#local-6989586621682433032"><span class="hs-identifier hs-var">acct</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433033"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-354"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">RewardAccount -&gt; Cert
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#RegisterKey"><span class="hs-identifier hs-var">RegisterKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; RewardAccount
</span><a href="#local-6989586621682433032"><span class="hs-identifier hs-var">acct</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433033"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>  </span><span class="annot"><span class="annottext">RewardAccount -&gt; Cert
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#Delegate"><span class="hs-identifier hs-var">Delegate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; RewardAccount
</span><a href="#local-6989586621682433032"><span class="hs-identifier hs-var">acct</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433033"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-355"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span>
</span><span id="line-358"></span><span>    </span><span class="annot"><a href="#local-6989586621682433043"><span class="hs-identifier hs-type">dereg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Soft"><span class="hs-identifier hs-type">Soft</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Cert"><span class="hs-identifier hs-type">Cert</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-359"></span><span>    </span><span id="local-6989586621682433043"><span class="annot"><span class="annottext">dereg :: [Index 'Soft 'AddressK] -&gt; [Cert]
</span><a href="#local-6989586621682433043"><span class="hs-identifier hs-var hs-var">dereg</span></a></span></span><span> </span><span id="local-6989586621682433031"><span class="annot"><span class="annottext">[Index 'Soft 'AddressK]
</span><a href="#local-6989586621682433031"><span class="hs-identifier hs-var">ixs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-360"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">RewardAccount -&gt; Cert
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#DeRegisterKey"><span class="hs-identifier hs-var">DeRegisterKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; RewardAccount
</span><a href="#local-6989586621682433032"><span class="hs-identifier hs-var">acct</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433030"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682433030"><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433030"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Index 'Soft 'AddressK]
</span><a href="#local-6989586621682433031"><span class="hs-identifier hs-var">ixs</span></a></span><span>
</span><span id="line-362"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewardAccount -&gt; Bool
</span><a href="#local-6989586621682433053"><span class="hs-identifier hs-var">isReg</span></a></span><span> </span><span class="annot"><span class="annottext">(RewardAccount -&gt; Bool)
-&gt; (Index 'Soft 'AddressK -&gt; RewardAccount)
-&gt; Index 'Soft 'AddressK
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; RewardAccount
</span><a href="#local-6989586621682433032"><span class="hs-identifier hs-var">acct</span></a></span><span> </span><span class="annot"><span class="annottext">(Index 'Soft 'AddressK -&gt; Bool) -&gt; Index 'Soft 'AddressK -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433030"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-363"></span><span>        </span><span class="hs-comment">-- We need to /at least/ check @isReg (key 0)@, because the user could</span><span>
</span><span id="line-364"></span><span>        </span><span class="hs-comment">-- have deregistered it using old wallet software.</span><span>
</span><span id="line-365"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span>    </span><span id="local-6989586621682433032"><span class="annot"><span class="annottext">acct :: Index 'Soft 'AddressK -&gt; RewardAccount
</span><a href="#local-6989586621682433032"><span class="hs-identifier hs-var hs-var">acct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">k 'AddressK XPub -&gt; RewardAccount
forall (k :: Depth -&gt; * -&gt; *).
ToRewardAccount k =&gt;
k 'AddressK XPub -&gt; RewardAccount
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#toRewardAccount"><span class="hs-identifier hs-var">toRewardAccount</span></a></span><span> </span><span class="annot"><span class="annottext">(k 'AddressK XPub -&gt; RewardAccount)
-&gt; (Index 'Soft 'AddressK -&gt; k 'AddressK XPub)
-&gt; Index 'Soft 'AddressK
-&gt; RewardAccount
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
forall (k :: Depth -&gt; * -&gt; *).
SoftDerivation k =&gt;
DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#keyAtIx"><span class="hs-identifier hs-var">keyAtIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433056"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span class="hs-comment">-- | Apply a `Tx` to a `DelegationState`.</span><span>
</span><span id="line-370"></span><span class="hs-comment">--</span><span>
</span><span id="line-371"></span><span class="hs-comment">-- Expects the @PointerUTxO@ to be correctly managed, and will panic otherwise.</span><span>
</span><span id="line-372"></span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#applyTx"><span class="hs-identifier hs-type">applyTx</span></a></span><span>
</span><span id="line-373"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682433027"><span class="annot"><a href="#local-6989586621682433027"><span class="hs-identifier hs-type">k</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#SoftDerivation"><span class="hs-identifier hs-type">SoftDerivation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433027"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-374"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#ToRewardAccount"><span class="hs-identifier hs-type">ToRewardAccount</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433027"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-375"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#MkKeyFingerprint"><span class="hs-identifier hs-type">MkKeyFingerprint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433027"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a></span><span>
</span><span id="line-376"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#MkKeyFingerprint"><span class="hs-identifier hs-type">MkKeyFingerprint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433027"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682433027"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier hs-type">Tx</span></a></span><span>
</span><span id="line-378"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Hash.html#Hash"><span class="hs-identifier hs-type">Hash</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Tx&quot;</span></span><span>
</span><span id="line-379"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433027"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-380"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433027"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-381"></span><span id="applyTx"><span class="annot"><span class="annottext">applyTx :: Tx -&gt; Hash &quot;Tx&quot; -&gt; DelegationState k -&gt; DelegationState k
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#applyTx"><span class="hs-identifier hs-var hs-var">applyTx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Tx"><span class="hs-identifier hs-type">Tx</span></a></span><span> </span><span id="local-6989586621682433026"><span class="annot"><span class="annottext">[Cert]
</span><a href="#local-6989586621682433026"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621682433025"><span class="annot"><span class="annottext">[(TxIn, Coin)]
</span><a href="#local-6989586621682433025"><span class="hs-identifier hs-var">_ins</span></a></span></span><span> </span><span id="local-6989586621682433024"><span class="annot"><span class="annottext">[TxOut]
</span><a href="#local-6989586621682433024"><span class="hs-identifier hs-var">outs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682433023"><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682433023"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621682433022"><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433022"><span class="hs-identifier hs-var">ds0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DelegationState k -&gt; Cert -&gt; DelegationState k)
-&gt; DelegationState k -&gt; [Cert] -&gt; DelegationState k
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldl</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Cert -&gt; DelegationState k
</span><a href="#local-6989586621682433020"><span class="hs-identifier hs-var">applyCert</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433022"><span class="hs-identifier hs-var">ds0</span></a></span><span> </span><span class="annot"><span class="annottext">[Cert]
</span><a href="#local-6989586621682433026"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-382"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-383"></span><span>    </span><span id="local-6989586621682433020"><span class="annot"><span class="annottext">applyCert :: DelegationState k -&gt; Cert -&gt; DelegationState k
</span><a href="#local-6989586621682433020"><span class="hs-identifier hs-var hs-var">applyCert</span></a></span></span><span> </span><span id="local-6989586621682433019"><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433019"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span id="local-6989586621682433018"><span class="annot"><span class="annottext">Cert
</span><a href="#local-6989586621682433018"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((State -&gt; State) -&gt; DelegationState k -&gt; DelegationState k)
-&gt; DelegationState k -&gt; (State -&gt; State) -&gt; DelegationState k
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">(State -&gt; State) -&gt; DelegationState k -&gt; DelegationState k
</span><a href="#local-6989586621682433016"><span class="hs-identifier hs-var">modifyState</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433019"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">((State -&gt; State) -&gt; DelegationState k)
-&gt; (State -&gt; State) -&gt; DelegationState k
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Cert
</span><a href="#local-6989586621682433018"><span class="hs-identifier hs-var">cert</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-384"></span><span>            </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#RegisterKey"><span class="hs-identifier hs-type">RegisterKey</span></a></span><span> </span><span class="annot"><span class="annottext">RewardAccount
</span><span class="hs-identifier">_</span></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State -&gt; State
forall a. a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-385"></span><span>            </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Delegate"><span class="hs-identifier hs-type">Delegate</span></a></span><span> </span><span id="local-6989586621682433014"><span class="annot"><span class="annottext">RewardAccount
</span><a href="#local-6989586621682433014"><span class="hs-identifier hs-var">k</span></a></span></span><span>
</span><span id="line-386"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">RewardAccount
</span><a href="#local-6989586621682433014"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">RewardAccount -&gt; RewardAccount -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; RewardAccount
forall (k :: Depth -&gt; * -&gt; *).
(ToRewardAccount k, SoftDerivation k) =&gt;
DelegationState k -&gt; RewardAccount
</span><a href="#local-6989586621682433013"><span class="hs-identifier hs-var">nextKey</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433019"><span class="hs-identifier hs-var">ds</span></a></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State -&gt; State
</span><a href="#local-6989586621682433012"><span class="hs-identifier hs-var">inc</span></a></span><span>
</span><span id="line-387"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Cert -&gt; State -&gt; State
</span><a href="#local-6989586621682433011"><span class="hs-identifier hs-var">modifyKey0</span></a></span><span> </span><span class="annot"><span class="annottext">Cert
</span><a href="#local-6989586621682433018"><span class="hs-identifier hs-var">cert</span></a></span><span>
</span><span id="line-388"></span><span>            </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DeRegisterKey"><span class="hs-identifier hs-type">DeRegisterKey</span></a></span><span> </span><span id="local-6989586621682433010"><span class="annot"><span class="annottext">RewardAccount
</span><a href="#local-6989586621682433010"><span class="hs-identifier hs-var">k</span></a></span></span><span>
</span><span id="line-389"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">RewardAccount -&gt; Maybe RewardAccount
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">RewardAccount
</span><a href="#local-6989586621682433010"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe RewardAccount -&gt; Maybe RewardAccount -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Maybe RewardAccount
forall (k :: Depth -&gt; * -&gt; *).
(ToRewardAccount k, SoftDerivation k) =&gt;
DelegationState k -&gt; Maybe RewardAccount
</span><a href="#local-6989586621682433009"><span class="hs-identifier hs-var">lastActiveKey</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433019"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State -&gt; State
</span><a href="#local-6989586621682433008"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-390"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Cert -&gt; State -&gt; State
</span><a href="#local-6989586621682433011"><span class="hs-identifier hs-var">modifyKey0</span></a></span><span> </span><span class="annot"><span class="annottext">Cert
</span><a href="#local-6989586621682433018"><span class="hs-identifier hs-var">cert</span></a></span><span>
</span><span id="line-391"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-392"></span><span>        </span><span id="local-6989586621682433012"><span class="annot"><span class="annottext">inc :: State -&gt; State
</span><a href="#local-6989586621682433012"><span class="hs-identifier hs-var hs-var">inc</span></a></span></span><span> </span><span id="local-6989586621682433007"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621682433007"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621682433007"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-393"></span><span>            </span><span class="annot"><span class="annottext">State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#Zero"><span class="hs-identifier hs-var">Zero</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#One"><span class="hs-identifier hs-var">One</span></a></span><span>
</span><span id="line-394"></span><span>            </span><span class="annot"><span class="annottext">State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#One"><span class="hs-identifier hs-var">One</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; PointerUTxO -&gt; Key0Status -&gt; State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#More"><span class="hs-identifier hs-var">More</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; Int -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toEnum</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; PointerUTxO
</span><a href="#local-6989586621682433006"><span class="hs-identifier hs-var">findOut</span></a></span><span> </span><span class="annot"><span class="annottext">(Index 'Soft 'AddressK -&gt; PointerUTxO)
-&gt; Index 'Soft 'AddressK -&gt; PointerUTxO
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; Int -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toEnum</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Key0Status
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#ValidKey0"><span class="hs-identifier hs-var">ValidKey0</span></a></span><span>
</span><span id="line-395"></span><span>            </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#More"><span class="hs-identifier hs-type">More</span></a></span><span> </span><span id="local-6989586621682433005"><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433005"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="annot"><span class="annottext">PointerUTxO
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682433004"><span class="annot"><span class="annottext">Key0Status
</span><a href="#local-6989586621682433004"><span class="hs-identifier hs-var">is0Reg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682433003"><span class="annot"><span class="annottext">ix' :: Index 'Soft 'AddressK
</span><a href="#local-6989586621682433003"><span class="hs-identifier hs-var hs-var">ix'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">succ</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433005"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; PointerUTxO -&gt; Key0Status -&gt; State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#More"><span class="hs-identifier hs-var">More</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433003"><span class="hs-identifier hs-var">ix'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; PointerUTxO
</span><a href="#local-6989586621682433006"><span class="hs-identifier hs-var">findOut</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433003"><span class="hs-identifier hs-var">ix'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Key0Status
</span><a href="#local-6989586621682433004"><span class="hs-identifier hs-var">is0Reg</span></a></span><span>
</span><span id="line-396"></span><span>        </span><span id="local-6989586621682433008"><span class="annot"><span class="annottext">dec :: State -&gt; State
</span><a href="#local-6989586621682433008"><span class="hs-identifier hs-var hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621682433002"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621682433002"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621682433002"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-397"></span><span>            </span><span class="annot"><span class="annottext">State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#Zero"><span class="hs-identifier hs-var">Zero</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; State
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;impossible: can't decrement beyond zero&quot;</span></span><span>
</span><span id="line-398"></span><span>            </span><span class="annot"><span class="annottext">State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#One"><span class="hs-identifier hs-var">One</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#Zero"><span class="hs-identifier hs-var">Zero</span></a></span><span>
</span><span id="line-399"></span><span>            </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#More"><span class="hs-identifier hs-type">More</span></a></span><span> </span><span id="local-6989586621682433000"><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433000"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="annot"><span class="annottext">PointerUTxO
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682432999"><span class="annot"><span class="annottext">Key0Status
</span><a href="#local-6989586621682432999"><span class="hs-identifier hs-var">is0Reg</span></a></span></span><span>
</span><span id="line-400"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromEnum</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433000"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682432997"><span class="annot"><span class="annottext">ix' :: Index 'Soft 'AddressK
</span><a href="#local-6989586621682432997"><span class="hs-identifier hs-var hs-var">ix'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682433000"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; PointerUTxO -&gt; Key0Status -&gt; State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#More"><span class="hs-identifier hs-var">More</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432997"><span class="hs-identifier hs-var">ix'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; PointerUTxO
</span><a href="#local-6989586621682433006"><span class="hs-identifier hs-var">findOut</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432997"><span class="hs-identifier hs-var">ix'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Key0Status
</span><a href="#local-6989586621682432999"><span class="hs-identifier hs-var">is0Reg</span></a></span><span>
</span><span id="line-401"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Key0Status
</span><a href="#local-6989586621682432999"><span class="hs-identifier hs-var">is0Reg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-402"></span><span>                    </span><span class="annot"><span class="annottext">Key0Status
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#ValidKey0"><span class="hs-identifier hs-var">ValidKey0</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#One"><span class="hs-identifier hs-var">One</span></a></span><span>
</span><span id="line-403"></span><span>                    </span><span class="annot"><span class="annottext">Key0Status
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#MissingKey0"><span class="hs-identifier hs-var">MissingKey0</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#Zero"><span class="hs-identifier hs-var">Zero</span></a></span><span>
</span><span id="line-404"></span><span>
</span><span id="line-405"></span><span>        </span><span id="local-6989586621682433006"><span class="annot"><span class="annottext">findOut :: Index 'Soft 'AddressK -&gt; PointerUTxO
</span><a href="#local-6989586621682433006"><span class="hs-identifier hs-var hs-var">findOut</span></a></span></span><span> </span><span id="local-6989586621682432996"><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432996"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">((Word32, TxOut) -&gt; PointerUTxO)
-&gt; [(Word32, TxOut)] -&gt; [PointerUTxO]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Word32, TxOut) -&gt; PointerUTxO
</span><a href="#local-6989586621682432995"><span class="hs-identifier hs-var">mkPointer</span></a></span><span> </span><span class="annot"><span class="annottext">[(Word32, TxOut)]
</span><a href="#local-6989586621682432994"><span class="hs-identifier hs-var">pointerOuts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-406"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621682432993"><span class="annot"><span class="annottext">PointerUTxO
</span><a href="#local-6989586621682432993"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">[PointerUTxO]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PointerUTxO
</span><a href="#local-6989586621682432993"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-407"></span><span>            </span><span class="annot"><span class="annottext">[PointerUTxO]
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; PointerUTxO
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; PointerUTxO) -&gt; String -&gt; PointerUTxO
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
forall a. Monoid a =&gt; [a] -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mconcat</span></a></span><span>
</span><span id="line-408"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;couldn't find pointer output for ix &quot;</span></span><span>
</span><span id="line-409"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432996"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-410"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; with state &quot;</span></span><span>
</span><span id="line-411"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(State -&gt; String) -&gt; State -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; State
forall (k :: Depth -&gt; * -&gt; *). DelegationState k -&gt; State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#state"><span class="hs-identifier hs-var hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433019"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-412"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-413"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-414"></span><span>            </span><span id="local-6989586621682432991"><span class="annot"><span class="annottext">isOurOut :: TxOut -&gt; Bool
</span><a href="#local-6989586621682432991"><span class="hs-identifier hs-var hs-var">isOurOut</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxOut"><span class="hs-identifier hs-type">TxOut</span></a></span><span> </span><span id="local-6989586621682432990"><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682432990"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span id="local-6989586621682432989"><span class="annot"><span class="annottext">TokenBundle
</span><a href="#local-6989586621682432989"><span class="hs-identifier hs-var">_b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-415"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall from.
MkKeyFingerprint k from =&gt;
from
-&gt; Either (ErrMkKeyFingerprint k from) (KeyFingerprint &quot;payment&quot; k)
forall (key :: Depth -&gt; * -&gt; *) from.
MkKeyFingerprint key from =&gt;
from
-&gt; Either
     (ErrMkKeyFingerprint key from) (KeyFingerprint &quot;payment&quot; key)
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#paymentKeyFingerprint"><span class="hs-identifier hs-var">paymentKeyFingerprint</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682433027"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><span class="annottext">(k 'AddressK XPub
 -&gt; Either
      (ErrMkKeyFingerprint k (k 'AddressK XPub))
      (KeyFingerprint &quot;payment&quot; k))
-&gt; k 'AddressK XPub
-&gt; Either
     (ErrMkKeyFingerprint k (k 'AddressK XPub))
     (KeyFingerprint &quot;payment&quot; k)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
forall (k :: Depth -&gt; * -&gt; *).
SoftDerivation k =&gt;
DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#keyAtIx"><span class="hs-identifier hs-var">keyAtIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433019"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432996"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Address
-&gt; Either
     (ErrMkKeyFingerprint k Address) (KeyFingerprint &quot;payment&quot; k)
forall (key :: Depth -&gt; * -&gt; *) from.
MkKeyFingerprint key from =&gt;
from
-&gt; Either
     (ErrMkKeyFingerprint key from) (KeyFingerprint &quot;payment&quot; key)
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#paymentKeyFingerprint"><span class="hs-identifier hs-var">paymentKeyFingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">Address
</span><a href="#local-6989586621682432990"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-416"></span><span>                </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621682432988"><span class="annot"><span class="annottext">KeyFingerprint &quot;payment&quot; k
</span><a href="#local-6989586621682432988"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621682432987"><span class="annot"><span class="annottext">KeyFingerprint &quot;payment&quot; k
</span><a href="#local-6989586621682432987"><span class="hs-identifier hs-var">fp'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">KeyFingerprint &quot;payment&quot; k
</span><a href="#local-6989586621682432988"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">KeyFingerprint &quot;payment&quot; k -&gt; KeyFingerprint &quot;payment&quot; k -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">KeyFingerprint &quot;payment&quot; k
</span><a href="#local-6989586621682432987"><span class="hs-identifier hs-var">fp'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-418"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-419"></span><span>                </span><span class="annot"><span class="annottext">(Either
   (ErrMkKeyFingerprint k (k 'AddressK XPub))
   (KeyFingerprint &quot;payment&quot; k),
 Either
   (ErrMkKeyFingerprint k Address) (KeyFingerprint &quot;payment&quot; k))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-420"></span><span>            </span><span id="local-6989586621682432995"><span class="annot"><span class="annottext">mkPointer :: (Word32, TxOut) -&gt; PointerUTxO
</span><a href="#local-6989586621682432995"><span class="hs-identifier hs-var hs-var">mkPointer</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682432986"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682432986"><span class="hs-identifier hs-var">txIx</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxOut"><span class="hs-identifier hs-type">TxOut</span></a></span><span> </span><span class="annot"><span class="annottext">Address
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682432985"><span class="annot"><span class="annottext">TokenBundle
</span><a href="#local-6989586621682432985"><span class="hs-identifier hs-var">tb</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxIn -&gt; Coin -&gt; PointerUTxO
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#PointerUTxO"><span class="hs-identifier hs-var">PointerUTxO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash &quot;Tx&quot; -&gt; Word32 -&gt; TxIn
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxIn"><span class="hs-identifier hs-var">TxIn</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682433023"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682432986"><span class="hs-identifier hs-var">txIx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TokenBundle -&gt; Coin
</span><a href="Cardano.Wallet.Primitive.Types.TokenBundle.html#getCoin"><span class="hs-identifier hs-var">TB.getCoin</span></a></span><span> </span><span class="annot"><span class="annottext">TokenBundle
</span><a href="#local-6989586621682432985"><span class="hs-identifier hs-var">tb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-421"></span><span>            </span><span id="local-6989586621682432994"><span class="annot"><span class="annottext">pointerOuts :: [(Word32, TxOut)]
</span><a href="#local-6989586621682432994"><span class="hs-identifier hs-var hs-var">pointerOuts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Word32, TxOut) -&gt; Bool) -&gt; [(Word32, TxOut)] -&gt; [(Word32, TxOut)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxOut -&gt; Bool
</span><a href="#local-6989586621682432991"><span class="hs-identifier hs-var">isOurOut</span></a></span><span> </span><span class="annot"><span class="annottext">(TxOut -&gt; Bool)
-&gt; ((Word32, TxOut) -&gt; TxOut) -&gt; (Word32, TxOut) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Word32, TxOut) -&gt; TxOut
forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Word32, TxOut)] -&gt; [(Word32, TxOut)])
-&gt; [(Word32, TxOut)] -&gt; [(Word32, TxOut)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Word32] -&gt; [TxOut] -&gt; [(Word32, TxOut)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">zip</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[TxOut]
</span><a href="#local-6989586621682433024"><span class="hs-identifier hs-var">outs</span></a></span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span>    </span><span class="annot"><a href="#local-6989586621682433016"><span class="hs-identifier hs-type">modifyState</span></a></span><span>
</span><span id="line-424"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#State"><span class="hs-identifier hs-type">State</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-425"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433027"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-426"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682433027"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-427"></span><span>    </span><span id="local-6989586621682433016"><span class="annot"><span class="annottext">modifyState :: (State -&gt; State) -&gt; DelegationState k -&gt; DelegationState k
</span><a href="#local-6989586621682433016"><span class="hs-identifier hs-var hs-var">modifyState</span></a></span></span><span> </span><span id="local-6989586621682432982"><span class="annot"><span class="annottext">State -&gt; State
</span><a href="#local-6989586621682432982"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621682432981"><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432981"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432981"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">state :: State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#state"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State -&gt; State
</span><a href="#local-6989586621682432982"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DelegationState k -&gt; State
forall (k :: Depth -&gt; * -&gt; *). DelegationState k -&gt; State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#state"><span class="hs-identifier hs-var hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432981"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span>    </span><span class="hs-comment">-- | Modifies the &quot;isKey0Reg&quot; of the `More` constructor.</span><span>
</span><span id="line-430"></span><span>    </span><span id="local-6989586621682433011"><span class="annot"><span class="annottext">modifyKey0 :: Cert -&gt; State -&gt; State
</span><a href="#local-6989586621682433011"><span class="hs-identifier hs-var hs-var">modifyKey0</span></a></span></span><span> </span><span id="local-6989586621682432980"><span class="annot"><span class="annottext">Cert
</span><a href="#local-6989586621682432980"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span id="local-6989586621682432979"><span class="annot"><span class="annottext">s :: State
</span><a href="#local-6989586621682432979"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#More"><span class="hs-identifier hs-type">More</span></a></span><span> </span><span id="local-6989586621682432978"><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432978"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621682432977"><span class="annot"><span class="annottext">PointerUTxO
</span><a href="#local-6989586621682432977"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">Key0Status
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Cert
</span><a href="#local-6989586621682432980"><span class="hs-identifier hs-var">cert</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-431"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#Delegate"><span class="hs-identifier hs-type">Delegate</span></a></span><span> </span><span id="local-6989586621682432976"><span class="annot"><span class="annottext">RewardAccount
</span><a href="#local-6989586621682432976"><span class="hs-identifier hs-var">k</span></a></span></span><span>
</span><span id="line-432"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">RewardAccount
</span><a href="#local-6989586621682432976"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">RewardAccount -&gt; RewardAccount -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; RewardAccount
</span><a href="#local-6989586621682432975"><span class="hs-identifier hs-var">acct</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; PointerUTxO -&gt; Key0Status -&gt; State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#More"><span class="hs-identifier hs-var">More</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432978"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">PointerUTxO
</span><a href="#local-6989586621682432977"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Key0Status
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#ValidKey0"><span class="hs-identifier hs-var">ValidKey0</span></a></span><span>
</span><span id="line-433"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621682432979"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-434"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DeRegisterKey"><span class="hs-identifier hs-type">DeRegisterKey</span></a></span><span> </span><span id="local-6989586621682432974"><span class="annot"><span class="annottext">RewardAccount
</span><a href="#local-6989586621682432974"><span class="hs-identifier hs-var">k</span></a></span></span><span>
</span><span id="line-435"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">RewardAccount
</span><a href="#local-6989586621682432974"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">RewardAccount -&gt; RewardAccount -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; RewardAccount
</span><a href="#local-6989586621682432975"><span class="hs-identifier hs-var">acct</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; PointerUTxO -&gt; Key0Status -&gt; State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#More"><span class="hs-identifier hs-var">More</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432978"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">PointerUTxO
</span><a href="#local-6989586621682432977"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Key0Status
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#MissingKey0"><span class="hs-identifier hs-var">MissingKey0</span></a></span><span>
</span><span id="line-436"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621682432979"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-437"></span><span>        </span><span class="annot"><span class="annottext">Cert
</span><span class="hs-identifier">_</span></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621682432979"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-438"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-439"></span><span>        </span><span id="local-6989586621682432975"><span class="annot"><span class="annottext">acct :: Int -&gt; RewardAccount
</span><a href="#local-6989586621682432975"><span class="hs-identifier hs-var hs-var">acct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">k 'AddressK XPub -&gt; RewardAccount
forall (k :: Depth -&gt; * -&gt; *).
ToRewardAccount k =&gt;
k 'AddressK XPub -&gt; RewardAccount
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#toRewardAccount"><span class="hs-identifier hs-var">toRewardAccount</span></a></span><span> </span><span class="annot"><span class="annottext">(k 'AddressK XPub -&gt; RewardAccount)
-&gt; (Int -&gt; k 'AddressK XPub) -&gt; Int -&gt; RewardAccount
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
forall (k :: Depth -&gt; * -&gt; *).
SoftDerivation k =&gt;
DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#keyAtIx"><span class="hs-identifier hs-var">keyAtIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682433022"><span class="hs-identifier hs-var">ds0</span></a></span><span> </span><span class="annot"><span class="annottext">(Index 'Soft 'AddressK -&gt; k 'AddressK XPub)
-&gt; (Int -&gt; Index 'Soft 'AddressK) -&gt; Int -&gt; k 'AddressK XPub
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; Int -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toEnum</span></a></span><span>
</span><span id="line-440"></span><span>    </span><span class="annot"><a href="#local-6989586621682433011"><span class="hs-identifier hs-var">modifyKey0</span></a></span><span> </span><span class="annot"><span class="annottext">Cert
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682432973"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621682432973"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621682432973"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span>    </span><span id="local-6989586621682433009"><span class="annot"><span class="annottext">lastActiveKey :: DelegationState k -&gt; Maybe RewardAccount
</span><a href="#local-6989586621682433009"><span class="hs-identifier hs-var hs-var">lastActiveKey</span></a></span></span><span> </span><span id="local-6989586621682432972"><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432972"><span class="hs-identifier hs-var">ds'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">k 'AddressK XPub -&gt; RewardAccount
forall (k :: Depth -&gt; * -&gt; *).
ToRewardAccount k =&gt;
k 'AddressK XPub -&gt; RewardAccount
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#toRewardAccount"><span class="hs-identifier hs-var">toRewardAccount</span></a></span><span> </span><span class="annot"><span class="annottext">(k 'AddressK XPub -&gt; RewardAccount)
-&gt; (Index 'Soft 'AddressK -&gt; k 'AddressK XPub)
-&gt; Index 'Soft 'AddressK
-&gt; RewardAccount
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
forall (k :: Depth -&gt; * -&gt; *).
SoftDerivation k =&gt;
DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#keyAtIx"><span class="hs-identifier hs-var">keyAtIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432972"><span class="hs-identifier hs-var">ds'</span></a></span><span> </span><span class="annot"><span class="annottext">(Index 'Soft 'AddressK -&gt; RewardAccount)
-&gt; Maybe (Index 'Soft 'AddressK) -&gt; Maybe RewardAccount
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Maybe (Index 'Soft 'AddressK)
forall (k :: Depth -&gt; * -&gt; *).
DelegationState k -&gt; Maybe (Index 'Soft 'AddressK)
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#lastActiveIx"><span class="hs-identifier hs-var">lastActiveIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432972"><span class="hs-identifier hs-var">ds'</span></a></span><span>
</span><span id="line-443"></span><span>    </span><span id="local-6989586621682433013"><span class="annot"><span class="annottext">nextKey :: DelegationState k -&gt; RewardAccount
</span><a href="#local-6989586621682433013"><span class="hs-identifier hs-var hs-var">nextKey</span></a></span></span><span> </span><span id="local-6989586621682432971"><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432971"><span class="hs-identifier hs-var">ds'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">k 'AddressK XPub -&gt; RewardAccount
forall (k :: Depth -&gt; * -&gt; *).
ToRewardAccount k =&gt;
k 'AddressK XPub -&gt; RewardAccount
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#toRewardAccount"><span class="hs-identifier hs-var">toRewardAccount</span></a></span><span> </span><span class="annot"><span class="annottext">(k 'AddressK XPub -&gt; RewardAccount)
-&gt; (Index 'Soft 'AddressK -&gt; k 'AddressK XPub)
-&gt; Index 'Soft 'AddressK
-&gt; RewardAccount
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
forall (k :: Depth -&gt; * -&gt; *).
SoftDerivation k =&gt;
DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#keyAtIx"><span class="hs-identifier hs-var">keyAtIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432971"><span class="hs-identifier hs-var">ds'</span></a></span><span> </span><span class="annot"><span class="annottext">(Index 'Soft 'AddressK -&gt; RewardAccount)
-&gt; Index 'Soft 'AddressK -&gt; RewardAccount
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK
forall (k :: Depth -&gt; * -&gt; *).
DelegationState k -&gt; Index 'Soft 'AddressK
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#nextKeyIx"><span class="hs-identifier hs-var">nextKeyIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432971"><span class="hs-identifier hs-var">ds'</span></a></span><span>
</span><span id="line-444"></span><span>
</span><span id="line-445"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-446"></span><span class="hs-comment">-- Operations</span><span>
</span><span id="line-447"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-448"></span><span>
</span><span id="line-449"></span><span class="hs-comment">-- | All stake keys worth listing to the user.</span><span>
</span><span id="line-450"></span><span class="hs-comment">--</span><span>
</span><span id="line-451"></span><span class="hs-comment">-- May include:</span><span>
</span><span id="line-452"></span><span class="hs-comment">-- 1. Active stake keys</span><span>
</span><span id="line-453"></span><span class="hs-comment">-- 2. The next un-active key</span><span>
</span><span id="line-454"></span><span class="hs-comment">--</span><span>
</span><span id="line-455"></span><span class="hs-comment">-- NOTE: In theory we might want also present stake keys that are unexpectedly</span><span>
</span><span id="line-456"></span><span class="hs-comment">-- registered, as they could be de-registered to reclaim the deposit, but this</span><span>
</span><span id="line-457"></span><span class="hs-comment">-- should in-practice never happen.</span><span>
</span><span id="line-458"></span><span class="hs-comment">--</span><span>
</span><span id="line-459"></span><span class="hs-comment">-- If @sn@ denotes the state with @n@ registered and delegating keys:</span><span>
</span><span id="line-460"></span><span class="hs-comment">-- &gt;&gt;&gt; presentableKeys s0</span><span>
</span><span id="line-461"></span><span class="hs-comment">-- [0]</span><span>
</span><span id="line-462"></span><span class="hs-comment">-- &gt;&gt;&gt; presentableKeys s1</span><span>
</span><span id="line-463"></span><span class="hs-comment">-- [0, 1]</span><span>
</span><span id="line-464"></span><span class="hs-comment">-- &gt;&gt;&gt; presentableKeys s2</span><span>
</span><span id="line-465"></span><span class="hs-comment">-- [0, 1, 2]</span><span>
</span><span id="line-466"></span><span id="local-6989586621682432970"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#presentableKeys"><span class="hs-identifier hs-type">presentableKeys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#SoftDerivation"><span class="hs-identifier hs-type">SoftDerivation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682432970"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682432970"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682432970"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-467"></span><span id="presentableKeys"><span class="annot"><span class="annottext">presentableKeys :: DelegationState k -&gt; [k 'AddressK XPub]
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#presentableKeys"><span class="hs-identifier hs-var hs-var">presentableKeys</span></a></span></span><span> </span><span id="local-6989586621682432969"><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432969"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Maybe (Index 'Soft 'AddressK)
forall (k :: Depth -&gt; * -&gt; *).
DelegationState k -&gt; Maybe (Index 'Soft 'AddressK)
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#lastActiveIx"><span class="hs-identifier hs-var">lastActiveIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432969"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-468"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682432968"><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432968"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Index 'Soft 'AddressK -&gt; k 'AddressK XPub)
-&gt; [Index 'Soft 'AddressK] -&gt; [k 'AddressK XPub]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
forall (k :: Depth -&gt; * -&gt; *).
SoftDerivation k =&gt;
DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#keyAtIx"><span class="hs-identifier hs-var">keyAtIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432969"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
forall a. Bounded a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">minBound</span></a></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">succ</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432968"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-469"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Index 'Soft 'AddressK)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
forall (k :: Depth -&gt; * -&gt; *).
SoftDerivation k =&gt;
DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#keyAtIx"><span class="hs-identifier hs-var">keyAtIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432969"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
forall a. Bounded a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">minBound</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-470"></span><span>
</span><span id="line-471"></span><span class="hs-comment">-- Keys meant to be used in addresses.</span><span>
</span><span id="line-472"></span><span class="hs-comment">--</span><span>
</span><span id="line-473"></span><span class="hs-comment">-- If @sn@ denotes the state with @n@ registered and delegating keys:</span><span>
</span><span id="line-474"></span><span class="hs-comment">-- &gt;&gt;&gt; usableKeys s0</span><span>
</span><span id="line-475"></span><span class="hs-comment">-- [0]</span><span>
</span><span id="line-476"></span><span class="hs-comment">-- &gt;&gt;&gt; usableKeys s1</span><span>
</span><span id="line-477"></span><span class="hs-comment">-- [0]</span><span>
</span><span id="line-478"></span><span class="hs-comment">-- &gt;&gt;&gt; usableKeys s2</span><span>
</span><span id="line-479"></span><span class="hs-comment">-- [0, 1]</span><span>
</span><span id="line-480"></span><span class="hs-comment">--</span><span>
</span><span id="line-481"></span><span class="hs-comment">-- Note that for @s0@, we have no active stake keys, but we still want to use</span><span>
</span><span id="line-482"></span><span class="hs-comment">-- key 0 as part of addresses.</span><span>
</span><span id="line-483"></span><span class="hs-comment">--</span><span>
</span><span id="line-484"></span><span class="hs-comment">-- Also note that old wallet software may unregister the first stake key 0</span><span>
</span><span id="line-485"></span><span class="hs-comment">-- despite stake key 1 being active. This doesn't affect `usableKeys`</span><span>
</span><span id="line-486"></span><span class="hs-comment">-- (it still includes key 0), as we view the state as incorrect and temporary.</span><span>
</span><span id="line-487"></span><span id="local-6989586621682432967"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#usableKeys"><span class="hs-identifier hs-type">usableKeys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#SoftDerivation"><span class="hs-identifier hs-type">SoftDerivation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682432967"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682432967"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682432967"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-488"></span><span id="usableKeys"><span class="annot"><span class="annottext">usableKeys :: DelegationState k -&gt; [k 'AddressK XPub]
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#usableKeys"><span class="hs-identifier hs-var hs-var">usableKeys</span></a></span></span><span> </span><span id="local-6989586621682432966"><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432966"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; Maybe (Index 'Soft 'AddressK)
forall (k :: Depth -&gt; * -&gt; *).
DelegationState k -&gt; Maybe (Index 'Soft 'AddressK)
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#lastActiveIx"><span class="hs-identifier hs-var">lastActiveIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432966"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-489"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682432965"><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432965"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Index 'Soft 'AddressK -&gt; k 'AddressK XPub)
-&gt; [Index 'Soft 'AddressK] -&gt; [k 'AddressK XPub]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
forall (k :: Depth -&gt; * -&gt; *).
SoftDerivation k =&gt;
DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#keyAtIx"><span class="hs-identifier hs-var">keyAtIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432966"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
forall a. Bounded a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">minBound</span></a></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432965"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-490"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Index 'Soft 'AddressK)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
forall (k :: Depth -&gt; * -&gt; *).
SoftDerivation k =&gt;
DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#keyAtIx"><span class="hs-identifier hs-var">keyAtIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432966"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
forall a. Bounded a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">minBound</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-491"></span><span>
</span><span id="line-492"></span><span class="hs-comment">-- | For testing. Returns all registered and delegating stake keys.</span><span>
</span><span id="line-493"></span><span id="local-6989586621682432964"><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#activeKeys"><span class="hs-identifier hs-type">activeKeys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#SoftDerivation"><span class="hs-identifier hs-type">SoftDerivation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682432964"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#DelegationState"><span class="hs-identifier hs-type">DelegationState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682432964"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682432964"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-494"></span><span id="activeKeys"><span class="annot"><span class="annottext">activeKeys :: DelegationState k -&gt; [k 'AddressK XPub]
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#activeKeys"><span class="hs-identifier hs-var hs-var">activeKeys</span></a></span></span><span> </span><span id="local-6989586621682432963"><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432963"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Index 'Soft 'AddressK -&gt; k 'AddressK XPub)
-&gt; [Index 'Soft 'AddressK] -&gt; [k 'AddressK XPub]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
forall (k :: Depth -&gt; * -&gt; *).
SoftDerivation k =&gt;
DelegationState k -&gt; Index 'Soft 'AddressK -&gt; k 'AddressK XPub
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#keyAtIx"><span class="hs-identifier hs-var">keyAtIx</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432963"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Index 'Soft 'AddressK] -&gt; [k 'AddressK XPub])
-&gt; [Index 'Soft 'AddressK] -&gt; [k 'AddressK XPub]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DelegationState k -&gt; State
forall (k :: Depth -&gt; * -&gt; *). DelegationState k -&gt; State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#state"><span class="hs-identifier hs-var hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationState k
</span><a href="#local-6989586621682432963"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-495"></span><span>    </span><span class="annot"><span class="annottext">State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#Zero"><span class="hs-identifier hs-var">Zero</span></a></span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-496"></span><span>    </span><span class="annot"><span class="annottext">State
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#One"><span class="hs-identifier hs-var">One</span></a></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
forall a. Bounded a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">minBound</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-497"></span><span>    </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#More"><span class="hs-identifier hs-type">More</span></a></span><span> </span><span id="local-6989586621682432962"><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432962"><span class="hs-identifier hs-var">nextIx</span></a></span></span><span> </span><span class="annot"><span class="annottext">PointerUTxO
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Key0Status
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#ValidKey0"><span class="hs-identifier hs-var">ValidKey0</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
forall a. Bounded a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">minBound</span></a></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432962"><span class="hs-identifier hs-var">nextIx</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-498"></span><span>    </span><span class="annot"><a href="Cardano.Wallet.Primitive.Delegation.State.html#More"><span class="hs-identifier hs-type">More</span></a></span><span> </span><span id="local-6989586621682432961"><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432961"><span class="hs-identifier hs-var">nextIx</span></a></span></span><span> </span><span class="annot"><span class="annottext">PointerUTxO
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Key0Status
</span><a href="Cardano.Wallet.Primitive.Delegation.State.html#MissingKey0"><span class="hs-identifier hs-var">MissingKey0</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">succ</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
forall a. Bounded a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">minBound</span></a></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK -&gt; Index 'Soft 'AddressK
forall a. Enum a =&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft 'AddressK
</span><a href="#local-6989586621682432961"><span class="hs-identifier hs-var">nextIx</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-499"></span></pre></body></html>