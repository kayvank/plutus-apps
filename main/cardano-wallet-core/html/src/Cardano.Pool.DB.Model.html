<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# OPTIONS_GHC -Wno-unrecognised-pragmas #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE DuplicateRecordFields #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE GADTs #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE OverloadedLabels #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-17"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- Copyright: &#169; 2018-2020 IOHK</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- License: Apache-2.0</span><span>
</span><span id="line-23"></span><span class="hs-comment">--</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- An implementation of the production pool database using only pure functions.</span><span>
</span><span id="line-25"></span><span class="hs-comment">--</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- These functions and types model the behaviour of the SQLite database backend,</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- and are used for QuickCheck state machine testing, and the MVar database</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- backend.</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Cardano.Pool.DB.Model</span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">(</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Model Types</span></span><span>
</span><span id="line-33"></span><span>      </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolDatabase"><span class="hs-identifier">PoolDatabase</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#emptyPoolDatabase"><span class="hs-identifier">emptyPoolDatabase</span></a></span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Model Operation Types</span></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier">ModelOp</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolErr"><span class="hs-identifier">PoolErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Model pool database functions</span></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mCleanDatabase"><span class="hs-identifier">mCleanDatabase</span></a></span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mCleanPoolMetadata"><span class="hs-identifier">mCleanPoolMetadata</span></a></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutPoolProduction"><span class="hs-identifier">mPutPoolProduction</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutHeader"><span class="hs-identifier">mPutHeader</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mListHeaders"><span class="hs-identifier">mListHeaders</span></a></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadPoolProduction"><span class="hs-identifier">mReadPoolProduction</span></a></span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadTotalProduction"><span class="hs-identifier">mReadTotalProduction</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutStakeDistribution"><span class="hs-identifier">mPutStakeDistribution</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadStakeDistribution"><span class="hs-identifier">mReadStakeDistribution</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadPoolMetadata"><span class="hs-identifier">mReadPoolMetadata</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutPoolRegistration"><span class="hs-identifier">mPutPoolRegistration</span></a></span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadPoolRegistration"><span class="hs-identifier">mReadPoolRegistration</span></a></span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutPoolRetirement"><span class="hs-identifier">mPutPoolRetirement</span></a></span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadPoolRetirement"><span class="hs-identifier">mReadPoolRetirement</span></a></span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mUnfetchedPoolMetadataRefs"><span class="hs-identifier">mUnfetchedPoolMetadataRefs</span></a></span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutDelistedPools"><span class="hs-identifier">mPutDelistedPools</span></a></span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutFetchAttempt"><span class="hs-identifier">mPutFetchAttempt</span></a></span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutPoolMetadata"><span class="hs-identifier">mPutPoolMetadata</span></a></span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mListPoolLifeCycleData"><span class="hs-identifier">mListPoolLifeCycleData</span></a></span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mListRegisteredPools"><span class="hs-identifier">mListRegisteredPools</span></a></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mListRetiredPools"><span class="hs-identifier">mListRetiredPools</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadPoolLifeCycleStatus"><span class="hs-identifier">mReadPoolLifeCycleStatus</span></a></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadSystemSeed"><span class="hs-identifier">mReadSystemSeed</span></a></span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mRollbackTo"><span class="hs-identifier">mRollbackTo</span></a></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadCursor"><span class="hs-identifier">mReadCursor</span></a></span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mRemovePools"><span class="hs-identifier">mRemovePools</span></a></span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadDelistedPools"><span class="hs-identifier">mReadDelistedPools</span></a></span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mRemoveRetiredPools"><span class="hs-identifier">mRemoveRetiredPools</span></a></span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadSettings"><span class="hs-identifier">mReadSettings</span></a></span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutSettings"><span class="hs-identifier">mPutSettings</span></a></span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutLastMetadataGC"><span class="hs-identifier">mPutLastMetadataGC</span></a></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadLastMetadataGC"><span class="hs-identifier">mReadLastMetadataGC</span></a></span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Prelude</span></a></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.html"><span class="hs-identifier">Cardano.Pool.DB</span></a></span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.html#determinePoolLifeCycleStatus"><span class="hs-identifier">determinePoolLifeCycleStatus</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Slotting</span></a></span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier">TimeInterpreter</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#epochOf"><span class="hs-identifier">epochOf</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#interpretQuery"><span class="hs-identifier">interpretQuery</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types</span></a></span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier">BlockHeader</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#CertificatePublicationTime"><span class="hs-identifier">CertificatePublicationTime</span></a></span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier">EpochNo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#InternalState"><span class="hs-identifier">InternalState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier">PoolId</span></a></span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolLifeCycleStatus"><span class="hs-identifier">PoolLifeCycleStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolOwner"><span class="hs-identifier">PoolOwner</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRegistrationCertificate"><span class="hs-identifier">PoolRegistrationCertificate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRetirementCertificate"><span class="hs-identifier">PoolRetirementCertificate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Settings"><span class="hs-identifier">Settings</span></a></span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier">SlotNo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadata"><span class="hs-identifier">StakePoolMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadataHash"><span class="hs-identifier">StakePoolMetadataHash</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadataUrl"><span class="hs-identifier">StakePoolMetadataUrl</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#defaultInternalState"><span class="hs-identifier">defaultInternalState</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#defaultSettings"><span class="hs-identifier">defaultSettings</span></a></span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">Control.Monad.Trans.Class</span></a></span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">lift</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">Control.Monad.Trans.State.Strict</span></a></span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">StateT</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Bifunctor</span></a></span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">first</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">fold</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Function</span></a></span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&amp;)</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Functor.Const</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Const</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Functor.Identity</span></a></span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Identity</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../generic-lens/html/src"><span class="hs-identifier">Data.Generics.Internal.VL.Lens</span></a></span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../generic-lens/html/src"><span class="hs-identifier">over</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../generic-lens/html/src"><span class="hs-identifier">view</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Map</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Ord</span></a></span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Down</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Quantity.html"><span class="hs-identifier">Data.Quantity</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier">Quantity</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Set</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Set</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../time/html/src"><span class="hs-identifier">Data.Time.Clock.POSIX</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../time/html/src"><span class="hs-identifier">POSIXTime</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Word</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Word64</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../random/html/src"><span class="hs-identifier">System.Random</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../random/html/src"><span class="hs-identifier">StdGen</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../random/html/src"><span class="hs-identifier">newStdGen</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">Control.Monad.Trans.State.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">State</span></span><span>
</span><span id="line-131"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-132"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-133"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span class="hs-comment">{-------------------------------------------------------------------------------
                            Model Database Types
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span id="local-6989586621682466758"><span id="local-6989586621682466759"></span></span><span class="hs-keyword">data</span><span> </span><span id="PoolDatabase"><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolDatabase"><span class="hs-identifier hs-var">PoolDatabase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PoolDatabase"><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolDatabase"><span class="hs-identifier hs-var">PoolDatabase</span></a></span></span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="%24sel%3Apools%3APoolDatabase"><span class="annot"><span class="annottext">PoolDatabase -&gt; Map PoolId [BlockHeader]
</span><a href="Cardano.Pool.DB.Model.html#%24sel%3Apools%3APoolDatabase"><span class="hs-identifier hs-var hs-var">pools</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-comment">-- ^ Information of what blocks were produced by which stake pools</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Adistributions%3APoolDatabase"><span class="annot"><span class="annottext">PoolDatabase -&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
</span><a href="Cardano.Pool.DB.Model.html#%24sel%3Adistributions%3APoolDatabase"><span class="hs-identifier hs-var hs-var">distributions</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-type">Quantity</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;lovelace&quot;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-comment">-- ^ Store known stake distributions for epochs</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Aowners%3APoolDatabase"><span class="annot"><span class="annottext">PoolDatabase -&gt; Map PoolId [PoolOwner]
</span><a href="Cardano.Pool.DB.Model.html#%24sel%3Aowners%3APoolDatabase"><span class="hs-identifier hs-var hs-var">owners</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolOwner"><span class="hs-identifier hs-type">PoolOwner</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-comment">-- ^ Mapping between pool ids and owners</span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Aregistrations%3APoolDatabase"><span class="annot"><span class="annottext">PoolDatabase
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
</span><a href="Cardano.Pool.DB.Model.html#%24sel%3Aregistrations%3APoolDatabase"><span class="hs-identifier hs-var hs-var">registrations</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-150"></span><span>        </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#CertificatePublicationTime"><span class="hs-identifier hs-type">CertificatePublicationTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRegistrationCertificate"><span class="hs-identifier hs-type">PoolRegistrationCertificate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>    </span><span class="hs-comment">-- ^ On-chain registrations associated with pools</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Aretirements%3APoolDatabase"><span class="annot"><span class="annottext">PoolDatabase
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
</span><a href="Cardano.Pool.DB.Model.html#%24sel%3Aretirements%3APoolDatabase"><span class="hs-identifier hs-var hs-var">retirements</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-154"></span><span>        </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#CertificatePublicationTime"><span class="hs-identifier hs-type">CertificatePublicationTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRetirementCertificate"><span class="hs-identifier hs-type">PoolRetirementCertificate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-comment">-- ^ On-chain retirements associated with pools</span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Adelisted%3APoolDatabase"><span class="annot"><span class="annottext">PoolDatabase -&gt; Set PoolId
</span><a href="Cardano.Pool.DB.Model.html#%24sel%3Adelisted%3APoolDatabase"><span class="hs-identifier hs-var hs-var">delisted</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Ametadata%3APoolDatabase"><span class="annot"><span class="annottext">PoolDatabase -&gt; Map StakePoolMetadataHash StakePoolMetadata
</span><a href="Cardano.Pool.DB.Model.html#%24sel%3Ametadata%3APoolDatabase"><span class="hs-identifier hs-var hs-var">metadata</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadataHash"><span class="hs-identifier hs-type">StakePoolMetadataHash</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadata"><span class="hs-identifier hs-type">StakePoolMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-comment">-- ^ Off-chain metadata cached in database</span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AfetchAttempts%3APoolDatabase"><span class="annot"><span class="annottext">PoolDatabase
-&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
</span><a href="Cardano.Pool.DB.Model.html#%24sel%3AfetchAttempts%3APoolDatabase"><span class="hs-identifier hs-var hs-var">fetchAttempts</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadataUrl"><span class="hs-identifier hs-type">StakePoolMetadataUrl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadataHash"><span class="hs-identifier hs-type">StakePoolMetadataHash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-comment">-- ^ Metadata (failed) fetch attempts</span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Aseed%3APoolDatabase"><span class="annot"><span class="annottext">PoolDatabase -&gt; SystemSeed
</span><a href="Cardano.Pool.DB.Model.html#%24sel%3Aseed%3APoolDatabase"><span class="hs-identifier hs-var hs-var">seed</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Cardano.Pool.DB.Model.html#SystemSeed"><span class="hs-identifier hs-type">SystemSeed</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-comment">-- ^ Store an arbitrary random generator seed</span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AblockHeaders%3APoolDatabase"><span class="annot"><span class="annottext">PoolDatabase -&gt; [BlockHeader]
</span><a href="Cardano.Pool.DB.Model.html#%24sel%3AblockHeaders%3APoolDatabase"><span class="hs-identifier hs-var hs-var">blockHeaders</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-comment">-- ^ Store headers during syncing</span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Asettings%3APoolDatabase"><span class="annot"><span class="annottext">PoolDatabase -&gt; Settings
</span><a href="Cardano.Pool.DB.Model.html#%24sel%3Asettings%3APoolDatabase"><span class="hs-identifier hs-var hs-var">settings</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AinternalState%3APoolDatabase"><span class="annot"><span class="annottext">PoolDatabase -&gt; InternalState
</span><a href="Cardano.Pool.DB.Model.html#%24sel%3AinternalState%3APoolDatabase"><span class="hs-identifier hs-var hs-var">internalState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a></span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-comment">-- ^ Various internal states that need to persist across</span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-comment">-- wallet restarts.</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. PoolDatabase -&gt; Rep PoolDatabase x)
-&gt; (forall x. Rep PoolDatabase x -&gt; PoolDatabase)
-&gt; Generic PoolDatabase
forall x. Rep PoolDatabase x -&gt; PoolDatabase
forall x. PoolDatabase -&gt; Rep PoolDatabase x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep PoolDatabase x -&gt; PoolDatabase
$cfrom :: forall x. PoolDatabase -&gt; Rep PoolDatabase x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682466736"><span id="local-6989586621682466738"><span id="local-6989586621682466740"><span class="annot"><span class="annottext">Int -&gt; PoolDatabase -&gt; ShowS
[PoolDatabase] -&gt; ShowS
PoolDatabase -&gt; String
(Int -&gt; PoolDatabase -&gt; ShowS)
-&gt; (PoolDatabase -&gt; String)
-&gt; ([PoolDatabase] -&gt; ShowS)
-&gt; Show PoolDatabase
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PoolDatabase] -&gt; ShowS
$cshowList :: [PoolDatabase] -&gt; ShowS
show :: PoolDatabase -&gt; String
$cshow :: PoolDatabase -&gt; String
showsPrec :: Int -&gt; PoolDatabase -&gt; ShowS
$cshowsPrec :: Int -&gt; PoolDatabase -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682466731"><span id="local-6989586621682466733"><span class="annot"><span class="annottext">PoolDatabase -&gt; PoolDatabase -&gt; Bool
(PoolDatabase -&gt; PoolDatabase -&gt; Bool)
-&gt; (PoolDatabase -&gt; PoolDatabase -&gt; Bool) -&gt; Eq PoolDatabase
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PoolDatabase -&gt; PoolDatabase -&gt; Bool
$c/= :: PoolDatabase -&gt; PoolDatabase -&gt; Bool
== :: PoolDatabase -&gt; PoolDatabase -&gt; Bool
$c== :: PoolDatabase -&gt; PoolDatabase -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span id="local-6989586621682466728"><span id="local-6989586621682466729"></span></span><span class="hs-keyword">data</span><span> </span><span id="SystemSeed"><span class="annot"><a href="Cardano.Pool.DB.Model.html#SystemSeed"><span class="hs-identifier hs-var">SystemSeed</span></a></span></span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="SystemSeed"><span class="annot"><a href="Cardano.Pool.DB.Model.html#SystemSeed"><span class="hs-identifier hs-var">SystemSeed</span></a></span></span><span> </span><span class="annot"><a href="../../../../random/html/src"><span class="hs-identifier hs-type">StdGen</span></a></span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="NotSeededYet"><span class="annot"><a href="Cardano.Pool.DB.Model.html#NotSeededYet"><span class="hs-identifier hs-var">NotSeededYet</span></a></span></span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. SystemSeed -&gt; Rep SystemSeed x)
-&gt; (forall x. Rep SystemSeed x -&gt; SystemSeed) -&gt; Generic SystemSeed
forall x. Rep SystemSeed x -&gt; SystemSeed
forall x. SystemSeed -&gt; Rep SystemSeed x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep SystemSeed x -&gt; SystemSeed
$cfrom :: forall x. SystemSeed -&gt; Rep SystemSeed x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682466718"><span id="local-6989586621682466720"><span id="local-6989586621682466722"><span class="annot"><span class="annottext">Int -&gt; SystemSeed -&gt; ShowS
[SystemSeed] -&gt; ShowS
SystemSeed -&gt; String
(Int -&gt; SystemSeed -&gt; ShowS)
-&gt; (SystemSeed -&gt; String)
-&gt; ([SystemSeed] -&gt; ShowS)
-&gt; Show SystemSeed
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SystemSeed] -&gt; ShowS
$cshowList :: [SystemSeed] -&gt; ShowS
show :: SystemSeed -&gt; String
$cshow :: SystemSeed -&gt; String
showsPrec :: Int -&gt; SystemSeed -&gt; ShowS
$cshowsPrec :: Int -&gt; SystemSeed -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span class="hs-comment">-- | Shallow / weak equality on seeds.</span><span>
</span><span id="line-184"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682466715"><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#SystemSeed"><span class="hs-identifier hs-type">SystemSeed</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Pool.DB.Model.html#SystemSeed"><span class="hs-identifier hs-type">SystemSeed</span></a></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682466714"><span class="annot"><span class="annottext">== :: SystemSeed -&gt; SystemSeed -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var hs-var hs-var hs-var">==</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Pool.DB.Model.html#SystemSeed"><span class="hs-identifier hs-type">SystemSeed</span></a></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-186"></span><span>    </span><span class="annot"><span class="annottext">SystemSeed
</span><a href="Cardano.Pool.DB.Model.html#NotSeededYet"><span class="hs-identifier hs-var">NotSeededYet</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">SystemSeed
</span><a href="Cardano.Pool.DB.Model.html#NotSeededYet"><span class="hs-identifier hs-var">NotSeededYet</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-187"></span><span>    </span><span class="annot"><span class="annottext">SystemSeed
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">SystemSeed
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span class="hs-comment">-- | Produces an empty model pool production database.</span><span>
</span><span id="line-190"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#emptyPoolDatabase"><span class="hs-identifier hs-type">emptyPoolDatabase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolDatabase"><span class="hs-identifier hs-type">PoolDatabase</span></a></span><span>
</span><span id="line-191"></span><span id="emptyPoolDatabase"><span class="annot"><span class="annottext">emptyPoolDatabase :: PoolDatabase
</span><a href="Cardano.Pool.DB.Model.html#emptyPoolDatabase"><span class="hs-identifier hs-var hs-var">emptyPoolDatabase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map PoolId [BlockHeader]
-&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; Map PoolId [PoolOwner]
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
-&gt; Set PoolId
-&gt; Map StakePoolMetadataHash StakePoolMetadata
-&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
-&gt; SystemSeed
-&gt; [BlockHeader]
-&gt; Settings
-&gt; InternalState
-&gt; PoolDatabase
</span><a href="Cardano.Pool.DB.Model.html#PoolDatabase"><span class="hs-identifier hs-var">PoolDatabase</span></a></span><span>
</span><span id="line-192"></span><span>    </span><span class="annot"><span class="annottext">Map PoolId [BlockHeader]
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Map PoolId [PoolOwner]
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Map (CertificatePublicationTime, PoolId) PoolRetirementCertificate
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Set PoolId
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Map StakePoolMetadataHash StakePoolMetadata
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">SystemSeed
</span><a href="Cardano.Pool.DB.Model.html#NotSeededYet"><span class="hs-identifier hs-var">NotSeededYet</span></a></span><span>
</span><span id="line-193"></span><span>    </span><span class="annot"><span class="annottext">[BlockHeader]
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="Cardano.Wallet.Primitive.Types.html#defaultSettings"><span class="hs-identifier hs-var">defaultSettings</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState
</span><a href="Cardano.Wallet.Primitive.Types.html#defaultInternalState"><span class="hs-identifier hs-var">defaultInternalState</span></a></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="hs-comment">{-------------------------------------------------------------------------------
                                  Model Operation Types
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span class="hs-keyword">type</span><span> </span><span id="ModelOp"><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-var">ModelOp</span></a></span></span><span> </span><span id="local-6989586621682466713"><span class="annot"><a href="#local-6989586621682466713"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier hs-type">StateT</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolDatabase"><span class="hs-identifier hs-type">PoolDatabase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolErr"><span class="hs-identifier hs-type">PoolErr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682466713"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span class="hs-keyword">newtype</span><span> </span><span id="PoolErr"><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolErr"><span class="hs-identifier hs-var">PoolErr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PointAlreadyExists"><span class="annot"><a href="Cardano.Pool.DB.Model.html#PointAlreadyExists"><span class="hs-identifier hs-var">PointAlreadyExists</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-202"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682466706"><span id="local-6989586621682466708"><span id="local-6989586621682466710"><span class="annot"><span class="annottext">Int -&gt; PoolErr -&gt; ShowS
[PoolErr] -&gt; ShowS
PoolErr -&gt; String
(Int -&gt; PoolErr -&gt; ShowS)
-&gt; (PoolErr -&gt; String) -&gt; ([PoolErr] -&gt; ShowS) -&gt; Show PoolErr
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PoolErr] -&gt; ShowS
$cshowList :: [PoolErr] -&gt; ShowS
show :: PoolErr -&gt; String
$cshow :: PoolErr -&gt; String
showsPrec :: Int -&gt; PoolErr -&gt; ShowS
$cshowsPrec :: Int -&gt; PoolErr -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682466702"><span id="local-6989586621682466704"><span class="annot"><span class="annottext">PoolErr -&gt; PoolErr -&gt; Bool
(PoolErr -&gt; PoolErr -&gt; Bool)
-&gt; (PoolErr -&gt; PoolErr -&gt; Bool) -&gt; Eq PoolErr
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PoolErr -&gt; PoolErr -&gt; Bool
$c/= :: PoolErr -&gt; PoolErr -&gt; Bool
== :: PoolErr -&gt; PoolErr -&gt; Bool
$c== :: PoolErr -&gt; PoolErr -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span class="hs-comment">{-------------------------------------------------------------------------------
                            Model Pool Database Functions
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mCleanDatabase"><span class="hs-identifier hs-type">mCleanDatabase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span id="mCleanDatabase"><span class="annot"><span class="annottext">mCleanDatabase :: ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mCleanDatabase"><span class="hs-identifier hs-var hs-var">mCleanDatabase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolDatabase -&gt; ModelOp ()
forall (m :: * -&gt; *) s. Monad m =&gt; s -&gt; StateT s m ()
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">State.put</span></a></span><span> </span><span class="annot"><span class="annottext">PoolDatabase
</span><a href="Cardano.Pool.DB.Model.html#emptyPoolDatabase"><span class="hs-identifier hs-var">emptyPoolDatabase</span></a></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mCleanPoolMetadata"><span class="hs-identifier hs-type">mCleanPoolMetadata</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span id="mCleanPoolMetadata"><span class="annot"><span class="annottext">mCleanPoolMetadata :: ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mCleanPoolMetadata"><span class="hs-identifier hs-var hs-var">mCleanPoolMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-213"></span><span>    </span><span class="annot"><span class="annottext">((Map StakePoolMetadataHash StakePoolMetadata
  -&gt; Identity (Map StakePoolMetadataHash StakePoolMetadata))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map StakePoolMetadataHash StakePoolMetadata
    -&gt; Map StakePoolMetadataHash StakePoolMetadata)
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;metadata&quot;
  ((Map StakePoolMetadataHash StakePoolMetadata
    -&gt; Identity (Map StakePoolMetadataHash StakePoolMetadata))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map StakePoolMetadataHash StakePoolMetadata
 -&gt; Identity (Map StakePoolMetadataHash StakePoolMetadata))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466699"><span class="hs-var">#metadata</span></a></span><span>
</span><span id="line-214"></span><span>        </span><span class="annot"><span class="annottext">((Map StakePoolMetadataHash StakePoolMetadata
  -&gt; Map StakePoolMetadataHash StakePoolMetadata)
 -&gt; ModelOp ())
-&gt; (Map StakePoolMetadataHash StakePoolMetadata
    -&gt; Map StakePoolMetadataHash StakePoolMetadata)
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map StakePoolMetadataHash StakePoolMetadata
-&gt; Map StakePoolMetadataHash StakePoolMetadata
-&gt; Map StakePoolMetadataHash StakePoolMetadata
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Map StakePoolMetadataHash StakePoolMetadata
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><span class="annottext">[PoolId] -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mPutDelistedPools"><span class="hs-identifier hs-var">mPutDelistedPools</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutPoolProduction"><span class="hs-identifier hs-type">mPutPoolProduction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span id="mPutPoolProduction"><span class="annot"><span class="annottext">mPutPoolProduction :: BlockHeader -&gt; PoolId -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mPutPoolProduction"><span class="hs-identifier hs-var hs-var">mPutPoolProduction</span></a></span></span><span> </span><span id="local-6989586621682466697"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682466697"><span class="hs-identifier hs-var">point</span></a></span></span><span> </span><span id="local-6989586621682466696"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466696"><span class="hs-identifier hs-var">poolId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModelOp [BlockHeader]
</span><a href="#local-6989586621682466695"><span class="hs-identifier hs-var">getPoints</span></a></span><span> </span><span class="annot"><span class="annottext">ModelOp [BlockHeader]
-&gt; ([BlockHeader] -&gt; ModelOp ()) -&gt; ModelOp ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682466694"><span class="annot"><span class="annottext">[BlockHeader]
</span><a href="#local-6989586621682466694"><span class="hs-identifier hs-var">points</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682466697"><span class="hs-identifier hs-var">point</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; [BlockHeader] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockHeader]
</span><a href="#local-6989586621682466694"><span class="hs-identifier hs-var">points</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-220"></span><span>        </span><span class="annot"><span class="annottext">Either PoolErr () -&gt; ModelOp ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(Either PoolErr () -&gt; ModelOp ())
-&gt; Either PoolErr () -&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PoolErr -&gt; Either PoolErr ()
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolErr -&gt; Either PoolErr ()) -&gt; PoolErr -&gt; Either PoolErr ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; PoolErr
</span><a href="Cardano.Pool.DB.Model.html#PointAlreadyExists"><span class="hs-identifier hs-var">PointAlreadyExists</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682466697"><span class="hs-identifier hs-var">point</span></a></span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-222"></span><span>        </span><span class="annot"><span class="annottext">((Map PoolId [BlockHeader] -&gt; Identity (Map PoolId [BlockHeader]))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;pools&quot;
  ((Map PoolId [BlockHeader] -&gt; Identity (Map PoolId [BlockHeader]))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map PoolId [BlockHeader] -&gt; Identity (Map PoolId [BlockHeader]))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466692"><span class="hs-var">#pools</span></a></span><span> </span><span class="annot"><span class="annottext">((Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
 -&gt; ModelOp ())
-&gt; (Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe [BlockHeader] -&gt; Maybe [BlockHeader])
-&gt; PoolId -&gt; Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader]
forall k a.
Ord k =&gt;
(Maybe a -&gt; Maybe a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.alter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; Maybe [BlockHeader] -&gt; Maybe [BlockHeader]
</span><a href="#local-6989586621682466690"><span class="hs-identifier hs-var">alter</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682466697"><span class="hs-identifier hs-var">point</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466696"><span class="hs-identifier hs-var">poolId</span></a></span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-224"></span><span>    </span><span id="local-6989586621682466690"><span class="annot"><span class="annottext">alter :: BlockHeader -&gt; Maybe [BlockHeader] -&gt; Maybe [BlockHeader]
</span><a href="#local-6989586621682466690"><span class="hs-identifier hs-var hs-var">alter</span></a></span></span><span> </span><span id="local-6989586621682466689"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682466689"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-225"></span><span>        </span><span class="annot"><span class="annottext">Maybe [BlockHeader]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[BlockHeader] -&gt; Maybe [BlockHeader]
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682466689"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-226"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682466688"><span class="annot"><span class="annottext">[BlockHeader]
</span><a href="#local-6989586621682466688"><span class="hs-identifier hs-var">slots</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[BlockHeader] -&gt; Maybe [BlockHeader]
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockHeader] -&gt; Maybe [BlockHeader])
-&gt; [BlockHeader] -&gt; Maybe [BlockHeader]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockHeader] -&gt; [BlockHeader]
</span><a href="#local-6989586621682466687"><span class="hs-identifier hs-var">sortDesc</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockHeader] -&gt; [BlockHeader]) -&gt; [BlockHeader] -&gt; [BlockHeader]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682466689"><span class="hs-identifier hs-var">slot</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; [BlockHeader] -&gt; [BlockHeader]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockHeader]
</span><a href="#local-6989586621682466688"><span class="hs-identifier hs-var">slots</span></a></span><span>
</span><span id="line-227"></span><span>    </span><span id="local-6989586621682466687"><span class="annot"><span class="annottext">sortDesc :: [BlockHeader] -&gt; [BlockHeader]
</span><a href="#local-6989586621682466687"><span class="hs-identifier hs-var hs-var">sortDesc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; BlockHeader -&gt; Ordering)
-&gt; [BlockHeader] -&gt; [BlockHeader]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">L.sortBy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(BlockHeader -&gt; BlockHeader -&gt; Ordering)
-&gt; BlockHeader -&gt; BlockHeader -&gt; Ordering
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHeader -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">compare</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><a href="#local-6989586621682466695"><span class="hs-identifier hs-type">getPoints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-230"></span><span>    </span><span id="local-6989586621682466695"><span class="annot"><span class="annottext">getPoints :: ModelOp [BlockHeader]
</span><a href="#local-6989586621682466695"><span class="hs-identifier hs-var hs-var">getPoints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[BlockHeader]] -&gt; [BlockHeader]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="annot"><span class="annottext">([[BlockHeader]] -&gt; [BlockHeader])
-&gt; (Map PoolId [BlockHeader] -&gt; [[BlockHeader]])
-&gt; Map PoolId [BlockHeader]
-&gt; [BlockHeader]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map PoolId [BlockHeader] -&gt; [[BlockHeader]]
forall k a. Map k a -&gt; [a]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.elems</span></a></span><span> </span><span class="annot"><span class="annottext">(Map PoolId [BlockHeader] -&gt; [BlockHeader])
-&gt; StateT PoolDatabase (Either PoolErr) (Map PoolId [BlockHeader])
-&gt; ModelOp [BlockHeader]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Map PoolId [BlockHeader]
  -&gt; Const (Map PoolId [BlockHeader]) (Map PoolId [BlockHeader]))
 -&gt; PoolDatabase -&gt; Const (Map PoolId [BlockHeader]) PoolDatabase)
-&gt; StateT PoolDatabase (Either PoolErr) (Map PoolId [BlockHeader])
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;pools&quot;
  ((Map PoolId [BlockHeader]
    -&gt; Const (Map PoolId [BlockHeader]) (Map PoolId [BlockHeader]))
   -&gt; PoolDatabase -&gt; Const (Map PoolId [BlockHeader]) PoolDatabase)
(Map PoolId [BlockHeader]
 -&gt; Const (Map PoolId [BlockHeader]) (Map PoolId [BlockHeader]))
-&gt; PoolDatabase -&gt; Const (Map PoolId [BlockHeader]) PoolDatabase
</span><a href="#local-6989586621682466678"><span class="hs-var">#pools</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadPoolProduction"><span class="hs-identifier hs-type">mReadPoolProduction</span></a></span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier hs-type">TimeInterpreter</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Identity</span></a></span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a></span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span id="mReadPoolProduction"><span class="annot"><span class="annottext">mReadPoolProduction :: TimeInterpreter Identity
-&gt; EpochNo
-&gt; StateT PoolDatabase (Either PoolErr) (Map PoolId [BlockHeader])
</span><a href="Cardano.Pool.DB.Model.html#mReadPoolProduction"><span class="hs-identifier hs-var hs-var">mReadPoolProduction</span></a></span></span><span> </span><span id="local-6989586621682466677"><span class="annot"><span class="annottext">TimeInterpreter Identity
</span><a href="#local-6989586621682466677"><span class="hs-identifier hs-var">timeInterpreter</span></a></span></span><span> </span><span id="local-6989586621682466676"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466676"><span class="hs-identifier hs-var">epoch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-237"></span><span>    </span><span class="annot"><span class="annottext">Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader]
forall k a. Map k [a] -&gt; Map k [a]
</span><a href="#local-6989586621682466675"><span class="hs-identifier hs-var">updatePools</span></a></span><span> </span><span class="annot"><span class="annottext">(Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
-&gt; (Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
-&gt; Map PoolId [BlockHeader]
-&gt; Map PoolId [BlockHeader]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader]
</span><a href="#local-6989586621682466674"><span class="hs-identifier hs-var">updateSlots</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466676"><span class="hs-identifier hs-var">epoch</span></a></span><span> </span><span class="annot"><span class="annottext">(Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
-&gt; StateT PoolDatabase (Either PoolErr) (Map PoolId [BlockHeader])
-&gt; StateT PoolDatabase (Either PoolErr) (Map PoolId [BlockHeader])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Map PoolId [BlockHeader]
  -&gt; Const (Map PoolId [BlockHeader]) (Map PoolId [BlockHeader]))
 -&gt; PoolDatabase -&gt; Const (Map PoolId [BlockHeader]) PoolDatabase)
-&gt; StateT PoolDatabase (Either PoolErr) (Map PoolId [BlockHeader])
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;pools&quot;
  ((Map PoolId [BlockHeader]
    -&gt; Const (Map PoolId [BlockHeader]) (Map PoolId [BlockHeader]))
   -&gt; PoolDatabase -&gt; Const (Map PoolId [BlockHeader]) PoolDatabase)
(Map PoolId [BlockHeader]
 -&gt; Const (Map PoolId [BlockHeader]) (Map PoolId [BlockHeader]))
-&gt; PoolDatabase -&gt; Const (Map PoolId [BlockHeader]) PoolDatabase
</span><a href="#local-6989586621682466673"><span class="hs-var">#pools</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-239"></span><span>    </span><span id="local-6989586621682466672"><span class="annot"><span class="annottext">epochOf' :: SlotNo -&gt; EpochNo
</span><a href="#local-6989586621682466672"><span class="hs-identifier hs-var hs-var">epochOf'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity EpochNo -&gt; EpochNo
forall a. Identity a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var">runIdentity</span></a></span><span> </span><span class="annot"><span class="annottext">(Identity EpochNo -&gt; EpochNo)
-&gt; (SlotNo -&gt; Identity EpochNo) -&gt; SlotNo -&gt; EpochNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter Identity -&gt; Qry EpochNo -&gt; Identity EpochNo
forall (m :: * -&gt; *) a.
(HasCallStack, Monad m) =&gt;
TimeInterpreter m -&gt; Qry a -&gt; m a
</span><a href="Cardano.Wallet.Primitive.Slotting.html#interpretQuery"><span class="hs-identifier hs-var">interpretQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter Identity
</span><a href="#local-6989586621682466677"><span class="hs-identifier hs-var">timeInterpreter</span></a></span><span> </span><span class="annot"><span class="annottext">(Qry EpochNo -&gt; Identity EpochNo)
-&gt; (SlotNo -&gt; Qry EpochNo) -&gt; SlotNo -&gt; Identity EpochNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Qry EpochNo
</span><a href="Cardano.Wallet.Primitive.Slotting.html#epochOf"><span class="hs-identifier hs-var">epochOf</span></a></span><span>
</span><span id="line-240"></span><span>    </span><span id="local-6989586621682466675"><span class="annot"><span class="annottext">updatePools :: Map k [a] -&gt; Map k [a]
</span><a href="#local-6989586621682466675"><span class="hs-identifier hs-var hs-var">updatePools</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([a] -&gt; Bool) -&gt; Map k [a] -&gt; Map k [a]
forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; ([a] -&gt; Bool) -&gt; [a] -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">L.null</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>    </span><span id="local-6989586621682466674"><span class="annot"><span class="annottext">updateSlots :: EpochNo -&gt; Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader]
</span><a href="#local-6989586621682466674"><span class="hs-identifier hs-var hs-var">updateSlots</span></a></span></span><span> </span><span id="local-6989586621682466667"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466667"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([BlockHeader] -&gt; [BlockHeader])
-&gt; Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader]
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(BlockHeader -&gt; Bool) -&gt; [BlockHeader] -&gt; [BlockHeader]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682466665"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682466665"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; EpochNo
</span><a href="#local-6989586621682466672"><span class="hs-identifier hs-var">epochOf'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; SlotNo
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AslotNo%3ABlockHeader"><span class="hs-identifier hs-var hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682466665"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; EpochNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466667"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadTotalProduction"><span class="hs-identifier hs-type">mReadTotalProduction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-type">Quantity</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;block&quot;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span id="mReadTotalProduction"><span class="annot"><span class="annottext">mReadTotalProduction :: ModelOp (Map PoolId (Quantity &quot;block&quot; Word64))
</span><a href="Cardano.Pool.DB.Model.html#mReadTotalProduction"><span class="hs-identifier hs-var hs-var">mReadTotalProduction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-245"></span><span>    </span><span class="annot"><span class="annottext">([BlockHeader] -&gt; Quantity &quot;block&quot; Word64)
-&gt; Map PoolId [BlockHeader] -&gt; Map PoolId (Quantity &quot;block&quot; Word64)
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Quantity &quot;block&quot; Word64
forall (unit :: Symbol) a. a -&gt; Quantity unit a
</span><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-var">Quantity</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Quantity &quot;block&quot; Word64)
-&gt; ([BlockHeader] -&gt; Word64)
-&gt; [BlockHeader]
-&gt; Quantity &quot;block&quot; Word64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Word64)
-&gt; ([BlockHeader] -&gt; Int) -&gt; [BlockHeader] -&gt; Word64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockHeader] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">length</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map PoolId [BlockHeader] -&gt; Map PoolId (Quantity &quot;block&quot; Word64))
-&gt; StateT PoolDatabase (Either PoolErr) (Map PoolId [BlockHeader])
-&gt; ModelOp (Map PoolId (Quantity &quot;block&quot; Word64))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Map PoolId [BlockHeader]
  -&gt; Const (Map PoolId [BlockHeader]) (Map PoolId [BlockHeader]))
 -&gt; PoolDatabase -&gt; Const (Map PoolId [BlockHeader]) PoolDatabase)
-&gt; StateT PoolDatabase (Either PoolErr) (Map PoolId [BlockHeader])
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;pools&quot;
  ((Map PoolId [BlockHeader]
    -&gt; Const (Map PoolId [BlockHeader]) (Map PoolId [BlockHeader]))
   -&gt; PoolDatabase -&gt; Const (Map PoolId [BlockHeader]) PoolDatabase)
(Map PoolId [BlockHeader]
 -&gt; Const (Map PoolId [BlockHeader]) (Map PoolId [BlockHeader]))
-&gt; PoolDatabase -&gt; Const (Map PoolId [BlockHeader]) PoolDatabase
</span><a href="#local-6989586621682466661"><span class="hs-var">#pools</span></a></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutStakeDistribution"><span class="hs-identifier hs-type">mPutStakeDistribution</span></a></span><span>
</span><span id="line-248"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-type">Quantity</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;lovelace&quot;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span id="mPutStakeDistribution"><span class="annot"><span class="annottext">mPutStakeDistribution :: EpochNo -&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)] -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mPutStakeDistribution"><span class="hs-identifier hs-var hs-var">mPutStakeDistribution</span></a></span></span><span> </span><span id="local-6989586621682466660"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466660"><span class="hs-identifier hs-var">epoch</span></a></span></span><span> </span><span id="local-6989586621682466659"><span class="annot"><span class="annottext">[(PoolId, Quantity &quot;lovelace&quot; Word64)]
</span><a href="#local-6989586621682466659"><span class="hs-identifier hs-var">distribution</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-250"></span><span>    </span><span class="annot"><span class="annottext">((Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
  -&gt; Identity (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
    -&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;distributions&quot;
  ((Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
    -&gt; Identity (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
 -&gt; Identity (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466658"><span class="hs-var">#distributions</span></a></span><span> </span><span class="annot"><span class="annottext">((Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
  -&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
 -&gt; ModelOp ())
-&gt; (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
    -&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466660"><span class="hs-identifier hs-var">epoch</span></a></span><span> </span><span class="annot"><span class="annottext">[(PoolId, Quantity &quot;lovelace&quot; Word64)]
</span><a href="#local-6989586621682466659"><span class="hs-identifier hs-var">distribution</span></a></span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadStakeDistribution"><span class="hs-identifier hs-type">mReadStakeDistribution</span></a></span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-type">Quantity</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;lovelace&quot;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-254"></span><span id="mReadStakeDistribution"><span class="annot"><span class="annottext">mReadStakeDistribution :: EpochNo -&gt; ModelOp [(PoolId, Quantity &quot;lovelace&quot; Word64)]
</span><a href="Cardano.Pool.DB.Model.html#mReadStakeDistribution"><span class="hs-identifier hs-var hs-var">mReadStakeDistribution</span></a></span></span><span> </span><span id="local-6989586621682466656"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466656"><span class="hs-identifier hs-var">epoch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><span class="annottext">[(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; EpochNo
-&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.findWithDefault</span></a></span><span> </span><span class="annot"><span class="annottext">[(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466656"><span class="hs-identifier hs-var">epoch</span></a></span><span> </span><span class="annot"><span class="annottext">(Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
 -&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; ModelOp [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
  -&gt; Const
       (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
       (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]))
 -&gt; PoolDatabase
 -&gt; Const
      (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]) PoolDatabase)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;distributions&quot;
  ((Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
    -&gt; Const
         (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
         (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]))
   -&gt; PoolDatabase
   -&gt; Const
        (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]) PoolDatabase)
(Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
 -&gt; Const
      (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
      (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]))
-&gt; PoolDatabase
-&gt; Const
     (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]) PoolDatabase
</span><a href="#local-6989586621682466654"><span class="hs-var">#distributions</span></a></span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutPoolRegistration"><span class="hs-identifier hs-type">mPutPoolRegistration</span></a></span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#CertificatePublicationTime"><span class="hs-identifier hs-type">CertificatePublicationTime</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRegistrationCertificate"><span class="hs-identifier hs-type">PoolRegistrationCertificate</span></a></span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span id="mPutPoolRegistration"><span class="annot"><span class="annottext">mPutPoolRegistration :: CertificatePublicationTime
-&gt; PoolRegistrationCertificate -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mPutPoolRegistration"><span class="hs-identifier hs-var hs-var">mPutPoolRegistration</span></a></span></span><span> </span><span id="local-6989586621682466653"><span class="annot"><span class="annottext">CertificatePublicationTime
</span><a href="#local-6989586621682466653"><span class="hs-identifier hs-var">cpt</span></a></span></span><span> </span><span id="local-6989586621682466652"><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682466652"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>    </span><span class="annot"><span class="annottext">((Map PoolId [PoolOwner] -&gt; Identity (Map PoolId [PoolOwner]))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map PoolId [PoolOwner] -&gt; Map PoolId [PoolOwner]) -&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;owners&quot;
  ((Map PoolId [PoolOwner] -&gt; Identity (Map PoolId [PoolOwner]))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map PoolId [PoolOwner] -&gt; Identity (Map PoolId [PoolOwner]))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466651"><span class="hs-var">#owners</span></a></span><span>
</span><span id="line-263"></span><span>        </span><span class="annot"><span class="annottext">((Map PoolId [PoolOwner] -&gt; Map PoolId [PoolOwner]) -&gt; ModelOp ())
-&gt; (Map PoolId [PoolOwner] -&gt; Map PoolId [PoolOwner]) -&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
-&gt; [PoolOwner] -&gt; Map PoolId [PoolOwner] -&gt; Map PoolId [PoolOwner]
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466650"><span class="hs-identifier hs-var">poolId</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolOwner]
</span><a href="#local-6989586621682466649"><span class="hs-identifier hs-var">poolOwners</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
  -&gt; Identity
       (Map
          (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;registrations&quot;
  ((Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Identity
         (Map
            (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map
   (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Identity
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466648"><span class="hs-var">#registrations</span></a></span><span>
</span><span id="line-265"></span><span>        </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
  -&gt; Map
       (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
 -&gt; ModelOp ())
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(CertificatePublicationTime, PoolId)
-&gt; PoolRegistrationCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CertificatePublicationTime
</span><a href="#local-6989586621682466653"><span class="hs-identifier hs-var">cpt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466650"><span class="hs-identifier hs-var">poolId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682466652"><span class="hs-identifier hs-var">cert</span></a></span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-267"></span><span>    </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRegistrationCertificate"><span class="hs-identifier hs-type">PoolRegistrationCertificate</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621682466650"><span class="annot"><span class="annottext">PoolId
$sel:poolId:PoolRegistrationCertificate :: PoolRegistrationCertificate -&gt; PoolId
poolId :: PoolId
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3ApoolId%3APoolRegistrationCertificate"><span class="hs-identifier hs-var hs-var">poolId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682466649"><span class="annot"><span class="annottext">[PoolOwner]
$sel:poolOwners:PoolRegistrationCertificate :: PoolRegistrationCertificate -&gt; [PoolOwner]
poolOwners :: [PoolOwner]
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3ApoolOwners%3APoolRegistrationCertificate"><span class="hs-identifier hs-var hs-var">poolOwners</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682466652"><span class="hs-identifier hs-var">cert</span></a></span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadPoolRegistration"><span class="hs-identifier hs-type">mReadPoolRegistration</span></a></span><span>
</span><span id="line-270"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span>
</span><span id="line-272"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#CertificatePublicationTime"><span class="hs-identifier hs-type">CertificatePublicationTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRegistrationCertificate"><span class="hs-identifier hs-type">PoolRegistrationCertificate</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span id="mReadPoolRegistration"><span class="annot"><span class="annottext">mReadPoolRegistration :: PoolId
-&gt; ModelOp
     (Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
</span><a href="Cardano.Pool.DB.Model.html#mReadPoolRegistration"><span class="hs-identifier hs-var hs-var">mReadPoolRegistration</span></a></span></span><span> </span><span id="local-6989586621682466644"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466644"><span class="hs-identifier hs-var">poolId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-274"></span><span>    </span><span class="annot"><span class="annottext">(((CertificatePublicationTime, PoolId),
  PoolRegistrationCertificate)
 -&gt; (CertificatePublicationTime, PoolRegistrationCertificate))
-&gt; Maybe
     ((CertificatePublicationTime, PoolId), PoolRegistrationCertificate)
-&gt; Maybe (CertificatePublicationTime, PoolRegistrationCertificate)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((CertificatePublicationTime, PoolId)
 -&gt; CertificatePublicationTime)
-&gt; ((CertificatePublicationTime, PoolId),
    PoolRegistrationCertificate)
-&gt; (CertificatePublicationTime, PoolRegistrationCertificate)
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">first</span></a></span><span> </span><span class="annot"><span class="annottext">(CertificatePublicationTime, PoolId) -&gt; CertificatePublicationTime
forall a b. (a, b) -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe
   ((CertificatePublicationTime, PoolId), PoolRegistrationCertificate)
 -&gt; Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Maybe
         ((CertificatePublicationTime, PoolId),
          PoolRegistrationCertificate))
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Maybe (CertificatePublicationTime, PoolRegistrationCertificate)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Maybe
     ((CertificatePublicationTime, PoolId), PoolRegistrationCertificate)
forall k a. Map k a -&gt; Maybe (k, a)
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookupMax</span></a></span><span> </span><span class="annot"><span class="annottext">(Map
   (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Maybe
      ((CertificatePublicationTime, PoolId),
       PoolRegistrationCertificate))
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Maybe
     ((CertificatePublicationTime, PoolId), PoolRegistrationCertificate)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((CertificatePublicationTime, PoolId)
 -&gt; PoolRegistrationCertificate -&gt; Bool)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filterWithKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolId
-&gt; (CertificatePublicationTime, PoolId)
-&gt; PoolRegistrationCertificate
-&gt; Bool
forall a a p. Eq a =&gt; a -&gt; (a, a) -&gt; p -&gt; Bool
</span><a href="#local-6989586621682466641"><span class="hs-identifier hs-var">only</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466644"><span class="hs-identifier hs-var">poolId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map
   (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; ModelOp
     (Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-275"></span><span>        </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
  -&gt; Const
       (Map
          (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
       (Map
          (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
 -&gt; PoolDatabase
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
      PoolDatabase)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;registrations&quot;
  ((Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Const
         (Map
            (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
         (Map
            (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
   -&gt; PoolDatabase
   -&gt; Const
        (Map
           (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
        PoolDatabase)
(Map
   (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
-&gt; PoolDatabase
-&gt; Const
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
     PoolDatabase
</span><a href="#local-6989586621682466640"><span class="hs-var">#registrations</span></a></span><span>
</span><span id="line-276"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-277"></span><span>    </span><span id="local-6989586621682466641"><span class="annot"><span class="annottext">only :: a -&gt; (a, a) -&gt; p -&gt; Bool
</span><a href="#local-6989586621682466641"><span class="hs-identifier hs-var hs-var">only</span></a></span></span><span> </span><span id="local-6989586621682466639"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682466639"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682466638"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682466638"><span class="hs-identifier hs-var">k'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682466639"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682466638"><span class="hs-identifier hs-var">k'</span></a></span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutPoolRetirement"><span class="hs-identifier hs-type">mPutPoolRetirement</span></a></span><span>
</span><span id="line-280"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#CertificatePublicationTime"><span class="hs-identifier hs-type">CertificatePublicationTime</span></a></span><span>
</span><span id="line-281"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRetirementCertificate"><span class="hs-identifier hs-type">PoolRetirementCertificate</span></a></span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span id="mPutPoolRetirement"><span class="annot"><span class="annottext">mPutPoolRetirement :: CertificatePublicationTime
-&gt; PoolRetirementCertificate -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mPutPoolRetirement"><span class="hs-identifier hs-var hs-var">mPutPoolRetirement</span></a></span></span><span> </span><span id="local-6989586621682466637"><span class="annot"><span class="annottext">CertificatePublicationTime
</span><a href="#local-6989586621682466637"><span class="hs-identifier hs-var">cpt</span></a></span></span><span> </span><span id="local-6989586621682466636"><span class="annot"><span class="annottext">PoolRetirementCertificate
</span><a href="#local-6989586621682466636"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-284"></span><span>    </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRetirementCertificate
  -&gt; Identity
       (Map
          (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
    -&gt; Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;retirements&quot;
  ((Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
    -&gt; Identity
         (Map
            (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map (CertificatePublicationTime, PoolId) PoolRetirementCertificate
 -&gt; Identity
      (Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466635"><span class="hs-var">#retirements</span></a></span><span> </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRetirementCertificate
  -&gt; Map
       (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
 -&gt; ModelOp ())
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
    -&gt; Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(CertificatePublicationTime, PoolId)
-&gt; PoolRetirementCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CertificatePublicationTime
</span><a href="#local-6989586621682466637"><span class="hs-identifier hs-var">cpt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466634"><span class="hs-identifier hs-var">poolId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PoolRetirementCertificate
</span><a href="#local-6989586621682466636"><span class="hs-identifier hs-var">cert</span></a></span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-286"></span><span>    </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRetirementCertificate"><span class="hs-identifier hs-type">PoolRetirementCertificate</span></a></span><span> </span><span id="local-6989586621682466634"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466634"><span class="hs-identifier hs-var">poolId</span></a></span></span><span> </span><span id="local-6989586621682466632"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466632"><span class="hs-identifier hs-var">_retirementEpoch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolRetirementCertificate
</span><a href="#local-6989586621682466636"><span class="hs-identifier hs-var">cert</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadPoolRetirement"><span class="hs-identifier hs-type">mReadPoolRetirement</span></a></span><span>
</span><span id="line-289"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span>
</span><span id="line-290"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span>
</span><span id="line-291"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#CertificatePublicationTime"><span class="hs-identifier hs-type">CertificatePublicationTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRetirementCertificate"><span class="hs-identifier hs-type">PoolRetirementCertificate</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-292"></span><span id="mReadPoolRetirement"><span class="annot"><span class="annottext">mReadPoolRetirement :: PoolId
-&gt; ModelOp
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate))
</span><a href="Cardano.Pool.DB.Model.html#mReadPoolRetirement"><span class="hs-identifier hs-var hs-var">mReadPoolRetirement</span></a></span></span><span> </span><span id="local-6989586621682466631"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466631"><span class="hs-identifier hs-var">poolId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-293"></span><span>    </span><span class="annot"><span class="annottext">(((CertificatePublicationTime, PoolId), PoolRetirementCertificate)
 -&gt; (CertificatePublicationTime, PoolRetirementCertificate))
-&gt; Maybe
     ((CertificatePublicationTime, PoolId), PoolRetirementCertificate)
-&gt; Maybe (CertificatePublicationTime, PoolRetirementCertificate)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((CertificatePublicationTime, PoolId)
 -&gt; CertificatePublicationTime)
-&gt; ((CertificatePublicationTime, PoolId),
    PoolRetirementCertificate)
-&gt; (CertificatePublicationTime, PoolRetirementCertificate)
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">first</span></a></span><span> </span><span class="annot"><span class="annottext">(CertificatePublicationTime, PoolId) -&gt; CertificatePublicationTime
forall a b. (a, b) -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe
   ((CertificatePublicationTime, PoolId), PoolRetirementCertificate)
 -&gt; Maybe (CertificatePublicationTime, PoolRetirementCertificate))
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
    -&gt; Maybe
         ((CertificatePublicationTime, PoolId), PoolRetirementCertificate))
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
-&gt; Maybe (CertificatePublicationTime, PoolRetirementCertificate)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map (CertificatePublicationTime, PoolId) PoolRetirementCertificate
-&gt; Maybe
     ((CertificatePublicationTime, PoolId), PoolRetirementCertificate)
forall k a. Map k a -&gt; Maybe (k, a)
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookupMax</span></a></span><span> </span><span class="annot"><span class="annottext">(Map (CertificatePublicationTime, PoolId) PoolRetirementCertificate
 -&gt; Maybe
      ((CertificatePublicationTime, PoolId), PoolRetirementCertificate))
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
    -&gt; Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
-&gt; Maybe
     ((CertificatePublicationTime, PoolId), PoolRetirementCertificate)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((CertificatePublicationTime, PoolId)
 -&gt; PoolRetirementCertificate -&gt; Bool)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filterWithKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolId
-&gt; (CertificatePublicationTime, PoolId)
-&gt; PoolRetirementCertificate
-&gt; Bool
forall a a p. Eq a =&gt; a -&gt; (a, a) -&gt; p -&gt; Bool
</span><a href="#local-6989586621682466630"><span class="hs-identifier hs-var">only</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466631"><span class="hs-identifier hs-var">poolId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><span class="annottext">(Map (CertificatePublicationTime, PoolId) PoolRetirementCertificate
 -&gt; Maybe (CertificatePublicationTime, PoolRetirementCertificate))
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
-&gt; ModelOp
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRetirementCertificate
  -&gt; Const
       (Map
          (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
       (Map
          (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
 -&gt; PoolDatabase
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
      PoolDatabase)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;retirements&quot;
  ((Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
    -&gt; Const
         (Map
            (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
         (Map
            (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
   -&gt; PoolDatabase
   -&gt; Const
        (Map
           (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
        PoolDatabase)
(Map (CertificatePublicationTime, PoolId) PoolRetirementCertificate
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
      (Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
-&gt; PoolDatabase
-&gt; Const
     (Map
        (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
     PoolDatabase
</span><a href="#local-6989586621682466629"><span class="hs-var">#retirements</span></a></span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-296"></span><span>    </span><span id="local-6989586621682466630"><span class="annot"><span class="annottext">only :: a -&gt; (a, a) -&gt; p -&gt; Bool
</span><a href="#local-6989586621682466630"><span class="hs-identifier hs-var hs-var">only</span></a></span></span><span> </span><span id="local-6989586621682466628"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682466628"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682466627"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682466627"><span class="hs-identifier hs-var">k'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682466628"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682466627"><span class="hs-identifier hs-var">k'</span></a></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mListPoolLifeCycleData"><span class="hs-identifier hs-type">mListPoolLifeCycleData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolLifeCycleStatus"><span class="hs-identifier hs-type">PoolLifeCycleStatus</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-299"></span><span id="mListPoolLifeCycleData"><span class="annot"><span class="annottext">mListPoolLifeCycleData :: EpochNo -&gt; ModelOp [PoolLifeCycleStatus]
</span><a href="Cardano.Pool.DB.Model.html#mListPoolLifeCycleData"><span class="hs-identifier hs-var hs-var">mListPoolLifeCycleData</span></a></span></span><span> </span><span id="local-6989586621682466626"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466626"><span class="hs-identifier hs-var">epoch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-300"></span><span>    </span><span id="local-6989586621682466625"><span class="annot"><span class="annottext">[PoolId]
</span><a href="#local-6989586621682466625"><span class="hs-identifier hs-var">registeredPools</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ModelOp [PoolId]
</span><a href="Cardano.Pool.DB.Model.html#mListRegisteredPools"><span class="hs-identifier hs-var">mListRegisteredPools</span></a></span><span>
</span><span id="line-301"></span><span>    </span><span id="local-6989586621682466624"><span class="annot"><span class="annottext">[PoolId]
</span><a href="#local-6989586621682466624"><span class="hs-identifier hs-var">retiredPools</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PoolRetirementCertificate -&gt; PoolId)
-&gt; [PoolRetirementCertificate] -&gt; [PoolId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((PoolId -&gt; Const PoolId PoolId)
 -&gt; PoolRetirementCertificate
 -&gt; Const PoolId PoolRetirementCertificate)
-&gt; PoolRetirementCertificate -&gt; PoolId
forall a s. ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; s -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;poolId&quot;
  ((PoolId -&gt; Const PoolId PoolId)
   -&gt; PoolRetirementCertificate
   -&gt; Const PoolId PoolRetirementCertificate)
(PoolId -&gt; Const PoolId PoolId)
-&gt; PoolRetirementCertificate
-&gt; Const PoolId PoolRetirementCertificate
</span><a href="#local-6989586621682466623"><span class="hs-var">#poolId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PoolRetirementCertificate] -&gt; [PoolId])
-&gt; StateT PoolDatabase (Either PoolErr) [PoolRetirementCertificate]
-&gt; ModelOp [PoolId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
-&gt; StateT PoolDatabase (Either PoolErr) [PoolRetirementCertificate]
</span><a href="Cardano.Pool.DB.Model.html#mListRetiredPools"><span class="hs-identifier hs-var">mListRetiredPools</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466626"><span class="hs-identifier hs-var">epoch</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682466622"><span class="annot"><span class="annottext">nonRetiredPools :: [PoolId]
</span><a href="#local-6989586621682466622"><span class="hs-identifier hs-var hs-var">nonRetiredPools</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set PoolId -&gt; [PoolId]
forall a. Set a -&gt; [a]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(Set PoolId -&gt; [PoolId]) -&gt; Set PoolId -&gt; [PoolId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Set PoolId -&gt; Set PoolId -&gt; Set PoolId
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.difference</span></a></span><span>
</span><span id="line-303"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PoolId] -&gt; Set PoolId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolId]
</span><a href="#local-6989586621682466625"><span class="hs-identifier hs-var">registeredPools</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PoolId] -&gt; Set PoolId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolId]
</span><a href="#local-6989586621682466624"><span class="hs-identifier hs-var">retiredPools</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>    </span><span class="annot"><span class="annottext">(PoolId
 -&gt; StateT PoolDatabase (Either PoolErr) PoolLifeCycleStatus)
-&gt; [PoolId] -&gt; ModelOp [PoolLifeCycleStatus]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId -&gt; StateT PoolDatabase (Either PoolErr) PoolLifeCycleStatus
</span><a href="Cardano.Pool.DB.Model.html#mReadPoolLifeCycleStatus"><span class="hs-identifier hs-var">mReadPoolLifeCycleStatus</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolId]
</span><a href="#local-6989586621682466622"><span class="hs-identifier hs-var">nonRetiredPools</span></a></span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mListRegisteredPools"><span class="hs-identifier hs-type">mListRegisteredPools</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-308"></span><span id="mListRegisteredPools"><span class="annot"><span class="annottext">mListRegisteredPools :: ModelOp [PoolId]
</span><a href="Cardano.Pool.DB.Model.html#mListRegisteredPools"><span class="hs-identifier hs-var hs-var">mListRegisteredPools</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-309"></span><span>    </span><span class="annot"><span class="annottext">Set PoolId -&gt; [PoolId]
forall a. Set a -&gt; [a]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(Set PoolId -&gt; [PoolId])
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Set PoolId)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; [PoolId]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((CertificatePublicationTime, PoolId) -&gt; PoolId)
-&gt; Set (CertificatePublicationTime, PoolId) -&gt; Set PoolId
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.map</span></a></span><span> </span><span class="annot"><span class="annottext">(CertificatePublicationTime, PoolId) -&gt; PoolId
forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">(Set (CertificatePublicationTime, PoolId) -&gt; Set PoolId)
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Set (CertificatePublicationTime, PoolId))
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Set PoolId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Set (CertificatePublicationTime, PoolId)
forall k a. Map k a -&gt; Set k
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.keysSet</span></a></span><span> </span><span class="annot"><span class="annottext">(Map
   (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; [PoolId])
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; ModelOp [PoolId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
  -&gt; Const
       (Map
          (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
       (Map
          (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
 -&gt; PoolDatabase
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
      PoolDatabase)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;registrations&quot;
  ((Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Const
         (Map
            (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
         (Map
            (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
   -&gt; PoolDatabase
   -&gt; Const
        (Map
           (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
        PoolDatabase)
(Map
   (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
-&gt; PoolDatabase
-&gt; Const
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
     PoolDatabase
</span><a href="#local-6989586621682466615"><span class="hs-var">#registrations</span></a></span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mListRetiredPools"><span class="hs-identifier hs-type">mListRetiredPools</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRetirementCertificate"><span class="hs-identifier hs-type">PoolRetirementCertificate</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-312"></span><span id="mListRetiredPools"><span class="annot"><span class="annottext">mListRetiredPools :: EpochNo
-&gt; StateT PoolDatabase (Either PoolErr) [PoolRetirementCertificate]
</span><a href="Cardano.Pool.DB.Model.html#mListRetiredPools"><span class="hs-identifier hs-var hs-var">mListRetiredPools</span></a></span></span><span> </span><span id="local-6989586621682466614"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466614"><span class="hs-identifier hs-var">epochNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-313"></span><span>    </span><span id="local-6989586621682466613"><span class="annot"><span class="annottext">Map (CertificatePublicationTime, PoolId) (Maybe EpochNo)
</span><a href="#local-6989586621682466613"><span class="hs-identifier hs-var">retirements</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PoolRetirementCertificate -&gt; Maybe EpochNo)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
-&gt; Map (CertificatePublicationTime, PoolId) (Maybe EpochNo)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpochNo -&gt; Maybe EpochNo
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(EpochNo -&gt; Maybe EpochNo)
-&gt; (PoolRetirementCertificate -&gt; EpochNo)
-&gt; PoolRetirementCertificate
-&gt; Maybe EpochNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((EpochNo -&gt; Const EpochNo EpochNo)
 -&gt; PoolRetirementCertificate
 -&gt; Const EpochNo PoolRetirementCertificate)
-&gt; PoolRetirementCertificate -&gt; EpochNo
forall a s. ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; s -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;retirementEpoch&quot;
  ((EpochNo -&gt; Const EpochNo EpochNo)
   -&gt; PoolRetirementCertificate
   -&gt; Const EpochNo PoolRetirementCertificate)
(EpochNo -&gt; Const EpochNo EpochNo)
-&gt; PoolRetirementCertificate
-&gt; Const EpochNo PoolRetirementCertificate
</span><a href="#local-6989586621682466612"><span class="hs-var">#retirementEpoch</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map (CertificatePublicationTime, PoolId) PoolRetirementCertificate
 -&gt; Map (CertificatePublicationTime, PoolId) (Maybe EpochNo))
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map (CertificatePublicationTime, PoolId) (Maybe EpochNo))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRetirementCertificate
  -&gt; Const
       (Map
          (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
       (Map
          (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
 -&gt; PoolDatabase
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
      PoolDatabase)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;retirements&quot;
  ((Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
    -&gt; Const
         (Map
            (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
         (Map
            (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
   -&gt; PoolDatabase
   -&gt; Const
        (Map
           (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
        PoolDatabase)
(Map (CertificatePublicationTime, PoolId) PoolRetirementCertificate
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
      (Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
-&gt; PoolDatabase
-&gt; Const
     (Map
        (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
     PoolDatabase
</span><a href="#local-6989586621682466611"><span class="hs-var">#retirements</span></a></span><span>
</span><span id="line-314"></span><span>    </span><span id="local-6989586621682466610"><span class="annot"><span class="annottext">Map (CertificatePublicationTime, PoolId) (Maybe EpochNo)
</span><a href="#local-6989586621682466610"><span class="hs-identifier hs-var">retirementCancellations</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PoolRegistrationCertificate -&gt; Maybe EpochNo)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Map (CertificatePublicationTime, PoolId) (Maybe EpochNo)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe EpochNo -&gt; PoolRegistrationCertificate -&gt; Maybe EpochNo
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EpochNo
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map
   (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Map (CertificatePublicationTime, PoolId) (Maybe EpochNo))
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map (CertificatePublicationTime, PoolId) (Maybe EpochNo))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
  -&gt; Const
       (Map
          (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
       (Map
          (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
 -&gt; PoolDatabase
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
      PoolDatabase)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;registrations&quot;
  ((Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Const
         (Map
            (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
         (Map
            (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
   -&gt; PoolDatabase
   -&gt; Const
        (Map
           (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
        PoolDatabase)
(Map
   (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
-&gt; PoolDatabase
-&gt; Const
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
     PoolDatabase
</span><a href="#local-6989586621682466609"><span class="hs-var">#registrations</span></a></span><span>
</span><span id="line-315"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682466608"><span class="annot"><span class="annottext">retiredPools :: Map PoolId EpochNo
</span><a href="#local-6989586621682466608"><span class="hs-identifier hs-var hs-var">retiredPools</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-316"></span><span>            </span><span class="hs-comment">-- First, merge the retirements map with the cancellations map.</span><span>
</span><span id="line-317"></span><span>            </span><span class="hs-comment">-- A retirement is represented as a 'Just retirementEpoch' value.</span><span>
</span><span id="line-318"></span><span>            </span><span class="hs-comment">-- A retirement cancellation is represented as a 'Nothing' value.</span><span>
</span><span id="line-319"></span><span>            </span><span class="annot"><span class="annottext">Map (CertificatePublicationTime, PoolId) (Maybe EpochNo)
-&gt; Map (CertificatePublicationTime, PoolId) (Maybe EpochNo)
-&gt; Map (CertificatePublicationTime, PoolId) (Maybe EpochNo)
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.union</span></a></span><span> </span><span class="annot"><span class="annottext">Map (CertificatePublicationTime, PoolId) (Maybe EpochNo)
</span><a href="#local-6989586621682466613"><span class="hs-identifier hs-var">retirements</span></a></span><span> </span><span class="annot"><span class="annottext">Map (CertificatePublicationTime, PoolId) (Maybe EpochNo)
</span><a href="#local-6989586621682466610"><span class="hs-identifier hs-var">retirementCancellations</span></a></span><span>
</span><span id="line-320"></span><span>            </span><span class="hs-comment">-- Keep only the most-recently published retirement epoch for each</span><span>
</span><span id="line-321"></span><span>            </span><span class="hs-comment">-- pool (which will be 'Nothing' in the case of a cancellation):</span><span>
</span><span id="line-322"></span><span>            </span><span class="annot"><span class="annottext">Map (CertificatePublicationTime, PoolId) (Maybe EpochNo)
-&gt; (Map (CertificatePublicationTime, PoolId) (Maybe EpochNo)
    -&gt; Map PoolId (Maybe EpochNo))
-&gt; Map PoolId (Maybe EpochNo)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (CertificatePublicationTime, PoolId) (Maybe EpochNo)
-&gt; Map PoolId (Maybe EpochNo)
forall k publicationTime v.
Ord k =&gt;
Map (publicationTime, k) v -&gt; Map k v
</span><a href="#local-6989586621682466606"><span class="hs-identifier hs-var">retainOnlyMostRecent</span></a></span><span>
</span><span id="line-323"></span><span>            </span><span class="hs-comment">-- Remove pools that have had their retirements cancelled:</span><span>
</span><span id="line-324"></span><span>            </span><span class="annot"><span class="annottext">Map PoolId (Maybe EpochNo)
-&gt; (Map PoolId (Maybe EpochNo) -&gt; Map PoolId EpochNo)
-&gt; Map PoolId EpochNo
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Map PoolId (Maybe EpochNo) -&gt; Map PoolId EpochNo
forall k v. Map k (Maybe v) -&gt; Map k v
</span><a href="#local-6989586621682466605"><span class="hs-identifier hs-var">pruneEmptyValues</span></a></span><span>
</span><span id="line-325"></span><span>            </span><span class="hs-comment">-- Remove pools that have not yet retired:</span><span>
</span><span id="line-326"></span><span>            </span><span class="annot"><span class="annottext">Map PoolId EpochNo
-&gt; (Map PoolId EpochNo -&gt; Map PoolId EpochNo) -&gt; Map PoolId EpochNo
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(EpochNo -&gt; Bool) -&gt; Map PoolId EpochNo -&gt; Map PoolId EpochNo
forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpochNo -&gt; EpochNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466614"><span class="hs-identifier hs-var">epochNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">Map PoolId EpochNo
</span><a href="#local-6989586621682466608"><span class="hs-identifier hs-var">retiredPools</span></a></span><span>
</span><span id="line-328"></span><span>        </span><span class="annot"><span class="annottext">Map PoolId EpochNo
-&gt; (Map PoolId EpochNo -&gt; [(PoolId, EpochNo)])
-&gt; [(PoolId, EpochNo)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Map PoolId EpochNo -&gt; [(PoolId, EpochNo)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.toList</span></a></span><span>
</span><span id="line-329"></span><span>        </span><span class="annot"><span class="annottext">[(PoolId, EpochNo)]
-&gt; ([(PoolId, EpochNo)] -&gt; [PoolRetirementCertificate])
-&gt; [PoolRetirementCertificate]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">((PoolId, EpochNo) -&gt; PoolRetirementCertificate)
-&gt; [(PoolId, EpochNo)] -&gt; [PoolRetirementCertificate]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PoolId -&gt; EpochNo -&gt; PoolRetirementCertificate)
-&gt; (PoolId, EpochNo) -&gt; PoolRetirementCertificate
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">uncurry</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId -&gt; EpochNo -&gt; PoolRetirementCertificate
</span><a href="Cardano.Wallet.Primitive.Types.html#PoolRetirementCertificate"><span class="hs-identifier hs-var">PoolRetirementCertificate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span>        </span><span class="annot"><span class="annottext">[PoolRetirementCertificate]
-&gt; ([PoolRetirementCertificate]
    -&gt; StateT
         PoolDatabase (Either PoolErr) [PoolRetirementCertificate])
-&gt; StateT PoolDatabase (Either PoolErr) [PoolRetirementCertificate]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolRetirementCertificate]
-&gt; StateT PoolDatabase (Either PoolErr) [PoolRetirementCertificate]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-332"></span><span>    </span><span id="local-6989586621682466874"><span id="local-6989586621682466875"><span class="annot"><a href="#local-6989586621682466605"><span class="hs-identifier hs-type">pruneEmptyValues</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682466875"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682466874"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682466875"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682466874"><span class="hs-identifier hs-type">v</span></a></span></span></span><span>
</span><span id="line-333"></span><span>    </span><span id="local-6989586621682466605"><span class="annot"><span class="annottext">pruneEmptyValues :: Map k (Maybe v) -&gt; Map k v
</span><a href="#local-6989586621682466605"><span class="hs-identifier hs-var hs-var">pruneEmptyValues</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe v -&gt; Maybe v) -&gt; Map k (Maybe v) -&gt; Map k v
forall a b k. (a -&gt; Maybe b) -&gt; Map k a -&gt; Map k b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.mapMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe v -&gt; Maybe v
forall a. a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span>    </span><span id="local-6989586621682466876"><span id="local-6989586621682466877"><span id="local-6989586621682466878"><span class="annot"><a href="#local-6989586621682466606"><span class="hs-identifier hs-type">retainOnlyMostRecent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682466878"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682466877"><span class="hs-identifier hs-type">publicationTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682466878"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682466876"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682466878"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682466876"><span class="hs-identifier hs-type">v</span></a></span></span></span></span><span>
</span><span id="line-336"></span><span>    </span><span id="local-6989586621682466606"><span class="annot"><span class="annottext">retainOnlyMostRecent :: Map (publicationTime, k) v -&gt; Map k v
</span><a href="#local-6989586621682466606"><span class="hs-identifier hs-var hs-var">retainOnlyMostRecent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-337"></span><span>        </span><span class="hs-comment">-- If more than one key from the original map is mapped to the same key</span><span>
</span><span id="line-338"></span><span>        </span><span class="hs-comment">-- in the result map, 'Map.mapKeys' guarantees to retain only the value</span><span>
</span><span id="line-339"></span><span>        </span><span class="hs-comment">-- corresponding to the greatest of the original keys.</span><span>
</span><span id="line-340"></span><span>        </span><span class="annot"><span class="annottext">((publicationTime, k) -&gt; k)
-&gt; Map (publicationTime, k) v -&gt; Map k v
forall k2 k1 a. Ord k2 =&gt; (k1 -&gt; k2) -&gt; Map k1 a -&gt; Map k2 a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.mapKeys</span></a></span><span> </span><span class="annot"><span class="annottext">(publicationTime, k) -&gt; k
forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span>
</span><span id="line-341"></span><span>
</span><span id="line-342"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadPoolLifeCycleStatus"><span class="hs-identifier hs-type">mReadPoolLifeCycleStatus</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolLifeCycleStatus"><span class="hs-identifier hs-type">PoolLifeCycleStatus</span></a></span><span>
</span><span id="line-343"></span><span id="mReadPoolLifeCycleStatus"><span class="annot"><span class="annottext">mReadPoolLifeCycleStatus :: PoolId -&gt; StateT PoolDatabase (Either PoolErr) PoolLifeCycleStatus
</span><a href="Cardano.Pool.DB.Model.html#mReadPoolLifeCycleStatus"><span class="hs-identifier hs-var hs-var">mReadPoolLifeCycleStatus</span></a></span></span><span> </span><span id="local-6989586621682466598"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466598"><span class="hs-identifier hs-var">poolId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-344"></span><span>    </span><span class="annot"><span class="annottext">Maybe (CertificatePublicationTime, PoolRegistrationCertificate)
-&gt; Maybe (CertificatePublicationTime, PoolRetirementCertificate)
-&gt; PoolLifeCycleStatus
forall publicationTime.
(Ord publicationTime, Show publicationTime) =&gt;
Maybe (publicationTime, PoolRegistrationCertificate)
-&gt; Maybe (publicationTime, PoolRetirementCertificate)
-&gt; PoolLifeCycleStatus
</span><a href="Cardano.Pool.DB.html#determinePoolLifeCycleStatus"><span class="hs-identifier hs-var">determinePoolLifeCycleStatus</span></a></span><span>
</span><span id="line-345"></span><span>        </span><span class="annot"><span class="annottext">(Maybe (CertificatePublicationTime, PoolRegistrationCertificate)
 -&gt; Maybe (CertificatePublicationTime, PoolRetirementCertificate)
 -&gt; PoolLifeCycleStatus)
-&gt; ModelOp
     (Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate)
      -&gt; PoolLifeCycleStatus)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map
  (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Maybe (CertificatePublicationTime, PoolRegistrationCertificate)
forall publicationTime certificate.
Map (publicationTime, PoolId) certificate
-&gt; Maybe (publicationTime, certificate)
</span><a href="#local-6989586621682466597"><span class="hs-identifier hs-var">lookupLatestCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">(Map
   (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; ModelOp
     (Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
  -&gt; Const
       (Map
          (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
       (Map
          (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
 -&gt; PoolDatabase
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
      PoolDatabase)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;registrations&quot;
  ((Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Const
         (Map
            (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
         (Map
            (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
   -&gt; PoolDatabase
   -&gt; Const
        (Map
           (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
        PoolDatabase)
(Map
   (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
-&gt; PoolDatabase
-&gt; Const
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
     PoolDatabase
</span><a href="#local-6989586621682466596"><span class="hs-var">#registrations</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>        </span><span class="annot"><span class="annottext">StateT
  PoolDatabase
  (Either PoolErr)
  (Maybe (CertificatePublicationTime, PoolRetirementCertificate)
   -&gt; PoolLifeCycleStatus)
-&gt; ModelOp
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate))
-&gt; StateT PoolDatabase (Either PoolErr) PoolLifeCycleStatus
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (CertificatePublicationTime, PoolId) PoolRetirementCertificate
-&gt; Maybe (CertificatePublicationTime, PoolRetirementCertificate)
forall publicationTime certificate.
Map (publicationTime, PoolId) certificate
-&gt; Maybe (publicationTime, certificate)
</span><a href="#local-6989586621682466597"><span class="hs-identifier hs-var">lookupLatestCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">(Map (CertificatePublicationTime, PoolId) PoolRetirementCertificate
 -&gt; Maybe (CertificatePublicationTime, PoolRetirementCertificate))
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
-&gt; ModelOp
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRetirementCertificate
  -&gt; Const
       (Map
          (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
       (Map
          (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
 -&gt; PoolDatabase
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
      PoolDatabase)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;retirements&quot;
  ((Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
    -&gt; Const
         (Map
            (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
         (Map
            (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
   -&gt; PoolDatabase
   -&gt; Const
        (Map
           (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
        PoolDatabase)
(Map (CertificatePublicationTime, PoolId) PoolRetirementCertificate
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
      (Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
-&gt; PoolDatabase
-&gt; Const
     (Map
        (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
     PoolDatabase
</span><a href="#local-6989586621682466595"><span class="hs-var">#retirements</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-348"></span><span>    </span><span id="local-6989586621682466852"><span id="local-6989586621682466853"><span class="annot"><a href="#local-6989586621682466597"><span class="hs-identifier hs-type">lookupLatestCertificate</span></a></span><span>
</span><span id="line-349"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682466853"><span class="hs-identifier hs-type">publicationTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621682466852"><span class="hs-identifier hs-type">certificate</span></a></span><span>
</span><span id="line-350"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682466853"><span class="hs-identifier hs-type">publicationTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682466852"><span class="hs-identifier hs-type">certificate</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-351"></span><span>    </span><span id="local-6989586621682466597"><span class="annot"><span class="annottext">lookupLatestCertificate :: Map (publicationTime, PoolId) certificate
-&gt; Maybe (publicationTime, certificate)
</span><a href="#local-6989586621682466597"><span class="hs-identifier hs-var hs-var">lookupLatestCertificate</span></a></span></span><span>
</span><span id="line-352"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(((publicationTime, PoolId), certificate)
 -&gt; (publicationTime, certificate))
-&gt; Maybe ((publicationTime, PoolId), certificate)
-&gt; Maybe (publicationTime, certificate)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((publicationTime, PoolId) -&gt; publicationTime)
-&gt; ((publicationTime, PoolId), certificate)
-&gt; (publicationTime, certificate)
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">first</span></a></span><span> </span><span class="annot"><span class="annottext">(publicationTime, PoolId) -&gt; publicationTime
forall a b. (a, b) -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>        </span><span class="annot"><span class="annottext">(Maybe ((publicationTime, PoolId), certificate)
 -&gt; Maybe (publicationTime, certificate))
-&gt; (Map (publicationTime, PoolId) certificate
    -&gt; Maybe ((publicationTime, PoolId), certificate))
-&gt; Map (publicationTime, PoolId) certificate
-&gt; Maybe (publicationTime, certificate)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map (publicationTime, PoolId) certificate
-&gt; Maybe ((publicationTime, PoolId), certificate)
forall k a. Map k a -&gt; Maybe (k, a)
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookupMax</span></a></span><span>
</span><span id="line-354"></span><span>        </span><span class="annot"><span class="annottext">(Map (publicationTime, PoolId) certificate
 -&gt; Maybe ((publicationTime, PoolId), certificate))
-&gt; (Map (publicationTime, PoolId) certificate
    -&gt; Map (publicationTime, PoolId) certificate)
-&gt; Map (publicationTime, PoolId) certificate
-&gt; Maybe ((publicationTime, PoolId), certificate)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((publicationTime, PoolId) -&gt; certificate -&gt; Bool)
-&gt; Map (publicationTime, PoolId) certificate
-&gt; Map (publicationTime, PoolId) certificate
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filterWithKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">publicationTime
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682466594"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466594"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">certificate
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466594"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId -&gt; PoolId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466598"><span class="hs-identifier hs-var">poolId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mUnfetchedPoolMetadataRefs"><span class="hs-identifier hs-type">mUnfetchedPoolMetadataRefs</span></a></span><span>
</span><span id="line-357"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadataUrl"><span class="hs-identifier hs-type">StakePoolMetadataUrl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadataHash"><span class="hs-identifier hs-type">StakePoolMetadataHash</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-359"></span><span id="mUnfetchedPoolMetadataRefs"><span class="annot"><span class="annottext">mUnfetchedPoolMetadataRefs :: Int
-&gt; ModelOp [(PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)]
</span><a href="Cardano.Pool.DB.Model.html#mUnfetchedPoolMetadataRefs"><span class="hs-identifier hs-var hs-var">mUnfetchedPoolMetadataRefs</span></a></span></span><span> </span><span id="local-6989586621682466593"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682466593"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map
  (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Map StakePoolMetadataHash StakePoolMetadata
-&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
-&gt; [(PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)]
</span><a href="#local-6989586621682466592"><span class="hs-identifier hs-var">inner</span></a></span><span>
</span><span id="line-360"></span><span>    </span><span class="annot"><span class="annottext">(Map
   (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Map StakePoolMetadataHash StakePoolMetadata
 -&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
 -&gt; [(PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)])
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map StakePoolMetadataHash StakePoolMetadata
      -&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
      -&gt; [(PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
  -&gt; Const
       (Map
          (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
       (Map
          (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
 -&gt; PoolDatabase
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
      PoolDatabase)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;registrations&quot;
  ((Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Const
         (Map
            (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
         (Map
            (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
   -&gt; PoolDatabase
   -&gt; Const
        (Map
           (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
        PoolDatabase)
(Map
   (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Const
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
-&gt; PoolDatabase
-&gt; Const
     (Map
        (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
     PoolDatabase
</span><a href="#local-6989586621682466591"><span class="hs-var">#registrations</span></a></span><span>
</span><span id="line-361"></span><span>    </span><span class="annot"><span class="annottext">StateT
  PoolDatabase
  (Either PoolErr)
  (Map StakePoolMetadataHash StakePoolMetadata
   -&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
   -&gt; [(PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)])
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map StakePoolMetadataHash StakePoolMetadata)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
      -&gt; [(PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)])
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Map StakePoolMetadataHash StakePoolMetadata
  -&gt; Const
       (Map StakePoolMetadataHash StakePoolMetadata)
       (Map StakePoolMetadataHash StakePoolMetadata))
 -&gt; PoolDatabase
 -&gt; Const
      (Map StakePoolMetadataHash StakePoolMetadata) PoolDatabase)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map StakePoolMetadataHash StakePoolMetadata)
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;metadata&quot;
  ((Map StakePoolMetadataHash StakePoolMetadata
    -&gt; Const
         (Map StakePoolMetadataHash StakePoolMetadata)
         (Map StakePoolMetadataHash StakePoolMetadata))
   -&gt; PoolDatabase
   -&gt; Const
        (Map StakePoolMetadataHash StakePoolMetadata) PoolDatabase)
(Map StakePoolMetadataHash StakePoolMetadata
 -&gt; Const
      (Map StakePoolMetadataHash StakePoolMetadata)
      (Map StakePoolMetadataHash StakePoolMetadata))
-&gt; PoolDatabase
-&gt; Const (Map StakePoolMetadataHash StakePoolMetadata) PoolDatabase
</span><a href="#local-6989586621682466590"><span class="hs-var">#metadata</span></a></span><span>
</span><span id="line-362"></span><span>    </span><span class="annot"><span class="annottext">StateT
  PoolDatabase
  (Either PoolErr)
  (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
   -&gt; [(PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)])
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
-&gt; ModelOp [(PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)]
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
  -&gt; Const
       (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
       (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int))
 -&gt; PoolDatabase
 -&gt; Const
      (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
      PoolDatabase)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;fetchAttempts&quot;
  ((Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
    -&gt; Const
         (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
         (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int))
   -&gt; PoolDatabase
   -&gt; Const
        (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
        PoolDatabase)
(Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
 -&gt; Const
      (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
      (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int))
-&gt; PoolDatabase
-&gt; Const
     (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
     PoolDatabase
</span><a href="#local-6989586621682466589"><span class="hs-var">#fetchAttempts</span></a></span><span>
</span><span id="line-363"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-364"></span><span>    </span><span id="local-6989586621682466592"><span class="annot"><span class="annottext">inner :: Map
  (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Map StakePoolMetadataHash StakePoolMetadata
-&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
-&gt; [(PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)]
</span><a href="#local-6989586621682466592"><span class="hs-identifier hs-var hs-var">inner</span></a></span></span><span> </span><span id="local-6989586621682466588"><span class="annot"><span class="annottext">Map
  (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
</span><a href="#local-6989586621682466588"><span class="hs-identifier hs-var">registrations</span></a></span></span><span> </span><span id="local-6989586621682466587"><span class="annot"><span class="annottext">Map StakePoolMetadataHash StakePoolMetadata
</span><a href="#local-6989586621682466587"><span class="hs-identifier hs-var">metadata</span></a></span></span><span> </span><span id="local-6989586621682466586"><span class="annot"><span class="annottext">Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
</span><a href="#local-6989586621682466586"><span class="hs-identifier hs-var">fetchAttempts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-365"></span><span>        </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
-&gt; (PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="#local-6989586621682466585"><span class="hs-identifier hs-var">toTuple</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolRegistrationCertificate
 -&gt; (PoolId, StakePoolMetadataUrl, StakePoolMetadataHash))
-&gt; [PoolRegistrationCertificate]
-&gt; [(PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [PoolRegistrationCertificate] -&gt; [PoolRegistrationCertificate]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">take</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682466593"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map
  (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; [PoolRegistrationCertificate]
forall k a. Map k a -&gt; [a]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.elems</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
</span><a href="#local-6989586621682466583"><span class="hs-identifier hs-var">unfetched</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-367"></span><span>        </span><span id="local-6989586621682466583"><span class="annot"><span class="annottext">unfetched :: Map
  (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
</span><a href="#local-6989586621682466583"><span class="hs-identifier hs-var hs-var">unfetched</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((PoolRegistrationCertificate -&gt; Bool)
 -&gt; Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; (PoolRegistrationCertificate -&gt; Bool)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolRegistrationCertificate -&gt; Bool)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filter</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
</span><a href="#local-6989586621682466588"><span class="hs-identifier hs-var">registrations</span></a></span><span> </span><span class="annot"><span class="annottext">((PoolRegistrationCertificate -&gt; Bool)
 -&gt; Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; (PoolRegistrationCertificate -&gt; Bool)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682466582"><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682466582"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-368"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
-&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3ApoolMetadata%3APoolRegistrationCertificate"><span class="hs-identifier hs-var hs-var">poolMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682466582"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-369"></span><span>                </span><span class="annot"><span class="annottext">Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-370"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682466580"><span class="annot"><span class="annottext">fkey :: (StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="#local-6989586621682466580"><span class="hs-identifier hs-var">fkey</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">StakePoolMetadataUrl
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682466579"><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682466579"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">(&amp;&amp;)</span></a></span><span>
</span><span id="line-371"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682466579"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataHash -&gt; [StakePoolMetadataHash] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`notElem`</span></a></span><span> </span><span class="annot"><span class="annottext">Map StakePoolMetadataHash StakePoolMetadata
-&gt; [StakePoolMetadataHash]
forall k a. Map k a -&gt; [k]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.keys</span></a></span><span> </span><span class="annot"><span class="annottext">Map StakePoolMetadataHash StakePoolMetadata
</span><a href="#local-6989586621682466587"><span class="hs-identifier hs-var">metadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="#local-6989586621682466580"><span class="hs-identifier hs-var">fkey</span></a></span><span> </span><span class="annot"><span class="annottext">(StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; [(StakePoolMetadataUrl, StakePoolMetadataHash)] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`notElem`</span></a></span><span> </span><span class="annot"><span class="annottext">Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
-&gt; [(StakePoolMetadataUrl, StakePoolMetadataHash)]
forall k a. Map k a -&gt; [k]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.keys</span></a></span><span> </span><span class="annot"><span class="annottext">Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
</span><a href="#local-6989586621682466586"><span class="hs-identifier hs-var">fetchAttempts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>        </span><span id="local-6989586621682466585"><span class="annot"><span class="annottext">toTuple :: PoolRegistrationCertificate
-&gt; (PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="#local-6989586621682466585"><span class="hs-identifier hs-var hs-var">toTuple</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRegistrationCertificate"><span class="hs-identifier hs-type">PoolRegistrationCertificate</span></a></span><span class="hs-special">{</span><span id="local-6989586621682466575"><span class="annot"><span class="annottext">PoolId
poolId :: PoolId
$sel:poolId:PoolRegistrationCertificate :: PoolRegistrationCertificate -&gt; PoolId
</span><a href="#local-6989586621682466575"><span class="hs-identifier hs-var hs-var">poolId</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682466574"><span class="annot"><span class="annottext">Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
poolMetadata :: Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
$sel:poolMetadata:PoolRegistrationCertificate :: PoolRegistrationCertificate
-&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="#local-6989586621682466574"><span class="hs-identifier hs-var hs-var">poolMetadata</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-374"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466575"><span class="hs-identifier hs-var">poolId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataUrl
</span><a href="#local-6989586621682466573"><span class="hs-identifier hs-var">metadataUrl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682466572"><span class="hs-identifier hs-var">metadataHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-376"></span><span>            </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682466573"><span class="annot"><span class="annottext">StakePoolMetadataUrl
</span><a href="#local-6989586621682466573"><span class="hs-identifier hs-var">metadataUrl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682466572"><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682466572"><span class="hs-identifier hs-var">metadataHash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="#local-6989586621682466574"><span class="hs-identifier hs-var">poolMetadata</span></a></span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutFetchAttempt"><span class="hs-identifier hs-type">mPutFetchAttempt</span></a></span><span>
</span><span id="line-379"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadataUrl"><span class="hs-identifier hs-type">StakePoolMetadataUrl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadataHash"><span class="hs-identifier hs-type">StakePoolMetadataHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-381"></span><span id="mPutFetchAttempt"><span class="annot"><span class="annottext">mPutFetchAttempt :: (StakePoolMetadataUrl, StakePoolMetadataHash) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mPutFetchAttempt"><span class="hs-identifier hs-var hs-var">mPutFetchAttempt</span></a></span></span><span> </span><span id="local-6989586621682466571"><span class="annot"><span class="annottext">(StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="#local-6989586621682466571"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-382"></span><span>    </span><span class="annot"><span class="annottext">((Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
  -&gt; Identity
       (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
    -&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;fetchAttempts&quot;
  ((Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
    -&gt; Identity
         (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
 -&gt; Identity
      (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466570"><span class="hs-var">#fetchAttempts</span></a></span><span> </span><span class="annot"><span class="annottext">((Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
  -&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
 -&gt; ModelOp ())
-&gt; (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
    -&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Int)
-&gt; (StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; Int
-&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
-&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.insertWith</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">(+)</span></a></span><span> </span><span class="annot"><span class="annottext">(StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="#local-6989586621682466571"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutPoolMetadata"><span class="hs-identifier hs-type">mPutPoolMetadata</span></a></span><span>
</span><span id="line-385"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadataHash"><span class="hs-identifier hs-type">StakePoolMetadataHash</span></a></span><span>
</span><span id="line-386"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadata"><span class="hs-identifier hs-type">StakePoolMetadata</span></a></span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span id="mPutPoolMetadata"><span class="annot"><span class="annottext">mPutPoolMetadata :: StakePoolMetadataHash -&gt; StakePoolMetadata -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mPutPoolMetadata"><span class="hs-identifier hs-var hs-var">mPutPoolMetadata</span></a></span></span><span> </span><span id="local-6989586621682466567"><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682466567"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span id="local-6989586621682466566"><span class="annot"><span class="annottext">StakePoolMetadata
</span><a href="#local-6989586621682466566"><span class="hs-identifier hs-var">meta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-389"></span><span>    </span><span class="annot"><span class="annottext">((Map StakePoolMetadataHash StakePoolMetadata
  -&gt; Identity (Map StakePoolMetadataHash StakePoolMetadata))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map StakePoolMetadataHash StakePoolMetadata
    -&gt; Map StakePoolMetadataHash StakePoolMetadata)
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;metadata&quot;
  ((Map StakePoolMetadataHash StakePoolMetadata
    -&gt; Identity (Map StakePoolMetadataHash StakePoolMetadata))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map StakePoolMetadataHash StakePoolMetadata
 -&gt; Identity (Map StakePoolMetadataHash StakePoolMetadata))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466565"><span class="hs-var">#metadata</span></a></span><span>
</span><span id="line-390"></span><span>        </span><span class="annot"><span class="annottext">((Map StakePoolMetadataHash StakePoolMetadata
  -&gt; Map StakePoolMetadataHash StakePoolMetadata)
 -&gt; ModelOp ())
-&gt; (Map StakePoolMetadataHash StakePoolMetadata
    -&gt; Map StakePoolMetadataHash StakePoolMetadata)
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataHash
-&gt; StakePoolMetadata
-&gt; Map StakePoolMetadataHash StakePoolMetadata
-&gt; Map StakePoolMetadataHash StakePoolMetadata
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682466567"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadata
</span><a href="#local-6989586621682466566"><span class="hs-identifier hs-var">meta</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span class="annot"><span class="annottext">((Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
  -&gt; Identity
       (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
    -&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;fetchAttempts&quot;
  ((Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
    -&gt; Identity
         (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
 -&gt; Identity
      (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466564"><span class="hs-var">#fetchAttempts</span></a></span><span>
</span><span id="line-392"></span><span>        </span><span class="annot"><span class="annottext">((Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
  -&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
 -&gt; ModelOp ())
-&gt; (Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
    -&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((StakePoolMetadataUrl, StakePoolMetadataHash) -&gt; Int -&gt; Bool)
-&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
-&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filterWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">(((StakePoolMetadataUrl, StakePoolMetadataHash) -&gt; Int -&gt; Bool)
 -&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
 -&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int)
-&gt; ((StakePoolMetadataUrl, StakePoolMetadataHash) -&gt; Int -&gt; Bool)
-&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
-&gt; Map (StakePoolMetadataUrl, StakePoolMetadataHash) Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682466563"><span class="annot"><span class="annottext">(StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="#local-6989586621682466563"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; StakePoolMetadataHash
forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">(StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="#local-6989586621682466563"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataHash -&gt; StakePoolMetadataHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682466567"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadPoolMetadata"><span class="hs-identifier hs-type">mReadPoolMetadata</span></a></span><span>
</span><span id="line-395"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadataHash"><span class="hs-identifier hs-type">StakePoolMetadataHash</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadata"><span class="hs-identifier hs-type">StakePoolMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-396"></span><span id="mReadPoolMetadata"><span class="annot"><span class="annottext">mReadPoolMetadata :: StateT
  PoolDatabase
  (Either PoolErr)
  (Map StakePoolMetadataHash StakePoolMetadata)
</span><a href="Cardano.Pool.DB.Model.html#mReadPoolMetadata"><span class="hs-identifier hs-var hs-var">mReadPoolMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Map StakePoolMetadataHash StakePoolMetadata
  -&gt; Const
       (Map StakePoolMetadataHash StakePoolMetadata)
       (Map StakePoolMetadataHash StakePoolMetadata))
 -&gt; PoolDatabase
 -&gt; Const
      (Map StakePoolMetadataHash StakePoolMetadata) PoolDatabase)
-&gt; StateT
     PoolDatabase
     (Either PoolErr)
     (Map StakePoolMetadataHash StakePoolMetadata)
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;metadata&quot;
  ((Map StakePoolMetadataHash StakePoolMetadata
    -&gt; Const
         (Map StakePoolMetadataHash StakePoolMetadata)
         (Map StakePoolMetadataHash StakePoolMetadata))
   -&gt; PoolDatabase
   -&gt; Const
        (Map StakePoolMetadataHash StakePoolMetadata) PoolDatabase)
(Map StakePoolMetadataHash StakePoolMetadata
 -&gt; Const
      (Map StakePoolMetadataHash StakePoolMetadata)
      (Map StakePoolMetadataHash StakePoolMetadata))
-&gt; PoolDatabase
-&gt; Const (Map StakePoolMetadataHash StakePoolMetadata) PoolDatabase
</span><a href="#local-6989586621682466561"><span class="hs-var">#metadata</span></a></span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadSystemSeed"><span class="hs-identifier hs-type">mReadSystemSeed</span></a></span><span>
</span><span id="line-399"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolDatabase"><span class="hs-identifier hs-type">PoolDatabase</span></a></span><span>
</span><span id="line-400"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../random/html/src"><span class="hs-identifier hs-type">StdGen</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolDatabase"><span class="hs-identifier hs-type">PoolDatabase</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-401"></span><span id="mReadSystemSeed"><span class="annot"><span class="annottext">mReadSystemSeed :: PoolDatabase -&gt; IO (StdGen, PoolDatabase)
</span><a href="Cardano.Pool.DB.Model.html#mReadSystemSeed"><span class="hs-identifier hs-var hs-var">mReadSystemSeed</span></a></span></span><span> </span><span id="local-6989586621682466560"><span class="annot"><span class="annottext">db :: PoolDatabase
</span><a href="#local-6989586621682466560"><span class="hs-identifier hs-var">db</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolDatabase"><span class="hs-identifier hs-type">PoolDatabase</span></a></span><span class="hs-special">{</span><span id="local-6989586621682466559"><span class="annot"><span class="annottext">SystemSeed
seed :: SystemSeed
$sel:seed:PoolDatabase :: PoolDatabase -&gt; SystemSeed
</span><a href="#local-6989586621682466559"><span class="hs-identifier hs-var hs-var">seed</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-402"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SystemSeed
</span><a href="#local-6989586621682466559"><span class="hs-identifier hs-var">seed</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-403"></span><span>        </span><span class="annot"><span class="annottext">SystemSeed
</span><a href="Cardano.Pool.DB.Model.html#NotSeededYet"><span class="hs-identifier hs-var">NotSeededYet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-404"></span><span>            </span><span id="local-6989586621682466558"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621682466558"><span class="hs-identifier hs-var">seed'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO StdGen
forall (m :: * -&gt; *). MonadIO m =&gt; m StdGen
</span><a href="../../../../random/html/src"><span class="hs-identifier hs-var">newStdGen</span></a></span><span>
</span><span id="line-405"></span><span>            </span><span class="annot"><span class="annottext">(StdGen, PoolDatabase) -&gt; IO (StdGen, PoolDatabase)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621682466558"><span class="hs-identifier hs-var">seed'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PoolDatabase
</span><a href="#local-6989586621682466560"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:seed:PoolDatabase :: SystemSeed
</span><a href="Cardano.Pool.DB.Model.html#%24sel%3Aseed%3APoolDatabase"><span class="hs-identifier hs-var">seed</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdGen -&gt; SystemSeed
</span><a href="Cardano.Pool.DB.Model.html#SystemSeed"><span class="hs-identifier hs-var">SystemSeed</span></a></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621682466558"><span class="hs-identifier hs-var">seed'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>        </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#SystemSeed"><span class="hs-identifier hs-type">SystemSeed</span></a></span><span> </span><span id="local-6989586621682466557"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621682466557"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-407"></span><span>            </span><span class="annot"><span class="annottext">(StdGen, PoolDatabase) -&gt; IO (StdGen, PoolDatabase)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621682466557"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PoolDatabase
</span><a href="#local-6989586621682466560"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadCursor"><span class="hs-identifier hs-type">mReadCursor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-410"></span><span id="mReadCursor"><span class="annot"><span class="annottext">mReadCursor :: Int -&gt; ModelOp [BlockHeader]
</span><a href="Cardano.Pool.DB.Model.html#mReadCursor"><span class="hs-identifier hs-var hs-var">mReadCursor</span></a></span></span><span> </span><span id="local-6989586621682466556"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682466556"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-411"></span><span>    </span><span id="local-6989586621682466555"><span class="annot"><span class="annottext">[BlockHeader]
</span><a href="#local-6989586621682466555"><span class="hs-identifier hs-var">allHeaders</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map PoolId [BlockHeader] -&gt; [BlockHeader]
forall (t :: * -&gt; *) m. (Foldable t, Monoid m) =&gt; t m -&gt; m
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fold</span></a></span><span> </span><span class="annot"><span class="annottext">(Map PoolId [BlockHeader] -&gt; [BlockHeader])
-&gt; StateT PoolDatabase (Either PoolErr) (Map PoolId [BlockHeader])
-&gt; ModelOp [BlockHeader]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Map PoolId [BlockHeader]
  -&gt; Const (Map PoolId [BlockHeader]) (Map PoolId [BlockHeader]))
 -&gt; PoolDatabase -&gt; Const (Map PoolId [BlockHeader]) PoolDatabase)
-&gt; StateT PoolDatabase (Either PoolErr) (Map PoolId [BlockHeader])
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;pools&quot;
  ((Map PoolId [BlockHeader]
    -&gt; Const (Map PoolId [BlockHeader]) (Map PoolId [BlockHeader]))
   -&gt; PoolDatabase -&gt; Const (Map PoolId [BlockHeader]) PoolDatabase)
(Map PoolId [BlockHeader]
 -&gt; Const (Map PoolId [BlockHeader]) (Map PoolId [BlockHeader]))
-&gt; PoolDatabase -&gt; Const (Map PoolId [BlockHeader]) PoolDatabase
</span><a href="#local-6989586621682466554"><span class="hs-var">#pools</span></a></span><span>
</span><span id="line-412"></span><span>    </span><span class="annot"><span class="annottext">[BlockHeader] -&gt; ModelOp [BlockHeader]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockHeader] -&gt; ModelOp [BlockHeader])
-&gt; [BlockHeader] -&gt; ModelOp [BlockHeader]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockHeader] -&gt; [BlockHeader]
forall a. [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockHeader] -&gt; [BlockHeader]) -&gt; [BlockHeader] -&gt; [BlockHeader]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockHeader] -&gt; [BlockHeader]
</span><a href="#local-6989586621682466552"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockHeader] -&gt; [BlockHeader]) -&gt; [BlockHeader] -&gt; [BlockHeader]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockHeader] -&gt; [BlockHeader]
</span><a href="#local-6989586621682466551"><span class="hs-identifier hs-var">sortDesc</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockHeader]
</span><a href="#local-6989586621682466555"><span class="hs-identifier hs-var">allHeaders</span></a></span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-414"></span><span>    </span><span id="local-6989586621682466551"><span class="annot"><span class="annottext">sortDesc :: [BlockHeader] -&gt; [BlockHeader]
</span><a href="#local-6989586621682466551"><span class="hs-identifier hs-var hs-var">sortDesc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; Down SlotNo) -&gt; [BlockHeader] -&gt; [BlockHeader]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">L.sortOn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Down SlotNo
forall a. a -&gt; Down a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Down</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; Down SlotNo)
-&gt; (BlockHeader -&gt; SlotNo) -&gt; BlockHeader -&gt; Down SlotNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; SlotNo
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AslotNo%3ABlockHeader"><span class="hs-identifier hs-var hs-var">slotNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span>    </span><span id="local-6989586621682466552"><span class="annot"><span class="annottext">limit :: [BlockHeader] -&gt; [BlockHeader]
</span><a href="#local-6989586621682466552"><span class="hs-identifier hs-var hs-var">limit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [BlockHeader] -&gt; [BlockHeader]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">take</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682466556"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mRollbackTo"><span class="hs-identifier hs-type">mRollbackTo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier hs-type">TimeInterpreter</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Identity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">SlotNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span id="mRollbackTo"><span class="annot"><span class="annottext">mRollbackTo :: TimeInterpreter Identity -&gt; SlotNo -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mRollbackTo"><span class="hs-identifier hs-var hs-var">mRollbackTo</span></a></span></span><span> </span><span id="local-6989586621682466548"><span class="annot"><span class="annottext">TimeInterpreter Identity
</span><a href="#local-6989586621682466548"><span class="hs-identifier hs-var">ti</span></a></span></span><span> </span><span id="local-6989586621682466547"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682466547"><span class="hs-identifier hs-var">point</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-419"></span><span>    </span><span class="annot"><span class="annottext">((Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
  -&gt; Identity (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
    -&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;distributions&quot;
  ((Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
    -&gt; Identity (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
 -&gt; Identity (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466546"><span class="hs-var">#distributions</span></a></span><span>
</span><span id="line-420"></span><span>        </span><span class="annot"><span class="annottext">((Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
  -&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
 -&gt; ModelOp ())
-&gt; (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
    -&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(EpochNo
 -&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
 -&gt; Maybe [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall k a b. (k -&gt; a -&gt; Maybe b) -&gt; Map k a -&gt; Map k b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.mapMaybeWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">((EpochNo
  -&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
  -&gt; Maybe [(PoolId, Quantity &quot;lovelace&quot; Word64)])
 -&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
 -&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; (EpochNo
    -&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
    -&gt; Maybe [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; EpochNo)
-&gt; EpochNo
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; Maybe [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall point a.
Ord point =&gt;
(SlotNo -&gt; point) -&gt; point -&gt; a -&gt; Maybe a
</span><a href="#local-6989586621682466544"><span class="hs-identifier hs-var">discardBy</span></a></span><span> </span><span class="annot"><span class="annottext">((SlotNo -&gt; EpochNo)
 -&gt; EpochNo
 -&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
 -&gt; Maybe [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; (SlotNo -&gt; EpochNo)
-&gt; EpochNo
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; Maybe [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Identity EpochNo -&gt; EpochNo
forall a. Identity a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var">runIdentity</span></a></span><span> </span><span class="annot"><span class="annottext">(Identity EpochNo -&gt; EpochNo)
-&gt; (SlotNo -&gt; Identity EpochNo) -&gt; SlotNo -&gt; EpochNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter Identity -&gt; Qry EpochNo -&gt; Identity EpochNo
forall (m :: * -&gt; *) a.
(HasCallStack, Monad m) =&gt;
TimeInterpreter m -&gt; Qry a -&gt; m a
</span><a href="Cardano.Wallet.Primitive.Slotting.html#interpretQuery"><span class="hs-identifier hs-var">interpretQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter Identity
</span><a href="#local-6989586621682466548"><span class="hs-identifier hs-var">ti</span></a></span><span> </span><span class="annot"><span class="annottext">(Qry EpochNo -&gt; Identity EpochNo)
-&gt; (SlotNo -&gt; Qry EpochNo) -&gt; SlotNo -&gt; Identity EpochNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Qry EpochNo
</span><a href="Cardano.Wallet.Primitive.Slotting.html#epochOf"><span class="hs-identifier hs-var">epochOf</span></a></span><span>
</span><span id="line-421"></span><span>    </span><span class="annot"><span class="annottext">((Map PoolId [BlockHeader] -&gt; Identity (Map PoolId [BlockHeader]))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;pools&quot;
  ((Map PoolId [BlockHeader] -&gt; Identity (Map PoolId [BlockHeader]))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map PoolId [BlockHeader] -&gt; Identity (Map PoolId [BlockHeader]))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466543"><span class="hs-var">#pools</span></a></span><span>
</span><span id="line-422"></span><span>        </span><span class="annot"><span class="annottext">((Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
 -&gt; ModelOp ())
-&gt; (Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockHeader] -&gt; Bool)
-&gt; Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader]
forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; ([BlockHeader] -&gt; Bool) -&gt; [BlockHeader] -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockHeader] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">L.null</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
-&gt; (Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
-&gt; Map PoolId [BlockHeader]
-&gt; Map PoolId [BlockHeader]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockHeader] -&gt; [BlockHeader])
-&gt; Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(BlockHeader -&gt; Bool) -&gt; [BlockHeader] -&gt; [BlockHeader]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682466547"><span class="hs-identifier hs-var">point</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; Bool) -&gt; (BlockHeader -&gt; SlotNo) -&gt; BlockHeader -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; SlotNo
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AslotNo%3ABlockHeader"><span class="hs-identifier hs-var hs-var">slotNo</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>    </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
  -&gt; Identity
       (Map
          (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;registrations&quot;
  ((Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Identity
         (Map
            (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map
   (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Identity
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466542"><span class="hs-var">#registrations</span></a></span><span>
</span><span id="line-424"></span><span>        </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
  -&gt; Map
       (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
 -&gt; ModelOp ())
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((CertificatePublicationTime, PoolId)
 -&gt; PoolRegistrationCertificate
 -&gt; Maybe PoolRegistrationCertificate)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
forall k a b. (k -&gt; a -&gt; Maybe b) -&gt; Map k a -&gt; Map k b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.mapMaybeWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">(((CertificatePublicationTime, PoolId)
  -&gt; PoolRegistrationCertificate
  -&gt; Maybe PoolRegistrationCertificate)
 -&gt; Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; ((CertificatePublicationTime, PoolId)
    -&gt; PoolRegistrationCertificate
    -&gt; Maybe PoolRegistrationCertificate)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; SlotNo)
-&gt; SlotNo
-&gt; PoolRegistrationCertificate
-&gt; Maybe PoolRegistrationCertificate
forall point a.
Ord point =&gt;
(SlotNo -&gt; point) -&gt; point -&gt; a -&gt; Maybe a
</span><a href="#local-6989586621682466544"><span class="hs-identifier hs-var">discardBy</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo
forall a. a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo
 -&gt; PoolRegistrationCertificate
 -&gt; Maybe PoolRegistrationCertificate)
-&gt; ((CertificatePublicationTime, PoolId) -&gt; SlotNo)
-&gt; (CertificatePublicationTime, PoolId)
-&gt; PoolRegistrationCertificate
-&gt; Maybe PoolRegistrationCertificate
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((SlotNo -&gt; Const SlotNo SlotNo)
 -&gt; CertificatePublicationTime
 -&gt; Const SlotNo CertificatePublicationTime)
-&gt; CertificatePublicationTime -&gt; SlotNo
forall a s. ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; s -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;slotNo&quot;
  ((SlotNo -&gt; Const SlotNo SlotNo)
   -&gt; CertificatePublicationTime
   -&gt; Const SlotNo CertificatePublicationTime)
(SlotNo -&gt; Const SlotNo SlotNo)
-&gt; CertificatePublicationTime
-&gt; Const SlotNo CertificatePublicationTime
</span><a href="#local-6989586621682466541"><span class="hs-var">#slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">(CertificatePublicationTime -&gt; SlotNo)
-&gt; ((CertificatePublicationTime, PoolId)
    -&gt; CertificatePublicationTime)
-&gt; (CertificatePublicationTime, PoolId)
-&gt; SlotNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(CertificatePublicationTime, PoolId) -&gt; CertificatePublicationTime
forall a b. (a, b) -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span>
</span><span id="line-425"></span><span>    </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRetirementCertificate
  -&gt; Identity
       (Map
          (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
    -&gt; Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;retirements&quot;
  ((Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
    -&gt; Identity
         (Map
            (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map (CertificatePublicationTime, PoolId) PoolRetirementCertificate
 -&gt; Identity
      (Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466540"><span class="hs-var">#retirements</span></a></span><span>
</span><span id="line-426"></span><span>        </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRetirementCertificate
  -&gt; Map
       (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
 -&gt; ModelOp ())
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
    -&gt; Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((CertificatePublicationTime, PoolId)
 -&gt; PoolRetirementCertificate -&gt; Maybe PoolRetirementCertificate)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
forall k a b. (k -&gt; a -&gt; Maybe b) -&gt; Map k a -&gt; Map k b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.mapMaybeWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">(((CertificatePublicationTime, PoolId)
  -&gt; PoolRetirementCertificate -&gt; Maybe PoolRetirementCertificate)
 -&gt; Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
 -&gt; Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
-&gt; ((CertificatePublicationTime, PoolId)
    -&gt; PoolRetirementCertificate -&gt; Maybe PoolRetirementCertificate)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; SlotNo)
-&gt; SlotNo
-&gt; PoolRetirementCertificate
-&gt; Maybe PoolRetirementCertificate
forall point a.
Ord point =&gt;
(SlotNo -&gt; point) -&gt; point -&gt; a -&gt; Maybe a
</span><a href="#local-6989586621682466544"><span class="hs-identifier hs-var">discardBy</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo
forall a. a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo
 -&gt; PoolRetirementCertificate -&gt; Maybe PoolRetirementCertificate)
-&gt; ((CertificatePublicationTime, PoolId) -&gt; SlotNo)
-&gt; (CertificatePublicationTime, PoolId)
-&gt; PoolRetirementCertificate
-&gt; Maybe PoolRetirementCertificate
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((SlotNo -&gt; Const SlotNo SlotNo)
 -&gt; CertificatePublicationTime
 -&gt; Const SlotNo CertificatePublicationTime)
-&gt; CertificatePublicationTime -&gt; SlotNo
forall a s. ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; s -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;slotNo&quot;
  ((SlotNo -&gt; Const SlotNo SlotNo)
   -&gt; CertificatePublicationTime
   -&gt; Const SlotNo CertificatePublicationTime)
(SlotNo -&gt; Const SlotNo SlotNo)
-&gt; CertificatePublicationTime
-&gt; Const SlotNo CertificatePublicationTime
</span><a href="#local-6989586621682466539"><span class="hs-var">#slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">(CertificatePublicationTime -&gt; SlotNo)
-&gt; ((CertificatePublicationTime, PoolId)
    -&gt; CertificatePublicationTime)
-&gt; (CertificatePublicationTime, PoolId)
-&gt; SlotNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(CertificatePublicationTime, PoolId) -&gt; CertificatePublicationTime
forall a b. (a, b) -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span>
</span><span id="line-427"></span><span>    </span><span class="annot"><span class="annottext">((Map PoolId [PoolOwner] -&gt; Identity (Map PoolId [PoolOwner]))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map PoolId [PoolOwner] -&gt; Map PoolId [PoolOwner]) -&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;owners&quot;
  ((Map PoolId [PoolOwner] -&gt; Identity (Map PoolId [PoolOwner]))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map PoolId [PoolOwner] -&gt; Identity (Map PoolId [PoolOwner]))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466538"><span class="hs-var">#owners</span></a></span><span>
</span><span id="line-428"></span><span>        </span><span class="annot"><span class="annottext">((Map PoolId [PoolOwner] -&gt; Map PoolId [PoolOwner]) -&gt; ModelOp ())
-&gt; ([PoolId] -&gt; Map PoolId [PoolOwner] -&gt; Map PoolId [PoolOwner])
-&gt; [PoolId]
-&gt; ModelOp ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Map PoolId [PoolOwner] -&gt; Set PoolId -&gt; Map PoolId [PoolOwner])
-&gt; Set PoolId -&gt; Map PoolId [PoolOwner] -&gt; Map PoolId [PoolOwner]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">Map PoolId [PoolOwner] -&gt; Set PoolId -&gt; Map PoolId [PoolOwner]
forall k a. Ord k =&gt; Map k a -&gt; Set k -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.restrictKeys</span></a></span><span> </span><span class="annot"><span class="annottext">(Set PoolId -&gt; Map PoolId [PoolOwner] -&gt; Map PoolId [PoolOwner])
-&gt; ([PoolId] -&gt; Set PoolId)
-&gt; [PoolId]
-&gt; Map PoolId [PoolOwner]
-&gt; Map PoolId [PoolOwner]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolId] -&gt; Set PoolId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([PoolId] -&gt; ModelOp ()) -&gt; ModelOp [PoolId] -&gt; ModelOp ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">ModelOp [PoolId]
</span><a href="Cardano.Pool.DB.Model.html#mListRegisteredPools"><span class="hs-identifier hs-var">mListRegisteredPools</span></a></span><span>
</span><span id="line-429"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-430"></span><span>    </span><span id="local-6989586621682466826"><span id="local-6989586621682466827"><span class="annot"><a href="#local-6989586621682466544"><span class="hs-identifier hs-type">discardBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682466827"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">SlotNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682466827"><span class="hs-identifier hs-type">point</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682466827"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682466826"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682466826"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-431"></span><span>    </span><span id="local-6989586621682466544"><span class="annot"><span class="annottext">discardBy :: (SlotNo -&gt; point) -&gt; point -&gt; a -&gt; Maybe a
</span><a href="#local-6989586621682466544"><span class="hs-identifier hs-var hs-var">discardBy</span></a></span></span><span> </span><span id="local-6989586621682466535"><span class="annot"><span class="annottext">SlotNo -&gt; point
</span><a href="#local-6989586621682466535"><span class="hs-identifier hs-var">getPoint</span></a></span></span><span> </span><span id="local-6989586621682466534"><span class="annot"><span class="annottext">point
</span><a href="#local-6989586621682466534"><span class="hs-identifier hs-var">point'</span></a></span></span><span> </span><span id="local-6989586621682466533"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682466533"><span class="hs-identifier hs-var">v</span></a></span></span><span>
</span><span id="line-432"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">point
</span><a href="#local-6989586621682466534"><span class="hs-identifier hs-var">point'</span></a></span><span> </span><span class="annot"><span class="annottext">point -&gt; point -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; point
</span><a href="#local-6989586621682466535"><span class="hs-identifier hs-var">getPoint</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682466547"><span class="hs-identifier hs-var">point</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682466533"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-433"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-434"></span><span>
</span><span id="line-435"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutDelistedPools"><span class="hs-identifier hs-type">mPutDelistedPools</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span id="mPutDelistedPools"><span class="annot"><span class="annottext">mPutDelistedPools :: [PoolId] -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mPutDelistedPools"><span class="hs-identifier hs-var hs-var">mPutDelistedPools</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Set PoolId -&gt; Identity (Set PoolId))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Set PoolId -&gt; Set PoolId) -&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;delisted&quot;
  ((Set PoolId -&gt; Identity (Set PoolId))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Set PoolId -&gt; Identity (Set PoolId))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466532"><span class="hs-var">#delisted</span></a></span><span> </span><span class="annot"><span class="annottext">((Set PoolId -&gt; Set PoolId) -&gt; ModelOp ())
-&gt; ([PoolId] -&gt; Set PoolId -&gt; Set PoolId) -&gt; [PoolId] -&gt; ModelOp ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Set PoolId -&gt; Set PoolId -&gt; Set PoolId
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">(Set PoolId -&gt; Set PoolId -&gt; Set PoolId)
-&gt; ([PoolId] -&gt; Set PoolId) -&gt; [PoolId] -&gt; Set PoolId -&gt; Set PoolId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolId] -&gt; Set PoolId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadDelistedPools"><span class="hs-identifier hs-type">mReadDelistedPools</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-439"></span><span id="mReadDelistedPools"><span class="annot"><span class="annottext">mReadDelistedPools :: ModelOp [PoolId]
</span><a href="Cardano.Pool.DB.Model.html#mReadDelistedPools"><span class="hs-identifier hs-var hs-var">mReadDelistedPools</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set PoolId -&gt; [PoolId]
forall a. Set a -&gt; [a]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(Set PoolId -&gt; [PoolId])
-&gt; StateT PoolDatabase (Either PoolErr) (Set PoolId)
-&gt; ModelOp [PoolId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Set PoolId -&gt; Const (Set PoolId) (Set PoolId))
 -&gt; PoolDatabase -&gt; Const (Set PoolId) PoolDatabase)
-&gt; StateT PoolDatabase (Either PoolErr) (Set PoolId)
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;delisted&quot;
  ((Set PoolId -&gt; Const (Set PoolId) (Set PoolId))
   -&gt; PoolDatabase -&gt; Const (Set PoolId) PoolDatabase)
(Set PoolId -&gt; Const (Set PoolId) (Set PoolId))
-&gt; PoolDatabase -&gt; Const (Set PoolId) PoolDatabase
</span><a href="#local-6989586621682466531"><span class="hs-var">#delisted</span></a></span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mRemovePools"><span class="hs-identifier hs-type">mRemovePools</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-442"></span><span id="mRemovePools"><span class="annot"><span class="annottext">mRemovePools :: [PoolId] -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mRemovePools"><span class="hs-identifier hs-var hs-var">mRemovePools</span></a></span></span><span> </span><span id="local-6989586621682466530"><span class="annot"><span class="annottext">[PoolId]
</span><a href="#local-6989586621682466530"><span class="hs-identifier hs-var">poolsToRemove</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-443"></span><span>    </span><span class="annot"><span class="annottext">((Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
  -&gt; Identity (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
    -&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;distributions&quot;
  ((Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
    -&gt; Identity (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
 -&gt; Identity (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466529"><span class="hs-var">#distributions</span></a></span><span>
</span><span id="line-444"></span><span>        </span><span class="annot"><span class="annottext">((Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
  -&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
 -&gt; ModelOp ())
-&gt; (Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
    -&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">([(PoolId, Quantity &quot;lovelace&quot; Word64)]
 -&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.map</span></a></span><span> </span><span class="annot"><span class="annottext">(([(PoolId, Quantity &quot;lovelace&quot; Word64)]
  -&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)])
 -&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
 -&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; ([(PoolId, Quantity &quot;lovelace&quot; Word64)]
    -&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; Map EpochNo [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((PoolId, Quantity &quot;lovelace&quot; Word64) -&gt; Bool)
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">L.filter</span></a></span><span> </span><span class="annot"><span class="annottext">(((PoolId, Quantity &quot;lovelace&quot; Word64) -&gt; Bool)
 -&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
 -&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; ((PoolId, Quantity &quot;lovelace&quot; Word64) -&gt; Bool)
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621682466528"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466528"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Quantity &quot;lovelace&quot; Word64
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PoolId -&gt; Bool
</span><a href="#local-6989586621682466527"><span class="hs-identifier hs-var">retain</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466528"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-445"></span><span>    </span><span class="annot"><span class="annottext">((Map PoolId [BlockHeader] -&gt; Identity (Map PoolId [BlockHeader]))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;pools&quot;
  ((Map PoolId [BlockHeader] -&gt; Identity (Map PoolId [BlockHeader]))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map PoolId [BlockHeader] -&gt; Identity (Map PoolId [BlockHeader]))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466526"><span class="hs-var">#pools</span></a></span><span>
</span><span id="line-446"></span><span>        </span><span class="annot"><span class="annottext">((Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
 -&gt; ModelOp ())
-&gt; (Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolId -&gt; [BlockHeader] -&gt; Bool)
-&gt; Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader]
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filterWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">((PoolId -&gt; [BlockHeader] -&gt; Bool)
 -&gt; Map PoolId [BlockHeader] -&gt; Map PoolId [BlockHeader])
-&gt; (PoolId -&gt; [BlockHeader] -&gt; Bool)
-&gt; Map PoolId [BlockHeader]
-&gt; Map PoolId [BlockHeader]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682466525"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466525"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">[BlockHeader]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PoolId -&gt; Bool
</span><a href="#local-6989586621682466527"><span class="hs-identifier hs-var">retain</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466525"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-447"></span><span>    </span><span class="annot"><span class="annottext">((Map PoolId [PoolOwner] -&gt; Identity (Map PoolId [PoolOwner]))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map PoolId [PoolOwner] -&gt; Map PoolId [PoolOwner]) -&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;owners&quot;
  ((Map PoolId [PoolOwner] -&gt; Identity (Map PoolId [PoolOwner]))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map PoolId [PoolOwner] -&gt; Identity (Map PoolId [PoolOwner]))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466524"><span class="hs-var">#owners</span></a></span><span>
</span><span id="line-448"></span><span>        </span><span class="annot"><span class="annottext">((Map PoolId [PoolOwner] -&gt; Map PoolId [PoolOwner]) -&gt; ModelOp ())
-&gt; (Map PoolId [PoolOwner] -&gt; Map PoolId [PoolOwner]) -&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolId -&gt; [PoolOwner] -&gt; Bool)
-&gt; Map PoolId [PoolOwner] -&gt; Map PoolId [PoolOwner]
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filterWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">((PoolId -&gt; [PoolOwner] -&gt; Bool)
 -&gt; Map PoolId [PoolOwner] -&gt; Map PoolId [PoolOwner])
-&gt; (PoolId -&gt; [PoolOwner] -&gt; Bool)
-&gt; Map PoolId [PoolOwner]
-&gt; Map PoolId [PoolOwner]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682466523"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466523"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">[PoolOwner]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PoolId -&gt; Bool
</span><a href="#local-6989586621682466527"><span class="hs-identifier hs-var">retain</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466523"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-449"></span><span>    </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
  -&gt; Identity
       (Map
          (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;registrations&quot;
  ((Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Identity
         (Map
            (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map
   (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Identity
      (Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466522"><span class="hs-var">#registrations</span></a></span><span>
</span><span id="line-450"></span><span>        </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
  -&gt; Map
       (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
 -&gt; ModelOp ())
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
    -&gt; Map
         (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((CertificatePublicationTime, PoolId)
 -&gt; PoolRegistrationCertificate -&gt; Bool)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filterWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">(((CertificatePublicationTime, PoolId)
  -&gt; PoolRegistrationCertificate -&gt; Bool)
 -&gt; Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
 -&gt; Map
      (CertificatePublicationTime, PoolId) PoolRegistrationCertificate)
-&gt; ((CertificatePublicationTime, PoolId)
    -&gt; PoolRegistrationCertificate -&gt; Bool)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRegistrationCertificate
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">CertificatePublicationTime
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682466521"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466521"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PoolId -&gt; Bool
</span><a href="#local-6989586621682466527"><span class="hs-identifier hs-var">retain</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466521"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-451"></span><span>    </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRetirementCertificate
  -&gt; Identity
       (Map
          (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
    -&gt; Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
-&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;retirements&quot;
  ((Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
    -&gt; Identity
         (Map
            (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Map (CertificatePublicationTime, PoolId) PoolRetirementCertificate
 -&gt; Identity
      (Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate))
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466520"><span class="hs-var">#retirements</span></a></span><span>
</span><span id="line-452"></span><span>        </span><span class="annot"><span class="annottext">((Map
    (CertificatePublicationTime, PoolId) PoolRetirementCertificate
  -&gt; Map
       (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
 -&gt; ModelOp ())
-&gt; (Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
    -&gt; Map
         (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
-&gt; ModelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((CertificatePublicationTime, PoolId)
 -&gt; PoolRetirementCertificate -&gt; Bool)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filterWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">(((CertificatePublicationTime, PoolId)
  -&gt; PoolRetirementCertificate -&gt; Bool)
 -&gt; Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate
 -&gt; Map
      (CertificatePublicationTime, PoolId) PoolRetirementCertificate)
-&gt; ((CertificatePublicationTime, PoolId)
    -&gt; PoolRetirementCertificate -&gt; Bool)
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
-&gt; Map
     (CertificatePublicationTime, PoolId) PoolRetirementCertificate
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">CertificatePublicationTime
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682466519"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466519"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PoolRetirementCertificate
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PoolId -&gt; Bool
</span><a href="#local-6989586621682466527"><span class="hs-identifier hs-var">retain</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466519"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-453"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-454"></span><span>    </span><span id="local-6989586621682466527"><span class="annot"><span class="annottext">retain :: PoolId -&gt; Bool
</span><a href="#local-6989586621682466527"><span class="hs-identifier hs-var hs-var">retain</span></a></span></span><span> </span><span id="local-6989586621682466518"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466518"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682466518"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId -&gt; Set PoolId -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../../../containers/html/src"><span class="hs-operator hs-var">`Set.notMember`</span></a></span><span> </span><span class="annot"><span class="annottext">Set PoolId
</span><a href="#local-6989586621682466516"><span class="hs-identifier hs-var">poolsToRemoveSet</span></a></span><span>
</span><span id="line-455"></span><span>    </span><span id="local-6989586621682466516"><span class="annot"><span class="annottext">poolsToRemoveSet :: Set PoolId
</span><a href="#local-6989586621682466516"><span class="hs-identifier hs-var hs-var">poolsToRemoveSet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PoolId] -&gt; Set PoolId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolId]
</span><a href="#local-6989586621682466530"><span class="hs-identifier hs-var">poolsToRemove</span></a></span><span>
</span><span id="line-456"></span><span>
</span><span id="line-457"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mRemoveRetiredPools"><span class="hs-identifier hs-type">mRemoveRetiredPools</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRetirementCertificate"><span class="hs-identifier hs-type">PoolRetirementCertificate</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-458"></span><span id="mRemoveRetiredPools"><span class="annot"><span class="annottext">mRemoveRetiredPools :: EpochNo
-&gt; StateT PoolDatabase (Either PoolErr) [PoolRetirementCertificate]
</span><a href="Cardano.Pool.DB.Model.html#mRemoveRetiredPools"><span class="hs-identifier hs-var hs-var">mRemoveRetiredPools</span></a></span></span><span> </span><span id="local-6989586621682466515"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466515"><span class="hs-identifier hs-var">epoch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-459"></span><span>    </span><span id="local-6989586621682466514"><span class="annot"><span class="annottext">[PoolRetirementCertificate]
</span><a href="#local-6989586621682466514"><span class="hs-identifier hs-var">certificates</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EpochNo
-&gt; StateT PoolDatabase (Either PoolErr) [PoolRetirementCertificate]
</span><a href="Cardano.Pool.DB.Model.html#mListRetiredPools"><span class="hs-identifier hs-var">mListRetiredPools</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682466515"><span class="hs-identifier hs-var">epoch</span></a></span><span>
</span><span id="line-460"></span><span>    </span><span class="annot"><span class="annottext">[PoolId] -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mRemovePools"><span class="hs-identifier hs-var">mRemovePools</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((PoolId -&gt; Const PoolId PoolId)
 -&gt; PoolRetirementCertificate
 -&gt; Const PoolId PoolRetirementCertificate)
-&gt; PoolRetirementCertificate -&gt; PoolId
forall a s. ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; s -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;poolId&quot;
  ((PoolId -&gt; Const PoolId PoolId)
   -&gt; PoolRetirementCertificate
   -&gt; Const PoolId PoolRetirementCertificate)
(PoolId -&gt; Const PoolId PoolId)
-&gt; PoolRetirementCertificate
-&gt; Const PoolId PoolRetirementCertificate
</span><a href="#local-6989586621682466513"><span class="hs-var">#poolId</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolRetirementCertificate -&gt; PoolId)
-&gt; [PoolRetirementCertificate] -&gt; [PoolId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolRetirementCertificate]
</span><a href="#local-6989586621682466514"><span class="hs-identifier hs-var">certificates</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span>    </span><span class="annot"><span class="annottext">[PoolRetirementCertificate]
-&gt; StateT PoolDatabase (Either PoolErr) [PoolRetirementCertificate]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolRetirementCertificate]
</span><a href="#local-6989586621682466514"><span class="hs-identifier hs-var">certificates</span></a></span><span>
</span><span id="line-462"></span><span>
</span><span id="line-463"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutHeader"><span class="hs-identifier hs-type">mPutHeader</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span id="mPutHeader"><span class="annot"><span class="annottext">mPutHeader :: BlockHeader -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mPutHeader"><span class="hs-identifier hs-var hs-var">mPutHeader</span></a></span></span><span> </span><span id="local-6989586621682466512"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682466512"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(([BlockHeader] -&gt; Identity [BlockHeader])
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; ([BlockHeader] -&gt; [BlockHeader]) -&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;blockHeaders&quot;
  (([BlockHeader] -&gt; Identity [BlockHeader])
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
([BlockHeader] -&gt; Identity [BlockHeader])
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466511"><span class="hs-var">#blockHeaders</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682466512"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; [BlockHeader] -&gt; [BlockHeader]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-465"></span><span>
</span><span id="line-466"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mListHeaders"><span class="hs-identifier hs-type">mListHeaders</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-467"></span><span id="mListHeaders"><span class="annot"><span class="annottext">mListHeaders :: Int -&gt; ModelOp [BlockHeader]
</span><a href="Cardano.Pool.DB.Model.html#mListHeaders"><span class="hs-identifier hs-var hs-var">mListHeaders</span></a></span></span><span> </span><span id="local-6989586621682466510"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682466510"><span class="hs-identifier hs-var">k</span></a></span></span><span>
</span><span id="line-468"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682466510"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[BlockHeader] -&gt; [BlockHeader]
forall a. [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockHeader] -&gt; [BlockHeader])
-&gt; ([BlockHeader] -&gt; [BlockHeader])
-&gt; [BlockHeader]
-&gt; [BlockHeader]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [BlockHeader] -&gt; [BlockHeader]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">take</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682466510"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockHeader] -&gt; [BlockHeader])
-&gt; ModelOp [BlockHeader] -&gt; ModelOp [BlockHeader]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(([BlockHeader] -&gt; Const [BlockHeader] [BlockHeader])
 -&gt; PoolDatabase -&gt; Const [BlockHeader] PoolDatabase)
-&gt; ModelOp [BlockHeader]
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;blockHeaders&quot;
  (([BlockHeader] -&gt; Const [BlockHeader] [BlockHeader])
   -&gt; PoolDatabase -&gt; Const [BlockHeader] PoolDatabase)
([BlockHeader] -&gt; Const [BlockHeader] [BlockHeader])
-&gt; PoolDatabase -&gt; Const [BlockHeader] PoolDatabase
</span><a href="#local-6989586621682466508"><span class="hs-var">#blockHeaders</span></a></span><span>
</span><span id="line-469"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[BlockHeader] -&gt; [BlockHeader]
forall a. [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockHeader] -&gt; [BlockHeader])
-&gt; ModelOp [BlockHeader] -&gt; ModelOp [BlockHeader]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(([BlockHeader] -&gt; Const [BlockHeader] [BlockHeader])
 -&gt; PoolDatabase -&gt; Const [BlockHeader] PoolDatabase)
-&gt; ModelOp [BlockHeader]
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;blockHeaders&quot;
  (([BlockHeader] -&gt; Const [BlockHeader] [BlockHeader])
   -&gt; PoolDatabase -&gt; Const [BlockHeader] PoolDatabase)
([BlockHeader] -&gt; Const [BlockHeader] [BlockHeader])
-&gt; PoolDatabase -&gt; Const [BlockHeader] PoolDatabase
</span><a href="#local-6989586621682466507"><span class="hs-var">#blockHeaders</span></a></span><span>
</span><span id="line-470"></span><span>
</span><span id="line-471"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadSettings"><span class="hs-identifier hs-type">mReadSettings</span></a></span><span>
</span><span id="line-472"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span>
</span><span id="line-473"></span><span id="mReadSettings"><span class="annot"><span class="annottext">mReadSettings :: ModelOp Settings
</span><a href="Cardano.Pool.DB.Model.html#mReadSettings"><span class="hs-identifier hs-var hs-var">mReadSettings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Settings -&gt; Const Settings Settings)
 -&gt; PoolDatabase -&gt; Const Settings PoolDatabase)
-&gt; ModelOp Settings
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;settings&quot;
  ((Settings -&gt; Const Settings Settings)
   -&gt; PoolDatabase -&gt; Const Settings PoolDatabase)
(Settings -&gt; Const Settings Settings)
-&gt; PoolDatabase -&gt; Const Settings PoolDatabase
</span><a href="#local-6989586621682466506"><span class="hs-var">#settings</span></a></span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutSettings"><span class="hs-identifier hs-type">mPutSettings</span></a></span><span>
</span><span id="line-476"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span>
</span><span id="line-477"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span id="mPutSettings"><span class="annot"><span class="annottext">mPutSettings :: Settings -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mPutSettings"><span class="hs-identifier hs-var hs-var">mPutSettings</span></a></span></span><span> </span><span id="local-6989586621682466505"><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621682466505"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Settings -&gt; Identity Settings)
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Settings -&gt; Settings) -&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;settings&quot;
  ((Settings -&gt; Identity Settings)
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(Settings -&gt; Identity Settings)
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466504"><span class="hs-var">#settings</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Settings
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621682466505"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mReadLastMetadataGC"><span class="hs-identifier hs-type">mReadLastMetadataGC</span></a></span><span>
</span><span id="line-481"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../time/html/src"><span class="hs-identifier hs-type">POSIXTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span id="mReadLastMetadataGC"><span class="annot"><span class="annottext">mReadLastMetadataGC :: ModelOp (Maybe POSIXTime)
</span><a href="Cardano.Pool.DB.Model.html#mReadLastMetadataGC"><span class="hs-identifier hs-var hs-var">mReadLastMetadataGC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Maybe POSIXTime -&gt; Const (Maybe POSIXTime) (Maybe POSIXTime))
 -&gt; PoolDatabase -&gt; Const (Maybe POSIXTime) PoolDatabase)
-&gt; ModelOp (Maybe POSIXTime)
forall a.
((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsLabel
  &quot;internalState&quot;
  ((InternalState -&gt; Const (Maybe POSIXTime) InternalState)
   -&gt; PoolDatabase -&gt; Const (Maybe POSIXTime) PoolDatabase)
(InternalState -&gt; Const (Maybe POSIXTime) InternalState)
-&gt; PoolDatabase -&gt; Const (Maybe POSIXTime) PoolDatabase
</span><a href="#local-6989586621682466503"><span class="hs-var">#internalState</span></a></span><span> </span><span class="annot"><span class="annottext">((InternalState -&gt; Const (Maybe POSIXTime) InternalState)
 -&gt; PoolDatabase -&gt; Const (Maybe POSIXTime) PoolDatabase)
-&gt; ((Maybe POSIXTime -&gt; Const (Maybe POSIXTime) (Maybe POSIXTime))
    -&gt; InternalState -&gt; Const (Maybe POSIXTime) InternalState)
-&gt; (Maybe POSIXTime -&gt; Const (Maybe POSIXTime) (Maybe POSIXTime))
-&gt; PoolDatabase
-&gt; Const (Maybe POSIXTime) PoolDatabase
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;lastMetadataGC&quot;
  ((Maybe POSIXTime -&gt; Const (Maybe POSIXTime) (Maybe POSIXTime))
   -&gt; InternalState -&gt; Const (Maybe POSIXTime) InternalState)
(Maybe POSIXTime -&gt; Const (Maybe POSIXTime) (Maybe POSIXTime))
-&gt; InternalState -&gt; Const (Maybe POSIXTime) InternalState
</span><a href="#local-6989586621682466502"><span class="hs-var">#lastMetadataGC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-483"></span><span>
</span><span id="line-484"></span><span class="annot"><a href="Cardano.Pool.DB.Model.html#mPutLastMetadataGC"><span class="hs-identifier hs-type">mPutLastMetadataGC</span></a></span><span>
</span><span id="line-485"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../time/html/src"><span class="hs-identifier hs-type">POSIXTime</span></a></span><span>
</span><span id="line-486"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-487"></span><span id="mPutLastMetadataGC"><span class="annot"><span class="annottext">mPutLastMetadataGC :: POSIXTime -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#mPutLastMetadataGC"><span class="hs-identifier hs-var hs-var">mPutLastMetadataGC</span></a></span></span><span> </span><span id="local-6989586621682466501"><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621682466501"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Maybe POSIXTime -&gt; Identity (Maybe POSIXTime))
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (Maybe POSIXTime -&gt; Maybe POSIXTime) -&gt; ModelOp ()
forall a b.
((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsLabel
  &quot;internalState&quot;
  ((InternalState -&gt; Identity InternalState)
   -&gt; PoolDatabase -&gt; Identity PoolDatabase)
(InternalState -&gt; Identity InternalState)
-&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466500"><span class="hs-var">#internalState</span></a></span><span> </span><span class="annot"><span class="annottext">((InternalState -&gt; Identity InternalState)
 -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; ((Maybe POSIXTime -&gt; Identity (Maybe POSIXTime))
    -&gt; InternalState -&gt; Identity InternalState)
-&gt; (Maybe POSIXTime -&gt; Identity (Maybe POSIXTime))
-&gt; PoolDatabase
-&gt; Identity PoolDatabase
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;lastMetadataGC&quot;
  ((Maybe POSIXTime -&gt; Identity (Maybe POSIXTime))
   -&gt; InternalState -&gt; Identity InternalState)
(Maybe POSIXTime -&gt; Identity (Maybe POSIXTime))
-&gt; InternalState -&gt; Identity InternalState
</span><a href="#local-6989586621682466499"><span class="hs-var">#lastMetadataGC</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Maybe POSIXTime
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; Maybe POSIXTime
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621682466501"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-490"></span><span class="hs-comment">-- Utilities</span><span>
</span><span id="line-491"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span class="hs-comment">-- Get the value of a particular field from the database.</span><span>
</span><span id="line-494"></span><span class="hs-comment">--</span><span>
</span><span id="line-495"></span><span id="local-6989586621682466944"><span class="annot"><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-type">get</span></a></span><span>
</span><span id="line-496"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682466944"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Const</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682466944"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682466944"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolDatabase"><span class="hs-identifier hs-type">PoolDatabase</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Const</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682466944"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolDatabase"><span class="hs-identifier hs-type">PoolDatabase</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>    </span><span class="hs-comment">-- ^ Database field label.</span><span>
</span><span id="line-498"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682466944"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-499"></span><span id="get"><span class="annot"><span class="annottext">get :: ((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; ModelOp a
</span><a href="Cardano.Pool.DB.Model.html#get"><span class="hs-identifier hs-var hs-var">get</span></a></span></span><span> </span><span id="local-6989586621682466498"><span class="annot"><span class="annottext">(a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase
</span><a href="#local-6989586621682466498"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PoolDatabase -&gt; a) -&gt; ModelOp a
forall (m :: * -&gt; *) s a. Monad m =&gt; (s -&gt; a) -&gt; StateT s m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">State.gets</span></a></span><span> </span><span class="annot"><span class="annottext">((PoolDatabase -&gt; a) -&gt; ModelOp a)
-&gt; (PoolDatabase -&gt; a) -&gt; ModelOp a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase)
-&gt; PoolDatabase -&gt; a
forall a s. ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; s -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Const a a) -&gt; PoolDatabase -&gt; Const a PoolDatabase
</span><a href="#local-6989586621682466498"><span class="hs-keyword hs-var">label</span></a></span><span>
</span><span id="line-500"></span><span>
</span><span id="line-501"></span><span class="hs-comment">-- Modify the value of a particular field within the database.</span><span>
</span><span id="line-502"></span><span class="hs-comment">--</span><span>
</span><span id="line-503"></span><span id="local-6989586621682466980"><span id="local-6989586621682466981"><span class="annot"><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-type">modify</span></a></span><span>
</span><span id="line-504"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682466981"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Identity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682466980"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolDatabase"><span class="hs-identifier hs-type">PoolDatabase</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Identity</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#PoolDatabase"><span class="hs-identifier hs-type">PoolDatabase</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span>    </span><span class="hs-comment">-- ^ Database field label.</span><span>
</span><span id="line-506"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682466981"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682466980"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>    </span><span class="hs-comment">-- ^ Modification function.</span><span>
</span><span id="line-508"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Model.html#ModelOp"><span class="hs-identifier hs-type">ModelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-509"></span><span id="modify"><span class="annot"><span class="annottext">modify :: ((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; ModelOp ()
</span><a href="Cardano.Pool.DB.Model.html#modify"><span class="hs-identifier hs-var hs-var">modify</span></a></span></span><span> </span><span id="local-6989586621682466496"><span class="annot"><span class="annottext">(a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466496"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PoolDatabase -&gt; PoolDatabase) -&gt; ModelOp ()
forall (m :: * -&gt; *) s. Monad m =&gt; (s -&gt; s) -&gt; StateT s m ()
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">State.modify</span></a></span><span> </span><span class="annot"><span class="annottext">((PoolDatabase -&gt; PoolDatabase) -&gt; ModelOp ())
-&gt; ((a -&gt; b) -&gt; PoolDatabase -&gt; PoolDatabase)
-&gt; (a -&gt; b)
-&gt; ModelOp ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase)
-&gt; (a -&gt; b) -&gt; PoolDatabase -&gt; PoolDatabase
forall a b s t.
((a -&gt; Identity b) -&gt; s -&gt; Identity t) -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">over</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Identity b) -&gt; PoolDatabase -&gt; Identity PoolDatabase
</span><a href="#local-6989586621682466496"><span class="hs-keyword hs-var">label</span></a></span><span>
</span><span id="line-510"></span></pre></body></html>