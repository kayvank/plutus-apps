<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE OverloadedLabels #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- Copyright: &#169; 2021 IOHK</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- License: Apache-2.0</span><span>
</span><span id="line-10"></span><span class="hs-comment">--</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- Data type that represents a collection of checkpoints.</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- Each checkpoints is associated with a 'Slot'.</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Cardano.Wallet.Checkpoints</span><span>
</span><span id="line-15"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Checkpoints</span></span><span>
</span><span id="line-16"></span><span>      </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#Checkpoints"><span class="hs-identifier">Checkpoints</span></a></span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#checkpoints"><span class="hs-identifier">checkpoints</span></a></span><span>
</span><span id="line-18"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#loadCheckpoints"><span class="hs-identifier">loadCheckpoints</span></a></span><span>
</span><span id="line-19"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#fromGenesis"><span class="hs-identifier">fromGenesis</span></a></span><span>
</span><span id="line-20"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#getLatest"><span class="hs-identifier">getLatest</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#findNearestPoint"><span class="hs-identifier">findNearestPoint</span></a></span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Delta types</span></span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#DeltaCheckpoints"><span class="hs-identifier">DeltaCheckpoints</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#DeltasCheckpoints"><span class="hs-identifier">DeltasCheckpoints</span></a></span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Checkpoint hygiene</span></span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#SparseCheckpointsConfig"><span class="hs-identifier">SparseCheckpointsConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#defaultSparseCheckpointsConfig"><span class="hs-identifier">defaultSparseCheckpointsConfig</span></a></span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#sparseCheckpoints"><span class="hs-identifier">sparseCheckpoints</span></a></span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#gapSize"><span class="hs-identifier">gapSize</span></a></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Prelude</span></a></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier">Data.Delta</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier">Delta</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../generic-lens/html/src"><span class="hs-identifier">Data.Generics.Internal.VL.Lens</span></a></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../generic-lens/html/src"><span class="hs-identifier">over</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../generic-lens/html/src"><span class="hs-identifier">view</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Map</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">fromMaybe</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Quantity.html"><span class="hs-identifier">Data.Quantity</span></a></span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier">Quantity</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Word</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Word32</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Word8</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../fmt/html/src"><span class="hs-identifier">Fmt</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../formatting/html/src"><span class="hs-identifier">Buildable</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../fmt/html/src"><span class="hs-identifier">listF</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-comment">{- NOTE [PointSlotNo]

'SlotNo' cannot represent the genesis point.

Historical hack. The DB layer can't represent 'Origin' in the database,
instead we have mapped it to 'SlotNo 0', which is wrong.

Rolling back to SlotNo 0 instead of Origin is fine for followers starting
from genesis (which should be the majority of cases). Other, non-trivial
rollbacks to genesis cannot occur on mainnet (genesis is years within
stable part, and there were no rollbacks in byron).

Could possibly be problematic in the beginning of a testnet without a
byron era. /Perhaps/ this is what is happening in the
&gt;&gt;&gt; [cardano-wallet.pools-engine:Error:1293] [2020-11-24 10:02:04.00 UTC]
&gt;&gt;&gt; Couldn't store production for given block before it conflicts with
&gt;&gt;&gt; another block. Conflicting block header is:
&gt;&gt;&gt; 5bde7e7b&lt;-[f1b35b98-4290#2008]
errors observed in the integration tests.

The issue has been partially fixed in that 'rollbackTo' now takes
a 'Slot' as argument, which can represent the 'Origin'.
However, the database itself mostly stores slot numbers.

FIXME LATER during ADP-1043: As we move towards in-memory data,
all slot numbers in the DB file will either be replaced by
the 'Slot' type, or handled slightly differently when it
is clear that the data cannot exist at the genesis point
(e.g. for TxHistory).

-}</span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Checkpoints
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- | Collection of checkpoints indexed by 'Slot'.</span><span>
</span><span id="line-94"></span><span id="local-6989586621682459603"><span id="local-6989586621682459604"></span></span><span class="hs-keyword">newtype</span><span> </span><span id="Checkpoints"><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#Checkpoints"><span class="hs-identifier hs-var">Checkpoints</span></a></span></span><span> </span><span id="local-6989586621682459688"><span class="annot"><a href="#local-6989586621682459688"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Checkpoints"><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#Checkpoints"><span class="hs-identifier hs-var">Checkpoints</span></a></span></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="checkpoints"><span class="annot"><span class="annottext">Checkpoints a -&gt; Map Slot a
</span><a href="Cardano.Wallet.Checkpoints.html#checkpoints"><span class="hs-identifier hs-var hs-var">checkpoints</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Slot"><span class="hs-identifier hs-type">W.Slot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682459688"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-comment">-- ^ Map of checkpoints. Always contains the genesis checkpoint.</span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682459598"><span id="local-6989586621682459600"><span class="annot"><span class="annottext">Checkpoints a -&gt; Checkpoints a -&gt; Bool
(Checkpoints a -&gt; Checkpoints a -&gt; Bool)
-&gt; (Checkpoints a -&gt; Checkpoints a -&gt; Bool) -&gt; Eq (Checkpoints a)
forall a. Eq a =&gt; Checkpoints a -&gt; Checkpoints a -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Checkpoints a -&gt; Checkpoints a -&gt; Bool
$c/= :: forall a. Eq a =&gt; Checkpoints a -&gt; Checkpoints a -&gt; Bool
== :: Checkpoints a -&gt; Checkpoints a -&gt; Bool
$c== :: forall a. Eq a =&gt; Checkpoints a -&gt; Checkpoints a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span id="local-6989586621682459591"><span id="local-6989586621682459593"><span id="local-6989586621682459595"><span class="annot"><span class="annottext">Int -&gt; Checkpoints a -&gt; ShowS
[Checkpoints a] -&gt; ShowS
Checkpoints a -&gt; String
(Int -&gt; Checkpoints a -&gt; ShowS)
-&gt; (Checkpoints a -&gt; String)
-&gt; ([Checkpoints a] -&gt; ShowS)
-&gt; Show (Checkpoints a)
forall a. Show a =&gt; Int -&gt; Checkpoints a -&gt; ShowS
forall a. Show a =&gt; [Checkpoints a] -&gt; ShowS
forall a. Show a =&gt; Checkpoints a -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Checkpoints a] -&gt; ShowS
$cshowList :: forall a. Show a =&gt; [Checkpoints a] -&gt; ShowS
show :: Checkpoints a -&gt; String
$cshow :: forall a. Show a =&gt; Checkpoints a -&gt; String
showsPrec :: Int -&gt; Checkpoints a -&gt; ShowS
$cshowsPrec :: forall a. Show a =&gt; Int -&gt; Checkpoints a -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">(forall x. Checkpoints a -&gt; Rep (Checkpoints a) x)
-&gt; (forall x. Rep (Checkpoints a) x -&gt; Checkpoints a)
-&gt; Generic (Checkpoints a)
forall x. Rep (Checkpoints a) x -&gt; Checkpoints a
forall x. Checkpoints a -&gt; Rep (Checkpoints a) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall a x. Rep (Checkpoints a) x -&gt; Checkpoints a
forall a x. Checkpoints a -&gt; Rep (Checkpoints a) x
$cto :: forall a x. Rep (Checkpoints a) x -&gt; Checkpoints a
$cfrom :: forall a x. Checkpoints a -&gt; Rep (Checkpoints a) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span class="hs-comment">-- FIXME LATER during ADP-1043:</span><span>
</span><span id="line-99"></span><span class="hs-comment">--  Use a more sophisticated 'Checkpoints' type that stores deltas.</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="hs-comment">-- | Turn the list of checkpoints into a map of checkpoints.</span><span>
</span><span id="line-102"></span><span class="hs-comment">--</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- FIXME LATER during ADP-1043:</span><span>
</span><span id="line-104"></span><span class="hs-comment">--   The database actually does not store the checkpoint at genesis,</span><span>
</span><span id="line-105"></span><span class="hs-comment">--   but the checkpoint after that.</span><span>
</span><span id="line-106"></span><span class="hs-comment">--   Hence, this function does not check whether the genesis checkpoint</span><span>
</span><span id="line-107"></span><span class="hs-comment">--   is in the list of checkpoints.</span><span>
</span><span id="line-108"></span><span id="local-6989586621682459586"><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#loadCheckpoints"><span class="hs-identifier hs-type">loadCheckpoints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Slot"><span class="hs-identifier hs-type">W.Slot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682459586"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#Checkpoints"><span class="hs-identifier hs-type">Checkpoints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682459586"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-109"></span><span id="loadCheckpoints"><span class="annot"><span class="annottext">loadCheckpoints :: [(Slot, a)] -&gt; Checkpoints a
</span><a href="Cardano.Wallet.Checkpoints.html#loadCheckpoints"><span class="hs-identifier hs-var hs-var">loadCheckpoints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Slot a -&gt; Checkpoints a
forall a. Map Slot a -&gt; Checkpoints a
</span><a href="Cardano.Wallet.Checkpoints.html#Checkpoints"><span class="hs-identifier hs-var">Checkpoints</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Slot a -&gt; Checkpoints a)
-&gt; ([(Slot, a)] -&gt; Map Slot a) -&gt; [(Slot, a)] -&gt; Checkpoints a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[(Slot, a)] -&gt; Map Slot a
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-comment">-- | Begin with the genesis checkpoint.</span><span>
</span><span id="line-112"></span><span id="local-6989586621682459583"><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#fromGenesis"><span class="hs-identifier hs-type">fromGenesis</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621682459583"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#Checkpoints"><span class="hs-identifier hs-type">Checkpoints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682459583"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-113"></span><span id="fromGenesis"><span class="annot"><span class="annottext">fromGenesis :: a -&gt; Checkpoints a
</span><a href="Cardano.Wallet.Checkpoints.html#fromGenesis"><span class="hs-identifier hs-var hs-var">fromGenesis</span></a></span></span><span> </span><span id="local-6989586621682459582"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682459582"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Slot a -&gt; Checkpoints a
forall a. Map Slot a -&gt; Checkpoints a
</span><a href="Cardano.Wallet.Checkpoints.html#Checkpoints"><span class="hs-identifier hs-var">Checkpoints</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Slot a -&gt; Checkpoints a) -&gt; Map Slot a -&gt; Checkpoints a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; a -&gt; Map Slot a
forall k a. k -&gt; a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.singleton</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
forall t. WithOrigin t
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">W.Origin</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682459582"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="hs-comment">-- | Get the checkpoint with the largest 'SlotNo'.</span><span>
</span><span id="line-116"></span><span id="local-6989586621682459579"><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#getLatest"><span class="hs-identifier hs-type">getLatest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#Checkpoints"><span class="hs-identifier hs-type">Checkpoints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682459579"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Slot"><span class="hs-identifier hs-type">W.Slot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682459579"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-117"></span><span id="getLatest"><span class="annot"><span class="annottext">getLatest :: Checkpoints a -&gt; (Slot, a)
</span><a href="Cardano.Wallet.Checkpoints.html#getLatest"><span class="hs-identifier hs-var hs-var">getLatest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Slot, a) -&gt; (Slot, a)
forall a. Maybe a -&gt; a
</span><a href="#local-6989586621682459578"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Slot, a) -&gt; (Slot, a))
-&gt; (Checkpoints a -&gt; Maybe (Slot, a)) -&gt; Checkpoints a -&gt; (Slot, a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map Slot a -&gt; Maybe (Slot, a)
forall k a. Map k a -&gt; Maybe (k, a)
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookupMax</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Slot a -&gt; Maybe (Slot, a))
-&gt; (Checkpoints a -&gt; Map Slot a)
-&gt; Checkpoints a
-&gt; Maybe (Slot, a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((Map Slot a -&gt; Const (Map Slot a) (Map Slot a))
 -&gt; Checkpoints a -&gt; Const (Map Slot a) (Checkpoints a))
-&gt; Checkpoints a -&gt; Map Slot a
forall a s. ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; s -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;checkpoints&quot;
  ((Map Slot a -&gt; Const (Map Slot a) (Map Slot a))
   -&gt; Checkpoints a -&gt; Const (Map Slot a) (Checkpoints a))
(Map Slot a -&gt; Const (Map Slot a) (Map Slot a))
-&gt; Checkpoints a -&gt; Const (Map Slot a) (Checkpoints a)
</span><a href="#local-6989586621682459576"><span class="hs-var">#checkpoints</span></a></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-119"></span><span>    </span><span id="local-6989586621682459578"><span class="annot"><span class="annottext">from :: Maybe a -&gt; a
</span><a href="#local-6989586621682459578"><span class="hs-identifier hs-var hs-var">from</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a -&gt; a
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; a
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;getLatest: there should always be at least a genesis checkpoint&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-comment">-- | Find the nearest 'Checkpoint' that is either at the given point or before.</span><span>
</span><span id="line-122"></span><span id="local-6989586621682459574"><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#findNearestPoint"><span class="hs-identifier hs-type">findNearestPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#Checkpoints"><span class="hs-identifier hs-type">Checkpoints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682459574"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Slot"><span class="hs-identifier hs-type">W.Slot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Slot"><span class="hs-identifier hs-type">W.Slot</span></a></span></span><span>
</span><span id="line-123"></span><span id="findNearestPoint"><span class="annot"><span class="annottext">findNearestPoint :: Checkpoints a -&gt; Slot -&gt; Maybe Slot
</span><a href="Cardano.Wallet.Checkpoints.html#findNearestPoint"><span class="hs-identifier hs-var hs-var">findNearestPoint</span></a></span></span><span> </span><span id="local-6989586621682459573"><span class="annot"><span class="annottext">Checkpoints a
</span><a href="#local-6989586621682459573"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682459572"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682459572"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Slot, a) -&gt; Slot
forall a b. (a, b) -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">((Slot, a) -&gt; Slot) -&gt; Maybe (Slot, a) -&gt; Maybe Slot
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Map Slot a -&gt; Maybe (Slot, a)
forall k v. Ord k =&gt; k -&gt; Map k v -&gt; Maybe (k, v)
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookupLE</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682459572"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Map Slot a -&gt; Const (Map Slot a) (Map Slot a))
 -&gt; Checkpoints a -&gt; Const (Map Slot a) (Checkpoints a))
-&gt; Checkpoints a -&gt; Map Slot a
forall a s. ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; s -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;checkpoints&quot;
  ((Map Slot a -&gt; Const (Map Slot a) (Map Slot a))
   -&gt; Checkpoints a -&gt; Const (Map Slot a) (Checkpoints a))
(Map Slot a -&gt; Const (Map Slot a) (Map Slot a))
-&gt; Checkpoints a -&gt; Const (Map Slot a) (Checkpoints a)
</span><a href="#local-6989586621682459569"><span class="hs-var">#checkpoints</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoints a
</span><a href="#local-6989586621682459573"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Delta type for Checkpoints
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-128"></span><span class="hs-keyword">type</span><span> </span><span id="DeltasCheckpoints"><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#DeltasCheckpoints"><span class="hs-identifier hs-var">DeltasCheckpoints</span></a></span></span><span> </span><span id="local-6989586621682459568"><span class="annot"><a href="#local-6989586621682459568"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#DeltaCheckpoints"><span class="hs-identifier hs-type">DeltaCheckpoints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682459568"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="hs-keyword">data</span><span> </span><span id="DeltaCheckpoints"><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#DeltaCheckpoints"><span class="hs-identifier hs-var">DeltaCheckpoints</span></a></span></span><span> </span><span id="local-6989586621682459567"><span class="annot"><a href="#local-6989586621682459567"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="PutCheckpoint"><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#PutCheckpoint"><span class="hs-identifier hs-var">PutCheckpoint</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Slot"><span class="hs-identifier hs-type">W.Slot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682459567"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="RollbackTo"><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#RollbackTo"><span class="hs-identifier hs-var">RollbackTo</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Slot"><span class="hs-identifier hs-type">W.Slot</span></a></span><span>
</span><span id="line-133"></span><span>        </span><span class="hs-comment">-- Rolls back to the latest checkpoint at or before this slot.</span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="RestrictTo"><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#RestrictTo"><span class="hs-identifier hs-var">RestrictTo</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Slot"><span class="hs-identifier hs-type">W.Slot</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-135"></span><span>        </span><span class="hs-comment">-- ^ Restrict to the intersection of this list with</span><span>
</span><span id="line-136"></span><span>        </span><span class="hs-comment">-- the checkpoints that are already present.</span><span>
</span><span id="line-137"></span><span>        </span><span class="hs-comment">-- The genesis checkpoint will always be present.</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span id="local-6989586621682459563"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-type">Delta</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#DeltaCheckpoints"><span class="hs-identifier hs-type">DeltaCheckpoints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682459563"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-keyword">type</span><span> </span><span id="Base"><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">Base</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#DeltaCheckpoints"><span class="hs-identifier hs-type">DeltaCheckpoints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682459563"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#Checkpoints"><span class="hs-identifier hs-type">Checkpoints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682459563"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span id="local-6989586621682459560"><span class="annot"><span class="annottext">apply :: DeltaCheckpoints a
-&gt; Base (DeltaCheckpoints a) -&gt; Base (DeltaCheckpoints a)
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">apply</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#PutCheckpoint"><span class="hs-identifier hs-type">PutCheckpoint</span></a></span><span> </span><span id="local-6989586621682459558"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682459558"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621682459557"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682459557"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Map Slot a -&gt; Identity (Map Slot a))
 -&gt; Checkpoints a -&gt; Identity (Checkpoints a))
-&gt; (Map Slot a -&gt; Map Slot a) -&gt; Checkpoints a -&gt; Checkpoints a
forall a b s t.
((a -&gt; Identity b) -&gt; s -&gt; Identity t) -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">over</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;checkpoints&quot;
  ((Map Slot a -&gt; Identity (Map Slot a))
   -&gt; Checkpoints a -&gt; Identity (Checkpoints a))
(Map Slot a -&gt; Identity (Map Slot a))
-&gt; Checkpoints a -&gt; Identity (Checkpoints a)
</span><a href="#local-6989586621682459556"><span class="hs-var">#checkpoints</span></a></span><span> </span><span class="annot"><span class="annottext">((Map Slot a -&gt; Map Slot a) -&gt; Checkpoints a -&gt; Checkpoints a)
-&gt; (Map Slot a -&gt; Map Slot a) -&gt; Checkpoints a -&gt; Checkpoints a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; a -&gt; Map Slot a -&gt; Map Slot a
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682459558"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682459557"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-142"></span><span>    </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#RollbackTo"><span class="hs-identifier hs-type">RollbackTo</span></a></span><span> </span><span id="local-6989586621682459554"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682459554"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Map Slot a -&gt; Identity (Map Slot a))
 -&gt; Checkpoints a -&gt; Identity (Checkpoints a))
-&gt; (Map Slot a -&gt; Map Slot a) -&gt; Checkpoints a -&gt; Checkpoints a
forall a b s t.
((a -&gt; Identity b) -&gt; s -&gt; Identity t) -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">over</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;checkpoints&quot;
  ((Map Slot a -&gt; Identity (Map Slot a))
   -&gt; Checkpoints a -&gt; Identity (Checkpoints a))
(Map Slot a -&gt; Identity (Map Slot a))
-&gt; Checkpoints a -&gt; Identity (Checkpoints a)
</span><a href="#local-6989586621682459553"><span class="hs-var">#checkpoints</span></a></span><span> </span><span class="annot"><span class="annottext">((Map Slot a -&gt; Map Slot a) -&gt; Checkpoints a -&gt; Checkpoints a)
-&gt; (Map Slot a -&gt; Map Slot a) -&gt; Checkpoints a -&gt; Checkpoints a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-143"></span><span>        </span><span class="annot"><span class="annottext">(Slot -&gt; a -&gt; Bool) -&gt; Map Slot a -&gt; Map Slot a
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filterWithKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682459551"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682459551"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682459551"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Slot -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682459554"><span class="hs-identifier hs-var">pt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>    </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#RestrictTo"><span class="hs-identifier hs-type">RestrictTo</span></a></span><span> </span><span id="local-6989586621682459549"><span class="annot"><span class="annottext">[Slot]
</span><a href="#local-6989586621682459549"><span class="hs-identifier hs-var">pts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Map Slot a -&gt; Identity (Map Slot a))
 -&gt; Checkpoints a -&gt; Identity (Checkpoints a))
-&gt; (Map Slot a -&gt; Map Slot a) -&gt; Checkpoints a -&gt; Checkpoints a
forall a b s t.
((a -&gt; Identity b) -&gt; s -&gt; Identity t) -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">over</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;checkpoints&quot;
  ((Map Slot a -&gt; Identity (Map Slot a))
   -&gt; Checkpoints a -&gt; Identity (Checkpoints a))
(Map Slot a -&gt; Identity (Map Slot a))
-&gt; Checkpoints a -&gt; Identity (Checkpoints a)
</span><a href="#local-6989586621682459548"><span class="hs-var">#checkpoints</span></a></span><span> </span><span class="annot"><span class="annottext">((Map Slot a -&gt; Map Slot a) -&gt; Checkpoints a -&gt; Checkpoints a)
-&gt; (Map Slot a -&gt; Map Slot a) -&gt; Checkpoints a -&gt; Checkpoints a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682459547"><span class="annot"><span class="annottext">Map Slot a
</span><a href="#local-6989586621682459547"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-145"></span><span>        </span><span class="annot"><span class="annottext">Map Slot a -&gt; Set Slot -&gt; Map Slot a
forall k a. Ord k =&gt; Map k a -&gt; Set k -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.restrictKeys</span></a></span><span> </span><span class="annot"><span class="annottext">Map Slot a
</span><a href="#local-6989586621682459547"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">(Set Slot -&gt; Map Slot a) -&gt; Set Slot -&gt; Map Slot a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Slot] -&gt; Set Slot
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slot
forall t. WithOrigin t
</span><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-var">W.Origin</span></a></span><span class="annot"><span class="annottext">Slot -&gt; [Slot] -&gt; [Slot]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[Slot]
</span><a href="#local-6989586621682459549"><span class="hs-identifier hs-var">pts</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span id="local-6989586621682459544"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../formatting/html/src"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#DeltaCheckpoints"><span class="hs-identifier hs-type">DeltaCheckpoints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682459544"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-148"></span><span>    </span><span id="local-6989586621682459541"><span class="annot"><span class="annottext">build :: DeltaCheckpoints a -&gt; Builder
</span><a href="../../../../formatting/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">build</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#PutCheckpoint"><span class="hs-identifier hs-type">PutCheckpoint</span></a></span><span> </span><span id="local-6989586621682459539"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682459539"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot;PutCheckpoint &quot;</span></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Builder
forall p. Buildable p =&gt; p -&gt; Builder
</span><a href="../../../../formatting/html/src"><span class="hs-identifier hs-var">build</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682459539"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-149"></span><span>    </span><span class="annot"><a href="../../../../formatting/html/src"><span class="hs-identifier hs-var">build</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#RollbackTo"><span class="hs-identifier hs-type">RollbackTo</span></a></span><span> </span><span id="local-6989586621682459538"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682459538"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot;RollbackTo &quot;</span></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Builder
forall p. Buildable p =&gt; p -&gt; Builder
</span><a href="../../../../formatting/html/src"><span class="hs-identifier hs-var">build</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682459538"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><a href="../../../../formatting/html/src"><span class="hs-identifier hs-var">build</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#RestrictTo"><span class="hs-identifier hs-type">RestrictTo</span></a></span><span> </span><span id="local-6989586621682459537"><span class="annot"><span class="annottext">[Slot]
</span><a href="#local-6989586621682459537"><span class="hs-identifier hs-var">slots</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot;RestrictTo &quot;</span></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Slot] -&gt; Builder
forall (f :: * -&gt; *) a. (Foldable f, Buildable a) =&gt; f a -&gt; Builder
</span><a href="../../../../fmt/html/src"><span class="hs-identifier hs-var">listF</span></a></span><span> </span><span class="annot"><span class="annottext">[Slot]
</span><a href="#local-6989586621682459537"><span class="hs-identifier hs-var">slots</span></a></span></span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Checkpoint hygiene
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-155"></span><span class="hs-comment">-- | Storing EVERY checkpoints in the database is quite expensive and useless.</span><span>
</span><span id="line-156"></span><span class="hs-comment">-- We make the following assumptions:</span><span>
</span><span id="line-157"></span><span class="hs-comment">--</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- - We can't rollback for more than `k=epochStability` blocks in the past</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- - It is pretty fast to re-sync a few hundred blocks</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- - Small rollbacks may occur more often than deep ones</span><span>
</span><span id="line-161"></span><span class="hs-comment">--</span><span>
</span><span id="line-162"></span><span class="hs-comment">-- So, as we insert checkpoints, we make sure to:</span><span>
</span><span id="line-163"></span><span class="hs-comment">--</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- - Prune any checkpoint that more than `k` blocks in the past</span><span>
</span><span id="line-165"></span><span class="hs-comment">-- - Keep only one checkpoint every 100 blocks</span><span>
</span><span id="line-166"></span><span class="hs-comment">-- - But still keep ~10 most recent checkpoints to cope with small rollbacks</span><span>
</span><span id="line-167"></span><span class="hs-comment">--</span><span>
</span><span id="line-168"></span><span class="hs-comment">-- __Example 1__: Inserting `cp153`</span><span>
</span><span id="line-169"></span><span class="hs-comment">--</span><span>
</span><span id="line-170"></span><span class="hs-comment">--  &#8505;: `cp142` is discarded and `cp153` inserted.</span><span>
</span><span id="line-171"></span><span class="hs-comment">--</span><span>
</span><span id="line-172"></span><span class="hs-comment">--  @</span><span>
</span><span id="line-173"></span><span class="hs-comment">--  Currently in DB:</span><span>
</span><span id="line-174"></span><span class="hs-comment">-- &#9484;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;  &#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9488;</span><span>
</span><span id="line-175"></span><span class="hs-comment">-- &#9474;cp000 &#9474;cp100 &#9474;cp142 &#9474;..    ..&#9474;cp152 &#9474;</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- &#9492;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;  &#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9496;</span><span>
</span><span id="line-177"></span><span class="hs-comment">--  Want in DB:</span><span>
</span><span id="line-178"></span><span class="hs-comment">-- &#9484;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;  &#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9488;</span><span>
</span><span id="line-179"></span><span class="hs-comment">-- &#9474;cp000 &#9474;cp100 &#9474;cp143 &#9474;..    ..&#9474;cp153 &#9474;</span><span>
</span><span id="line-180"></span><span class="hs-comment">-- &#9492;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;  &#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9496;</span><span>
</span><span id="line-181"></span><span class="hs-comment">--  @</span><span>
</span><span id="line-182"></span><span class="hs-comment">--</span><span>
</span><span id="line-183"></span><span class="hs-comment">--</span><span>
</span><span id="line-184"></span><span class="hs-comment">--  __Example 2__: Inserting `cp111`</span><span>
</span><span id="line-185"></span><span class="hs-comment">--</span><span>
</span><span id="line-186"></span><span class="hs-comment">--  &#8505;: `cp100` is kept and `cp111` inserted.</span><span>
</span><span id="line-187"></span><span class="hs-comment">--</span><span>
</span><span id="line-188"></span><span class="hs-comment">--  @</span><span>
</span><span id="line-189"></span><span class="hs-comment">--  Currently in DB:</span><span>
</span><span id="line-190"></span><span class="hs-comment">-- &#9484;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;  &#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9488;</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- &#9474;cp000 &#9474;cp100 &#9474;cp101 &#9474;..    ..&#9474;cp110 &#9474;</span><span>
</span><span id="line-192"></span><span class="hs-comment">-- &#9492;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;  &#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9496;</span><span>
</span><span id="line-193"></span><span class="hs-comment">--  Want in DB:</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- &#9484;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;  &#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9488;</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- &#9474;cp000 &#9474;cp100 &#9474;cp101 &#9474;..    ..&#9474;cp111 &#9474;</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- &#9492;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;  &#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9496;</span><span>
</span><span id="line-197"></span><span class="hs-comment">--  @</span><span>
</span><span id="line-198"></span><span class="hs-comment">--</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- NOTE: There might be cases where the chain following &quot;fails&quot; (because, for</span><span>
</span><span id="line-200"></span><span class="hs-comment">-- example, the node has switched to a different chain, different by more than k),</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- and in such cases, we have no choice but rolling back from genesis.</span><span>
</span><span id="line-202"></span><span class="hs-comment">-- Therefore, we need to keep the very first checkpoint in the database, no</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- matter what.</span><span>
</span><span id="line-204"></span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#sparseCheckpoints"><span class="hs-identifier hs-type">sparseCheckpoints</span></a></span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#SparseCheckpointsConfig"><span class="hs-identifier hs-type">SparseCheckpointsConfig</span></a></span><span>
</span><span id="line-206"></span><span>        </span><span class="hs-comment">-- ^ Parameters for the function.</span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-type">Quantity</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;block&quot;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span>
</span><span id="line-208"></span><span>        </span><span class="hs-comment">-- ^ A given block height</span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-210"></span><span>        </span><span class="hs-comment">-- ^ The list of checkpoint heights that should be kept in DB.</span><span>
</span><span id="line-211"></span><span id="sparseCheckpoints"><span class="annot"><span class="annottext">sparseCheckpoints :: SparseCheckpointsConfig -&gt; Quantity &quot;block&quot; Word32 -&gt; [Word32]
</span><a href="Cardano.Wallet.Checkpoints.html#sparseCheckpoints"><span class="hs-identifier hs-var hs-var">sparseCheckpoints</span></a></span></span><span> </span><span id="local-6989586621682459536"><span class="annot"><span class="annottext">SparseCheckpointsConfig
</span><a href="#local-6989586621682459536"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621682459535"><span class="annot"><span class="annottext">Quantity &quot;block&quot; Word32
</span><a href="#local-6989586621682459535"><span class="hs-identifier hs-var">blkH</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-213"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#SparseCheckpointsConfig"><span class="hs-identifier hs-type">SparseCheckpointsConfig</span></a></span><span class="hs-special">{</span><span id="local-6989586621682459533"><span class="annot"><span class="annottext">Word8
edgeSize :: SparseCheckpointsConfig -&gt; Word8
edgeSize :: Word8
</span><a href="Cardano.Wallet.Checkpoints.html#edgeSize"><span class="hs-identifier hs-var hs-var">edgeSize</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682459531"><span class="annot"><span class="annottext">Word32
epochStability :: SparseCheckpointsConfig -&gt; Word32
epochStability :: Word32
</span><a href="Cardano.Wallet.Checkpoints.html#epochStability"><span class="hs-identifier hs-var hs-var">epochStability</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SparseCheckpointsConfig
</span><a href="#local-6989586621682459536"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-214"></span><span>        </span><span id="local-6989586621682459529"><span class="annot"><span class="annottext">g :: Word32
</span><a href="#local-6989586621682459529"><span class="hs-identifier hs-var hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SparseCheckpointsConfig -&gt; Word32
</span><a href="Cardano.Wallet.Checkpoints.html#gapSize"><span class="hs-identifier hs-var">gapSize</span></a></span><span> </span><span class="annot"><span class="annottext">SparseCheckpointsConfig
</span><a href="#local-6989586621682459536"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-215"></span><span>        </span><span id="local-6989586621682459528"><span class="annot"><span class="annottext">h :: Word32
</span><a href="#local-6989586621682459528"><span class="hs-identifier hs-var hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Quantity &quot;block&quot; Word32 -&gt; Word32
forall (unit :: Symbol) a. Quantity unit a -&gt; a
</span><a href="Data.Quantity.html#getQuantity"><span class="hs-identifier hs-var hs-var">getQuantity</span></a></span><span> </span><span class="annot"><span class="annottext">Quantity &quot;block&quot; Word32
</span><a href="#local-6989586621682459535"><span class="hs-identifier hs-var">blkH</span></a></span><span>
</span><span id="line-216"></span><span>        </span><span id="local-6989586621682459526"><span class="annot"><span class="annottext">e :: Word32
</span><a href="#local-6989586621682459526"><span class="hs-identifier hs-var hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621682459533"><span class="hs-identifier hs-var">edgeSize</span></a></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span>        </span><span id="local-6989586621682459525"><span class="annot"><span class="annottext">minH :: Word32
</span><a href="#local-6989586621682459525"><span class="hs-identifier hs-var hs-var">minH</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-219"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682459524"><span class="annot"><span class="annottext">x :: Word32
</span><a href="#local-6989586621682459524"><span class="hs-identifier hs-var hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459528"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459531"><span class="hs-identifier hs-var">epochStability</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459529"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459528"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459531"><span class="hs-identifier hs-var">epochStability</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459529"><span class="hs-identifier hs-var">g</span></a></span><span>
</span><span id="line-220"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459529"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459524"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`div`</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459529"><span class="hs-identifier hs-var">g</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span>        </span><span id="local-6989586621682459519"><span class="annot"><span class="annottext">initial :: Word32
</span><a href="#local-6989586621682459519"><span class="hs-identifier hs-var hs-var">initial</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span>
</span><span id="line-223"></span><span>        </span><span id="local-6989586621682459518"><span class="annot"><span class="annottext">longTerm :: [Word32]
</span><a href="#local-6989586621682459518"><span class="hs-identifier hs-var hs-var">longTerm</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459525"><span class="hs-identifier hs-var">minH</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459525"><span class="hs-identifier hs-var">minH</span></a></span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459529"><span class="hs-identifier hs-var">g</span></a></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459528"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-224"></span><span>        </span><span id="local-6989586621682459517"><span class="annot"><span class="annottext">shortTerm :: [Word32]
</span><a href="#local-6989586621682459517"><span class="hs-identifier hs-var hs-var">shortTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459528"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459526"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-225"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459528"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-226"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459528"><span class="hs-identifier hs-var">h</span></a></span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459526"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459528"><span class="hs-identifier hs-var">h</span></a></span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459526"><span class="hs-identifier hs-var">e</span></a></span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">1</span></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459528"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-228"></span><span>        </span><span class="annot"><span class="annottext">[Word32] -&gt; [Word32]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">L.sort</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Word32] -&gt; [Word32]
forall a. Eq a =&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">L.nub</span></a></span><span> </span><span class="annot"><span class="annottext">([Word32] -&gt; [Word32]) -&gt; [Word32] -&gt; [Word32]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459519"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; [Word32] -&gt; [Word32]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Word32]
</span><a href="#local-6989586621682459518"><span class="hs-identifier hs-var">longTerm</span></a></span><span> </span><span class="annot"><span class="annottext">[Word32] -&gt; [Word32] -&gt; [Word32]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[Word32]
</span><a href="#local-6989586621682459517"><span class="hs-identifier hs-var">shortTerm</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span class="hs-comment">-- | Captures the configuration for the `sparseCheckpoints` function.</span><span>
</span><span id="line-231"></span><span class="hs-comment">--</span><span>
</span><span id="line-232"></span><span class="hs-comment">-- NOTE: large values of 'edgeSize' aren't recommended as they would mean</span><span>
</span><span id="line-233"></span><span class="hs-comment">-- storing many unnecessary checkpoints. In Ouroboros Praos, there's a</span><span>
</span><span id="line-234"></span><span class="hs-comment">-- reasonable probability for small forks each a few blocks deep so it makes sense to</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- maintain a small part that is denser near the edge.</span><span>
</span><span id="line-236"></span><span class="hs-keyword">data</span><span> </span><span id="SparseCheckpointsConfig"><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#SparseCheckpointsConfig"><span class="hs-identifier hs-var">SparseCheckpointsConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SparseCheckpointsConfig"><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#SparseCheckpointsConfig"><span class="hs-identifier hs-var">SparseCheckpointsConfig</span></a></span></span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="edgeSize"><span class="annot"><span class="annottext">SparseCheckpointsConfig -&gt; Word8
</span><a href="Cardano.Wallet.Checkpoints.html#edgeSize"><span class="hs-identifier hs-var hs-var">edgeSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word8</span></a></span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="epochStability"><span class="annot"><span class="annottext">SparseCheckpointsConfig -&gt; Word32
</span><a href="Cardano.Wallet.Checkpoints.html#epochStability"><span class="hs-identifier hs-var hs-var">epochStability</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621682459509"><span id="local-6989586621682459511"><span id="local-6989586621682459513"><span class="annot"><span class="annottext">Int -&gt; SparseCheckpointsConfig -&gt; ShowS
[SparseCheckpointsConfig] -&gt; ShowS
SparseCheckpointsConfig -&gt; String
(Int -&gt; SparseCheckpointsConfig -&gt; ShowS)
-&gt; (SparseCheckpointsConfig -&gt; String)
-&gt; ([SparseCheckpointsConfig] -&gt; ShowS)
-&gt; Show SparseCheckpointsConfig
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SparseCheckpointsConfig] -&gt; ShowS
$cshowList :: [SparseCheckpointsConfig] -&gt; ShowS
show :: SparseCheckpointsConfig -&gt; String
$cshow :: SparseCheckpointsConfig -&gt; String
showsPrec :: Int -&gt; SparseCheckpointsConfig -&gt; ShowS
$cshowsPrec :: Int -&gt; SparseCheckpointsConfig -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="hs-comment">-- | A sensible default to use in production. See also 'SparseCheckpointsConfig'</span><span>
</span><span id="line-242"></span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#defaultSparseCheckpointsConfig"><span class="hs-identifier hs-type">defaultSparseCheckpointsConfig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-type">Quantity</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;block&quot;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#SparseCheckpointsConfig"><span class="hs-identifier hs-type">SparseCheckpointsConfig</span></a></span><span>
</span><span id="line-243"></span><span id="defaultSparseCheckpointsConfig"><span class="annot"><span class="annottext">defaultSparseCheckpointsConfig :: Quantity &quot;block&quot; Word32 -&gt; SparseCheckpointsConfig
</span><a href="Cardano.Wallet.Checkpoints.html#defaultSparseCheckpointsConfig"><span class="hs-identifier hs-var hs-var">defaultSparseCheckpointsConfig</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-type">Quantity</span></a></span><span> </span><span id="local-6989586621682459507"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459507"><span class="hs-identifier hs-var">epochStability</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><span class="annottext">SparseCheckpointsConfig :: Word8 -&gt; Word32 -&gt; SparseCheckpointsConfig
</span><a href="Cardano.Wallet.Checkpoints.html#SparseCheckpointsConfig"><span class="hs-identifier hs-type">SparseCheckpointsConfig</span></a></span><span>
</span><span id="line-245"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">edgeSize :: Word8
</span><a href="Cardano.Wallet.Checkpoints.html#edgeSize"><span class="hs-identifier hs-var">edgeSize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">5</span></span><span>
</span><span id="line-246"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word32
epochStability :: Word32
epochStability :: Word32
</span><a href="#local-6989586621682459507"><span class="hs-identifier hs-var hs-var">epochStability</span></a></span><span>
</span><span id="line-247"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span class="hs-comment">-- | A reasonable gap size used internally in 'sparseCheckpoints'.</span><span>
</span><span id="line-250"></span><span class="hs-comment">--</span><span>
</span><span id="line-251"></span><span class="hs-comment">-- 'Reasonable' means that it's not _too frequent_ and it's not too large. A</span><span>
</span><span id="line-252"></span><span class="hs-comment">-- value that is too small in front of k would require generating much more</span><span>
</span><span id="line-253"></span><span class="hs-comment">-- checkpoints than necessary.</span><span>
</span><span id="line-254"></span><span class="hs-comment">--</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- A value that is larger than `k` may have dramatic consequences in case of</span><span>
</span><span id="line-256"></span><span class="hs-comment">-- deep rollbacks.</span><span>
</span><span id="line-257"></span><span class="hs-comment">--</span><span>
</span><span id="line-258"></span><span class="hs-comment">-- As a middle ground, we current choose `k / 3`, which is justified by:</span><span>
</span><span id="line-259"></span><span class="hs-comment">--</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- - The current speed of the network layer (several thousands blocks per seconds)</span><span>
</span><span id="line-261"></span><span class="hs-comment">-- - The current value of k = 2160</span><span>
</span><span id="line-262"></span><span class="hs-comment">--</span><span>
</span><span id="line-263"></span><span class="hs-comment">-- So, `k / 3` = 720, which should remain around a second of time needed to catch</span><span>
</span><span id="line-264"></span><span class="hs-comment">-- up in case of large rollbacks.</span><span>
</span><span id="line-265"></span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#gapSize"><span class="hs-identifier hs-type">gapSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#SparseCheckpointsConfig"><span class="hs-identifier hs-type">SparseCheckpointsConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span>
</span><span id="line-266"></span><span id="gapSize"><span class="annot"><span class="annottext">gapSize :: SparseCheckpointsConfig -&gt; Word32
</span><a href="Cardano.Wallet.Checkpoints.html#gapSize"><span class="hs-identifier hs-var hs-var">gapSize</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#SparseCheckpointsConfig"><span class="hs-identifier hs-type">SparseCheckpointsConfig</span></a></span><span class="hs-special">{</span><span id="local-6989586621682459506"><span class="annot"><span class="annottext">Word32
epochStability :: Word32
epochStability :: SparseCheckpointsConfig -&gt; Word32
</span><a href="#local-6989586621682459506"><span class="hs-identifier hs-var hs-var">epochStability</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-267"></span><span>    </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682459506"><span class="hs-identifier hs-var">epochStability</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`div`</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">3</span></span><span>
</span><span id="line-268"></span></pre></body></html>