<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE FunctionalDependencies #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- Copyright: &#169; 2018-2020 IOHK</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- License: Apache-2.0</span><span>
</span><span id="line-15"></span><span class="hs-comment">--</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- This module contains types for address discovery. The two address discovery</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- schemes implemented are:</span><span>
</span><span id="line-18"></span><span class="hs-comment">--</span><span>
</span><span id="line-19"></span><span class="hs-comment">--  * &quot;Cardano.Wallet.Primitive.AddressDiscovery.Sequential&quot;</span><span>
</span><span id="line-20"></span><span class="hs-comment">--  * &quot;Cardano.Wallet.Primitive.AddressDiscovery.Random&quot;</span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Cardano.Wallet.Primitive.AddressDiscovery</span><span>
</span><span id="line-23"></span><span>    </span><span class="hs-special">(</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Abstractions</span></span><span>
</span><span id="line-25"></span><span>      </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#IsOurs"><span class="hs-identifier">IsOurs</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#IsOwned"><span class="hs-identifier">IsOwned</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#GenChange"><span class="hs-identifier">GenChange</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#CompareDiscovery"><span class="hs-identifier">CompareDiscovery</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#KnownAddresses"><span class="hs-identifier">KnownAddresses</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#GetPurpose"><span class="hs-identifier">GetPurpose</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#GetAccount"><span class="hs-identifier">GetAccount</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#coinTypeAda"><span class="hs-identifier">coinTypeAda</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#MaybeLight"><span class="hs-identifier">MaybeLight</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#DiscoverTxs"><span class="hs-identifier">DiscoverTxs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier">PendingIxs</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#emptyPendingIxs"><span class="hs-identifier">emptyPendingIxs</span></a></span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#pendingIxsToList"><span class="hs-identifier">pendingIxsToList</span></a></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#pendingIxsFromList"><span class="hs-identifier">pendingIxsFromList</span></a></span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#nextChangeIndex"><span class="hs-identifier">nextChangeIndex</span></a></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#updatePendingIxs"><span class="hs-identifier">updatePendingIxs</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Prelude</span></a></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier">Cardano.Crypto.Wallet</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier">XPrv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier">XPub</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html"><span class="hs-identifier">Cardano.Wallet.Primitive.AddressDerivation</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Depth"><span class="hs-identifier">Depth</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#DerivationIndex"><span class="hs-identifier">DerivationIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#DerivationType"><span class="hs-identifier">DerivationType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier">Index</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#KeyFingerprint"><span class="hs-identifier">KeyFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.RewardAccount.html#RewardAccount"><span class="hs-identifier">RewardAccount</span></a></span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.BlockSummary.html"><span class="hs-identifier">Cardano.Wallet.Primitive.BlockSummary</span></a></span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.BlockSummary.html#ChainEvents"><span class="hs-identifier">ChainEvents</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Passphrase.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Passphrase</span></a></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Passphrase.Types.html#Passphrase"><span class="hs-identifier">Passphrase</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.Address</span></a></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier">Address</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#AddressState"><span class="hs-identifier">AddressState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Util.html"><span class="hs-identifier">Cardano.Wallet.Util</span></a></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Util.html#invariant"><span class="hs-identifier">invariant</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier">Control.DeepSeq</span></a></span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier">NFData</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Kind</span></a></span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier">Type</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">NonEmpty</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Address.Pool.html"><span class="hs-identifier">Cardano.Wallet.Address.Pool</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AddressPool</span></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-comment">-- | Checks whether or not a given entity belongs to us.</span><span>
</span><span id="line-77"></span><span class="hs-comment">--</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- This abstraction exists to give us the ability to keep the wallet business</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- logic agnostic to the address derivation and discovery mechanisms.</span><span>
</span><span id="line-80"></span><span class="hs-comment">--</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- This is needed because two different address schemes lives on Cardano:</span><span>
</span><span id="line-82"></span><span class="hs-comment">--</span><span>
</span><span id="line-83"></span><span class="hs-comment">--   - A hierarchical random scheme:</span><span>
</span><span id="line-84"></span><span class="hs-comment">--      rather 'custom' made, with several flaws; this is the original and now</span><span>
</span><span id="line-85"></span><span class="hs-comment">--      legacy address scheme.</span><span>
</span><span id="line-86"></span><span class="hs-comment">--</span><span>
</span><span id="line-87"></span><span class="hs-comment">--   - A hierarchical sequential scheme:</span><span>
</span><span id="line-88"></span><span class="hs-comment">--      a new scheme based on the BIP-0044 specification, which is better suited</span><span>
</span><span id="line-89"></span><span class="hs-comment">--      for our present needs.</span><span>
</span><span id="line-90"></span><span class="hs-comment">--</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- In practice, we will need a wallet that can support both, even if not at the</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- same time, and this little abstraction can buy us this without introducing</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- too much overhead.</span><span>
</span><span id="line-94"></span><span class="hs-keyword">class</span><span> </span><span id="IsOurs"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#IsOurs"><span class="hs-identifier hs-var">IsOurs</span></a></span></span><span> </span><span id="local-6989586621682442941"><span class="annot"><a href="#local-6989586621682442941"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621682442940"><span class="annot"><a href="#local-6989586621682442940"><span class="hs-identifier hs-type">entity</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-95"></span><span>    </span><span id="isOurs"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#isOurs"><span class="hs-identifier hs-type">isOurs</span></a></span></span><span>
</span><span id="line-96"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621682442940"><span class="hs-identifier hs-type">entity</span></a></span><span>
</span><span id="line-97"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682442941"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-98"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#DerivationIndex"><span class="hs-identifier hs-type">DerivationIndex</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682442941"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>        </span><span class="hs-comment">-- ^ Returns derivation path if the entity is ours, otherwise Nothing.</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="hs-comment">-- | More powerful than 'isOurs', this abstractions offer the underlying state</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- the ability to find / compute the address private key corresponding to a</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- given known address.</span><span>
</span><span id="line-104"></span><span class="hs-comment">--</span><span>
</span><span id="line-105"></span><span class="hs-comment">-- Requiring 'IsOwned' as a constraint supposed that there is a way to recover</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- the root private key of a particular wallet. This isn't true for externally</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- owned wallet which would delegate its key management to a third party (like</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- a hardware Ledger or Trezor).</span><span>
</span><span id="line-109"></span><span class="hs-keyword">class</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#IsOurs"><span class="hs-identifier hs-type">IsOurs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442938"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="IsOwned"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#IsOwned"><span class="hs-identifier hs-var">IsOwned</span></a></span></span><span> </span><span id="local-6989586621682442938"><span class="annot"><a href="#local-6989586621682442938"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621682442937"><span class="annot"><a href="#local-6989586621682442937"><span class="hs-identifier hs-type">key</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-110"></span><span>    </span><span id="isOwned"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#isOwned"><span class="hs-identifier hs-type">isOwned</span></a></span></span><span>
</span><span id="line-111"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621682442938"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-112"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682442937"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#RootK"><span class="hs-identifier hs-type">RootK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPrv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Passphrase.Types.html#Passphrase"><span class="hs-identifier hs-type">Passphrase</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;encryption&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a></span><span>
</span><span id="line-114"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682442937"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AddressK"><span class="hs-identifier hs-type">AddressK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPrv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Passphrase.Types.html#Passphrase"><span class="hs-identifier hs-type">Passphrase</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;encryption&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>        </span><span class="hs-comment">-- ^ Derive the private key corresponding to an address. Careful, this</span><span>
</span><span id="line-116"></span><span>        </span><span class="hs-comment">-- operation can be costly. Note that the state is discarded from this</span><span>
</span><span id="line-117"></span><span>        </span><span class="hs-comment">-- function as we do not intend to discover any addresses from this</span><span>
</span><span id="line-118"></span><span>        </span><span class="hs-comment">-- operation; This is merely a lookup from known addresses.</span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="hs-comment">-- | Abstracting over change address generation. In theory, this is only needed</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- for sending transactions on a wallet following a particular scheme. This</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- abstractions allows for defining an heuristic to pick new change address. For</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- instance, in BIP-44, change addresses belong to a particular change chain</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- (also called &quot;Internal Chain&quot;).</span><span>
</span><span id="line-125"></span><span class="hs-keyword">class</span><span> </span><span id="GenChange"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#GenChange"><span class="hs-identifier hs-var">GenChange</span></a></span></span><span> </span><span id="local-6989586621682442933"><span class="annot"><a href="#local-6989586621682442933"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-keyword">type</span><span> </span><span id="ArgGenChange"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#ArgGenChange"><span class="hs-identifier hs-var">ArgGenChange</span></a></span></span><span> </span><span id="local-6989586621682442933"><span class="annot"><a href="#local-6989586621682442933"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span id="genChange"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#genChange"><span class="hs-identifier hs-type">genChange</span></a></span></span><span>
</span><span id="line-128"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#ArgGenChange"><span class="hs-identifier hs-type">ArgGenChange</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442933"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-129"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682442933"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-130"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682442933"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>        </span><span class="hs-comment">-- ^ Generate a new change address for the given scheme. The rules for</span><span>
</span><span id="line-132"></span><span>        </span><span class="hs-comment">-- generating a new change address depends on the underlying scheme.</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span class="hs-comment">-- | Ordering addresses by discovery date.</span><span>
</span><span id="line-135"></span><span class="hs-comment">--</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- If `a1` has been discovered before `a2`, then the following equation holds:</span><span>
</span><span id="line-137"></span><span class="hs-comment">--</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- compareDiscovery s a1 a2 == LT</span><span>
</span><span id="line-140"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-141"></span><span class="hs-comment">--</span><span>
</span><span id="line-142"></span><span class="hs-comment">-- If `a1` has been discovered after `a2`, then the following equation holds:</span><span>
</span><span id="line-143"></span><span class="hs-comment">--</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-145"></span><span class="hs-comment">-- compareDiscovery s a1 a2 == GT</span><span>
</span><span id="line-146"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-147"></span><span class="hs-comment">--</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- Note that, if an address isn't known it is considered not discovered and</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- therefore, is always _greater than_ any known address.</span><span>
</span><span id="line-150"></span><span class="hs-keyword">class</span><span> </span><span id="CompareDiscovery"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#CompareDiscovery"><span class="hs-identifier hs-var">CompareDiscovery</span></a></span></span><span> </span><span id="local-6989586621682442930"><span class="annot"><a href="#local-6989586621682442930"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-151"></span><span>    </span><span id="compareDiscovery"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#compareDiscovery"><span class="hs-identifier hs-type">compareDiscovery</span></a></span></span><span>
</span><span id="line-152"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621682442930"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-153"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a></span><span>
</span><span id="line-154"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a></span><span>
</span><span id="line-155"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ordering</span></a></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span class="hs-comment">-- | Extract the list of all known addresses.</span><span>
</span><span id="line-158"></span><span class="hs-comment">--</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- NOTE: Change addresses aren't considered &quot;known&quot; until they've been used. The</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- rationale is that, we don't want users or consumers of the wallet to be using</span><span>
</span><span id="line-161"></span><span class="hs-comment">-- change addresses prematurely.</span><span>
</span><span id="line-162"></span><span class="hs-keyword">class</span><span> </span><span id="KnownAddresses"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#KnownAddresses"><span class="hs-identifier hs-var">KnownAddresses</span></a></span></span><span> </span><span id="local-6989586621682442928"><span class="annot"><a href="#local-6989586621682442928"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-163"></span><span>    </span><span id="knownAddresses"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#knownAddresses"><span class="hs-identifier hs-type">knownAddresses</span></a></span></span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621682442928"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-165"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#AddressState"><span class="hs-identifier hs-type">AddressState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#DerivationIndex"><span class="hs-identifier hs-type">DerivationIndex</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span class="hs-comment">-- | One master node (seed) can be used for unlimited number of independent</span><span>
</span><span id="line-168"></span><span class="hs-comment">-- cryptocoins such as Bitcoin, Litecoin or Namecoin. However, sharing the</span><span>
</span><span id="line-169"></span><span class="hs-comment">-- same space for various cryptocoins has some disadvantages.</span><span>
</span><span id="line-170"></span><span class="hs-comment">--</span><span>
</span><span id="line-171"></span><span class="hs-comment">-- This level creates a separate subtree for every cryptocoin, avoiding reusing</span><span>
</span><span id="line-172"></span><span class="hs-comment">-- addresses across cryptocoins and improving privacy issues.</span><span>
</span><span id="line-173"></span><span class="hs-comment">--</span><span>
</span><span id="line-174"></span><span class="hs-comment">-- Coin type is a constant, set for each cryptocoin. For Cardano this constant</span><span>
</span><span id="line-175"></span><span class="hs-comment">-- is set to 1815' (or 0x80000717). 1815 is the birthyear of our beloved Ada</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- Lovelace.</span><span>
</span><span id="line-177"></span><span class="hs-comment">--</span><span>
</span><span id="line-178"></span><span class="hs-comment">-- Hardened derivation is used at this level.</span><span>
</span><span id="line-179"></span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#coinTypeAda"><span class="hs-identifier hs-type">coinTypeAda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Hardened"><span class="hs-identifier hs-type">Hardened</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#CoinTypeK"><span class="hs-identifier hs-type">CoinTypeK</span></a></span><span>
</span><span id="line-180"></span><span id="coinTypeAda"><span class="annot"><span class="annottext">coinTypeAda :: Index 'Hardened 'CoinTypeK
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#coinTypeAda"><span class="hs-identifier hs-var hs-var">coinTypeAda</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Index 'Hardened 'CoinTypeK
forall a. Enum a =&gt; Int -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toEnum</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0x80000717</span></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">-- It is used for getting purpose for a given key.</span><span>
</span><span id="line-183"></span><span class="hs-keyword">class</span><span> </span><span id="GetPurpose"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#GetPurpose"><span class="hs-identifier hs-var">GetPurpose</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682442925"><span class="annot"><a href="#local-6989586621682442925"><span class="hs-identifier hs-type">key</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Depth"><span class="hs-identifier hs-type">Depth</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-184"></span><span>    </span><span id="getPurpose"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#getPurpose"><span class="hs-identifier hs-type">getPurpose</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Hardened"><span class="hs-identifier hs-type">Hardened</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PurposeK"><span class="hs-identifier hs-type">PurposeK</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">-- It is used for getting account public key for a given state.</span><span>
</span><span id="line-187"></span><span class="hs-keyword">class</span><span> </span><span id="GetAccount"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#GetAccount"><span class="hs-identifier hs-var">GetAccount</span></a></span></span><span> </span><span id="local-6989586621682442922"><span class="annot"><a href="#local-6989586621682442922"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682442921"><span class="annot"><a href="#local-6989586621682442921"><span class="hs-identifier hs-type">key</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Depth"><span class="hs-identifier hs-type">Depth</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="#local-6989586621682442922"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682442921"><span class="hs-identifier hs-type">key</span></a></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-188"></span><span>    </span><span id="getAccount"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#getAccount"><span class="hs-identifier hs-type">getAccount</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621682442922"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682442921"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#AccountK"><span class="hs-identifier hs-type">AccountK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-crypto/html/src"><span class="hs-identifier hs-type">XPub</span></a></span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-comment">-- | Checks whether the address discovery state @s@ works in light-mode</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- and returns a procedure for discovering addresses</span><span>
</span><span id="line-192"></span><span class="hs-comment">-- if that is indeed the case.</span><span>
</span><span id="line-193"></span><span class="hs-keyword">class</span><span> </span><span id="MaybeLight"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#MaybeLight"><span class="hs-identifier hs-var">MaybeLight</span></a></span></span><span> </span><span id="local-6989586621682442918"><span class="annot"><a href="#local-6989586621682442918"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-194"></span><span>    </span><span id="maybeDiscover"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#maybeDiscover"><span class="hs-identifier hs-type">maybeDiscover</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#LightDiscoverTxs"><span class="hs-identifier hs-type">LightDiscoverTxs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442918"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span class="hs-keyword">type</span><span> </span><span id="LightDiscoverTxs"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#LightDiscoverTxs"><span class="hs-identifier hs-var">LightDiscoverTxs</span></a></span></span><span> </span><span id="local-6989586621682442915"><span class="annot"><a href="#local-6989586621682442915"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#DiscoverTxs"><span class="hs-identifier hs-type">DiscoverTxs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.RewardAccount.html#RewardAccount"><span class="hs-identifier hs-type">RewardAccount</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.BlockSummary.html#ChainEvents"><span class="hs-identifier hs-type">ChainEvents</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442915"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span class="hs-comment">-- | Function that discovers transactions based on an address.</span><span>
</span><span id="line-200"></span><span class="hs-keyword">newtype</span><span> </span><span id="DiscoverTxs"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#DiscoverTxs"><span class="hs-identifier hs-var">DiscoverTxs</span></a></span></span><span> </span><span id="local-6989586621682442914"><span class="annot"><a href="#local-6989586621682442914"><span class="hs-identifier hs-type">addr</span></a></span></span><span> </span><span id="local-6989586621682442913"><span class="annot"><a href="#local-6989586621682442913"><span class="hs-identifier hs-type">txs</span></a></span></span><span> </span><span id="local-6989586621682442912"><span class="annot"><a href="#local-6989586621682442912"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DiscoverTxs"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#DiscoverTxs"><span class="hs-identifier hs-var">DiscoverTxs</span></a></span></span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="discoverTxs"><span class="annot"><span class="annottext">DiscoverTxs addr txs s
-&gt; forall (m :: * -&gt; *).
   Monad m =&gt;
   (addr -&gt; m txs) -&gt; s -&gt; m (txs, s)
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#discoverTxs"><span class="hs-identifier hs-var hs-var">discoverTxs</span></a></span></span><span>
</span><span id="line-202"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682443018"><span class="annot"><a href="#local-6989586621682443018"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682443018"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-203"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682442914"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682443018"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442913"><span class="hs-identifier hs-type">txs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682442912"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682443018"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682442913"><span class="hs-identifier hs-type">txs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621682442912"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span class="hs-comment">{-------------------------------------------------------------------------------
                            Pending Change Indexes
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span class="hs-comment">-- | An ordered set of pending indexes. This keep track of indexes used</span><span>
</span><span id="line-211"></span><span id="local-6989586621682442908"><span id="local-6989586621682442909"></span></span><span class="hs-keyword">newtype</span><span> </span><span id="PendingIxs"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-var">PendingIxs</span></a></span></span><span> </span><span id="local-6989586621682442997"><span class="annot"><a href="#local-6989586621682442997"><span class="hs-identifier hs-type">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PendingIxs"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-var">PendingIxs</span></a></span></span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="pendingIxsToList"><span class="annot"><span class="annottext">PendingIxs k -&gt; [Index 'Soft k]
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#pendingIxsToList"><span class="hs-identifier hs-var hs-var">pendingIxsToList</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Soft"><span class="hs-identifier hs-type">Soft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442997"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. PendingIxs k -&gt; Rep (PendingIxs k) x)
-&gt; (forall x. Rep (PendingIxs k) x -&gt; PendingIxs k)
-&gt; Generic (PendingIxs k)
forall x. Rep (PendingIxs k) x -&gt; PendingIxs k
forall x. PendingIxs k -&gt; Rep (PendingIxs k) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (k :: Depth) x. Rep (PendingIxs k) x -&gt; PendingIxs k
forall (k :: Depth) x. PendingIxs k -&gt; Rep (PendingIxs k) x
$cto :: forall (k :: Depth) x. Rep (PendingIxs k) x -&gt; PendingIxs k
$cfrom :: forall (k :: Depth) x. PendingIxs k -&gt; Rep (PendingIxs k) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682442898"><span id="local-6989586621682442900"><span id="local-6989586621682442902"><span class="annot"><span class="annottext">Int -&gt; PendingIxs k -&gt; ShowS
[PendingIxs k] -&gt; ShowS
PendingIxs k -&gt; String
(Int -&gt; PendingIxs k -&gt; ShowS)
-&gt; (PendingIxs k -&gt; String)
-&gt; ([PendingIxs k] -&gt; ShowS)
-&gt; Show (PendingIxs k)
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
forall (k :: Depth). Int -&gt; PendingIxs k -&gt; ShowS
forall (k :: Depth). [PendingIxs k] -&gt; ShowS
forall (k :: Depth). PendingIxs k -&gt; String
showList :: [PendingIxs k] -&gt; ShowS
$cshowList :: forall (k :: Depth). [PendingIxs k] -&gt; ShowS
show :: PendingIxs k -&gt; String
$cshow :: forall (k :: Depth). PendingIxs k -&gt; String
showsPrec :: Int -&gt; PendingIxs k -&gt; ShowS
$cshowsPrec :: forall (k :: Depth). Int -&gt; PendingIxs k -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682442893"><span id="local-6989586621682442895"><span class="annot"><span class="annottext">PendingIxs k -&gt; PendingIxs k -&gt; Bool
(PendingIxs k -&gt; PendingIxs k -&gt; Bool)
-&gt; (PendingIxs k -&gt; PendingIxs k -&gt; Bool) -&gt; Eq (PendingIxs k)
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
forall (k :: Depth). PendingIxs k -&gt; PendingIxs k -&gt; Bool
/= :: PendingIxs k -&gt; PendingIxs k -&gt; Bool
$c/= :: forall (k :: Depth). PendingIxs k -&gt; PendingIxs k -&gt; Bool
== :: PendingIxs k -&gt; PendingIxs k -&gt; Bool
$c== :: forall (k :: Depth). PendingIxs k -&gt; PendingIxs k -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span id="local-6989586621682442891"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682442889"><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-type">PendingIxs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442891"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="hs-comment">-- | An empty pending set of change indexes.</span><span>
</span><span id="line-218"></span><span class="hs-comment">--</span><span>
</span><span id="line-219"></span><span class="hs-comment">-- NOTE: We do not define a 'Monoid' instance here because there's no rational</span><span>
</span><span id="line-220"></span><span class="hs-comment">-- of combining two pending sets.</span><span>
</span><span id="line-221"></span><span id="local-6989586621682442887"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#emptyPendingIxs"><span class="hs-identifier hs-type">emptyPendingIxs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-type">PendingIxs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442887"><span class="hs-identifier hs-type">k</span></a></span></span><span>
</span><span id="line-222"></span><span id="emptyPendingIxs"><span class="annot"><span class="annottext">emptyPendingIxs :: PendingIxs k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#emptyPendingIxs"><span class="hs-identifier hs-var hs-var">emptyPendingIxs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Index 'Soft k] -&gt; PendingIxs k
forall (k :: Depth). [Index 'Soft k] -&gt; PendingIxs k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-var">PendingIxs</span></a></span><span> </span><span class="annot"><span class="annottext">[Index 'Soft k]
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="hs-comment">-- | Construct a 'PendingIxs' from a list, ensuring that it is a set of indexes</span><span>
</span><span id="line-225"></span><span class="hs-comment">-- in descending order.</span><span>
</span><span id="line-226"></span><span id="local-6989586621682442886"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#pendingIxsFromList"><span class="hs-identifier hs-type">pendingIxsFromList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Soft"><span class="hs-identifier hs-type">Soft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442886"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-type">PendingIxs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442886"><span class="hs-identifier hs-type">k</span></a></span></span><span>
</span><span id="line-227"></span><span id="pendingIxsFromList"><span class="annot"><span class="annottext">pendingIxsFromList :: [Index 'Soft k] -&gt; PendingIxs k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#pendingIxsFromList"><span class="hs-identifier hs-var hs-var">pendingIxsFromList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Index 'Soft k] -&gt; PendingIxs k
forall (k :: Depth). [Index 'Soft k] -&gt; PendingIxs k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-var">PendingIxs</span></a></span><span> </span><span class="annot"><span class="annottext">([Index 'Soft k] -&gt; PendingIxs k)
-&gt; ([Index 'Soft k] -&gt; [Index 'Soft k])
-&gt; [Index 'Soft k]
-&gt; PendingIxs k
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[Index 'Soft k] -&gt; [Index 'Soft k]
forall a. [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">([Index 'Soft k] -&gt; [Index 'Soft k])
-&gt; ([Index 'Soft k] -&gt; [Index 'Soft k])
-&gt; [Index 'Soft k]
-&gt; [Index 'Soft k]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">([Index 'Soft k] -&gt; Index 'Soft k)
-&gt; [[Index 'Soft k]] -&gt; [Index 'Soft k]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">[Index 'Soft k] -&gt; Index 'Soft k
forall a. [a] -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">head</span></a></span><span> </span><span class="annot"><span class="annottext">([[Index 'Soft k]] -&gt; [Index 'Soft k])
-&gt; ([Index 'Soft k] -&gt; [[Index 'Soft k]])
-&gt; [Index 'Soft k]
-&gt; [Index 'Soft k]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[Index 'Soft k] -&gt; [[Index 'Soft k]]
forall a. Eq a =&gt; [a] -&gt; [[a]]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">L.group</span></a></span><span> </span><span class="annot"><span class="annottext">([Index 'Soft k] -&gt; [[Index 'Soft k]])
-&gt; ([Index 'Soft k] -&gt; [Index 'Soft k])
-&gt; [Index 'Soft k]
-&gt; [[Index 'Soft k]]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[Index 'Soft k] -&gt; [Index 'Soft k]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">L.sort</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span class="hs-comment">-- | Get the next change index; If every available indexes have already been</span><span>
</span><span id="line-230"></span><span class="hs-comment">-- taken, we'll rotate the pending set and re-use already provided indexes.</span><span>
</span><span id="line-231"></span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#nextChangeIndex"><span class="hs-identifier hs-type">nextChangeIndex</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682442880"><span class="annot"><a href="#local-6989586621682442880"><span class="hs-identifier hs-type">key</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Depth"><span class="hs-identifier hs-type">Depth</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682442879"><span class="annot"><a href="#local-6989586621682442879"><span class="hs-identifier hs-type">k</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-233"></span><span>       </span><span class="annot"><a href="Cardano.Wallet.Address.Pool.html#Pool"><span class="hs-identifier hs-type">AddressPool.Pool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#KeyFingerprint"><span class="hs-identifier hs-type">KeyFingerprint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;payment&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621682442880"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Soft"><span class="hs-identifier hs-type">Soft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442879"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-type">PendingIxs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442879"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Soft"><span class="hs-identifier hs-type">Soft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442879"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-type">PendingIxs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442879"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span id="nextChangeIndex"><span class="annot"><span class="annottext">nextChangeIndex :: Pool (KeyFingerprint &quot;payment&quot; key) (Index 'Soft k)
-&gt; PendingIxs k -&gt; (Index 'Soft k, PendingIxs k)
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#nextChangeIndex"><span class="hs-identifier hs-var hs-var">nextChangeIndex</span></a></span></span><span> </span><span id="local-6989586621682442878"><span class="annot"><span class="annottext">Pool (KeyFingerprint &quot;payment&quot; key) (Index 'Soft k)
</span><a href="#local-6989586621682442878"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-type">PendingIxs</span></a></span><span> </span><span id="local-6989586621682442877"><span class="annot"><span class="annottext">[Index 'Soft k]
</span><a href="#local-6989586621682442877"><span class="hs-identifier hs-var">ixs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-238"></span><span>        </span><span id="local-6989586621682442876"><span class="annot"><span class="annottext">poolLen :: Int
</span><a href="#local-6989586621682442876"><span class="hs-identifier hs-var hs-var">poolLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pool (KeyFingerprint &quot;payment&quot; key) (Index 'Soft k) -&gt; Int
forall addr ix. Pool addr ix -&gt; Int
</span><a href="Cardano.Wallet.Address.Pool.html#size"><span class="hs-identifier hs-var">AddressPool.size</span></a></span><span>  </span><span class="annot"><span class="annottext">Pool (KeyFingerprint &quot;payment&quot; key) (Index 'Soft k)
</span><a href="#local-6989586621682442878"><span class="hs-identifier hs-var">pool</span></a></span><span>
</span><span id="line-239"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682442874"><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442874"><span class="hs-identifier hs-var">firstUnused</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682442873"><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442873"><span class="hs-identifier hs-var">lastUnused</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-240"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Index 'Soft k
forall a. Enum a =&gt; Int -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toEnum</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Index 'Soft k) -&gt; Int -&gt; Index 'Soft k
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682442876"><span class="hs-identifier hs-var">poolLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Pool (KeyFingerprint &quot;payment&quot; key) (Index 'Soft k) -&gt; Int
forall addr ix. Pool addr ix -&gt; Int
</span><a href="Cardano.Wallet.Address.Pool.html#gap"><span class="hs-identifier hs-var hs-var">AddressPool.gap</span></a></span><span> </span><span class="annot"><span class="annottext">Pool (KeyFingerprint &quot;payment&quot; key) (Index 'Soft k)
</span><a href="#local-6989586621682442878"><span class="hs-identifier hs-var">pool</span></a></span><span>
</span><span id="line-241"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Index 'Soft k
forall a. Enum a =&gt; Int -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toEnum</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Index 'Soft k) -&gt; Int -&gt; Index 'Soft k
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682442876"><span class="hs-identifier hs-var">poolLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-242"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682442871"><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442871"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682442870"><span class="annot"><span class="annottext">PendingIxs k
</span><a href="#local-6989586621682442870"><span class="hs-identifier hs-var">ixs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Index 'Soft k]
</span><a href="#local-6989586621682442877"><span class="hs-identifier hs-var">ixs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-244"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-245"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442874"><span class="hs-identifier hs-var">firstUnused</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Index 'Soft k] -&gt; PendingIxs k
forall (k :: Depth). [Index 'Soft k] -&gt; PendingIxs k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-var">PendingIxs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442874"><span class="hs-identifier hs-var">firstUnused</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>            </span><span id="local-6989586621682442869"><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442869"><span class="hs-identifier hs-var">h</span></a></span></span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">[Index 'Soft k]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Index 'Soft k] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[Index 'Soft k]
</span><a href="#local-6989586621682442877"><span class="hs-identifier hs-var">ixs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Pool (KeyFingerprint &quot;payment&quot; key) (Index 'Soft k) -&gt; Int
forall addr ix. Pool addr ix -&gt; Int
</span><a href="Cardano.Wallet.Address.Pool.html#gap"><span class="hs-identifier hs-var hs-var">AddressPool.gap</span></a></span><span> </span><span class="annot"><span class="annottext">Pool (KeyFingerprint &quot;payment&quot; key) (Index 'Soft k)
</span><a href="#local-6989586621682442878"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-247"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft k -&gt; Index 'Soft k
forall a. Enum a =&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">succ</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442869"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Index 'Soft k] -&gt; PendingIxs k
forall (k :: Depth). [Index 'Soft k] -&gt; PendingIxs k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-var">PendingIxs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft k -&gt; Index 'Soft k
forall a. Enum a =&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">succ</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442869"><span class="hs-identifier hs-var">h</span></a></span><span class="annot"><span class="annottext">Index 'Soft k -&gt; [Index 'Soft k] -&gt; [Index 'Soft k]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[Index 'Soft k]
</span><a href="#local-6989586621682442877"><span class="hs-identifier hs-var">ixs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>            </span><span id="local-6989586621682442865"><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442865"><span class="hs-identifier hs-var">h</span></a></span></span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621682442864"><span class="annot"><span class="annottext">[Index 'Soft k]
</span><a href="#local-6989586621682442864"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-249"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442865"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Index 'Soft k] -&gt; PendingIxs k
forall (k :: Depth). [Index 'Soft k] -&gt; PendingIxs k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-var">PendingIxs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Index 'Soft k]
</span><a href="#local-6989586621682442864"><span class="hs-identifier hs-var">q</span></a></span><span class="annot"><span class="annottext">[Index 'Soft k] -&gt; [Index 'Soft k] -&gt; [Index 'Soft k]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span class="hs-special">[</span><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442865"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-251"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; (Index 'Soft k, PendingIxs k)
-&gt; ((Index 'Soft k, PendingIxs k) -&gt; Bool)
-&gt; (Index 'Soft k, PendingIxs k)
forall a. HasCallStack =&gt; String -&gt; a -&gt; (a -&gt; Bool) -&gt; a
</span><a href="Cardano.Wallet.Util.html#invariant"><span class="hs-identifier hs-var">invariant</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;index is within first unused and last unused&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442871"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PendingIxs k
</span><a href="#local-6989586621682442870"><span class="hs-identifier hs-var">ixs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621682442863"><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442863"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">PendingIxs k
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442863"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft k -&gt; Index 'Soft k -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442874"><span class="hs-identifier hs-var">firstUnused</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442863"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft k -&gt; Index 'Soft k -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442873"><span class="hs-identifier hs-var">lastUnused</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="hs-comment">-- | Update the set of pending indexes by discarding every indexes _below_ the</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- given index.</span><span>
</span><span id="line-256"></span><span class="hs-comment">--</span><span>
</span><span id="line-257"></span><span class="hs-comment">-- Why is that?</span><span>
</span><span id="line-258"></span><span class="hs-comment">--</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- Because we really do care about the higher index that was last used in order</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- to know from where we can generate new indexes.</span><span>
</span><span id="line-261"></span><span id="local-6989586621682442860"><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#updatePendingIxs"><span class="hs-identifier hs-type">updatePendingIxs</span></a></span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Soft"><span class="hs-identifier hs-type">Soft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442860"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-263"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-type">PendingIxs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442860"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-type">PendingIxs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682442860"><span class="hs-identifier hs-type">k</span></a></span></span><span>
</span><span id="line-265"></span><span id="updatePendingIxs"><span class="annot"><span class="annottext">updatePendingIxs :: Index 'Soft k -&gt; PendingIxs k -&gt; PendingIxs k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#updatePendingIxs"><span class="hs-identifier hs-var hs-var">updatePendingIxs</span></a></span></span><span> </span><span id="local-6989586621682442859"><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442859"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-type">PendingIxs</span></a></span><span> </span><span id="local-6989586621682442858"><span class="annot"><span class="annottext">[Index 'Soft k]
</span><a href="#local-6989586621682442858"><span class="hs-identifier hs-var">ixs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-266"></span><span>    </span><span class="annot"><span class="annottext">[Index 'Soft k] -&gt; PendingIxs k
forall (k :: Depth). [Index 'Soft k] -&gt; PendingIxs k
</span><a href="Cardano.Wallet.Primitive.AddressDiscovery.html#PendingIxs"><span class="hs-identifier hs-var">PendingIxs</span></a></span><span> </span><span class="annot"><span class="annottext">([Index 'Soft k] -&gt; PendingIxs k)
-&gt; [Index 'Soft k] -&gt; PendingIxs k
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Index 'Soft k -&gt; Bool) -&gt; [Index 'Soft k] -&gt; [Index 'Soft k]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">L.filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index 'Soft k -&gt; Index 'Soft k -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Index 'Soft k
</span><a href="#local-6989586621682442859"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Index 'Soft k]
</span><a href="#local-6989586621682442858"><span class="hs-identifier hs-var">ixs</span></a></span><span>
</span><span id="line-267"></span></pre></body></html>