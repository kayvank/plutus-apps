<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE OverloadedLabels #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- Copyright: &#169; 2018-2020 IOHK</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- License: Apache-2.0</span><span>
</span><span id="line-14"></span><span class="hs-comment">--</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- An implementation of the DBLayer which uses Persistent and SQLite.</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Cardano.Wallet.DB.Layer</span><span>
</span><span id="line-18"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Directory of single-file wallet databases</span></span><span>
</span><span id="line-19"></span><span>      </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#newDBFactory"><span class="hs-identifier">newDBFactory</span></a></span><span>
</span><span id="line-20"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#findDatabases"><span class="hs-identifier">findDatabases</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#DBFactoryLog"><span class="hs-identifier">DBFactoryLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Internal implementation</span></span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#withDBLayer"><span class="hs-identifier">withDBLayer</span></a></span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#withDBLayerInMemory"><span class="hs-identifier">withDBLayerInMemory</span></a></span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#WalletDBLog"><span class="hs-identifier">WalletDBLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#CacheBehavior"><span class="hs-identifier">CacheBehavior</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Unbracketed internal implementation</span></span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#newDBLayerWith"><span class="hs-identifier">newDBLayerWith</span></a></span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#newDBLayerInMemory"><span class="hs-identifier">newDBLayerInMemory</span></a></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Interfaces</span></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier">PersistAddressBook</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Migration Support</span></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Migration.html#DefaultFieldValues"><span class="hs-identifier">DefaultFieldValues</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Prelude</span></a></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier">Cardano.Address.Derivation</span></a></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier">XPrv</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.BM.Data.Severity</span></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Severity</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.BM.Data.Tracer</span></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">HasPrivacyAnnotation</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">HasSeverityAnnotation</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html"><span class="hs-identifier">Cardano.DB.Sqlite</span></a></span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#DBLog"><span class="hs-identifier">DBLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#ForeignKeysSetting"><span class="hs-identifier">ForeignKeysSetting</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.DB.Sqlite.html#ForeignKeysEnabled"><span class="hs-identifier">ForeignKeysEnabled</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#SqliteContext"><span class="hs-identifier">SqliteContext</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#handleConstraint"><span class="hs-identifier">handleConstraint</span></a></span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#newInMemorySqliteContext"><span class="hs-identifier">newInMemorySqliteContext</span></a></span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#newSqliteContext"><span class="hs-identifier">newSqliteContext</span></a></span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#withConnectionPool"><span class="hs-identifier">withConnectionPool</span></a></span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.Delete.html"><span class="hs-identifier">Cardano.DB.Sqlite.Delete</span></a></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.Delete.html#DeleteSqliteDatabaseLog"><span class="hs-identifier">DeleteSqliteDatabaseLog</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.Delete.html#deleteSqliteDatabase"><span class="hs-identifier">deleteSqliteDatabase</span></a></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.Delete.html#newRefCount"><span class="hs-identifier">newRefCount</span></a></span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.Delete.html#waitForFree"><span class="hs-identifier">waitForFree</span></a></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.Delete.html#withRef"><span class="hs-identifier">withRef</span></a></span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html"><span class="hs-identifier">Cardano.Wallet.Checkpoints</span></a></span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#DeltaCheckpoints"><span class="hs-identifier">DeltaCheckpoints</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#defaultSparseCheckpointsConfig"><span class="hs-identifier">defaultSparseCheckpointsConfig</span></a></span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Checkpoints.html#sparseCheckpoints"><span class="hs-identifier">sparseCheckpoints</span></a></span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.html"><span class="hs-identifier">Cardano.Wallet.DB</span></a></span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.html#DBFactory"><span class="hs-identifier">DBFactory</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.html#DBLayer"><span class="hs-identifier">DBLayer</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.html#ErrNoSuchTransaction"><span class="hs-identifier">ErrNoSuchTransaction</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.html#ErrPutLocalTxSubmission"><span class="hs-identifier">ErrPutLocalTxSubmission</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.html#ErrRemoveTx"><span class="hs-identifier">ErrRemoveTx</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.html#ErrWalletAlreadyExists"><span class="hs-identifier">ErrWalletAlreadyExists</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Migration.html"><span class="hs-identifier">Cardano.Wallet.DB.Sqlite.Migration</span></a></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Migration.html#DefaultFieldValues"><span class="hs-identifier">DefaultFieldValues</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Migration.html#migrateManually"><span class="hs-identifier">migrateManually</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html"><span class="hs-identifier">Cardano.Wallet.DB.Sqlite.Schema</span></a></span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#DelegationCertificate"><span class="hs-identifier">DelegationCertificate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#DelegationReward"><span class="hs-identifier">DelegationReward</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">EntityField</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">Key</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#LocalTxSubmission"><span class="hs-identifier">LocalTxSubmission</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#PrivateKey"><span class="hs-identifier">PrivateKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#StakeKeyCertificate"><span class="hs-identifier">StakeKeyCertificate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#TxMeta"><span class="hs-identifier">TxMeta</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#TxWithdrawal"><span class="hs-identifier">TxWithdrawal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#txWithdrawalAmount"><span class="hs-identifier">txWithdrawalAmount</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Wallet"><span class="hs-identifier">Wallet</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#migrateAll"><span class="hs-identifier">migrateAll</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#unWalletKey"><span class="hs-identifier">unWalletKey</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html"><span class="hs-identifier">Cardano.Wallet.DB.Sqlite.Types</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#BlockId"><span class="hs-identifier">BlockId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#TxId"><span class="hs-identifier">TxId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html"><span class="hs-identifier">Cardano.Wallet.DB.Store.Checkpoints</span></a></span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier">PersistAddressBook</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#blockHeaderFromEntity"><span class="hs-identifier">blockHeaderFromEntity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkStoreWallets"><span class="hs-identifier">mkStoreWallets</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Meta.Model.html"><span class="hs-identifier">Cardano.Wallet.DB.Store.Meta.Model</span></a></span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Meta.Model.html#ManipulateTxMetaHistory"><span class="hs-identifier">ManipulateTxMetaHistory</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Meta.Model.html#TxMetaHistory"><span class="hs-identifier">TxMetaHistory</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Transactions.Model.html"><span class="hs-identifier">Cardano.Wallet.DB.Store.Transactions.Model</span></a></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Transactions.Model.html#TxHistoryF"><span class="hs-identifier">TxHistoryF</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Transactions.Model.html#decorateWithTxOuts"><span class="hs-identifier">decorateWithTxOuts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Transactions.Model.html#%24sel%3Awithdrawals%3ATxRelationF"><span class="hs-identifier">withdrawals</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Wallets.Model.html"><span class="hs-identifier">Cardano.Wallet.DB.Store.Wallets.Model</span></a></span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Wallets.Model.html#TxWalletsHistory"><span class="hs-identifier">TxWalletsHistory</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Wallets.Model.html#mkTransactionInfo"><span class="hs-identifier">mkTransactionInfo</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Wallets.Store.html"><span class="hs-identifier">Cardano.Wallet.DB.Store.Wallets.Store</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Wallets.Model.html#DeltaTxWalletsHistory"><span class="hs-identifier">DeltaTxWalletsHistory</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Wallets.Store.html#mkStoreTxWalletsHistory"><span class="hs-identifier">mkStoreTxWalletsHistory</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html"><span class="hs-identifier">Cardano.Wallet.DB.WalletState</span></a></span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier">DeltaMap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#DeltaWalletState1"><span class="hs-identifier">DeltaWalletState1</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier">ErrNoSuchWallet</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#findNearestPoint"><span class="hs-identifier">findNearestPoint</span></a></span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#fromGenesis"><span class="hs-identifier">fromGenesis</span></a></span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#fromWallet"><span class="hs-identifier">fromWallet</span></a></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#getBlockHeight"><span class="hs-identifier">getBlockHeight</span></a></span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#getLatest"><span class="hs-identifier">getLatest</span></a></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.WalletState.html#getSlot"><span class="hs-identifier">getSlot</span></a></span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html"><span class="hs-identifier">Cardano.Wallet.Primitive.AddressDerivation</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#Depth"><span class="hs-identifier">Depth</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPrivateKey"><span class="hs-identifier">PersistPrivateKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#WalletKey"><span class="hs-identifier">WalletKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Passphrase.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Passphrase</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Passphrase.Types.html#PassphraseHash"><span class="hs-identifier">PassphraseHash</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Slotting</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier">TimeInterpreter</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#epochOf"><span class="hs-identifier">epochOf</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#firstSlotInEpoch"><span class="hs-identifier">firstSlotInEpoch</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#interpretQuery"><span class="hs-identifier">interpretQuery</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.Tx</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TransactionInfo"><span class="hs-identifier">TransactionInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TxMeta"><span class="hs-identifier">TxMeta</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">throw</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">forM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">guard</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">unless</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">void</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">when</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&lt;=&lt;)</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad.IO.Class</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">MonadIO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../mtl/html/src"><span class="hs-identifier">Control.Monad.Trans</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">lift</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">Control.Monad.Trans.Except</span></a></span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">ExceptT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier">Control.Tracer</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier">Tracer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">contramap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier">traceWith</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Coerce</span></a></span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier">coerce</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier">Data.DBVar</span></a></span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier">loadDBVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier">modifyDBMaybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier">readDBVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../dbvar/html/src"><span class="hs-identifier">updateDBVar</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Either</span></a></span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">isRight</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">toList</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../generic-lens/html/src"><span class="hs-identifier">Data.Generics.Internal.VL.Lens</span></a></span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../generic-lens/html/src"><span class="hs-identifier">view</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../generic-lens/html/src"><span class="hs-operator">(^.)</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">sortOn</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">catMaybes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">fromMaybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">listToMaybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">maybeToList</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Ord</span></a></span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Down</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Proxy</span></a></span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Proxy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Quantity.html"><span class="hs-identifier">Data.Quantity</span></a></span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier">Quantity</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier">Data.Text</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier">Text</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../text-class/html/src"><span class="hs-identifier">Data.Text.Class</span></a></span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../text-class/html/src"><span class="hs-identifier">ToText</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../text-class/html/src"><span class="hs-identifier">fromText</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Word</span></a></span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Word32</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">Database.Persist.Class</span></a></span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">toPersistValue</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">Database.Persist.Sql</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">Entity</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">Filter</span></a></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">SelectOpt</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">Single</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">Update</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">deleteWhere</span></a></span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">insert_</span></a></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">rawExecute</span></a></span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">rawSql</span></a></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">repsert</span></a></span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">selectFirst</span></a></span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">selectKeysList</span></a></span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">selectList</span></a></span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">updateWhere</span></a></span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">upsert</span></a></span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-operator">(&lt;.)</span></a></span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-operator">(=.)</span></a></span><span>
</span><span id="line-183"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-operator">(==.)</span></a></span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-operator">(&gt;.)</span></a></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-operator">(&gt;=.)</span></a></span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../persistent-sqlite/html/src"><span class="hs-identifier">Database.Persist.Sqlite</span></a></span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">SqlPersistT</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../fmt/html/src"><span class="hs-identifier">Fmt</span></a></span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../fmt/html/src"><span class="hs-identifier">pretty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../fmt/html/src"><span class="hs-operator">(+|)</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../fmt/html/src"><span class="hs-operator">(|+)</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../directory/html/src"><span class="hs-identifier">System.Directory</span></a></span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../directory/html/src"><span class="hs-identifier">doesFileExist</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../directory/html/src"><span class="hs-identifier">listDirectory</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../filepath/html/src"><span class="hs-identifier">System.FilePath</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../filepath/html/src"><span class="hs-operator">(&lt;/&gt;)</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../unliftio/html/src"><span class="hs-identifier">UnliftIO.Exception</span></a></span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Exception</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../unliftio/html/src"><span class="hs-identifier">bracket</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../unliftio/html/src"><span class="hs-identifier">throwIO</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../unliftio/html/src"><span class="hs-identifier">UnliftIO.MVar</span></a></span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../unliftio/html/src"><span class="hs-identifier">modifyMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../unliftio/html/src"><span class="hs-identifier">modifyMVar_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../unliftio/html/src"><span class="hs-identifier">newMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../unliftio/html/src"><span class="hs-identifier">readMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../unliftio/html/src"><span class="hs-identifier">withMVar</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html"><span class="hs-identifier">Cardano.Wallet.DB.Sqlite.Schema</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DB</span></span><span>
</span><span id="line-203"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Model.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Model</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-204"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Passphrase.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Passphrase</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-205"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-206"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Coin.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.Coin</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Coin</span></span><span>
</span><span id="line-207"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Coin.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.Coin</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-208"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Hash.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.Hash</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-209"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.Tx</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-210"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-211"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-212"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span class="hs-comment">{-------------------------------------------------------------------------------
                               Database &quot;factory&quot;
             (a directory containing one database file per wallet)
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="hs-comment">-- | Instantiate a 'DBFactory' from a given directory, or in-memory for testing.</span><span>
</span><span id="line-220"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#newDBFactory"><span class="hs-identifier hs-type">newDBFactory</span></a></span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682488031"><span class="annot"><a href="#local-6989586621682488031"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621682488030"><span class="annot"><a href="#local-6989586621682488030"><span class="hs-identifier hs-type">k</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-222"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488031"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-223"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPrivateKey"><span class="hs-identifier hs-type">PersistPrivateKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682488030"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#RootK"><span class="hs-identifier hs-type">RootK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#WalletKey"><span class="hs-identifier hs-type">WalletKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488030"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-225"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-type">Tracer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#DBFactoryLog"><span class="hs-identifier hs-type">DBFactoryLog</span></a></span><span>
</span><span id="line-227"></span><span>       </span><span class="hs-comment">-- ^ Logging object</span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Migration.html#DefaultFieldValues"><span class="hs-identifier hs-type">DefaultFieldValues</span></a></span><span>
</span><span id="line-229"></span><span>       </span><span class="hs-comment">-- ^ Default database field values, used during migration.</span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier hs-type">TimeInterpreter</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-231"></span><span>       </span><span class="hs-comment">-- ^ Time interpreter for slot to time conversions</span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-233"></span><span>       </span><span class="hs-comment">-- ^ Path to database directory, or Nothing for in-memory database</span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.html#DBFactory"><span class="hs-identifier hs-type">DBFactory</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488031"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488030"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span id="newDBFactory"><span class="annot"><span class="annottext">newDBFactory :: Tracer IO DBFactoryLog
-&gt; DefaultFieldValues
-&gt; TimeInterpreter IO
-&gt; Maybe FilePath
-&gt; IO (DBFactory IO s k)
</span><a href="Cardano.Wallet.DB.Layer.html#newDBFactory"><span class="hs-identifier hs-var hs-var">newDBFactory</span></a></span></span><span> </span><span id="local-6989586621682488029"><span class="annot"><span class="annottext">Tracer IO DBFactoryLog
</span><a href="#local-6989586621682488029"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621682488028"><span class="annot"><span class="annottext">DefaultFieldValues
</span><a href="#local-6989586621682488028"><span class="hs-identifier hs-var">defaultFieldValues</span></a></span></span><span> </span><span id="local-6989586621682488027"><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682488027"><span class="hs-identifier hs-var">ti</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-236"></span><span>    </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-237"></span><span>        </span><span class="hs-comment">-- NOTE1</span><span>
</span><span id="line-238"></span><span>        </span><span class="hs-comment">-- For the in-memory database, we do actually preserve the database</span><span>
</span><span id="line-239"></span><span>        </span><span class="hs-comment">-- after the 'action' is done. This allows for calling 'withDatabase'</span><span>
</span><span id="line-240"></span><span>        </span><span class="hs-comment">-- several times within the same execution and get back the same</span><span>
</span><span id="line-241"></span><span>        </span><span class="hs-comment">-- database. The memory is only cleaned up when calling</span><span>
</span><span id="line-242"></span><span>        </span><span class="hs-comment">-- 'removeDatabase', to mimic the way the file database works!</span><span>
</span><span id="line-243"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-244"></span><span>        </span><span class="hs-comment">-- NOTE2</span><span>
</span><span id="line-245"></span><span>        </span><span class="hs-comment">-- The in-memory withDatabase will leak memory unless removeDatabase is</span><span>
</span><span id="line-246"></span><span>        </span><span class="hs-comment">-- called after using the database. In practice, this is only a problem</span><span>
</span><span id="line-247"></span><span>        </span><span class="hs-comment">-- for testing.</span><span>
</span><span id="line-248"></span><span>        </span><span id="local-6989586621682488026"><span class="annot"><span class="annottext">MVar (Map WalletId (DBLayer IO s k))
</span><a href="#local-6989586621682488026"><span class="hs-identifier hs-var">mvar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map WalletId (DBLayer IO s k)
-&gt; IO (MVar (Map WalletId (DBLayer IO s k)))
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (MVar a)
</span><a href="../../../../unliftio/html/src"><span class="hs-identifier hs-var">newMVar</span></a></span><span> </span><span class="annot"><span class="annottext">Map WalletId (DBLayer IO s k)
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-249"></span><span>        </span><span class="annot"><span class="annottext">DBFactory IO s k -&gt; IO (DBFactory IO s k)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">DBFactory :: forall (m :: * -&gt; *) s (k :: Depth -&gt; * -&gt; *).
(forall a. WalletId -&gt; (DBLayer m s k -&gt; IO a) -&gt; IO a)
-&gt; (WalletId -&gt; IO ()) -&gt; IO [WalletId] -&gt; DBFactory m s k
</span><a href="Cardano.Wallet.DB.html#DBFactory"><span class="hs-identifier hs-type">DBFactory</span></a></span><span>
</span><span id="line-250"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">withDatabase :: forall a. WalletId -&gt; (DBLayer IO s k -&gt; IO a) -&gt; IO a
</span><a href="Cardano.Wallet.DB.html#withDatabase"><span class="hs-identifier hs-var">withDatabase</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682488023"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682488023"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682488022"><span class="annot"><span class="annottext">DBLayer IO s k -&gt; IO a
</span><a href="#local-6989586621682488022"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>                </span><span id="local-6989586621682488021"><span class="annot"><span class="annottext">DBLayer IO s k
</span><a href="#local-6989586621682488021"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar (Map WalletId (DBLayer IO s k))
-&gt; (Map WalletId (DBLayer IO s k)
    -&gt; IO (Map WalletId (DBLayer IO s k), DBLayer IO s k))
-&gt; IO (DBLayer IO s k)
forall (m :: * -&gt; *) a b.
MonadUnliftIO m =&gt;
MVar a -&gt; (a -&gt; m (a, b)) -&gt; m b
</span><a href="../../../../unliftio/html/src"><span class="hs-identifier hs-var">modifyMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (Map WalletId (DBLayer IO s k))
</span><a href="#local-6989586621682488026"><span class="hs-identifier hs-var">mvar</span></a></span><span> </span><span class="annot"><span class="annottext">((Map WalletId (DBLayer IO s k)
  -&gt; IO (Map WalletId (DBLayer IO s k), DBLayer IO s k))
 -&gt; IO (DBLayer IO s k))
-&gt; (Map WalletId (DBLayer IO s k)
    -&gt; IO (Map WalletId (DBLayer IO s k), DBLayer IO s k))
-&gt; IO (DBLayer IO s k)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682488020"><span class="annot"><span class="annottext">Map WalletId (DBLayer IO s k)
</span><a href="#local-6989586621682488020"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; Map WalletId (DBLayer IO s k) -&gt; Maybe (DBLayer IO s k)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682488023"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Map WalletId (DBLayer IO s k)
</span><a href="#local-6989586621682488020"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-252"></span><span>                    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682488018"><span class="annot"><span class="annottext">DBLayer IO s k
</span><a href="#local-6989586621682488018"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Map WalletId (DBLayer IO s k), DBLayer IO s k)
-&gt; IO (Map WalletId (DBLayer IO s k), DBLayer IO s k)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map WalletId (DBLayer IO s k)
</span><a href="#local-6989586621682488020"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DBLayer IO s k
</span><a href="#local-6989586621682488018"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (DBLayer IO s k)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-254"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488017"><span class="annot"><span class="annottext">tr' :: Tracer IO WalletDBLog
</span><a href="#local-6989586621682488017"><span class="hs-identifier hs-var hs-var">tr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(WalletDBLog -&gt; DBFactoryLog)
-&gt; Tracer IO DBFactoryLog -&gt; Tracer IO WalletDBLog
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; WalletDBLog -&gt; DBFactoryLog
</span><a href="Cardano.Wallet.DB.Layer.html#MsgWalletDB"><span class="hs-identifier hs-var">MsgWalletDB</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog
</span><a href="#local-6989586621682488029"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-255"></span><span>                        </span><span class="hs-special">(</span><span id="local-6989586621682488015"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621682488015"><span class="hs-identifier hs-var">_cleanup</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682488014"><span class="annot"><span class="annottext">DBLayer IO s k
</span><a href="#local-6989586621682488014"><span class="hs-identifier hs-var">db</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Tracer IO WalletDBLog
-&gt; TimeInterpreter IO -&gt; IO (IO (), DBLayer IO s k)
forall s (k :: Depth -&gt; * -&gt; *).
(PersistAddressBook s, PersistPrivateKey (k 'RootK)) =&gt;
Tracer IO WalletDBLog
-&gt; TimeInterpreter IO -&gt; IO (IO (), DBLayer IO s k)
</span><a href="Cardano.Wallet.DB.Layer.html#newDBLayerInMemory"><span class="hs-identifier hs-var">newDBLayerInMemory</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO WalletDBLog
</span><a href="#local-6989586621682488017"><span class="hs-identifier hs-var">tr'</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682488027"><span class="hs-identifier hs-var">ti</span></a></span><span>
</span><span id="line-256"></span><span>                        </span><span class="annot"><span class="annottext">(Map WalletId (DBLayer IO s k), DBLayer IO s k)
-&gt; IO (Map WalletId (DBLayer IO s k), DBLayer IO s k)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId
-&gt; DBLayer IO s k
-&gt; Map WalletId (DBLayer IO s k)
-&gt; Map WalletId (DBLayer IO s k)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682488023"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">DBLayer IO s k
</span><a href="#local-6989586621682488014"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="annot"><span class="annottext">Map WalletId (DBLayer IO s k)
</span><a href="#local-6989586621682488020"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DBLayer IO s k
</span><a href="#local-6989586621682488014"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>                </span><span class="annot"><span class="annottext">DBLayer IO s k -&gt; IO a
</span><a href="#local-6989586621682488022"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">DBLayer IO s k
</span><a href="#local-6989586621682488021"><span class="hs-identifier hs-var">db</span></a></span><span>
</span><span id="line-258"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">removeDatabase :: WalletId -&gt; IO ()
</span><a href="Cardano.Wallet.DB.html#removeDatabase"><span class="hs-identifier hs-var">removeDatabase</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682488011"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682488011"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-259"></span><span>                </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog -&gt; DBFactoryLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-var">traceWith</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog
</span><a href="#local-6989586621682488029"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">(DBFactoryLog -&gt; IO ()) -&gt; DBFactoryLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; DBFactoryLog
</span><a href="Cardano.Wallet.DB.Layer.html#MsgRemoving"><span class="hs-identifier hs-var">MsgRemoving</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; Text
forall a b. (Buildable a, FromBuilder b) =&gt; a -&gt; b
</span><a href="../../../../fmt/html/src"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682488011"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>                </span><span class="annot"><span class="annottext">MVar (Map WalletId (DBLayer IO s k))
-&gt; (Map WalletId (DBLayer IO s k)
    -&gt; IO (Map WalletId (DBLayer IO s k)))
-&gt; IO ()
forall (m :: * -&gt; *) a.
MonadUnliftIO m =&gt;
MVar a -&gt; (a -&gt; m a) -&gt; m ()
</span><a href="../../../../unliftio/html/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (Map WalletId (DBLayer IO s k))
</span><a href="#local-6989586621682488026"><span class="hs-identifier hs-var">mvar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map WalletId (DBLayer IO s k) -&gt; IO (Map WalletId (DBLayer IO s k))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Map WalletId (DBLayer IO s k)
 -&gt; IO (Map WalletId (DBLayer IO s k)))
-&gt; (Map WalletId (DBLayer IO s k) -&gt; Map WalletId (DBLayer IO s k))
-&gt; Map WalletId (DBLayer IO s k)
-&gt; IO (Map WalletId (DBLayer IO s k))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; Map WalletId (DBLayer IO s k) -&gt; Map WalletId (DBLayer IO s k)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.delete</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682488011"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">listDatabases :: IO [WalletId]
</span><a href="#local-6989586621682488007"><span class="hs-identifier hs-var">listDatabases</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-263"></span><span>                </span><span class="annot"><span class="annottext">Map WalletId (DBLayer IO s k) -&gt; [WalletId]
forall k a. Map k a -&gt; [k]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.keys</span></a></span><span> </span><span class="annot"><span class="annottext">(Map WalletId (DBLayer IO s k) -&gt; [WalletId])
-&gt; IO (Map WalletId (DBLayer IO s k)) -&gt; IO [WalletId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (Map WalletId (DBLayer IO s k))
-&gt; IO (Map WalletId (DBLayer IO s k))
forall (m :: * -&gt; *) a. MonadIO m =&gt; MVar a -&gt; m a
</span><a href="../../../../unliftio/html/src"><span class="hs-identifier hs-var">readMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (Map WalletId (DBLayer IO s k))
</span><a href="#local-6989586621682488026"><span class="hs-identifier hs-var">mvar</span></a></span><span>
</span><span id="line-264"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682488004"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682488004"><span class="hs-identifier hs-var">databaseDir</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-267"></span><span>        </span><span id="local-6989586621682488003"><span class="annot"><span class="annottext">RefCount WalletId
</span><a href="#local-6989586621682488003"><span class="hs-identifier hs-var">refs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (RefCount WalletId)
forall ix. Ord ix =&gt; IO (RefCount ix)
</span><a href="Cardano.DB.Sqlite.Delete.html#newRefCount"><span class="hs-identifier hs-var">newRefCount</span></a></span><span>
</span><span id="line-268"></span><span>        </span><span class="annot"><span class="annottext">DBFactory IO s k -&gt; IO (DBFactory IO s k)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">DBFactory :: forall (m :: * -&gt; *) s (k :: Depth -&gt; * -&gt; *).
(forall a. WalletId -&gt; (DBLayer m s k -&gt; IO a) -&gt; IO a)
-&gt; (WalletId -&gt; IO ()) -&gt; IO [WalletId] -&gt; DBFactory m s k
</span><a href="Cardano.Wallet.DB.html#DBFactory"><span class="hs-identifier hs-type">DBFactory</span></a></span><span>
</span><span id="line-269"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">withDatabase :: forall a. WalletId -&gt; (DBLayer IO s k -&gt; IO a) -&gt; IO a
</span><a href="Cardano.Wallet.DB.html#withDatabase"><span class="hs-identifier hs-var">withDatabase</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682488002"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682488002"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682488001"><span class="annot"><span class="annottext">DBLayer IO s k -&gt; IO a
</span><a href="#local-6989586621682488001"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RefCount WalletId -&gt; WalletId -&gt; IO a -&gt; IO a
forall ix a. Ord ix =&gt; RefCount ix -&gt; ix -&gt; IO a -&gt; IO a
</span><a href="Cardano.DB.Sqlite.Delete.html#withRef"><span class="hs-identifier hs-var">withRef</span></a></span><span> </span><span class="annot"><span class="annottext">RefCount WalletId
</span><a href="#local-6989586621682488003"><span class="hs-identifier hs-var">refs</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682488002"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; IO a) -&gt; IO a -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO WalletDBLog
-&gt; DefaultFieldValues
-&gt; FilePath
-&gt; TimeInterpreter IO
-&gt; (DBLayer IO s k -&gt; IO a)
-&gt; IO a
forall s (k :: Depth -&gt; * -&gt; *) a.
(PersistAddressBook s, PersistPrivateKey (k 'RootK),
 WalletKey k) =&gt;
Tracer IO WalletDBLog
-&gt; DefaultFieldValues
-&gt; FilePath
-&gt; TimeInterpreter IO
-&gt; (DBLayer IO s k -&gt; IO a)
-&gt; IO a
</span><a href="Cardano.Wallet.DB.Layer.html#withDBLayer"><span class="hs-identifier hs-var">withDBLayer</span></a></span><span>
</span><span id="line-270"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(WalletDBLog -&gt; DBFactoryLog)
-&gt; Tracer IO DBFactoryLog -&gt; Tracer IO WalletDBLog
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; WalletDBLog -&gt; DBFactoryLog
</span><a href="Cardano.Wallet.DB.Layer.html#MsgWalletDB"><span class="hs-identifier hs-var">MsgWalletDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; FilePath
forall a. ToText a =&gt; a -&gt; FilePath
</span><a href="#local-6989586621682488000"><span class="hs-identifier hs-var">databaseFile</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682488002"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog
</span><a href="#local-6989586621682488029"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>                </span><span class="annot"><span class="annottext">DefaultFieldValues
</span><a href="#local-6989586621682488028"><span class="hs-identifier hs-var">defaultFieldValues</span></a></span><span>
</span><span id="line-272"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; FilePath
forall a. ToText a =&gt; a -&gt; FilePath
</span><a href="#local-6989586621682488000"><span class="hs-identifier hs-var">databaseFile</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682488002"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>                </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682488027"><span class="hs-identifier hs-var">ti</span></a></span><span>
</span><span id="line-274"></span><span>                </span><span class="annot"><span class="annottext">DBLayer IO s k -&gt; IO a
</span><a href="#local-6989586621682488001"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-275"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">removeDatabase :: WalletId -&gt; IO ()
</span><a href="Cardano.Wallet.DB.html#removeDatabase"><span class="hs-identifier hs-var">removeDatabase</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487999"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487999"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-276"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487998"><span class="annot"><span class="annottext">widp :: Text
</span><a href="#local-6989586621682487998"><span class="hs-identifier hs-var hs-var">widp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; Text
forall a b. (Buildable a, FromBuilder b) =&gt; a -&gt; b
</span><a href="../../../../fmt/html/src"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487999"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-277"></span><span>                </span><span class="hs-comment">-- try to wait for all 'withDatabase' calls to finish before</span><span>
</span><span id="line-278"></span><span>                </span><span class="hs-comment">-- deleting database file.</span><span>
</span><span id="line-279"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487997"><span class="annot"><span class="annottext">trWait :: Tracer IO (Maybe Int)
</span><a href="#local-6989586621682487997"><span class="hs-identifier hs-var hs-var">trWait</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe Int -&gt; DBFactoryLog)
-&gt; Tracer IO DBFactoryLog -&gt; Tracer IO (Maybe Int)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Int -&gt; DBFactoryLog
</span><a href="Cardano.Wallet.DB.Layer.html#MsgWaitingForDatabase"><span class="hs-identifier hs-var">MsgWaitingForDatabase</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487998"><span class="hs-identifier hs-var">widp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog
</span><a href="#local-6989586621682488029"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-280"></span><span>                </span><span class="hs-comment">-- TODO: rather than refcounting, why not keep retrying the</span><span>
</span><span id="line-281"></span><span>                </span><span class="hs-comment">-- delete until there are no file busy errors?</span><span>
</span><span id="line-282"></span><span>                </span><span class="annot"><span class="annottext">Tracer IO (Maybe Int)
-&gt; RefCount WalletId -&gt; WalletId -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall ix a.
Ord ix =&gt;
Tracer IO (Maybe Int) -&gt; RefCount ix -&gt; ix -&gt; (Int -&gt; IO a) -&gt; IO a
</span><a href="Cardano.DB.Sqlite.Delete.html#waitForFree"><span class="hs-identifier hs-var">waitForFree</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO (Maybe Int)
</span><a href="#local-6989586621682487997"><span class="hs-identifier hs-var">trWait</span></a></span><span> </span><span class="annot"><span class="annottext">RefCount WalletId
</span><a href="#local-6989586621682488003"><span class="hs-identifier hs-var">refs</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487999"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; IO ()) -&gt; IO ()) -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487995"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682487995"><span class="hs-identifier hs-var">inUse</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-283"></span><span>                    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682487995"><span class="hs-identifier hs-var">inUse</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-284"></span><span>                        </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog -&gt; DBFactoryLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-var">traceWith</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog
</span><a href="#local-6989586621682488029"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">(DBFactoryLog -&gt; IO ()) -&gt; DBFactoryLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; DBFactoryLog
</span><a href="Cardano.Wallet.DB.Layer.html#MsgRemovingInUse"><span class="hs-identifier hs-var">MsgRemovingInUse</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487998"><span class="hs-identifier hs-var">widp</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682487995"><span class="hs-identifier hs-var">inUse</span></a></span><span>
</span><span id="line-285"></span><span>                    </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog -&gt; DBFactoryLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-var">traceWith</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog
</span><a href="#local-6989586621682488029"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">(DBFactoryLog -&gt; IO ()) -&gt; DBFactoryLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; DBFactoryLog
</span><a href="Cardano.Wallet.DB.Layer.html#MsgRemoving"><span class="hs-identifier hs-var">MsgRemoving</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487998"><span class="hs-identifier hs-var">widp</span></a></span><span>
</span><span id="line-286"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487993"><span class="annot"><span class="annottext">trDel :: Tracer IO DeleteSqliteDatabaseLog
</span><a href="#local-6989586621682487993"><span class="hs-identifier hs-var hs-var">trDel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DeleteSqliteDatabaseLog -&gt; DBFactoryLog)
-&gt; Tracer IO DBFactoryLog -&gt; Tracer IO DeleteSqliteDatabaseLog
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; DeleteSqliteDatabaseLog -&gt; DBFactoryLog
</span><a href="Cardano.Wallet.DB.Layer.html#MsgRemovingDatabaseFile"><span class="hs-identifier hs-var">MsgRemovingDatabaseFile</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487998"><span class="hs-identifier hs-var">widp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog
</span><a href="#local-6989586621682488029"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-287"></span><span>                    </span><span class="annot"><span class="annottext">Tracer IO DeleteSqliteDatabaseLog -&gt; FilePath -&gt; IO ()
</span><a href="Cardano.DB.Sqlite.Delete.html#deleteSqliteDatabase"><span class="hs-identifier hs-var">deleteSqliteDatabase</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO DeleteSqliteDatabaseLog
</span><a href="#local-6989586621682487993"><span class="hs-identifier hs-var">trDel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; FilePath
forall a. ToText a =&gt; a -&gt; FilePath
</span><a href="#local-6989586621682488000"><span class="hs-identifier hs-var">databaseFile</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487999"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">listDatabases :: IO [WalletId]
</span><a href="#local-6989586621682488007"><span class="hs-identifier hs-var">listDatabases</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-289"></span><span>                </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog -&gt; FilePath -&gt; IO [WalletId]
forall (k :: Depth -&gt; * -&gt; *).
WalletKey k =&gt;
Tracer IO DBFactoryLog -&gt; FilePath -&gt; IO [WalletId]
</span><a href="Cardano.Wallet.DB.Layer.html#findDatabases"><span class="hs-identifier hs-var">findDatabases</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682488030"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog
</span><a href="#local-6989586621682488029"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682488004"><span class="hs-identifier hs-var">databaseDir</span></a></span><span>
</span><span id="line-290"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-291"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-292"></span><span>        </span><span id="local-6989586621682487991"><span class="annot"><span class="annottext">databaseFilePrefix :: FilePath
</span><a href="#local-6989586621682487991"><span class="hs-identifier hs-var hs-var">databaseFilePrefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy k -&gt; FilePath
forall (key :: Depth -&gt; * -&gt; *).
WalletKey key =&gt;
Proxy key -&gt; FilePath
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#keyTypeDescriptor"><span class="hs-identifier hs-var">keyTypeDescriptor</span></a></span><span> </span><span class="annot"><span class="annottext">(Proxy k -&gt; FilePath) -&gt; Proxy k -&gt; FilePath
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy k
forall k (t :: k). Proxy t
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682488030"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-293"></span><span>        </span><span id="local-6989586621682488000"><span class="annot"><span class="annottext">databaseFile :: a -&gt; FilePath
</span><a href="#local-6989586621682488000"><span class="hs-identifier hs-var hs-var">databaseFile</span></a></span></span><span> </span><span id="local-6989586621682487988"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682487988"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-294"></span><span>            </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682488004"><span class="hs-identifier hs-var">databaseDir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><a href="../../../../filepath/html/src"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span>
</span><span id="line-295"></span><span>            </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487991"><span class="hs-identifier hs-var">databaseFilePrefix</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-296"></span><span>            </span><span class="annot"><span class="annottext">Text -&gt; FilePath
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">T.unpack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Text
forall a. ToText a =&gt; a -&gt; Text
</span><a href="../../../../text-class/html/src"><span class="hs-identifier hs-var">toText</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682487988"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;.sqlite&quot;</span></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span class="hs-comment">-- | Return all wallet databases that match the specified key type within the</span><span>
</span><span id="line-299"></span><span class="hs-comment">--   specified directory.</span><span>
</span><span id="line-300"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#findDatabases"><span class="hs-identifier hs-type">findDatabases</span></a></span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682488487"><span class="annot"><a href="#local-6989586621682488487"><span class="hs-identifier hs-type">k</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#WalletKey"><span class="hs-identifier hs-type">WalletKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488487"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-type">Tracer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#DBFactoryLog"><span class="hs-identifier hs-type">DBFactoryLog</span></a></span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-305"></span><span id="findDatabases"><span class="annot"><span class="annottext">findDatabases :: Tracer IO DBFactoryLog -&gt; FilePath -&gt; IO [WalletId]
</span><a href="Cardano.Wallet.DB.Layer.html#findDatabases"><span class="hs-identifier hs-var hs-var">findDatabases</span></a></span></span><span> </span><span id="local-6989586621682487985"><span class="annot"><span class="annottext">Tracer IO DBFactoryLog
</span><a href="#local-6989586621682487985"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621682487984"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487984"><span class="hs-identifier hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621682487983"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621682487983"><span class="hs-identifier hs-var">files</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO [FilePath]
</span><a href="../../../../directory/html/src"><span class="hs-identifier hs-var">listDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487984"><span class="hs-identifier hs-var">dir</span></a></span><span>
</span><span id="line-307"></span><span>    </span><span class="annot"><span class="annottext">([Maybe WalletId] -&gt; [WalletId])
-&gt; IO [Maybe WalletId] -&gt; IO [WalletId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe WalletId] -&gt; [WalletId]
forall a. [Maybe a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">catMaybes</span></a></span><span> </span><span class="annot"><span class="annottext">(IO [Maybe WalletId] -&gt; IO [WalletId])
-&gt; IO [Maybe WalletId] -&gt; IO [WalletId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
-&gt; (FilePath -&gt; IO (Maybe WalletId)) -&gt; IO [Maybe WalletId]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621682487983"><span class="hs-identifier hs-var">files</span></a></span><span> </span><span class="annot"><span class="annottext">((FilePath -&gt; IO (Maybe WalletId)) -&gt; IO [Maybe WalletId])
-&gt; (FilePath -&gt; IO (Maybe WalletId)) -&gt; IO [Maybe WalletId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487982"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487982"><span class="hs-identifier hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-308"></span><span>        </span><span id="local-6989586621682487981"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682487981"><span class="hs-identifier hs-var">isFile</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO Bool
</span><a href="../../../../directory/html/src"><span class="hs-identifier hs-var">doesFileExist</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487984"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><a href="../../../../filepath/html/src"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487982"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682487981"><span class="hs-identifier hs-var">isFile</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; [Text]
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">T.splitOn</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; [Text]) -&gt; Text -&gt; [Text]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Text
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487982"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-310"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682487978"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487978"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span id="local-6989586621682487977"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487977"><span class="hs-identifier hs-var">basename</span></a></span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;sqlite&quot;</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487978"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487976"><span class="hs-identifier hs-var">expectedPrefix</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-311"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either TextDecodingError WalletId
forall a. FromText a =&gt; Text -&gt; Either TextDecodingError a
</span><a href="../../../../text-class/html/src"><span class="hs-identifier hs-var">fromText</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487977"><span class="hs-identifier hs-var">basename</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-312"></span><span>                    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621682487975"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487975"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-313"></span><span>                        </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog -&gt; DBFactoryLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-var">traceWith</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog
</span><a href="#local-6989586621682487985"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">(DBFactoryLog -&gt; IO ()) -&gt; DBFactoryLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Text -&gt; DBFactoryLog
</span><a href="Cardano.Wallet.DB.Layer.html#MsgFoundDatabase"><span class="hs-identifier hs-var">MsgFoundDatabase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487984"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><a href="../../../../filepath/html/src"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487982"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; Text
forall a. ToText a =&gt; a -&gt; Text
</span><a href="../../../../text-class/html/src"><span class="hs-identifier hs-var">toText</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487975"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>                        </span><span class="annot"><span class="annottext">Maybe WalletId -&gt; IO (Maybe WalletId)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; Maybe WalletId
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487975"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>                    </span><span class="annot"><span class="annottext">Either TextDecodingError WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-316"></span><span>                        </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog -&gt; DBFactoryLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-var">traceWith</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO DBFactoryLog
</span><a href="#local-6989586621682487985"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">(DBFactoryLog -&gt; IO ()) -&gt; DBFactoryLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; DBFactoryLog
</span><a href="Cardano.Wallet.DB.Layer.html#MsgUnknownDBFile"><span class="hs-identifier hs-var">MsgUnknownDBFile</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487982"><span class="hs-identifier hs-var">file</span></a></span><span>
</span><span id="line-317"></span><span>                        </span><span class="annot"><span class="annottext">Maybe WalletId -&gt; IO (Maybe WalletId)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe WalletId
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-318"></span><span>            </span><span class="annot"><span class="annottext">(Bool, [Text])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe WalletId -&gt; IO (Maybe WalletId)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe WalletId
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-319"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-320"></span><span>    </span><span id="local-6989586621682487976"><span class="annot"><span class="annottext">expectedPrefix :: Text
</span><a href="#local-6989586621682487976"><span class="hs-identifier hs-var hs-var">expectedPrefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Text
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; Text) -&gt; FilePath -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy k -&gt; FilePath
forall (key :: Depth -&gt; * -&gt; *).
WalletKey key =&gt;
Proxy key -&gt; FilePath
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#keyTypeDescriptor"><span class="hs-identifier hs-var">keyTypeDescriptor</span></a></span><span> </span><span class="annot"><span class="annottext">(Proxy k -&gt; FilePath) -&gt; Proxy k -&gt; FilePath
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy k
forall k (t :: k). Proxy t
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682488487"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span id="local-6989586621682487971"><span id="local-6989586621682487972"></span></span><span class="hs-keyword">data</span><span> </span><span id="DBFactoryLog"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#DBFactoryLog"><span class="hs-identifier hs-var">DBFactoryLog</span></a></span></span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="MsgFoundDatabase"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgFoundDatabase"><span class="hs-identifier hs-var">MsgFoundDatabase</span></a></span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">Text</span></a></span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="MsgUnknownDBFile"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgUnknownDBFile"><span class="hs-identifier hs-var">MsgUnknownDBFile</span></a></span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="MsgRemoving"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgRemoving"><span class="hs-identifier hs-var">MsgRemoving</span></a></span></span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">Text</span></a></span><span>
</span><span id="line-326"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="MsgRemovingInUse"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgRemovingInUse"><span class="hs-identifier hs-var">MsgRemovingInUse</span></a></span></span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="MsgRemovingDatabaseFile"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgRemovingDatabaseFile"><span class="hs-identifier hs-var">MsgRemovingDatabaseFile</span></a></span></span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.Delete.html#DeleteSqliteDatabaseLog"><span class="hs-identifier hs-type">DeleteSqliteDatabaseLog</span></a></span><span>
</span><span id="line-328"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="MsgWaitingForDatabase"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgWaitingForDatabase"><span class="hs-identifier hs-var">MsgWaitingForDatabase</span></a></span></span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="MsgWalletDB"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgWalletDB"><span class="hs-identifier hs-var">MsgWalletDB</span></a></span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#WalletDBLog"><span class="hs-identifier hs-type">WalletDBLog</span></a></span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. DBFactoryLog -&gt; Rep DBFactoryLog x)
-&gt; (forall x. Rep DBFactoryLog x -&gt; DBFactoryLog)
-&gt; Generic DBFactoryLog
forall x. Rep DBFactoryLog x -&gt; DBFactoryLog
forall x. DBFactoryLog -&gt; Rep DBFactoryLog x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep DBFactoryLog x -&gt; DBFactoryLog
$cfrom :: forall x. DBFactoryLog -&gt; Rep DBFactoryLog x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682487962"><span id="local-6989586621682487964"><span id="local-6989586621682487966"><span class="annot"><span class="annottext">Int -&gt; DBFactoryLog -&gt; FilePath -&gt; FilePath
[DBFactoryLog] -&gt; FilePath -&gt; FilePath
DBFactoryLog -&gt; FilePath
(Int -&gt; DBFactoryLog -&gt; FilePath -&gt; FilePath)
-&gt; (DBFactoryLog -&gt; FilePath)
-&gt; ([DBFactoryLog] -&gt; FilePath -&gt; FilePath)
-&gt; Show DBFactoryLog
forall a.
(Int -&gt; a -&gt; FilePath -&gt; FilePath)
-&gt; (a -&gt; FilePath) -&gt; ([a] -&gt; FilePath -&gt; FilePath) -&gt; Show a
showList :: [DBFactoryLog] -&gt; FilePath -&gt; FilePath
$cshowList :: [DBFactoryLog] -&gt; FilePath -&gt; FilePath
show :: DBFactoryLog -&gt; FilePath
$cshow :: DBFactoryLog -&gt; FilePath
showsPrec :: Int -&gt; DBFactoryLog -&gt; FilePath -&gt; FilePath
$cshowsPrec :: Int -&gt; DBFactoryLog -&gt; FilePath -&gt; FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682487957"><span id="local-6989586621682487959"><span class="annot"><span class="annottext">DBFactoryLog -&gt; DBFactoryLog -&gt; Bool
(DBFactoryLog -&gt; DBFactoryLog -&gt; Bool)
-&gt; (DBFactoryLog -&gt; DBFactoryLog -&gt; Bool) -&gt; Eq DBFactoryLog
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: DBFactoryLog -&gt; DBFactoryLog -&gt; Bool
$c/= :: DBFactoryLog -&gt; DBFactoryLog -&gt; Bool
== :: DBFactoryLog -&gt; DBFactoryLog -&gt; Bool
$c== :: DBFactoryLog -&gt; DBFactoryLog -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682487954"><span class="annot"><span class="hs-identifier hs-type">HasPrivacyAnnotation</span></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#DBFactoryLog"><span class="hs-identifier hs-type">DBFactoryLog</span></a></span></span><span>
</span><span id="line-333"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasSeverityAnnotation</span></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#DBFactoryLog"><span class="hs-identifier hs-type">DBFactoryLog</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-334"></span><span>    </span><span id="local-6989586621682487950"><span class="annot"><span class="annottext">getSeverityAnnotation :: DBFactoryLog -&gt; Severity
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">getSeverityAnnotation</span></span></span><span> </span><span id="local-6989586621682487948"><span class="annot"><span class="annottext">DBFactoryLog
</span><a href="#local-6989586621682487948"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DBFactoryLog
</span><a href="#local-6989586621682487948"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-335"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgFoundDatabase"><span class="hs-identifier hs-type">MsgFoundDatabase</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Info</span></span><span>
</span><span id="line-336"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgUnknownDBFile"><span class="hs-identifier hs-type">MsgUnknownDBFile</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Notice</span></span><span>
</span><span id="line-337"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgRemoving"><span class="hs-identifier hs-type">MsgRemoving</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Info</span></span><span>
</span><span id="line-338"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgRemovingInUse"><span class="hs-identifier hs-type">MsgRemovingInUse</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Notice</span></span><span>
</span><span id="line-339"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgRemovingDatabaseFile"><span class="hs-identifier hs-type">MsgRemovingDatabaseFile</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682487945"><span class="annot"><span class="annottext">DeleteSqliteDatabaseLog
</span><a href="#local-6989586621682487945"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DeleteSqliteDatabaseLog -&gt; Severity
forall a. HasSeverityAnnotation a =&gt; a -&gt; Severity
</span><span class="hs-identifier hs-var">getSeverityAnnotation</span></span><span> </span><span class="annot"><span class="annottext">DeleteSqliteDatabaseLog
</span><a href="#local-6989586621682487945"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-340"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgWaitingForDatabase"><span class="hs-identifier hs-type">MsgWaitingForDatabase</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Info</span></span><span>
</span><span id="line-341"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgWalletDB"><span class="hs-identifier hs-type">MsgWalletDB</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682487944"><span class="annot"><span class="annottext">WalletDBLog
</span><a href="#local-6989586621682487944"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WalletDBLog -&gt; Severity
forall a. HasSeverityAnnotation a =&gt; a -&gt; Severity
</span><span class="hs-identifier hs-var">getSeverityAnnotation</span></span><span> </span><span class="annot"><span class="annottext">WalletDBLog
</span><a href="#local-6989586621682487944"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-342"></span><span>
</span><span id="line-343"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../text-class/html/src"><span class="hs-identifier hs-type">ToText</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#DBFactoryLog"><span class="hs-identifier hs-type">DBFactoryLog</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-344"></span><span>    </span><span id="local-6989586621682487941"><span class="annot"><span class="annottext">toText :: DBFactoryLog -&gt; Text
</span><a href="#local-6989586621682487941"><span class="hs-identifier hs-var hs-var hs-var hs-var">toText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-345"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgFoundDatabase"><span class="hs-identifier hs-type">MsgFoundDatabase</span></a></span><span> </span><span id="local-6989586621682487940"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487940"><span class="hs-identifier hs-var">_file</span></a></span></span><span> </span><span id="local-6989586621682487939"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487939"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-346"></span><span>            </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Found existing wallet: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487939"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-347"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgUnknownDBFile"><span class="hs-identifier hs-type">MsgUnknownDBFile</span></a></span><span> </span><span id="local-6989586621682487938"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487938"><span class="hs-identifier hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall a. Monoid a =&gt; [a] -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mconcat</span></a></span><span>
</span><span id="line-348"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Found something other than a database file in &quot;</span></span><span>
</span><span id="line-349"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;the database folder: &quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Text
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487938"><span class="hs-identifier hs-var">file</span></a></span><span>
</span><span id="line-350"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-351"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgRemoving"><span class="hs-identifier hs-type">MsgRemoving</span></a></span><span> </span><span id="local-6989586621682487937"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487937"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-352"></span><span>            </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Removing wallet's database. Wallet id was &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487937"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-353"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgRemovingDatabaseFile"><span class="hs-identifier hs-type">MsgRemovingDatabaseFile</span></a></span><span> </span><span id="local-6989586621682487936"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487936"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487935"><span class="annot"><span class="annottext">DeleteSqliteDatabaseLog
</span><a href="#local-6989586621682487935"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-354"></span><span>            </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Removing &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487936"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">DeleteSqliteDatabaseLog -&gt; Text
forall a. ToText a =&gt; a -&gt; Text
</span><a href="../../../../text-class/html/src"><span class="hs-identifier hs-var">toText</span></a></span><span> </span><span class="annot"><span class="annottext">DeleteSqliteDatabaseLog
</span><a href="#local-6989586621682487935"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-355"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgWaitingForDatabase"><span class="hs-identifier hs-type">MsgWaitingForDatabase</span></a></span><span> </span><span id="local-6989586621682487934"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487934"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-356"></span><span>            </span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot;Database &quot;</span></span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Text
forall b. FromBuilder b =&gt; Builder -&gt; Builder -&gt; b
</span><a href="../../../../fmt/html/src"><span class="hs-operator hs-var">+|</span></a></span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487934"><span class="hs-identifier hs-var">wid</span></a></span><span class="annot"><span class="annottext">Text -&gt; Builder -&gt; Builder
forall a b. (Buildable a, FromBuilder b) =&gt; a -&gt; Builder -&gt; b
</span><a href="../../../../fmt/html/src"><span class="hs-operator hs-var">|+</span></a></span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot; is ready to be deleted&quot;</span></span><span>
</span><span id="line-357"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgWaitingForDatabase"><span class="hs-identifier hs-type">MsgWaitingForDatabase</span></a></span><span> </span><span id="local-6989586621682487933"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487933"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682487932"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682487932"><span class="hs-identifier hs-var">count</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-358"></span><span>            </span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot;Waiting for &quot;</span></span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Text
forall b. FromBuilder b =&gt; Builder -&gt; Builder -&gt; b
</span><a href="../../../../fmt/html/src"><span class="hs-operator hs-var">+|</span></a></span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682487932"><span class="hs-identifier hs-var">count</span></a></span><span class="annot"><span class="annottext">Int -&gt; Builder -&gt; Builder
forall a b. (Buildable a, FromBuilder b) =&gt; a -&gt; Builder -&gt; b
</span><a href="../../../../fmt/html/src"><span class="hs-operator hs-var">|+</span></a></span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot; withDatabase &quot;</span></span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall b. FromBuilder b =&gt; Builder -&gt; Builder -&gt; b
</span><a href="../../../../fmt/html/src"><span class="hs-operator hs-var">+|</span></a></span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487933"><span class="hs-identifier hs-var">wid</span></a></span><span class="annot"><span class="annottext">Text -&gt; Builder -&gt; Builder
forall a b. (Buildable a, FromBuilder b) =&gt; a -&gt; Builder -&gt; b
</span><a href="../../../../fmt/html/src"><span class="hs-operator hs-var">|+</span></a></span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot; call(s) to finish&quot;</span></span><span>
</span><span id="line-359"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgRemovingInUse"><span class="hs-identifier hs-type">MsgRemovingInUse</span></a></span><span> </span><span id="local-6989586621682487931"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487931"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487930"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682487930"><span class="hs-identifier hs-var">count</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-360"></span><span>            </span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot;Timed out waiting for &quot;</span></span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Text
forall b. FromBuilder b =&gt; Builder -&gt; Builder -&gt; b
</span><a href="../../../../fmt/html/src"><span class="hs-operator hs-var">+|</span></a></span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682487930"><span class="hs-identifier hs-var">count</span></a></span><span class="annot"><span class="annottext">Int -&gt; Builder -&gt; Builder
forall a b. (Buildable a, FromBuilder b) =&gt; a -&gt; Builder -&gt; b
</span><a href="../../../../fmt/html/src"><span class="hs-operator hs-var">|+</span></a></span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot; withDatabase &quot;</span></span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall b. FromBuilder b =&gt; Builder -&gt; Builder -&gt; b
</span><a href="../../../../fmt/html/src"><span class="hs-operator hs-var">+|</span></a></span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487931"><span class="hs-identifier hs-var">wid</span></a></span><span class="annot"><span class="annottext">Text -&gt; Builder -&gt; Builder
forall a b. (Buildable a, FromBuilder b) =&gt; a -&gt; Builder -&gt; b
</span><a href="../../../../fmt/html/src"><span class="hs-operator hs-var">|+</span></a></span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot; call(s) to finish. &quot;</span></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-361"></span><span>            </span><span class="annot"><span class="annottext">Builder
</span><span class="hs-string">&quot;Attempting to remove the database anyway.&quot;</span></span><span>
</span><span id="line-362"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgWalletDB"><span class="hs-identifier hs-type">MsgWalletDB</span></a></span><span> </span><span id="local-6989586621682487929"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487929"><span class="hs-identifier hs-var">_file</span></a></span></span><span> </span><span id="local-6989586621682487928"><span class="annot"><span class="annottext">WalletDBLog
</span><a href="#local-6989586621682487928"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WalletDBLog -&gt; Text
forall a. ToText a =&gt; a -&gt; Text
</span><a href="../../../../text-class/html/src"><span class="hs-identifier hs-var">toText</span></a></span><span> </span><span class="annot"><span class="annottext">WalletDBLog
</span><a href="#local-6989586621682487928"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span class="hs-comment">{-------------------------------------------------------------------------------
                                 Database layer
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span class="hs-comment">-- | Runs an action with a connection to the SQLite database.</span><span>
</span><span id="line-369"></span><span class="hs-comment">--</span><span>
</span><span id="line-370"></span><span class="hs-comment">-- Database migrations are run to create tables if necessary.</span><span>
</span><span id="line-371"></span><span class="hs-comment">--</span><span>
</span><span id="line-372"></span><span class="hs-comment">-- If the given file path does not exist, it will be created by the sqlite</span><span>
</span><span id="line-373"></span><span class="hs-comment">-- library.</span><span>
</span><span id="line-374"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#withDBLayer"><span class="hs-identifier hs-type">withDBLayer</span></a></span><span>
</span><span id="line-375"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682488498"><span class="annot"><a href="#local-6989586621682488498"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621682488497"><span class="annot"><a href="#local-6989586621682488497"><span class="hs-identifier hs-type">k</span></a></span></span><span> </span><span id="local-6989586621682488495"><span class="annot"><a href="#local-6989586621682488495"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-376"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488498"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-377"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPrivateKey"><span class="hs-identifier hs-type">PersistPrivateKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682488497"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#RootK"><span class="hs-identifier hs-type">RootK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#WalletKey"><span class="hs-identifier hs-type">WalletKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488497"><span class="hs-identifier hs-type">k</span></a></span><span>
</span><span id="line-379"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-type">Tracer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#WalletDBLog"><span class="hs-identifier hs-type">WalletDBLog</span></a></span><span>
</span><span id="line-381"></span><span>       </span><span class="hs-comment">-- ^ Logging object</span><span>
</span><span id="line-382"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Migration.html#DefaultFieldValues"><span class="hs-identifier hs-type">DefaultFieldValues</span></a></span><span>
</span><span id="line-383"></span><span>       </span><span class="hs-comment">-- ^ Default database field values, used during migration.</span><span>
</span><span id="line-384"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-385"></span><span>       </span><span class="hs-comment">-- ^ Path to database file</span><span>
</span><span id="line-386"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier hs-type">TimeInterpreter</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-387"></span><span>       </span><span class="hs-comment">-- ^ Time interpreter for slot to time conversions</span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.html#DBLayer"><span class="hs-identifier hs-type">DBLayer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488498"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488497"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488495"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-389"></span><span>       </span><span class="hs-comment">-- ^ Action to run.</span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488495"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-391"></span><span id="withDBLayer"><span class="annot"><span class="annottext">withDBLayer :: Tracer IO WalletDBLog
-&gt; DefaultFieldValues
-&gt; FilePath
-&gt; TimeInterpreter IO
-&gt; (DBLayer IO s k -&gt; IO a)
-&gt; IO a
</span><a href="Cardano.Wallet.DB.Layer.html#withDBLayer"><span class="hs-identifier hs-var hs-var">withDBLayer</span></a></span></span><span> </span><span id="local-6989586621682487927"><span class="annot"><span class="annottext">Tracer IO WalletDBLog
</span><a href="#local-6989586621682487927"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621682487926"><span class="annot"><span class="annottext">DefaultFieldValues
</span><a href="#local-6989586621682487926"><span class="hs-identifier hs-var">defaultFieldValues</span></a></span></span><span> </span><span id="local-6989586621682487925"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487925"><span class="hs-identifier hs-var">dbFile</span></a></span></span><span> </span><span id="local-6989586621682487924"><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682487924"><span class="hs-identifier hs-var">ti</span></a></span></span><span> </span><span id="local-6989586621682487923"><span class="annot"><span class="annottext">DBLayer IO s k -&gt; IO a
</span><a href="#local-6989586621682487923"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-392"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487922"><span class="annot"><span class="annottext">trDB :: Tracer IO DBLog
</span><a href="#local-6989586621682487922"><span class="hs-identifier hs-var hs-var">trDB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DBLog -&gt; WalletDBLog) -&gt; Tracer IO WalletDBLog -&gt; Tracer IO DBLog
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">DBLog -&gt; WalletDBLog
</span><a href="Cardano.Wallet.DB.Layer.html#MsgDB"><span class="hs-identifier hs-var">MsgDB</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO WalletDBLog
</span><a href="#local-6989586621682487927"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487920"><span class="annot"><span class="annottext">manualMigrations :: [ManualMigration]
</span><a href="#local-6989586621682487920"><span class="hs-identifier hs-var hs-var">manualMigrations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer IO DBLog
-&gt; Proxy k -&gt; DefaultFieldValues -&gt; [ManualMigration]
forall (k :: Depth -&gt; * -&gt; *).
WalletKey k =&gt;
Tracer IO DBLog
-&gt; Proxy k -&gt; DefaultFieldValues -&gt; [ManualMigration]
</span><a href="Cardano.Wallet.DB.Sqlite.Migration.html#migrateManually"><span class="hs-identifier hs-var">migrateManually</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO DBLog
</span><a href="#local-6989586621682487922"><span class="hs-identifier hs-var">trDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy k
forall k (t :: k). Proxy t
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682488497"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DefaultFieldValues
</span><a href="#local-6989586621682487926"><span class="hs-identifier hs-var">defaultFieldValues</span></a></span><span>
</span><span id="line-394"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487919"><span class="annot"><span class="annottext">autoMigrations :: Migration
</span><a href="#local-6989586621682487919"><span class="hs-identifier hs-var hs-var">autoMigrations</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#migrateAll"><span class="hs-identifier hs-var">migrateAll</span></a></span><span>
</span><span id="line-395"></span><span>    </span><span class="annot"><span class="annottext">Tracer IO DBLog -&gt; FilePath -&gt; (ConnectionPool -&gt; IO a) -&gt; IO a
forall a.
Tracer IO DBLog -&gt; FilePath -&gt; (ConnectionPool -&gt; IO a) -&gt; IO a
</span><a href="Cardano.DB.Sqlite.html#withConnectionPool"><span class="hs-identifier hs-var">withConnectionPool</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO DBLog
</span><a href="#local-6989586621682487922"><span class="hs-identifier hs-var">trDB</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682487925"><span class="hs-identifier hs-var">dbFile</span></a></span><span> </span><span class="annot"><span class="annottext">((ConnectionPool -&gt; IO a) -&gt; IO a)
-&gt; (ConnectionPool -&gt; IO a) -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487918"><span class="annot"><span class="annottext">ConnectionPool
</span><a href="#local-6989586621682487918"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-396"></span><span>        </span><span id="local-6989586621682487917"><span class="annot"><span class="annottext">Either MigrationError SqliteContext
</span><a href="#local-6989586621682487917"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Tracer IO DBLog
-&gt; ConnectionPool
-&gt; [ManualMigration]
-&gt; Migration
-&gt; IO (Either MigrationError SqliteContext)
</span><a href="Cardano.DB.Sqlite.html#newSqliteContext"><span class="hs-identifier hs-var">newSqliteContext</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO DBLog
</span><a href="#local-6989586621682487922"><span class="hs-identifier hs-var">trDB</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionPool
</span><a href="#local-6989586621682487918"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="annot"><span class="annottext">[ManualMigration]
</span><a href="#local-6989586621682487920"><span class="hs-identifier hs-var">manualMigrations</span></a></span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="#local-6989586621682487919"><span class="hs-identifier hs-var">autoMigrations</span></a></span><span>
</span><span id="line-397"></span><span>        </span><span class="annot"><span class="annottext">(MigrationError -&gt; IO a)
-&gt; (SqliteContext -&gt; IO a)
-&gt; Either MigrationError SqliteContext
-&gt; IO a
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="annot"><span class="annottext">MigrationError -&gt; IO a
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><a href="../../../../unliftio/html/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DBLayer IO s k -&gt; IO a
</span><a href="#local-6989586621682487923"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">(DBLayer IO s k -&gt; IO a)
-&gt; (SqliteContext -&gt; IO (DBLayer IO s k)) -&gt; SqliteContext -&gt; IO a
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;=&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">CacheBehavior
-&gt; Tracer IO WalletDBLog
-&gt; TimeInterpreter IO
-&gt; SqliteContext
-&gt; IO (DBLayer IO s k)
forall s (k :: Depth -&gt; * -&gt; *).
(PersistAddressBook s, PersistPrivateKey (k 'RootK)) =&gt;
CacheBehavior
-&gt; Tracer IO WalletDBLog
-&gt; TimeInterpreter IO
-&gt; SqliteContext
-&gt; IO (DBLayer IO s k)
</span><a href="Cardano.Wallet.DB.Layer.html#newDBLayerWith"><span class="hs-identifier hs-var">newDBLayerWith</span></a></span><span> </span><span class="annot"><span class="annottext">CacheBehavior
</span><a href="Cardano.Wallet.DB.Layer.html#CacheLatestCheckpoint"><span class="hs-identifier hs-var">CacheLatestCheckpoint</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO WalletDBLog
</span><a href="#local-6989586621682487927"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682487924"><span class="hs-identifier hs-var">ti</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Either MigrationError SqliteContext
</span><a href="#local-6989586621682487917"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span id="local-6989586621682487913"><span id="local-6989586621682487914"></span></span><span class="hs-keyword">newtype</span><span> </span><span id="WalletDBLog"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#WalletDBLog"><span class="hs-identifier hs-var">WalletDBLog</span></a></span></span><span>
</span><span id="line-400"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="MsgDB"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgDB"><span class="hs-identifier hs-var">MsgDB</span></a></span></span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#DBLog"><span class="hs-identifier hs-type">DBLog</span></a></span><span>
</span><span id="line-401"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. WalletDBLog -&gt; Rep WalletDBLog x)
-&gt; (forall x. Rep WalletDBLog x -&gt; WalletDBLog)
-&gt; Generic WalletDBLog
forall x. Rep WalletDBLog x -&gt; WalletDBLog
forall x. WalletDBLog -&gt; Rep WalletDBLog x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep WalletDBLog x -&gt; WalletDBLog
$cfrom :: forall x. WalletDBLog -&gt; Rep WalletDBLog x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682487905"><span id="local-6989586621682487907"><span id="local-6989586621682487909"><span class="annot"><span class="annottext">Int -&gt; WalletDBLog -&gt; FilePath -&gt; FilePath
[WalletDBLog] -&gt; FilePath -&gt; FilePath
WalletDBLog -&gt; FilePath
(Int -&gt; WalletDBLog -&gt; FilePath -&gt; FilePath)
-&gt; (WalletDBLog -&gt; FilePath)
-&gt; ([WalletDBLog] -&gt; FilePath -&gt; FilePath)
-&gt; Show WalletDBLog
forall a.
(Int -&gt; a -&gt; FilePath -&gt; FilePath)
-&gt; (a -&gt; FilePath) -&gt; ([a] -&gt; FilePath -&gt; FilePath) -&gt; Show a
showList :: [WalletDBLog] -&gt; FilePath -&gt; FilePath
$cshowList :: [WalletDBLog] -&gt; FilePath -&gt; FilePath
show :: WalletDBLog -&gt; FilePath
$cshow :: WalletDBLog -&gt; FilePath
showsPrec :: Int -&gt; WalletDBLog -&gt; FilePath -&gt; FilePath
$cshowsPrec :: Int -&gt; WalletDBLog -&gt; FilePath -&gt; FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682487901"><span id="local-6989586621682487903"><span class="annot"><span class="annottext">WalletDBLog -&gt; WalletDBLog -&gt; Bool
(WalletDBLog -&gt; WalletDBLog -&gt; Bool)
-&gt; (WalletDBLog -&gt; WalletDBLog -&gt; Bool) -&gt; Eq WalletDBLog
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: WalletDBLog -&gt; WalletDBLog -&gt; Bool
$c/= :: WalletDBLog -&gt; WalletDBLog -&gt; Bool
== :: WalletDBLog -&gt; WalletDBLog -&gt; Bool
$c== :: WalletDBLog -&gt; WalletDBLog -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>
</span><span id="line-403"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682487899"><span class="annot"><span class="hs-identifier hs-type">HasPrivacyAnnotation</span></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#WalletDBLog"><span class="hs-identifier hs-type">WalletDBLog</span></a></span></span><span>
</span><span id="line-404"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasSeverityAnnotation</span></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#WalletDBLog"><span class="hs-identifier hs-type">WalletDBLog</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-405"></span><span>    </span><span id="local-6989586621682487897"><span class="annot"><span class="annottext">getSeverityAnnotation :: WalletDBLog -&gt; Severity
</span><a href="#local-6989586621682487897"><span class="hs-identifier hs-var hs-var hs-var hs-var">getSeverityAnnotation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-406"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgDB"><span class="hs-identifier hs-type">MsgDB</span></a></span><span> </span><span id="local-6989586621682487896"><span class="annot"><span class="annottext">DBLog
</span><a href="#local-6989586621682487896"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DBLog -&gt; Severity
forall a. HasSeverityAnnotation a =&gt; a -&gt; Severity
</span><span class="hs-identifier hs-var">getSeverityAnnotation</span></span><span> </span><span class="annot"><span class="annottext">DBLog
</span><a href="#local-6989586621682487896"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../text-class/html/src"><span class="hs-identifier hs-type">ToText</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#WalletDBLog"><span class="hs-identifier hs-type">WalletDBLog</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-409"></span><span>    </span><span id="local-6989586621682487894"><span class="annot"><span class="annottext">toText :: WalletDBLog -&gt; Text
</span><a href="#local-6989586621682487894"><span class="hs-identifier hs-var hs-var hs-var hs-var">toText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-410"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#MsgDB"><span class="hs-identifier hs-type">MsgDB</span></a></span><span> </span><span id="local-6989586621682487893"><span class="annot"><span class="annottext">DBLog
</span><a href="#local-6989586621682487893"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DBLog -&gt; Text
forall a. ToText a =&gt; a -&gt; Text
</span><a href="../../../../text-class/html/src"><span class="hs-identifier hs-var">toText</span></a></span><span> </span><span class="annot"><span class="annottext">DBLog
</span><a href="#local-6989586621682487893"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-411"></span><span>
</span><span id="line-412"></span><span class="hs-comment">-- | Runs an IO action with a new 'DBLayer' backed by a sqlite in-memory</span><span>
</span><span id="line-413"></span><span class="hs-comment">-- database.</span><span>
</span><span id="line-414"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#withDBLayerInMemory"><span class="hs-identifier hs-type">withDBLayerInMemory</span></a></span><span>
</span><span id="line-415"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682487892"><span class="annot"><a href="#local-6989586621682487892"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621682487891"><span class="annot"><a href="#local-6989586621682487891"><span class="hs-identifier hs-type">k</span></a></span></span><span> </span><span id="local-6989586621682487890"><span class="annot"><a href="#local-6989586621682487890"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-416"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682487892"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-417"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPrivateKey"><span class="hs-identifier hs-type">PersistPrivateKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682487891"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#RootK"><span class="hs-identifier hs-type">RootK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-type">Tracer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#WalletDBLog"><span class="hs-identifier hs-type">WalletDBLog</span></a></span><span>
</span><span id="line-420"></span><span>       </span><span class="hs-comment">-- ^ Logging object</span><span>
</span><span id="line-421"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier hs-type">TimeInterpreter</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-422"></span><span>       </span><span class="hs-comment">-- ^ Time interpreter for slot to time conversions</span><span>
</span><span id="line-423"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.html#DBLayer"><span class="hs-identifier hs-type">DBLayer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682487892"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682487891"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682487890"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682487890"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-425"></span><span id="withDBLayerInMemory"><span class="annot"><span class="annottext">withDBLayerInMemory :: Tracer IO WalletDBLog
-&gt; TimeInterpreter IO -&gt; (DBLayer IO s k -&gt; IO a) -&gt; IO a
</span><a href="Cardano.Wallet.DB.Layer.html#withDBLayerInMemory"><span class="hs-identifier hs-var hs-var">withDBLayerInMemory</span></a></span></span><span> </span><span id="local-6989586621682487889"><span class="annot"><span class="annottext">Tracer IO WalletDBLog
</span><a href="#local-6989586621682487889"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621682487888"><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682487888"><span class="hs-identifier hs-var">ti</span></a></span></span><span> </span><span id="local-6989586621682487887"><span class="annot"><span class="annottext">DBLayer IO s k -&gt; IO a
</span><a href="#local-6989586621682487887"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (IO (), DBLayer IO s k)
-&gt; ((IO (), DBLayer IO s k) -&gt; IO ())
-&gt; ((IO (), DBLayer IO s k) -&gt; IO a)
-&gt; IO a
forall (m :: * -&gt; *) a b c.
MonadUnliftIO m =&gt;
m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
</span><a href="../../../../unliftio/html/src"><span class="hs-identifier hs-var">bracket</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer IO WalletDBLog
-&gt; TimeInterpreter IO -&gt; IO (IO (), DBLayer IO s k)
forall s (k :: Depth -&gt; * -&gt; *).
(PersistAddressBook s, PersistPrivateKey (k 'RootK)) =&gt;
Tracer IO WalletDBLog
-&gt; TimeInterpreter IO -&gt; IO (IO (), DBLayer IO s k)
</span><a href="Cardano.Wallet.DB.Layer.html#newDBLayerInMemory"><span class="hs-identifier hs-var">newDBLayerInMemory</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO WalletDBLog
</span><a href="#local-6989586621682487889"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682487888"><span class="hs-identifier hs-var">ti</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (), DBLayer IO s k) -&gt; IO ()
forall a b. (a, b) -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DBLayer IO s k -&gt; IO a
</span><a href="#local-6989586621682487887"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">(DBLayer IO s k -&gt; IO a)
-&gt; ((IO (), DBLayer IO s k) -&gt; DBLayer IO s k)
-&gt; (IO (), DBLayer IO s k)
-&gt; IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (), DBLayer IO s k) -&gt; DBLayer IO s k
forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>
</span><span id="line-427"></span><span class="hs-comment">-- | Creates a 'DBLayer' backed by a sqlite in-memory database.</span><span>
</span><span id="line-428"></span><span class="hs-comment">--</span><span>
</span><span id="line-429"></span><span class="hs-comment">-- Returns a cleanup function which you should always use exactly once when</span><span>
</span><span id="line-430"></span><span class="hs-comment">-- finished with the 'DBLayer'.</span><span>
</span><span id="line-431"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#newDBLayerInMemory"><span class="hs-identifier hs-type">newDBLayerInMemory</span></a></span><span>
</span><span id="line-432"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682488531"><span class="annot"><a href="#local-6989586621682488531"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621682488529"><span class="annot"><a href="#local-6989586621682488529"><span class="hs-identifier hs-type">k</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-433"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488531"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-434"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPrivateKey"><span class="hs-identifier hs-type">PersistPrivateKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682488529"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#RootK"><span class="hs-identifier hs-type">RootK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-type">Tracer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#WalletDBLog"><span class="hs-identifier hs-type">WalletDBLog</span></a></span><span>
</span><span id="line-437"></span><span>       </span><span class="hs-comment">-- ^ Logging object</span><span>
</span><span id="line-438"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier hs-type">TimeInterpreter</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-439"></span><span>       </span><span class="hs-comment">-- ^ Time interpreter for slot to time conversions</span><span>
</span><span id="line-440"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.html#DBLayer"><span class="hs-identifier hs-type">DBLayer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488531"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488529"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span id="newDBLayerInMemory"><span class="annot"><span class="annottext">newDBLayerInMemory :: Tracer IO WalletDBLog
-&gt; TimeInterpreter IO -&gt; IO (IO (), DBLayer IO s k)
</span><a href="Cardano.Wallet.DB.Layer.html#newDBLayerInMemory"><span class="hs-identifier hs-var hs-var">newDBLayerInMemory</span></a></span></span><span> </span><span id="local-6989586621682487886"><span class="annot"><span class="annottext">Tracer IO WalletDBLog
</span><a href="#local-6989586621682487886"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621682487885"><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682487885"><span class="hs-identifier hs-var">ti</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-442"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487884"><span class="annot"><span class="annottext">tr' :: Tracer IO DBLog
</span><a href="#local-6989586621682487884"><span class="hs-identifier hs-var hs-var">tr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DBLog -&gt; WalletDBLog) -&gt; Tracer IO WalletDBLog -&gt; Tracer IO DBLog
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">DBLog -&gt; WalletDBLog
</span><a href="Cardano.Wallet.DB.Layer.html#MsgDB"><span class="hs-identifier hs-var">MsgDB</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO WalletDBLog
</span><a href="#local-6989586621682487886"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-443"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682487883"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621682487883"><span class="hs-identifier hs-var">destroy</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682487882"><span class="annot"><span class="annottext">SqliteContext
</span><a href="#local-6989586621682487882"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-444"></span><span>        </span><span class="annot"><span class="annottext">Tracer IO DBLog
-&gt; [ManualMigration]
-&gt; Migration
-&gt; ForeignKeysSetting
-&gt; IO (IO (), SqliteContext)
</span><a href="Cardano.DB.Sqlite.html#newInMemorySqliteContext"><span class="hs-identifier hs-var">newInMemorySqliteContext</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO DBLog
</span><a href="#local-6989586621682487884"><span class="hs-identifier hs-var">tr'</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#migrateAll"><span class="hs-identifier hs-var">migrateAll</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignKeysSetting
</span><a href="Cardano.DB.Sqlite.html#ForeignKeysEnabled"><span class="hs-identifier hs-var">ForeignKeysEnabled</span></a></span><span>
</span><span id="line-445"></span><span>    </span><span id="local-6989586621682487881"><span class="annot"><span class="annottext">DBLayer IO s k
</span><a href="#local-6989586621682487881"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Tracer IO WalletDBLog
-&gt; TimeInterpreter IO -&gt; SqliteContext -&gt; IO (DBLayer IO s k)
forall s (k :: Depth -&gt; * -&gt; *).
(PersistAddressBook s, PersistPrivateKey (k 'RootK)) =&gt;
Tracer IO WalletDBLog
-&gt; TimeInterpreter IO -&gt; SqliteContext -&gt; IO (DBLayer IO s k)
</span><a href="Cardano.Wallet.DB.Layer.html#newDBLayer"><span class="hs-identifier hs-var">newDBLayer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO WalletDBLog
</span><a href="#local-6989586621682487886"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682487885"><span class="hs-identifier hs-var">ti</span></a></span><span> </span><span class="annot"><span class="annottext">SqliteContext
</span><a href="#local-6989586621682487882"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-446"></span><span>    </span><span class="annot"><span class="annottext">(IO (), DBLayer IO s k) -&gt; IO (IO (), DBLayer IO s k)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621682487883"><span class="hs-identifier hs-var">destroy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DBLayer IO s k
</span><a href="#local-6989586621682487881"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span class="hs-comment">-- | What to do with regards to caching. This is useful to disable caching in</span><span>
</span><span id="line-449"></span><span class="hs-comment">-- database benchmarks.</span><span>
</span><span id="line-450"></span><span class="hs-keyword">data</span><span> </span><span id="CacheBehavior"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#CacheBehavior"><span class="hs-identifier hs-var">CacheBehavior</span></a></span></span><span>
</span><span id="line-451"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="NoCache"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#NoCache"><span class="hs-identifier hs-var">NoCache</span></a></span></span><span>
</span><span id="line-452"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="CacheLatestCheckpoint"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#CacheLatestCheckpoint"><span class="hs-identifier hs-var">CacheLatestCheckpoint</span></a></span></span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682487875"><span id="local-6989586621682487877"><span class="annot"><span class="annottext">CacheBehavior -&gt; CacheBehavior -&gt; Bool
(CacheBehavior -&gt; CacheBehavior -&gt; Bool)
-&gt; (CacheBehavior -&gt; CacheBehavior -&gt; Bool) -&gt; Eq CacheBehavior
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: CacheBehavior -&gt; CacheBehavior -&gt; Bool
$c/= :: CacheBehavior -&gt; CacheBehavior -&gt; Bool
== :: CacheBehavior -&gt; CacheBehavior -&gt; Bool
$c== :: CacheBehavior -&gt; CacheBehavior -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682487869"><span id="local-6989586621682487871"><span id="local-6989586621682487873"><span class="annot"><span class="annottext">Int -&gt; CacheBehavior -&gt; FilePath -&gt; FilePath
[CacheBehavior] -&gt; FilePath -&gt; FilePath
CacheBehavior -&gt; FilePath
(Int -&gt; CacheBehavior -&gt; FilePath -&gt; FilePath)
-&gt; (CacheBehavior -&gt; FilePath)
-&gt; ([CacheBehavior] -&gt; FilePath -&gt; FilePath)
-&gt; Show CacheBehavior
forall a.
(Int -&gt; a -&gt; FilePath -&gt; FilePath)
-&gt; (a -&gt; FilePath) -&gt; ([a] -&gt; FilePath -&gt; FilePath) -&gt; Show a
showList :: [CacheBehavior] -&gt; FilePath -&gt; FilePath
$cshowList :: [CacheBehavior] -&gt; FilePath -&gt; FilePath
show :: CacheBehavior -&gt; FilePath
$cshow :: CacheBehavior -&gt; FilePath
showsPrec :: Int -&gt; CacheBehavior -&gt; FilePath -&gt; FilePath
$cshowsPrec :: Int -&gt; CacheBehavior -&gt; FilePath -&gt; FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span class="hs-comment">-- | Sets up a connection to the SQLite database.</span><span>
</span><span id="line-456"></span><span class="hs-comment">--</span><span>
</span><span id="line-457"></span><span class="hs-comment">-- Database migrations are run to create tables if necessary.</span><span>
</span><span id="line-458"></span><span class="hs-comment">--</span><span>
</span><span id="line-459"></span><span class="hs-comment">-- If the given file path does not exist, it will be created by the sqlite</span><span>
</span><span id="line-460"></span><span class="hs-comment">-- library.</span><span>
</span><span id="line-461"></span><span class="hs-comment">--</span><span>
</span><span id="line-462"></span><span class="hs-comment">-- 'newDBLayer' will provide the actual 'DBLayer' implementation. It requires an</span><span>
</span><span id="line-463"></span><span class="hs-comment">-- 'SqliteContext' which can be obtained from a database connection pool. This</span><span>
</span><span id="line-464"></span><span class="hs-comment">-- is better initialized with 'withDBLayer'.</span><span>
</span><span id="line-465"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#newDBLayer"><span class="hs-identifier hs-type">newDBLayer</span></a></span><span>
</span><span id="line-466"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682488408"><span class="annot"><a href="#local-6989586621682488408"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621682488407"><span class="annot"><a href="#local-6989586621682488407"><span class="hs-identifier hs-type">k</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-467"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488408"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-468"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPrivateKey"><span class="hs-identifier hs-type">PersistPrivateKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682488407"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#RootK"><span class="hs-identifier hs-type">RootK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-470"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-type">Tracer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#WalletDBLog"><span class="hs-identifier hs-type">WalletDBLog</span></a></span><span>
</span><span id="line-471"></span><span>       </span><span class="hs-comment">-- ^ Logging</span><span>
</span><span id="line-472"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier hs-type">TimeInterpreter</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-473"></span><span>       </span><span class="hs-comment">-- ^ Time interpreter for slot to time conversions</span><span>
</span><span id="line-474"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#SqliteContext"><span class="hs-identifier hs-type">SqliteContext</span></a></span><span>
</span><span id="line-475"></span><span>       </span><span class="hs-comment">-- ^ A (thread-)safe wrapper for query execution.</span><span>
</span><span id="line-476"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.html#DBLayer"><span class="hs-identifier hs-type">DBLayer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488408"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488407"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-477"></span><span id="newDBLayer"><span class="annot"><span class="annottext">newDBLayer :: Tracer IO WalletDBLog
-&gt; TimeInterpreter IO -&gt; SqliteContext -&gt; IO (DBLayer IO s k)
</span><a href="Cardano.Wallet.DB.Layer.html#newDBLayer"><span class="hs-identifier hs-var hs-var">newDBLayer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheBehavior
-&gt; Tracer IO WalletDBLog
-&gt; TimeInterpreter IO
-&gt; SqliteContext
-&gt; IO (DBLayer IO s k)
forall s (k :: Depth -&gt; * -&gt; *).
(PersistAddressBook s, PersistPrivateKey (k 'RootK)) =&gt;
CacheBehavior
-&gt; Tracer IO WalletDBLog
-&gt; TimeInterpreter IO
-&gt; SqliteContext
-&gt; IO (DBLayer IO s k)
</span><a href="Cardano.Wallet.DB.Layer.html#newDBLayerWith"><span class="hs-identifier hs-var">newDBLayerWith</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682488408"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621682488407"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><span class="annottext">CacheBehavior
</span><a href="Cardano.Wallet.DB.Layer.html#CacheLatestCheckpoint"><span class="hs-identifier hs-var">CacheLatestCheckpoint</span></a></span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span class="hs-comment">{- HLINT ignore newDBLayerWith &quot;Redundant &lt;$&gt;&quot; -}</span><span>
</span><span id="line-480"></span><span class="hs-comment">-- | Like 'newDBLayer', but allows to explicitly specify the caching behavior.</span><span>
</span><span id="line-481"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#newDBLayerWith"><span class="hs-identifier hs-type">newDBLayerWith</span></a></span><span>
</span><span id="line-482"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682488426"><span class="annot"><a href="#local-6989586621682488426"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621682488425"><span class="annot"><a href="#local-6989586621682488425"><span class="hs-identifier hs-type">k</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-483"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Checkpoints.html#PersistAddressBook"><span class="hs-identifier hs-type">PersistAddressBook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488426"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-484"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPrivateKey"><span class="hs-identifier hs-type">PersistPrivateKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682488425"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#RootK"><span class="hs-identifier hs-type">RootK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-485"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#CacheBehavior"><span class="hs-identifier hs-type">CacheBehavior</span></a></span><span>
</span><span id="line-487"></span><span>       </span><span class="hs-comment">-- ^ Option to disable caching.</span><span>
</span><span id="line-488"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-type">Tracer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#WalletDBLog"><span class="hs-identifier hs-type">WalletDBLog</span></a></span><span>
</span><span id="line-489"></span><span>       </span><span class="hs-comment">-- ^ Logging</span><span>
</span><span id="line-490"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier hs-type">TimeInterpreter</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-491"></span><span>       </span><span class="hs-comment">-- ^ Time interpreter for slot to time conversions</span><span>
</span><span id="line-492"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#SqliteContext"><span class="hs-identifier hs-type">SqliteContext</span></a></span><span>
</span><span id="line-493"></span><span>       </span><span class="hs-comment">-- ^ A (thread-)safe wrapper for query execution.</span><span>
</span><span id="line-494"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.html#DBLayer"><span class="hs-identifier hs-type">DBLayer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488426"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488425"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span id="newDBLayerWith"><span class="annot"><span class="annottext">newDBLayerWith :: CacheBehavior
-&gt; Tracer IO WalletDBLog
-&gt; TimeInterpreter IO
-&gt; SqliteContext
-&gt; IO (DBLayer IO s k)
</span><a href="Cardano.Wallet.DB.Layer.html#newDBLayerWith"><span class="hs-identifier hs-var hs-var">newDBLayerWith</span></a></span></span><span> </span><span id="local-6989586621682487868"><span class="annot"><span class="annottext">CacheBehavior
</span><a href="#local-6989586621682487868"><span class="hs-identifier hs-var">_cacheBehavior</span></a></span></span><span> </span><span id="local-6989586621682487867"><span class="annot"><span class="annottext">Tracer IO WalletDBLog
</span><a href="#local-6989586621682487867"><span class="hs-identifier hs-var">_tr</span></a></span></span><span> </span><span id="local-6989586621682487866"><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682487866"><span class="hs-identifier hs-var">ti</span></a></span></span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#SqliteContext"><span class="hs-identifier hs-type">SqliteContext</span></a></span><span class="hs-special">{</span><span id="local-6989586621682487864"><span class="annot"><span class="annottext">forall a. SqlPersistT IO a -&gt; IO a
$sel:runQuery:SqliteContext :: SqliteContext -&gt; forall a. SqlPersistT IO a -&gt; IO a
runQuery :: forall a. SqlPersistT IO a -&gt; IO a
</span><a href="Cardano.DB.Sqlite.html#%24sel%3ArunQuery%3ASqliteContext"><span class="hs-identifier hs-var hs-var">runQuery</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-496"></span><span>    </span><span class="hs-comment">-- FIXME LATER during ADP-1043:</span><span>
</span><span id="line-497"></span><span>    </span><span class="hs-comment">--   Remove the 'NoCache' behavior, we cannot get it back.</span><span>
</span><span id="line-498"></span><span>    </span><span class="hs-comment">--   This will affect read benchmarks, they will need to benchmark</span><span>
</span><span id="line-499"></span><span>    </span><span class="hs-comment">--   'loadDBVar' instead.</span><span>
</span><span id="line-500"></span><span>
</span><span id="line-501"></span><span>    </span><span class="hs-comment">-- FIXME LATER during ADP-1043:</span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-comment">--   Handle the case where loading the database fails.</span><span>
</span><span id="line-503"></span><span>    </span><span id="local-6989586621682487862"><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
</span><a href="#local-6989586621682487862"><span class="hs-identifier hs-var">walletsDB_</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SqlPersistT
  IO
  (DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s)))
-&gt; IO
     (DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s)))
forall a. SqlPersistT IO a -&gt; IO a
</span><a href="#local-6989586621682487864"><span class="hs-identifier hs-var">runQuery</span></a></span><span> </span><span class="annot"><span class="annottext">(SqlPersistT
   IO
   (DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s)))
 -&gt; IO
      (DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))))
-&gt; SqlPersistT
     IO
     (DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s)))
-&gt; IO
     (DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Store (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
-&gt; SqlPersistT
     IO
     (DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s)))
forall (m :: * -&gt; *) da.
(MonadSTM m, MonadThrow m, MonadEvaluate m, MonadMask m,
 Delta da) =&gt;
Store m da -&gt; m (DBVar m da)
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">loadDBVar</span></a></span><span> </span><span class="annot"><span class="annottext">Store (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
forall s key.
(PersistAddressBook s, key ~ WalletId) =&gt;
Store (SqlPersistT IO) (DeltaMap key (DeltaWalletState s))
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#mkStoreWallets"><span class="hs-identifier hs-var">mkStoreWallets</span></a></span><span>
</span><span id="line-504"></span><span>    </span><span id="local-6989586621682487861"><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
</span><a href="#local-6989586621682487861"><span class="hs-identifier hs-var">transactionsDBVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (DBVar (SqlPersistT IO) DeltaTxWalletsHistory)
-&gt; IO (DBVar (SqlPersistT IO) DeltaTxWalletsHistory)
forall a. SqlPersistT IO a -&gt; IO a
</span><a href="#local-6989586621682487864"><span class="hs-identifier hs-var">runQuery</span></a></span><span> </span><span class="annot"><span class="annottext">(SqlPersistT IO (DBVar (SqlPersistT IO) DeltaTxWalletsHistory)
 -&gt; IO (DBVar (SqlPersistT IO) DeltaTxWalletsHistory))
-&gt; SqlPersistT IO (DBVar (SqlPersistT IO) DeltaTxWalletsHistory)
-&gt; IO (DBVar (SqlPersistT IO) DeltaTxWalletsHistory)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Store (SqlPersistT IO) DeltaTxWalletsHistory
-&gt; SqlPersistT IO (DBVar (SqlPersistT IO) DeltaTxWalletsHistory)
forall (m :: * -&gt; *) da.
(MonadSTM m, MonadThrow m, MonadEvaluate m, MonadMask m,
 Delta da) =&gt;
Store m da -&gt; m (DBVar m da)
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">loadDBVar</span></a></span><span> </span><span class="annot"><span class="annottext">Store (SqlPersistT IO) DeltaTxWalletsHistory
</span><a href="Cardano.Wallet.DB.Store.Wallets.Store.html#mkStoreTxWalletsHistory"><span class="hs-identifier hs-var">mkStoreTxWalletsHistory</span></a></span><span>
</span><span id="line-505"></span><span>
</span><span id="line-506"></span><span>    </span><span class="hs-comment">-- NOTE</span><span>
</span><span id="line-507"></span><span>    </span><span class="hs-comment">-- The cache will not work properly unless 'atomically' is protected by a</span><span>
</span><span id="line-508"></span><span>    </span><span class="hs-comment">-- mutex (queryLock), which means no concurrent queries.</span><span>
</span><span id="line-509"></span><span>    </span><span id="local-6989586621682487860"><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621682487860"><span class="hs-identifier hs-var">queryLock</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO (MVar ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (MVar a)
</span><a href="../../../../unliftio/html/src"><span class="hs-identifier hs-var">newMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- fixme: ADP-586</span><span>
</span><span id="line-510"></span><span>
</span><span id="line-511"></span><span>    </span><span class="hs-comment">-- Insert genesis checkpoint into the DBVar.</span><span>
</span><span id="line-512"></span><span>    </span><span class="hs-comment">-- Throws an internal error if the checkpoint is not actually at genesis.</span><span>
</span><span id="line-513"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487859"><span class="annot"><span class="annottext">insertCheckpointGenesis :: WalletId -&gt; Wallet s -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682487859"><span class="hs-identifier hs-var hs-var">insertCheckpointGenesis</span></a></span></span><span> </span><span id="local-6989586621682487858"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487858"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487857"><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487857"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-514"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Wallet s -&gt; Maybe (WalletState s)
forall s. AddressBookIso s =&gt; Wallet s -&gt; Maybe (WalletState s)
</span><a href="Cardano.Wallet.DB.WalletState.html#fromGenesis"><span class="hs-identifier hs-var">fromGenesis</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487857"><span class="hs-identifier hs-var">cp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-515"></span><span>                </span><span class="annot"><span class="annottext">Maybe (WalletState s)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ErrInitializeGenesisAbsent -&gt; SqlPersistT IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><a href="../../../../unliftio/html/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrInitializeGenesisAbsent -&gt; SqlPersistT IO ())
-&gt; ErrInitializeGenesisAbsent -&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; BlockHeader -&gt; ErrInitializeGenesisAbsent
</span><a href="Cardano.Wallet.DB.Layer.html#ErrInitializeGenesisAbsent"><span class="hs-identifier hs-var">ErrInitializeGenesisAbsent</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487858"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682487855"><span class="hs-identifier hs-var">header</span></a></span><span>
</span><span id="line-516"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682487854"><span class="annot"><span class="annottext">WalletState s
</span><a href="#local-6989586621682487854"><span class="hs-identifier hs-var">wallet</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-517"></span><span>                    </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
-&gt; DeltaMap WalletId (DeltaWalletState s) -&gt; SqlPersistT IO ()
forall da (m :: * -&gt; *).
(Delta da, Monad m) =&gt;
DBVar m da -&gt; da -&gt; m ()
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">updateDBVar</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
</span><a href="#local-6989586621682487862"><span class="hs-identifier hs-var">walletsDB_</span></a></span><span> </span><span class="annot"><span class="annottext">(DeltaMap WalletId (DeltaWalletState s) -&gt; SqlPersistT IO ())
-&gt; DeltaMap WalletId (DeltaWalletState s) -&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; Base (DeltaWalletState s)
-&gt; DeltaMap WalletId (DeltaWalletState s)
forall key da. key -&gt; Base da -&gt; DeltaMap key da
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">Insert</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487858"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Base (DeltaWalletState s)
WalletState s
</span><a href="#local-6989586621682487854"><span class="hs-identifier hs-var">wallet</span></a></span><span>
</span><span id="line-518"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-519"></span><span>            </span><span id="local-6989586621682487855"><span class="annot"><span class="annottext">header :: BlockHeader
</span><a href="#local-6989586621682487855"><span class="hs-identifier hs-var hs-var">header</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487857"><span class="hs-identifier hs-var">cp</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet s
-&gt; ((BlockHeader -&gt; Const BlockHeader BlockHeader)
    -&gt; Wallet s -&gt; Const BlockHeader (Wallet s))
-&gt; BlockHeader
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;currentTip&quot;
  ((BlockHeader -&gt; Const BlockHeader BlockHeader)
   -&gt; Wallet s -&gt; Const BlockHeader (Wallet s))
(BlockHeader -&gt; Const BlockHeader BlockHeader)
-&gt; Wallet s -&gt; Const BlockHeader (Wallet s)
</span><a href="#local-6989586621682487852"><span class="hs-var">#currentTip</span></a></span><span>
</span><span id="line-520"></span><span>
</span><span id="line-521"></span><span>    </span><span class="hs-comment">-- Retrieve the latest checkpoint from the DBVar</span><span>
</span><span id="line-522"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621682487851"><span class="hs-identifier hs-type">readCheckpoint_</span></a></span><span>
</span><span id="line-523"></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-524"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Model.html#Wallet"><span class="hs-identifier hs-type">W.Wallet</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488426"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-525"></span><span>        </span><span id="local-6989586621682487851"><span class="annot"><span class="annottext">readCheckpoint_ :: WalletId -&gt; SqlPersistT IO (Maybe (Wallet s))
</span><a href="#local-6989586621682487851"><span class="hs-identifier hs-var hs-var">readCheckpoint_</span></a></span></span><span> </span><span id="local-6989586621682487850"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487850"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-526"></span><span>            </span><span class="annot"><span class="annottext">(WalletState s -&gt; Wallet s)
-&gt; Maybe (WalletState s) -&gt; Maybe (Wallet s)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">WalletState s -&gt; Wallet s
forall s. AddressBookIso s =&gt; WalletState s -&gt; Wallet s
</span><a href="Cardano.Wallet.DB.WalletState.html#getLatest"><span class="hs-identifier hs-var">getLatest</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (WalletState s) -&gt; Maybe (Wallet s))
-&gt; (Map WalletId (WalletState s) -&gt; Maybe (WalletState s))
-&gt; Map WalletId (WalletState s)
-&gt; Maybe (Wallet s)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; Map WalletId (WalletState s) -&gt; Maybe (WalletState s)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487850"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">(Map WalletId (WalletState s) -&gt; Maybe (Wallet s))
-&gt; SqlPersistT IO (Map WalletId (WalletState s))
-&gt; SqlPersistT IO (Maybe (Wallet s))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
-&gt; SqlPersistT IO (Map WalletId (WalletState s))
forall da a (m :: * -&gt; *).
(Delta da, a ~ Base da) =&gt;
DBVar m da -&gt; m a
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">readDBVar</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
</span><a href="#local-6989586621682487862"><span class="hs-identifier hs-var">walletsDB_</span></a></span><span>
</span><span id="line-527"></span><span>
</span><span id="line-528"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621682487849"><span class="hs-identifier hs-type">pruneCheckpoints</span></a></span><span>
</span><span id="line-529"></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-530"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-type">Quantity</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;block&quot;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">W.BlockHeader</span></a></span><span>
</span><span id="line-531"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-532"></span><span>        </span><span id="local-6989586621682487849"><span class="annot"><span class="annottext">pruneCheckpoints :: WalletId
-&gt; Quantity &quot;block&quot; Word32 -&gt; BlockHeader -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682487849"><span class="hs-identifier hs-var hs-var">pruneCheckpoints</span></a></span></span><span> </span><span id="local-6989586621682487848"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487848"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487847"><span class="annot"><span class="annottext">Quantity &quot;block&quot; Word32
</span><a href="#local-6989586621682487847"><span class="hs-identifier hs-var">epochStability</span></a></span></span><span> </span><span id="local-6989586621682487846"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682487846"><span class="hs-identifier hs-var">tip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-533"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487845"><span class="annot"><span class="annottext">heights :: Set Word32
</span><a href="#local-6989586621682487845"><span class="hs-identifier hs-var hs-var">heights</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Word32] -&gt; Set Word32
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Word32] -&gt; Set Word32) -&gt; [Word32] -&gt; Set Word32
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SparseCheckpointsConfig -&gt; Quantity &quot;block&quot; Word32 -&gt; [Word32]
</span><a href="Cardano.Wallet.Checkpoints.html#sparseCheckpoints"><span class="hs-identifier hs-var">sparseCheckpoints</span></a></span><span>
</span><span id="line-534"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Quantity &quot;block&quot; Word32 -&gt; SparseCheckpointsConfig
</span><a href="Cardano.Wallet.Checkpoints.html#defaultSparseCheckpointsConfig"><span class="hs-identifier hs-var">defaultSparseCheckpointsConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Quantity &quot;block&quot; Word32
</span><a href="#local-6989586621682487847"><span class="hs-identifier hs-var">epochStability</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-535"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682487846"><span class="hs-identifier hs-var">tip</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
-&gt; ((Quantity &quot;block&quot; Word32
     -&gt; Const (Quantity &quot;block&quot; Word32) (Quantity &quot;block&quot; Word32))
    -&gt; BlockHeader -&gt; Const (Quantity &quot;block&quot; Word32) BlockHeader)
-&gt; Quantity &quot;block&quot; Word32
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;blockHeight&quot;
  ((Quantity &quot;block&quot; Word32
    -&gt; Const (Quantity &quot;block&quot; Word32) (Quantity &quot;block&quot; Word32))
   -&gt; BlockHeader -&gt; Const (Quantity &quot;block&quot; Word32) BlockHeader)
(Quantity &quot;block&quot; Word32
 -&gt; Const (Quantity &quot;block&quot; Word32) (Quantity &quot;block&quot; Word32))
-&gt; BlockHeader -&gt; Const (Quantity &quot;block&quot; Word32) BlockHeader
</span><a href="#local-6989586621682487843"><span class="hs-var">#blockHeight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-536"></span><span>            </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
-&gt; (Map WalletId (WalletState s)
    -&gt; (Maybe (DeltaMap WalletId (DeltaWalletState s)), ()))
-&gt; SqlPersistT IO ()
forall da (m :: * -&gt; *) a b.
(Delta da, Monad m, a ~ Base da) =&gt;
DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">modifyDBMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
</span><a href="#local-6989586621682487862"><span class="hs-identifier hs-var">walletsDB_</span></a></span><span> </span><span class="annot"><span class="annottext">((Map WalletId (WalletState s)
  -&gt; (Maybe (DeltaMap WalletId (DeltaWalletState s)), ()))
 -&gt; SqlPersistT IO ())
-&gt; (Map WalletId (WalletState s)
    -&gt; (Maybe (DeltaMap WalletId (DeltaWalletState s)), ()))
-&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487842"><span class="annot"><span class="annottext">Map WalletId (WalletState s)
</span><a href="#local-6989586621682487842"><span class="hs-identifier hs-var">ws</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-537"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; Map WalletId (WalletState s) -&gt; Maybe (WalletState s)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487848"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Map WalletId (WalletState s)
</span><a href="#local-6989586621682487842"><span class="hs-identifier hs-var">ws</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-538"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (WalletState s)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (DeltaMap WalletId (DeltaWalletState s))
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-539"></span><span>                    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682487841"><span class="annot"><span class="annottext">WalletState s
</span><a href="#local-6989586621682487841"><span class="hs-identifier hs-var">wal</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-540"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487840"><span class="annot"><span class="annottext">willKeep :: WalletCheckpoint s -&gt; Bool
</span><a href="#local-6989586621682487840"><span class="hs-identifier hs-var hs-var">willKeep</span></a></span></span><span> </span><span id="local-6989586621682487839"><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682487839"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletCheckpoint s -&gt; Word32
forall s. WalletCheckpoint s -&gt; Word32
</span><a href="Cardano.Wallet.DB.WalletState.html#getBlockHeight"><span class="hs-identifier hs-var">getBlockHeight</span></a></span><span> </span><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682487839"><span class="hs-identifier hs-var">cp</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Set Word32 -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../../../containers/html/src"><span class="hs-operator hs-var">`Set.member`</span></a></span><span> </span><span class="annot"><span class="annottext">Set Word32
</span><a href="#local-6989586621682487845"><span class="hs-identifier hs-var">heights</span></a></span><span>
</span><span id="line-541"></span><span>                            </span><span id="local-6989586621682487837"><span class="annot"><span class="annottext">slots :: Map Slot (WalletCheckpoint s)
</span><a href="#local-6989586621682487837"><span class="hs-identifier hs-var hs-var">slots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(WalletCheckpoint s -&gt; Bool)
-&gt; Map Slot (WalletCheckpoint s) -&gt; Map Slot (WalletCheckpoint s)
forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filter</span></a></span><span> </span><span class="annot"><span class="annottext">WalletCheckpoint s -&gt; Bool
forall s. WalletCheckpoint s -&gt; Bool
</span><a href="#local-6989586621682487840"><span class="hs-identifier hs-var">willKeep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletState s
</span><a href="#local-6989586621682487841"><span class="hs-identifier hs-var">wal</span></a></span><span> </span><span class="annot"><span class="annottext">WalletState s
-&gt; ((Map Slot (WalletCheckpoint s)
     -&gt; Const
          (Map Slot (WalletCheckpoint s)) (Map Slot (WalletCheckpoint s)))
    -&gt; WalletState s
    -&gt; Const (Map Slot (WalletCheckpoint s)) (WalletState s))
-&gt; Map Slot (WalletCheckpoint s)
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;checkpoints&quot;
  ((Checkpoints (WalletCheckpoint s)
    -&gt; Const
         (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s)))
   -&gt; WalletState s
   -&gt; Const (Map Slot (WalletCheckpoint s)) (WalletState s))
(Checkpoints (WalletCheckpoint s)
 -&gt; Const
      (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s)))
-&gt; WalletState s
-&gt; Const (Map Slot (WalletCheckpoint s)) (WalletState s)
</span><a href="#local-6989586621682487835"><span class="hs-var">#checkpoints</span></a></span><span> </span><span class="annot"><span class="annottext">((Checkpoints (WalletCheckpoint s)
  -&gt; Const
       (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s)))
 -&gt; WalletState s
 -&gt; Const (Map Slot (WalletCheckpoint s)) (WalletState s))
-&gt; ((Map Slot (WalletCheckpoint s)
     -&gt; Const
          (Map Slot (WalletCheckpoint s)) (Map Slot (WalletCheckpoint s)))
    -&gt; Checkpoints (WalletCheckpoint s)
    -&gt; Const
         (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s)))
-&gt; (Map Slot (WalletCheckpoint s)
    -&gt; Const
         (Map Slot (WalletCheckpoint s)) (Map Slot (WalletCheckpoint s)))
-&gt; WalletState s
-&gt; Const (Map Slot (WalletCheckpoint s)) (WalletState s)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;checkpoints&quot;
  ((Map Slot (WalletCheckpoint s)
    -&gt; Const
         (Map Slot (WalletCheckpoint s)) (Map Slot (WalletCheckpoint s)))
   -&gt; Checkpoints (WalletCheckpoint s)
   -&gt; Const
        (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s)))
(Map Slot (WalletCheckpoint s)
 -&gt; Const
      (Map Slot (WalletCheckpoint s)) (Map Slot (WalletCheckpoint s)))
-&gt; Checkpoints (WalletCheckpoint s)
-&gt; Const
     (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s))
</span><a href="#local-6989586621682487834"><span class="hs-var">#checkpoints</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-542"></span><span>                            </span><span id="local-6989586621682487833"><span class="annot"><span class="annottext">delta :: DeltaMap WalletId [DeltaWalletState1 s]
</span><a href="#local-6989586621682487833"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; [DeltaWalletState1 s] -&gt; DeltaMap WalletId [DeltaWalletState1 s]
forall key da. key -&gt; da -&gt; DeltaMap key da
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">Adjust</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487848"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-543"></span><span>                                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">DeltasCheckpoints (WalletCheckpoint s) -&gt; DeltaWalletState1 s
forall s.
DeltasCheckpoints (WalletCheckpoint s) -&gt; DeltaWalletState1 s
</span><a href="Cardano.Wallet.DB.WalletState.html#UpdateCheckpoints"><span class="hs-identifier hs-var">UpdateCheckpoints</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Slot] -&gt; DeltaCheckpoints (WalletCheckpoint s)
forall a. [Slot] -&gt; DeltaCheckpoints a
</span><a href="Cardano.Wallet.Checkpoints.html#RestrictTo"><span class="hs-identifier hs-var">RestrictTo</span></a></span><span> </span><span class="annot"><span class="annottext">([Slot] -&gt; DeltaCheckpoints (WalletCheckpoint s))
-&gt; [Slot] -&gt; DeltaCheckpoints (WalletCheckpoint s)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map Slot (WalletCheckpoint s) -&gt; [Slot]
forall k a. Map k a -&gt; [k]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.keys</span></a></span><span> </span><span class="annot"><span class="annottext">Map Slot (WalletCheckpoint s)
</span><a href="#local-6989586621682487837"><span class="hs-identifier hs-var">slots</span></a></span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-544"></span><span>                        </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DeltaMap WalletId (DeltaWalletState s)
-&gt; Maybe (DeltaMap WalletId (DeltaWalletState s))
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaMap WalletId (DeltaWalletState s)
forall s. DeltaMap WalletId [DeltaWalletState1 s]
</span><a href="#local-6989586621682487833"><span class="hs-identifier hs-var">delta</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span>    </span><span class="hs-comment">-- Delete the a wallet from the checkpoint DBVar</span><span>
</span><span id="line-547"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621682487829"><span class="hs-identifier hs-type">deleteCheckpoints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>        </span><span id="local-6989586621682487829"><span class="annot"><span class="annottext">deleteCheckpoints :: WalletId -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682487829"><span class="hs-identifier hs-var hs-var">deleteCheckpoints</span></a></span></span><span> </span><span id="local-6989586621682487828"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487828"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
-&gt; DeltaMap WalletId (DeltaWalletState s) -&gt; SqlPersistT IO ()
forall da (m :: * -&gt; *).
(Delta da, Monad m) =&gt;
DBVar m da -&gt; da -&gt; m ()
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">updateDBVar</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
</span><a href="#local-6989586621682487862"><span class="hs-identifier hs-var">walletsDB_</span></a></span><span> </span><span class="annot"><span class="annottext">(DeltaMap WalletId (DeltaWalletState s) -&gt; SqlPersistT IO ())
-&gt; DeltaMap WalletId (DeltaWalletState s) -&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; DeltaMap WalletId (DeltaWalletState s)
forall key da. key -&gt; DeltaMap key da
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">Delete</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487828"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-549"></span><span>
</span><span id="line-550"></span><span>    </span><span class="annot"><span class="annottext">DBLayer IO s k -&gt; IO (DBLayer IO s k)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">DBLayer :: forall (m :: * -&gt; *) s (k :: Depth -&gt; * -&gt; *) (stm :: * -&gt; *).
(MonadIO stm, MonadFail stm) =&gt;
(WalletId
 -&gt; Wallet s
 -&gt; WalletMetadata
 -&gt; [(Tx, TxMeta)]
 -&gt; GenesisParameters
 -&gt; ExceptT ErrWalletAlreadyExists stm ())
-&gt; (WalletId -&gt; ExceptT ErrNoSuchWallet stm ())
-&gt; stm [WalletId]
-&gt; DBVar stm (DeltaMap WalletId (DeltaWalletState s))
-&gt; (WalletId -&gt; Wallet s -&gt; ExceptT ErrNoSuchWallet stm ())
-&gt; (WalletId -&gt; stm (Maybe (Wallet s)))
-&gt; (WalletId -&gt; stm [ChainPoint])
-&gt; (WalletId -&gt; WalletMetadata -&gt; ExceptT ErrNoSuchWallet stm ())
-&gt; (WalletId -&gt; stm (Maybe WalletMetadata))
-&gt; (WalletId -&gt; ExceptT ErrNoSuchWallet stm Bool)
-&gt; (WalletId
    -&gt; DelegationCertificate
    -&gt; SlotNo
    -&gt; ExceptT ErrNoSuchWallet stm ())
-&gt; (WalletId -&gt; Coin -&gt; ExceptT ErrNoSuchWallet stm ())
-&gt; (WalletId -&gt; stm Coin)
-&gt; (WalletId -&gt; [(Tx, TxMeta)] -&gt; ExceptT ErrNoSuchWallet stm ())
-&gt; (WalletId
    -&gt; Maybe Coin
    -&gt; SortOrder
    -&gt; Range SlotNo
    -&gt; Maybe TxStatus
    -&gt; stm [TransactionInfo])
-&gt; (WalletId
    -&gt; Hash &quot;Tx&quot;
    -&gt; ExceptT ErrNoSuchWallet stm (Maybe TransactionInfo))
-&gt; (WalletId
    -&gt; Hash &quot;Tx&quot;
    -&gt; SealedTx
    -&gt; SlotNo
    -&gt; ExceptT ErrPutLocalTxSubmission stm ())
-&gt; (WalletId -&gt; stm [LocalTxSubmissionStatus SealedTx])
-&gt; (WalletId -&gt; SlotNo -&gt; ExceptT ErrNoSuchWallet stm ())
-&gt; (WalletId -&gt; Hash &quot;Tx&quot; -&gt; ExceptT ErrRemoveTx stm ())
-&gt; (WalletId
    -&gt; (k 'RootK XPrv, PassphraseHash)
    -&gt; ExceptT ErrNoSuchWallet stm ())
-&gt; (WalletId -&gt; stm (Maybe (k 'RootK XPrv, PassphraseHash)))
-&gt; (WalletId -&gt; stm (Maybe GenesisParameters))
-&gt; (WalletId -&gt; Slot -&gt; ExceptT ErrNoSuchWallet stm ChainPoint)
-&gt; (WalletId
    -&gt; Quantity &quot;block&quot; Word32 -&gt; ExceptT ErrNoSuchWallet stm ())
-&gt; (forall a. stm a -&gt; m a)
-&gt; DBLayer m s k
</span><a href="Cardano.Wallet.DB.html#DBLayer"><span class="hs-identifier hs-type">DBLayer</span></a></span><span>
</span><span id="line-551"></span><span>
</span><span id="line-552"></span><span>        </span><span class="hs-comment">{-----------------------------------------------------------------------
                                      Wallets
        -----------------------------------------------------------------------}</span><span>
</span><span id="line-555"></span><span>
</span><span id="line-556"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">initializeWallet :: WalletId
-&gt; Wallet s
-&gt; WalletMetadata
-&gt; [(Tx, TxMeta)]
-&gt; GenesisParameters
-&gt; ExceptT ErrWalletAlreadyExists (SqlPersistT IO) ()
</span><a href="Cardano.Wallet.DB.html#initializeWallet"><span class="hs-identifier hs-var">initializeWallet</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487824"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487824"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487823"><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487823"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span id="local-6989586621682487822"><span class="annot"><span class="annottext">WalletMetadata
</span><a href="#local-6989586621682487822"><span class="hs-identifier hs-var">meta</span></a></span></span><span> </span><span id="local-6989586621682487821"><span class="annot"><span class="annottext">[(Tx, TxMeta)]
</span><a href="#local-6989586621682487821"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span id="local-6989586621682487820"><span class="annot"><span class="annottext">GenesisParameters
</span><a href="#local-6989586621682487820"><span class="hs-identifier hs-var">gp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-557"></span><span>            </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrWalletAlreadyExists ())
-&gt; ExceptT ErrWalletAlreadyExists (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrWalletAlreadyExists ())
 -&gt; ExceptT ErrWalletAlreadyExists (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrWalletAlreadyExists ())
-&gt; ExceptT ErrWalletAlreadyExists (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-558"></span><span>                </span><span id="local-6989586621682487818"><span class="annot"><span class="annottext">Either ErrWalletAlreadyExists ()
</span><a href="#local-6989586621682487818"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ErrWalletAlreadyExists
-&gt; SqlPersistT IO ()
-&gt; ReaderT SqlBackend IO (Either ErrWalletAlreadyExists ())
forall (m :: * -&gt; *) e a.
MonadUnliftIO m =&gt;
e -&gt; m a -&gt; m (Either e a)
</span><a href="Cardano.DB.Sqlite.html#handleConstraint"><span class="hs-identifier hs-var">handleConstraint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; ErrWalletAlreadyExists
</span><a href="Cardano.Wallet.DB.html#ErrWalletAlreadyExists"><span class="hs-identifier hs-var">ErrWalletAlreadyExists</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487824"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SqlPersistT IO ()
 -&gt; ReaderT SqlBackend IO (Either ErrWalletAlreadyExists ()))
-&gt; SqlPersistT IO ()
-&gt; ReaderT SqlBackend IO (Either ErrWalletAlreadyExists ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-559"></span><span>                    </span><span class="annot"><span class="annottext">Wallet -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insert_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; WalletMetadata -&gt; GenesisParameters -&gt; Wallet
</span><a href="Cardano.Wallet.DB.Layer.html#mkWalletEntity"><span class="hs-identifier hs-var">mkWalletEntity</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487824"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
</span><a href="#local-6989586621682487822"><span class="hs-identifier hs-var">meta</span></a></span><span> </span><span class="annot"><span class="annottext">GenesisParameters
</span><a href="#local-6989586621682487820"><span class="hs-identifier hs-var">gp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; SqlPersistT IO () -&gt; SqlPersistT IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either ErrWalletAlreadyExists () -&gt; Bool
forall a b. Either a b -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">isRight</span></a></span><span> </span><span class="annot"><span class="annottext">Either ErrWalletAlreadyExists ()
</span><a href="#local-6989586621682487818"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SqlPersistT IO () -&gt; SqlPersistT IO ())
-&gt; SqlPersistT IO () -&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-561"></span><span>                    </span><span class="annot"><span class="annottext">WalletId -&gt; Wallet s -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682487859"><span class="hs-identifier hs-var">insertCheckpointGenesis</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487824"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487823"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-562"></span><span>                    </span><span class="annot"><span class="annottext">SqlPersistT IO (Either Any ()) -&gt; SqlPersistT IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(SqlPersistT IO (Either Any ()) -&gt; SqlPersistT IO ())
-&gt; SqlPersistT IO (Either Any ()) -&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, Either Any ()))
-&gt; SqlPersistT IO (Either Any ())
forall da (m :: * -&gt; *) a b.
(Delta da, Monad m, a ~ Base da) =&gt;
DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">modifyDBMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
</span><a href="#local-6989586621682487861"><span class="hs-identifier hs-var">transactionsDBVar</span></a></span><span> </span><span class="annot"><span class="annottext">(((TxHistory, Map WalletId TxMetaHistory)
  -&gt; (Maybe DeltaTxWalletsHistory, Either Any ()))
 -&gt; SqlPersistT IO (Either Any ()))
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, Either Any ()))
-&gt; SqlPersistT IO (Either Any ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621682487815"><span class="annot"><span class="annottext">TxHistory
</span><a href="#local-6989586621682487815"><span class="hs-identifier hs-var">_txsOld</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682487814"><span class="annot"><span class="annottext">Map WalletId TxMetaHistory
</span><a href="#local-6989586621682487814"><span class="hs-identifier hs-var">_ws</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-563"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487813"><span class="annot"><span class="annottext">delta :: Maybe DeltaTxWalletsHistory
</span><a href="#local-6989586621682487813"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory)
-&gt; DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; [(Tx, TxMeta)] -&gt; DeltaTxWalletsHistory
</span><a href="Cardano.Wallet.DB.Store.Wallets.Model.html#ExpandTxWalletsHistory"><span class="hs-identifier hs-var">ExpandTxWalletsHistory</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487824"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">[(Tx, TxMeta)]
</span><a href="#local-6989586621682487821"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-564"></span><span>                        </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DeltaTxWalletsHistory
</span><a href="#local-6989586621682487813"><span class="hs-identifier hs-var">delta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either Any ()
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-565"></span><span>                </span><span class="annot"><span class="annottext">Either ErrWalletAlreadyExists ()
-&gt; ReaderT SqlBackend IO (Either ErrWalletAlreadyExists ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Either ErrWalletAlreadyExists ()
</span><a href="#local-6989586621682487818"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-566"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">removeWallet :: WalletId -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
</span><a href="Cardano.Wallet.DB.html#removeWallet"><span class="hs-identifier hs-var">removeWallet</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487810"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487810"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-567"></span><span>            </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
 -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-568"></span><span>                </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe Wallet)
forall (m :: * -&gt; *).
MonadIO m =&gt;
WalletId -&gt; SqlPersistT m (Maybe Wallet)
</span><a href="Cardano.Wallet.DB.Layer.html#selectWallet"><span class="hs-identifier hs-var">selectWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487810"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Maybe Wallet)
-&gt; (Maybe Wallet
    -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-569"></span><span>                    </span><span class="annot"><span class="annottext">Maybe Wallet
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrNoSuchWallet ()
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ())
-&gt; ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ErrNoSuchWallet
</span><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier hs-var">ErrNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487810"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-570"></span><span>                    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either ErrNoSuchWallet ()
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(() -&gt; Either ErrNoSuchWallet ())
-&gt; SqlPersistT IO ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-571"></span><span>                        </span><span class="annot"><span class="annottext">[Filter Wallet] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField Wallet WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField Wallet typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#WalId"><span class="hs-identifier hs-var">WalId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Wallet WalletId -&gt; WalletId -&gt; Filter Wallet
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487810"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-572"></span><span>                        </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682487829"><span class="hs-identifier hs-var">deleteCheckpoints</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487810"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-573"></span><span>            </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
 -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall da (m :: * -&gt; *) a b.
(Delta da, Monad m, a ~ Base da) =&gt;
DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">modifyDBMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
</span><a href="#local-6989586621682487861"><span class="hs-identifier hs-var">transactionsDBVar</span></a></span><span> </span><span class="annot"><span class="annottext">(((TxHistory, Map WalletId TxMetaHistory)
  -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">(TxHistory, Map WalletId TxMetaHistory)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-574"></span><span>                        </span><span class="hs-keyword">let</span><span>
</span><span id="line-575"></span><span>                            </span><span id="local-6989586621682487806"><span class="annot"><span class="annottext">delta :: Maybe DeltaTxWalletsHistory
</span><a href="#local-6989586621682487806"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory)
-&gt; DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; DeltaTxWalletsHistory
</span><a href="Cardano.Wallet.DB.Store.Wallets.Model.html#RemoveWallet"><span class="hs-identifier hs-var">RemoveWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487810"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-576"></span><span>                        </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DeltaTxWalletsHistory
</span><a href="#local-6989586621682487806"><span class="hs-identifier hs-var">delta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either ErrNoSuchWallet ()
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-577"></span><span>            </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
 -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall da (m :: * -&gt; *) a b.
(Delta da, Monad m, a ~ Base da) =&gt;
DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">modifyDBMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
</span><a href="#local-6989586621682487861"><span class="hs-identifier hs-var">transactionsDBVar</span></a></span><span> </span><span class="annot"><span class="annottext">(((TxHistory, Map WalletId TxMetaHistory)
  -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">(TxHistory, Map WalletId TxMetaHistory)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-578"></span><span>                        </span><span class="hs-keyword">let</span><span>
</span><span id="line-579"></span><span>                            </span><span id="local-6989586621682487804"><span class="annot"><span class="annottext">delta :: Maybe DeltaTxWalletsHistory
</span><a href="#local-6989586621682487804"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaTxWalletsHistory
</span><a href="Cardano.Wallet.DB.Store.Wallets.Model.html#GarbageCollectTxWalletsHistory"><span class="hs-identifier hs-var">GarbageCollectTxWalletsHistory</span></a></span><span>
</span><span id="line-580"></span><span>                        </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DeltaTxWalletsHistory
</span><a href="#local-6989586621682487804"><span class="hs-identifier hs-var">delta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either ErrNoSuchWallet ()
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-581"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">listWallets :: ReaderT SqlBackend IO [WalletId]
</span><a href="Cardano.Wallet.DB.html#listWallets"><span class="hs-identifier hs-var">listWallets</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Key Wallet -&gt; WalletId) -&gt; [Key Wallet] -&gt; [WalletId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Key Wallet -&gt; WalletId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#unWalletKey"><span class="hs-identifier hs-var hs-var">unWalletKey</span></a></span><span> </span><span class="annot"><span class="annottext">([Key Wallet] -&gt; [WalletId])
-&gt; ReaderT SqlBackend IO [Key Wallet]
-&gt; ReaderT SqlBackend IO [WalletId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter Wallet]
-&gt; [SelectOpt Wallet] -&gt; ReaderT SqlBackend IO [Key Wallet]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Key record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectKeysList</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField Wallet WalletId -&gt; SelectOpt Wallet
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Asc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Wallet WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField Wallet typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#WalId"><span class="hs-identifier hs-var">WalId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-582"></span><span>
</span><span id="line-583"></span><span>        </span><span class="hs-comment">{-----------------------------------------------------------------------
                                    Checkpoints
        -----------------------------------------------------------------------}</span><span>
</span><span id="line-586"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">walletsDB :: DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
</span><a href="Cardano.Wallet.DB.html#walletsDB"><span class="hs-identifier hs-var">walletsDB</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
</span><a href="#local-6989586621682487862"><span class="hs-identifier hs-var">walletsDB_</span></a></span><span>
</span><span id="line-587"></span><span>
</span><span id="line-588"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">putCheckpoint :: WalletId -&gt; Wallet s -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
</span><a href="Cardano.Wallet.DB.html#putCheckpoint"><span class="hs-identifier hs-var">putCheckpoint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487798"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487798"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487797"><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487797"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
 -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-589"></span><span>            </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
-&gt; (Map WalletId (WalletState s)
    -&gt; (Maybe (DeltaMap WalletId (DeltaWalletState s)),
        Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall da (m :: * -&gt; *) a b.
(Delta da, Monad m, a ~ Base da) =&gt;
DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">modifyDBMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
</span><a href="#local-6989586621682487862"><span class="hs-identifier hs-var">walletsDB_</span></a></span><span> </span><span class="annot"><span class="annottext">((Map WalletId (WalletState s)
  -&gt; (Maybe (DeltaMap WalletId (DeltaWalletState s)),
      Either ErrNoSuchWallet ()))
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; (Map WalletId (WalletState s)
    -&gt; (Maybe (DeltaMap WalletId (DeltaWalletState s)),
        Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487796"><span class="annot"><span class="annottext">Map WalletId (WalletState s)
</span><a href="#local-6989586621682487796"><span class="hs-identifier hs-var">ws</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-590"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; Map WalletId (WalletState s) -&gt; Maybe (WalletState s)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487798"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Map WalletId (WalletState s)
</span><a href="#local-6989586621682487796"><span class="hs-identifier hs-var">ws</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-591"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (WalletState s)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (DeltaMap WalletId (DeltaWalletState s))
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ())
-&gt; ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ErrNoSuchWallet
</span><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier hs-var">ErrNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487798"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-592"></span><span>                    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">WalletState s
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-593"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682487795"><span class="annot"><span class="annottext">Prologue s
</span><a href="#local-6989586621682487795"><span class="hs-identifier hs-var">prologue</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682487794"><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682487794"><span class="hs-identifier hs-var">wcp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Wallet s -&gt; (Prologue s, WalletCheckpoint s)
forall s.
AddressBookIso s =&gt;
Wallet s -&gt; (Prologue s, WalletCheckpoint s)
</span><a href="Cardano.Wallet.DB.WalletState.html#fromWallet"><span class="hs-identifier hs-var">fromWallet</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487797"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-594"></span><span>                            </span><span id="local-6989586621682487793"><span class="annot"><span class="annottext">slot :: Slot
</span><a href="#local-6989586621682487793"><span class="hs-identifier hs-var hs-var">slot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletCheckpoint s -&gt; Slot
forall s. WalletCheckpoint s -&gt; Slot
</span><a href="Cardano.Wallet.DB.WalletState.html#getSlot"><span class="hs-identifier hs-var">getSlot</span></a></span><span> </span><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682487794"><span class="hs-identifier hs-var">wcp</span></a></span><span>
</span><span id="line-595"></span><span>                            </span><span id="local-6989586621682487792"><span class="annot"><span class="annottext">delta :: Maybe (DeltaMap WalletId (DeltaWalletState s))
</span><a href="#local-6989586621682487792"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DeltaMap WalletId (DeltaWalletState s)
-&gt; Maybe (DeltaMap WalletId (DeltaWalletState s))
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(DeltaMap WalletId (DeltaWalletState s)
 -&gt; Maybe (DeltaMap WalletId (DeltaWalletState s)))
-&gt; DeltaMap WalletId (DeltaWalletState s)
-&gt; Maybe (DeltaMap WalletId (DeltaWalletState s))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; DeltaWalletState s -&gt; DeltaMap WalletId (DeltaWalletState s)
forall key da. key -&gt; da -&gt; DeltaMap key da
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">Adjust</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487798"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-596"></span><span>                                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">DeltasCheckpoints (WalletCheckpoint s) -&gt; DeltaWalletState1 s
forall s.
DeltasCheckpoints (WalletCheckpoint s) -&gt; DeltaWalletState1 s
</span><a href="Cardano.Wallet.DB.WalletState.html#UpdateCheckpoints"><span class="hs-identifier hs-var">UpdateCheckpoints</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Slot -&gt; WalletCheckpoint s -&gt; DeltaCheckpoints (WalletCheckpoint s)
forall a. Slot -&gt; a -&gt; DeltaCheckpoints a
</span><a href="Cardano.Wallet.Checkpoints.html#PutCheckpoint"><span class="hs-identifier hs-var">PutCheckpoint</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682487793"><span class="hs-identifier hs-var">slot</span></a></span><span> </span><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682487794"><span class="hs-identifier hs-var">wcp</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-597"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Prologue s -&gt; DeltaWalletState1 s
forall s. Prologue s -&gt; DeltaWalletState1 s
</span><a href="Cardano.Wallet.DB.WalletState.html#ReplacePrologue"><span class="hs-identifier hs-var">ReplacePrologue</span></a></span><span> </span><span class="annot"><span class="annottext">Prologue s
</span><a href="#local-6989586621682487795"><span class="hs-identifier hs-var">prologue</span></a></span><span>
</span><span id="line-598"></span><span>                                </span><span class="hs-special">]</span><span>
</span><span id="line-599"></span><span>                        </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (DeltaMap WalletId (DeltaWalletState s))
</span><a href="#local-6989586621682487792"><span class="hs-identifier hs-var">delta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either ErrNoSuchWallet ()
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-600"></span><span>
</span><span id="line-601"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">readCheckpoint :: WalletId -&gt; SqlPersistT IO (Maybe (Wallet s))
</span><a href="Cardano.Wallet.DB.html#readCheckpoint"><span class="hs-identifier hs-var">readCheckpoint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe (Wallet s))
</span><a href="#local-6989586621682487851"><span class="hs-identifier hs-var">readCheckpoint_</span></a></span><span>
</span><span id="line-602"></span><span>
</span><span id="line-603"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">listCheckpoints :: WalletId -&gt; ReaderT SqlBackend IO [ChainPoint]
</span><a href="Cardano.Wallet.DB.html#listCheckpoints"><span class="hs-identifier hs-var">listCheckpoints</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487787"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487787"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-604"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487786"><span class="annot"><span class="annottext">toChainPoint :: BlockHeader -&gt; ChainPoint
</span><a href="#local-6989586621682487786"><span class="hs-identifier hs-var hs-var">toChainPoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; ChainPoint
</span><a href="Cardano.Wallet.Primitive.Types.html#chainPointFromBlockHeader"><span class="hs-identifier hs-var">W.chainPointFromBlockHeader</span></a></span><span>
</span><span id="line-605"></span><span>            </span><span class="annot"><span class="annottext">(Entity Checkpoint -&gt; ChainPoint)
-&gt; [Entity Checkpoint] -&gt; [ChainPoint]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; ChainPoint
</span><a href="#local-6989586621682487786"><span class="hs-identifier hs-var">toChainPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; ChainPoint)
-&gt; (Entity Checkpoint -&gt; BlockHeader)
-&gt; Entity Checkpoint
-&gt; ChainPoint
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Checkpoint -&gt; BlockHeader
</span><a href="Cardano.Wallet.DB.Store.Checkpoints.html#blockHeaderFromEntity"><span class="hs-identifier hs-var">blockHeaderFromEntity</span></a></span><span> </span><span class="annot"><span class="annottext">(Checkpoint -&gt; BlockHeader)
-&gt; (Entity Checkpoint -&gt; Checkpoint)
-&gt; Entity Checkpoint
-&gt; BlockHeader
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity Checkpoint -&gt; Checkpoint
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Entity Checkpoint] -&gt; [ChainPoint])
-&gt; ReaderT SqlBackend IO [Entity Checkpoint]
-&gt; ReaderT SqlBackend IO [ChainPoint]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter Checkpoint]
-&gt; [SelectOpt Checkpoint]
-&gt; ReaderT SqlBackend IO [Entity Checkpoint]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-606"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointWalletId"><span class="hs-identifier hs-var">CheckpointWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint WalletId -&gt; WalletId -&gt; Filter Checkpoint
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487787"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-607"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint SlotNo -&gt; SelectOpt Checkpoint
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Asc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Checkpoint SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField Checkpoint typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CheckpointSlot"><span class="hs-identifier hs-var">CheckpointSlot</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-608"></span><span>
</span><span id="line-609"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rollbackTo :: WalletId
-&gt; Slot -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ChainPoint
</span><a href="Cardano.Wallet.DB.html#rollbackTo"><span class="hs-identifier hs-var">rollbackTo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487780"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487780"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487779"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682487779"><span class="hs-identifier hs-var">requestedPoint</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-610"></span><span>            </span><span id="local-6989586621682487778"><span class="annot"><span class="annottext">Maybe (WalletCheckpoint s)
</span><a href="#local-6989586621682487778"><span class="hs-identifier hs-var">mNearestCheckpoint</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>  </span><span class="annot"><span class="annottext">SqlPersistT
  IO (Either ErrNoSuchWallet (Maybe (WalletCheckpoint s)))
-&gt; ExceptT
     ErrNoSuchWallet (SqlPersistT IO) (Maybe (WalletCheckpoint s))
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(SqlPersistT
   IO (Either ErrNoSuchWallet (Maybe (WalletCheckpoint s)))
 -&gt; ExceptT
      ErrNoSuchWallet (SqlPersistT IO) (Maybe (WalletCheckpoint s)))
-&gt; SqlPersistT
     IO (Either ErrNoSuchWallet (Maybe (WalletCheckpoint s)))
-&gt; ExceptT
     ErrNoSuchWallet (SqlPersistT IO) (Maybe (WalletCheckpoint s))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-611"></span><span>                </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
-&gt; (Map WalletId (WalletState s)
    -&gt; (Maybe (DeltaMap WalletId (DeltaWalletState s)),
        Either ErrNoSuchWallet (Maybe (WalletCheckpoint s))))
-&gt; SqlPersistT
     IO (Either ErrNoSuchWallet (Maybe (WalletCheckpoint s)))
forall da (m :: * -&gt; *) a b.
(Delta da, Monad m, a ~ Base da) =&gt;
DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">modifyDBMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) (DeltaMap WalletId (DeltaWalletState s))
</span><a href="#local-6989586621682487862"><span class="hs-identifier hs-var">walletsDB_</span></a></span><span> </span><span class="annot"><span class="annottext">((Map WalletId (WalletState s)
  -&gt; (Maybe (DeltaMap WalletId (DeltaWalletState s)),
      Either ErrNoSuchWallet (Maybe (WalletCheckpoint s))))
 -&gt; SqlPersistT
      IO (Either ErrNoSuchWallet (Maybe (WalletCheckpoint s))))
-&gt; (Map WalletId (WalletState s)
    -&gt; (Maybe (DeltaMap WalletId (DeltaWalletState s)),
        Either ErrNoSuchWallet (Maybe (WalletCheckpoint s))))
-&gt; SqlPersistT
     IO (Either ErrNoSuchWallet (Maybe (WalletCheckpoint s)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487777"><span class="annot"><span class="annottext">Map WalletId (WalletState s)
</span><a href="#local-6989586621682487777"><span class="hs-identifier hs-var">ws</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-612"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; Map WalletId (WalletState s) -&gt; Maybe (WalletState s)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487780"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Map WalletId (WalletState s)
</span><a href="#local-6989586621682487777"><span class="hs-identifier hs-var">ws</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-613"></span><span>                        </span><span class="annot"><span class="annottext">Maybe (WalletState s)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (DeltaMap WalletId (DeltaWalletState s))
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (WalletCheckpoint s)
-&gt; Either ErrNoSuchWallet (Maybe (WalletCheckpoint s))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (WalletCheckpoint s)
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-614"></span><span>                        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682487776"><span class="annot"><span class="annottext">WalletState s
</span><a href="#local-6989586621682487776"><span class="hs-identifier hs-var">wal</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WalletState s -&gt; Slot -&gt; Maybe Slot
forall s. WalletState s -&gt; Slot -&gt; Maybe Slot
</span><a href="Cardano.Wallet.DB.WalletState.html#findNearestPoint"><span class="hs-identifier hs-var">findNearestPoint</span></a></span><span> </span><span class="annot"><span class="annottext">WalletState s
</span><a href="#local-6989586621682487776"><span class="hs-identifier hs-var">wal</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682487779"><span class="hs-identifier hs-var">requestedPoint</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-615"></span><span>                            </span><span class="annot"><span class="annottext">Maybe Slot
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-616"></span><span>                                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe (DeltaMap WalletId (DeltaWalletState s))
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-617"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ErrRollbackTo
-&gt; Either ErrNoSuchWallet (Maybe (WalletCheckpoint s))
forall a e. Exception e =&gt; e -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">throw</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrRollbackTo
 -&gt; Either ErrNoSuchWallet (Maybe (WalletCheckpoint s)))
-&gt; ErrRollbackTo
-&gt; Either ErrNoSuchWallet (Maybe (WalletCheckpoint s))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; Slot -&gt; ErrRollbackTo
</span><a href="Cardano.Wallet.DB.Layer.html#ErrNoOlderCheckpoint"><span class="hs-identifier hs-var">ErrNoOlderCheckpoint</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487780"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682487779"><span class="hs-identifier hs-var">requestedPoint</span></a></span><span>
</span><span id="line-618"></span><span>                                </span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>                            </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682487774"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682487774"><span class="hs-identifier hs-var">nearestPoint</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-620"></span><span>                                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DeltaMap WalletId (DeltaWalletState s)
-&gt; Maybe (DeltaMap WalletId (DeltaWalletState s))
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(DeltaMap WalletId (DeltaWalletState s)
 -&gt; Maybe (DeltaMap WalletId (DeltaWalletState s)))
-&gt; DeltaMap WalletId (DeltaWalletState s)
-&gt; Maybe (DeltaMap WalletId (DeltaWalletState s))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; DeltaWalletState s -&gt; DeltaMap WalletId (DeltaWalletState s)
forall key da. key -&gt; da -&gt; DeltaMap key da
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">Adjust</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487780"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-621"></span><span>                                    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">DeltasCheckpoints (WalletCheckpoint s) -&gt; DeltaWalletState1 s
forall s.
DeltasCheckpoints (WalletCheckpoint s) -&gt; DeltaWalletState1 s
</span><a href="Cardano.Wallet.DB.WalletState.html#UpdateCheckpoints"><span class="hs-identifier hs-var">UpdateCheckpoints</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Slot -&gt; DeltaCheckpoints (WalletCheckpoint s)
forall a. Slot -&gt; DeltaCheckpoints a
</span><a href="Cardano.Wallet.Checkpoints.html#RollbackTo"><span class="hs-identifier hs-var">RollbackTo</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682487774"><span class="hs-identifier hs-var">nearestPoint</span></a></span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-622"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (WalletCheckpoint s)
-&gt; Either ErrNoSuchWallet (Maybe (WalletCheckpoint s))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (WalletCheckpoint s)
 -&gt; Either ErrNoSuchWallet (Maybe (WalletCheckpoint s)))
-&gt; Maybe (WalletCheckpoint s)
-&gt; Either ErrNoSuchWallet (Maybe (WalletCheckpoint s))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Map Slot (WalletCheckpoint s) -&gt; Maybe (WalletCheckpoint s)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621682487774"><span class="hs-identifier hs-var">nearestPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Slot (WalletCheckpoint s) -&gt; Maybe (WalletCheckpoint s))
-&gt; Map Slot (WalletCheckpoint s) -&gt; Maybe (WalletCheckpoint s)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-623"></span><span>                                    </span><span class="annot"><span class="annottext">WalletState s
</span><a href="#local-6989586621682487776"><span class="hs-identifier hs-var">wal</span></a></span><span> </span><span class="annot"><span class="annottext">WalletState s
-&gt; ((Map Slot (WalletCheckpoint s)
     -&gt; Const
          (Map Slot (WalletCheckpoint s)) (Map Slot (WalletCheckpoint s)))
    -&gt; WalletState s
    -&gt; Const (Map Slot (WalletCheckpoint s)) (WalletState s))
-&gt; Map Slot (WalletCheckpoint s)
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;checkpoints&quot;
  ((Checkpoints (WalletCheckpoint s)
    -&gt; Const
         (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s)))
   -&gt; WalletState s
   -&gt; Const (Map Slot (WalletCheckpoint s)) (WalletState s))
(Checkpoints (WalletCheckpoint s)
 -&gt; Const
      (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s)))
-&gt; WalletState s
-&gt; Const (Map Slot (WalletCheckpoint s)) (WalletState s)
</span><a href="#local-6989586621682487772"><span class="hs-var">#checkpoints</span></a></span><span> </span><span class="annot"><span class="annottext">((Checkpoints (WalletCheckpoint s)
  -&gt; Const
       (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s)))
 -&gt; WalletState s
 -&gt; Const (Map Slot (WalletCheckpoint s)) (WalletState s))
-&gt; ((Map Slot (WalletCheckpoint s)
     -&gt; Const
          (Map Slot (WalletCheckpoint s)) (Map Slot (WalletCheckpoint s)))
    -&gt; Checkpoints (WalletCheckpoint s)
    -&gt; Const
         (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s)))
-&gt; (Map Slot (WalletCheckpoint s)
    -&gt; Const
         (Map Slot (WalletCheckpoint s)) (Map Slot (WalletCheckpoint s)))
-&gt; WalletState s
-&gt; Const (Map Slot (WalletCheckpoint s)) (WalletState s)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;checkpoints&quot;
  ((Map Slot (WalletCheckpoint s)
    -&gt; Const
         (Map Slot (WalletCheckpoint s)) (Map Slot (WalletCheckpoint s)))
   -&gt; Checkpoints (WalletCheckpoint s)
   -&gt; Const
        (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s)))
(Map Slot (WalletCheckpoint s)
 -&gt; Const
      (Map Slot (WalletCheckpoint s)) (Map Slot (WalletCheckpoint s)))
-&gt; Checkpoints (WalletCheckpoint s)
-&gt; Const
     (Map Slot (WalletCheckpoint s)) (Checkpoints (WalletCheckpoint s))
</span><a href="#local-6989586621682487771"><span class="hs-var">#checkpoints</span></a></span><span>
</span><span id="line-624"></span><span>                                </span><span class="hs-special">)</span><span>
</span><span id="line-625"></span><span>
</span><span id="line-626"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (WalletCheckpoint s)
</span><a href="#local-6989586621682487778"><span class="hs-identifier hs-var">mNearestCheckpoint</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-627"></span><span>                </span><span class="annot"><span class="annottext">Maybe (WalletCheckpoint s)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrNoSuchWallet ChainPoint)
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ChainPoint
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrNoSuchWallet ChainPoint)
 -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ChainPoint)
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ChainPoint)
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ChainPoint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Either ErrNoSuchWallet ChainPoint
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ChainPoint)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrNoSuchWallet ChainPoint
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ChainPoint))
-&gt; Either ErrNoSuchWallet ChainPoint
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ChainPoint)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ChainPoint
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ChainPoint)
-&gt; ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ChainPoint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ErrNoSuchWallet
</span><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier hs-var">ErrNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487780"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-628"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682487770"><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682487770"><span class="hs-identifier hs-var">wcp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-629"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487769"><span class="annot"><span class="annottext">nearestPoint :: SlotNo
</span><a href="#local-6989586621682487769"><span class="hs-identifier hs-var hs-var">nearestPoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682487770"><span class="hs-identifier hs-var">wcp</span></a></span><span> </span><span class="annot"><span class="annottext">WalletCheckpoint s
-&gt; ((SlotNo -&gt; Const SlotNo SlotNo)
    -&gt; WalletCheckpoint s -&gt; Const SlotNo (WalletCheckpoint s))
-&gt; SlotNo
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;currentTip&quot;
  ((BlockHeader -&gt; Const SlotNo BlockHeader)
   -&gt; WalletCheckpoint s -&gt; Const SlotNo (WalletCheckpoint s))
(BlockHeader -&gt; Const SlotNo BlockHeader)
-&gt; WalletCheckpoint s -&gt; Const SlotNo (WalletCheckpoint s)
</span><a href="#local-6989586621682487768"><span class="hs-var">#currentTip</span></a></span><span> </span><span class="annot"><span class="annottext">((BlockHeader -&gt; Const SlotNo BlockHeader)
 -&gt; WalletCheckpoint s -&gt; Const SlotNo (WalletCheckpoint s))
-&gt; ((SlotNo -&gt; Const SlotNo SlotNo)
    -&gt; BlockHeader -&gt; Const SlotNo BlockHeader)
-&gt; (SlotNo -&gt; Const SlotNo SlotNo)
-&gt; WalletCheckpoint s
-&gt; Const SlotNo (WalletCheckpoint s)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;slotNo&quot;
  ((SlotNo -&gt; Const SlotNo SlotNo)
   -&gt; BlockHeader -&gt; Const SlotNo BlockHeader)
(SlotNo -&gt; Const SlotNo SlotNo)
-&gt; BlockHeader -&gt; Const SlotNo BlockHeader
</span><a href="#local-6989586621682487767"><span class="hs-var">#slotNo</span></a></span><span>
</span><span id="line-630"></span><span>                    </span><span class="annot"><span class="annottext">SqlPersistT IO () -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(SqlPersistT IO () -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; SqlPersistT IO () -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; [Filter DelegationCertificate] -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Layer.html#deleteDelegationCertificates"><span class="hs-identifier hs-var">deleteDelegationCertificates</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487780"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-631"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField DelegationCertificate SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField DelegationCertificate typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CertSlot"><span class="hs-identifier hs-var">CertSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField DelegationCertificate SlotNo
-&gt; SlotNo -&gt; Filter DelegationCertificate
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">&gt;.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487769"><span class="hs-identifier hs-var">nearestPoint</span></a></span><span>
</span><span id="line-632"></span><span>                        </span><span class="hs-special">]</span><span>
</span><span id="line-633"></span><span>                    </span><span class="annot"><span class="annottext">SqlPersistT IO () -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(SqlPersistT IO () -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; SqlPersistT IO () -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; [Filter StakeKeyCertificate] -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Layer.html#deleteStakeKeyCerts"><span class="hs-identifier hs-var">deleteStakeKeyCerts</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487780"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-634"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField StakeKeyCertificate SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField StakeKeyCertificate typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#StakeKeyCertSlot"><span class="hs-identifier hs-var">StakeKeyCertSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField StakeKeyCertificate SlotNo
-&gt; SlotNo -&gt; Filter StakeKeyCertificate
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">&gt;.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487769"><span class="hs-identifier hs-var">nearestPoint</span></a></span><span>
</span><span id="line-635"></span><span>                        </span><span class="hs-special">]</span><span>
</span><span id="line-636"></span><span>                    </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
 -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall da (m :: * -&gt; *) a b.
(Delta da, Monad m, a ~ Base da) =&gt;
DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">modifyDBMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
</span><a href="#local-6989586621682487861"><span class="hs-identifier hs-var">transactionsDBVar</span></a></span><span> </span><span class="annot"><span class="annottext">(((TxHistory, Map WalletId TxMetaHistory)
  -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">(TxHistory, Map WalletId TxMetaHistory)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-637"></span><span>                        </span><span class="hs-keyword">let</span><span>
</span><span id="line-638"></span><span>                            </span><span id="local-6989586621682487762"><span class="annot"><span class="annottext">delta :: Maybe DeltaTxWalletsHistory
</span><a href="#local-6989586621682487762"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span>
</span><span id="line-639"></span><span>                                </span><span class="annot"><span class="annottext">(DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory)
-&gt; DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ManipulateTxMetaHistory -&gt; DeltaTxWalletsHistory
</span><a href="Cardano.Wallet.DB.Store.Wallets.Model.html#ChangeTxMetaWalletsHistory"><span class="hs-identifier hs-var">ChangeTxMetaWalletsHistory</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487780"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-640"></span><span>                                </span><span class="annot"><span class="annottext">(ManipulateTxMetaHistory -&gt; DeltaTxWalletsHistory)
-&gt; ManipulateTxMetaHistory -&gt; DeltaTxWalletsHistory
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; ManipulateTxMetaHistory
</span><a href="Cardano.Wallet.DB.Store.Meta.Model.html#RollBackTxMetaHistory"><span class="hs-identifier hs-var">RollBackTxMetaHistory</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487769"><span class="hs-identifier hs-var">nearestPoint</span></a></span><span>
</span><span id="line-641"></span><span>                        </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DeltaTxWalletsHistory
</span><a href="#local-6989586621682487762"><span class="hs-identifier hs-var">delta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either ErrNoSuchWallet ()
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-642"></span><span>                    </span><span class="annot"><span class="annottext">ChainPoint -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ChainPoint
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span>
</span><span id="line-643"></span><span>                        </span><span class="annot"><span class="annottext">(ChainPoint -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ChainPoint)
-&gt; ChainPoint
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ChainPoint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; ChainPoint
</span><a href="Cardano.Wallet.Primitive.Types.html#chainPointFromBlockHeader"><span class="hs-identifier hs-var">W.chainPointFromBlockHeader</span></a></span><span>
</span><span id="line-644"></span><span>                        </span><span class="annot"><span class="annottext">(BlockHeader -&gt; ChainPoint) -&gt; BlockHeader -&gt; ChainPoint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((BlockHeader -&gt; Const BlockHeader BlockHeader)
 -&gt; WalletCheckpoint s -&gt; Const BlockHeader (WalletCheckpoint s))
-&gt; WalletCheckpoint s -&gt; BlockHeader
forall a s. ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; s -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;currentTip&quot;
  ((BlockHeader -&gt; Const BlockHeader BlockHeader)
   -&gt; WalletCheckpoint s -&gt; Const BlockHeader (WalletCheckpoint s))
(BlockHeader -&gt; Const BlockHeader BlockHeader)
-&gt; WalletCheckpoint s -&gt; Const BlockHeader (WalletCheckpoint s)
</span><a href="#local-6989586621682487759"><span class="hs-var">#currentTip</span></a></span><span> </span><span class="annot"><span class="annottext">WalletCheckpoint s
</span><a href="#local-6989586621682487770"><span class="hs-identifier hs-var">wcp</span></a></span><span>
</span><span id="line-645"></span><span>
</span><span id="line-646"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">prune :: WalletId
-&gt; Quantity &quot;block&quot; Word32
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
</span><a href="Cardano.Wallet.DB.html#prune"><span class="hs-identifier hs-var">prune</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487757"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487757"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487756"><span class="annot"><span class="annottext">Quantity &quot;block&quot; Word32
</span><a href="#local-6989586621682487756"><span class="hs-identifier hs-var">epochStability</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-647"></span><span>            </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
 -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-648"></span><span>                </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe (Wallet s))
</span><a href="#local-6989586621682487851"><span class="hs-identifier hs-var">readCheckpoint_</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487757"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Maybe (Wallet s))
-&gt; (Maybe (Wallet s)
    -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-649"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (Wallet s)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrNoSuchWallet ()
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ())
-&gt; ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ErrNoSuchWallet
</span><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier hs-var">ErrNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487757"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-650"></span><span>                    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682487755"><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487755"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either ErrNoSuchWallet ()
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(() -&gt; Either ErrNoSuchWallet ())
-&gt; SqlPersistT IO ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-651"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487754"><span class="annot"><span class="annottext">tip :: BlockHeader
</span><a href="#local-6989586621682487754"><span class="hs-identifier hs-var hs-var">tip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487755"><span class="hs-identifier hs-var">cp</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet s
-&gt; ((BlockHeader -&gt; Const BlockHeader BlockHeader)
    -&gt; Wallet s -&gt; Const BlockHeader (Wallet s))
-&gt; BlockHeader
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;currentTip&quot;
  ((BlockHeader -&gt; Const BlockHeader BlockHeader)
   -&gt; Wallet s -&gt; Const BlockHeader (Wallet s))
(BlockHeader -&gt; Const BlockHeader BlockHeader)
-&gt; Wallet s -&gt; Const BlockHeader (Wallet s)
</span><a href="#local-6989586621682487753"><span class="hs-var">#currentTip</span></a></span><span>
</span><span id="line-652"></span><span>                        </span><span class="annot"><span class="annottext">WalletId
-&gt; Quantity &quot;block&quot; Word32 -&gt; BlockHeader -&gt; SqlPersistT IO ()
</span><a href="#local-6989586621682487849"><span class="hs-identifier hs-var">pruneCheckpoints</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487757"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Quantity &quot;block&quot; Word32
</span><a href="#local-6989586621682487756"><span class="hs-identifier hs-var">epochStability</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682487754"><span class="hs-identifier hs-var">tip</span></a></span><span>
</span><span id="line-653"></span><span>                        </span><span class="annot"><span class="annottext">WalletId
-&gt; Quantity &quot;block&quot; Word32 -&gt; BlockHeader -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Layer.html#pruneLocalTxSubmission"><span class="hs-identifier hs-var">pruneLocalTxSubmission</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487757"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Quantity &quot;block&quot; Word32
</span><a href="#local-6989586621682487756"><span class="hs-identifier hs-var">epochStability</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682487754"><span class="hs-identifier hs-var">tip</span></a></span><span>
</span><span id="line-654"></span><span>            </span><span class="annot"><span class="annottext">SqlPersistT IO () -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(SqlPersistT IO () -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; SqlPersistT IO () -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, ()))
-&gt; SqlPersistT IO ()
forall da (m :: * -&gt; *) a b.
(Delta da, Monad m, a ~ Base da) =&gt;
DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">modifyDBMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
</span><a href="#local-6989586621682487861"><span class="hs-identifier hs-var">transactionsDBVar</span></a></span><span> </span><span class="annot"><span class="annottext">(((TxHistory, Map WalletId TxMetaHistory)
  -&gt; (Maybe DeltaTxWalletsHistory, ()))
 -&gt; SqlPersistT IO ())
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, ()))
-&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">(TxHistory, Map WalletId TxMetaHistory)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-655"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaTxWalletsHistory
</span><a href="Cardano.Wallet.DB.Store.Wallets.Model.html#GarbageCollectTxWalletsHistory"><span class="hs-identifier hs-var">GarbageCollectTxWalletsHistory</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-656"></span><span>
</span><span id="line-657"></span><span>        </span><span class="hs-comment">{-----------------------------------------------------------------------
                                   Wallet Metadata
        -----------------------------------------------------------------------}</span><span>
</span><span id="line-660"></span><span>
</span><span id="line-661"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">putWalletMeta :: WalletId
-&gt; WalletMetadata -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
</span><a href="Cardano.Wallet.DB.html#putWalletMeta"><span class="hs-identifier hs-var">putWalletMeta</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487750"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487750"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487749"><span class="annot"><span class="annottext">WalletMetadata
</span><a href="#local-6989586621682487749"><span class="hs-identifier hs-var">meta</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
 -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-662"></span><span>            </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe Wallet)
forall (m :: * -&gt; *).
MonadIO m =&gt;
WalletId -&gt; SqlPersistT m (Maybe Wallet)
</span><a href="Cardano.Wallet.DB.Layer.html#selectWallet"><span class="hs-identifier hs-var">selectWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487750"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Maybe Wallet)
-&gt; (Maybe Wallet
    -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-663"></span><span>                </span><span class="annot"><span class="annottext">Maybe Wallet
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrNoSuchWallet ()
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ())
-&gt; ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ErrNoSuchWallet
</span><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier hs-var">ErrNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487750"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-664"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-665"></span><span>                    </span><span class="annot"><span class="annottext">[Filter Wallet] -&gt; [Update Wallet] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; [Update record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">updateWhere</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField Wallet WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField Wallet typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#WalId"><span class="hs-identifier hs-var">WalId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Wallet WalletId -&gt; WalletId -&gt; Filter Wallet
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487750"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-666"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletMetadata -&gt; [Update Wallet]
</span><a href="Cardano.Wallet.DB.Layer.html#mkWalletMetadataUpdate"><span class="hs-identifier hs-var">mkWalletMetadataUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
</span><a href="#local-6989586621682487749"><span class="hs-identifier hs-var">meta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-667"></span><span>                    </span><span class="annot"><span class="annottext">Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrNoSuchWallet ()
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; Either ErrNoSuchWallet ()
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-668"></span><span>
</span><span id="line-669"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">readWalletMeta :: WalletId -&gt; ReaderT SqlBackend IO (Maybe WalletMetadata)
</span><a href="Cardano.Wallet.DB.html#readWalletMeta"><span class="hs-identifier hs-var">readWalletMeta</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487746"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487746"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-670"></span><span>            </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe (Wallet s))
</span><a href="#local-6989586621682487851"><span class="hs-identifier hs-var">readCheckpoint_</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487746"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Maybe (Wallet s))
-&gt; (Maybe (Wallet s)
    -&gt; ReaderT SqlBackend IO (Maybe WalletMetadata))
-&gt; ReaderT SqlBackend IO (Maybe WalletMetadata)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-671"></span><span>                </span><span class="annot"><span class="annottext">Maybe (Wallet s)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe WalletMetadata
-&gt; ReaderT SqlBackend IO (Maybe WalletMetadata)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe WalletMetadata
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-672"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682487745"><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487745"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-673"></span><span>                    </span><span id="local-6989586621682487744"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682487744"><span class="hs-identifier hs-var">currentEpoch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO EpochNo -&gt; ReaderT SqlBackend IO EpochNo
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO EpochNo -&gt; ReaderT SqlBackend IO EpochNo)
-&gt; IO EpochNo -&gt; ReaderT SqlBackend IO EpochNo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-674"></span><span>                        </span><span class="annot"><span class="annottext">TimeInterpreter IO -&gt; Qry EpochNo -&gt; IO EpochNo
forall (m :: * -&gt; *) a.
(HasCallStack, Monad m) =&gt;
TimeInterpreter m -&gt; Qry a -&gt; m a
</span><a href="Cardano.Wallet.Primitive.Slotting.html#interpretQuery"><span class="hs-identifier hs-var">interpretQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682487866"><span class="hs-identifier hs-var">ti</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Qry EpochNo
</span><a href="Cardano.Wallet.Primitive.Slotting.html#epochOf"><span class="hs-identifier hs-var">epochOf</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; Qry EpochNo) -&gt; SlotNo -&gt; Qry EpochNo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487745"><span class="hs-identifier hs-var">cp</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet s
-&gt; ((SlotNo -&gt; Const SlotNo SlotNo)
    -&gt; Wallet s -&gt; Const SlotNo (Wallet s))
-&gt; SlotNo
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;currentTip&quot;
  ((BlockHeader -&gt; Const SlotNo BlockHeader)
   -&gt; Wallet s -&gt; Const SlotNo (Wallet s))
(BlockHeader -&gt; Const SlotNo BlockHeader)
-&gt; Wallet s -&gt; Const SlotNo (Wallet s)
</span><a href="#local-6989586621682487742"><span class="hs-var">#currentTip</span></a></span><span> </span><span class="annot"><span class="annottext">((BlockHeader -&gt; Const SlotNo BlockHeader)
 -&gt; Wallet s -&gt; Const SlotNo (Wallet s))
-&gt; ((SlotNo -&gt; Const SlotNo SlotNo)
    -&gt; BlockHeader -&gt; Const SlotNo BlockHeader)
-&gt; (SlotNo -&gt; Const SlotNo SlotNo)
-&gt; Wallet s
-&gt; Const SlotNo (Wallet s)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;slotNo&quot;
  ((SlotNo -&gt; Const SlotNo SlotNo)
   -&gt; BlockHeader -&gt; Const SlotNo BlockHeader)
(SlotNo -&gt; Const SlotNo SlotNo)
-&gt; BlockHeader -&gt; Const SlotNo BlockHeader
</span><a href="#local-6989586621682487741"><span class="hs-var">#slotNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-675"></span><span>                    </span><span class="annot"><span class="annottext">TimeInterpreter IO
-&gt; WalletId -&gt; EpochNo -&gt; SqlPersistT IO WalletDelegation
</span><a href="Cardano.Wallet.DB.Layer.html#readWalletDelegation"><span class="hs-identifier hs-var">readWalletDelegation</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682487866"><span class="hs-identifier hs-var">ti</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487746"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682487744"><span class="hs-identifier hs-var">currentEpoch</span></a></span><span>
</span><span id="line-676"></span><span>                        </span><span class="annot"><span class="annottext">SqlPersistT IO WalletDelegation
-&gt; (WalletDelegation
    -&gt; ReaderT SqlBackend IO (Maybe WalletMetadata))
-&gt; ReaderT SqlBackend IO (Maybe WalletMetadata)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; WalletDelegation -&gt; ReaderT SqlBackend IO (Maybe WalletMetadata)
</span><a href="Cardano.Wallet.DB.Layer.html#readWalletMetadata"><span class="hs-identifier hs-var">readWalletMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487746"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-677"></span><span>
</span><span id="line-678"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">putDelegationCertificate :: WalletId
-&gt; DelegationCertificate
-&gt; SlotNo
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
</span><a href="Cardano.Wallet.DB.html#putDelegationCertificate"><span class="hs-identifier hs-var">putDelegationCertificate</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487737"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487737"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487736"><span class="annot"><span class="annottext">DelegationCertificate
</span><a href="#local-6989586621682487736"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span id="local-6989586621682487735"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487735"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
 -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-679"></span><span>            </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe Wallet)
forall (m :: * -&gt; *).
MonadIO m =&gt;
WalletId -&gt; SqlPersistT m (Maybe Wallet)
</span><a href="Cardano.Wallet.DB.Layer.html#selectWallet"><span class="hs-identifier hs-var">selectWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487737"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Maybe Wallet)
-&gt; (Maybe Wallet
    -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-680"></span><span>                </span><span class="annot"><span class="annottext">Maybe Wallet
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrNoSuchWallet ()
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ())
-&gt; ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ErrNoSuchWallet
</span><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier hs-var">ErrNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487737"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-681"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DelegationCertificate
</span><a href="#local-6989586621682487736"><span class="hs-identifier hs-var">cert</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-682"></span><span>                    </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#CertDelegateNone"><span class="hs-identifier hs-type">W.CertDelegateNone</span></a></span><span> </span><span class="annot"><span class="annottext">RewardAccount
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-683"></span><span>                        </span><span class="annot"><span class="annottext">Key DelegationCertificate
-&gt; DelegationCertificate -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
Key record -&gt; record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">repsert</span></a></span><span>
</span><span id="line-684"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; SlotNo -&gt; Key DelegationCertificate
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#DelegationCertificateKey"><span class="hs-identifier hs-var">DelegationCertificateKey</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487737"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487735"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-685"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; SlotNo -&gt; Maybe PoolId -&gt; DelegationCertificate
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#DelegationCertificate"><span class="hs-identifier hs-var">DelegationCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487737"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487735"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe PoolId
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-686"></span><span>                        </span><span class="annot"><span class="annottext">() -&gt; Either ErrNoSuchWallet ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(() -&gt; Either ErrNoSuchWallet ())
-&gt; SqlPersistT IO ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Key StakeKeyCertificate -&gt; StakeKeyCertificate -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
Key record -&gt; record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">repsert</span></a></span><span>
</span><span id="line-687"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; SlotNo -&gt; Key StakeKeyCertificate
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#StakeKeyCertificateKey"><span class="hs-identifier hs-var">StakeKeyCertificateKey</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487737"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487735"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-688"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; SlotNo -&gt; StakeKeyCertificate -&gt; StakeKeyCertificate
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#StakeKeyCertificate"><span class="hs-identifier hs-var">StakeKeyCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487737"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487735"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">StakeKeyCertificate
</span><a href="Cardano.Wallet.Primitive.Types.html#StakeKeyDeregistration"><span class="hs-identifier hs-var">W.StakeKeyDeregistration</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-689"></span><span>                    </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#CertDelegateFull"><span class="hs-identifier hs-type">W.CertDelegateFull</span></a></span><span> </span><span class="annot"><span class="annottext">RewardAccount
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682487727"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682487727"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-690"></span><span>                        </span><span class="annot"><span class="annottext">() -&gt; Either ErrNoSuchWallet ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(() -&gt; Either ErrNoSuchWallet ())
-&gt; SqlPersistT IO ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Key DelegationCertificate
-&gt; DelegationCertificate -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
Key record -&gt; record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">repsert</span></a></span><span>
</span><span id="line-691"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; SlotNo -&gt; Key DelegationCertificate
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#DelegationCertificateKey"><span class="hs-identifier hs-var">DelegationCertificateKey</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487737"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487735"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-692"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; SlotNo -&gt; Maybe PoolId -&gt; DelegationCertificate
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#DelegationCertificate"><span class="hs-identifier hs-var">DelegationCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487737"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487735"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolId -&gt; Maybe PoolId
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682487727"><span class="hs-identifier hs-var">pool</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-693"></span><span>                    </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#CertRegisterKey"><span class="hs-identifier hs-type">W.CertRegisterKey</span></a></span><span> </span><span class="annot"><span class="annottext">RewardAccount
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-694"></span><span>                        </span><span class="annot"><span class="annottext">() -&gt; Either ErrNoSuchWallet ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(() -&gt; Either ErrNoSuchWallet ())
-&gt; SqlPersistT IO ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Key StakeKeyCertificate -&gt; StakeKeyCertificate -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
Key record -&gt; record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">repsert</span></a></span><span>
</span><span id="line-695"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; SlotNo -&gt; Key StakeKeyCertificate
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#StakeKeyCertificateKey"><span class="hs-identifier hs-var">StakeKeyCertificateKey</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487737"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487735"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-696"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; SlotNo -&gt; StakeKeyCertificate -&gt; StakeKeyCertificate
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#StakeKeyCertificate"><span class="hs-identifier hs-var">StakeKeyCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487737"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487735"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">StakeKeyCertificate
</span><a href="Cardano.Wallet.Primitive.Types.html#StakeKeyRegistration"><span class="hs-identifier hs-var">W.StakeKeyRegistration</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-697"></span><span>
</span><span id="line-698"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">isStakeKeyRegistered :: WalletId -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) Bool
</span><a href="Cardano.Wallet.DB.html#isStakeKeyRegistered"><span class="hs-identifier hs-var">isStakeKeyRegistered</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487723"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487723"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrNoSuchWallet Bool)
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) Bool
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrNoSuchWallet Bool)
 -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) Bool)
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet Bool)
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-699"></span><span>              </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe Wallet)
forall (m :: * -&gt; *).
MonadIO m =&gt;
WalletId -&gt; SqlPersistT m (Maybe Wallet)
</span><a href="Cardano.Wallet.DB.Layer.html#selectWallet"><span class="hs-identifier hs-var">selectWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487723"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Maybe Wallet)
-&gt; (Maybe Wallet
    -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet Bool))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet Bool)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-700"></span><span>                </span><span class="annot"><span class="annottext">Maybe Wallet
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either ErrNoSuchWallet Bool
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet Bool)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrNoSuchWallet Bool
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet Bool))
-&gt; Either ErrNoSuchWallet Bool
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrNoSuchWallet -&gt; Either ErrNoSuchWallet Bool
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrNoSuchWallet -&gt; Either ErrNoSuchWallet Bool)
-&gt; ErrNoSuchWallet -&gt; Either ErrNoSuchWallet Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ErrNoSuchWallet
</span><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier hs-var">ErrNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487723"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-701"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-702"></span><span>                    </span><span id="local-6989586621682487722"><span class="annot"><span class="annottext">Maybe StakeKeyCertificate
</span><a href="#local-6989586621682487722"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Entity StakeKeyCertificate -&gt; StakeKeyCertificate)
-&gt; Maybe (Entity StakeKeyCertificate) -&gt; Maybe StakeKeyCertificate
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Entity StakeKeyCertificate -&gt; StakeKeyCertificate
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Entity StakeKeyCertificate) -&gt; Maybe StakeKeyCertificate)
-&gt; ReaderT SqlBackend IO (Maybe (Entity StakeKeyCertificate))
-&gt; ReaderT SqlBackend IO (Maybe StakeKeyCertificate)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter StakeKeyCertificate]
-&gt; [SelectOpt StakeKeyCertificate]
-&gt; ReaderT SqlBackend IO (Maybe (Entity StakeKeyCertificate))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span>
</span><span id="line-703"></span><span>                        </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField StakeKeyCertificate WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField StakeKeyCertificate typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#StakeKeyCertWalletId"><span class="hs-identifier hs-var">StakeKeyCertWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField StakeKeyCertificate WalletId
-&gt; WalletId -&gt; Filter StakeKeyCertificate
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487723"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-704"></span><span>                        </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField StakeKeyCertificate SlotNo
-&gt; SelectOpt StakeKeyCertificate
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Desc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField StakeKeyCertificate SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField StakeKeyCertificate typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#StakeKeyCertSlot"><span class="hs-identifier hs-var">StakeKeyCertSlot</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-705"></span><span>                    </span><span class="annot"><span class="annottext">Either ErrNoSuchWallet Bool
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet Bool)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrNoSuchWallet Bool
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet Bool))
-&gt; Either ErrNoSuchWallet Bool
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe StakeKeyCertificate
</span><a href="#local-6989586621682487722"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-706"></span><span>                        </span><span class="annot"><span class="annottext">Maybe StakeKeyCertificate
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Either ErrNoSuchWallet Bool
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-707"></span><span>                        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#StakeKeyCertificate"><span class="hs-identifier hs-type">StakeKeyCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682487719"><span class="annot"><span class="annottext">StakeKeyCertificate
</span><a href="#local-6989586621682487719"><span class="hs-identifier hs-var">status</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-708"></span><span>                            </span><span class="annot"><span class="annottext">Bool -&gt; Either ErrNoSuchWallet Bool
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StakeKeyCertificate
</span><a href="#local-6989586621682487719"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="annot"><span class="annottext">StakeKeyCertificate -&gt; StakeKeyCertificate -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">StakeKeyCertificate
</span><a href="Cardano.Wallet.Primitive.Types.html#StakeKeyRegistration"><span class="hs-identifier hs-var">W.StakeKeyRegistration</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-709"></span><span>
</span><span id="line-710"></span><span>        </span><span class="hs-comment">{-----------------------------------------------------------------------
                                     Tx History
        -----------------------------------------------------------------------}</span><span>
</span><span id="line-713"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">putTxHistory :: WalletId
-&gt; [(Tx, TxMeta)] -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
</span><a href="Cardano.Wallet.DB.html#putTxHistory"><span class="hs-identifier hs-var">putTxHistory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487717"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487717"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487716"><span class="annot"><span class="annottext">[(Tx, TxMeta)]
</span><a href="#local-6989586621682487716"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
 -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-714"></span><span>            </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe Wallet)
forall (m :: * -&gt; *).
MonadIO m =&gt;
WalletId -&gt; SqlPersistT m (Maybe Wallet)
</span><a href="Cardano.Wallet.DB.Layer.html#selectWallet"><span class="hs-identifier hs-var">selectWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487717"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Maybe Wallet)
-&gt; (Maybe Wallet
    -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-715"></span><span>                </span><span class="annot"><span class="annottext">Maybe Wallet
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrNoSuchWallet ()
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ())
-&gt; ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ErrNoSuchWallet
</span><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier hs-var">ErrNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487717"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-716"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall da (m :: * -&gt; *) a b.
(Delta da, Monad m, a ~ Base da) =&gt;
DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">modifyDBMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
</span><a href="#local-6989586621682487861"><span class="hs-identifier hs-var">transactionsDBVar</span></a></span><span> </span><span class="annot"><span class="annottext">(((TxHistory, Map WalletId TxMetaHistory)
  -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">(TxHistory, Map WalletId TxMetaHistory)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-717"></span><span>                    </span><span class="hs-keyword">let</span><span>
</span><span id="line-718"></span><span>                        </span><span id="local-6989586621682487715"><span class="annot"><span class="annottext">delta :: Maybe DeltaTxWalletsHistory
</span><a href="#local-6989586621682487715"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory)
-&gt; DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; [(Tx, TxMeta)] -&gt; DeltaTxWalletsHistory
</span><a href="Cardano.Wallet.DB.Store.Wallets.Model.html#ExpandTxWalletsHistory"><span class="hs-identifier hs-var">ExpandTxWalletsHistory</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487717"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">[(Tx, TxMeta)]
</span><a href="#local-6989586621682487716"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-719"></span><span>                    </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DeltaTxWalletsHistory
</span><a href="#local-6989586621682487715"><span class="hs-identifier hs-var">delta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either ErrNoSuchWallet ()
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-720"></span><span>
</span><span id="line-721"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">readTxHistory :: WalletId
-&gt; Maybe Coin
-&gt; SortOrder
-&gt; Range SlotNo
-&gt; Maybe TxStatus
-&gt; ReaderT SqlBackend IO [TransactionInfo]
</span><a href="Cardano.Wallet.DB.html#readTxHistory"><span class="hs-identifier hs-var">readTxHistory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487713"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487713"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487712"><span class="annot"><span class="annottext">Maybe Coin
</span><a href="#local-6989586621682487712"><span class="hs-identifier hs-var">minWithdrawal</span></a></span></span><span> </span><span id="local-6989586621682487711"><span class="annot"><span class="annottext">SortOrder
</span><a href="#local-6989586621682487711"><span class="hs-identifier hs-var">order</span></a></span></span><span> </span><span id="local-6989586621682487710"><span class="annot"><span class="annottext">Range SlotNo
</span><a href="#local-6989586621682487710"><span class="hs-identifier hs-var">range</span></a></span></span><span> </span><span id="local-6989586621682487709"><span class="annot"><span class="annottext">Maybe TxStatus
</span><a href="#local-6989586621682487709"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-722"></span><span>            </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe (Wallet s))
</span><a href="#local-6989586621682487851"><span class="hs-identifier hs-var">readCheckpoint_</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487713"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Maybe (Wallet s))
-&gt; (Maybe (Wallet s) -&gt; ReaderT SqlBackend IO [TransactionInfo])
-&gt; ReaderT SqlBackend IO [TransactionInfo]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-723"></span><span>                </span><span class="annot"><span class="annottext">Maybe (Wallet s)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[TransactionInfo] -&gt; ReaderT SqlBackend IO [TransactionInfo]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-724"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682487708"><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487708"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-725"></span><span>                    </span><span id="local-6989586621682487707"><span class="annot"><span class="annottext">(TxHistory, Map WalletId TxMetaHistory)
</span><a href="#local-6989586621682487707"><span class="hs-identifier hs-var">txHistory</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
-&gt; SqlPersistT IO (TxHistory, Map WalletId TxMetaHistory)
forall da a (m :: * -&gt; *).
(Delta da, a ~ Base da) =&gt;
DBVar m da -&gt; m a
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">readDBVar</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
</span><a href="#local-6989586621682487861"><span class="hs-identifier hs-var">transactionsDBVar</span></a></span><span>
</span><span id="line-726"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487706"><span class="annot"><span class="annottext">filtering :: TxMeta -&gt; Bool
</span><a href="#local-6989586621682487706"><span class="hs-identifier hs-var hs-var">filtering</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#TxMeta"><span class="hs-identifier hs-type">DB.TxMeta</span></a></span><span class="hs-special">{</span><span id="local-6989586621682487694"><span id="local-6989586621682487695"><span id="local-6989586621682487696"><span id="local-6989586621682487697"><span id="local-6989586621682487698"><span id="local-6989586621682487699"><span id="local-6989586621682487700"><span id="local-6989586621682487701"><span id="local-6989586621682487702"><span id="local-6989586621682487703"><span id="local-6989586621682487704"><span class="annot"><span class="annottext">Maybe Bool
Maybe Word64
Maybe TxMetadata
Maybe SlotNo
Word32
SlotNo
Coin
Direction
TxStatus
WalletId
TxId
txMetaScriptValidity :: TxMeta -&gt; Maybe Bool
txMetaFee :: TxMeta -&gt; Maybe Word64
txMetaSlotExpires :: TxMeta -&gt; Maybe SlotNo
txMetadata :: TxMeta -&gt; Maybe TxMetadata
txMetaAmount :: TxMeta -&gt; Coin
txMetaBlockHeight :: TxMeta -&gt; Word32
txMetaSlot :: TxMeta -&gt; SlotNo
txMetaDirection :: TxMeta -&gt; Direction
txMetaStatus :: TxMeta -&gt; TxStatus
txMetaWalletId :: TxMeta -&gt; WalletId
txMetaTxId :: TxMeta -&gt; TxId
txMetaScriptValidity :: Maybe Bool
txMetaFee :: Maybe Word64
txMetaSlotExpires :: Maybe SlotNo
txMetadata :: Maybe TxMetadata
txMetaAmount :: Coin
txMetaBlockHeight :: Word32
txMetaSlot :: SlotNo
txMetaDirection :: Direction
txMetaStatus :: TxStatus
txMetaWalletId :: WalletId
txMetaTxId :: TxId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#txMetaScriptValidity"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">and</span></a></span><span> </span><span class="annot"><span class="annottext">([Bool] -&gt; Bool) -&gt; [Bool] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Bool] -&gt; [Bool]
forall a. [Maybe a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">catMaybes</span></a></span><span>
</span><span id="line-727"></span><span>                            </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487700"><span class="hs-identifier hs-var">txMetaSlot</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; Bool) -&gt; Maybe SlotNo -&gt; Maybe Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Range SlotNo -&gt; Maybe SlotNo
forall a. Range a -&gt; Maybe a
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AinclusiveLowerBound%3ARange"><span class="hs-identifier hs-var hs-var">W.inclusiveLowerBound</span></a></span><span> </span><span class="annot"><span class="annottext">Range SlotNo
</span><a href="#local-6989586621682487710"><span class="hs-identifier hs-var">range</span></a></span><span>
</span><span id="line-728"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487700"><span class="hs-identifier hs-var">txMetaSlot</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; Bool) -&gt; Maybe SlotNo -&gt; Maybe Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Range SlotNo -&gt; Maybe SlotNo
forall a. Range a -&gt; Maybe a
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AinclusiveUpperBound%3ARange"><span class="hs-identifier hs-var hs-var">W.inclusiveUpperBound</span></a></span><span> </span><span class="annot"><span class="annottext">Range SlotNo
</span><a href="#local-6989586621682487710"><span class="hs-identifier hs-var">range</span></a></span><span>
</span><span id="line-729"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxStatus
</span><a href="#local-6989586621682487702"><span class="hs-identifier hs-var">txMetaStatus</span></a></span><span> </span><span class="annot"><span class="annottext">TxStatus -&gt; TxStatus -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TxStatus -&gt; Bool) -&gt; Maybe TxStatus -&gt; Maybe Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TxStatus
</span><a href="#local-6989586621682487709"><span class="hs-identifier hs-var">status</span></a></span><span>
</span><span id="line-730"></span><span>                            </span><span class="hs-special">]</span><span>
</span><span id="line-731"></span><span>                    </span><span class="annot"><span class="annottext">IO [TransactionInfo] -&gt; ReaderT SqlBackend IO [TransactionInfo]
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(IO [TransactionInfo] -&gt; ReaderT SqlBackend IO [TransactionInfo])
-&gt; IO [TransactionInfo] -&gt; ReaderT SqlBackend IO [TransactionInfo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet s
-&gt; TimeInterpreter IO
-&gt; WalletId
-&gt; Maybe Coin
-&gt; SortOrder
-&gt; (TxMeta -&gt; Bool)
-&gt; (TxHistory, Map WalletId TxMetaHistory)
-&gt; IO [TransactionInfo]
forall (m :: * -&gt; *) s.
Monad m =&gt;
Wallet s
-&gt; TimeInterpreter m
-&gt; WalletId
-&gt; Maybe Coin
-&gt; SortOrder
-&gt; (TxMeta -&gt; Bool)
-&gt; (TxHistory, Map WalletId TxMetaHistory)
-&gt; m [TransactionInfo]
</span><a href="Cardano.Wallet.DB.Layer.html#selectTxHistory"><span class="hs-identifier hs-var">selectTxHistory</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487708"><span class="hs-identifier hs-var">cp</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682487866"><span class="hs-identifier hs-var">ti</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487713"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Coin
</span><a href="#local-6989586621682487712"><span class="hs-identifier hs-var">minWithdrawal</span></a></span><span>
</span><span id="line-732"></span><span>                        </span><span class="annot"><span class="annottext">SortOrder
</span><a href="#local-6989586621682487711"><span class="hs-identifier hs-var">order</span></a></span><span> </span><span class="annot"><span class="annottext">TxMeta -&gt; Bool
</span><a href="#local-6989586621682487706"><span class="hs-identifier hs-var">filtering</span></a></span><span> </span><span class="annot"><span class="annottext">(TxHistory, Map WalletId TxMetaHistory)
</span><a href="#local-6989586621682487707"><span class="hs-identifier hs-var">txHistory</span></a></span><span>
</span><span id="line-733"></span><span>
</span><span id="line-734"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">putLocalTxSubmission :: WalletId
-&gt; Hash &quot;Tx&quot;
-&gt; SealedTx
-&gt; SlotNo
-&gt; ExceptT ErrPutLocalTxSubmission (SqlPersistT IO) ()
</span><a href="Cardano.Wallet.DB.html#putLocalTxSubmission"><span class="hs-identifier hs-var">putLocalTxSubmission</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487676"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487676"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487675"><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682487675"><span class="hs-identifier hs-var">txid</span></a></span></span><span> </span><span id="local-6989586621682487674"><span class="annot"><span class="annottext">SealedTx
</span><a href="#local-6989586621682487674"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span id="local-6989586621682487673"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487673"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrPutLocalTxSubmission ())
-&gt; ExceptT ErrPutLocalTxSubmission (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrPutLocalTxSubmission ())
 -&gt; ExceptT ErrPutLocalTxSubmission (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrPutLocalTxSubmission ())
-&gt; ExceptT ErrPutLocalTxSubmission (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-735"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487672"><span class="annot"><span class="annottext">errNoSuchWallet :: ErrPutLocalTxSubmission
</span><a href="#local-6989586621682487672"><span class="hs-identifier hs-var hs-var">errNoSuchWallet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ErrNoSuchWallet -&gt; ErrPutLocalTxSubmission
</span><a href="Cardano.Wallet.DB.html#ErrPutLocalTxSubmissionNoSuchWallet"><span class="hs-identifier hs-var">ErrPutLocalTxSubmissionNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrNoSuchWallet -&gt; ErrPutLocalTxSubmission)
-&gt; ErrNoSuchWallet -&gt; ErrPutLocalTxSubmission
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-736"></span><span>                    </span><span class="annot"><span class="annottext">WalletId -&gt; ErrNoSuchWallet
</span><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier hs-var">ErrNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487676"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-737"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487670"><span class="annot"><span class="annottext">errNoSuchTx :: ErrPutLocalTxSubmission
</span><a href="#local-6989586621682487670"><span class="hs-identifier hs-var hs-var">errNoSuchTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ErrNoSuchTransaction -&gt; ErrPutLocalTxSubmission
</span><a href="Cardano.Wallet.DB.html#ErrPutLocalTxSubmissionNoSuchTransaction"><span class="hs-identifier hs-var">ErrPutLocalTxSubmissionNoSuchTransaction</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrNoSuchTransaction -&gt; ErrPutLocalTxSubmission)
-&gt; ErrNoSuchTransaction -&gt; ErrPutLocalTxSubmission
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-738"></span><span>                    </span><span class="annot"><span class="annottext">WalletId -&gt; Hash &quot;Tx&quot; -&gt; ErrNoSuchTransaction
</span><a href="Cardano.Wallet.DB.html#ErrNoSuchTransaction"><span class="hs-identifier hs-var">ErrNoSuchTransaction</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487676"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682487675"><span class="hs-identifier hs-var">txid</span></a></span><span>
</span><span id="line-739"></span><span>
</span><span id="line-740"></span><span>            </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe Wallet)
forall (m :: * -&gt; *).
MonadIO m =&gt;
WalletId -&gt; SqlPersistT m (Maybe Wallet)
</span><a href="Cardano.Wallet.DB.Layer.html#selectWallet"><span class="hs-identifier hs-var">selectWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487676"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Maybe Wallet)
-&gt; (Maybe Wallet
    -&gt; ReaderT SqlBackend IO (Either ErrPutLocalTxSubmission ()))
-&gt; ReaderT SqlBackend IO (Either ErrPutLocalTxSubmission ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-741"></span><span>                </span><span class="annot"><span class="annottext">Maybe Wallet
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either ErrPutLocalTxSubmission ()
-&gt; ReaderT SqlBackend IO (Either ErrPutLocalTxSubmission ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrPutLocalTxSubmission ()
 -&gt; ReaderT SqlBackend IO (Either ErrPutLocalTxSubmission ()))
-&gt; Either ErrPutLocalTxSubmission ()
-&gt; ReaderT SqlBackend IO (Either ErrPutLocalTxSubmission ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrPutLocalTxSubmission -&gt; Either ErrPutLocalTxSubmission ()
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">ErrPutLocalTxSubmission
</span><a href="#local-6989586621682487672"><span class="hs-identifier hs-var">errNoSuchWallet</span></a></span><span>
</span><span id="line-742"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ErrPutLocalTxSubmission
-&gt; SqlPersistT IO ()
-&gt; ReaderT SqlBackend IO (Either ErrPutLocalTxSubmission ())
forall (m :: * -&gt; *) e a.
MonadUnliftIO m =&gt;
e -&gt; m a -&gt; m (Either e a)
</span><a href="Cardano.DB.Sqlite.html#handleConstraint"><span class="hs-identifier hs-var">handleConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">ErrPutLocalTxSubmission
</span><a href="#local-6989586621682487670"><span class="hs-identifier hs-var">errNoSuchTx</span></a></span><span> </span><span class="annot"><span class="annottext">(SqlPersistT IO ()
 -&gt; ReaderT SqlBackend IO (Either ErrPutLocalTxSubmission ()))
-&gt; SqlPersistT IO ()
-&gt; ReaderT SqlBackend IO (Either ErrPutLocalTxSubmission ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-743"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487667"><span class="annot"><span class="annottext">record :: LocalTxSubmission
</span><a href="#local-6989586621682487667"><span class="hs-identifier hs-var hs-var">record</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxId -&gt; WalletId -&gt; SlotNo -&gt; SealedTx -&gt; LocalTxSubmission
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#LocalTxSubmission"><span class="hs-identifier hs-var">LocalTxSubmission</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash &quot;Tx&quot; -&gt; TxId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#TxId"><span class="hs-identifier hs-var">TxId</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682487675"><span class="hs-identifier hs-var">txid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487676"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487673"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">SealedTx
</span><a href="#local-6989586621682487674"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-744"></span><span>                    </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Entity LocalTxSubmission)
-&gt; SqlPersistT IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Entity LocalTxSubmission)
 -&gt; SqlPersistT IO ())
-&gt; ReaderT SqlBackend IO (Entity LocalTxSubmission)
-&gt; SqlPersistT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LocalTxSubmission
-&gt; [Update LocalTxSubmission]
-&gt; ReaderT SqlBackend IO (Entity LocalTxSubmission)
forall backend record (m :: * -&gt; *).
(PersistUniqueWrite backend, MonadIO m,
 PersistRecordBackend record backend, OnlyOneUniqueKey record) =&gt;
record -&gt; [Update record] -&gt; ReaderT backend m (Entity record)
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">upsert</span></a></span><span> </span><span class="annot"><span class="annottext">LocalTxSubmission
</span><a href="#local-6989586621682487667"><span class="hs-identifier hs-var">record</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField LocalTxSubmission SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField LocalTxSubmission typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#LocalTxSubmissionLastSlot"><span class="hs-identifier hs-var">LocalTxSubmissionLastSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField LocalTxSubmission SlotNo
-&gt; SlotNo -&gt; Update LocalTxSubmission
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Update v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">=.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487673"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-745"></span><span>
</span><span id="line-746"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">readLocalTxSubmissionPending :: WalletId
-&gt; ReaderT SqlBackend IO [LocalTxSubmissionStatus SealedTx]
</span><a href="Cardano.Wallet.DB.html#readLocalTxSubmissionPending"><span class="hs-identifier hs-var">readLocalTxSubmissionPending</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-747"></span><span>            </span><span class="annot"><span class="annottext">([(SlotNo, LocalTxSubmission)]
 -&gt; [LocalTxSubmissionStatus SealedTx])
-&gt; ReaderT SqlBackend IO [(SlotNo, LocalTxSubmission)]
-&gt; ReaderT SqlBackend IO [LocalTxSubmissionStatus SealedTx]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((SlotNo, LocalTxSubmission) -&gt; LocalTxSubmissionStatus SealedTx)
-&gt; [(SlotNo, LocalTxSubmission)]
-&gt; [LocalTxSubmissionStatus SealedTx]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo, LocalTxSubmission) -&gt; LocalTxSubmissionStatus SealedTx
</span><a href="Cardano.Wallet.DB.Layer.html#localTxSubmissionFromEntity"><span class="hs-identifier hs-var">localTxSubmissionFromEntity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-748"></span><span>            </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO [(SlotNo, LocalTxSubmission)]
 -&gt; ReaderT SqlBackend IO [LocalTxSubmissionStatus SealedTx])
-&gt; (WalletId
    -&gt; ReaderT SqlBackend IO [(SlotNo, LocalTxSubmission)])
-&gt; WalletId
-&gt; ReaderT SqlBackend IO [LocalTxSubmissionStatus SealedTx]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ReaderT SqlBackend IO [(SlotNo, LocalTxSubmission)]
</span><a href="Cardano.Wallet.DB.Layer.html#listPendingLocalTxSubmissionQuery"><span class="hs-identifier hs-var">listPendingLocalTxSubmissionQuery</span></a></span><span>
</span><span id="line-749"></span><span>
</span><span id="line-750"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">updatePendingTxForExpiry :: WalletId -&gt; SlotNo -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
</span><a href="Cardano.Wallet.DB.html#updatePendingTxForExpiry"><span class="hs-identifier hs-var">updatePendingTxForExpiry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487659"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487659"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487658"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487658"><span class="hs-identifier hs-var">tip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
 -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-751"></span><span>            </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe Wallet)
forall (m :: * -&gt; *).
MonadIO m =&gt;
WalletId -&gt; SqlPersistT m (Maybe Wallet)
</span><a href="Cardano.Wallet.DB.Layer.html#selectWallet"><span class="hs-identifier hs-var">selectWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487659"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Maybe Wallet)
-&gt; (Maybe Wallet
    -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-752"></span><span>                </span><span class="annot"><span class="annottext">Maybe Wallet
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrNoSuchWallet ()
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ())
-&gt; ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ErrNoSuchWallet
</span><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier hs-var">ErrNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487659"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-753"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall da (m :: * -&gt; *) a b.
(Delta da, Monad m, a ~ Base da) =&gt;
DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">modifyDBMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
</span><a href="#local-6989586621682487861"><span class="hs-identifier hs-var">transactionsDBVar</span></a></span><span> </span><span class="annot"><span class="annottext">(((TxHistory, Map WalletId TxMetaHistory)
  -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">(TxHistory, Map WalletId TxMetaHistory)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-754"></span><span>                    </span><span class="hs-keyword">let</span><span>
</span><span id="line-755"></span><span>                        </span><span id="local-6989586621682487657"><span class="annot"><span class="annottext">delta :: Maybe DeltaTxWalletsHistory
</span><a href="#local-6989586621682487657"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span>
</span><span id="line-756"></span><span>                            </span><span class="annot"><span class="annottext">(DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory)
-&gt; DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ManipulateTxMetaHistory -&gt; DeltaTxWalletsHistory
</span><a href="Cardano.Wallet.DB.Store.Wallets.Model.html#ChangeTxMetaWalletsHistory"><span class="hs-identifier hs-var">ChangeTxMetaWalletsHistory</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487659"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-757"></span><span>                            </span><span class="annot"><span class="annottext">(ManipulateTxMetaHistory -&gt; DeltaTxWalletsHistory)
-&gt; ManipulateTxMetaHistory -&gt; DeltaTxWalletsHistory
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; ManipulateTxMetaHistory
</span><a href="Cardano.Wallet.DB.Store.Meta.Model.html#AgeTxMetaHistory"><span class="hs-identifier hs-var">AgeTxMetaHistory</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487658"><span class="hs-identifier hs-var">tip</span></a></span><span>
</span><span id="line-758"></span><span>                    </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DeltaTxWalletsHistory
</span><a href="#local-6989586621682487657"><span class="hs-identifier hs-var">delta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either ErrNoSuchWallet ()
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-759"></span><span>
</span><span id="line-760"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">removePendingOrExpiredTx :: WalletId -&gt; Hash &quot;Tx&quot; -&gt; ExceptT ErrRemoveTx (SqlPersistT IO) ()
</span><a href="Cardano.Wallet.DB.html#removePendingOrExpiredTx"><span class="hs-identifier hs-var">removePendingOrExpiredTx</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487654"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487654"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487653"><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682487653"><span class="hs-identifier hs-var">txId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-761"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487652"><span class="annot"><span class="annottext">noTx :: (Maybe a, Either ErrRemoveTx b)
</span><a href="#local-6989586621682487652"><span class="hs-identifier hs-var hs-var">noTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-762"></span><span>                    </span><span class="hs-special">(</span><span>   </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-763"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ErrRemoveTx -&gt; Either ErrRemoveTx b
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span>
</span><span id="line-764"></span><span>                            </span><span class="annot"><span class="annottext">(ErrRemoveTx -&gt; Either ErrRemoveTx b)
-&gt; ErrRemoveTx -&gt; Either ErrRemoveTx b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrNoSuchTransaction -&gt; ErrRemoveTx
</span><a href="Cardano.Wallet.DB.html#ErrRemoveTxNoSuchTransaction"><span class="hs-identifier hs-var">ErrRemoveTxNoSuchTransaction</span></a></span><span>
</span><span id="line-765"></span><span>                            </span><span class="annot"><span class="annottext">(ErrNoSuchTransaction -&gt; ErrRemoveTx)
-&gt; ErrNoSuchTransaction -&gt; ErrRemoveTx
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; Hash &quot;Tx&quot; -&gt; ErrNoSuchTransaction
</span><a href="Cardano.Wallet.DB.html#ErrNoSuchTransaction"><span class="hs-identifier hs-var">ErrNoSuchTransaction</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487654"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682487653"><span class="hs-identifier hs-var">txId</span></a></span><span>
</span><span id="line-766"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-767"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrRemoveTx ())
-&gt; ExceptT ErrRemoveTx (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrRemoveTx ())
 -&gt; ExceptT ErrRemoveTx (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrRemoveTx ())
-&gt; ExceptT ErrRemoveTx (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe Wallet)
forall (m :: * -&gt; *).
MonadIO m =&gt;
WalletId -&gt; SqlPersistT m (Maybe Wallet)
</span><a href="Cardano.Wallet.DB.Layer.html#selectWallet"><span class="hs-identifier hs-var">selectWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487654"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Maybe Wallet)
-&gt; (Maybe Wallet -&gt; ReaderT SqlBackend IO (Either ErrRemoveTx ()))
-&gt; ReaderT SqlBackend IO (Either ErrRemoveTx ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-768"></span><span>                </span><span class="annot"><span class="annottext">Maybe Wallet
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either ErrRemoveTx ()
-&gt; ReaderT SqlBackend IO (Either ErrRemoveTx ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrRemoveTx ()
 -&gt; ReaderT SqlBackend IO (Either ErrRemoveTx ()))
-&gt; Either ErrRemoveTx ()
-&gt; ReaderT SqlBackend IO (Either ErrRemoveTx ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrRemoveTx -&gt; Either ErrRemoveTx ()
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span>
</span><span id="line-769"></span><span>                    </span><span class="annot"><span class="annottext">(ErrRemoveTx -&gt; Either ErrRemoveTx ())
-&gt; ErrRemoveTx -&gt; Either ErrRemoveTx ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrNoSuchWallet -&gt; ErrRemoveTx
</span><a href="Cardano.Wallet.DB.html#ErrRemoveTxNoSuchWallet"><span class="hs-identifier hs-var">ErrRemoveTxNoSuchWallet</span></a></span><span>
</span><span id="line-770"></span><span>                    </span><span class="annot"><span class="annottext">(ErrNoSuchWallet -&gt; ErrRemoveTx) -&gt; ErrNoSuchWallet -&gt; ErrRemoveTx
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ErrNoSuchWallet
</span><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier hs-var">ErrNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487654"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-771"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ()))
-&gt; ReaderT SqlBackend IO (Either ErrRemoveTx ())
forall da (m :: * -&gt; *) a b.
(Delta da, Monad m, a ~ Base da) =&gt;
DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">modifyDBMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
</span><a href="#local-6989586621682487861"><span class="hs-identifier hs-var">transactionsDBVar</span></a></span><span>
</span><span id="line-772"></span><span>                    </span><span class="annot"><span class="annottext">(((TxHistory, Map WalletId TxMetaHistory)
  -&gt; (Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ()))
 -&gt; ReaderT SqlBackend IO (Either ErrRemoveTx ()))
-&gt; ((TxHistory, Map WalletId TxMetaHistory)
    -&gt; (Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ()))
-&gt; ReaderT SqlBackend IO (Either ErrRemoveTx ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Store.Transactions.Model.html#TxHistoryF"><span class="hs-identifier hs-type">TxHistoryF</span></a></span><span> </span><span id="local-6989586621682487648"><span class="annot"><span class="annottext">Map TxId (TxRelationF 'Without)
</span><a href="#local-6989586621682487648"><span class="hs-identifier hs-var">_txsOld</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682487647"><span class="annot"><span class="annottext">Map WalletId TxMetaHistory
</span><a href="#local-6989586621682487647"><span class="hs-identifier hs-var">ws</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ())
-&gt; Maybe (Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ())
-&gt; (Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ())
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ())
forall a b. (Maybe a, Either ErrRemoveTx b)
</span><a href="#local-6989586621682487652"><span class="hs-identifier hs-var">noTx</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ())
 -&gt; (Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ()))
-&gt; Maybe (Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ())
-&gt; (Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-773"></span><span>                        </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Meta.Model.html#TxMetaHistory"><span class="hs-identifier hs-type">TxMetaHistory</span></a></span><span> </span><span id="local-6989586621682487645"><span class="annot"><span class="annottext">Map TxId TxMeta
</span><a href="#local-6989586621682487645"><span class="hs-identifier hs-var">metas</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; Map WalletId TxMetaHistory -&gt; Maybe TxMetaHistory
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487654"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Map WalletId TxMetaHistory
</span><a href="#local-6989586621682487647"><span class="hs-identifier hs-var">ws</span></a></span><span>
</span><span id="line-774"></span><span>                        </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#TxMeta"><span class="hs-identifier hs-type">DB.TxMeta</span></a></span><span class="hs-special">{</span><span id="local-6989586621682487634"><span id="local-6989586621682487635"><span id="local-6989586621682487636"><span id="local-6989586621682487637"><span id="local-6989586621682487638"><span id="local-6989586621682487639"><span id="local-6989586621682487640"><span id="local-6989586621682487641"><span id="local-6989586621682487642"><span id="local-6989586621682487643"><span id="local-6989586621682487644"><span class="annot"><span class="annottext">Maybe Bool
Maybe Word64
Maybe TxMetadata
Maybe SlotNo
Word32
SlotNo
Coin
Direction
TxStatus
WalletId
TxId
txMetaScriptValidity :: Maybe Bool
txMetaFee :: Maybe Word64
txMetaSlotExpires :: Maybe SlotNo
txMetadata :: Maybe TxMetadata
txMetaAmount :: Coin
txMetaBlockHeight :: Word32
txMetaSlot :: SlotNo
txMetaDirection :: Direction
txMetaStatus :: TxStatus
txMetaWalletId :: WalletId
txMetaTxId :: TxId
txMetaScriptValidity :: TxMeta -&gt; Maybe Bool
txMetaFee :: TxMeta -&gt; Maybe Word64
txMetaSlotExpires :: TxMeta -&gt; Maybe SlotNo
txMetadata :: TxMeta -&gt; Maybe TxMetadata
txMetaAmount :: TxMeta -&gt; Coin
txMetaBlockHeight :: TxMeta -&gt; Word32
txMetaSlot :: TxMeta -&gt; SlotNo
txMetaDirection :: TxMeta -&gt; Direction
txMetaStatus :: TxMeta -&gt; TxStatus
txMetaWalletId :: TxMeta -&gt; WalletId
txMetaTxId :: TxMeta -&gt; TxId
</span><a href="#local-6989586621682487634"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TxId -&gt; Map TxId TxMeta -&gt; Maybe TxMeta
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash &quot;Tx&quot; -&gt; TxId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#TxId"><span class="hs-identifier hs-var">TxId</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682487653"><span class="hs-identifier hs-var">txId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map TxId TxMeta
</span><a href="#local-6989586621682487645"><span class="hs-identifier hs-var">metas</span></a></span><span>
</span><span id="line-775"></span><span>                        </span><span class="annot"><span class="annottext">(Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ())
-&gt; Maybe (Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ())
 -&gt; Maybe (Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ()))
-&gt; (Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ())
-&gt; Maybe (Maybe DeltaTxWalletsHistory, Either ErrRemoveTx ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-776"></span><span>                            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TxStatus
</span><a href="#local-6989586621682487642"><span class="hs-identifier hs-var">txMetaStatus</span></a></span><span> </span><span class="annot"><span class="annottext">TxStatus -&gt; TxStatus -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">TxStatus
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#InLedger"><span class="hs-identifier hs-var">W.InLedger</span></a></span><span>
</span><span id="line-777"></span><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DeltaTxWalletsHistory
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-778"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ErrRemoveTx -&gt; Either ErrRemoveTx ()
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrRemoveTx -&gt; Either ErrRemoveTx ())
-&gt; ErrRemoveTx -&gt; Either ErrRemoveTx ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot; -&gt; ErrRemoveTx
</span><a href="Cardano.Wallet.DB.html#ErrRemoveTxAlreadyInLedger"><span class="hs-identifier hs-var">ErrRemoveTxAlreadyInLedger</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682487653"><span class="hs-identifier hs-var">txId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-779"></span><span>                            </span><span class="hs-keyword">else</span><span>
</span><span id="line-780"></span><span>                                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682487631"><span class="annot"><span class="annottext">delta :: Maybe DeltaTxWalletsHistory
</span><a href="#local-6989586621682487631"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span>
</span><span id="line-781"></span><span>                                        </span><span class="annot"><span class="annottext">(DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory)
-&gt; DeltaTxWalletsHistory -&gt; Maybe DeltaTxWalletsHistory
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ManipulateTxMetaHistory -&gt; DeltaTxWalletsHistory
</span><a href="Cardano.Wallet.DB.Store.Wallets.Model.html#ChangeTxMetaWalletsHistory"><span class="hs-identifier hs-var">ChangeTxMetaWalletsHistory</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487654"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-782"></span><span>                                        </span><span class="annot"><span class="annottext">(ManipulateTxMetaHistory -&gt; DeltaTxWalletsHistory)
-&gt; ManipulateTxMetaHistory -&gt; DeltaTxWalletsHistory
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxId -&gt; ManipulateTxMetaHistory
</span><a href="Cardano.Wallet.DB.Store.Meta.Model.html#PruneTxMetaHistory"><span class="hs-identifier hs-var">PruneTxMetaHistory</span></a></span><span> </span><span class="annot"><span class="annottext">(TxId -&gt; ManipulateTxMetaHistory)
-&gt; TxId -&gt; ManipulateTxMetaHistory
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot; -&gt; TxId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#TxId"><span class="hs-identifier hs-var">TxId</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682487653"><span class="hs-identifier hs-var">txId</span></a></span><span>
</span><span id="line-783"></span><span>                                </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DeltaTxWalletsHistory
</span><a href="#local-6989586621682487631"><span class="hs-identifier hs-var">delta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either ErrRemoveTx ()
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-784"></span><span>
</span><span id="line-785"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getTx :: WalletId
-&gt; Hash &quot;Tx&quot;
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) (Maybe TransactionInfo)
</span><a href="Cardano.Wallet.DB.html#getTx"><span class="hs-identifier hs-var">getTx</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487628"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487628"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487627"><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682487627"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReaderT
  SqlBackend IO (Either ErrNoSuchWallet (Maybe TransactionInfo))
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) (Maybe TransactionInfo)
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT
   SqlBackend IO (Either ErrNoSuchWallet (Maybe TransactionInfo))
 -&gt; ExceptT
      ErrNoSuchWallet (SqlPersistT IO) (Maybe TransactionInfo))
-&gt; ReaderT
     SqlBackend IO (Either ErrNoSuchWallet (Maybe TransactionInfo))
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) (Maybe TransactionInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-786"></span><span>            </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe (Wallet s))
</span><a href="#local-6989586621682487851"><span class="hs-identifier hs-var">readCheckpoint_</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487628"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Maybe (Wallet s))
-&gt; (Maybe (Wallet s)
    -&gt; ReaderT
         SqlBackend IO (Either ErrNoSuchWallet (Maybe TransactionInfo)))
-&gt; ReaderT
     SqlBackend IO (Either ErrNoSuchWallet (Maybe TransactionInfo))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-787"></span><span>                </span><span class="annot"><span class="annottext">Maybe (Wallet s)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either ErrNoSuchWallet (Maybe TransactionInfo)
-&gt; ReaderT
     SqlBackend IO (Either ErrNoSuchWallet (Maybe TransactionInfo))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrNoSuchWallet (Maybe TransactionInfo)
 -&gt; ReaderT
      SqlBackend IO (Either ErrNoSuchWallet (Maybe TransactionInfo)))
-&gt; Either ErrNoSuchWallet (Maybe TransactionInfo)
-&gt; ReaderT
     SqlBackend IO (Either ErrNoSuchWallet (Maybe TransactionInfo))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrNoSuchWallet -&gt; Either ErrNoSuchWallet (Maybe TransactionInfo)
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrNoSuchWallet -&gt; Either ErrNoSuchWallet (Maybe TransactionInfo))
-&gt; ErrNoSuchWallet
-&gt; Either ErrNoSuchWallet (Maybe TransactionInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ErrNoSuchWallet
</span><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier hs-var">ErrNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487628"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-788"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682487626"><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487626"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-789"></span><span>                    </span><span id="local-6989586621682487625"><span class="annot"><span class="annottext">(TxHistory, Map WalletId TxMetaHistory)
</span><a href="#local-6989586621682487625"><span class="hs-identifier hs-var">txHistory</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
-&gt; SqlPersistT IO (TxHistory, Map WalletId TxMetaHistory)
forall da a (m :: * -&gt; *).
(Delta da, a ~ Base da) =&gt;
DBVar m da -&gt; m a
</span><a href="../../../../dbvar/html/src"><span class="hs-identifier hs-var">readDBVar</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar (SqlPersistT IO) DeltaTxWalletsHistory
</span><a href="#local-6989586621682487861"><span class="hs-identifier hs-var">transactionsDBVar</span></a></span><span>
</span><span id="line-790"></span><span>                    </span><span id="local-6989586621682487624"><span class="annot"><span class="annottext">[TransactionInfo]
</span><a href="#local-6989586621682487624"><span class="hs-identifier hs-var">metas</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [TransactionInfo] -&gt; ReaderT SqlBackend IO [TransactionInfo]
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(IO [TransactionInfo] -&gt; ReaderT SqlBackend IO [TransactionInfo])
-&gt; IO [TransactionInfo] -&gt; ReaderT SqlBackend IO [TransactionInfo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet s
-&gt; TimeInterpreter IO
-&gt; WalletId
-&gt; Maybe Coin
-&gt; SortOrder
-&gt; (TxMeta -&gt; Bool)
-&gt; (TxHistory, Map WalletId TxMetaHistory)
-&gt; IO [TransactionInfo]
forall (m :: * -&gt; *) s.
Monad m =&gt;
Wallet s
-&gt; TimeInterpreter m
-&gt; WalletId
-&gt; Maybe Coin
-&gt; SortOrder
-&gt; (TxMeta -&gt; Bool)
-&gt; (TxHistory, Map WalletId TxMetaHistory)
-&gt; m [TransactionInfo]
</span><a href="Cardano.Wallet.DB.Layer.html#selectTxHistory"><span class="hs-identifier hs-var">selectTxHistory</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487626"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-791"></span><span>                        </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682487866"><span class="hs-identifier hs-var">ti</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487628"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Coin
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">SortOrder
</span><a href="Cardano.Wallet.Primitive.Types.html#Descending"><span class="hs-identifier hs-var">W.Descending</span></a></span><span>
</span><span id="line-792"></span><span>                            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682487622"><span class="annot"><span class="annottext">TxMeta
</span><a href="#local-6989586621682487622"><span class="hs-identifier hs-var">meta</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxMeta -&gt; TxId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#txMetaTxId"><span class="hs-identifier hs-var hs-var">txMetaTxId</span></a></span><span> </span><span class="annot"><span class="annottext">TxMeta
</span><a href="#local-6989586621682487622"><span class="hs-identifier hs-var">meta</span></a></span><span> </span><span class="annot"><span class="annottext">TxId -&gt; TxId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot; -&gt; TxId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#TxId"><span class="hs-identifier hs-var">TxId</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682487627"><span class="hs-identifier hs-var">tid</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-793"></span><span>                            </span><span class="annot"><span class="annottext">(TxHistory, Map WalletId TxMetaHistory)
</span><a href="#local-6989586621682487625"><span class="hs-identifier hs-var">txHistory</span></a></span><span>
</span><span id="line-794"></span><span>                    </span><span class="annot"><span class="annottext">Either ErrNoSuchWallet (Maybe TransactionInfo)
-&gt; ReaderT
     SqlBackend IO (Either ErrNoSuchWallet (Maybe TransactionInfo))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrNoSuchWallet (Maybe TransactionInfo)
 -&gt; ReaderT
      SqlBackend IO (Either ErrNoSuchWallet (Maybe TransactionInfo)))
-&gt; Either ErrNoSuchWallet (Maybe TransactionInfo)
-&gt; ReaderT
     SqlBackend IO (Either ErrNoSuchWallet (Maybe TransactionInfo))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TransactionInfo
-&gt; Either ErrNoSuchWallet (Maybe TransactionInfo)
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe TransactionInfo
 -&gt; Either ErrNoSuchWallet (Maybe TransactionInfo))
-&gt; Maybe TransactionInfo
-&gt; Either ErrNoSuchWallet (Maybe TransactionInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[TransactionInfo] -&gt; Maybe TransactionInfo
forall a. [a] -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[TransactionInfo]
</span><a href="#local-6989586621682487624"><span class="hs-identifier hs-var">metas</span></a></span><span>
</span><span id="line-795"></span><span>
</span><span id="line-796"></span><span>        </span><span class="hs-comment">{-----------------------------------------------------------------------
                                       Keystore
        -----------------------------------------------------------------------}</span><span>
</span><span id="line-799"></span><span>
</span><span id="line-800"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">putPrivateKey :: WalletId
-&gt; (k 'RootK XPrv, PassphraseHash)
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
</span><a href="Cardano.Wallet.DB.html#putPrivateKey"><span class="hs-identifier hs-var">putPrivateKey</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682487620"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487620"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487619"><span class="annot"><span class="annottext">(k 'RootK XPrv, PassphraseHash)
</span><a href="#local-6989586621682487619"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
 -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-801"></span><span>            </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe Wallet)
forall (m :: * -&gt; *).
MonadIO m =&gt;
WalletId -&gt; SqlPersistT m (Maybe Wallet)
</span><a href="Cardano.Wallet.DB.Layer.html#selectWallet"><span class="hs-identifier hs-var">selectWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487620"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Maybe Wallet)
-&gt; (Maybe Wallet
    -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-802"></span><span>                </span><span class="annot"><span class="annottext">Maybe Wallet
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrNoSuchWallet ()
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ())
-&gt; ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ErrNoSuchWallet
</span><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier hs-var">ErrNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487620"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-803"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either ErrNoSuchWallet ()
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(() -&gt; Either ErrNoSuchWallet ())
-&gt; SqlPersistT IO ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-804"></span><span>                    </span><span class="annot"><span class="annottext">[Filter PrivateKey] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField PrivateKey WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField PrivateKey typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#PrivateKeyWalletId"><span class="hs-identifier hs-var">PrivateKeyWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PrivateKey WalletId -&gt; WalletId -&gt; Filter PrivateKey
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487620"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-805"></span><span>                    </span><span class="annot"><span class="annottext">PrivateKey -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insert_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; (k 'RootK XPrv, PassphraseHash) -&gt; PrivateKey
forall (k :: Depth -&gt; * -&gt; *).
PersistPrivateKey (k 'RootK) =&gt;
WalletId -&gt; (k 'RootK XPrv, PassphraseHash) -&gt; PrivateKey
</span><a href="Cardano.Wallet.DB.Layer.html#mkPrivateKeyEntity"><span class="hs-identifier hs-var">mkPrivateKeyEntity</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487620"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">(k 'RootK XPrv, PassphraseHash)
</span><a href="#local-6989586621682487619"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-806"></span><span>
</span><span id="line-807"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">readPrivateKey :: WalletId
-&gt; ReaderT SqlBackend IO (Maybe (k 'RootK XPrv, PassphraseHash))
</span><a href="Cardano.Wallet.DB.html#readPrivateKey"><span class="hs-identifier hs-var">readPrivateKey</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; ReaderT SqlBackend IO (Maybe (k 'RootK XPrv, PassphraseHash))
forall (m :: * -&gt; *) (k :: Depth -&gt; * -&gt; *).
(MonadIO m, PersistPrivateKey (k 'RootK)) =&gt;
WalletId -&gt; SqlPersistT m (Maybe (k 'RootK XPrv, PassphraseHash))
</span><a href="Cardano.Wallet.DB.Layer.html#selectPrivateKey"><span class="hs-identifier hs-var">selectPrivateKey</span></a></span><span>
</span><span id="line-808"></span><span>
</span><span id="line-809"></span><span>        </span><span class="hs-comment">{-----------------------------------------------------------------------
                                 Blockchain Parameters
        -----------------------------------------------------------------------}</span><span>
</span><span id="line-812"></span><span>
</span><span id="line-813"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">readGenesisParameters :: WalletId -&gt; ReaderT SqlBackend IO (Maybe GenesisParameters)
</span><a href="Cardano.Wallet.DB.html#readGenesisParameters"><span class="hs-identifier hs-var">readGenesisParameters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ReaderT SqlBackend IO (Maybe GenesisParameters)
forall (m :: * -&gt; *).
MonadIO m =&gt;
WalletId -&gt; SqlPersistT m (Maybe GenesisParameters)
</span><a href="Cardano.Wallet.DB.Layer.html#selectGenesisParameters"><span class="hs-identifier hs-var">selectGenesisParameters</span></a></span><span>
</span><span id="line-814"></span><span>
</span><span id="line-815"></span><span>        </span><span class="hs-comment">{-----------------------------------------------------------------------
                                 Delegation Rewards
        -----------------------------------------------------------------------}</span><span>
</span><span id="line-818"></span><span>
</span><span id="line-819"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">putDelegationRewardBalance :: WalletId -&gt; Coin -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
</span><a href="Cardano.Wallet.DB.html#putDelegationRewardBalance"><span class="hs-identifier hs-var">putDelegationRewardBalance</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-820"></span><span>            </span><span class="hs-glyph">\</span><span id="local-6989586621682487611"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487611"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487610"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621682487610"><span class="hs-identifier hs-var">amt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
 -&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ())
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
-&gt; ExceptT ErrNoSuchWallet (SqlPersistT IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-821"></span><span>            </span><span class="annot"><span class="annottext">WalletId -&gt; SqlPersistT IO (Maybe Wallet)
forall (m :: * -&gt; *).
MonadIO m =&gt;
WalletId -&gt; SqlPersistT m (Maybe Wallet)
</span><a href="Cardano.Wallet.DB.Layer.html#selectWallet"><span class="hs-identifier hs-var">selectWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487611"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO (Maybe Wallet)
-&gt; (Maybe Wallet
    -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-822"></span><span>                </span><span class="annot"><span class="annottext">Maybe Wallet
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ErrNoSuchWallet ()
 -&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ()))
-&gt; Either ErrNoSuchWallet ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ())
-&gt; ErrNoSuchWallet -&gt; Either ErrNoSuchWallet ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; ErrNoSuchWallet
</span><a href="Cardano.Wallet.DB.WalletState.html#ErrNoSuchWallet"><span class="hs-identifier hs-var">ErrNoSuchWallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487611"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-823"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either ErrNoSuchWallet ()
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(() -&gt; Either ErrNoSuchWallet ())
-&gt; SqlPersistT IO ()
-&gt; ReaderT SqlBackend IO (Either ErrNoSuchWallet ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Key DelegationReward -&gt; DelegationReward -&gt; SqlPersistT IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
Key record -&gt; record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">repsert</span></a></span><span>
</span><span id="line-824"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; Key DelegationReward
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#DelegationRewardKey"><span class="hs-identifier hs-var">DelegationRewardKey</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487611"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-825"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletId -&gt; Word64 -&gt; DelegationReward
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#DelegationReward"><span class="hs-identifier hs-var">DelegationReward</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487611"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; Coin -&gt; Word64
Coin -&gt; Word64
</span><a href="Cardano.Wallet.Primitive.Types.Coin.html#unsafeToWord64"><span class="hs-identifier hs-var">Coin.unsafeToWord64</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621682487610"><span class="hs-identifier hs-var">amt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-826"></span><span>
</span><span id="line-827"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">readDelegationRewardBalance :: WalletId -&gt; ReaderT SqlBackend IO Coin
</span><a href="Cardano.Wallet.DB.html#readDelegationRewardBalance"><span class="hs-identifier hs-var">readDelegationRewardBalance</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-828"></span><span>            </span><span class="hs-glyph">\</span><span id="local-6989586621682487605"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487605"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-829"></span><span>                </span><span class="annot"><span class="annottext">Word64 -&gt; Coin
</span><a href="Cardano.Wallet.Primitive.Types.Coin.html#fromWord64"><span class="hs-identifier hs-var">Coin.fromWord64</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Coin)
-&gt; (Maybe (Entity DelegationReward) -&gt; Word64)
-&gt; Maybe (Entity DelegationReward)
-&gt; Coin
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
-&gt; (Entity DelegationReward -&gt; Word64)
-&gt; Maybe (Entity DelegationReward)
-&gt; Word64
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DelegationReward -&gt; Word64
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#rewardAccountBalance"><span class="hs-identifier hs-var hs-var">rewardAccountBalance</span></a></span><span> </span><span class="annot"><span class="annottext">(DelegationReward -&gt; Word64)
-&gt; (Entity DelegationReward -&gt; DelegationReward)
-&gt; Entity DelegationReward
-&gt; Word64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity DelegationReward -&gt; DelegationReward
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (Entity DelegationReward) -&gt; Coin)
-&gt; ReaderT SqlBackend IO (Maybe (Entity DelegationReward))
-&gt; ReaderT SqlBackend IO Coin
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-830"></span><span>                </span><span class="annot"><span class="annottext">[Filter DelegationReward]
-&gt; [SelectOpt DelegationReward]
-&gt; ReaderT SqlBackend IO (Maybe (Entity DelegationReward))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField DelegationReward WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField DelegationReward typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#RewardWalletId"><span class="hs-identifier hs-var">RewardWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField DelegationReward WalletId
-&gt; WalletId -&gt; Filter DelegationReward
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487605"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-831"></span><span>
</span><span id="line-832"></span><span>        </span><span class="hs-comment">{-----------------------------------------------------------------------
                                     ACID Execution
        -----------------------------------------------------------------------}</span><span>
</span><span id="line-835"></span><span>
</span><span id="line-836"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">atomically :: forall a. SqlPersistT IO a -&gt; IO a
</span><a href="Cardano.Wallet.DB.html#atomically"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; (() -&gt; IO a) -&gt; IO a
forall (m :: * -&gt; *) a b.
MonadUnliftIO m =&gt;
MVar a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../unliftio/html/src"><span class="hs-identifier hs-var">withMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621682487860"><span class="hs-identifier hs-var">queryLock</span></a></span><span> </span><span class="annot"><span class="annottext">((() -&gt; IO a) -&gt; IO a)
-&gt; (SqlPersistT IO a -&gt; () -&gt; IO a) -&gt; SqlPersistT IO a -&gt; IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; () -&gt; IO a
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; () -&gt; IO a)
-&gt; (SqlPersistT IO a -&gt; IO a) -&gt; SqlPersistT IO a -&gt; () -&gt; IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO a -&gt; IO a
forall a. SqlPersistT IO a -&gt; IO a
</span><a href="#local-6989586621682487864"><span class="hs-identifier hs-var">runQuery</span></a></span><span>
</span><span id="line-837"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-838"></span><span>
</span><span id="line-839"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#readWalletMetadata"><span class="hs-identifier hs-type">readWalletMetadata</span></a></span><span>
</span><span id="line-840"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-841"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletDelegation"><span class="hs-identifier hs-type">W.WalletDelegation</span></a></span><span>
</span><span id="line-842"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletMetadata"><span class="hs-identifier hs-type">W.WalletMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-843"></span><span id="readWalletMetadata"><span class="annot"><span class="annottext">readWalletMetadata :: WalletId
-&gt; WalletDelegation -&gt; ReaderT SqlBackend IO (Maybe WalletMetadata)
</span><a href="Cardano.Wallet.DB.Layer.html#readWalletMetadata"><span class="hs-identifier hs-var hs-var">readWalletMetadata</span></a></span></span><span> </span><span id="local-6989586621682487598"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487598"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487597"><span class="annot"><span class="annottext">WalletDelegation
</span><a href="#local-6989586621682487597"><span class="hs-identifier hs-var">walDel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-844"></span><span>     </span><span class="annot"><span class="annottext">(Entity Wallet -&gt; WalletMetadata)
-&gt; Maybe (Entity Wallet) -&gt; Maybe WalletMetadata
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WalletDelegation -&gt; Wallet -&gt; WalletMetadata
</span><a href="Cardano.Wallet.DB.Layer.html#metadataFromEntity"><span class="hs-identifier hs-var">metadataFromEntity</span></a></span><span> </span><span class="annot"><span class="annottext">WalletDelegation
</span><a href="#local-6989586621682487597"><span class="hs-identifier hs-var">walDel</span></a></span><span> </span><span class="annot"><span class="annottext">(Wallet -&gt; WalletMetadata)
-&gt; (Entity Wallet -&gt; Wallet) -&gt; Entity Wallet -&gt; WalletMetadata
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity Wallet -&gt; Wallet
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-845"></span><span>        </span><span class="annot"><span class="annottext">(Maybe (Entity Wallet) -&gt; Maybe WalletMetadata)
-&gt; ReaderT SqlBackend IO (Maybe (Entity Wallet))
-&gt; ReaderT SqlBackend IO (Maybe WalletMetadata)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter Wallet]
-&gt; [SelectOpt Wallet]
-&gt; ReaderT SqlBackend IO (Maybe (Entity Wallet))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField Wallet WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField Wallet typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#WalId"><span class="hs-identifier hs-var">WalId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Wallet WalletId -&gt; WalletId -&gt; Filter Wallet
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487598"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-846"></span><span>
</span><span id="line-847"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#readWalletDelegation"><span class="hs-identifier hs-type">readWalletDelegation</span></a></span><span>
</span><span id="line-848"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier hs-type">TimeInterpreter</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-849"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-850"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">W.EpochNo</span></a></span><span>
</span><span id="line-851"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletDelegation"><span class="hs-identifier hs-type">W.WalletDelegation</span></a></span><span>
</span><span id="line-852"></span><span id="readWalletDelegation"><span class="annot"><span class="annottext">readWalletDelegation :: TimeInterpreter IO
-&gt; WalletId -&gt; EpochNo -&gt; SqlPersistT IO WalletDelegation
</span><a href="Cardano.Wallet.DB.Layer.html#readWalletDelegation"><span class="hs-identifier hs-var hs-var">readWalletDelegation</span></a></span></span><span> </span><span id="local-6989586621682487595"><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682487595"><span class="hs-identifier hs-var">ti</span></a></span></span><span> </span><span id="local-6989586621682487594"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487594"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487593"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682487593"><span class="hs-identifier hs-var">epoch</span></a></span></span><span>
</span><span id="line-853"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682487593"><span class="hs-identifier hs-var">epoch</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; EpochNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletDelegation -&gt; SqlPersistT IO WalletDelegation
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(WalletDelegation -&gt; SqlPersistT IO WalletDelegation)
-&gt; WalletDelegation -&gt; SqlPersistT IO WalletDelegation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletDelegationStatus
-&gt; [WalletDelegationNext] -&gt; WalletDelegation
</span><a href="Cardano.Wallet.Primitive.Types.html#WalletDelegation"><span class="hs-identifier hs-var">W.WalletDelegation</span></a></span><span> </span><span class="annot"><span class="annottext">WalletDelegationStatus
</span><a href="Cardano.Wallet.Primitive.Types.html#NotDelegating"><span class="hs-identifier hs-var">W.NotDelegating</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-854"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-855"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682487590"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487590"><span class="hs-identifier hs-var">eMinus1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682487589"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487589"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (SlotNo, SlotNo) -&gt; ReaderT SqlBackend IO (SlotNo, SlotNo)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (SlotNo, SlotNo) -&gt; ReaderT SqlBackend IO (SlotNo, SlotNo))
-&gt; IO (SlotNo, SlotNo) -&gt; ReaderT SqlBackend IO (SlotNo, SlotNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO -&gt; Qry (SlotNo, SlotNo) -&gt; IO (SlotNo, SlotNo)
forall (m :: * -&gt; *) a.
(HasCallStack, Monad m) =&gt;
TimeInterpreter m -&gt; Qry a -&gt; m a
</span><a href="Cardano.Wallet.Primitive.Slotting.html#interpretQuery"><span class="hs-identifier hs-var">interpretQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682487595"><span class="hs-identifier hs-var">ti</span></a></span><span> </span><span class="annot"><span class="annottext">(Qry (SlotNo, SlotNo) -&gt; IO (SlotNo, SlotNo))
-&gt; Qry (SlotNo, SlotNo) -&gt; IO (SlotNo, SlotNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-856"></span><span>            </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; SlotNo -&gt; (SlotNo, SlotNo))
-&gt; Qry SlotNo -&gt; Qry (SlotNo -&gt; (SlotNo, SlotNo))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; Qry SlotNo
</span><a href="Cardano.Wallet.Primitive.Slotting.html#firstSlotInEpoch"><span class="hs-identifier hs-var">firstSlotInEpoch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682487593"><span class="hs-identifier hs-var">epoch</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; EpochNo -&gt; EpochNo
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Qry (SlotNo -&gt; (SlotNo, SlotNo))
-&gt; Qry SlotNo -&gt; Qry (SlotNo, SlotNo)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; Qry SlotNo
</span><a href="Cardano.Wallet.Primitive.Slotting.html#firstSlotInEpoch"><span class="hs-identifier hs-var">firstSlotInEpoch</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682487593"><span class="hs-identifier hs-var">epoch</span></a></span><span>
</span><span id="line-857"></span><span>        </span><span id="local-6989586621682487588"><span class="annot"><span class="annottext">WalletDelegationStatus
</span><a href="#local-6989586621682487588"><span class="hs-identifier hs-var">active</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WalletDelegationStatus
-&gt; (DelegationCertificate -&gt; WalletDelegationStatus)
-&gt; Maybe DelegationCertificate
-&gt; WalletDelegationStatus
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">WalletDelegationStatus
</span><a href="Cardano.Wallet.Primitive.Types.html#NotDelegating"><span class="hs-identifier hs-var">W.NotDelegating</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationCertificate -&gt; WalletDelegationStatus
</span><a href="Cardano.Wallet.DB.Layer.html#toWalletDelegationStatus"><span class="hs-identifier hs-var">toWalletDelegationStatus</span></a></span><span>
</span><span id="line-858"></span><span>            </span><span class="annot"><span class="annottext">(Maybe DelegationCertificate -&gt; WalletDelegationStatus)
-&gt; ReaderT SqlBackend IO (Maybe DelegationCertificate)
-&gt; ReaderT SqlBackend IO WalletDelegationStatus
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; [Filter DelegationCertificate]
-&gt; ReaderT SqlBackend IO (Maybe DelegationCertificate)
</span><a href="Cardano.Wallet.DB.Layer.html#readDelegationCertificate"><span class="hs-identifier hs-var">readDelegationCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487594"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-859"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField DelegationCertificate SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField DelegationCertificate typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CertSlot"><span class="hs-identifier hs-var">CertSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField DelegationCertificate SlotNo
-&gt; SlotNo -&gt; Filter DelegationCertificate
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487590"><span class="hs-identifier hs-var">eMinus1</span></a></span><span>
</span><span id="line-860"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-861"></span><span>
</span><span id="line-862"></span><span>        </span><span id="local-6989586621682487585"><span class="annot"><span class="annottext">[WalletDelegationNext]
</span><a href="#local-6989586621682487585"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Maybe WalletDelegationNext] -&gt; [WalletDelegationNext]
forall a. [Maybe a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">catMaybes</span></a></span><span> </span><span class="annot"><span class="annottext">([Maybe WalletDelegationNext] -&gt; [WalletDelegationNext])
-&gt; ReaderT SqlBackend IO [Maybe WalletDelegationNext]
-&gt; ReaderT SqlBackend IO [WalletDelegationNext]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[ReaderT SqlBackend IO (Maybe WalletDelegationNext)]
-&gt; ReaderT SqlBackend IO [Maybe WalletDelegationNext]
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">sequence</span></a></span><span>
</span><span id="line-863"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">(DelegationCertificate -&gt; WalletDelegationNext)
-&gt; Maybe DelegationCertificate -&gt; Maybe WalletDelegationNext
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpochNo -&gt; WalletDelegationStatus -&gt; WalletDelegationNext
</span><a href="Cardano.Wallet.Primitive.Types.html#WalletDelegationNext"><span class="hs-identifier hs-var">W.WalletDelegationNext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682487593"><span class="hs-identifier hs-var">epoch</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; EpochNo -&gt; EpochNo
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(WalletDelegationStatus -&gt; WalletDelegationNext)
-&gt; (DelegationCertificate -&gt; WalletDelegationStatus)
-&gt; DelegationCertificate
-&gt; WalletDelegationNext
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationCertificate -&gt; WalletDelegationStatus
</span><a href="Cardano.Wallet.DB.Layer.html#toWalletDelegationStatus"><span class="hs-identifier hs-var">toWalletDelegationStatus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-864"></span><span>                </span><span class="annot"><span class="annottext">(Maybe DelegationCertificate -&gt; Maybe WalletDelegationNext)
-&gt; ReaderT SqlBackend IO (Maybe DelegationCertificate)
-&gt; ReaderT SqlBackend IO (Maybe WalletDelegationNext)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; [Filter DelegationCertificate]
-&gt; ReaderT SqlBackend IO (Maybe DelegationCertificate)
</span><a href="Cardano.Wallet.DB.Layer.html#readDelegationCertificate"><span class="hs-identifier hs-var">readDelegationCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487594"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-865"></span><span>                    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField DelegationCertificate SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField DelegationCertificate typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CertSlot"><span class="hs-identifier hs-var">CertSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField DelegationCertificate SlotNo
-&gt; SlotNo -&gt; Filter DelegationCertificate
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">&gt;=.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487590"><span class="hs-identifier hs-var">eMinus1</span></a></span><span>
</span><span id="line-866"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField DelegationCertificate SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField DelegationCertificate typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CertSlot"><span class="hs-identifier hs-var">CertSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField DelegationCertificate SlotNo
-&gt; SlotNo -&gt; Filter DelegationCertificate
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487589"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-867"></span><span>                    </span><span class="hs-special">]</span><span>
</span><span id="line-868"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(DelegationCertificate -&gt; WalletDelegationNext)
-&gt; Maybe DelegationCertificate -&gt; Maybe WalletDelegationNext
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpochNo -&gt; WalletDelegationStatus -&gt; WalletDelegationNext
</span><a href="Cardano.Wallet.Primitive.Types.html#WalletDelegationNext"><span class="hs-identifier hs-var">W.WalletDelegationNext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682487593"><span class="hs-identifier hs-var">epoch</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; EpochNo -&gt; EpochNo
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(WalletDelegationStatus -&gt; WalletDelegationNext)
-&gt; (DelegationCertificate -&gt; WalletDelegationStatus)
-&gt; DelegationCertificate
-&gt; WalletDelegationNext
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DelegationCertificate -&gt; WalletDelegationStatus
</span><a href="Cardano.Wallet.DB.Layer.html#toWalletDelegationStatus"><span class="hs-identifier hs-var">toWalletDelegationStatus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-869"></span><span>                </span><span class="annot"><span class="annottext">(Maybe DelegationCertificate -&gt; Maybe WalletDelegationNext)
-&gt; ReaderT SqlBackend IO (Maybe DelegationCertificate)
-&gt; ReaderT SqlBackend IO (Maybe WalletDelegationNext)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
-&gt; [Filter DelegationCertificate]
-&gt; ReaderT SqlBackend IO (Maybe DelegationCertificate)
</span><a href="Cardano.Wallet.DB.Layer.html#readDelegationCertificate"><span class="hs-identifier hs-var">readDelegationCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487594"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-870"></span><span>                    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField DelegationCertificate SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField DelegationCertificate typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CertSlot"><span class="hs-identifier hs-var">CertSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField DelegationCertificate SlotNo
-&gt; SlotNo -&gt; Filter DelegationCertificate
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">&gt;=.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487589"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-871"></span><span>                    </span><span class="hs-special">]</span><span>
</span><span id="line-872"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-873"></span><span>
</span><span id="line-874"></span><span>        </span><span class="annot"><span class="annottext">WalletDelegation -&gt; SqlPersistT IO WalletDelegation
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(WalletDelegation -&gt; SqlPersistT IO WalletDelegation)
-&gt; WalletDelegation -&gt; SqlPersistT IO WalletDelegation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletDelegationStatus
-&gt; [WalletDelegationNext] -&gt; WalletDelegation
</span><a href="Cardano.Wallet.Primitive.Types.html#WalletDelegation"><span class="hs-identifier hs-var">W.WalletDelegation</span></a></span><span> </span><span class="annot"><span class="annottext">WalletDelegationStatus
</span><a href="#local-6989586621682487588"><span class="hs-identifier hs-var">active</span></a></span><span> </span><span class="annot"><span class="annottext">[WalletDelegationNext]
</span><a href="#local-6989586621682487585"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-875"></span><span>
</span><span id="line-876"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#readDelegationCertificate"><span class="hs-identifier hs-type">readDelegationCertificate</span></a></span><span>
</span><span id="line-877"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-878"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#DelegationCertificate"><span class="hs-identifier hs-type">DelegationCertificate</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-879"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#DelegationCertificate"><span class="hs-identifier hs-type">DelegationCertificate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-880"></span><span id="readDelegationCertificate"><span class="annot"><span class="annottext">readDelegationCertificate :: WalletId
-&gt; [Filter DelegationCertificate]
-&gt; ReaderT SqlBackend IO (Maybe DelegationCertificate)
</span><a href="Cardano.Wallet.DB.Layer.html#readDelegationCertificate"><span class="hs-identifier hs-var hs-var">readDelegationCertificate</span></a></span></span><span> </span><span id="local-6989586621682487581"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487581"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487580"><span class="annot"><span class="annottext">[Filter DelegationCertificate]
</span><a href="#local-6989586621682487580"><span class="hs-identifier hs-var">filters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Entity DelegationCertificate -&gt; DelegationCertificate)
-&gt; Maybe (Entity DelegationCertificate)
-&gt; Maybe DelegationCertificate
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Entity DelegationCertificate -&gt; DelegationCertificate
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span>
</span><span id="line-881"></span><span>    </span><span class="annot"><span class="annottext">(Maybe (Entity DelegationCertificate)
 -&gt; Maybe DelegationCertificate)
-&gt; ReaderT SqlBackend IO (Maybe (Entity DelegationCertificate))
-&gt; ReaderT SqlBackend IO (Maybe DelegationCertificate)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter DelegationCertificate]
-&gt; [SelectOpt DelegationCertificate]
-&gt; ReaderT SqlBackend IO (Maybe (Entity DelegationCertificate))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityField DelegationCertificate WalletId
forall typ.
(typ ~ WalletId) =&gt;
EntityField DelegationCertificate typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CertWalletId"><span class="hs-identifier hs-var">CertWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField DelegationCertificate WalletId
-&gt; WalletId -&gt; Filter DelegationCertificate
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487581"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Filter DelegationCertificate
-&gt; [Filter DelegationCertificate] -&gt; [Filter DelegationCertificate]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter DelegationCertificate]
</span><a href="#local-6989586621682487580"><span class="hs-identifier hs-var">filters</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField DelegationCertificate SlotNo
-&gt; SelectOpt DelegationCertificate
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Desc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField DelegationCertificate SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField DelegationCertificate typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CertSlot"><span class="hs-identifier hs-var">CertSlot</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-882"></span><span>
</span><span id="line-883"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Conversion between types
        from the `persistent` database (Cardano.Wallet.DB.Sqlite.Schema)
        and from the wallet core ( Cardano.Wallet.Primitive.Types.*)
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-888"></span><span>
</span><span id="line-889"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#toWalletDelegationStatus"><span class="hs-identifier hs-type">toWalletDelegationStatus</span></a></span><span>
</span><span id="line-890"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#DelegationCertificate"><span class="hs-identifier hs-type">DelegationCertificate</span></a></span><span>
</span><span id="line-891"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletDelegationStatus"><span class="hs-identifier hs-type">W.WalletDelegationStatus</span></a></span><span>
</span><span id="line-892"></span><span id="toWalletDelegationStatus"><span class="annot"><span class="annottext">toWalletDelegationStatus :: DelegationCertificate -&gt; WalletDelegationStatus
</span><a href="Cardano.Wallet.DB.Layer.html#toWalletDelegationStatus"><span class="hs-identifier hs-var hs-var">toWalletDelegationStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-893"></span><span>    </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#DelegationCertificate"><span class="hs-identifier hs-type">DelegationCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe PoolId
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-894"></span><span>        </span><span class="annot"><span class="annottext">WalletDelegationStatus
</span><a href="Cardano.Wallet.Primitive.Types.html#NotDelegating"><span class="hs-identifier hs-var">W.NotDelegating</span></a></span><span>
</span><span id="line-895"></span><span>    </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#DelegationCertificate"><span class="hs-identifier hs-type">DelegationCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682487578"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682487578"><span class="hs-identifier hs-var">pool</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-896"></span><span>        </span><span class="annot"><span class="annottext">PoolId -&gt; WalletDelegationStatus
</span><a href="Cardano.Wallet.Primitive.Types.html#Delegating"><span class="hs-identifier hs-var">W.Delegating</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682487578"><span class="hs-identifier hs-var">pool</span></a></span><span>
</span><span id="line-897"></span><span>
</span><span id="line-898"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#mkWalletEntity"><span class="hs-identifier hs-type">mkWalletEntity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletMetadata"><span class="hs-identifier hs-type">W.WalletMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#GenesisParameters"><span class="hs-identifier hs-type">W.GenesisParameters</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Wallet"><span class="hs-identifier hs-type">Wallet</span></a></span><span>
</span><span id="line-899"></span><span id="mkWalletEntity"><span class="annot"><span class="annottext">mkWalletEntity :: WalletId -&gt; WalletMetadata -&gt; GenesisParameters -&gt; Wallet
</span><a href="Cardano.Wallet.DB.Layer.html#mkWalletEntity"><span class="hs-identifier hs-var hs-var">mkWalletEntity</span></a></span></span><span> </span><span id="local-6989586621682487576"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487576"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487575"><span class="annot"><span class="annottext">WalletMetadata
</span><a href="#local-6989586621682487575"><span class="hs-identifier hs-var">meta</span></a></span></span><span> </span><span id="local-6989586621682487574"><span class="annot"><span class="annottext">GenesisParameters
</span><a href="#local-6989586621682487574"><span class="hs-identifier hs-var">gp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Wallet :: WalletId
-&gt; UTCTime
-&gt; Text
-&gt; Maybe UTCTime
-&gt; Maybe PassphraseScheme
-&gt; BlockId
-&gt; UTCTime
-&gt; Wallet
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Wallet"><span class="hs-identifier hs-type">Wallet</span></a></span><span>
</span><span id="line-900"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">walId :: WalletId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#walId"><span class="hs-identifier hs-var">walId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487576"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-901"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">walName :: Text
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#walName"><span class="hs-identifier hs-var">walName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletMetadata
</span><a href="#local-6989586621682487575"><span class="hs-identifier hs-var">meta</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
-&gt; ((Text -&gt; Const Text Text)
    -&gt; WalletMetadata -&gt; Const Text WalletMetadata)
-&gt; Text
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;name&quot;
  ((WalletName -&gt; Const Text WalletName)
   -&gt; WalletMetadata -&gt; Const Text WalletMetadata)
(WalletName -&gt; Const Text WalletName)
-&gt; WalletMetadata -&gt; Const Text WalletMetadata
</span><a href="#local-6989586621682487570"><span class="hs-var">#name</span></a></span><span> </span><span class="annot"><span class="annottext">((WalletName -&gt; Const Text WalletName)
 -&gt; WalletMetadata -&gt; Const Text WalletMetadata)
-&gt; ((Text -&gt; Const Text Text)
    -&gt; WalletName -&gt; Const Text WalletName)
-&gt; (Text -&gt; Const Text Text)
-&gt; WalletMetadata
-&gt; Const Text WalletMetadata
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Const Text Text) -&gt; WalletName -&gt; Const Text WalletName
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">coerce</span></a></span><span>
</span><span id="line-902"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">walCreationTime :: UTCTime
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#walCreationTime"><span class="hs-identifier hs-var">walCreationTime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletMetadata
</span><a href="#local-6989586621682487575"><span class="hs-identifier hs-var">meta</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
-&gt; ((UTCTime -&gt; Const UTCTime UTCTime)
    -&gt; WalletMetadata -&gt; Const UTCTime WalletMetadata)
-&gt; UTCTime
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;creationTime&quot;
  ((UTCTime -&gt; Const UTCTime UTCTime)
   -&gt; WalletMetadata -&gt; Const UTCTime WalletMetadata)
(UTCTime -&gt; Const UTCTime UTCTime)
-&gt; WalletMetadata -&gt; Const UTCTime WalletMetadata
</span><a href="#local-6989586621682487568"><span class="hs-var">#creationTime</span></a></span><span>
</span><span id="line-903"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">walPassphraseLastUpdatedAt :: Maybe UTCTime
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#walPassphraseLastUpdatedAt"><span class="hs-identifier hs-var">walPassphraseLastUpdatedAt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletPassphraseInfo -&gt; UTCTime
</span><a href="Cardano.Wallet.Primitive.Passphrase.Types.html#lastUpdatedAt"><span class="hs-identifier hs-var hs-var">W.lastUpdatedAt</span></a></span><span> </span><span class="annot"><span class="annottext">(WalletPassphraseInfo -&gt; UTCTime)
-&gt; Maybe WalletPassphraseInfo -&gt; Maybe UTCTime
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
</span><a href="#local-6989586621682487575"><span class="hs-identifier hs-var">meta</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
-&gt; ((Maybe WalletPassphraseInfo
     -&gt; Const (Maybe WalletPassphraseInfo) (Maybe WalletPassphraseInfo))
    -&gt; WalletMetadata
    -&gt; Const (Maybe WalletPassphraseInfo) WalletMetadata)
-&gt; Maybe WalletPassphraseInfo
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;passphraseInfo&quot;
  ((Maybe WalletPassphraseInfo
    -&gt; Const (Maybe WalletPassphraseInfo) (Maybe WalletPassphraseInfo))
   -&gt; WalletMetadata
   -&gt; Const (Maybe WalletPassphraseInfo) WalletMetadata)
(Maybe WalletPassphraseInfo
 -&gt; Const (Maybe WalletPassphraseInfo) (Maybe WalletPassphraseInfo))
-&gt; WalletMetadata
-&gt; Const (Maybe WalletPassphraseInfo) WalletMetadata
</span><a href="#local-6989586621682487565"><span class="hs-var">#passphraseInfo</span></a></span><span>
</span><span id="line-904"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">walPassphraseScheme :: Maybe PassphraseScheme
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#walPassphraseScheme"><span class="hs-identifier hs-var">walPassphraseScheme</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletPassphraseInfo -&gt; PassphraseScheme
</span><a href="Cardano.Wallet.Primitive.Passphrase.Types.html#passphraseScheme"><span class="hs-identifier hs-var hs-var">W.passphraseScheme</span></a></span><span> </span><span class="annot"><span class="annottext">(WalletPassphraseInfo -&gt; PassphraseScheme)
-&gt; Maybe WalletPassphraseInfo -&gt; Maybe PassphraseScheme
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
</span><a href="#local-6989586621682487575"><span class="hs-identifier hs-var">meta</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
-&gt; ((Maybe WalletPassphraseInfo
     -&gt; Const (Maybe WalletPassphraseInfo) (Maybe WalletPassphraseInfo))
    -&gt; WalletMetadata
    -&gt; Const (Maybe WalletPassphraseInfo) WalletMetadata)
-&gt; Maybe WalletPassphraseInfo
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;passphraseInfo&quot;
  ((Maybe WalletPassphraseInfo
    -&gt; Const (Maybe WalletPassphraseInfo) (Maybe WalletPassphraseInfo))
   -&gt; WalletMetadata
   -&gt; Const (Maybe WalletPassphraseInfo) WalletMetadata)
(Maybe WalletPassphraseInfo
 -&gt; Const (Maybe WalletPassphraseInfo) (Maybe WalletPassphraseInfo))
-&gt; WalletMetadata
-&gt; Const (Maybe WalletPassphraseInfo) WalletMetadata
</span><a href="#local-6989586621682487562"><span class="hs-var">#passphraseInfo</span></a></span><span>
</span><span id="line-905"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">walGenesisHash :: BlockId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#walGenesisHash"><span class="hs-identifier hs-var">walGenesisHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash &quot;BlockHeader&quot; -&gt; BlockId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#BlockId"><span class="hs-identifier hs-var">BlockId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash &quot;Genesis&quot; -&gt; Hash &quot;BlockHeader&quot;
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">coerce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenesisParameters
</span><a href="#local-6989586621682487574"><span class="hs-identifier hs-var">gp</span></a></span><span> </span><span class="annot"><span class="annottext">GenesisParameters
-&gt; ((Hash &quot;Genesis&quot; -&gt; Const (Hash &quot;Genesis&quot;) (Hash &quot;Genesis&quot;))
    -&gt; GenesisParameters -&gt; Const (Hash &quot;Genesis&quot;) GenesisParameters)
-&gt; Hash &quot;Genesis&quot;
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;getGenesisBlockHash&quot;
  ((Hash &quot;Genesis&quot; -&gt; Const (Hash &quot;Genesis&quot;) (Hash &quot;Genesis&quot;))
   -&gt; GenesisParameters -&gt; Const (Hash &quot;Genesis&quot;) GenesisParameters)
(Hash &quot;Genesis&quot; -&gt; Const (Hash &quot;Genesis&quot;) (Hash &quot;Genesis&quot;))
-&gt; GenesisParameters -&gt; Const (Hash &quot;Genesis&quot;) GenesisParameters
</span><a href="#local-6989586621682487559"><span class="hs-var">#getGenesisBlockHash</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-906"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">walGenesisStart :: UTCTime
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#walGenesisStart"><span class="hs-identifier hs-var">walGenesisStart</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StartTime -&gt; UTCTime
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">coerce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenesisParameters
</span><a href="#local-6989586621682487574"><span class="hs-identifier hs-var">gp</span></a></span><span> </span><span class="annot"><span class="annottext">GenesisParameters
-&gt; ((StartTime -&gt; Const StartTime StartTime)
    -&gt; GenesisParameters -&gt; Const StartTime GenesisParameters)
-&gt; StartTime
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;getGenesisBlockDate&quot;
  ((StartTime -&gt; Const StartTime StartTime)
   -&gt; GenesisParameters -&gt; Const StartTime GenesisParameters)
(StartTime -&gt; Const StartTime StartTime)
-&gt; GenesisParameters -&gt; Const StartTime GenesisParameters
</span><a href="#local-6989586621682487557"><span class="hs-var">#getGenesisBlockDate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-907"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-908"></span><span>
</span><span id="line-909"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#mkWalletMetadataUpdate"><span class="hs-identifier hs-type">mkWalletMetadataUpdate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletMetadata"><span class="hs-identifier hs-type">W.WalletMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Wallet"><span class="hs-identifier hs-type">Wallet</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-910"></span><span id="mkWalletMetadataUpdate"><span class="annot"><span class="annottext">mkWalletMetadataUpdate :: WalletMetadata -&gt; [Update Wallet]
</span><a href="Cardano.Wallet.DB.Layer.html#mkWalletMetadataUpdate"><span class="hs-identifier hs-var hs-var">mkWalletMetadataUpdate</span></a></span></span><span> </span><span id="local-6989586621682487556"><span class="annot"><span class="annottext">WalletMetadata
</span><a href="#local-6989586621682487556"><span class="hs-identifier hs-var">meta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-911"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField Wallet Text
forall typ. (typ ~ Text) =&gt; EntityField Wallet typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#WalName"><span class="hs-identifier hs-var">WalName</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Wallet Text -&gt; Text -&gt; Update Wallet
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Update v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">=.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
</span><a href="#local-6989586621682487556"><span class="hs-identifier hs-var">meta</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
-&gt; ((Text -&gt; Const Text Text)
    -&gt; WalletMetadata -&gt; Const Text WalletMetadata)
-&gt; Text
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;name&quot;
  ((WalletName -&gt; Const Text WalletName)
   -&gt; WalletMetadata -&gt; Const Text WalletMetadata)
(WalletName -&gt; Const Text WalletName)
-&gt; WalletMetadata -&gt; Const Text WalletMetadata
</span><a href="#local-6989586621682487554"><span class="hs-var">#name</span></a></span><span> </span><span class="annot"><span class="annottext">((WalletName -&gt; Const Text WalletName)
 -&gt; WalletMetadata -&gt; Const Text WalletMetadata)
-&gt; ((Text -&gt; Const Text Text)
    -&gt; WalletName -&gt; Const Text WalletName)
-&gt; (Text -&gt; Const Text Text)
-&gt; WalletMetadata
-&gt; Const Text WalletMetadata
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Const Text Text) -&gt; WalletName -&gt; Const Text WalletName
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">coerce</span></a></span><span>
</span><span id="line-912"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField Wallet UTCTime
forall typ. (typ ~ UTCTime) =&gt; EntityField Wallet typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#WalCreationTime"><span class="hs-identifier hs-var">WalCreationTime</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Wallet UTCTime -&gt; UTCTime -&gt; Update Wallet
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Update v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">=.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
</span><a href="#local-6989586621682487556"><span class="hs-identifier hs-var">meta</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
-&gt; ((UTCTime -&gt; Const UTCTime UTCTime)
    -&gt; WalletMetadata -&gt; Const UTCTime WalletMetadata)
-&gt; UTCTime
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;creationTime&quot;
  ((UTCTime -&gt; Const UTCTime UTCTime)
   -&gt; WalletMetadata -&gt; Const UTCTime WalletMetadata)
(UTCTime -&gt; Const UTCTime UTCTime)
-&gt; WalletMetadata -&gt; Const UTCTime WalletMetadata
</span><a href="#local-6989586621682487552"><span class="hs-var">#creationTime</span></a></span><span>
</span><span id="line-913"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField Wallet (Maybe UTCTime)
forall typ. (typ ~ Maybe UTCTime) =&gt; EntityField Wallet typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#WalPassphraseLastUpdatedAt"><span class="hs-identifier hs-var">WalPassphraseLastUpdatedAt</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Wallet (Maybe UTCTime)
-&gt; Maybe UTCTime -&gt; Update Wallet
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Update v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">=.</span></a></span><span>
</span><span id="line-914"></span><span>        </span><span class="annot"><span class="annottext">WalletPassphraseInfo -&gt; UTCTime
</span><a href="Cardano.Wallet.Primitive.Passphrase.Types.html#lastUpdatedAt"><span class="hs-identifier hs-var hs-var">W.lastUpdatedAt</span></a></span><span> </span><span class="annot"><span class="annottext">(WalletPassphraseInfo -&gt; UTCTime)
-&gt; Maybe WalletPassphraseInfo -&gt; Maybe UTCTime
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
</span><a href="#local-6989586621682487556"><span class="hs-identifier hs-var">meta</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
-&gt; ((Maybe WalletPassphraseInfo
     -&gt; Const (Maybe WalletPassphraseInfo) (Maybe WalletPassphraseInfo))
    -&gt; WalletMetadata
    -&gt; Const (Maybe WalletPassphraseInfo) WalletMetadata)
-&gt; Maybe WalletPassphraseInfo
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;passphraseInfo&quot;
  ((Maybe WalletPassphraseInfo
    -&gt; Const (Maybe WalletPassphraseInfo) (Maybe WalletPassphraseInfo))
   -&gt; WalletMetadata
   -&gt; Const (Maybe WalletPassphraseInfo) WalletMetadata)
(Maybe WalletPassphraseInfo
 -&gt; Const (Maybe WalletPassphraseInfo) (Maybe WalletPassphraseInfo))
-&gt; WalletMetadata
-&gt; Const (Maybe WalletPassphraseInfo) WalletMetadata
</span><a href="#local-6989586621682487550"><span class="hs-var">#passphraseInfo</span></a></span><span>
</span><span id="line-915"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField Wallet (Maybe PassphraseScheme)
forall typ.
(typ ~ Maybe PassphraseScheme) =&gt;
EntityField Wallet typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#WalPassphraseScheme"><span class="hs-identifier hs-var">WalPassphraseScheme</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Wallet (Maybe PassphraseScheme)
-&gt; Maybe PassphraseScheme -&gt; Update Wallet
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Update v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">=.</span></a></span><span>
</span><span id="line-916"></span><span>        </span><span class="annot"><span class="annottext">WalletPassphraseInfo -&gt; PassphraseScheme
</span><a href="Cardano.Wallet.Primitive.Passphrase.Types.html#passphraseScheme"><span class="hs-identifier hs-var hs-var">W.passphraseScheme</span></a></span><span> </span><span class="annot"><span class="annottext">(WalletPassphraseInfo -&gt; PassphraseScheme)
-&gt; Maybe WalletPassphraseInfo -&gt; Maybe PassphraseScheme
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
</span><a href="#local-6989586621682487556"><span class="hs-identifier hs-var">meta</span></a></span><span> </span><span class="annot"><span class="annottext">WalletMetadata
-&gt; ((Maybe WalletPassphraseInfo
     -&gt; Const (Maybe WalletPassphraseInfo) (Maybe WalletPassphraseInfo))
    -&gt; WalletMetadata
    -&gt; Const (Maybe WalletPassphraseInfo) WalletMetadata)
-&gt; Maybe WalletPassphraseInfo
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;passphraseInfo&quot;
  ((Maybe WalletPassphraseInfo
    -&gt; Const (Maybe WalletPassphraseInfo) (Maybe WalletPassphraseInfo))
   -&gt; WalletMetadata
   -&gt; Const (Maybe WalletPassphraseInfo) WalletMetadata)
(Maybe WalletPassphraseInfo
 -&gt; Const (Maybe WalletPassphraseInfo) (Maybe WalletPassphraseInfo))
-&gt; WalletMetadata
-&gt; Const (Maybe WalletPassphraseInfo) WalletMetadata
</span><a href="#local-6989586621682487548"><span class="hs-var">#passphraseInfo</span></a></span><span>
</span><span id="line-917"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-918"></span><span>
</span><span id="line-919"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#metadataFromEntity"><span class="hs-identifier hs-type">metadataFromEntity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletDelegation"><span class="hs-identifier hs-type">W.WalletDelegation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Wallet"><span class="hs-identifier hs-type">Wallet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletMetadata"><span class="hs-identifier hs-type">W.WalletMetadata</span></a></span><span>
</span><span id="line-920"></span><span id="metadataFromEntity"><span class="annot"><span class="annottext">metadataFromEntity :: WalletDelegation -&gt; Wallet -&gt; WalletMetadata
</span><a href="Cardano.Wallet.DB.Layer.html#metadataFromEntity"><span class="hs-identifier hs-var hs-var">metadataFromEntity</span></a></span></span><span> </span><span id="local-6989586621682487547"><span class="annot"><span class="annottext">WalletDelegation
</span><a href="#local-6989586621682487547"><span class="hs-identifier hs-var">walDelegation</span></a></span></span><span> </span><span id="local-6989586621682487546"><span class="annot"><span class="annottext">Wallet
</span><a href="#local-6989586621682487546"><span class="hs-identifier hs-var">wal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletMetadata :: WalletName
-&gt; UTCTime
-&gt; Maybe WalletPassphraseInfo
-&gt; WalletDelegation
-&gt; WalletMetadata
</span><a href="Cardano.Wallet.Primitive.Types.html#WalletMetadata"><span class="hs-identifier hs-type">W.WalletMetadata</span></a></span><span>
</span><span id="line-921"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:name:WalletMetadata :: WalletName
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3Aname%3AWalletMetadata"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; WalletName
</span><a href="Cardano.Wallet.Primitive.Types.html#WalletName"><span class="hs-identifier hs-var">W.WalletName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Wallet -&gt; Text
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#walName"><span class="hs-identifier hs-var hs-var">walName</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet
</span><a href="#local-6989586621682487546"><span class="hs-identifier hs-var">wal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-922"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:creationTime:WalletMetadata :: UTCTime
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AcreationTime%3AWalletMetadata"><span class="hs-identifier hs-var">creationTime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Wallet -&gt; UTCTime
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#walCreationTime"><span class="hs-identifier hs-var hs-var">walCreationTime</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet
</span><a href="#local-6989586621682487546"><span class="hs-identifier hs-var">wal</span></a></span><span>
</span><span id="line-923"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:passphraseInfo:WalletMetadata :: Maybe WalletPassphraseInfo
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3ApassphraseInfo%3AWalletMetadata"><span class="hs-identifier hs-var">passphraseInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; PassphraseScheme -&gt; WalletPassphraseInfo
</span><a href="Cardano.Wallet.Primitive.Passphrase.Types.html#WalletPassphraseInfo"><span class="hs-identifier hs-var">W.WalletPassphraseInfo</span></a></span><span>
</span><span id="line-924"></span><span>        </span><span class="annot"><span class="annottext">(UTCTime -&gt; PassphraseScheme -&gt; WalletPassphraseInfo)
-&gt; Maybe UTCTime
-&gt; Maybe (PassphraseScheme -&gt; WalletPassphraseInfo)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet -&gt; Maybe UTCTime
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#walPassphraseLastUpdatedAt"><span class="hs-identifier hs-var hs-var">walPassphraseLastUpdatedAt</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet
</span><a href="#local-6989586621682487546"><span class="hs-identifier hs-var">wal</span></a></span><span>
</span><span id="line-925"></span><span>        </span><span class="annot"><span class="annottext">Maybe (PassphraseScheme -&gt; WalletPassphraseInfo)
-&gt; Maybe PassphraseScheme -&gt; Maybe WalletPassphraseInfo
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet -&gt; Maybe PassphraseScheme
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#walPassphraseScheme"><span class="hs-identifier hs-var hs-var">walPassphraseScheme</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet
</span><a href="#local-6989586621682487546"><span class="hs-identifier hs-var">wal</span></a></span><span>
</span><span id="line-926"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:delegation:WalletMetadata :: WalletDelegation
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3Adelegation%3AWalletMetadata"><span class="hs-identifier hs-var">delegation</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletDelegation
</span><a href="#local-6989586621682487547"><span class="hs-identifier hs-var">walDelegation</span></a></span><span>
</span><span id="line-927"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-928"></span><span>
</span><span id="line-929"></span><span id="local-6989586621682488202"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#mkPrivateKeyEntity"><span class="hs-identifier hs-type">mkPrivateKeyEntity</span></a></span><span>
</span><span id="line-930"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPrivateKey"><span class="hs-identifier hs-type">PersistPrivateKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682488202"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#RootK"><span class="hs-identifier hs-type">RootK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-931"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-932"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682488202"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#RootK"><span class="hs-identifier hs-type">RootK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier hs-type">XPrv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Passphrase.Types.html#PassphraseHash"><span class="hs-identifier hs-type">W.PassphraseHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-933"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#PrivateKey"><span class="hs-identifier hs-type">PrivateKey</span></a></span></span><span>
</span><span id="line-934"></span><span id="mkPrivateKeyEntity"><span class="annot"><span class="annottext">mkPrivateKeyEntity :: WalletId -&gt; (k 'RootK XPrv, PassphraseHash) -&gt; PrivateKey
</span><a href="Cardano.Wallet.DB.Layer.html#mkPrivateKeyEntity"><span class="hs-identifier hs-var hs-var">mkPrivateKeyEntity</span></a></span></span><span> </span><span id="local-6989586621682487538"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487538"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487537"><span class="annot"><span class="annottext">(k 'RootK XPrv, PassphraseHash)
</span><a href="#local-6989586621682487537"><span class="hs-identifier hs-var">kh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrivateKey :: WalletId -&gt; ByteString -&gt; ByteString -&gt; PrivateKey
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#PrivateKey"><span class="hs-identifier hs-type">PrivateKey</span></a></span><span>
</span><span id="line-935"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">privateKeyWalletId :: WalletId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#privateKeyWalletId"><span class="hs-identifier hs-var">privateKeyWalletId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487538"><span class="hs-identifier hs-var">wid</span></a></span><span>
</span><span id="line-936"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">privateKeyRootKey :: ByteString
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#privateKeyRootKey"><span class="hs-identifier hs-var">privateKeyRootKey</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682487533"><span class="hs-identifier hs-var">root</span></a></span><span>
</span><span id="line-937"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">privateKeyHash :: ByteString
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#privateKeyHash"><span class="hs-identifier hs-var">privateKeyHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682487531"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-938"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-939"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-940"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682487533"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682487533"><span class="hs-identifier hs-var">root</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682487531"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682487531"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(k 'RootK XPrv, PassphraseHash) -&gt; (ByteString, ByteString)
forall (key :: * -&gt; *).
PersistPrivateKey key =&gt;
(key XPrv, PassphraseHash) -&gt; (ByteString, ByteString)
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#serializeXPrv"><span class="hs-identifier hs-var">serializeXPrv</span></a></span><span> </span><span class="annot"><span class="annottext">(k 'RootK XPrv, PassphraseHash)
</span><a href="#local-6989586621682487537"><span class="hs-identifier hs-var">kh</span></a></span><span>
</span><span id="line-941"></span><span>
</span><span id="line-942"></span><span id="local-6989586621682488124"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#privateKeyFromEntity"><span class="hs-identifier hs-type">privateKeyFromEntity</span></a></span><span>
</span><span id="line-943"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPrivateKey"><span class="hs-identifier hs-type">PersistPrivateKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682488124"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#RootK"><span class="hs-identifier hs-type">RootK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-944"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#PrivateKey"><span class="hs-identifier hs-type">PrivateKey</span></a></span><span>
</span><span id="line-945"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682488124"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#RootK"><span class="hs-identifier hs-type">RootK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier hs-type">XPrv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Passphrase.Types.html#PassphraseHash"><span class="hs-identifier hs-type">PassphraseHash</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-946"></span><span id="privateKeyFromEntity"><span class="annot"><span class="annottext">privateKeyFromEntity :: PrivateKey -&gt; (k 'RootK XPrv, PassphraseHash)
</span><a href="Cardano.Wallet.DB.Layer.html#privateKeyFromEntity"><span class="hs-identifier hs-var hs-var">privateKeyFromEntity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#PrivateKey"><span class="hs-identifier hs-type">PrivateKey</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682487528"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682487528"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621682487527"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682487527"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-947"></span><span>    </span><span class="annot"><span class="annottext">(ByteString, ByteString) -&gt; (k 'RootK XPrv, PassphraseHash)
forall (key :: * -&gt; *).
PersistPrivateKey key =&gt;
(ByteString, ByteString) -&gt; (key XPrv, PassphraseHash)
</span><a href="Cardano.Wallet.Primitive.AddressDerivation.html#unsafeDeserializeXPrv"><span class="hs-identifier hs-var">unsafeDeserializeXPrv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682487528"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621682487527"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-948"></span><span>
</span><span id="line-949"></span><span>
</span><span id="line-950"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#genesisParametersFromEntity"><span class="hs-identifier hs-type">genesisParametersFromEntity</span></a></span><span>
</span><span id="line-951"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Wallet"><span class="hs-identifier hs-type">Wallet</span></a></span><span>
</span><span id="line-952"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#GenesisParameters"><span class="hs-identifier hs-type">W.GenesisParameters</span></a></span><span>
</span><span id="line-953"></span><span id="genesisParametersFromEntity"><span class="annot"><span class="annottext">genesisParametersFromEntity :: Wallet -&gt; GenesisParameters
</span><a href="Cardano.Wallet.DB.Layer.html#genesisParametersFromEntity"><span class="hs-identifier hs-var hs-var">genesisParametersFromEntity</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Wallet"><span class="hs-identifier hs-type">Wallet</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe UTCTime
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe PassphraseScheme
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682487524"><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682487524"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span id="local-6989586621682487523"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621682487523"><span class="hs-identifier hs-var">startTime</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-954"></span><span>    </span><span class="annot"><span class="annottext">GenesisParameters :: Hash &quot;Genesis&quot; -&gt; StartTime -&gt; GenesisParameters
</span><a href="Cardano.Wallet.Primitive.Types.html#GenesisParameters"><span class="hs-identifier hs-type">W.GenesisParameters</span></a></span><span>
</span><span id="line-955"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:getGenesisBlockHash:GenesisParameters :: Hash &quot;Genesis&quot;
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AgetGenesisBlockHash%3AGenesisParameters"><span class="hs-identifier hs-var">W.getGenesisBlockHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash &quot;BlockHeader&quot; -&gt; Hash &quot;Genesis&quot;
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">coerce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockId -&gt; Hash &quot;BlockHeader&quot;
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#getBlockId"><span class="hs-identifier hs-var hs-var">getBlockId</span></a></span><span> </span><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682487524"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-956"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:getGenesisBlockDate:GenesisParameters :: StartTime
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AgetGenesisBlockDate%3AGenesisParameters"><span class="hs-identifier hs-var">W.getGenesisBlockDate</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; StartTime
</span><a href="Cardano.Wallet.Primitive.Types.html#StartTime"><span class="hs-identifier hs-var">W.StartTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621682487523"><span class="hs-identifier hs-var">startTime</span></a></span><span>
</span><span id="line-957"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-958"></span><span>
</span><span id="line-959"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    SQLite database operations
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-962"></span><span>
</span><span id="line-963"></span><span id="local-6989586621682488297"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#selectWallet"><span class="hs-identifier hs-type">selectWallet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488297"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488297"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#Wallet"><span class="hs-identifier hs-type">Wallet</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-964"></span><span id="selectWallet"><span class="annot"><span class="annottext">selectWallet :: WalletId -&gt; SqlPersistT m (Maybe Wallet)
</span><a href="Cardano.Wallet.DB.Layer.html#selectWallet"><span class="hs-identifier hs-var hs-var">selectWallet</span></a></span></span><span> </span><span id="local-6989586621682487517"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487517"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-965"></span><span>    </span><span class="annot"><span class="annottext">(Entity Wallet -&gt; Wallet) -&gt; Maybe (Entity Wallet) -&gt; Maybe Wallet
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Entity Wallet -&gt; Wallet
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Entity Wallet) -&gt; Maybe Wallet)
-&gt; ReaderT SqlBackend m (Maybe (Entity Wallet))
-&gt; SqlPersistT m (Maybe Wallet)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter Wallet]
-&gt; [SelectOpt Wallet]
-&gt; ReaderT SqlBackend m (Maybe (Entity Wallet))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField Wallet WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField Wallet typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#WalId"><span class="hs-identifier hs-var">WalId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Wallet WalletId -&gt; WalletId -&gt; Filter Wallet
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487517"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-966"></span><span>
</span><span id="line-967"></span><span class="hs-comment">-- | Delete stake key certificates for a wallet.</span><span>
</span><span id="line-968"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#deleteStakeKeyCerts"><span class="hs-identifier hs-type">deleteStakeKeyCerts</span></a></span><span>
</span><span id="line-969"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-970"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#StakeKeyCertificate"><span class="hs-identifier hs-type">StakeKeyCertificate</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-971"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-972"></span><span id="deleteStakeKeyCerts"><span class="annot"><span class="annottext">deleteStakeKeyCerts :: WalletId -&gt; [Filter StakeKeyCertificate] -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Layer.html#deleteStakeKeyCerts"><span class="hs-identifier hs-var hs-var">deleteStakeKeyCerts</span></a></span></span><span> </span><span id="local-6989586621682487516"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487516"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487515"><span class="annot"><span class="annottext">[Filter StakeKeyCertificate]
</span><a href="#local-6989586621682487515"><span class="hs-identifier hs-var">filters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-973"></span><span>    </span><span class="annot"><span class="annottext">[Filter StakeKeyCertificate] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityField StakeKeyCertificate WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField StakeKeyCertificate typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#StakeKeyCertWalletId"><span class="hs-identifier hs-var">StakeKeyCertWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField StakeKeyCertificate WalletId
-&gt; WalletId -&gt; Filter StakeKeyCertificate
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487516"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Filter StakeKeyCertificate
-&gt; [Filter StakeKeyCertificate] -&gt; [Filter StakeKeyCertificate]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter StakeKeyCertificate]
</span><a href="#local-6989586621682487515"><span class="hs-identifier hs-var">filters</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-974"></span><span>
</span><span id="line-975"></span><span class="hs-comment">-- | Delete all delegation certificates matching the given filter</span><span>
</span><span id="line-976"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#deleteDelegationCertificates"><span class="hs-identifier hs-type">deleteDelegationCertificates</span></a></span><span>
</span><span id="line-977"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-978"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#DelegationCertificate"><span class="hs-identifier hs-type">DelegationCertificate</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-979"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-980"></span><span id="deleteDelegationCertificates"><span class="annot"><span class="annottext">deleteDelegationCertificates :: WalletId -&gt; [Filter DelegationCertificate] -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Layer.html#deleteDelegationCertificates"><span class="hs-identifier hs-var hs-var">deleteDelegationCertificates</span></a></span></span><span> </span><span id="local-6989586621682487514"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487514"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487513"><span class="annot"><span class="annottext">[Filter DelegationCertificate]
</span><a href="#local-6989586621682487513"><span class="hs-identifier hs-var">filters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-981"></span><span>    </span><span class="annot"><span class="annottext">[Filter DelegationCertificate] -&gt; SqlPersistT IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityField DelegationCertificate WalletId
forall typ.
(typ ~ WalletId) =&gt;
EntityField DelegationCertificate typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#CertWalletId"><span class="hs-identifier hs-var">CertWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField DelegationCertificate WalletId
-&gt; WalletId -&gt; Filter DelegationCertificate
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487514"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Filter DelegationCertificate
-&gt; [Filter DelegationCertificate] -&gt; [Filter DelegationCertificate]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter DelegationCertificate]
</span><a href="#local-6989586621682487513"><span class="hs-identifier hs-var">filters</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-982"></span><span>
</span><span id="line-983"></span><span class="hs-comment">-- This relies on available information from the database to reconstruct coin</span><span>
</span><span id="line-984"></span><span class="hs-comment">-- selection information for __outgoing__ payments. We can't however guarantee</span><span>
</span><span id="line-985"></span><span class="hs-comment">-- that we have such information for __incoming__ payments (we usually don't</span><span>
</span><span id="line-986"></span><span class="hs-comment">-- have it).</span><span>
</span><span id="line-987"></span><span class="hs-comment">--</span><span>
</span><span id="line-988"></span><span class="hs-comment">-- To reliably provide this information for incoming payments, it should be</span><span>
</span><span id="line-989"></span><span class="hs-comment">-- looked up when applying blocks from the global ledger, but that is future</span><span>
</span><span id="line-990"></span><span class="hs-comment">-- work.</span><span>
</span><span id="line-991"></span><span class="hs-comment">--</span><span>
</span><span id="line-992"></span><span>
</span><span id="line-993"></span><span class="hs-comment">-- See also: issue #573.</span><span>
</span><span id="line-994"></span><span id="local-6989586621682488221"><span id="local-6989586621682488222"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#selectTxHistory"><span class="hs-identifier hs-type">selectTxHistory</span></a></span><span>
</span><span id="line-995"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488222"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-996"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Model.html#Wallet"><span class="hs-identifier hs-type">W.Wallet</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488221"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-997"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier hs-type">TimeInterpreter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488222"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-998"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-999"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Coin.html#Coin"><span class="hs-identifier hs-type">W.Coin</span></a></span><span>
</span><span id="line-1000"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#SortOrder"><span class="hs-identifier hs-type">W.SortOrder</span></a></span><span>
</span><span id="line-1001"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#TxMeta"><span class="hs-identifier hs-type">DB.TxMeta</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1002"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Wallets.Model.html#TxWalletsHistory"><span class="hs-identifier hs-type">TxWalletsHistory</span></a></span><span>
</span><span id="line-1003"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682488222"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#TransactionInfo"><span class="hs-identifier hs-type">W.TransactionInfo</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-1004"></span><span id="selectTxHistory"><span class="annot"><span class="annottext">selectTxHistory :: Wallet s
-&gt; TimeInterpreter m
-&gt; WalletId
-&gt; Maybe Coin
-&gt; SortOrder
-&gt; (TxMeta -&gt; Bool)
-&gt; (TxHistory, Map WalletId TxMetaHistory)
-&gt; m [TransactionInfo]
</span><a href="Cardano.Wallet.DB.Layer.html#selectTxHistory"><span class="hs-identifier hs-var hs-var">selectTxHistory</span></a></span></span><span> </span><span id="local-6989586621682487512"><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487512"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span id="local-6989586621682487511"><span class="annot"><span class="annottext">TimeInterpreter m
</span><a href="#local-6989586621682487511"><span class="hs-identifier hs-var">ti</span></a></span></span><span> </span><span id="local-6989586621682487510"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487510"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span id="local-6989586621682487509"><span class="annot"><span class="annottext">Maybe Coin
</span><a href="#local-6989586621682487509"><span class="hs-identifier hs-var">minWithdrawal</span></a></span></span><span> </span><span id="local-6989586621682487508"><span class="annot"><span class="annottext">SortOrder
</span><a href="#local-6989586621682487508"><span class="hs-identifier hs-var">order</span></a></span></span><span> </span><span id="local-6989586621682487507"><span class="annot"><span class="annottext">TxMeta -&gt; Bool
</span><a href="#local-6989586621682487507"><span class="hs-identifier hs-var">whichMeta</span></a></span></span><span>
</span><span id="line-1005"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682487506"><span class="annot"><span class="annottext">TxHistory
</span><a href="#local-6989586621682487506"><span class="hs-identifier hs-var">txHistory</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682487505"><span class="annot"><span class="annottext">Map WalletId TxMetaHistory
</span><a href="#local-6989586621682487505"><span class="hs-identifier hs-var">wmetas</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1006"></span><span>    </span><span id="local-6989586621682487504"><span class="annot"><span class="annottext">[TransactionInfo]
</span><a href="#local-6989586621682487504"><span class="hs-identifier hs-var">tinfos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((TxRelationF 'With, TxMeta) -&gt; m TransactionInfo)
-&gt; [(TxRelationF 'With, TxMeta)] -&gt; m [TransactionInfo]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TxRelationF 'With -&gt; TxMeta -&gt; m TransactionInfo)
-&gt; (TxRelationF 'With, TxMeta) -&gt; m TransactionInfo
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">uncurry</span></a></span><span> </span><span class="annot"><span class="annottext">((TxRelationF 'With -&gt; TxMeta -&gt; m TransactionInfo)
 -&gt; (TxRelationF 'With, TxMeta) -&gt; m TransactionInfo)
-&gt; (TxRelationF 'With -&gt; TxMeta -&gt; m TransactionInfo)
-&gt; (TxRelationF 'With, TxMeta)
-&gt; m TransactionInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter m
-&gt; BlockHeader -&gt; TxRelationF 'With -&gt; TxMeta -&gt; m TransactionInfo
forall (m :: * -&gt; *).
Monad m =&gt;
TimeInterpreter m
-&gt; BlockHeader -&gt; TxRelationF 'With -&gt; TxMeta -&gt; m TransactionInfo
</span><a href="Cardano.Wallet.DB.Store.Wallets.Model.html#mkTransactionInfo"><span class="hs-identifier hs-var">mkTransactionInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter m
</span><a href="#local-6989586621682487511"><span class="hs-identifier hs-var">ti</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Wallet s -&gt; BlockHeader
forall s. Wallet s -&gt; BlockHeader
</span><a href="Cardano.Wallet.Primitive.Model.html#%24sel%3AcurrentTip%3AWallet"><span class="hs-identifier hs-var hs-var">W.currentTip</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet s
</span><a href="#local-6989586621682487512"><span class="hs-identifier hs-var">cp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(TxRelationF 'With, TxMeta)] -&gt; m [TransactionInfo])
-&gt; [(TxRelationF 'With, TxMeta)] -&gt; m [TransactionInfo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1007"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Meta.Model.html#TxMetaHistory"><span class="hs-identifier hs-type">TxMetaHistory</span></a></span><span> </span><span id="local-6989586621682487500"><span class="annot"><span class="annottext">Map TxId TxMeta
</span><a href="#local-6989586621682487500"><span class="hs-identifier hs-var">metas</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe TxMetaHistory -&gt; [TxMetaHistory]
forall a. Maybe a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybeToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe TxMetaHistory -&gt; [TxMetaHistory])
-&gt; Maybe TxMetaHistory -&gt; [TxMetaHistory]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId -&gt; Map WalletId TxMetaHistory -&gt; Maybe TxMetaHistory
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487510"><span class="hs-identifier hs-var">wid</span></a></span><span> </span><span class="annot"><span class="annottext">Map WalletId TxMetaHistory
</span><a href="#local-6989586621682487505"><span class="hs-identifier hs-var">wmetas</span></a></span><span>
</span><span id="line-1008"></span><span>        </span><span id="local-6989586621682487499"><span class="annot"><span class="annottext">TxMeta
</span><a href="#local-6989586621682487499"><span class="hs-identifier hs-var">meta</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map TxId TxMeta -&gt; [TxMeta]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxId TxMeta
</span><a href="#local-6989586621682487500"><span class="hs-identifier hs-var">metas</span></a></span><span>
</span><span id="line-1009"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; [()]
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; [()]) -&gt; Bool -&gt; [()]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>  </span><span class="annot"><span class="annottext">TxMeta -&gt; Bool
</span><a href="#local-6989586621682487507"><span class="hs-identifier hs-var">whichMeta</span></a></span><span> </span><span class="annot"><span class="annottext">TxMeta
</span><a href="#local-6989586621682487499"><span class="hs-identifier hs-var">meta</span></a></span><span>
</span><span id="line-1010"></span><span>        </span><span id="local-6989586621682487498"><span class="annot"><span class="annottext">TxRelationF 'With
</span><a href="#local-6989586621682487498"><span class="hs-identifier hs-var">transaction</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TxRelationF 'With) -&gt; [TxRelationF 'With]
forall a. Maybe a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybeToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (TxRelationF 'With) -&gt; [TxRelationF 'With])
-&gt; Maybe (TxRelationF 'With) -&gt; [TxRelationF 'With]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxId -&gt; Map TxId (TxRelationF 'With) -&gt; Maybe (TxRelationF 'With)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxMeta -&gt; TxId
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#txMetaTxId"><span class="hs-identifier hs-var hs-var">txMetaTxId</span></a></span><span> </span><span class="annot"><span class="annottext">TxMeta
</span><a href="#local-6989586621682487499"><span class="hs-identifier hs-var">meta</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map TxId (TxRelationF 'With)
</span><a href="#local-6989586621682487497"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-1011"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; [()]
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; [()]) -&gt; Bool -&gt; [()]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; (Coin -&gt; Bool) -&gt; Maybe Coin -&gt; Bool
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span>
</span><span id="line-1012"></span><span>            </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-1013"></span><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682487496"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621682487496"><span class="hs-identifier hs-var">coin</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Coin -&gt; Bool) -&gt; [Coin] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">any</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621682487496"><span class="hs-identifier hs-var">coin</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1014"></span><span>                </span><span class="annot"><span class="annottext">([Coin] -&gt; Bool) -&gt; [Coin] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxWithdrawal -&gt; Coin
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#txWithdrawalAmount"><span class="hs-identifier hs-var hs-var">txWithdrawalAmount</span></a></span><span> </span><span class="annot"><span class="annottext">(TxWithdrawal -&gt; Coin) -&gt; [TxWithdrawal] -&gt; [Coin]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>  </span><span class="annot"><span class="annottext">TxRelationF 'With -&gt; [TxWithdrawal]
forall (f :: Decoration). TxRelationF f -&gt; [TxWithdrawal]
</span><a href="Cardano.Wallet.DB.Store.Transactions.Model.html#%24sel%3Awithdrawals%3ATxRelationF"><span class="hs-identifier hs-var hs-var">withdrawals</span></a></span><span> </span><span class="annot"><span class="annottext">TxRelationF 'With
</span><a href="#local-6989586621682487498"><span class="hs-identifier hs-var">transaction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1015"></span><span>            </span><span class="annot"><span class="annottext">Maybe Coin
</span><a href="#local-6989586621682487509"><span class="hs-identifier hs-var">minWithdrawal</span></a></span><span>
</span><span id="line-1016"></span><span>        </span><span class="annot"><span class="annottext">(TxRelationF 'With, TxMeta) -&gt; [(TxRelationF 'With, TxMeta)]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxRelationF 'With
</span><a href="#local-6989586621682487498"><span class="hs-identifier hs-var">transaction</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TxMeta
</span><a href="#local-6989586621682487499"><span class="hs-identifier hs-var">meta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1017"></span><span>    </span><span class="annot"><span class="annottext">[TransactionInfo] -&gt; m [TransactionInfo]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">([TransactionInfo] -&gt; m [TransactionInfo])
-&gt; [TransactionInfo] -&gt; m [TransactionInfo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[TransactionInfo] -&gt; [TransactionInfo]
</span><a href="#local-6989586621682487494"><span class="hs-identifier hs-var">sortTx</span></a></span><span> </span><span class="annot"><span class="annottext">[TransactionInfo]
</span><a href="#local-6989586621682487504"><span class="hs-identifier hs-var">tinfos</span></a></span><span>
</span><span id="line-1018"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1019"></span><span>        </span><span id="local-6989586621682487494"><span class="annot"><span class="annottext">sortTx :: [TransactionInfo] -&gt; [TransactionInfo]
</span><a href="#local-6989586621682487494"><span class="hs-identifier hs-var hs-var">sortTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SortOrder
</span><a href="#local-6989586621682487508"><span class="hs-identifier hs-var">order</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1020"></span><span>            </span><span class="annot"><span class="annottext">SortOrder
</span><a href="Cardano.Wallet.Primitive.Types.html#Ascending"><span class="hs-identifier hs-var">W.Ascending</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TransactionInfo -&gt; (SlotNo, Down (Hash &quot;Tx&quot;)))
-&gt; [TransactionInfo] -&gt; [TransactionInfo]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">sortOn</span></a></span><span>
</span><span id="line-1021"></span><span>                </span><span class="annot"><span class="annottext">((TransactionInfo -&gt; (SlotNo, Down (Hash &quot;Tx&quot;)))
 -&gt; [TransactionInfo] -&gt; [TransactionInfo])
-&gt; (TransactionInfo -&gt; (SlotNo, Down (Hash &quot;Tx&quot;)))
-&gt; [TransactionInfo]
-&gt; [TransactionInfo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; Down (Hash &quot;Tx&quot;) -&gt; (SlotNo, Down (Hash &quot;Tx&quot;)))
-&gt; (TransactionInfo -&gt; SlotNo)
-&gt; TransactionInfo
-&gt; Down (Hash &quot;Tx&quot;)
-&gt; (SlotNo, Down (Hash &quot;Tx&quot;))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TxMeta -&gt; SlotNo
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#%24sel%3AslotNo%3ATxMeta"><span class="hs-identifier hs-var hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">(TxMeta -&gt; SlotNo)
-&gt; (TransactionInfo -&gt; TxMeta) -&gt; TransactionInfo -&gt; SlotNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionInfo -&gt; TxMeta
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#%24sel%3AtxInfoMeta%3ATransactionInfo"><span class="hs-identifier hs-var hs-var">txInfoMeta</span></a></span><span> </span><span class="annot"><span class="annottext">(TransactionInfo -&gt; Down (Hash &quot;Tx&quot;) -&gt; (SlotNo, Down (Hash &quot;Tx&quot;)))
-&gt; (TransactionInfo -&gt; Down (Hash &quot;Tx&quot;))
-&gt; TransactionInfo
-&gt; (SlotNo, Down (Hash &quot;Tx&quot;))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot; -&gt; Down (Hash &quot;Tx&quot;)
forall a. a -&gt; Down a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Down</span></a></span><span> </span><span class="annot"><span class="annottext">(Hash &quot;Tx&quot; -&gt; Down (Hash &quot;Tx&quot;))
-&gt; (TransactionInfo -&gt; Hash &quot;Tx&quot;)
-&gt; TransactionInfo
-&gt; Down (Hash &quot;Tx&quot;)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionInfo -&gt; Hash &quot;Tx&quot;
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#%24sel%3AtxInfoId%3ATransactionInfo"><span class="hs-identifier hs-var hs-var">txInfoId</span></a></span><span>
</span><span id="line-1022"></span><span>            </span><span class="annot"><span class="annottext">SortOrder
</span><a href="Cardano.Wallet.Primitive.Types.html#Descending"><span class="hs-identifier hs-var">W.Descending</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TransactionInfo -&gt; (Down SlotNo, Hash &quot;Tx&quot;))
-&gt; [TransactionInfo] -&gt; [TransactionInfo]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">sortOn</span></a></span><span>
</span><span id="line-1023"></span><span>                </span><span class="annot"><span class="annottext">((TransactionInfo -&gt; (Down SlotNo, Hash &quot;Tx&quot;))
 -&gt; [TransactionInfo] -&gt; [TransactionInfo])
-&gt; (TransactionInfo -&gt; (Down SlotNo, Hash &quot;Tx&quot;))
-&gt; [TransactionInfo]
-&gt; [TransactionInfo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Down SlotNo -&gt; Hash &quot;Tx&quot; -&gt; (Down SlotNo, Hash &quot;Tx&quot;))
-&gt; (TransactionInfo -&gt; Down SlotNo)
-&gt; TransactionInfo
-&gt; Hash &quot;Tx&quot;
-&gt; (Down SlotNo, Hash &quot;Tx&quot;)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Down SlotNo
forall a. a -&gt; Down a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Down</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; Down SlotNo)
-&gt; (TransactionInfo -&gt; SlotNo) -&gt; TransactionInfo -&gt; Down SlotNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TxMeta -&gt; SlotNo
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#%24sel%3AslotNo%3ATxMeta"><span class="hs-identifier hs-var hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">(TxMeta -&gt; SlotNo)
-&gt; (TransactionInfo -&gt; TxMeta) -&gt; TransactionInfo -&gt; SlotNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionInfo -&gt; TxMeta
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#%24sel%3AtxInfoMeta%3ATransactionInfo"><span class="hs-identifier hs-var hs-var">txInfoMeta</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TransactionInfo -&gt; Hash &quot;Tx&quot; -&gt; (Down SlotNo, Hash &quot;Tx&quot;))
-&gt; (TransactionInfo -&gt; Hash &quot;Tx&quot;)
-&gt; TransactionInfo
-&gt; (Down SlotNo, Hash &quot;Tx&quot;)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionInfo -&gt; Hash &quot;Tx&quot;
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#%24sel%3AtxInfoId%3ATransactionInfo"><span class="hs-identifier hs-var hs-var">txInfoId</span></a></span><span>
</span><span id="line-1024"></span><span>        </span><span class="annot"><a href="Cardano.Wallet.DB.Store.Transactions.Model.html#TxHistoryF"><span class="hs-identifier hs-type">TxHistoryF</span></a></span><span> </span><span id="local-6989586621682487497"><span class="annot"><span class="annottext">Map TxId (TxRelationF 'With)
</span><a href="#local-6989586621682487497"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxHistory -&gt; TxHistoryF 'With
</span><a href="Cardano.Wallet.DB.Store.Transactions.Model.html#decorateWithTxOuts"><span class="hs-identifier hs-var">decorateWithTxOuts</span></a></span><span> </span><span class="annot"><span class="annottext">TxHistory
</span><a href="#local-6989586621682487506"><span class="hs-identifier hs-var">txHistory</span></a></span><span>
</span><span id="line-1025"></span><span>
</span><span id="line-1026"></span><span>
</span><span id="line-1027"></span><span class="hs-comment">-- | Returns the initial submission slot and submission record for all pending</span><span>
</span><span id="line-1028"></span><span class="hs-comment">-- transactions in the wallet.</span><span>
</span><span id="line-1029"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#listPendingLocalTxSubmissionQuery"><span class="hs-identifier hs-type">listPendingLocalTxSubmissionQuery</span></a></span><span>
</span><span id="line-1030"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-1031"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">W.SlotNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#LocalTxSubmission"><span class="hs-identifier hs-type">LocalTxSubmission</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1032"></span><span id="listPendingLocalTxSubmissionQuery"><span class="annot"><span class="annottext">listPendingLocalTxSubmissionQuery :: WalletId -&gt; ReaderT SqlBackend IO [(SlotNo, LocalTxSubmission)]
</span><a href="Cardano.Wallet.DB.Layer.html#listPendingLocalTxSubmissionQuery"><span class="hs-identifier hs-var hs-var">listPendingLocalTxSubmissionQuery</span></a></span></span><span> </span><span id="local-6989586621682487488"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487488"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Single SlotNo, Entity LocalTxSubmission)
 -&gt; (SlotNo, LocalTxSubmission))
-&gt; [(Single SlotNo, Entity LocalTxSubmission)]
-&gt; [(SlotNo, LocalTxSubmission)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">(Single SlotNo, Entity LocalTxSubmission)
-&gt; (SlotNo, LocalTxSubmission)
forall a b. (Single a, Entity b) -&gt; (a, b)
</span><a href="#local-6989586621682487487"><span class="hs-identifier hs-var">unRaw</span></a></span><span> </span><span class="annot"><span class="annottext">([(Single SlotNo, Entity LocalTxSubmission)]
 -&gt; [(SlotNo, LocalTxSubmission)])
-&gt; ReaderT
     SqlBackend IO [(Single SlotNo, Entity LocalTxSubmission)]
-&gt; ReaderT SqlBackend IO [(SlotNo, LocalTxSubmission)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
-&gt; [PersistValue]
-&gt; ReaderT
     SqlBackend IO [(Single SlotNo, Entity LocalTxSubmission)]
forall a (m :: * -&gt; *) backend.
(RawSql a, MonadIO m, BackendCompatible SqlBackend backend) =&gt;
Text -&gt; [PersistValue] -&gt; ReaderT backend m [a]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">rawSql</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487486"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="annot"><span class="annottext">[PersistValue]
</span><a href="#local-6989586621682487485"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-1033"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1034"></span><span>    </span><span class="hs-comment">-- fixme: sort results</span><span>
</span><span id="line-1035"></span><span>    </span><span id="local-6989586621682487486"><span class="annot"><span class="annottext">query :: Text
</span><a href="#local-6989586621682487486"><span class="hs-identifier hs-var hs-var">query</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1036"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;SELECT tx_meta.slot,?? &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-1037"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;FROM tx_meta INNER JOIN local_tx_submission &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-1038"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;ON tx_meta.wallet_id=local_tx_submission.wallet_id &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-1039"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;    AND tx_meta.tx_id=local_tx_submission.tx_id &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-1040"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;WHERE tx_meta.wallet_id=? AND tx_meta.status=? &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-1041"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;ORDER BY local_tx_submission.wallet_id, local_tx_submission.tx_id&quot;</span></span><span>
</span><span id="line-1042"></span><span>    </span><span id="local-6989586621682487485"><span class="annot"><span class="annottext">params :: [PersistValue]
</span><a href="#local-6989586621682487485"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">WalletId -&gt; PersistValue
forall a. PersistField a =&gt; a -&gt; PersistValue
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">toPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487488"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TxStatus -&gt; PersistValue
forall a. PersistField a =&gt; a -&gt; PersistValue
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">toPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">TxStatus
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#Pending"><span class="hs-identifier hs-var">W.Pending</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1043"></span><span>    </span><span id="local-6989586621682487487"><span class="annot"><span class="annottext">unRaw :: (Single a, Entity b) -&gt; (a, b)
</span><a href="#local-6989586621682487487"><span class="hs-identifier hs-var hs-var">unRaw</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682487482"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682487482"><span class="hs-identifier hs-var">sl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Entity</span></a></span><span> </span><span class="annot"><span class="annottext">Key b
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682487480"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621682487480"><span class="hs-identifier hs-var">tx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682487482"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621682487480"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1044"></span><span>
</span><span id="line-1045"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#localTxSubmissionFromEntity"><span class="hs-identifier hs-type">localTxSubmissionFromEntity</span></a></span><span>
</span><span id="line-1046"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">W.SlotNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#LocalTxSubmission"><span class="hs-identifier hs-type">LocalTxSubmission</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1047"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#LocalTxSubmissionStatus"><span class="hs-identifier hs-type">W.LocalTxSubmissionStatus</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Tx.html#SealedTx"><span class="hs-identifier hs-type">W.SealedTx</span></a></span><span>
</span><span id="line-1048"></span><span id="localTxSubmissionFromEntity"><span class="annot"><span class="annottext">localTxSubmissionFromEntity :: (SlotNo, LocalTxSubmission) -&gt; LocalTxSubmissionStatus SealedTx
</span><a href="Cardano.Wallet.DB.Layer.html#localTxSubmissionFromEntity"><span class="hs-identifier hs-var hs-var">localTxSubmissionFromEntity</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682487479"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487479"><span class="hs-identifier hs-var">sl0</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Schema.html#LocalTxSubmission"><span class="hs-identifier hs-type">LocalTxSubmission</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#TxId"><span class="hs-identifier hs-type">TxId</span></a></span><span> </span><span id="local-6989586621682487478"><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682487478"><span class="hs-identifier hs-var">txid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WalletId
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682487477"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487477"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span id="local-6989586621682487476"><span class="annot"><span class="annottext">SealedTx
</span><a href="#local-6989586621682487476"><span class="hs-identifier hs-var">tx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1049"></span><span>    </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
-&gt; SealedTx -&gt; SlotNo -&gt; SlotNo -&gt; LocalTxSubmissionStatus SealedTx
forall tx.
Hash &quot;Tx&quot; -&gt; tx -&gt; SlotNo -&gt; SlotNo -&gt; LocalTxSubmissionStatus tx
</span><a href="Cardano.Wallet.Primitive.Types.Tx.html#LocalTxSubmissionStatus"><span class="hs-identifier hs-var">W.LocalTxSubmissionStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Hash &quot;Tx&quot;
</span><a href="#local-6989586621682487478"><span class="hs-identifier hs-var">txid</span></a></span><span> </span><span class="annot"><span class="annottext">SealedTx
</span><a href="#local-6989586621682487476"><span class="hs-identifier hs-var">tx</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487479"><span class="hs-identifier hs-var">sl0</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682487477"><span class="hs-identifier hs-var">sl</span></a></span><span>
</span><span id="line-1050"></span><span>
</span><span id="line-1051"></span><span class="hs-comment">-- | Remove transactions from the local submission pool once they can no longer</span><span>
</span><span id="line-1052"></span><span class="hs-comment">-- be rolled back.</span><span>
</span><span id="line-1053"></span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#pruneLocalTxSubmission"><span class="hs-identifier hs-type">pruneLocalTxSubmission</span></a></span><span>
</span><span id="line-1054"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-1055"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-type">Quantity</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;block&quot;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word32</span></a></span><span>
</span><span id="line-1056"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">W.BlockHeader</span></a></span><span>
</span><span id="line-1057"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1058"></span><span id="pruneLocalTxSubmission"><span class="annot"><span class="annottext">pruneLocalTxSubmission :: WalletId
-&gt; Quantity &quot;block&quot; Word32 -&gt; BlockHeader -&gt; SqlPersistT IO ()
</span><a href="Cardano.Wallet.DB.Layer.html#pruneLocalTxSubmission"><span class="hs-identifier hs-var hs-var">pruneLocalTxSubmission</span></a></span></span><span> </span><span id="local-6989586621682487474"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487474"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-type">Quantity</span></a></span><span> </span><span id="local-6989586621682487472"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682487472"><span class="hs-identifier hs-var">epochStability</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682487471"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682487471"><span class="hs-identifier hs-var">tip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1059"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; [PersistValue] -&gt; SqlPersistT IO ()
forall (m :: * -&gt; *) backend.
(MonadIO m, BackendCompatible SqlBackend backend) =&gt;
Text -&gt; [PersistValue] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">rawExecute</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682487470"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="annot"><span class="annottext">[PersistValue]
</span><a href="#local-6989586621682487469"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-1060"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1061"></span><span>    </span><span id="local-6989586621682487470"><span class="annot"><span class="annottext">query :: Text
</span><a href="#local-6989586621682487470"><span class="hs-identifier hs-var hs-var">query</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1062"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DELETE FROM local_tx_submission &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-1063"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;WHERE wallet_id=? AND tx_id IN &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-1064"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;( SELECT tx_id FROM tx_meta WHERE tx_meta.block_height &lt; ? )&quot;</span></span><span>
</span><span id="line-1065"></span><span>    </span><span id="local-6989586621682487469"><span class="annot"><span class="annottext">params :: [PersistValue]
</span><a href="#local-6989586621682487469"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">WalletId -&gt; PersistValue
forall a. PersistField a =&gt; a -&gt; PersistValue
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">toPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487474"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; PersistValue
forall a. PersistField a =&gt; a -&gt; PersistValue
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">toPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682487468"><span class="hs-identifier hs-var">stableHeight</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1066"></span><span>    </span><span id="local-6989586621682487468"><span class="annot"><span class="annottext">stableHeight :: Word32
</span><a href="#local-6989586621682487468"><span class="hs-identifier hs-var hs-var">stableHeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Quantity &quot;block&quot; Word32 -&gt; Word32
forall (unit :: Symbol) a. Quantity unit a -&gt; a
</span><a href="Data.Quantity.html#getQuantity"><span class="hs-identifier hs-var hs-var">getQuantity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682487471"><span class="hs-identifier hs-var">tip</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
-&gt; ((Quantity &quot;block&quot; Word32
     -&gt; Const (Quantity &quot;block&quot; Word32) (Quantity &quot;block&quot; Word32))
    -&gt; BlockHeader -&gt; Const (Quantity &quot;block&quot; Word32) BlockHeader)
-&gt; Quantity &quot;block&quot; Word32
forall s a. s -&gt; ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;blockHeight&quot;
  ((Quantity &quot;block&quot; Word32
    -&gt; Const (Quantity &quot;block&quot; Word32) (Quantity &quot;block&quot; Word32))
   -&gt; BlockHeader -&gt; Const (Quantity &quot;block&quot; Word32) BlockHeader)
(Quantity &quot;block&quot; Word32
 -&gt; Const (Quantity &quot;block&quot; Word32) (Quantity &quot;block&quot; Word32))
-&gt; BlockHeader -&gt; Const (Quantity &quot;block&quot; Word32) BlockHeader
</span><a href="#local-6989586621682487466"><span class="hs-var">#blockHeight</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682487472"><span class="hs-identifier hs-var">epochStability</span></a></span><span>
</span><span id="line-1067"></span><span>
</span><span id="line-1068"></span><span id="local-6989586621682488200"><span id="local-6989586621682488201"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#selectPrivateKey"><span class="hs-identifier hs-type">selectPrivateKey</span></a></span><span>
</span><span id="line-1069"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488201"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#PersistPrivateKey"><span class="hs-identifier hs-type">PersistPrivateKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682488200"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#RootK"><span class="hs-identifier hs-type">RootK</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1070"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-1071"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488201"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682488200"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Cardano.Wallet.Primitive.AddressDerivation.html#RootK"><span class="hs-identifier hs-type">RootK</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-addresses/html/src"><span class="hs-identifier hs-type">XPrv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Passphrase.Types.html#PassphraseHash"><span class="hs-identifier hs-type">PassphraseHash</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1072"></span><span id="selectPrivateKey"><span class="annot"><span class="annottext">selectPrivateKey :: WalletId -&gt; SqlPersistT m (Maybe (k 'RootK XPrv, PassphraseHash))
</span><a href="Cardano.Wallet.DB.Layer.html#selectPrivateKey"><span class="hs-identifier hs-var hs-var">selectPrivateKey</span></a></span></span><span> </span><span id="local-6989586621682487465"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487465"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1073"></span><span>    </span><span id="local-6989586621682487464"><span class="annot"><span class="annottext">Maybe (Entity PrivateKey)
</span><a href="#local-6989586621682487464"><span class="hs-identifier hs-var">keys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Filter PrivateKey]
-&gt; [SelectOpt PrivateKey]
-&gt; ReaderT SqlBackend m (Maybe (Entity PrivateKey))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField PrivateKey WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField PrivateKey typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#PrivateKeyWalletId"><span class="hs-identifier hs-var">PrivateKeyWalletId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PrivateKey WalletId -&gt; WalletId -&gt; Filter PrivateKey
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487465"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1074"></span><span>    </span><span class="annot"><span class="annottext">Maybe (k 'RootK XPrv, PassphraseHash)
-&gt; SqlPersistT m (Maybe (k 'RootK XPrv, PassphraseHash))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (k 'RootK XPrv, PassphraseHash)
 -&gt; SqlPersistT m (Maybe (k 'RootK XPrv, PassphraseHash)))
-&gt; Maybe (k 'RootK XPrv, PassphraseHash)
-&gt; SqlPersistT m (Maybe (k 'RootK XPrv, PassphraseHash))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrivateKey -&gt; (k 'RootK XPrv, PassphraseHash)
forall (k :: Depth -&gt; * -&gt; *).
PersistPrivateKey (k 'RootK) =&gt;
PrivateKey -&gt; (k 'RootK XPrv, PassphraseHash)
</span><a href="Cardano.Wallet.DB.Layer.html#privateKeyFromEntity"><span class="hs-identifier hs-var">privateKeyFromEntity</span></a></span><span> </span><span class="annot"><span class="annottext">(PrivateKey -&gt; (k 'RootK XPrv, PassphraseHash))
-&gt; (Entity PrivateKey -&gt; PrivateKey)
-&gt; Entity PrivateKey
-&gt; (k 'RootK XPrv, PassphraseHash)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity PrivateKey -&gt; PrivateKey
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Entity PrivateKey -&gt; (k 'RootK XPrv, PassphraseHash))
-&gt; Maybe (Entity PrivateKey)
-&gt; Maybe (k 'RootK XPrv, PassphraseHash)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Entity PrivateKey)
</span><a href="#local-6989586621682487464"><span class="hs-identifier hs-var">keys</span></a></span><span>
</span><span id="line-1075"></span><span>
</span><span id="line-1076"></span><span id="local-6989586621682488199"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#selectGenesisParameters"><span class="hs-identifier hs-type">selectGenesisParameters</span></a></span><span>
</span><span id="line-1077"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488199"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1078"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span>
</span><span id="line-1079"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488199"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#GenesisParameters"><span class="hs-identifier hs-type">W.GenesisParameters</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1080"></span><span id="selectGenesisParameters"><span class="annot"><span class="annottext">selectGenesisParameters :: WalletId -&gt; SqlPersistT m (Maybe GenesisParameters)
</span><a href="Cardano.Wallet.DB.Layer.html#selectGenesisParameters"><span class="hs-identifier hs-var hs-var">selectGenesisParameters</span></a></span></span><span> </span><span id="local-6989586621682487463"><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487463"><span class="hs-identifier hs-var">wid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1081"></span><span>    </span><span id="local-6989586621682487462"><span class="annot"><span class="annottext">Maybe (Entity Wallet)
</span><a href="#local-6989586621682487462"><span class="hs-identifier hs-var">gp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Filter Wallet]
-&gt; [SelectOpt Wallet]
-&gt; ReaderT SqlBackend m (Maybe (Entity Wallet))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField Wallet WalletId
forall typ. (typ ~ WalletId) =&gt; EntityField Wallet typ
</span><a href="Cardano.Wallet.DB.Sqlite.Schema.html#WalId"><span class="hs-identifier hs-var">WalId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Wallet WalletId -&gt; WalletId -&gt; Filter Wallet
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">WalletId
</span><a href="#local-6989586621682487463"><span class="hs-identifier hs-var">wid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1082"></span><span>    </span><span class="annot"><span class="annottext">Maybe GenesisParameters -&gt; SqlPersistT m (Maybe GenesisParameters)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe GenesisParameters
 -&gt; SqlPersistT m (Maybe GenesisParameters))
-&gt; Maybe GenesisParameters
-&gt; SqlPersistT m (Maybe GenesisParameters)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Wallet -&gt; GenesisParameters
</span><a href="Cardano.Wallet.DB.Layer.html#genesisParametersFromEntity"><span class="hs-identifier hs-var">genesisParametersFromEntity</span></a></span><span> </span><span class="annot"><span class="annottext">(Wallet -&gt; GenesisParameters)
-&gt; (Entity Wallet -&gt; Wallet) -&gt; Entity Wallet -&gt; GenesisParameters
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity Wallet -&gt; Wallet
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Entity Wallet -&gt; GenesisParameters)
-&gt; Maybe (Entity Wallet) -&gt; Maybe GenesisParameters
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Entity Wallet)
</span><a href="#local-6989586621682487462"><span class="hs-identifier hs-var">gp</span></a></span><span>
</span><span id="line-1083"></span><span>
</span><span id="line-1084"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Internal errors
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1087"></span><span class="hs-comment">-- | A fatal exception thrown when trying to rollback but, there's no checkpoint</span><span>
</span><span id="line-1088"></span><span class="hs-comment">-- to rollback to. The database maintain the invariant that there's always at</span><span>
</span><span id="line-1089"></span><span class="hs-comment">-- least one checkpoint (the first one made for genesis) present in the</span><span>
</span><span id="line-1090"></span><span class="hs-comment">-- database.</span><span>
</span><span id="line-1091"></span><span class="hs-comment">--</span><span>
</span><span id="line-1092"></span><span class="hs-comment">-- If we don't find any checkpoint, it means that this invariant has been</span><span>
</span><span id="line-1093"></span><span class="hs-comment">-- violated.</span><span>
</span><span id="line-1094"></span><span class="hs-keyword">data</span><span> </span><span id="ErrRollbackTo"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#ErrRollbackTo"><span class="hs-identifier hs-var">ErrRollbackTo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ErrNoOlderCheckpoint"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#ErrNoOlderCheckpoint"><span class="hs-identifier hs-var">ErrNoOlderCheckpoint</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Slot"><span class="hs-identifier hs-type">W.Slot</span></a></span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682487456"><span id="local-6989586621682487458"><span id="local-6989586621682487460"><span class="annot"><span class="annottext">Int -&gt; ErrRollbackTo -&gt; FilePath -&gt; FilePath
[ErrRollbackTo] -&gt; FilePath -&gt; FilePath
ErrRollbackTo -&gt; FilePath
(Int -&gt; ErrRollbackTo -&gt; FilePath -&gt; FilePath)
-&gt; (ErrRollbackTo -&gt; FilePath)
-&gt; ([ErrRollbackTo] -&gt; FilePath -&gt; FilePath)
-&gt; Show ErrRollbackTo
forall a.
(Int -&gt; a -&gt; FilePath -&gt; FilePath)
-&gt; (a -&gt; FilePath) -&gt; ([a] -&gt; FilePath -&gt; FilePath) -&gt; Show a
showList :: [ErrRollbackTo] -&gt; FilePath -&gt; FilePath
$cshowList :: [ErrRollbackTo] -&gt; FilePath -&gt; FilePath
show :: ErrRollbackTo -&gt; FilePath
$cshow :: ErrRollbackTo -&gt; FilePath
showsPrec :: Int -&gt; ErrRollbackTo -&gt; FilePath -&gt; FilePath
$cshowsPrec :: Int -&gt; ErrRollbackTo -&gt; FilePath -&gt; FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-1095"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682487448"><span id="local-6989586621682487450"><span id="local-6989586621682487452"><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#ErrRollbackTo"><span class="hs-identifier hs-type">ErrRollbackTo</span></a></span></span></span></span><span>
</span><span id="line-1096"></span><span>
</span><span id="line-1097"></span><span class="hs-comment">-- | Can't initialize a wallet because the given 'BlockHeader' is not genesis.</span><span>
</span><span id="line-1098"></span><span class="hs-keyword">data</span><span> </span><span id="ErrInitializeGenesisAbsent"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#ErrInitializeGenesisAbsent"><span class="hs-identifier hs-var">ErrInitializeGenesisAbsent</span></a></span></span><span>
</span><span id="line-1099"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="ErrInitializeGenesisAbsent"><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#ErrInitializeGenesisAbsent"><span class="hs-identifier hs-var">ErrInitializeGenesisAbsent</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#WalletId"><span class="hs-identifier hs-type">W.WalletId</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">W.BlockHeader</span></a></span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682487443"><span id="local-6989586621682487445"><span class="annot"><span class="annottext">ErrInitializeGenesisAbsent -&gt; ErrInitializeGenesisAbsent -&gt; Bool
(ErrInitializeGenesisAbsent -&gt; ErrInitializeGenesisAbsent -&gt; Bool)
-&gt; (ErrInitializeGenesisAbsent
    -&gt; ErrInitializeGenesisAbsent -&gt; Bool)
-&gt; Eq ErrInitializeGenesisAbsent
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ErrInitializeGenesisAbsent -&gt; ErrInitializeGenesisAbsent -&gt; Bool
$c/= :: ErrInitializeGenesisAbsent -&gt; ErrInitializeGenesisAbsent -&gt; Bool
== :: ErrInitializeGenesisAbsent -&gt; ErrInitializeGenesisAbsent -&gt; Bool
$c== :: ErrInitializeGenesisAbsent -&gt; ErrInitializeGenesisAbsent -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682487437"><span id="local-6989586621682487439"><span id="local-6989586621682487441"><span class="annot"><span class="annottext">Int -&gt; ErrInitializeGenesisAbsent -&gt; FilePath -&gt; FilePath
[ErrInitializeGenesisAbsent] -&gt; FilePath -&gt; FilePath
ErrInitializeGenesisAbsent -&gt; FilePath
(Int -&gt; ErrInitializeGenesisAbsent -&gt; FilePath -&gt; FilePath)
-&gt; (ErrInitializeGenesisAbsent -&gt; FilePath)
-&gt; ([ErrInitializeGenesisAbsent] -&gt; FilePath -&gt; FilePath)
-&gt; Show ErrInitializeGenesisAbsent
forall a.
(Int -&gt; a -&gt; FilePath -&gt; FilePath)
-&gt; (a -&gt; FilePath) -&gt; ([a] -&gt; FilePath -&gt; FilePath) -&gt; Show a
showList :: [ErrInitializeGenesisAbsent] -&gt; FilePath -&gt; FilePath
$cshowList :: [ErrInitializeGenesisAbsent] -&gt; FilePath -&gt; FilePath
show :: ErrInitializeGenesisAbsent -&gt; FilePath
$cshow :: ErrInitializeGenesisAbsent -&gt; FilePath
showsPrec :: Int -&gt; ErrInitializeGenesisAbsent -&gt; FilePath -&gt; FilePath
$cshowsPrec :: Int -&gt; ErrInitializeGenesisAbsent -&gt; FilePath -&gt; FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-1100"></span><span>
</span><span id="line-1101"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682487429"><span id="local-6989586621682487431"><span id="local-6989586621682487433"><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Layer.html#ErrInitializeGenesisAbsent"><span class="hs-identifier hs-type">ErrInitializeGenesisAbsent</span></a></span></span></span></span><span>
</span><span id="line-1102"></span></pre></body></html>