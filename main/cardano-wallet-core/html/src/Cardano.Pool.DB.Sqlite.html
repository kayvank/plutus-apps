<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DuplicateRecordFields #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE OverloadedLabels #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-comment">{- HLINT ignore &quot;Redundant flip&quot; -}</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- Copyright: &#169; 2018-2020 IOHK</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- License: Apache-2.0</span><span>
</span><span id="line-22"></span><span class="hs-comment">--</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- An implementation of the DBLayer which uses Persistent and SQLite.</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Cardano.Pool.DB.Sqlite</span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#newDBLayer"><span class="hs-identifier">newDBLayer</span></a></span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#withDBLayer"><span class="hs-identifier">withDBLayer</span></a></span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#withDecoratedDBLayer"><span class="hs-identifier">withDecoratedDBLayer</span></a></span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#DBDecorator"><span class="hs-identifier">DBDecorator</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#undecoratedDB"><span class="hs-identifier">undecoratedDB</span></a></span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#defaultFilePath"><span class="hs-identifier">defaultFilePath</span></a></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#DatabaseView"><span class="hs-identifier">DatabaseView</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#createViews"><span class="hs-identifier">createViews</span></a></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Prelude</span></a></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html"><span class="hs-identifier">Cardano.DB.Sqlite</span></a></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#DBField"><span class="hs-identifier">DBField</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#DBLog"><span class="hs-identifier">DBLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#ForeignKeysSetting"><span class="hs-identifier">ForeignKeysSetting</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.DB.Sqlite.html#ForeignKeysEnabled"><span class="hs-identifier">ForeignKeysEnabled</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#ManualMigration"><span class="hs-identifier">ManualMigration</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#MigrationError"><span class="hs-identifier">MigrationError</span></a></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#SqliteContext"><span class="hs-identifier">SqliteContext</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#fieldName"><span class="hs-identifier">fieldName</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#handleConstraint"><span class="hs-identifier">handleConstraint</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#newInMemorySqliteContext"><span class="hs-identifier">newInMemorySqliteContext</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#newSqliteContext"><span class="hs-identifier">newSqliteContext</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#tableName"><span class="hs-identifier">tableName</span></a></span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#withConnectionPool"><span class="hs-identifier">withConnectionPool</span></a></span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.html"><span class="hs-identifier">Cardano.Pool.DB</span></a></span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.html#DBLayer"><span class="hs-identifier">DBLayer</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.html#ErrPointAlreadyExists"><span class="hs-identifier">ErrPointAlreadyExists</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.html#determinePoolLifeCycleStatus"><span class="hs-identifier">determinePoolLifeCycleStatus</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Log.html"><span class="hs-identifier">Cardano.Pool.DB.Log</span></a></span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Log.html#ParseFailure"><span class="hs-identifier">ParseFailure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Log.html#PoolDbLog"><span class="hs-identifier">PoolDbLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html"><span class="hs-identifier">Cardano.Pool.DB.Sqlite.TH</span></a></span><span> </span><span class="hs-keyword">hiding</span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#BlockHeader"><span class="hs-identifier">BlockHeader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#blockHeight"><span class="hs-identifier">blockHeight</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html"><span class="hs-identifier">Cardano.Wallet.DB.Sqlite.Types</span></a></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#BlockId"><span class="hs-identifier">BlockId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#fromMaybeHash"><span class="hs-identifier">fromMaybeHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.DB.Sqlite.Types.html#toMaybeHash"><span class="hs-identifier">toMaybeHash</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Logging.html"><span class="hs-identifier">Cardano.Wallet.Logging</span></a></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Logging.html#bracketTracer"><span class="hs-identifier">bracketTracer</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Slotting</span></a></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier">TimeInterpreter</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#epochOf"><span class="hs-identifier">epochOf</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#firstSlotInEpoch"><span class="hs-identifier">firstSlotInEpoch</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#interpretQuery"><span class="hs-identifier">interpretQuery</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types</span></a></span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier">BlockHeader</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#CertificatePublicationTime"><span class="hs-identifier">CertificatePublicationTime</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier">EpochNo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier">PoolId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolLifeCycleStatus"><span class="hs-identifier">PoolLifeCycleStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRegistrationCertificate"><span class="hs-identifier">PoolRegistrationCertificate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRetirementCertificate"><span class="hs-identifier">PoolRetirementCertificate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadata"><span class="hs-identifier">StakePoolMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadataHash"><span class="hs-identifier">StakePoolMetadataHash</span></a></span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#defaultSettings"><span class="hs-identifier">defaultSettings</span></a></span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Wallet.Unsafe.html"><span class="hs-identifier">Cardano.Wallet.Unsafe</span></a></span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Wallet.Unsafe.html#unsafeMkPercentage"><span class="hs-identifier">unsafeMkPercentage</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">forM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">forM_</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad.IO.Class</span></a></span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">liftIO</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">Control.Monad.Trans.Except</span></a></span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">ExceptT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier">Control.Tracer</span></a></span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier">Tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">contramap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier">natTracer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier">traceWith</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Either</span></a></span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">partitionEithers</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">rights</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Function</span></a></span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&amp;)</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Functor</span></a></span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&lt;&amp;&gt;)</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../generic-lens/html/src"><span class="hs-identifier">Data.Generics.Internal.VL.Lens</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../generic-lens/html/src"><span class="hs-identifier">view</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">foldl'</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Map</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Quantity.html"><span class="hs-identifier">Data.Quantity</span></a></span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Data.Quantity.html#Percentage"><span class="hs-identifier">Percentage</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier">Quantity</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Ratio</span></a></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">denominator</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">numerator</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(%)</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../string-interpolate/html/src"><span class="hs-identifier">Data.String.Interpolate</span></a></span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../string-interpolate/html/src"><span class="hs-identifier">i</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier">Data.Text</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier">Text</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../time/html/src"><span class="hs-identifier">Data.Time.Clock</span></a></span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../time/html/src"><span class="hs-identifier">UTCTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../time/html/src"><span class="hs-identifier">addUTCTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../time/html/src"><span class="hs-identifier">getCurrentTime</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Word</span></a></span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Word64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Word8</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">Database.Persist.Sql</span></a></span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">Entity</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">Filter</span></a></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">PersistValue</span></a></span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">RawSql</span></a></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">SelectOpt</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">Single</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">deleteWhere</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">fromPersistValue</span></a></span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">insertMany_</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">insert_</span></a></span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">rawSql</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">repsert</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">selectFirst</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">selectList</span></a></span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">toPersistValue</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">update</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-operator">(&lt;.)</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-operator">(=.)</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-operator">(==.)</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-operator">(&gt;.)</span></a></span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-operator">(&gt;=.)</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../persistent-sqlite/html/src"><span class="hs-identifier">Database.Persist.Sqlite</span></a></span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier">SqlPersistT</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../directory/html/src"><span class="hs-identifier">System.Directory</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../directory/html/src"><span class="hs-identifier">removeFile</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../filepath/html/src"><span class="hs-identifier">System.FilePath</span></a></span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../filepath/html/src"><span class="hs-operator">(&lt;/&gt;)</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../random/html/src"><span class="hs-identifier">System.Random</span></a></span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../random/html/src"><span class="hs-identifier">newStdGen</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../unliftio/html/src"><span class="hs-identifier">UnliftIO.Exception</span></a></span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../unliftio/html/src"><span class="hs-identifier">bracket</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../unliftio/html/src"><span class="hs-identifier">catch</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../unliftio/html/src"><span class="hs-identifier">throwIO</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html"><span class="hs-identifier">Cardano.Pool.DB.Sqlite.TH</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TH</span></span><span>
</span><span id="line-145"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-146"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.Coin.html"><span class="hs-identifier">Cardano.Wallet.Primitive.Types.Coin</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Coin</span></span><span>
</span><span id="line-147"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-148"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-149"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../persistent-sqlite/html/src"><span class="hs-identifier">Database.Sqlite</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Sqlite</span></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="hs-comment">-- | Return the preferred @FilePath@ for the stake pool .sqlite file, given a</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- parent directory.</span><span>
</span><span id="line-153"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#defaultFilePath"><span class="hs-identifier hs-type">defaultFilePath</span></a></span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-comment">-- ^ The directory in which the .sqlite file will be located.</span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-157"></span><span id="defaultFilePath"><span class="annot"><span class="annottext">defaultFilePath :: FilePath -&gt; FilePath
</span><a href="Cardano.Pool.DB.Sqlite.html#defaultFilePath"><span class="hs-identifier hs-var hs-var">defaultFilePath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
</span><a href="../../../../filepath/html/src"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;stake-pools.sqlite&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span class="hs-comment">-- | Runs an action with a connection to the SQLite database.</span><span>
</span><span id="line-160"></span><span class="hs-comment">--</span><span>
</span><span id="line-161"></span><span class="hs-comment">-- Database migrations are run to create tables if necessary.</span><span>
</span><span id="line-162"></span><span class="hs-comment">--</span><span>
</span><span id="line-163"></span><span class="hs-comment">-- If the given file path does not exist, it will be created by the sqlite</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- library.</span><span>
</span><span id="line-165"></span><span id="local-6989586621682489095"><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#withDBLayer"><span class="hs-identifier hs-type">withDBLayer</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-type">Tracer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Log.html#PoolDbLog"><span class="hs-identifier hs-type">PoolDbLog</span></a></span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-comment">-- ^ Logging object.</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-comment">-- ^ Database file location, or 'Nothing' for in-memory database.</span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier hs-type">TimeInterpreter</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-comment">-- ^ The time interpreter object.</span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Pool.DB.html#DBLayer"><span class="hs-identifier hs-type">DBLayer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489095"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-comment">-- ^ Action to run.</span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489095"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-175"></span><span id="withDBLayer"><span class="annot"><span class="annottext">withDBLayer :: Tracer IO PoolDbLog
-&gt; Maybe FilePath
-&gt; TimeInterpreter IO
-&gt; (DBLayer IO -&gt; IO a)
-&gt; IO a
</span><a href="Cardano.Pool.DB.Sqlite.html#withDBLayer"><span class="hs-identifier hs-var hs-var">withDBLayer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DBDecorator IO
-&gt; Tracer IO PoolDbLog
-&gt; Maybe FilePath
-&gt; TimeInterpreter IO
-&gt; (DBLayer IO -&gt; IO a)
-&gt; IO a
forall a.
DBDecorator IO
-&gt; Tracer IO PoolDbLog
-&gt; Maybe FilePath
-&gt; TimeInterpreter IO
-&gt; (DBLayer IO -&gt; IO a)
-&gt; IO a
</span><a href="Cardano.Pool.DB.Sqlite.html#withDecoratedDBLayer"><span class="hs-identifier hs-var">withDecoratedDBLayer</span></a></span><span> </span><span class="annot"><span class="annottext">DBDecorator IO
forall (a :: * -&gt; *). DBDecorator a
</span><a href="Cardano.Pool.DB.Sqlite.html#undecoratedDB"><span class="hs-identifier hs-var">undecoratedDB</span></a></span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span class="hs-comment">-- | A decorator for the database layer, useful for instrumenting or monitoring</span><span>
</span><span id="line-178"></span><span class="hs-comment">--   calls to database operations.</span><span>
</span><span id="line-179"></span><span class="hs-keyword">newtype</span><span> </span><span id="DBDecorator"><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#DBDecorator"><span class="hs-identifier hs-var">DBDecorator</span></a></span></span><span> </span><span id="local-6989586621682489487"><span class="annot"><a href="#local-6989586621682489487"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-180"></span><span>    </span><span id="DBDecorator"><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#DBDecorator"><span class="hs-identifier hs-var">DBDecorator</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AdecorateDBLayer%3ADBDecorator"><span class="annot"><span class="annottext">DBDecorator a -&gt; DBLayer a -&gt; DBLayer a
</span><a href="Cardano.Pool.DB.Sqlite.html#%24sel%3AdecorateDBLayer%3ADBDecorator"><span class="hs-identifier hs-var hs-var">decorateDBLayer</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.html#DBLayer"><span class="hs-identifier hs-type">DBLayer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489487"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.html#DBLayer"><span class="hs-identifier hs-type">DBLayer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489487"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">-- | The identity decorator.</span><span>
</span><span id="line-183"></span><span class="hs-comment">--</span><span>
</span><span id="line-184"></span><span class="hs-comment">-- Equivalent to an undecorated database.</span><span>
</span><span id="line-185"></span><span class="hs-comment">--</span><span>
</span><span id="line-186"></span><span id="local-6989586621682489490"><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#undecoratedDB"><span class="hs-identifier hs-type">undecoratedDB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#DBDecorator"><span class="hs-identifier hs-type">DBDecorator</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489490"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-187"></span><span id="undecoratedDB"><span class="annot"><span class="annottext">undecoratedDB :: DBDecorator a
</span><a href="Cardano.Pool.DB.Sqlite.html#undecoratedDB"><span class="hs-identifier hs-var hs-var">undecoratedDB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DBLayer a -&gt; DBLayer a) -&gt; DBDecorator a
forall (a :: * -&gt; *). (DBLayer a -&gt; DBLayer a) -&gt; DBDecorator a
</span><a href="Cardano.Pool.DB.Sqlite.html#DBDecorator"><span class="hs-identifier hs-var">DBDecorator</span></a></span><span> </span><span class="annot"><span class="annottext">DBLayer a -&gt; DBLayer a
forall a. a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span class="hs-comment">-- | Runs an action with a connection to the SQLite database.</span><span>
</span><span id="line-190"></span><span class="hs-comment">--</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- This function has the same behaviour as 'withDBLayer', but provides a way</span><span>
</span><span id="line-192"></span><span class="hs-comment">-- to decorate the created 'DBLayer' object with a 'DBDecorator', useful for</span><span>
</span><span id="line-193"></span><span class="hs-comment">-- instrumenting or monitoring calls to database operations.</span><span>
</span><span id="line-194"></span><span class="hs-comment">--</span><span>
</span><span id="line-195"></span><span id="local-6989586621682489491"><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#withDecoratedDBLayer"><span class="hs-identifier hs-type">withDecoratedDBLayer</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#DBDecorator"><span class="hs-identifier hs-type">DBDecorator</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-197"></span><span>       </span><span class="hs-comment">-- ^ The database decorator.</span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-type">Tracer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Log.html#PoolDbLog"><span class="hs-identifier hs-type">PoolDbLog</span></a></span><span>
</span><span id="line-199"></span><span>       </span><span class="hs-comment">-- ^ Logging object</span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-201"></span><span>       </span><span class="hs-comment">-- ^ Database file location, or Nothing for in-memory database</span><span>
</span><span id="line-202"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier hs-type">TimeInterpreter</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-203"></span><span>       </span><span class="hs-comment">-- ^ The time interpreter object.</span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Pool.DB.html#DBLayer"><span class="hs-identifier hs-type">DBLayer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489491"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>       </span><span class="hs-comment">-- ^ Action to run.</span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489491"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-207"></span><span id="withDecoratedDBLayer"><span class="annot"><span class="annottext">withDecoratedDBLayer :: DBDecorator IO
-&gt; Tracer IO PoolDbLog
-&gt; Maybe FilePath
-&gt; TimeInterpreter IO
-&gt; (DBLayer IO -&gt; IO a)
-&gt; IO a
</span><a href="Cardano.Pool.DB.Sqlite.html#withDecoratedDBLayer"><span class="hs-identifier hs-var hs-var">withDecoratedDBLayer</span></a></span></span><span> </span><span id="local-6989586621682489091"><span class="annot"><span class="annottext">DBDecorator IO
</span><a href="#local-6989586621682489091"><span class="hs-identifier hs-var">dbDecorator</span></a></span></span><span> </span><span id="local-6989586621682489090"><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682489090"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621682489089"><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621682489089"><span class="hs-identifier hs-var">mDatabaseDir</span></a></span></span><span> </span><span id="local-6989586621682489088"><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682489088"><span class="hs-identifier hs-var">ti</span></a></span></span><span> </span><span id="local-6989586621682489087"><span class="annot"><span class="annottext">DBLayer IO -&gt; IO a
</span><a href="#local-6989586621682489087"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621682489089"><span class="hs-identifier hs-var">mDatabaseDir</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-209"></span><span>        </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO (IO (), SqliteContext)
-&gt; ((IO (), SqliteContext) -&gt; IO ())
-&gt; ((IO (), SqliteContext) -&gt; IO a)
-&gt; IO a
forall (m :: * -&gt; *) a b c.
MonadUnliftIO m =&gt;
m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
</span><a href="../../../../unliftio/html/src"><span class="hs-identifier hs-var">bracket</span></a></span><span>
</span><span id="line-210"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer IO DBLog
-&gt; [ManualMigration]
-&gt; Migration
-&gt; ForeignKeysSetting
-&gt; IO (IO (), SqliteContext)
</span><a href="Cardano.DB.Sqlite.html#newInMemorySqliteContext"><span class="hs-identifier hs-var">newInMemorySqliteContext</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO DBLog
</span><a href="#local-6989586621682489086"><span class="hs-identifier hs-var">tr'</span></a></span><span>
</span><span id="line-211"></span><span>                </span><span class="annot"><span class="annottext">[ManualMigration]
</span><a href="Cardano.Pool.DB.Sqlite.html#createViews"><span class="hs-identifier hs-var">createViews</span></a></span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#migrateAll"><span class="hs-identifier hs-var">migrateAll</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignKeysSetting
</span><a href="Cardano.DB.Sqlite.html#ForeignKeysEnabled"><span class="hs-identifier hs-var">ForeignKeysEnabled</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>            </span><span class="annot"><span class="annottext">(IO (), SqliteContext) -&gt; IO ()
forall a b. (a, b) -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span>
</span><span id="line-213"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DBLayer IO -&gt; IO a
</span><a href="#local-6989586621682489087"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">(DBLayer IO -&gt; IO a)
-&gt; ((IO (), SqliteContext) -&gt; DBLayer IO)
-&gt; (IO (), SqliteContext)
-&gt; IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DBDecorator IO -&gt; DBLayer IO -&gt; DBLayer IO
forall (a :: * -&gt; *). DBDecorator a -&gt; DBLayer a -&gt; DBLayer a
</span><a href="Cardano.Pool.DB.Sqlite.html#%24sel%3AdecorateDBLayer%3ADBDecorator"><span class="hs-identifier hs-var hs-var">decorateDBLayer</span></a></span><span> </span><span class="annot"><span class="annottext">DBDecorator IO
</span><a href="#local-6989586621682489091"><span class="hs-identifier hs-var">dbDecorator</span></a></span><span> </span><span class="annot"><span class="annottext">(DBLayer IO -&gt; DBLayer IO)
-&gt; ((IO (), SqliteContext) -&gt; DBLayer IO)
-&gt; (IO (), SqliteContext)
-&gt; DBLayer IO
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
-&gt; TimeInterpreter IO -&gt; SqliteContext -&gt; DBLayer IO
</span><a href="Cardano.Pool.DB.Sqlite.html#newDBLayer"><span class="hs-identifier hs-var">newDBLayer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682489090"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682489088"><span class="hs-identifier hs-var">ti</span></a></span><span> </span><span class="annot"><span class="annottext">(SqliteContext -&gt; DBLayer IO)
-&gt; ((IO (), SqliteContext) -&gt; SqliteContext)
-&gt; (IO (), SqliteContext)
-&gt; DBLayer IO
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (), SqliteContext) -&gt; SqliteContext
forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682489083"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682489083"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog -&gt; FilePath -&gt; IO a -&gt; IO a
forall a. Tracer IO PoolDbLog -&gt; FilePath -&gt; IO a -&gt; IO a
</span><a href="Cardano.Pool.DB.Sqlite.html#handlingPersistError"><span class="hs-identifier hs-var">handlingPersistError</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682489090"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682489083"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; IO a) -&gt; IO a -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-216"></span><span>            </span><span class="annot"><span class="annottext">Tracer IO DBLog -&gt; FilePath -&gt; (ConnectionPool -&gt; IO a) -&gt; IO a
forall a.
Tracer IO DBLog -&gt; FilePath -&gt; (ConnectionPool -&gt; IO a) -&gt; IO a
</span><a href="Cardano.DB.Sqlite.html#withConnectionPool"><span class="hs-identifier hs-var">withConnectionPool</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO DBLog
</span><a href="#local-6989586621682489086"><span class="hs-identifier hs-var">tr'</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682489083"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">((ConnectionPool -&gt; IO a) -&gt; IO a)
-&gt; (ConnectionPool -&gt; IO a) -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682489081"><span class="annot"><span class="annottext">ConnectionPool
</span><a href="#local-6989586621682489081"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-217"></span><span>                </span><span id="local-6989586621682489080"><span class="annot"><span class="annottext">Either MigrationError SqliteContext
</span><a href="#local-6989586621682489080"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Tracer IO DBLog
-&gt; ConnectionPool
-&gt; [ManualMigration]
-&gt; Migration
-&gt; IO (Either MigrationError SqliteContext)
</span><a href="Cardano.DB.Sqlite.html#newSqliteContext"><span class="hs-identifier hs-var">newSqliteContext</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO DBLog
</span><a href="#local-6989586621682489086"><span class="hs-identifier hs-var">tr'</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionPool
</span><a href="#local-6989586621682489081"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="annot"><span class="annottext">[ManualMigration]
</span><a href="Cardano.Pool.DB.Sqlite.html#createViews"><span class="hs-identifier hs-var">createViews</span></a></span><span> </span><span class="annot"><span class="annottext">Migration
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#migrateAll"><span class="hs-identifier hs-var">migrateAll</span></a></span><span>
</span><span id="line-218"></span><span>                </span><span class="annot"><span class="annottext">Either MigrationError SqliteContext
</span><a href="#local-6989586621682489080"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Either MigrationError SqliteContext
-&gt; (Either MigrationError SqliteContext -&gt; IO a) -&gt; IO a
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(MigrationError -&gt; IO a)
-&gt; (SqliteContext -&gt; IO a)
-&gt; Either MigrationError SqliteContext
-&gt; IO a
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">either</span></a></span><span>
</span><span id="line-219"></span><span>                    </span><span class="annot"><span class="annottext">MigrationError -&gt; IO a
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><a href="../../../../unliftio/html/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span>
</span><span id="line-220"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DBLayer IO -&gt; IO a
</span><a href="#local-6989586621682489087"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">(DBLayer IO -&gt; IO a)
-&gt; (SqliteContext -&gt; DBLayer IO) -&gt; SqliteContext -&gt; IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DBDecorator IO -&gt; DBLayer IO -&gt; DBLayer IO
forall (a :: * -&gt; *). DBDecorator a -&gt; DBLayer a -&gt; DBLayer a
</span><a href="Cardano.Pool.DB.Sqlite.html#%24sel%3AdecorateDBLayer%3ADBDecorator"><span class="hs-identifier hs-var hs-var">decorateDBLayer</span></a></span><span> </span><span class="annot"><span class="annottext">DBDecorator IO
</span><a href="#local-6989586621682489091"><span class="hs-identifier hs-var">dbDecorator</span></a></span><span> </span><span class="annot"><span class="annottext">(DBLayer IO -&gt; DBLayer IO)
-&gt; (SqliteContext -&gt; DBLayer IO) -&gt; SqliteContext -&gt; DBLayer IO
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
-&gt; TimeInterpreter IO -&gt; SqliteContext -&gt; DBLayer IO
</span><a href="Cardano.Pool.DB.Sqlite.html#newDBLayer"><span class="hs-identifier hs-var">newDBLayer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682489090"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682489088"><span class="hs-identifier hs-var">ti</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-222"></span><span>    </span><span id="local-6989586621682489086"><span class="annot"><span class="annottext">tr' :: Tracer IO DBLog
</span><a href="#local-6989586621682489086"><span class="hs-identifier hs-var hs-var">tr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DBLog -&gt; PoolDbLog) -&gt; Tracer IO PoolDbLog -&gt; Tracer IO DBLog
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">DBLog -&gt; PoolDbLog
</span><a href="Cardano.Pool.DB.Log.html#MsgGeneric"><span class="hs-identifier hs-var">MsgGeneric</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682489090"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="hs-comment">-- | Sets up a connection to the SQLite database.</span><span>
</span><span id="line-225"></span><span class="hs-comment">--</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- Database migrations are run to create tables if necessary.</span><span>
</span><span id="line-227"></span><span class="hs-comment">--</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- If the given file path does not exist, it will be created by the sqlite</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- library.</span><span>
</span><span id="line-230"></span><span class="hs-comment">--</span><span>
</span><span id="line-231"></span><span class="hs-comment">-- 'getDBLayer' will provide the actual 'DBLayer' implementation. The database</span><span>
</span><span id="line-232"></span><span class="hs-comment">-- should be closed with 'destroyDBLayer'. If you use 'withDBLayer' then both of</span><span>
</span><span id="line-233"></span><span class="hs-comment">-- these things will be handled for you.</span><span>
</span><span id="line-234"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#newDBLayer"><span class="hs-identifier hs-type">newDBLayer</span></a></span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-type">Tracer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Log.html#PoolDbLog"><span class="hs-identifier hs-type">PoolDbLog</span></a></span><span>
</span><span id="line-236"></span><span>       </span><span class="hs-comment">-- ^ Logging object</span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier hs-type">TimeInterpreter</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-238"></span><span>       </span><span class="hs-comment">-- ^ Time interpreter for slot to time conversions</span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#SqliteContext"><span class="hs-identifier hs-type">SqliteContext</span></a></span><span>
</span><span id="line-240"></span><span>        </span><span class="hs-comment">-- ^ A (thread-) safe wrapper for running db queries.</span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.html#DBLayer"><span class="hs-identifier hs-type">DBLayer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-242"></span><span id="newDBLayer"><span class="annot"><span class="annottext">newDBLayer :: Tracer IO PoolDbLog
-&gt; TimeInterpreter IO -&gt; SqliteContext -&gt; DBLayer IO
</span><a href="Cardano.Pool.DB.Sqlite.html#newDBLayer"><span class="hs-identifier hs-var hs-var">newDBLayer</span></a></span></span><span> </span><span id="local-6989586621682489077"><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682489077"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621682489076"><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682489076"><span class="hs-identifier hs-var">ti</span></a></span></span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#SqliteContext"><span class="hs-identifier hs-type">SqliteContext</span></a></span><span class="hs-special">{</span><span id="local-6989586621682489074"><span class="annot"><span class="annottext">forall a. SqlPersistT IO a -&gt; IO a
$sel:runQuery:SqliteContext :: SqliteContext -&gt; forall a. SqlPersistT IO a -&gt; IO a
runQuery :: forall a. SqlPersistT IO a -&gt; IO a
</span><a href="Cardano.DB.Sqlite.html#%24sel%3ArunQuery%3ASqliteContext"><span class="hs-identifier hs-var hs-var">runQuery</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-243"></span><span>    </span><span class="annot"><span class="annottext">DBLayer :: forall (m :: * -&gt; *) (stm :: * -&gt; *).
(MonadFail stm, MonadIO stm) =&gt;
(BlockHeader -&gt; PoolId -&gt; ExceptT ErrPointAlreadyExists stm ())
-&gt; (EpochNo -&gt; stm (Map PoolId [BlockHeader]))
-&gt; stm (Map PoolId (Quantity &quot;block&quot; Word64))
-&gt; (EpochNo -&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)] -&gt; stm ())
-&gt; (EpochNo -&gt; stm [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; (Int -&gt; stm [BlockHeader])
-&gt; (PoolId -&gt; stm PoolLifeCycleStatus)
-&gt; (CertificatePublicationTime
    -&gt; PoolRegistrationCertificate -&gt; stm ())
-&gt; (PoolId
    -&gt; stm
         (Maybe (CertificatePublicationTime, PoolRegistrationCertificate)))
-&gt; (CertificatePublicationTime
    -&gt; PoolRetirementCertificate -&gt; stm ())
-&gt; (PoolId
    -&gt; stm
         (Maybe (CertificatePublicationTime, PoolRetirementCertificate)))
-&gt; (Int
    -&gt; stm [(PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)])
-&gt; ((StakePoolMetadataUrl, StakePoolMetadataHash) -&gt; stm ())
-&gt; stm [PoolId]
-&gt; (EpochNo -&gt; stm [PoolRetirementCertificate])
-&gt; (EpochNo -&gt; stm [PoolLifeCycleStatus])
-&gt; (StakePoolMetadataHash -&gt; StakePoolMetadata -&gt; stm ())
-&gt; stm ()
-&gt; stm (Map StakePoolMetadataHash StakePoolMetadata)
-&gt; stm StdGen
-&gt; (SlotNo -&gt; stm ())
-&gt; ([PoolId] -&gt; stm ())
-&gt; stm [PoolId]
-&gt; ([PoolId] -&gt; stm ())
-&gt; (EpochNo -&gt; stm [PoolRetirementCertificate])
-&gt; (BlockHeader -&gt; stm ())
-&gt; (Int -&gt; stm [BlockHeader])
-&gt; stm Settings
-&gt; (Settings -&gt; stm ())
-&gt; stm (Maybe POSIXTime)
-&gt; (POSIXTime -&gt; stm ())
-&gt; stm ()
-&gt; (forall a. stm a -&gt; m a)
-&gt; DBLayer m
</span><a href="Cardano.Pool.DB.html#DBLayer"><span class="hs-identifier hs-type">DBLayer</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ReaderT SqlBackend IO [PoolId]
ReaderT SqlBackend IO (Maybe POSIXTime)
ReaderT SqlBackend IO ()
ReaderT SqlBackend IO (Map PoolId (Quantity &quot;block&quot; Word64))
ReaderT SqlBackend IO (Map StakePoolMetadataHash StakePoolMetadata)
ReaderT SqlBackend IO StdGen
ReaderT SqlBackend IO Settings
Int
-&gt; ReaderT
     SqlBackend
     IO
     [(PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)]
Int -&gt; ReaderT SqlBackend IO [BlockHeader]
[PoolId] -&gt; ReaderT SqlBackend IO ()
(StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; ReaderT SqlBackend IO ()
SlotNo -&gt; ReaderT SqlBackend IO ()
POSIXTime -&gt; ReaderT SqlBackend IO ()
Settings -&gt; ReaderT SqlBackend IO ()
CertificatePublicationTime
-&gt; PoolRetirementCertificate -&gt; ReaderT SqlBackend IO ()
CertificatePublicationTime
-&gt; PoolRegistrationCertificate -&gt; ReaderT SqlBackend IO ()
EpochNo
-&gt; ReaderT SqlBackend IO [(PoolId, Quantity &quot;lovelace&quot; Word64)]
EpochNo -&gt; SqlPersistT IO [PoolLifeCycleStatus]
EpochNo -&gt; ReaderT SqlBackend IO [PoolRetirementCertificate]
EpochNo -&gt; ReaderT SqlBackend IO (Map PoolId [BlockHeader])
EpochNo
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; ReaderT SqlBackend IO ()
BlockHeader -&gt; ReaderT SqlBackend IO ()
BlockHeader
-&gt; PoolId
-&gt; ExceptT ErrPointAlreadyExists (ReaderT SqlBackend IO) ()
PoolId
-&gt; ReaderT
     SqlBackend
     IO
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate))
PoolId
-&gt; ReaderT
     SqlBackend
     IO
     (Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
PoolId -&gt; ReaderT SqlBackend IO PoolLifeCycleStatus
StakePoolMetadataHash
-&gt; StakePoolMetadata -&gt; ReaderT SqlBackend IO ()
forall a. SqlPersistT IO a -&gt; IO a
forall backend (m :: * -&gt; *).
(PersistQueryRead backend, MonadIO m,
 BaseBackend backend ~ SqlBackend) =&gt;
Int -&gt; ReaderT backend m [BlockHeader]
forall backend (m :: * -&gt; *).
(PersistQueryRead backend, MonadIO m,
 BaseBackend backend ~ SqlBackend) =&gt;
EpochNo -&gt; ReaderT backend m [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall backend (m :: * -&gt; *).
(PersistQueryRead backend, MonadIO m, PersistStoreWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
(StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; ReaderT backend m ()
forall a (m :: * -&gt; *) a a a backend.
(Show a, PersistField a, PersistField a, PersistField a, MonadIO m,
 BackendCompatible SqlBackend backend) =&gt;
a -&gt; ReaderT backend m [(a, a, a)]
forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryRead backend,
 BaseBackend backend ~ SqlBackend) =&gt;
PoolId
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate))
forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryRead backend,
 BaseBackend backend ~ SqlBackend) =&gt;
PoolId
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryRead backend,
 BaseBackend backend ~ SqlBackend) =&gt;
PoolId -&gt; ReaderT backend m PoolLifeCycleStatus
forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryRead backend, PersistStoreWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
POSIXTime -&gt; ReaderT backend m ()
forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
[PoolId] -&gt; ReaderT backend m ()
forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
CertificatePublicationTime
-&gt; PoolRegistrationCertificate -&gt; ReaderT backend m ()
forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
EpochNo
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)] -&gt; ReaderT backend m ()
forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
StakePoolMetadataHash -&gt; StakePoolMetadata -&gt; ReaderT backend m ()
forall (m :: * -&gt; *) backend.
(MonadIO m, PersistStoreWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
CertificatePublicationTime
-&gt; PoolRetirementCertificate -&gt; ReaderT backend m ()
forall (m :: * -&gt; *) backend.
(MonadIO m, PersistStoreWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
BlockHeader -&gt; ReaderT backend m ()
forall (m :: * -&gt; *) backend.
(PersistStoreWrite backend, MonadUnliftIO m,
 BaseBackend backend ~ SqlBackend) =&gt;
BlockHeader
-&gt; PoolId -&gt; ExceptT ErrPointAlreadyExists (ReaderT backend m) ()
atomically :: forall a. SqlPersistT IO a -&gt; IO a
cleanDB :: ReaderT SqlBackend IO ()
putLastMetadataGC :: POSIXTime -&gt; ReaderT SqlBackend IO ()
readLastMetadataGC :: ReaderT SqlBackend IO (Maybe POSIXTime)
putSettings :: Settings -&gt; ReaderT SqlBackend IO ()
readSettings :: ReaderT SqlBackend IO Settings
listHeaders :: Int -&gt; ReaderT SqlBackend IO [BlockHeader]
putHeader :: BlockHeader -&gt; ReaderT SqlBackend IO ()
removeRetiredPools :: EpochNo -&gt; ReaderT SqlBackend IO [PoolRetirementCertificate]
removePools :: [PoolId] -&gt; ReaderT SqlBackend IO ()
readDelistedPools :: ReaderT SqlBackend IO [PoolId]
putDelistedPools :: [PoolId] -&gt; ReaderT SqlBackend IO ()
rollbackTo :: SlotNo -&gt; ReaderT SqlBackend IO ()
readSystemSeed :: ReaderT SqlBackend IO StdGen
readPoolMetadata :: ReaderT SqlBackend IO (Map StakePoolMetadataHash StakePoolMetadata)
removePoolMetadata :: ReaderT SqlBackend IO ()
putPoolMetadata :: StakePoolMetadataHash
-&gt; StakePoolMetadata -&gt; ReaderT SqlBackend IO ()
listPoolLifeCycleData :: EpochNo -&gt; SqlPersistT IO [PoolLifeCycleStatus]
listRetiredPools :: EpochNo -&gt; ReaderT SqlBackend IO [PoolRetirementCertificate]
listRegisteredPools :: ReaderT SqlBackend IO [PoolId]
putFetchAttempt :: (StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; ReaderT SqlBackend IO ()
unfetchedPoolMetadataRefs :: Int
-&gt; ReaderT
     SqlBackend
     IO
     [(PoolId, StakePoolMetadataUrl, StakePoolMetadataHash)]
readPoolRetirement :: PoolId
-&gt; ReaderT
     SqlBackend
     IO
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate))
putPoolRetirement :: CertificatePublicationTime
-&gt; PoolRetirementCertificate -&gt; ReaderT SqlBackend IO ()
readPoolRegistration :: PoolId
-&gt; ReaderT
     SqlBackend
     IO
     (Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
putPoolRegistration :: CertificatePublicationTime
-&gt; PoolRegistrationCertificate -&gt; ReaderT SqlBackend IO ()
readPoolLifeCycleStatus :: PoolId -&gt; ReaderT SqlBackend IO PoolLifeCycleStatus
readPoolProductionCursor :: Int -&gt; ReaderT SqlBackend IO [BlockHeader]
readStakeDistribution :: EpochNo
-&gt; ReaderT SqlBackend IO [(PoolId, Quantity &quot;lovelace&quot; Word64)]
putStakeDistribution :: EpochNo
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; ReaderT SqlBackend IO ()
readTotalProduction :: ReaderT SqlBackend IO (Map PoolId (Quantity &quot;block&quot; Word64))
readPoolProduction :: EpochNo -&gt; ReaderT SqlBackend IO (Map PoolId [BlockHeader])
putPoolProduction :: BlockHeader
-&gt; PoolId
-&gt; ExceptT ErrPointAlreadyExists (ReaderT SqlBackend IO) ()
listHeaders :: forall backend (m :: * -&gt; *).
(PersistQueryRead backend, MonadIO m,
 BaseBackend backend ~ SqlBackend) =&gt;
Int -&gt; ReaderT backend m [BlockHeader]
putHeader :: forall (m :: * -&gt; *) backend.
(MonadIO m, PersistStoreWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
BlockHeader -&gt; ReaderT backend m ()
readPoolRetirement :: forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryRead backend,
 BaseBackend backend ~ SqlBackend) =&gt;
PoolId
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate))
readPoolRegistration :: forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryRead backend,
 BaseBackend backend ~ SqlBackend) =&gt;
PoolId
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
atomically :: forall a. SqlPersistT IO a -&gt; IO a
cleanDB :: ReaderT SqlBackend IO ()
putLastMetadataGC :: forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryRead backend, PersistStoreWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
POSIXTime -&gt; ReaderT backend m ()
readLastMetadataGC :: ReaderT SqlBackend IO (Maybe POSIXTime)
putSettings :: Settings -&gt; ReaderT SqlBackend IO ()
readSettings :: ReaderT SqlBackend IO Settings
readSystemSeed :: ReaderT SqlBackend IO StdGen
readPoolProductionCursor :: forall backend (m :: * -&gt; *).
(PersistQueryRead backend, MonadIO m,
 BaseBackend backend ~ SqlBackend) =&gt;
Int -&gt; ReaderT backend m [BlockHeader]
removeRetiredPools :: EpochNo -&gt; ReaderT SqlBackend IO [PoolRetirementCertificate]
removePools :: [PoolId] -&gt; ReaderT SqlBackend IO ()
readDelistedPools :: ReaderT SqlBackend IO [PoolId]
putDelistedPools :: forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
[PoolId] -&gt; ReaderT backend m ()
rollbackTo :: SlotNo -&gt; ReaderT SqlBackend IO ()
listPoolLifeCycleData :: EpochNo -&gt; SqlPersistT IO [PoolLifeCycleStatus]
listRetiredPools :: EpochNo -&gt; ReaderT SqlBackend IO [PoolRetirementCertificate]
listRegisteredPools :: ReaderT SqlBackend IO [PoolId]
readPoolMetadata :: ReaderT SqlBackend IO (Map StakePoolMetadataHash StakePoolMetadata)
removePoolMetadata :: ReaderT SqlBackend IO ()
putPoolMetadata :: forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
StakePoolMetadataHash -&gt; StakePoolMetadata -&gt; ReaderT backend m ()
putFetchAttempt :: forall backend (m :: * -&gt; *).
(PersistQueryRead backend, MonadIO m, PersistStoreWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
(StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; ReaderT backend m ()
unfetchedPoolMetadataRefs :: forall a (m :: * -&gt; *) a a a backend.
(Show a, PersistField a, PersistField a, PersistField a, MonadIO m,
 BackendCompatible SqlBackend backend) =&gt;
a -&gt; ReaderT backend m [(a, a, a)]
putPoolRetirement :: forall (m :: * -&gt; *) backend.
(MonadIO m, PersistStoreWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
CertificatePublicationTime
-&gt; PoolRetirementCertificate -&gt; ReaderT backend m ()
putPoolRegistration :: forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
CertificatePublicationTime
-&gt; PoolRegistrationCertificate -&gt; ReaderT backend m ()
readPoolLifeCycleStatus :: forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryRead backend,
 BaseBackend backend ~ SqlBackend) =&gt;
PoolId -&gt; ReaderT backend m PoolLifeCycleStatus
readStakeDistribution :: forall backend (m :: * -&gt; *).
(PersistQueryRead backend, MonadIO m,
 BaseBackend backend ~ SqlBackend) =&gt;
EpochNo -&gt; ReaderT backend m [(PoolId, Quantity &quot;lovelace&quot; Word64)]
putStakeDistribution :: forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryWrite backend,
 BaseBackend backend ~ SqlBackend) =&gt;
EpochNo
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)] -&gt; ReaderT backend m ()
readTotalProduction :: ReaderT SqlBackend IO (Map PoolId (Quantity &quot;block&quot; Word64))
readPoolProduction :: EpochNo -&gt; ReaderT SqlBackend IO (Map PoolId [BlockHeader])
putPoolProduction :: forall (m :: * -&gt; *) backend.
(PersistStoreWrite backend, MonadUnliftIO m,
 BaseBackend backend ~ SqlBackend) =&gt;
BlockHeader
-&gt; PoolId -&gt; ExceptT ErrPointAlreadyExists (ReaderT backend m) ()
</span><a href="Cardano.Pool.DB.html#atomically"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-244"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-245"></span><span>        </span><span id="local-6989586621682489071"><span class="annot"><span class="annottext">putPoolProduction :: BlockHeader
-&gt; PoolId -&gt; ExceptT ErrPointAlreadyExists (ReaderT backend m) ()
</span><a href="#local-6989586621682489071"><span class="hs-identifier hs-var hs-var">putPoolProduction</span></a></span></span><span> </span><span id="local-6989586621682489005"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682489005"><span class="hs-identifier hs-var">point</span></a></span></span><span> </span><span id="local-6989586621682489004"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682489004"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReaderT backend m (Either ErrPointAlreadyExists ())
-&gt; ExceptT ErrPointAlreadyExists (ReaderT backend m) ()
forall e (m :: * -&gt; *) a. m (Either e a) -&gt; ExceptT e m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT backend m (Either ErrPointAlreadyExists ())
 -&gt; ExceptT ErrPointAlreadyExists (ReaderT backend m) ())
-&gt; ReaderT backend m (Either ErrPointAlreadyExists ())
-&gt; ExceptT ErrPointAlreadyExists (ReaderT backend m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-246"></span><span>            </span><span class="annot"><span class="annottext">ErrPointAlreadyExists
-&gt; ReaderT backend m ()
-&gt; ReaderT backend m (Either ErrPointAlreadyExists ())
forall (m :: * -&gt; *) e a.
MonadUnliftIO m =&gt;
e -&gt; m a -&gt; m (Either e a)
</span><a href="Cardano.DB.Sqlite.html#handleConstraint"><span class="hs-identifier hs-var">handleConstraint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; ErrPointAlreadyExists
</span><a href="Cardano.Pool.DB.html#ErrPointAlreadyExists"><span class="hs-identifier hs-var">ErrPointAlreadyExists</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682489005"><span class="hs-identifier hs-var">point</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ReaderT backend m ()
 -&gt; ReaderT backend m (Either ErrPointAlreadyExists ()))
-&gt; ReaderT backend m ()
-&gt; ReaderT backend m (Either ErrPointAlreadyExists ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-247"></span><span>                </span><span class="annot"><span class="annottext">PoolProduction -&gt; ReaderT backend m ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insert_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolId -&gt; BlockHeader -&gt; PoolProduction
</span><a href="Cardano.Pool.DB.Sqlite.html#mkPoolProduction"><span class="hs-identifier hs-var">mkPoolProduction</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682489004"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682489005"><span class="hs-identifier hs-var">point</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span>        </span><span id="local-6989586621682489070"><span class="annot"><span class="annottext">readPoolProduction :: EpochNo -&gt; ReaderT SqlBackend IO (Map PoolId [BlockHeader])
</span><a href="#local-6989586621682489070"><span class="hs-identifier hs-var hs-var">readPoolProduction</span></a></span></span><span> </span><span id="local-6989586621682489000"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682489000"><span class="hs-identifier hs-var">epoch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-250"></span><span>            </span><span id="local-6989586621682488999"><span class="annot"><span class="annottext">[(PoolId, BlockHeader)]
</span><a href="#local-6989586621682488999"><span class="hs-identifier hs-var">production</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PoolProduction -&gt; (PoolId, BlockHeader))
-&gt; [PoolProduction] -&gt; [(PoolId, BlockHeader)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">PoolProduction -&gt; (PoolId, BlockHeader)
</span><a href="Cardano.Pool.DB.Sqlite.html#fromPoolProduction"><span class="hs-identifier hs-var">fromPoolProduction</span></a></span><span>
</span><span id="line-251"></span><span>                </span><span class="annot"><span class="annottext">([PoolProduction] -&gt; [(PoolId, BlockHeader)])
-&gt; ReaderT SqlBackend IO [PoolProduction]
-&gt; ReaderT SqlBackend IO [(PoolId, BlockHeader)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO
-&gt; EpochNo -&gt; ReaderT SqlBackend IO [PoolProduction]
</span><a href="Cardano.Pool.DB.Sqlite.html#selectPoolProduction"><span class="hs-identifier hs-var">selectPoolProduction</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682489076"><span class="hs-identifier hs-var">ti</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682489000"><span class="hs-identifier hs-var">epoch</span></a></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682489352"><span id="local-6989586621682489353"><span class="annot"><a href="#local-6989586621682488995"><span class="hs-identifier hs-type">toMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489353"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489353"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682489352"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682489353"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621682489352"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489353"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682489352"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-254"></span><span>                </span><span id="local-6989586621682488995"><span class="annot"><span class="annottext">toMap :: Map a [b] -&gt; (a, b) -&gt; Map a [b]
</span><a href="#local-6989586621682488995"><span class="hs-identifier hs-var hs-var">toMap</span></a></span></span><span> </span><span id="local-6989586621682488994"><span class="annot"><span class="annottext">Map a [b]
</span><a href="#local-6989586621682488994"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682488993"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682488993"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682488992"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621682488992"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe [b] -&gt; Maybe [b]) -&gt; a -&gt; Map a [b] -&gt; Map a [b]
forall k a.
Ord k =&gt;
(Maybe a -&gt; Maybe a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.alter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Maybe [b] -&gt; Maybe [b]
forall a. a -&gt; Maybe [a] -&gt; Maybe [a]
</span><a href="#local-6989586621682488990"><span class="hs-identifier hs-var">alter</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621682488992"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682488993"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Map a [b]
</span><a href="#local-6989586621682488994"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-255"></span><span>                  </span><span class="hs-keyword">where</span><span>
</span><span id="line-256"></span><span>                    </span><span id="local-6989586621682488990"><span class="annot"><span class="annottext">alter :: a -&gt; Maybe [a] -&gt; Maybe [a]
</span><a href="#local-6989586621682488990"><span class="hs-identifier hs-var hs-var">alter</span></a></span></span><span> </span><span id="local-6989586621682488989"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682488989"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-257"></span><span>                      </span><span class="annot"><span class="annottext">Maybe [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Maybe [a]
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682488989"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-258"></span><span>                      </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682488988"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682488988"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Maybe [a]
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682488989"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621682488988"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>            </span><span class="annot"><span class="annottext">Map PoolId [BlockHeader]
-&gt; ReaderT SqlBackend IO (Map PoolId [BlockHeader])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map PoolId [BlockHeader]
 -&gt; (PoolId, BlockHeader) -&gt; Map PoolId [BlockHeader])
-&gt; Map PoolId [BlockHeader]
-&gt; [(PoolId, BlockHeader)]
-&gt; Map PoolId [BlockHeader]
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">Map PoolId [BlockHeader]
-&gt; (PoolId, BlockHeader) -&gt; Map PoolId [BlockHeader]
forall a b. Ord a =&gt; Map a [b] -&gt; (a, b) -&gt; Map a [b]
</span><a href="#local-6989586621682488995"><span class="hs-identifier hs-var">toMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map PoolId [BlockHeader]
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">[(PoolId, BlockHeader)]
</span><a href="#local-6989586621682488999"><span class="hs-identifier hs-var">production</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>        </span><span id="local-6989586621682489069"><span class="annot"><span class="annottext">readTotalProduction :: ReaderT SqlBackend IO (Map PoolId (Quantity &quot;block&quot; Word64))
</span><a href="#local-6989586621682489069"><span class="hs-identifier hs-var hs-var">readTotalProduction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(PoolId, Quantity &quot;block&quot; Word64)]
-&gt; Map PoolId (Quantity &quot;block&quot; Word64)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(PoolId, Quantity &quot;block&quot; Word64)]
 -&gt; Map PoolId (Quantity &quot;block&quot; Word64))
-&gt; ReaderT SqlBackend IO [(PoolId, Quantity &quot;block&quot; Word64)]
-&gt; ReaderT SqlBackend IO (Map PoolId (Quantity &quot;block&quot; Word64))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
-&gt; RawQuery
     (Single PersistValue, Single PersistValue)
     (PoolId, Quantity &quot;block&quot; Word64)
-&gt; ReaderT SqlBackend IO [(PoolId, Quantity &quot;block&quot; Word64)]
forall a b.
RawSql a =&gt;
Tracer IO PoolDbLog -&gt; RawQuery a b -&gt; SqlPersistT IO [b]
</span><a href="Cardano.Pool.DB.Sqlite.html#runRawQuery"><span class="hs-identifier hs-var">runRawQuery</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682489077"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-263"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
-&gt; Text
-&gt; [PersistValue]
-&gt; ((Single PersistValue, Single PersistValue)
    -&gt; Either Text (PoolId, Quantity &quot;block&quot; Word64))
-&gt; RawQuery
     (Single PersistValue, Single PersistValue)
     (PoolId, Quantity &quot;block&quot; Word64)
forall a b.
Text
-&gt; Text -&gt; [PersistValue] -&gt; (a -&gt; Either Text b) -&gt; RawQuery a b
</span><a href="Cardano.Pool.DB.Sqlite.html#RawQuery"><span class="hs-identifier hs-var">RawQuery</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;readTotalProduction&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488983"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Single PersistValue, Single PersistValue)
-&gt; Either Text (PoolId, Quantity &quot;block&quot; Word64)
forall a a (unit :: Symbol).
(PersistField a, PersistField a) =&gt;
(Single PersistValue, Single PersistValue)
-&gt; Either Text (a, Quantity unit a)
</span><a href="#local-6989586621682488982"><span class="hs-identifier hs-var">parseRow</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-265"></span><span>            </span><span id="local-6989586621682488983"><span class="annot"><span class="annottext">query :: Text
</span><a href="#local-6989586621682488983"><span class="hs-identifier hs-var hs-var">query</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">T.unwords</span></a></span><span>
</span><span id="line-266"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;SELECT pool_id, count(pool_id) as block_count&quot;</span></span><span>
</span><span id="line-267"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;FROM pool_production&quot;</span></span><span>
</span><span id="line-268"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;GROUP BY pool_id;&quot;</span></span><span>
</span><span id="line-269"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-270"></span><span>            </span><span id="local-6989586621682488982"><span class="annot"><span class="annottext">parseRow :: (Single PersistValue, Single PersistValue)
-&gt; Either Text (a, Quantity unit a)
</span><a href="#local-6989586621682488982"><span class="hs-identifier hs-var hs-var">parseRow</span></a></span></span><span>
</span><span id="line-271"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488979"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488979"><span class="hs-identifier hs-var">fieldPoolId</span></a></span></span><span>
</span><span id="line-272"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488978"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488978"><span class="hs-identifier hs-var">fieldBlockCount</span></a></span></span><span>
</span><span id="line-273"></span><span>                </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>                    </span><span class="annot"><span class="annottext">(a -&gt; Quantity unit a -&gt; (a, Quantity unit a))
-&gt; Either Text a
-&gt; Either Text (Quantity unit a -&gt; (a, Quantity unit a))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text a
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488979"><span class="hs-identifier hs-var">fieldPoolId</span></a></span><span>
</span><span id="line-275"></span><span>                    </span><span class="annot"><span class="annottext">Either Text (Quantity unit a -&gt; (a, Quantity unit a))
-&gt; Either Text (Quantity unit a)
-&gt; Either Text (a, Quantity unit a)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Quantity unit a
forall (unit :: Symbol) a. a -&gt; Quantity unit a
</span><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-var">Quantity</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Quantity unit a)
-&gt; Either Text a -&gt; Either Text (Quantity unit a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text a
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488978"><span class="hs-identifier hs-var">fieldBlockCount</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span>        </span><span id="local-6989586621682489068"><span class="annot"><span class="annottext">putStakeDistribution :: EpochNo
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)] -&gt; ReaderT backend m ()
</span><a href="#local-6989586621682489068"><span class="hs-identifier hs-var hs-var">putStakeDistribution</span></a></span></span><span> </span><span id="local-6989586621682488976"><span class="annot"><span class="annottext">epoch :: EpochNo
</span><a href="#local-6989586621682488976"><span class="hs-identifier hs-var">epoch</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a></span><span> </span><span id="local-6989586621682488974"><span class="annot"><span class="annottext">Word31
</span><a href="#local-6989586621682488974"><span class="hs-identifier hs-var">ep</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682488973"><span class="annot"><span class="annottext">[(PoolId, Quantity &quot;lovelace&quot; Word64)]
</span><a href="#local-6989586621682488973"><span class="hs-identifier hs-var">distribution</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-278"></span><span>            </span><span class="annot"><span class="annottext">[Filter StakeDistribution] -&gt; ReaderT backend m ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField StakeDistribution Word64
forall typ. (typ ~ Word64) =&gt; EntityField StakeDistribution typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#StakeDistributionEpoch"><span class="hs-identifier hs-var">StakeDistributionEpoch</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField StakeDistribution Word64
-&gt; Word64 -&gt; Filter StakeDistribution
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">Word31 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word31
</span><a href="#local-6989586621682488974"><span class="hs-identifier hs-var">ep</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-279"></span><span>            </span><span class="annot"><span class="annottext">[StakeDistribution] -&gt; ReaderT backend m ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insertMany_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpochNo
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)] -&gt; [StakeDistribution]
</span><a href="Cardano.Pool.DB.Sqlite.html#mkStakeDistribution"><span class="hs-identifier hs-var">mkStakeDistribution</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682488976"><span class="hs-identifier hs-var">epoch</span></a></span><span> </span><span class="annot"><span class="annottext">[(PoolId, Quantity &quot;lovelace&quot; Word64)]
</span><a href="#local-6989586621682488973"><span class="hs-identifier hs-var">distribution</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span>        </span><span id="local-6989586621682489067"><span class="annot"><span class="annottext">readStakeDistribution :: EpochNo -&gt; ReaderT backend m [(PoolId, Quantity &quot;lovelace&quot; Word64)]
</span><a href="#local-6989586621682489067"><span class="hs-identifier hs-var hs-var">readStakeDistribution</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a></span><span> </span><span id="local-6989586621682488970"><span class="annot"><span class="annottext">Word31
</span><a href="#local-6989586621682488970"><span class="hs-identifier hs-var">epoch</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>            </span><span class="annot"><span class="annottext">(Entity StakeDistribution -&gt; (PoolId, Quantity &quot;lovelace&quot; Word64))
-&gt; [Entity StakeDistribution]
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StakeDistribution -&gt; (PoolId, Quantity &quot;lovelace&quot; Word64)
</span><a href="Cardano.Pool.DB.Sqlite.html#fromStakeDistribution"><span class="hs-identifier hs-var">fromStakeDistribution</span></a></span><span> </span><span class="annot"><span class="annottext">(StakeDistribution -&gt; (PoolId, Quantity &quot;lovelace&quot; Word64))
-&gt; (Entity StakeDistribution -&gt; StakeDistribution)
-&gt; Entity StakeDistribution
-&gt; (PoolId, Quantity &quot;lovelace&quot; Word64)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity StakeDistribution -&gt; StakeDistribution
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Entity StakeDistribution]
 -&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)])
-&gt; ReaderT backend m [Entity StakeDistribution]
-&gt; ReaderT backend m [(PoolId, Quantity &quot;lovelace&quot; Word64)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter StakeDistribution]
-&gt; [SelectOpt StakeDistribution]
-&gt; ReaderT backend m [Entity StakeDistribution]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-283"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField StakeDistribution Word64
forall typ. (typ ~ Word64) =&gt; EntityField StakeDistribution typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#StakeDistributionEpoch"><span class="hs-identifier hs-var">StakeDistributionEpoch</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField StakeDistribution Word64
-&gt; Word64 -&gt; Filter StakeDistribution
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">Word31 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word31
</span><a href="#local-6989586621682488970"><span class="hs-identifier hs-var">epoch</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-284"></span><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span>        </span><span id="local-6989586621682489066"><span class="annot"><span class="annottext">readPoolLifeCycleStatus :: PoolId -&gt; ReaderT backend m PoolLifeCycleStatus
</span><a href="#local-6989586621682489066"><span class="hs-identifier hs-var hs-var">readPoolLifeCycleStatus</span></a></span></span><span> </span><span id="local-6989586621682488967"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488967"><span class="hs-identifier hs-var">poolId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-287"></span><span>            </span><span class="annot"><span class="annottext">Maybe (CertificatePublicationTime, PoolRegistrationCertificate)
-&gt; Maybe (CertificatePublicationTime, PoolRetirementCertificate)
-&gt; PoolLifeCycleStatus
forall publicationTime.
(Ord publicationTime, Show publicationTime) =&gt;
Maybe (publicationTime, PoolRegistrationCertificate)
-&gt; Maybe (publicationTime, PoolRetirementCertificate)
-&gt; PoolLifeCycleStatus
</span><a href="Cardano.Pool.DB.html#determinePoolLifeCycleStatus"><span class="hs-identifier hs-var">determinePoolLifeCycleStatus</span></a></span><span>
</span><span id="line-288"></span><span>                </span><span class="annot"><span class="annottext">(Maybe (CertificatePublicationTime, PoolRegistrationCertificate)
 -&gt; Maybe (CertificatePublicationTime, PoolRetirementCertificate)
 -&gt; PoolLifeCycleStatus)
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate)
      -&gt; PoolLifeCycleStatus)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryRead backend,
 BaseBackend backend ~ SqlBackend) =&gt;
PoolId
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
</span><a href="#local-6989586621682489042"><span class="hs-identifier hs-var">readPoolRegistration</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488967"><span class="hs-identifier hs-var">poolId</span></a></span><span>
</span><span id="line-289"></span><span>                </span><span class="annot"><span class="annottext">ReaderT
  backend
  m
  (Maybe (CertificatePublicationTime, PoolRetirementCertificate)
   -&gt; PoolLifeCycleStatus)
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate))
-&gt; ReaderT backend m PoolLifeCycleStatus
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate))
forall (m :: * -&gt; *) backend.
(MonadIO m, PersistQueryRead backend,
 BaseBackend backend ~ SqlBackend) =&gt;
PoolId
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate))
</span><a href="#local-6989586621682489041"><span class="hs-identifier hs-var">readPoolRetirement</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488967"><span class="hs-identifier hs-var">poolId</span></a></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span>        </span><span id="local-6989586621682489065"><span class="annot"><span class="annottext">putPoolRegistration :: CertificatePublicationTime
-&gt; PoolRegistrationCertificate -&gt; ReaderT backend m ()
</span><a href="#local-6989586621682489065"><span class="hs-identifier hs-var hs-var">putPoolRegistration</span></a></span></span><span> </span><span id="local-6989586621682488966"><span class="annot"><span class="annottext">CertificatePublicationTime
</span><a href="#local-6989586621682488966"><span class="hs-identifier hs-var">cpt</span></a></span></span><span> </span><span id="local-6989586621682488965"><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682488965"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-292"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#CertificatePublicationTime"><span class="hs-identifier hs-type">CertificatePublicationTime</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621682488963"><span class="annot"><span class="annottext">SlotNo
$sel:slotNo:CertificatePublicationTime :: CertificatePublicationTime -&gt; SlotNo
slotNo :: SlotNo
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AslotNo%3ACertificatePublicationTime"><span class="hs-identifier hs-var hs-var">slotNo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682488961"><span class="annot"><span class="annottext">Word64
$sel:slotInternalIndex:CertificatePublicationTime :: CertificatePublicationTime -&gt; Word64
slotInternalIndex :: Word64
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AslotInternalIndex%3ACertificatePublicationTime"><span class="hs-identifier hs-var hs-var">slotInternalIndex</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CertificatePublicationTime
</span><a href="#local-6989586621682488966"><span class="hs-identifier hs-var">cpt</span></a></span><span>
</span><span id="line-293"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488959"><span class="annot"><span class="annottext">poolId :: PoolId
</span><a href="#local-6989586621682488959"><span class="hs-identifier hs-var hs-var">poolId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((PoolId -&gt; Const PoolId PoolId)
 -&gt; PoolRegistrationCertificate
 -&gt; Const PoolId PoolRegistrationCertificate)
-&gt; PoolRegistrationCertificate -&gt; PoolId
forall a s. ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; s -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;poolId&quot;
  ((PoolId -&gt; Const PoolId PoolId)
   -&gt; PoolRegistrationCertificate
   -&gt; Const PoolId PoolRegistrationCertificate)
(PoolId -&gt; Const PoolId PoolId)
-&gt; PoolRegistrationCertificate
-&gt; Const PoolId PoolRegistrationCertificate
</span><a href="#local-6989586621682488958"><span class="hs-var">#poolId</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682488965"><span class="hs-identifier hs-var">cert</span></a></span><span>
</span><span id="line-294"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolOwner] -&gt; ReaderT backend m ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span>
</span><span id="line-295"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolOwner PoolId
forall typ. (typ ~ PoolId) =&gt; EntityField PoolOwner typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolOwnerPoolId"><span class="hs-identifier hs-var">PoolOwnerPoolId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolOwner PoolId -&gt; PoolId -&gt; Filter PoolOwner
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488959"><span class="hs-identifier hs-var">poolId</span></a></span><span>
</span><span id="line-296"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField PoolOwner SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField PoolOwner typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolOwnerSlot"><span class="hs-identifier hs-var">PoolOwnerSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolOwner SlotNo -&gt; SlotNo -&gt; Filter PoolOwner
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488963"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-297"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField PoolOwner Word64
forall typ. (typ ~ Word64) =&gt; EntityField PoolOwner typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolOwnerSlotInternalIndex"><span class="hs-identifier hs-var">PoolOwnerSlotInternalIndex</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolOwner Word64 -&gt; Word64 -&gt; Filter PoolOwner
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488961"><span class="hs-identifier hs-var">slotInternalIndex</span></a></span><span>
</span><span id="line-298"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-299"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488954"><span class="annot"><span class="annottext">poolRegistrationKey :: Key PoolRegistration
</span><a href="#local-6989586621682488954"><span class="hs-identifier hs-var hs-var">poolRegistrationKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolId -&gt; SlotNo -&gt; Word64 -&gt; Key PoolRegistration
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistrationKey"><span class="hs-identifier hs-var">PoolRegistrationKey</span></a></span><span>
</span><span id="line-300"></span><span>                    </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488959"><span class="hs-identifier hs-var">poolId</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488963"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488961"><span class="hs-identifier hs-var">slotInternalIndex</span></a></span><span>
</span><span id="line-301"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488952"><span class="annot"><span class="annottext">poolRegistrationRow :: PoolRegistration
</span><a href="#local-6989586621682488952"><span class="hs-identifier hs-var hs-var">poolRegistrationRow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolId
-&gt; SlotNo
-&gt; Word64
-&gt; Word64
-&gt; Word64
-&gt; Word64
-&gt; Word64
-&gt; Maybe StakePoolMetadataUrl
-&gt; Maybe StakePoolMetadataHash
-&gt; PoolRegistration
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistration"><span class="hs-identifier hs-var">PoolRegistration</span></a></span><span>
</span><span id="line-302"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488959"><span class="hs-identifier hs-var">poolId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488963"><span class="hs-identifier hs-var">slotNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488961"><span class="hs-identifier hs-var">slotInternalIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Word64) -&gt; Integer -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Integer -&gt; Integer
forall a. Ratio a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">numerator</span></a></span><span>
</span><span id="line-306"></span><span>                        </span><span class="annot"><span class="annottext">(Ratio Integer -&gt; Integer) -&gt; Ratio Integer -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Percentage -&gt; Ratio Integer
</span><a href="Data.Quantity.html#getPercentage"><span class="hs-identifier hs-var hs-var">getPercentage</span></a></span><span> </span><span class="annot"><span class="annottext">(Percentage -&gt; Ratio Integer) -&gt; Percentage -&gt; Ratio Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate -&gt; Percentage
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3ApoolMargin%3APoolRegistrationCertificate"><span class="hs-identifier hs-var hs-var">poolMargin</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682488965"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Word64) -&gt; Integer -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Integer -&gt; Integer
forall a. Ratio a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">denominator</span></a></span><span>
</span><span id="line-308"></span><span>                        </span><span class="annot"><span class="annottext">(Ratio Integer -&gt; Integer) -&gt; Ratio Integer -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Percentage -&gt; Ratio Integer
</span><a href="Data.Quantity.html#getPercentage"><span class="hs-identifier hs-var hs-var">getPercentage</span></a></span><span> </span><span class="annot"><span class="annottext">(Percentage -&gt; Ratio Integer) -&gt; Percentage -&gt; Ratio Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate -&gt; Percentage
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3ApoolMargin%3APoolRegistrationCertificate"><span class="hs-identifier hs-var hs-var">poolMargin</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682488965"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; Coin -&gt; Word64
Coin -&gt; Word64
</span><a href="Cardano.Wallet.Primitive.Types.Coin.html#unsafeToWord64"><span class="hs-identifier hs-var">Coin.unsafeToWord64</span></a></span><span> </span><span class="annot"><span class="annottext">(Coin -&gt; Word64) -&gt; Coin -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate -&gt; Coin
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3ApoolCost%3APoolRegistrationCertificate"><span class="hs-identifier hs-var hs-var">poolCost</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682488965"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; Coin -&gt; Word64
Coin -&gt; Word64
</span><a href="Cardano.Wallet.Primitive.Types.Coin.html#unsafeToWord64"><span class="hs-identifier hs-var">Coin.unsafeToWord64</span></a></span><span> </span><span class="annot"><span class="annottext">(Coin -&gt; Word64) -&gt; Coin -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate -&gt; Coin
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3ApoolPledge%3APoolRegistrationCertificate"><span class="hs-identifier hs-var hs-var">poolPledge</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682488965"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; StakePoolMetadataUrl
forall a b. (a, b) -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">((StakePoolMetadataUrl, StakePoolMetadataHash)
 -&gt; StakePoolMetadataUrl)
-&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; Maybe StakePoolMetadataUrl
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
-&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3ApoolMetadata%3APoolRegistrationCertificate"><span class="hs-identifier hs-var hs-var">poolMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682488965"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; StakePoolMetadataHash
forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">((StakePoolMetadataUrl, StakePoolMetadataHash)
 -&gt; StakePoolMetadataHash)
-&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; Maybe StakePoolMetadataHash
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
-&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3ApoolMetadata%3APoolRegistrationCertificate"><span class="hs-identifier hs-var hs-var">poolMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682488965"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>            </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Key PoolRegistration -&gt; PoolRegistration -&gt; ReaderT backend m ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
Key record -&gt; record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">repsert</span></a></span><span> </span><span class="annot"><span class="annottext">Key PoolRegistration
</span><a href="#local-6989586621682488954"><span class="hs-identifier hs-var">poolRegistrationKey</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistration
</span><a href="#local-6989586621682488952"><span class="hs-identifier hs-var">poolRegistrationRow</span></a></span><span>
</span><span id="line-314"></span><span>            </span><span class="annot"><span class="annottext">[PoolOwner] -&gt; ReaderT backend m ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insertMany_</span></a></span><span> </span><span class="annot"><span class="annottext">([PoolOwner] -&gt; ReaderT backend m ())
-&gt; [PoolOwner] -&gt; ReaderT backend m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-315"></span><span>                </span><span class="annot"><span class="annottext">(PoolOwner -&gt; Word8 -&gt; PoolOwner)
-&gt; [PoolOwner] -&gt; [Word8] -&gt; [PoolOwner]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">zipWith</span></a></span><span>
</span><span id="line-316"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolId -&gt; SlotNo -&gt; Word64 -&gt; PoolOwner -&gt; Word8 -&gt; PoolOwner
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolOwner"><span class="hs-identifier hs-var">PoolOwner</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488959"><span class="hs-identifier hs-var">poolId</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488963"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488961"><span class="hs-identifier hs-var">slotInternalIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolRegistrationCertificate -&gt; [PoolOwner]
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3ApoolOwners%3APoolRegistrationCertificate"><span class="hs-identifier hs-var hs-var">poolOwners</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682488965"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>                    </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span>        </span><span id="local-6989586621682489064"><span class="annot"><span class="annottext">putPoolRetirement :: CertificatePublicationTime
-&gt; PoolRetirementCertificate -&gt; ReaderT backend m ()
</span><a href="#local-6989586621682489064"><span class="hs-identifier hs-var hs-var">putPoolRetirement</span></a></span></span><span> </span><span id="local-6989586621682488941"><span class="annot"><span class="annottext">CertificatePublicationTime
</span><a href="#local-6989586621682488941"><span class="hs-identifier hs-var">cpt</span></a></span></span><span> </span><span id="local-6989586621682488940"><span class="annot"><span class="annottext">PoolRetirementCertificate
</span><a href="#local-6989586621682488940"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-321"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#CertificatePublicationTime"><span class="hs-identifier hs-type">CertificatePublicationTime</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621682488939"><span class="annot"><span class="annottext">SlotNo
slotNo :: SlotNo
$sel:slotNo:CertificatePublicationTime :: CertificatePublicationTime -&gt; SlotNo
</span><a href="#local-6989586621682488939"><span class="hs-identifier hs-var hs-var">slotNo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682488938"><span class="annot"><span class="annottext">Word64
slotInternalIndex :: Word64
$sel:slotInternalIndex:CertificatePublicationTime :: CertificatePublicationTime -&gt; Word64
</span><a href="#local-6989586621682488938"><span class="hs-identifier hs-var hs-var">slotInternalIndex</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CertificatePublicationTime
</span><a href="#local-6989586621682488941"><span class="hs-identifier hs-var">cpt</span></a></span><span>
</span><span id="line-322"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolRetirementCertificate"><span class="hs-identifier hs-type">PoolRetirementCertificate</span></a></span><span>
</span><span id="line-323"></span><span>                    </span><span id="local-6989586621682488936"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488936"><span class="hs-identifier hs-var">poolId</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a></span><span> </span><span id="local-6989586621682488935"><span class="annot"><span class="annottext">Word31
</span><a href="#local-6989586621682488935"><span class="hs-identifier hs-var">retirementEpoch</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolRetirementCertificate
</span><a href="#local-6989586621682488940"><span class="hs-identifier hs-var">cert</span></a></span><span>
</span><span id="line-324"></span><span>            </span><span class="annot"><span class="annottext">Key PoolRetirement -&gt; PoolRetirement -&gt; ReaderT backend m ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
Key record -&gt; record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">repsert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolId -&gt; SlotNo -&gt; Word64 -&gt; Key PoolRetirement
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRetirementKey"><span class="hs-identifier hs-var">PoolRetirementKey</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488936"><span class="hs-identifier hs-var">poolId</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488939"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488938"><span class="hs-identifier hs-var">slotInternalIndex</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PoolRetirement -&gt; ReaderT backend m ())
-&gt; PoolRetirement -&gt; ReaderT backend m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-325"></span><span>                </span><span class="annot"><span class="annottext">PoolId -&gt; SlotNo -&gt; Word64 -&gt; Word64 -&gt; PoolRetirement
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRetirement"><span class="hs-identifier hs-var">PoolRetirement</span></a></span><span>
</span><span id="line-326"></span><span>                    </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488936"><span class="hs-identifier hs-var">poolId</span></a></span><span>
</span><span id="line-327"></span><span>                    </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488939"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-328"></span><span>                    </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488938"><span class="hs-identifier hs-var">slotInternalIndex</span></a></span><span>
</span><span id="line-329"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word31 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word31
</span><a href="#local-6989586621682488935"><span class="hs-identifier hs-var">retirementEpoch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span>
</span><span id="line-331"></span><span>        </span><span id="local-6989586621682489063"><span class="annot"><span class="annottext">unfetchedPoolMetadataRefs :: a -&gt; ReaderT backend m [(a, a, a)]
</span><a href="#local-6989586621682489063"><span class="hs-identifier hs-var hs-var">unfetchedPoolMetadataRefs</span></a></span></span><span> </span><span id="local-6989586621682488932"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682488932"><span class="hs-identifier hs-var">limit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-332"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488931"><span class="annot"><span class="annottext">nLimit :: Text
</span><a href="#local-6989586621682488931"><span class="hs-identifier hs-var hs-var">nLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Text
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682488932"><span class="hs-identifier hs-var">limit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488928"><span class="annot"><span class="annottext">poolId :: Text
</span><a href="#local-6989586621682488928"><span class="hs-identifier hs-var hs-var">poolId</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DBField -&gt; Text
</span><a href="Cardano.DB.Sqlite.html#fieldName"><span class="hs-identifier hs-var">fieldName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityField PoolRegistration PoolId -&gt; DBField
forall record typ.
PersistEntity record =&gt;
EntityField record typ -&gt; DBField
</span><a href="Cardano.DB.Sqlite.html#DBField"><span class="hs-identifier hs-var">DBField</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration PoolId
forall typ. (typ ~ PoolId) =&gt; EntityField PoolRegistration typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistrationPoolId"><span class="hs-identifier hs-var">PoolRegistrationPoolId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488925"><span class="annot"><span class="annottext">metadataHash :: Text
</span><a href="#local-6989586621682488925"><span class="hs-identifier hs-var hs-var">metadataHash</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DBField -&gt; Text
</span><a href="Cardano.DB.Sqlite.html#fieldName"><span class="hs-identifier hs-var">fieldName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityField PoolRegistration (Maybe StakePoolMetadataHash)
-&gt; DBField
forall record typ.
PersistEntity record =&gt;
EntityField record typ -&gt; DBField
</span><a href="Cardano.DB.Sqlite.html#DBField"><span class="hs-identifier hs-var">DBField</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration (Maybe StakePoolMetadataHash)
forall typ.
(typ ~ Maybe StakePoolMetadataHash) =&gt;
EntityField PoolRegistration typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistrationMetadataHash"><span class="hs-identifier hs-var">PoolRegistrationMetadataHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-335"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488923"><span class="annot"><span class="annottext">metadataUrl :: Text
</span><a href="#local-6989586621682488923"><span class="hs-identifier hs-var hs-var">metadataUrl</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DBField -&gt; Text
</span><a href="Cardano.DB.Sqlite.html#fieldName"><span class="hs-identifier hs-var">fieldName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityField PoolRegistration (Maybe StakePoolMetadataUrl)
-&gt; DBField
forall record typ.
PersistEntity record =&gt;
EntityField record typ -&gt; DBField
</span><a href="Cardano.DB.Sqlite.html#DBField"><span class="hs-identifier hs-var">DBField</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration (Maybe StakePoolMetadataUrl)
forall typ.
(typ ~ Maybe StakePoolMetadataUrl) =&gt;
EntityField PoolRegistration typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistrationMetadataUrl"><span class="hs-identifier hs-var">PoolRegistrationMetadataUrl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488921"><span class="annot"><span class="annottext">retryAfter :: Text
</span><a href="#local-6989586621682488921"><span class="hs-identifier hs-var hs-var">retryAfter</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DBField -&gt; Text
</span><a href="Cardano.DB.Sqlite.html#fieldName"><span class="hs-identifier hs-var">fieldName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityField PoolMetadataFetchAttempts UTCTime -&gt; DBField
forall record typ.
PersistEntity record =&gt;
EntityField record typ -&gt; DBField
</span><a href="Cardano.DB.Sqlite.html#DBField"><span class="hs-identifier hs-var">DBField</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolMetadataFetchAttempts UTCTime
forall typ.
(typ ~ UTCTime) =&gt;
EntityField PoolMetadataFetchAttempts typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolFetchAttemptsRetryAfter"><span class="hs-identifier hs-var">PoolFetchAttemptsRetryAfter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488919"><span class="annot"><span class="annottext">registrations :: Text
</span><a href="#local-6989586621682488919"><span class="hs-identifier hs-var hs-var">registrations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DBField -&gt; Text
</span><a href="Cardano.DB.Sqlite.html#tableName"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityField PoolRegistration (Maybe StakePoolMetadataHash)
-&gt; DBField
forall record typ.
PersistEntity record =&gt;
EntityField record typ -&gt; DBField
</span><a href="Cardano.DB.Sqlite.html#DBField"><span class="hs-identifier hs-var">DBField</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration (Maybe StakePoolMetadataHash)
forall typ.
(typ ~ Maybe StakePoolMetadataHash) =&gt;
EntityField PoolRegistration typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistrationMetadataHash"><span class="hs-identifier hs-var">PoolRegistrationMetadataHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488918"><span class="annot"><span class="annottext">fetchAttempts :: Text
</span><a href="#local-6989586621682488918"><span class="hs-identifier hs-var hs-var">fetchAttempts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DBField -&gt; Text
</span><a href="Cardano.DB.Sqlite.html#tableName"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityField PoolMetadataFetchAttempts StakePoolMetadataHash
-&gt; DBField
forall record typ.
PersistEntity record =&gt;
EntityField record typ -&gt; DBField
</span><a href="Cardano.DB.Sqlite.html#DBField"><span class="hs-identifier hs-var">DBField</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolMetadataFetchAttempts StakePoolMetadataHash
forall typ.
(typ ~ StakePoolMetadataHash) =&gt;
EntityField PoolMetadataFetchAttempts typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolFetchAttemptsMetadataHash"><span class="hs-identifier hs-var">PoolFetchAttemptsMetadataHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488916"><span class="annot"><span class="annottext">metadata :: Text
</span><a href="#local-6989586621682488916"><span class="hs-identifier hs-var hs-var">metadata</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DBField -&gt; Text
</span><a href="Cardano.DB.Sqlite.html#tableName"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityField PoolMetadata StakePoolMetadataHash -&gt; DBField
forall record typ.
PersistEntity record =&gt;
EntityField record typ -&gt; DBField
</span><a href="Cardano.DB.Sqlite.html#DBField"><span class="hs-identifier hs-var">DBField</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolMetadata StakePoolMetadataHash
forall typ.
(typ ~ StakePoolMetadataHash) =&gt;
EntityField PoolMetadata typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolMetadataHash"><span class="hs-identifier hs-var">PoolMetadataHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488914"><span class="annot"><span class="annottext">query :: Text
</span><a href="#local-6989586621682488914"><span class="hs-identifier hs-var hs-var">query</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">T.unwords</span></a></span><span>
</span><span id="line-341"></span><span>                    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;SELECT&quot;</span></span><span>
</span><span id="line-342"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;a.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488928"><span class="hs-identifier hs-var">poolId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;,&quot;</span></span><span>
</span><span id="line-343"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;a.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488923"><span class="hs-identifier hs-var">metadataUrl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;,&quot;</span></span><span>
</span><span id="line-344"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;a.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488925"><span class="hs-identifier hs-var">metadataHash</span></a></span><span>
</span><span id="line-345"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;FROM&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488919"><span class="hs-identifier hs-var">registrations</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;AS a&quot;</span></span><span>
</span><span id="line-346"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;LEFT JOIN&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488918"><span class="hs-identifier hs-var">fetchAttempts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;AS b&quot;</span></span><span>
</span><span id="line-347"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;ON&quot;</span></span><span>
</span><span id="line-348"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;a.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488923"><span class="hs-identifier hs-var">metadataUrl</span></a></span><span class="hs-special">,</span><span>  </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;=&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;b.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488923"><span class="hs-identifier hs-var">metadataUrl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;AND&quot;</span></span><span>
</span><span id="line-349"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;a.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488925"><span class="hs-identifier hs-var">metadataHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;=&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;b.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488925"><span class="hs-identifier hs-var">metadataHash</span></a></span><span>
</span><span id="line-350"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;WHERE&quot;</span></span><span>
</span><span id="line-351"></span><span>                        </span><span class="hs-comment">-- Successfully fetched metadata</span><span>
</span><span id="line-352"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;a.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488925"><span class="hs-identifier hs-var">metadataHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;NOT&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;IN&quot;</span></span><span>
</span><span id="line-353"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;(&quot;</span></span><span>
</span><span id="line-354"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;SELECT&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488925"><span class="hs-identifier hs-var">metadataHash</span></a></span><span>
</span><span id="line-355"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;FROM&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488916"><span class="hs-identifier hs-var">metadata</span></a></span><span>
</span><span id="line-356"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-357"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;AND&quot;</span></span><span>
</span><span id="line-358"></span><span>                        </span><span class="hs-comment">-- Discard recent failed attempts</span><span>
</span><span id="line-359"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;(&quot;</span></span><span>
</span><span id="line-360"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488921"><span class="hs-identifier hs-var">retryAfter</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&lt;&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;datetime('now')&quot;</span></span><span>
</span><span id="line-361"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;OR&quot;</span></span><span>
</span><span id="line-362"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488921"><span class="hs-identifier hs-var">retryAfter</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;IS NULL&quot;</span></span><span>
</span><span id="line-363"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-364"></span><span>                    </span><span class="hs-comment">-- Important, since we have a limit, we order all results by</span><span>
</span><span id="line-365"></span><span>                    </span><span class="hs-comment">-- earliest &quot;retry_after&quot;, so that we are sure that all</span><span>
</span><span id="line-366"></span><span>                    </span><span class="hs-comment">-- metadata gets _eventually_ processed.</span><span>
</span><span id="line-367"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-368"></span><span>                    </span><span class="hs-comment">-- Note that `NULL` is smaller than everything.</span><span>
</span><span id="line-369"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;ORDER BY&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488921"><span class="hs-identifier hs-var">retryAfter</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;ASC&quot;</span></span><span>
</span><span id="line-370"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;LIMIT&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488931"><span class="hs-identifier hs-var">nLimit</span></a></span><span>
</span><span id="line-371"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;;&quot;</span></span><span>
</span><span id="line-372"></span><span>                    </span><span class="hs-special">]</span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488913"><span class="annot"><span class="annottext">safeCast :: (Single PersistValue, Single PersistValue, Single PersistValue)
-&gt; Either Text (a, a, a)
</span><a href="#local-6989586621682488913"><span class="hs-identifier hs-var hs-var">safeCast</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488912"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488912"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488911"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488911"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488910"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488910"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>                    </span><span class="annot"><span class="annottext">(a -&gt; a -&gt; a -&gt; (a, a, a))
-&gt; Either Text a -&gt; Either Text (a -&gt; a -&gt; (a, a, a))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text a
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488912"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-376"></span><span>                    </span><span class="annot"><span class="annottext">Either Text (a -&gt; a -&gt; (a, a, a))
-&gt; Either Text a -&gt; Either Text (a -&gt; (a, a, a))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text a
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488911"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-377"></span><span>                    </span><span class="annot"><span class="annottext">Either Text (a -&gt; (a, a, a))
-&gt; Either Text a -&gt; Either Text (a, a, a)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text a
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488910"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-378"></span><span>
</span><span id="line-379"></span><span>            </span><span class="annot"><span class="annottext">[Either Text (a, a, a)] -&gt; [(a, a, a)]
forall a b. [Either a b] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">rights</span></a></span><span> </span><span class="annot"><span class="annottext">([Either Text (a, a, a)] -&gt; [(a, a, a)])
-&gt; ([(Single PersistValue, Single PersistValue,
      Single PersistValue)]
    -&gt; [Either Text (a, a, a)])
-&gt; [(Single PersistValue, Single PersistValue,
     Single PersistValue)]
-&gt; [(a, a, a)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((Single PersistValue, Single PersistValue, Single PersistValue)
 -&gt; Either Text (a, a, a))
-&gt; [(Single PersistValue, Single PersistValue,
     Single PersistValue)]
-&gt; [Either Text (a, a, a)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">(Single PersistValue, Single PersistValue, Single PersistValue)
-&gt; Either Text (a, a, a)
forall a a a.
(PersistField a, PersistField a, PersistField a) =&gt;
(Single PersistValue, Single PersistValue, Single PersistValue)
-&gt; Either Text (a, a, a)
</span><a href="#local-6989586621682488913"><span class="hs-identifier hs-var">safeCast</span></a></span><span> </span><span class="annot"><span class="annottext">([(Single PersistValue, Single PersistValue, Single PersistValue)]
 -&gt; [(a, a, a)])
-&gt; ReaderT
     backend
     m
     [(Single PersistValue, Single PersistValue, Single PersistValue)]
-&gt; ReaderT backend m [(a, a, a)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
-&gt; [PersistValue]
-&gt; ReaderT
     backend
     m
     [(Single PersistValue, Single PersistValue, Single PersistValue)]
forall a (m :: * -&gt; *) backend.
(RawSql a, MonadIO m, BackendCompatible SqlBackend backend) =&gt;
Text -&gt; [PersistValue] -&gt; ReaderT backend m [a]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">rawSql</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488914"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-380"></span><span>
</span><span id="line-381"></span><span>        </span><span id="local-6989586621682489062"><span class="annot"><span class="annottext">putFetchAttempt :: (StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; ReaderT backend m ()
</span><a href="#local-6989586621682489062"><span class="hs-identifier hs-var hs-var">putFetchAttempt</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682488909"><span class="annot"><span class="annottext">StakePoolMetadataUrl
</span><a href="#local-6989586621682488909"><span class="hs-identifier hs-var">url</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682488908"><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682488908"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-382"></span><span>            </span><span class="hs-comment">-- NOTE</span><span>
</span><span id="line-383"></span><span>            </span><span class="hs-comment">-- assuming SQLite has the same notion of &quot;now&quot; that the host system.</span><span>
</span><span id="line-384"></span><span>            </span><span id="local-6989586621682488907"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621682488907"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; ReaderT backend m UTCTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><a href="../../../../time/html/src"><span class="hs-identifier hs-var">getCurrentTime</span></a></span><span>
</span><span id="line-385"></span><span>            </span><span id="local-6989586621682488906"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621682488906"><span class="hs-identifier hs-var">retryCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Word8
-&gt; (Entity PoolMetadataFetchAttempts -&gt; Word8)
-&gt; Maybe (Entity PoolMetadataFetchAttempts)
-&gt; Word8
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolMetadataFetchAttempts -&gt; Word8
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#poolFetchAttemptsRetryCount"><span class="hs-identifier hs-var hs-var">poolFetchAttemptsRetryCount</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolMetadataFetchAttempts -&gt; Word8)
-&gt; (Entity PoolMetadataFetchAttempts -&gt; PoolMetadataFetchAttempts)
-&gt; Entity PoolMetadataFetchAttempts
-&gt; Word8
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity PoolMetadataFetchAttempts -&gt; PoolMetadataFetchAttempts
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (Entity PoolMetadataFetchAttempts) -&gt; Word8)
-&gt; ReaderT backend m (Maybe (Entity PoolMetadataFetchAttempts))
-&gt; ReaderT backend m Word8
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter PoolMetadataFetchAttempts]
-&gt; [SelectOpt PoolMetadataFetchAttempts]
-&gt; ReaderT backend m (Maybe (Entity PoolMetadataFetchAttempts))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span>
</span><span id="line-386"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolMetadataFetchAttempts StakePoolMetadataHash
forall typ.
(typ ~ StakePoolMetadataHash) =&gt;
EntityField PoolMetadataFetchAttempts typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolFetchAttemptsMetadataHash"><span class="hs-identifier hs-var">PoolFetchAttemptsMetadataHash</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolMetadataFetchAttempts StakePoolMetadataHash
-&gt; StakePoolMetadataHash -&gt; Filter PoolMetadataFetchAttempts
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682488908"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-387"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField PoolMetadataFetchAttempts StakePoolMetadataUrl
forall typ.
(typ ~ StakePoolMetadataUrl) =&gt;
EntityField PoolMetadataFetchAttempts typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolFetchAttemptsMetadataUrl"><span class="hs-identifier hs-var">PoolFetchAttemptsMetadataUrl</span></a></span><span>  </span><span class="annot"><span class="annottext">EntityField PoolMetadataFetchAttempts StakePoolMetadataUrl
-&gt; StakePoolMetadataUrl -&gt; Filter PoolMetadataFetchAttempts
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataUrl
</span><a href="#local-6989586621682488909"><span class="hs-identifier hs-var">url</span></a></span><span>
</span><span id="line-388"></span><span>                </span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-389"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488902"><span class="annot"><span class="annottext">retryAfter :: UTCTime
</span><a href="#local-6989586621682488902"><span class="hs-identifier hs-var hs-var">retryAfter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; Word8 -&gt; UTCTime
</span><a href="Cardano.Pool.DB.Sqlite.html#backoff"><span class="hs-identifier hs-var">backoff</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621682488907"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621682488906"><span class="hs-identifier hs-var">retryCount</span></a></span><span>
</span><span id="line-390"></span><span>            </span><span class="annot"><span class="annottext">Key PoolMetadataFetchAttempts
-&gt; PoolMetadataFetchAttempts -&gt; ReaderT backend m ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
Key record -&gt; record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">repsert</span></a></span><span>
</span><span id="line-391"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StakePoolMetadataHash
-&gt; StakePoolMetadataUrl -&gt; Key PoolMetadataFetchAttempts
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolMetadataFetchAttemptsKey"><span class="hs-identifier hs-var">PoolMetadataFetchAttemptsKey</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682488908"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataUrl
</span><a href="#local-6989586621682488909"><span class="hs-identifier hs-var">url</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StakePoolMetadataHash
-&gt; StakePoolMetadataUrl
-&gt; UTCTime
-&gt; Word8
-&gt; PoolMetadataFetchAttempts
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolMetadataFetchAttempts"><span class="hs-identifier hs-var">PoolMetadataFetchAttempts</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682488908"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataUrl
</span><a href="#local-6989586621682488909"><span class="hs-identifier hs-var">url</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621682488902"><span class="hs-identifier hs-var">retryAfter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621682488906"><span class="hs-identifier hs-var">retryCount</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span>        </span><span id="local-6989586621682489061"><span class="annot"><span class="annottext">putPoolMetadata :: StakePoolMetadataHash -&gt; StakePoolMetadata -&gt; ReaderT backend m ()
</span><a href="#local-6989586621682489061"><span class="hs-identifier hs-var hs-var">putPoolMetadata</span></a></span></span><span> </span><span id="local-6989586621682488897"><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682488897"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span id="local-6989586621682488896"><span class="annot"><span class="annottext">StakePoolMetadata
</span><a href="#local-6989586621682488896"><span class="hs-identifier hs-var">metadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-395"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadata"><span class="hs-identifier hs-type">StakePoolMetadata</span></a></span><span>
</span><span id="line-396"></span><span>                    </span><span class="hs-special">{</span><span id="local-6989586621682488894"><span class="annot"><span class="annottext">StakePoolTicker
$sel:ticker:StakePoolMetadata :: StakePoolMetadata -&gt; StakePoolTicker
ticker :: StakePoolTicker
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3Aticker%3AStakePoolMetadata"><span class="hs-identifier hs-var hs-var">ticker</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682488892"><span class="annot"><span class="annottext">Text
$sel:name:StakePoolMetadata :: StakePoolMetadata -&gt; Text
name :: Text
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3Aname%3AStakePoolMetadata"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682488890"><span class="annot"><span class="annottext">Maybe Text
$sel:description:StakePoolMetadata :: StakePoolMetadata -&gt; Maybe Text
description :: Maybe Text
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3Adescription%3AStakePoolMetadata"><span class="hs-identifier hs-var hs-var">description</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682488888"><span class="annot"><span class="annottext">Text
$sel:homepage:StakePoolMetadata :: StakePoolMetadata -&gt; Text
homepage :: Text
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3Ahomepage%3AStakePoolMetadata"><span class="hs-identifier hs-var hs-var">homepage</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StakePoolMetadata
</span><a href="#local-6989586621682488896"><span class="hs-identifier hs-var">metadata</span></a></span><span>
</span><span id="line-397"></span><span>            </span><span class="annot"><span class="annottext">Key PoolMetadata -&gt; PoolMetadata -&gt; ReaderT backend m ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
Key record -&gt; record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">repsert</span></a></span><span>
</span><span id="line-398"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StakePoolMetadataHash -&gt; Key PoolMetadata
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolMetadataKey"><span class="hs-identifier hs-var">PoolMetadataKey</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682488897"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StakePoolMetadataHash
-&gt; Text -&gt; StakePoolTicker -&gt; Maybe Text -&gt; Text -&gt; PoolMetadata
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolMetadata"><span class="hs-identifier hs-var">PoolMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682488897"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488892"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolTicker
</span><a href="#local-6989586621682488894"><span class="hs-identifier hs-var">ticker</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621682488890"><span class="hs-identifier hs-var">description</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488888"><span class="hs-identifier hs-var">homepage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolMetadataFetchAttempts] -&gt; ReaderT backend m ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolMetadataFetchAttempts StakePoolMetadataHash
forall typ.
(typ ~ StakePoolMetadataHash) =&gt;
EntityField PoolMetadataFetchAttempts typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolFetchAttemptsMetadataHash"><span class="hs-identifier hs-var">PoolFetchAttemptsMetadataHash</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolMetadataFetchAttempts StakePoolMetadataHash
-&gt; StakePoolMetadataHash -&gt; Filter PoolMetadataFetchAttempts
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">StakePoolMetadataHash
</span><a href="#local-6989586621682488897"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span>        </span><span id="local-6989586621682489060"><span class="annot"><span class="annottext">removePoolMetadata :: ReaderT SqlBackend IO ()
</span><a href="#local-6989586621682489060"><span class="hs-identifier hs-var hs-var">removePoolMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-403"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolMetadata] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolMetadata"><span class="hs-identifier hs-type">PoolMetadata</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-404"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolMetadataFetchAttempts] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolMetadataFetchAttempts"><span class="hs-identifier hs-type">PoolMetadataFetchAttempts</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolDelistment] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolDelistment"><span class="hs-identifier hs-type">PoolDelistment</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span>        </span><span id="local-6989586621682489059"><span class="annot"><span class="annottext">readPoolMetadata :: ReaderT SqlBackend IO (Map StakePoolMetadataHash StakePoolMetadata)
</span><a href="#local-6989586621682489059"><span class="hs-identifier hs-var hs-var">readPoolMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-408"></span><span>            </span><span class="annot"><span class="annottext">[(StakePoolMetadataHash, StakePoolMetadata)]
-&gt; Map StakePoolMetadataHash StakePoolMetadata
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(StakePoolMetadataHash, StakePoolMetadata)]
 -&gt; Map StakePoolMetadataHash StakePoolMetadata)
-&gt; ([Entity PoolMetadata]
    -&gt; [(StakePoolMetadataHash, StakePoolMetadata)])
-&gt; [Entity PoolMetadata]
-&gt; Map StakePoolMetadataHash StakePoolMetadata
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Entity PoolMetadata -&gt; (StakePoolMetadataHash, StakePoolMetadata))
-&gt; [Entity PoolMetadata]
-&gt; [(StakePoolMetadataHash, StakePoolMetadata)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolMetadata -&gt; (StakePoolMetadataHash, StakePoolMetadata)
</span><a href="Cardano.Pool.DB.Sqlite.html#fromPoolMeta"><span class="hs-identifier hs-var">fromPoolMeta</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolMetadata -&gt; (StakePoolMetadataHash, StakePoolMetadata))
-&gt; (Entity PoolMetadata -&gt; PoolMetadata)
-&gt; Entity PoolMetadata
-&gt; (StakePoolMetadataHash, StakePoolMetadata)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity PoolMetadata -&gt; PoolMetadata
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span>                </span><span class="annot"><span class="annottext">([Entity PoolMetadata]
 -&gt; Map StakePoolMetadataHash StakePoolMetadata)
-&gt; ReaderT SqlBackend IO [Entity PoolMetadata]
-&gt; ReaderT
     SqlBackend IO (Map StakePoolMetadataHash StakePoolMetadata)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter PoolMetadata]
-&gt; [SelectOpt PoolMetadata]
-&gt; ReaderT SqlBackend IO [Entity PoolMetadata]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span>        </span><span id="local-6989586621682489058"><span class="annot"><span class="annottext">listRegisteredPools :: ReaderT SqlBackend IO [PoolId]
</span><a href="#local-6989586621682489058"><span class="hs-identifier hs-var hs-var">listRegisteredPools</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-412"></span><span>            </span><span class="annot"><span class="annottext">(Entity PoolRegistration -&gt; PoolId)
-&gt; [Entity PoolRegistration] -&gt; [PoolId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolRegistration -&gt; PoolId
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#poolRegistrationPoolId"><span class="hs-identifier hs-var hs-var">poolRegistrationPoolId</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolRegistration -&gt; PoolId)
-&gt; (Entity PoolRegistration -&gt; PoolRegistration)
-&gt; Entity PoolRegistration
-&gt; PoolId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity PoolRegistration -&gt; PoolRegistration
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Entity PoolRegistration] -&gt; [PoolId])
-&gt; ReaderT SqlBackend IO [Entity PoolRegistration]
-&gt; ReaderT SqlBackend IO [PoolId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter PoolRegistration]
-&gt; [SelectOpt PoolRegistration]
-&gt; ReaderT SqlBackend IO [Entity PoolRegistration]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-413"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration SlotNo -&gt; SelectOpt PoolRegistration
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Desc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField PoolRegistration typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistrationSlot"><span class="hs-identifier hs-var">PoolRegistrationSlot</span></a></span><span>
</span><span id="line-414"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration Word64 -&gt; SelectOpt PoolRegistration
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Desc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration Word64
forall typ. (typ ~ Word64) =&gt; EntityField PoolRegistration typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistrationSlotInternalIndex"><span class="hs-identifier hs-var">PoolRegistrationSlotInternalIndex</span></a></span><span>
</span><span id="line-415"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span>        </span><span id="local-6989586621682489057"><span class="annot"><span class="annottext">listRetiredPools :: EpochNo -&gt; ReaderT SqlBackend IO [PoolRetirementCertificate]
</span><a href="#local-6989586621682489057"><span class="hs-identifier hs-var hs-var">listRetiredPools</span></a></span></span><span> </span><span id="local-6989586621682488879"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682488879"><span class="hs-identifier hs-var">epochNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
-&gt; RawQuery
     (Single PersistValue, Single PersistValue)
     PoolRetirementCertificate
-&gt; ReaderT SqlBackend IO [PoolRetirementCertificate]
forall a b.
RawSql a =&gt;
Tracer IO PoolDbLog -&gt; RawQuery a b -&gt; SqlPersistT IO [b]
</span><a href="Cardano.Pool.DB.Sqlite.html#runRawQuery"><span class="hs-identifier hs-var">runRawQuery</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682489077"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">(RawQuery
   (Single PersistValue, Single PersistValue)
   PoolRetirementCertificate
 -&gt; ReaderT SqlBackend IO [PoolRetirementCertificate])
-&gt; RawQuery
     (Single PersistValue, Single PersistValue)
     PoolRetirementCertificate
-&gt; ReaderT SqlBackend IO [PoolRetirementCertificate]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-418"></span><span>            </span><span class="annot"><span class="annottext">Text
-&gt; Text
-&gt; [PersistValue]
-&gt; ((Single PersistValue, Single PersistValue)
    -&gt; Either Text PoolRetirementCertificate)
-&gt; RawQuery
     (Single PersistValue, Single PersistValue)
     PoolRetirementCertificate
forall a b.
Text
-&gt; Text -&gt; [PersistValue] -&gt; (a -&gt; Either Text b) -&gt; RawQuery a b
</span><a href="Cardano.Pool.DB.Sqlite.html#RawQuery"><span class="hs-identifier hs-var">RawQuery</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;listRetiredPools&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488878"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="annot"><span class="annottext">[PersistValue]
</span><a href="#local-6989586621682488877"><span class="hs-identifier hs-var">parameters</span></a></span><span> </span><span class="annot"><span class="annottext">(Single PersistValue, Single PersistValue)
-&gt; Either Text PoolRetirementCertificate
</span><a href="#local-6989586621682488876"><span class="hs-identifier hs-var">parseRow</span></a></span><span>
</span><span id="line-419"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-420"></span><span>            </span><span id="local-6989586621682488878"><span class="annot"><span class="annottext">query :: Text
</span><a href="#local-6989586621682488878"><span class="hs-identifier hs-var hs-var">query</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">T.unwords</span></a></span><span>
</span><span id="line-421"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;SELECT *&quot;</span></span><span>
</span><span id="line-422"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;FROM active_pool_retirements&quot;</span></span><span>
</span><span id="line-423"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;WHERE retirement_epoch &lt;= ?;&quot;</span></span><span>
</span><span id="line-424"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-425"></span><span>            </span><span id="local-6989586621682488877"><span class="annot"><span class="annottext">parameters :: [PersistValue]
</span><a href="#local-6989586621682488877"><span class="hs-identifier hs-var hs-var">parameters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; PersistValue
forall a. PersistField a =&gt; a -&gt; PersistValue
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">toPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682488879"><span class="hs-identifier hs-var">epochNo</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-426"></span><span>            </span><span id="local-6989586621682488876"><span class="annot"><span class="annottext">parseRow :: (Single PersistValue, Single PersistValue)
-&gt; Either Text PoolRetirementCertificate
</span><a href="#local-6989586621682488876"><span class="hs-identifier hs-var hs-var">parseRow</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488875"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488875"><span class="hs-identifier hs-var">poolId</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488874"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488874"><span class="hs-identifier hs-var">retirementEpoch</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-427"></span><span>                </span><span class="annot"><span class="annottext">PoolId -&gt; EpochNo -&gt; PoolRetirementCertificate
</span><a href="Cardano.Wallet.Primitive.Types.html#PoolRetirementCertificate"><span class="hs-identifier hs-var">PoolRetirementCertificate</span></a></span><span>
</span><span id="line-428"></span><span>                    </span><span class="annot"><span class="annottext">(PoolId -&gt; EpochNo -&gt; PoolRetirementCertificate)
-&gt; Either Text PoolId
-&gt; Either Text (EpochNo -&gt; PoolRetirementCertificate)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text PoolId
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488875"><span class="hs-identifier hs-var">poolId</span></a></span><span>
</span><span id="line-429"></span><span>                    </span><span class="annot"><span class="annottext">Either Text (EpochNo -&gt; PoolRetirementCertificate)
-&gt; Either Text EpochNo -&gt; Either Text PoolRetirementCertificate
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text EpochNo
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488874"><span class="hs-identifier hs-var">retirementEpoch</span></a></span><span>
</span><span id="line-430"></span><span>
</span><span id="line-431"></span><span>        </span><span id="local-6989586621682489056"><span class="annot"><span class="annottext">listPoolLifeCycleData :: EpochNo -&gt; SqlPersistT IO [PoolLifeCycleStatus]
</span><a href="#local-6989586621682489056"><span class="hs-identifier hs-var hs-var">listPoolLifeCycleData</span></a></span></span><span> </span><span id="local-6989586621682488873"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682488873"><span class="hs-identifier hs-var">epochNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
-&gt; RawQuery
     (Single PersistValue, Single PersistValue, Single PersistValue,
      Single PersistValue, Single PersistValue, Single PersistValue,
      Single PersistValue, Single PersistValue, Single PersistValue)
     PoolLifeCycleStatus
-&gt; SqlPersistT IO [PoolLifeCycleStatus]
forall a b.
RawSql a =&gt;
Tracer IO PoolDbLog -&gt; RawQuery a b -&gt; SqlPersistT IO [b]
</span><a href="Cardano.Pool.DB.Sqlite.html#runRawQuery"><span class="hs-identifier hs-var">runRawQuery</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682489077"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">(RawQuery
   (Single PersistValue, Single PersistValue, Single PersistValue,
    Single PersistValue, Single PersistValue, Single PersistValue,
    Single PersistValue, Single PersistValue, Single PersistValue)
   PoolLifeCycleStatus
 -&gt; SqlPersistT IO [PoolLifeCycleStatus])
-&gt; RawQuery
     (Single PersistValue, Single PersistValue, Single PersistValue,
      Single PersistValue, Single PersistValue, Single PersistValue,
      Single PersistValue, Single PersistValue, Single PersistValue)
     PoolLifeCycleStatus
-&gt; SqlPersistT IO [PoolLifeCycleStatus]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
-&gt; Text
-&gt; [PersistValue]
-&gt; ((Single PersistValue, Single PersistValue, Single PersistValue,
     Single PersistValue, Single PersistValue, Single PersistValue,
     Single PersistValue, Single PersistValue, Single PersistValue)
    -&gt; Either Text PoolLifeCycleStatus)
-&gt; RawQuery
     (Single PersistValue, Single PersistValue, Single PersistValue,
      Single PersistValue, Single PersistValue, Single PersistValue,
      Single PersistValue, Single PersistValue, Single PersistValue)
     PoolLifeCycleStatus
forall a b.
Text
-&gt; Text -&gt; [PersistValue] -&gt; (a -&gt; Either Text b) -&gt; RawQuery a b
</span><a href="Cardano.Pool.DB.Sqlite.html#RawQuery"><span class="hs-identifier hs-var">RawQuery</span></a></span><span>
</span><span id="line-432"></span><span>            </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;listPoolLifeCycleData&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488872"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="annot"><span class="annottext">[PersistValue]
</span><a href="#local-6989586621682488871"><span class="hs-identifier hs-var">parameters</span></a></span><span> </span><span class="annot"><span class="annottext">(Single PersistValue, Single PersistValue, Single PersistValue,
 Single PersistValue, Single PersistValue, Single PersistValue,
 Single PersistValue, Single PersistValue, Single PersistValue)
-&gt; Either Text PoolLifeCycleStatus
</span><a href="#local-6989586621682488870"><span class="hs-identifier hs-var">parseRow</span></a></span><span>
</span><span id="line-433"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-434"></span><span>            </span><span id="local-6989586621682488872"><span class="annot"><span class="annottext">query :: Text
</span><a href="#local-6989586621682488872"><span class="hs-identifier hs-var hs-var">query</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">T.unwords</span></a></span><span>
</span><span id="line-435"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;SELECT *&quot;</span></span><span>
</span><span id="line-436"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;FROM active_pool_lifecycle_data&quot;</span></span><span>
</span><span id="line-437"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;WHERE retirement_epoch IS NULL OR retirement_epoch &gt; ?;&quot;</span></span><span>
</span><span id="line-438"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-439"></span><span>            </span><span id="local-6989586621682488871"><span class="annot"><span class="annottext">parameters :: [PersistValue]
</span><a href="#local-6989586621682488871"><span class="hs-identifier hs-var hs-var">parameters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; PersistValue
forall a. PersistField a =&gt; a -&gt; PersistValue
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">toPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682488873"><span class="hs-identifier hs-var">epochNo</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-440"></span><span>            </span><span id="local-6989586621682488870"><span class="annot"><span class="annottext">parseRow :: (Single PersistValue, Single PersistValue, Single PersistValue,
 Single PersistValue, Single PersistValue, Single PersistValue,
 Single PersistValue, Single PersistValue, Single PersistValue)
-&gt; Either Text PoolLifeCycleStatus
</span><a href="#local-6989586621682488870"><span class="hs-identifier hs-var hs-var">parseRow</span></a></span></span><span>
</span><span id="line-441"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488869"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488869"><span class="hs-identifier hs-var">fieldPoolId</span></a></span></span><span>
</span><span id="line-442"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488868"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488868"><span class="hs-identifier hs-var">fieldRetirementEpoch</span></a></span></span><span>
</span><span id="line-443"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488867"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488867"><span class="hs-identifier hs-var">fieldOwners</span></a></span></span><span>
</span><span id="line-444"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488866"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488866"><span class="hs-identifier hs-var">fieldCost</span></a></span></span><span>
</span><span id="line-445"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488865"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488865"><span class="hs-identifier hs-var">fieldPledge</span></a></span></span><span>
</span><span id="line-446"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488864"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488864"><span class="hs-identifier hs-var">fieldMarginNumerator</span></a></span></span><span>
</span><span id="line-447"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488863"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488863"><span class="hs-identifier hs-var">fieldMarginDenominator</span></a></span></span><span>
</span><span id="line-448"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488862"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488862"><span class="hs-identifier hs-var">fieldMetadataHash</span></a></span></span><span>
</span><span id="line-449"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Single</span></a></span><span> </span><span id="local-6989586621682488861"><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488861"><span class="hs-identifier hs-var">fieldMetadataUrl</span></a></span></span><span>
</span><span id="line-450"></span><span>                </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-451"></span><span>                </span><span id="local-6989586621682488860"><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682488860"><span class="hs-identifier hs-var">regCert</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either Text PoolRegistrationCertificate
</span><a href="#local-6989586621682488859"><span class="hs-identifier hs-var">parseRegistrationCertificate</span></a></span><span>
</span><span id="line-452"></span><span>                </span><span class="annot"><span class="annottext">Either Text (Maybe PoolRetirementCertificate)
</span><a href="#local-6989586621682488858"><span class="hs-identifier hs-var">parseRetirementCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Either Text (Maybe PoolRetirementCertificate)
-&gt; (Maybe PoolRetirementCertificate -&gt; PoolLifeCycleStatus)
-&gt; Either Text PoolLifeCycleStatus
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&amp;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PoolLifeCycleStatus
-&gt; (PoolRetirementCertificate -&gt; PoolLifeCycleStatus)
-&gt; Maybe PoolRetirementCertificate
-&gt; PoolLifeCycleStatus
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span>
</span><span id="line-453"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolRegistrationCertificate -&gt; PoolLifeCycleStatus
</span><a href="Cardano.Wallet.Primitive.Types.html#PoolRegistered"><span class="hs-identifier hs-var">PoolRegistered</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682488860"><span class="hs-identifier hs-var">regCert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-454"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolRegistrationCertificate
-&gt; PoolRetirementCertificate -&gt; PoolLifeCycleStatus
</span><a href="Cardano.Wallet.Primitive.Types.html#PoolRegisteredAndRetired"><span class="hs-identifier hs-var">PoolRegisteredAndRetired</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682488860"><span class="hs-identifier hs-var">regCert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-455"></span><span>              </span><span class="hs-keyword">where</span><span>
</span><span id="line-456"></span><span>                </span><span id="local-6989586621682488859"><span class="annot"><span class="annottext">parseRegistrationCertificate :: Either Text PoolRegistrationCertificate
</span><a href="#local-6989586621682488859"><span class="hs-identifier hs-var hs-var">parseRegistrationCertificate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolId
-&gt; [PoolOwner]
-&gt; Percentage
-&gt; Coin
-&gt; Coin
-&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; PoolRegistrationCertificate
</span><a href="Cardano.Wallet.Primitive.Types.html#PoolRegistrationCertificate"><span class="hs-identifier hs-var">PoolRegistrationCertificate</span></a></span><span>
</span><span id="line-457"></span><span>                    </span><span class="annot"><span class="annottext">(PoolId
 -&gt; [PoolOwner]
 -&gt; Percentage
 -&gt; Coin
 -&gt; Coin
 -&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
 -&gt; PoolRegistrationCertificate)
-&gt; Either Text PoolId
-&gt; Either
     Text
     ([PoolOwner]
      -&gt; Percentage
      -&gt; Coin
      -&gt; Coin
      -&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
      -&gt; PoolRegistrationCertificate)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text PoolId
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488869"><span class="hs-identifier hs-var">fieldPoolId</span></a></span><span>
</span><span id="line-458"></span><span>                    </span><span class="annot"><span class="annottext">Either
  Text
  ([PoolOwner]
   -&gt; Percentage
   -&gt; Coin
   -&gt; Coin
   -&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
   -&gt; PoolRegistrationCertificate)
-&gt; Either Text [PoolOwner]
-&gt; Either
     Text
     (Percentage
      -&gt; Coin
      -&gt; Coin
      -&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
      -&gt; PoolRegistrationCertificate)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text [PoolOwner]
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488867"><span class="hs-identifier hs-var">fieldOwners</span></a></span><span>
</span><span id="line-459"></span><span>                    </span><span class="annot"><span class="annottext">Either
  Text
  (Percentage
   -&gt; Coin
   -&gt; Coin
   -&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
   -&gt; PoolRegistrationCertificate)
-&gt; Either Text Percentage
-&gt; Either
     Text
     (Coin
      -&gt; Coin
      -&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
      -&gt; PoolRegistrationCertificate)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Either Text Percentage
</span><a href="#local-6989586621682488854"><span class="hs-identifier hs-var">parseMargin</span></a></span><span>
</span><span id="line-460"></span><span>                    </span><span class="annot"><span class="annottext">Either
  Text
  (Coin
   -&gt; Coin
   -&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
   -&gt; PoolRegistrationCertificate)
-&gt; Either Text Coin
-&gt; Either
     Text
     (Coin
      -&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
      -&gt; PoolRegistrationCertificate)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Coin
</span><a href="Cardano.Wallet.Primitive.Types.Coin.html#fromWord64"><span class="hs-identifier hs-var">Coin.fromWord64</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Coin) -&gt; Either Text Word64 -&gt; Either Text Coin
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text Word64
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488866"><span class="hs-identifier hs-var">fieldCost</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span>                    </span><span class="annot"><span class="annottext">Either
  Text
  (Coin
   -&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
   -&gt; PoolRegistrationCertificate)
-&gt; Either Text Coin
-&gt; Either
     Text
     (Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
      -&gt; PoolRegistrationCertificate)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Coin
</span><a href="Cardano.Wallet.Primitive.Types.Coin.html#fromWord64"><span class="hs-identifier hs-var">Coin.fromWord64</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Coin) -&gt; Either Text Word64 -&gt; Either Text Coin
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text Word64
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488865"><span class="hs-identifier hs-var">fieldPledge</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span>                    </span><span class="annot"><span class="annottext">Either
  Text
  (Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
   -&gt; PoolRegistrationCertificate)
-&gt; Either
     Text (Maybe (StakePoolMetadataUrl, StakePoolMetadataHash))
-&gt; Either Text PoolRegistrationCertificate
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Either Text (Maybe (StakePoolMetadataUrl, StakePoolMetadataHash))
</span><a href="#local-6989586621682488852"><span class="hs-identifier hs-var">parseMetadata</span></a></span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span>                </span><span id="local-6989586621682488858"><span class="annot"><span class="annottext">parseRetirementCertificate :: Either Text (Maybe PoolRetirementCertificate)
</span><a href="#local-6989586621682488858"><span class="hs-identifier hs-var hs-var">parseRetirementCertificate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-465"></span><span>                    </span><span id="local-6989586621682488851"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488851"><span class="hs-identifier hs-var">poolId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text PoolId
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488869"><span class="hs-identifier hs-var">fieldPoolId</span></a></span><span>
</span><span id="line-466"></span><span>                    </span><span id="local-6989586621682488850"><span class="annot"><span class="annottext">Maybe EpochNo
</span><a href="#local-6989586621682488850"><span class="hs-identifier hs-var">mRetirementEpoch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text (Maybe EpochNo)
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488868"><span class="hs-identifier hs-var">fieldRetirementEpoch</span></a></span><span>
</span><span id="line-467"></span><span>                    </span><span class="annot"><span class="annottext">Maybe PoolRetirementCertificate
-&gt; Either Text (Maybe PoolRetirementCertificate)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe PoolRetirementCertificate
 -&gt; Either Text (Maybe PoolRetirementCertificate))
-&gt; Maybe PoolRetirementCertificate
-&gt; Either Text (Maybe PoolRetirementCertificate)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId -&gt; EpochNo -&gt; PoolRetirementCertificate
</span><a href="Cardano.Wallet.Primitive.Types.html#PoolRetirementCertificate"><span class="hs-identifier hs-var">PoolRetirementCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488851"><span class="hs-identifier hs-var">poolId</span></a></span><span> </span><span class="annot"><span class="annottext">(EpochNo -&gt; PoolRetirementCertificate)
-&gt; Maybe EpochNo -&gt; Maybe PoolRetirementCertificate
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EpochNo
</span><a href="#local-6989586621682488850"><span class="hs-identifier hs-var">mRetirementEpoch</span></a></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span>                </span><span id="local-6989586621682488854"><span class="annot"><span class="annottext">parseMargin :: Either Text Percentage
</span><a href="#local-6989586621682488854"><span class="hs-identifier hs-var hs-var">parseMargin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Percentage
forall a. Integral a =&gt; a -&gt; a -&gt; Percentage
</span><a href="#local-6989586621682488849"><span class="hs-identifier hs-var">mkMargin</span></a></span><span>
</span><span id="line-470"></span><span>                    </span><span class="annot"><span class="annottext">(Word64 -&gt; Word64 -&gt; Percentage)
-&gt; Either Text Word64 -&gt; Either Text (Word64 -&gt; Percentage)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text Word64
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488864"><span class="hs-identifier hs-var">fieldMarginNumerator</span></a></span><span>
</span><span id="line-471"></span><span>                    </span><span class="annot"><span class="annottext">Either Text (Word64 -&gt; Percentage)
-&gt; Either Text Word64 -&gt; Either Text Percentage
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text Word64
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488863"><span class="hs-identifier hs-var">fieldMarginDenominator</span></a></span><span>
</span><span id="line-472"></span><span>                  </span><span class="hs-keyword">where</span><span>
</span><span id="line-473"></span><span>                    </span><span id="local-6989586621682488849"><span class="annot"><span class="annottext">mkMargin :: a -&gt; a -&gt; Percentage
</span><a href="#local-6989586621682488849"><span class="hs-identifier hs-var hs-var">mkMargin</span></a></span></span><span> </span><span id="local-6989586621682488848"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682488848"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682488847"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682488847"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Ratio Integer -&gt; Percentage
Ratio Integer -&gt; Percentage
</span><a href="Cardano.Wallet.Unsafe.html#unsafeMkPercentage"><span class="hs-identifier hs-var">unsafeMkPercentage</span></a></span><span> </span><span class="annot"><span class="annottext">(Ratio Integer -&gt; Percentage) -&gt; Ratio Integer -&gt; Percentage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio a -&gt; Ratio Integer
forall a. Real a =&gt; a -&gt; Ratio Integer
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toRational</span></a></span><span> </span><span class="annot"><span class="annottext">(Ratio a -&gt; Ratio Integer) -&gt; Ratio a -&gt; Ratio Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682488848"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Ratio a
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">%</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682488847"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span>                </span><span id="local-6989586621682488852"><span class="annot"><span class="annottext">parseMetadata :: Either Text (Maybe (StakePoolMetadataUrl, StakePoolMetadataHash))
</span><a href="#local-6989586621682488852"><span class="hs-identifier hs-var hs-var">parseMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-476"></span><span>                    </span><span id="local-6989586621682488846"><span class="annot"><span class="annottext">Maybe StakePoolMetadataUrl
</span><a href="#local-6989586621682488846"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text (Maybe StakePoolMetadataUrl)
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488861"><span class="hs-identifier hs-var">fieldMetadataUrl</span></a></span><span>
</span><span id="line-477"></span><span>                    </span><span id="local-6989586621682488845"><span class="annot"><span class="annottext">Maybe StakePoolMetadataHash
</span><a href="#local-6989586621682488845"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PersistValue -&gt; Either Text (Maybe StakePoolMetadataHash)
forall a. PersistField a =&gt; PersistValue -&gt; Either Text a
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">fromPersistValue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistValue
</span><a href="#local-6989586621682488862"><span class="hs-identifier hs-var">fieldMetadataHash</span></a></span><span>
</span><span id="line-478"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; Either
     Text (Maybe (StakePoolMetadataUrl, StakePoolMetadataHash))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
 -&gt; Either
      Text (Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)))
-&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; Either
     Text (Maybe (StakePoolMetadataUrl, StakePoolMetadataHash))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StakePoolMetadataUrl
 -&gt; StakePoolMetadataHash
 -&gt; (StakePoolMetadataUrl, StakePoolMetadataHash))
-&gt; Maybe StakePoolMetadataUrl
-&gt; Maybe
     (StakePoolMetadataHash
      -&gt; (StakePoolMetadataUrl, StakePoolMetadataHash))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe StakePoolMetadataUrl
</span><a href="#local-6989586621682488846"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (StakePoolMetadataHash
   -&gt; (StakePoolMetadataUrl, StakePoolMetadataHash))
-&gt; Maybe StakePoolMetadataHash
-&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe StakePoolMetadataHash
</span><a href="#local-6989586621682488845"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span>        </span><span id="local-6989586621682489055"><span class="annot"><span class="annottext">rollbackTo :: SlotNo -&gt; ReaderT SqlBackend IO ()
</span><a href="#local-6989586621682489055"><span class="hs-identifier hs-var hs-var">rollbackTo</span></a></span></span><span> </span><span id="local-6989586621682488844"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488844"><span class="hs-identifier hs-var">point</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-481"></span><span>            </span><span class="hs-comment">-- TODO(ADP-356): What if the conversion blocks or fails?</span><span>
</span><span id="line-482"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-483"></span><span>            </span><span class="hs-comment">-- Missing a rollback would be bad.</span><span>
</span><span id="line-484"></span><span>            </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a></span><span> </span><span id="local-6989586621682488843"><span class="annot"><span class="annottext">Word31
</span><a href="#local-6989586621682488843"><span class="hs-identifier hs-var">epoch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO EpochNo -&gt; ReaderT SqlBackend IO EpochNo
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO EpochNo -&gt; ReaderT SqlBackend IO EpochNo)
-&gt; IO EpochNo -&gt; ReaderT SqlBackend IO EpochNo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO -&gt; Qry EpochNo -&gt; IO EpochNo
forall (m :: * -&gt; *) a.
(HasCallStack, Monad m) =&gt;
TimeInterpreter m -&gt; Qry a -&gt; m a
</span><a href="Cardano.Wallet.Primitive.Slotting.html#interpretQuery"><span class="hs-identifier hs-var">interpretQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682489076"><span class="hs-identifier hs-var">ti</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Qry EpochNo
</span><a href="Cardano.Wallet.Primitive.Slotting.html#epochOf"><span class="hs-identifier hs-var">epochOf</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488844"><span class="hs-identifier hs-var">point</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-485"></span><span>            </span><span class="annot"><span class="annottext">[Filter StakeDistribution] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField StakeDistribution Word64
forall typ. (typ ~ Word64) =&gt; EntityField StakeDistribution typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#StakeDistributionEpoch"><span class="hs-identifier hs-var">StakeDistributionEpoch</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField StakeDistribution Word64
-&gt; Word64 -&gt; Filter StakeDistribution
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">&gt;.</span></a></span><span> </span><span class="annot"><span class="annottext">Word31 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word31
</span><a href="#local-6989586621682488843"><span class="hs-identifier hs-var">epoch</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-486"></span><span>
</span><span id="line-487"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolProduction] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolProduction SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField PoolProduction typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolProductionSlot"><span class="hs-identifier hs-var">PoolProductionSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolProduction SlotNo
-&gt; SlotNo -&gt; Filter PoolProduction
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">&gt;.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488844"><span class="hs-identifier hs-var">point</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-488"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolRegistration] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField PoolRegistration typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistrationSlot"><span class="hs-identifier hs-var">PoolRegistrationSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration SlotNo
-&gt; SlotNo -&gt; Filter PoolRegistration
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">&gt;.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488844"><span class="hs-identifier hs-var">point</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-489"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolRetirement] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolRetirement SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField PoolRetirement typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRetirementSlot"><span class="hs-identifier hs-var">PoolRetirementSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRetirement SlotNo
-&gt; SlotNo -&gt; Filter PoolRetirement
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">&gt;.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488844"><span class="hs-identifier hs-var">point</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-490"></span><span>            </span><span class="annot"><span class="annottext">[Filter BlockHeader] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField BlockHeader SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField BlockHeader typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#BlockSlot"><span class="hs-identifier hs-var">BlockSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField BlockHeader SlotNo -&gt; SlotNo -&gt; Filter BlockHeader
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">&gt;.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488844"><span class="hs-identifier hs-var">point</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-491"></span><span>            </span><span class="hs-comment">-- TODO: remove dangling metadata no longer attached to a pool</span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span>        </span><span id="local-6989586621682489054"><span class="annot"><span class="annottext">putDelistedPools :: [PoolId] -&gt; ReaderT backend m ()
</span><a href="#local-6989586621682489054"><span class="hs-identifier hs-var hs-var">putDelistedPools</span></a></span></span><span> </span><span id="local-6989586621682488839"><span class="annot"><span class="annottext">[PoolId]
</span><a href="#local-6989586621682488839"><span class="hs-identifier hs-var">pools</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-494"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolDelistment] -&gt; ReaderT backend m ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolDelistment"><span class="hs-identifier hs-type">PoolDelistment</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span>            </span><span class="annot"><span class="annottext">[PoolDelistment] -&gt; ReaderT backend m ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insertMany_</span></a></span><span> </span><span class="annot"><span class="annottext">([PoolDelistment] -&gt; ReaderT backend m ())
-&gt; [PoolDelistment] -&gt; ReaderT backend m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolId -&gt; PoolDelistment) -&gt; [PoolId] -&gt; [PoolDelistment]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId -&gt; PoolDelistment
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolDelistment"><span class="hs-identifier hs-var">PoolDelistment</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolId]
</span><a href="#local-6989586621682488839"><span class="hs-identifier hs-var">pools</span></a></span><span>
</span><span id="line-496"></span><span>
</span><span id="line-497"></span><span>        </span><span id="local-6989586621682489053"><span class="annot"><span class="annottext">readDelistedPools :: ReaderT SqlBackend IO [PoolId]
</span><a href="#local-6989586621682489053"><span class="hs-identifier hs-var hs-var">readDelistedPools</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-498"></span><span>            </span><span class="annot"><span class="annottext">(Entity PoolDelistment -&gt; PoolId)
-&gt; [Entity PoolDelistment] -&gt; [PoolId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolDelistment -&gt; PoolId
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#delistedPoolId"><span class="hs-identifier hs-var hs-var">delistedPoolId</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolDelistment -&gt; PoolId)
-&gt; (Entity PoolDelistment -&gt; PoolDelistment)
-&gt; Entity PoolDelistment
-&gt; PoolId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity PoolDelistment -&gt; PoolDelistment
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Entity PoolDelistment] -&gt; [PoolId])
-&gt; ReaderT SqlBackend IO [Entity PoolDelistment]
-&gt; ReaderT SqlBackend IO [PoolId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter PoolDelistment]
-&gt; [SelectOpt PoolDelistment]
-&gt; ReaderT SqlBackend IO [Entity PoolDelistment]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span>        </span><span id="local-6989586621682489052"><span class="annot"><span class="annottext">removePools :: [PoolId] -&gt; ReaderT SqlBackend IO ()
</span><a href="#local-6989586621682489052"><span class="hs-identifier hs-var hs-var">removePools</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PoolId -&gt; ReaderT SqlBackend IO ())
-&gt; [PoolId] -&gt; ReaderT SqlBackend IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="annot"><span class="annottext">((PoolId -&gt; ReaderT SqlBackend IO ())
 -&gt; [PoolId] -&gt; ReaderT SqlBackend IO ())
-&gt; (PoolId -&gt; ReaderT SqlBackend IO ())
-&gt; [PoolId]
-&gt; ReaderT SqlBackend IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682488835"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488835"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-501"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; ReaderT SqlBackend IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ReaderT SqlBackend IO ())
-&gt; IO () -&gt; ReaderT SqlBackend IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog -&gt; PoolDbLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-var">traceWith</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682489077"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolDbLog -&gt; IO ()) -&gt; PoolDbLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId -&gt; PoolDbLog
</span><a href="Cardano.Pool.DB.Log.html#MsgRemovingPool"><span class="hs-identifier hs-var">MsgRemovingPool</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488835"><span class="hs-identifier hs-var">pool</span></a></span><span>
</span><span id="line-502"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolProduction] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolProduction PoolId
forall typ. (typ ~ PoolId) =&gt; EntityField PoolProduction typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolProductionPoolId"><span class="hs-identifier hs-var">PoolProductionPoolId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolProduction PoolId
-&gt; PoolId -&gt; Filter PoolProduction
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488835"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-503"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolOwner] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolOwner PoolId
forall typ. (typ ~ PoolId) =&gt; EntityField PoolOwner typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolOwnerPoolId"><span class="hs-identifier hs-var">PoolOwnerPoolId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolOwner PoolId -&gt; PoolId -&gt; Filter PoolOwner
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488835"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-504"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolRegistration] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration PoolId
forall typ. (typ ~ PoolId) =&gt; EntityField PoolRegistration typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistrationPoolId"><span class="hs-identifier hs-var">PoolRegistrationPoolId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration PoolId
-&gt; PoolId -&gt; Filter PoolRegistration
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488835"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-505"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolRetirement] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolRetirement PoolId
forall typ. (typ ~ PoolId) =&gt; EntityField PoolRetirement typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRetirementPoolId"><span class="hs-identifier hs-var">PoolRetirementPoolId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRetirement PoolId
-&gt; PoolId -&gt; Filter PoolRetirement
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488835"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-506"></span><span>            </span><span class="annot"><span class="annottext">[Filter StakeDistribution] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField StakeDistribution PoolId
forall typ. (typ ~ PoolId) =&gt; EntityField StakeDistribution typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#StakeDistributionPoolId"><span class="hs-identifier hs-var">StakeDistributionPoolId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField StakeDistribution PoolId
-&gt; PoolId -&gt; Filter StakeDistribution
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488835"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span>        </span><span id="local-6989586621682489051"><span class="annot"><span class="annottext">removeRetiredPools :: EpochNo -&gt; ReaderT SqlBackend IO [PoolRetirementCertificate]
</span><a href="#local-6989586621682489051"><span class="hs-identifier hs-var hs-var">removeRetiredPools</span></a></span></span><span> </span><span id="local-6989586621682488830"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682488830"><span class="hs-identifier hs-var">epoch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-509"></span><span>            </span><span class="annot"><span class="annottext">Tracer (ReaderT SqlBackend IO) BracketLog
-&gt; ReaderT SqlBackend IO [PoolRetirementCertificate]
-&gt; ReaderT SqlBackend IO [PoolRetirementCertificate]
forall (m :: * -&gt; *) a.
MonadUnliftIO m =&gt;
Tracer m BracketLog -&gt; m a -&gt; m a
</span><a href="Cardano.Wallet.Logging.html#bracketTracer"><span class="hs-identifier hs-var">bracketTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer (ReaderT SqlBackend IO) BracketLog
</span><a href="#local-6989586621682488829"><span class="hs-identifier hs-var">traceOuter</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO [PoolRetirementCertificate]
</span><a href="#local-6989586621682488828"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-510"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-511"></span><span>            </span><span id="local-6989586621682488828"><span class="annot"><span class="annottext">action :: ReaderT SqlBackend IO [PoolRetirementCertificate]
</span><a href="#local-6989586621682488828"><span class="hs-identifier hs-var hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; ReaderT SqlBackend IO [PoolRetirementCertificate]
</span><a href="#local-6989586621682489057"><span class="hs-identifier hs-var">listRetiredPools</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682488830"><span class="hs-identifier hs-var">epoch</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT SqlBackend IO [PoolRetirementCertificate]
-&gt; ([PoolRetirementCertificate]
    -&gt; ReaderT SqlBackend IO [PoolRetirementCertificate])
-&gt; ReaderT SqlBackend IO [PoolRetirementCertificate]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682488827"><span class="annot"><span class="annottext">[PoolRetirementCertificate]
</span><a href="#local-6989586621682488827"><span class="hs-identifier hs-var">retirementCerts</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-512"></span><span>                </span><span class="annot"><span class="annottext">[PoolRetirementCertificate] -&gt; ReaderT SqlBackend IO ()
</span><a href="#local-6989586621682488826"><span class="hs-identifier hs-var">traceInner</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolRetirementCertificate]
</span><a href="#local-6989586621682488827"><span class="hs-identifier hs-var">retirementCerts</span></a></span><span>
</span><span id="line-513"></span><span>                </span><span class="annot"><span class="annottext">[PoolId] -&gt; ReaderT SqlBackend IO ()
</span><a href="#local-6989586621682489052"><span class="hs-identifier hs-var">removePools</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((PoolId -&gt; Const PoolId PoolId)
 -&gt; PoolRetirementCertificate
 -&gt; Const PoolId PoolRetirementCertificate)
-&gt; PoolRetirementCertificate -&gt; PoolId
forall a s. ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; s -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;poolId&quot;
  ((PoolId -&gt; Const PoolId PoolId)
   -&gt; PoolRetirementCertificate
   -&gt; Const PoolId PoolRetirementCertificate)
(PoolId -&gt; Const PoolId PoolId)
-&gt; PoolRetirementCertificate
-&gt; Const PoolId PoolRetirementCertificate
</span><a href="#local-6989586621682488825"><span class="hs-var">#poolId</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolRetirementCertificate -&gt; PoolId)
-&gt; [PoolRetirementCertificate] -&gt; [PoolId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolRetirementCertificate]
</span><a href="#local-6989586621682488827"><span class="hs-identifier hs-var">retirementCerts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-514"></span><span>                </span><span class="annot"><span class="annottext">[PoolRetirementCertificate]
-&gt; ReaderT SqlBackend IO [PoolRetirementCertificate]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolRetirementCertificate]
</span><a href="#local-6989586621682488827"><span class="hs-identifier hs-var">retirementCerts</span></a></span><span>
</span><span id="line-515"></span><span>            </span><span id="local-6989586621682488829"><span class="annot"><span class="annottext">traceOuter :: Tracer (ReaderT SqlBackend IO) BracketLog
</span><a href="#local-6989586621682488829"><span class="hs-identifier hs-var hs-var">traceOuter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682489077"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-516"></span><span>                </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
-&gt; (Tracer IO PoolDbLog
    -&gt; Tracer (ReaderT SqlBackend IO) PoolDbLog)
-&gt; Tracer (ReaderT SqlBackend IO) PoolDbLog
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(forall x. IO x -&gt; ReaderT SqlBackend IO x)
-&gt; Tracer IO PoolDbLog -&gt; Tracer (ReaderT SqlBackend IO) PoolDbLog
forall (m :: * -&gt; *) (n :: * -&gt; *) s.
(forall x. m x -&gt; n x) -&gt; Tracer m s -&gt; Tracer n s
</span><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-var">natTracer</span></a></span><span> </span><span class="annot"><span class="annottext">forall x. IO x -&gt; ReaderT SqlBackend IO x
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span>
</span><span id="line-517"></span><span>                </span><span class="annot"><span class="annottext">Tracer (ReaderT SqlBackend IO) PoolDbLog
-&gt; (Tracer (ReaderT SqlBackend IO) PoolDbLog
    -&gt; Tracer (ReaderT SqlBackend IO) BracketLog)
-&gt; Tracer (ReaderT SqlBackend IO) BracketLog
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(BracketLog -&gt; PoolDbLog)
-&gt; Tracer (ReaderT SqlBackend IO) PoolDbLog
-&gt; Tracer (ReaderT SqlBackend IO) BracketLog
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpochNo -&gt; BracketLog -&gt; PoolDbLog
</span><a href="Cardano.Pool.DB.Log.html#MsgRemovingRetiredPoolsForEpoch"><span class="hs-identifier hs-var">MsgRemovingRetiredPoolsForEpoch</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682488830"><span class="hs-identifier hs-var">epoch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-518"></span><span>            </span><span id="local-6989586621682488826"><span class="annot"><span class="annottext">traceInner :: [PoolRetirementCertificate] -&gt; ReaderT SqlBackend IO ()
</span><a href="#local-6989586621682488826"><span class="hs-identifier hs-var hs-var">traceInner</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; ReaderT SqlBackend IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span>
</span><span id="line-519"></span><span>                </span><span class="annot"><span class="annottext">(IO () -&gt; ReaderT SqlBackend IO ())
-&gt; ([PoolRetirementCertificate] -&gt; IO ())
-&gt; [PoolRetirementCertificate]
-&gt; ReaderT SqlBackend IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog -&gt; PoolDbLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-var">traceWith</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682489077"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-520"></span><span>                </span><span class="annot"><span class="annottext">(PoolDbLog -&gt; IO ())
-&gt; ([PoolRetirementCertificate] -&gt; PoolDbLog)
-&gt; [PoolRetirementCertificate]
-&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[PoolRetirementCertificate] -&gt; PoolDbLog
</span><a href="Cardano.Pool.DB.Log.html#MsgRemovingRetiredPools"><span class="hs-identifier hs-var">MsgRemovingRetiredPools</span></a></span><span>
</span><span id="line-521"></span><span>
</span><span id="line-522"></span><span>        </span><span id="local-6989586621682489050"><span class="annot"><span class="annottext">readPoolProductionCursor :: Int -&gt; ReaderT backend m [BlockHeader]
</span><a href="#local-6989586621682489050"><span class="hs-identifier hs-var hs-var">readPoolProductionCursor</span></a></span></span><span> </span><span id="local-6989586621682488822"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682488822"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-523"></span><span>            </span><span class="annot"><span class="annottext">[BlockHeader] -&gt; [BlockHeader]
forall a. [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockHeader] -&gt; [BlockHeader])
-&gt; ([Entity PoolProduction] -&gt; [BlockHeader])
-&gt; [Entity PoolProduction]
-&gt; [BlockHeader]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Entity PoolProduction -&gt; BlockHeader)
-&gt; [Entity PoolProduction] -&gt; [BlockHeader]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PoolId, BlockHeader) -&gt; BlockHeader
forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">((PoolId, BlockHeader) -&gt; BlockHeader)
-&gt; (Entity PoolProduction -&gt; (PoolId, BlockHeader))
-&gt; Entity PoolProduction
-&gt; BlockHeader
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">PoolProduction -&gt; (PoolId, BlockHeader)
</span><a href="Cardano.Pool.DB.Sqlite.html#fromPoolProduction"><span class="hs-identifier hs-var">fromPoolProduction</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolProduction -&gt; (PoolId, BlockHeader))
-&gt; (Entity PoolProduction -&gt; PoolProduction)
-&gt; Entity PoolProduction
-&gt; (PoolId, BlockHeader)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity PoolProduction -&gt; PoolProduction
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Entity PoolProduction] -&gt; [BlockHeader])
-&gt; ReaderT backend m [Entity PoolProduction]
-&gt; ReaderT backend m [BlockHeader]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter PoolProduction]
-&gt; [SelectOpt PoolProduction]
-&gt; ReaderT backend m [Entity PoolProduction]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-524"></span><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-525"></span><span>                </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField PoolProduction SlotNo -&gt; SelectOpt PoolProduction
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Desc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolProduction SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField PoolProduction typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolProductionSlot"><span class="hs-identifier hs-var">PoolProductionSlot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SelectOpt PoolProduction
forall record. Int -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">LimitTo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682488822"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-526"></span><span>
</span><span id="line-527"></span><span>        </span><span id="local-6989586621682489049"><span class="annot"><span class="annottext">readSystemSeed :: ReaderT SqlBackend IO StdGen
</span><a href="#local-6989586621682489049"><span class="hs-identifier hs-var hs-var">readSystemSeed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-528"></span><span>            </span><span id="local-6989586621682488819"><span class="annot"><span class="annottext">Maybe (Entity ArbitrarySeed)
</span><a href="#local-6989586621682488819"><span class="hs-identifier hs-var">mseed</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Filter ArbitrarySeed]
-&gt; [SelectOpt ArbitrarySeed]
-&gt; ReaderT SqlBackend IO (Maybe (Entity ArbitrarySeed))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-529"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Entity ArbitrarySeed)
</span><a href="#local-6989586621682488819"><span class="hs-identifier hs-var">mseed</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-530"></span><span>                </span><span class="annot"><span class="annottext">Maybe (Entity ArbitrarySeed)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-531"></span><span>                    </span><span id="local-6989586621682488818"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621682488818"><span class="hs-identifier hs-var">seed</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO StdGen -&gt; ReaderT SqlBackend IO StdGen
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO StdGen
forall (m :: * -&gt; *). MonadIO m =&gt; m StdGen
</span><a href="../../../../random/html/src"><span class="hs-identifier hs-var">newStdGen</span></a></span><span>
</span><span id="line-532"></span><span>                    </span><span class="annot"><span class="annottext">ArbitrarySeed -&gt; ReaderT SqlBackend IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insert_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StdGen -&gt; ArbitrarySeed
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#ArbitrarySeed"><span class="hs-identifier hs-var">ArbitrarySeed</span></a></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621682488818"><span class="hs-identifier hs-var">seed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>                    </span><span class="annot"><span class="annottext">StdGen -&gt; ReaderT SqlBackend IO StdGen
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621682488818"><span class="hs-identifier hs-var">seed</span></a></span><span>
</span><span id="line-534"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682488816"><span class="annot"><span class="annottext">Entity ArbitrarySeed
</span><a href="#local-6989586621682488816"><span class="hs-identifier hs-var">seed</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-535"></span><span>                    </span><span class="annot"><span class="annottext">StdGen -&gt; ReaderT SqlBackend IO StdGen
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(StdGen -&gt; ReaderT SqlBackend IO StdGen)
-&gt; StdGen -&gt; ReaderT SqlBackend IO StdGen
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ArbitrarySeed -&gt; StdGen
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#seedSeed"><span class="hs-identifier hs-var hs-var">seedSeed</span></a></span><span> </span><span class="annot"><span class="annottext">(ArbitrarySeed -&gt; StdGen) -&gt; ArbitrarySeed -&gt; StdGen
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Entity ArbitrarySeed -&gt; ArbitrarySeed
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">Entity ArbitrarySeed
</span><a href="#local-6989586621682488816"><span class="hs-identifier hs-var">seed</span></a></span><span>
</span><span id="line-536"></span><span>
</span><span id="line-537"></span><span>        </span><span id="local-6989586621682489048"><span class="annot"><span class="annottext">readSettings :: ReaderT SqlBackend IO Settings
</span><a href="#local-6989586621682489048"><span class="hs-identifier hs-var hs-var">readSettings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-538"></span><span>            </span><span id="local-6989586621682488814"><span class="annot"><span class="annottext">[Entity Settings]
</span><a href="#local-6989586621682488814"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Filter Settings]
-&gt; [SelectOpt Settings] -&gt; ReaderT SqlBackend IO [Entity Settings]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-539"></span><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-540"></span><span>                </span><span class="hs-comment">-- only ever read the first row</span><span>
</span><span id="line-541"></span><span>                </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField Settings SettingsId -&gt; SelectOpt Settings
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Asc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField Settings SettingsId
forall typ. (typ ~ SettingsId) =&gt; EntityField Settings typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#SettingsId"><span class="hs-identifier hs-var">SettingsId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SelectOpt Settings
forall record. Int -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">LimitTo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-542"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Entity Settings]
</span><a href="#local-6989586621682488814"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-543"></span><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; ReaderT SqlBackend IO Settings
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="Cardano.Wallet.Primitive.Types.html#defaultSettings"><span class="hs-identifier hs-var">defaultSettings</span></a></span><span>
</span><span id="line-544"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621682488811"><span class="annot"><span class="annottext">Entity Settings
</span><a href="#local-6989586621682488811"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">[Entity Settings]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; ReaderT SqlBackend IO Settings
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Settings -&gt; ReaderT SqlBackend IO Settings)
-&gt; (Entity Settings -&gt; Settings)
-&gt; Entity Settings
-&gt; ReaderT SqlBackend IO Settings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Settings
</span><a href="Cardano.Pool.DB.Sqlite.html#fromSettings"><span class="hs-identifier hs-var">fromSettings</span></a></span><span> </span><span class="annot"><span class="annottext">(Settings -&gt; Settings)
-&gt; (Entity Settings -&gt; Settings) -&gt; Entity Settings -&gt; Settings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity Settings -&gt; Settings
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">(Entity Settings -&gt; ReaderT SqlBackend IO Settings)
-&gt; Entity Settings -&gt; ReaderT SqlBackend IO Settings
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Entity Settings
</span><a href="#local-6989586621682488811"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span>        </span><span id="local-6989586621682489047"><span class="annot"><span class="annottext">putSettings :: Settings -&gt; ReaderT SqlBackend IO ()
</span><a href="#local-6989586621682489047"><span class="hs-identifier hs-var hs-var">putSettings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-547"></span><span>            </span><span class="annot"><span class="annottext">SettingsId -&gt; Settings -&gt; ReaderT SqlBackend IO ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
Key record -&gt; record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">repsert</span></a></span><span>
</span><span id="line-548"></span><span>                </span><span class="hs-comment">-- only ever write the first row</span><span>
</span><span id="line-549"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BackendKey SqlBackend -&gt; SettingsId
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#SettingsKey"><span class="hs-identifier hs-var">SettingsKey</span></a></span><span> </span><span class="annot"><span class="annottext">BackendKey SqlBackend
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-550"></span><span>            </span><span class="annot"><span class="annottext">(Settings -&gt; ReaderT SqlBackend IO ())
-&gt; (Settings -&gt; Settings) -&gt; Settings -&gt; ReaderT SqlBackend IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Settings
</span><a href="Cardano.Pool.DB.Sqlite.html#toSettings"><span class="hs-identifier hs-var">toSettings</span></a></span><span>
</span><span id="line-551"></span><span>
</span><span id="line-552"></span><span>        </span><span id="local-6989586621682489046"><span class="annot"><span class="annottext">readLastMetadataGC :: ReaderT SqlBackend IO (Maybe POSIXTime)
</span><a href="#local-6989586621682489046"><span class="hs-identifier hs-var hs-var">readLastMetadataGC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-553"></span><span>            </span><span class="hs-comment">-- only ever read the first row</span><span>
</span><span id="line-554"></span><span>            </span><span id="local-6989586621682488807"><span class="annot"><span class="annottext">Maybe (Entity InternalState)
</span><a href="#local-6989586621682488807"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Filter InternalState]
-&gt; [SelectOpt InternalState]
-&gt; ReaderT SqlBackend IO (Maybe (Entity InternalState))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span>
</span><span id="line-555"></span><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-556"></span><span>                </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField InternalState InternalStateId
-&gt; SelectOpt InternalState
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Asc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField InternalState InternalStateId
forall typ.
(typ ~ InternalStateId) =&gt;
EntityField InternalState typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#InternalStateId"><span class="hs-identifier hs-var">InternalStateId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SelectOpt InternalState
forall record. Int -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">LimitTo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-557"></span><span>            </span><span class="annot"><span class="annottext">Maybe POSIXTime -&gt; ReaderT SqlBackend IO (Maybe POSIXTime)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe POSIXTime -&gt; ReaderT SqlBackend IO (Maybe POSIXTime))
-&gt; Maybe POSIXTime -&gt; ReaderT SqlBackend IO (Maybe POSIXTime)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InternalState -&gt; Maybe POSIXTime
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AlastMetadataGC%3AInternalState"><span class="hs-identifier hs-var hs-var">W.lastMetadataGC</span></a></span><span> </span><span class="annot"><span class="annottext">(InternalState -&gt; Maybe POSIXTime)
-&gt; (Entity InternalState -&gt; InternalState)
-&gt; Entity InternalState
-&gt; Maybe POSIXTime
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState -&gt; InternalState
</span><a href="Cardano.Pool.DB.Sqlite.html#fromInternalState"><span class="hs-identifier hs-var">fromInternalState</span></a></span><span> </span><span class="annot"><span class="annottext">(InternalState -&gt; InternalState)
-&gt; (Entity InternalState -&gt; InternalState)
-&gt; Entity InternalState
-&gt; InternalState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity InternalState -&gt; InternalState
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Entity InternalState -&gt; Maybe POSIXTime)
-&gt; Maybe (Entity InternalState) -&gt; Maybe POSIXTime
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Entity InternalState)
</span><a href="#local-6989586621682488807"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-558"></span><span>
</span><span id="line-559"></span><span>        </span><span id="local-6989586621682489045"><span class="annot"><span class="annottext">putLastMetadataGC :: POSIXTime -&gt; ReaderT backend m ()
</span><a href="#local-6989586621682489045"><span class="hs-identifier hs-var hs-var">putLastMetadataGC</span></a></span></span><span> </span><span id="local-6989586621682488802"><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621682488802"><span class="hs-identifier hs-var">utc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-560"></span><span>            </span><span id="local-6989586621682488801"><span class="annot"><span class="annottext">Maybe (Entity InternalState)
</span><a href="#local-6989586621682488801"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Filter InternalState]
-&gt; [SelectOpt InternalState]
-&gt; ReaderT backend m (Maybe (Entity InternalState))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span>
</span><span id="line-561"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField InternalState InternalStateId
forall typ.
(typ ~ InternalStateId) =&gt;
EntityField InternalState typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#InternalStateId"><span class="hs-identifier hs-var">InternalStateId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField InternalState InternalStateId
-&gt; InternalStateId -&gt; Filter InternalState
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BackendKey SqlBackend -&gt; InternalStateId
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#InternalStateKey"><span class="hs-identifier hs-var">InternalStateKey</span></a></span><span> </span><span class="annot"><span class="annottext">BackendKey SqlBackend
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-562"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-563"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Entity InternalState)
</span><a href="#local-6989586621682488801"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-564"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Entity InternalState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InternalStateId -&gt; [Update InternalState] -&gt; ReaderT backend m ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
Key record -&gt; [Update record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BackendKey SqlBackend -&gt; InternalStateId
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#InternalStateKey"><span class="hs-identifier hs-var">InternalStateKey</span></a></span><span> </span><span class="annot"><span class="annottext">BackendKey SqlBackend
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField InternalState (Maybe POSIXTime)
forall typ.
(typ ~ Maybe POSIXTime) =&gt;
EntityField InternalState typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#LastGCMetadata"><span class="hs-identifier hs-var">LastGCMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField InternalState (Maybe POSIXTime)
-&gt; Maybe POSIXTime -&gt; Update InternalState
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Update v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">=.</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; Maybe POSIXTime
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621682488802"><span class="hs-identifier hs-var">utc</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-565"></span><span>                </span><span class="annot"><span class="annottext">Maybe (Entity InternalState)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InternalState -&gt; ReaderT backend m ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">insert_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe POSIXTime -&gt; InternalState
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#InternalState"><span class="hs-identifier hs-var">InternalState</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe POSIXTime -&gt; InternalState)
-&gt; Maybe POSIXTime -&gt; InternalState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; Maybe POSIXTime
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621682488802"><span class="hs-identifier hs-var">utc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-566"></span><span>
</span><span id="line-567"></span><span>        </span><span id="local-6989586621682489044"><span class="annot"><span class="annottext">cleanDB :: ReaderT SqlBackend IO ()
</span><a href="#local-6989586621682489044"><span class="hs-identifier hs-var hs-var">cleanDB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-568"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolProduction] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolProduction"><span class="hs-identifier hs-type">PoolProduction</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-569"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolOwner] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolOwner"><span class="hs-identifier hs-type">PoolOwner</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolRegistration] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistration"><span class="hs-identifier hs-type">PoolRegistration</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-571"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolRetirement] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRetirement"><span class="hs-identifier hs-type">PoolRetirement</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-572"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolDelistment] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolDelistment"><span class="hs-identifier hs-type">PoolDelistment</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-573"></span><span>            </span><span class="annot"><span class="annottext">[Filter StakeDistribution] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#StakeDistribution"><span class="hs-identifier hs-type">StakeDistribution</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-574"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolMetadata] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolMetadata"><span class="hs-identifier hs-type">PoolMetadata</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>            </span><span class="annot"><span class="annottext">[Filter PoolMetadataFetchAttempts] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolMetadataFetchAttempts"><span class="hs-identifier hs-type">PoolMetadataFetchAttempts</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-576"></span><span>            </span><span class="annot"><span class="annottext">[Filter BlockHeader] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#BlockHeader"><span class="hs-identifier hs-type">TH.BlockHeader</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-577"></span><span>            </span><span class="annot"><span class="annottext">[Filter Settings] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-578"></span><span>            </span><span class="annot"><span class="annottext">[Filter InternalState] -&gt; ReaderT SqlBackend IO ()
forall backend (m :: * -&gt; *) record.
(PersistQueryWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record] -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">deleteWhere</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">Filter</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span>        </span><span class="annot"><a href="#local-6989586621682489043"><span class="hs-identifier hs-type">atomically</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682488797"><span class="annot"><a href="#local-6989586621682488797"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488797"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682488797"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-581"></span><span>        </span><span id="local-6989586621682489043"><span class="annot"><span class="annottext">atomically :: SqlPersistT IO a -&gt; IO a
</span><a href="#local-6989586621682489043"><span class="hs-identifier hs-var hs-var">atomically</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SqlPersistT IO a -&gt; IO a
forall a. SqlPersistT IO a -&gt; IO a
</span><a href="#local-6989586621682489074"><span class="hs-identifier hs-var">runQuery</span></a></span><span>
</span><span id="line-582"></span><span>
</span><span id="line-583"></span><span>        </span><span id="local-6989586621682489042"><span class="annot"><span class="annottext">readPoolRegistration :: PoolId
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
</span><a href="#local-6989586621682489042"><span class="hs-identifier hs-var hs-var">readPoolRegistration</span></a></span></span><span> </span><span id="local-6989586621682488796"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488796"><span class="hs-identifier hs-var">poolId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-584"></span><span>            </span><span id="local-6989586621682488795"><span class="annot"><span class="annottext">Maybe (Entity PoolRegistration)
</span><a href="#local-6989586621682488795"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Filter PoolRegistration]
-&gt; [SelectOpt PoolRegistration]
-&gt; ReaderT backend m (Maybe (Entity PoolRegistration))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span>
</span><span id="line-585"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration PoolId
forall typ. (typ ~ PoolId) =&gt; EntityField PoolRegistration typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistrationPoolId"><span class="hs-identifier hs-var">PoolRegistrationPoolId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration PoolId
-&gt; PoolId -&gt; Filter PoolRegistration
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488796"><span class="hs-identifier hs-var">poolId</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-586"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration SlotNo -&gt; SelectOpt PoolRegistration
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Desc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField PoolRegistration typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistrationSlot"><span class="hs-identifier hs-var">PoolRegistrationSlot</span></a></span><span>
</span><span id="line-587"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration Word64 -&gt; SelectOpt PoolRegistration
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Desc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRegistration Word64
forall typ. (typ ~ Word64) =&gt; EntityField PoolRegistration typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistrationSlotInternalIndex"><span class="hs-identifier hs-var">PoolRegistrationSlotInternalIndex</span></a></span><span>
</span><span id="line-588"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-589"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Entity PoolRegistration)
-&gt; (Entity PoolRegistration
    -&gt; ReaderT
         backend
         m
         (CertificatePublicationTime, PoolRegistrationCertificate))
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Entity PoolRegistration)
</span><a href="#local-6989586621682488795"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="annot"><span class="annottext">((Entity PoolRegistration
  -&gt; ReaderT
       backend
       m
       (CertificatePublicationTime, PoolRegistrationCertificate))
 -&gt; ReaderT
      backend
      m
      (Maybe (CertificatePublicationTime, PoolRegistrationCertificate)))
-&gt; (Entity PoolRegistration
    -&gt; ReaderT
         backend
         m
         (CertificatePublicationTime, PoolRegistrationCertificate))
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRegistrationCertificate))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682488794"><span class="annot"><span class="annottext">Entity PoolRegistration
</span><a href="#local-6989586621682488794"><span class="hs-identifier hs-var">meta</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-590"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRegistration"><span class="hs-identifier hs-type">PoolRegistration</span></a></span><span>
</span><span id="line-591"></span><span>                        </span><span id="local-6989586621682488793"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488793"><span class="hs-identifier hs-var">_poolId</span></a></span></span><span>
</span><span id="line-592"></span><span>                        </span><span id="local-6989586621682488792"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488792"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span>
</span><span id="line-593"></span><span>                        </span><span id="local-6989586621682488791"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488791"><span class="hs-identifier hs-var">slotInternalIndex</span></a></span></span><span>
</span><span id="line-594"></span><span>                        </span><span id="local-6989586621682488790"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488790"><span class="hs-identifier hs-var">marginNum</span></a></span></span><span>
</span><span id="line-595"></span><span>                        </span><span id="local-6989586621682488789"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488789"><span class="hs-identifier hs-var">marginDen</span></a></span></span><span>
</span><span id="line-596"></span><span>                        </span><span id="local-6989586621682488788"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488788"><span class="hs-identifier hs-var">poolCost_</span></a></span></span><span>
</span><span id="line-597"></span><span>                        </span><span id="local-6989586621682488787"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488787"><span class="hs-identifier hs-var">poolPledge_</span></a></span></span><span>
</span><span id="line-598"></span><span>                        </span><span id="local-6989586621682488786"><span class="annot"><span class="annottext">Maybe StakePoolMetadataUrl
</span><a href="#local-6989586621682488786"><span class="hs-identifier hs-var">poolMetadataUrl</span></a></span></span><span>
</span><span id="line-599"></span><span>                        </span><span id="local-6989586621682488785"><span class="annot"><span class="annottext">Maybe StakePoolMetadataHash
</span><a href="#local-6989586621682488785"><span class="hs-identifier hs-var">poolMetadataHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Entity PoolRegistration -&gt; PoolRegistration
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">Entity PoolRegistration
</span><a href="#local-6989586621682488794"><span class="hs-identifier hs-var">meta</span></a></span><span>
</span><span id="line-600"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488784"><span class="annot"><span class="annottext">poolMargin :: Percentage
</span><a href="#local-6989586621682488784"><span class="hs-identifier hs-var hs-var">poolMargin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Ratio Integer -&gt; Percentage
Ratio Integer -&gt; Percentage
</span><a href="Cardano.Wallet.Unsafe.html#unsafeMkPercentage"><span class="hs-identifier hs-var">unsafeMkPercentage</span></a></span><span> </span><span class="annot"><span class="annottext">(Ratio Integer -&gt; Percentage) -&gt; Ratio Integer -&gt; Percentage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-601"></span><span>                        </span><span class="annot"><span class="annottext">Ratio Word64 -&gt; Ratio Integer
forall a. Real a =&gt; a -&gt; Ratio Integer
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toRational</span></a></span><span> </span><span class="annot"><span class="annottext">(Ratio Word64 -&gt; Ratio Integer) -&gt; Ratio Word64 -&gt; Ratio Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488790"><span class="hs-identifier hs-var">marginNum</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Ratio Word64
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">%</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488789"><span class="hs-identifier hs-var">marginDen</span></a></span><span>
</span><span id="line-602"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488783"><span class="annot"><span class="annottext">poolCost :: Coin
</span><a href="#local-6989586621682488783"><span class="hs-identifier hs-var hs-var">poolCost</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Coin
</span><a href="Cardano.Wallet.Primitive.Types.Coin.html#fromWord64"><span class="hs-identifier hs-var">Coin.fromWord64</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488788"><span class="hs-identifier hs-var">poolCost_</span></a></span><span>
</span><span id="line-603"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488782"><span class="annot"><span class="annottext">poolPledge :: Coin
</span><a href="#local-6989586621682488782"><span class="hs-identifier hs-var hs-var">poolPledge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Coin
</span><a href="Cardano.Wallet.Primitive.Types.Coin.html#fromWord64"><span class="hs-identifier hs-var">Coin.fromWord64</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488787"><span class="hs-identifier hs-var">poolPledge_</span></a></span><span>
</span><span id="line-604"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488781"><span class="annot"><span class="annottext">poolMetadata :: Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="#local-6989586621682488781"><span class="hs-identifier hs-var hs-var">poolMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StakePoolMetadataUrl
 -&gt; StakePoolMetadataHash
 -&gt; (StakePoolMetadataUrl, StakePoolMetadataHash))
-&gt; Maybe StakePoolMetadataUrl
-&gt; Maybe
     (StakePoolMetadataHash
      -&gt; (StakePoolMetadataUrl, StakePoolMetadataHash))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe StakePoolMetadataUrl
</span><a href="#local-6989586621682488786"><span class="hs-identifier hs-var">poolMetadataUrl</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (StakePoolMetadataHash
   -&gt; (StakePoolMetadataUrl, StakePoolMetadataHash))
-&gt; Maybe StakePoolMetadataHash
-&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe StakePoolMetadataHash
</span><a href="#local-6989586621682488785"><span class="hs-identifier hs-var">poolMetadataHash</span></a></span><span>
</span><span id="line-605"></span><span>                </span><span id="local-6989586621682488780"><span class="annot"><span class="annottext">[PoolOwner]
</span><a href="#local-6989586621682488780"><span class="hs-identifier hs-var">poolOwners</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Entity PoolOwner -&gt; PoolOwner)
-&gt; [Entity PoolOwner] -&gt; [PoolOwner]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolOwner -&gt; PoolOwner
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#poolOwnerOwner"><span class="hs-identifier hs-var hs-var">poolOwnerOwner</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolOwner -&gt; PoolOwner)
-&gt; (Entity PoolOwner -&gt; PoolOwner) -&gt; Entity PoolOwner -&gt; PoolOwner
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity PoolOwner -&gt; PoolOwner
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Entity PoolOwner] -&gt; [PoolOwner])
-&gt; ReaderT backend m [Entity PoolOwner]
-&gt; ReaderT backend m [PoolOwner]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-606"></span><span>                    </span><span class="annot"><span class="annottext">[Filter PoolOwner]
-&gt; [SelectOpt PoolOwner] -&gt; ReaderT backend m [Entity PoolOwner]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-607"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolOwner PoolId
forall typ. (typ ~ PoolId) =&gt; EntityField PoolOwner typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolOwnerPoolId"><span class="hs-identifier hs-var">PoolOwnerPoolId</span></a></span><span>
</span><span id="line-608"></span><span>                            </span><span class="annot"><span class="annottext">EntityField PoolOwner PoolId -&gt; PoolId -&gt; Filter PoolOwner
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488796"><span class="hs-identifier hs-var">poolId</span></a></span><span>
</span><span id="line-609"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField PoolOwner SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField PoolOwner typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolOwnerSlot"><span class="hs-identifier hs-var">PoolOwnerSlot</span></a></span><span>
</span><span id="line-610"></span><span>                            </span><span class="annot"><span class="annottext">EntityField PoolOwner SlotNo -&gt; SlotNo -&gt; Filter PoolOwner
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488792"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-611"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField PoolOwner Word64
forall typ. (typ ~ Word64) =&gt; EntityField PoolOwner typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolOwnerSlotInternalIndex"><span class="hs-identifier hs-var">PoolOwnerSlotInternalIndex</span></a></span><span>
</span><span id="line-612"></span><span>                            </span><span class="annot"><span class="annottext">EntityField PoolOwner Word64 -&gt; Word64 -&gt; Filter PoolOwner
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488791"><span class="hs-identifier hs-var">slotInternalIndex</span></a></span><span>
</span><span id="line-613"></span><span>                        </span><span class="hs-special">]</span><span>
</span><span id="line-614"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolOwner Word8 -&gt; SelectOpt PoolOwner
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Asc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolOwner Word8
forall typ. (typ ~ Word8) =&gt; EntityField PoolOwner typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolOwnerIndex"><span class="hs-identifier hs-var">PoolOwnerIndex</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-615"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488777"><span class="annot"><span class="annottext">cert :: PoolRegistrationCertificate
</span><a href="#local-6989586621682488777"><span class="hs-identifier hs-var hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate :: PoolId
-&gt; [PoolOwner]
-&gt; Percentage
-&gt; Coin
-&gt; Coin
-&gt; Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
-&gt; PoolRegistrationCertificate
</span><a href="Cardano.Wallet.Primitive.Types.html#PoolRegistrationCertificate"><span class="hs-identifier hs-type">PoolRegistrationCertificate</span></a></span><span>
</span><span id="line-616"></span><span>                        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">PoolId
$sel:poolId:PoolRegistrationCertificate :: PoolId
poolId :: PoolId
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3ApoolId%3APoolRegistrationCertificate"><span class="hs-identifier hs-var hs-var">poolId</span></a></span><span>
</span><span id="line-617"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PoolOwner]
poolOwners :: [PoolOwner]
$sel:poolOwners:PoolRegistrationCertificate :: [PoolOwner]
</span><a href="#local-6989586621682488780"><span class="hs-identifier hs-var hs-var">poolOwners</span></a></span><span>
</span><span id="line-618"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Percentage
poolMargin :: Percentage
$sel:poolMargin:PoolRegistrationCertificate :: Percentage
</span><a href="#local-6989586621682488784"><span class="hs-identifier hs-var hs-var">poolMargin</span></a></span><span>
</span><span id="line-619"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coin
poolCost :: Coin
$sel:poolCost:PoolRegistrationCertificate :: Coin
</span><a href="#local-6989586621682488783"><span class="hs-identifier hs-var hs-var">poolCost</span></a></span><span>
</span><span id="line-620"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coin
poolPledge :: Coin
$sel:poolPledge:PoolRegistrationCertificate :: Coin
</span><a href="#local-6989586621682488782"><span class="hs-identifier hs-var hs-var">poolPledge</span></a></span><span>
</span><span id="line-621"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
poolMetadata :: Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
$sel:poolMetadata:PoolRegistrationCertificate :: Maybe (StakePoolMetadataUrl, StakePoolMetadataHash)
</span><a href="#local-6989586621682488781"><span class="hs-identifier hs-var hs-var">poolMetadata</span></a></span><span>
</span><span id="line-622"></span><span>                        </span><span class="hs-special">}</span><span>
</span><span id="line-623"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488775"><span class="annot"><span class="annottext">cpt :: CertificatePublicationTime
</span><a href="#local-6989586621682488775"><span class="hs-identifier hs-var hs-var">cpt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CertificatePublicationTime :: SlotNo -&gt; Word64 -&gt; CertificatePublicationTime
</span><a href="Cardano.Wallet.Primitive.Types.html#CertificatePublicationTime"><span class="hs-identifier hs-type">CertificatePublicationTime</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">SlotNo
slotNo :: SlotNo
$sel:slotNo:CertificatePublicationTime :: SlotNo
</span><a href="#local-6989586621682488792"><span class="hs-identifier hs-var hs-var">slotNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64
slotInternalIndex :: Word64
$sel:slotInternalIndex:CertificatePublicationTime :: Word64
</span><a href="#local-6989586621682488791"><span class="hs-identifier hs-var hs-var">slotInternalIndex</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-624"></span><span>                </span><span class="annot"><span class="annottext">(CertificatePublicationTime, PoolRegistrationCertificate)
-&gt; ReaderT
     backend m (CertificatePublicationTime, PoolRegistrationCertificate)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CertificatePublicationTime
</span><a href="#local-6989586621682488775"><span class="hs-identifier hs-var">cpt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PoolRegistrationCertificate
</span><a href="#local-6989586621682488777"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-625"></span><span>
</span><span id="line-626"></span><span>        </span><span id="local-6989586621682489041"><span class="annot"><span class="annottext">readPoolRetirement :: PoolId
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate))
</span><a href="#local-6989586621682489041"><span class="hs-identifier hs-var hs-var">readPoolRetirement</span></a></span></span><span> </span><span id="local-6989586621682488774"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488774"><span class="hs-identifier hs-var">poolId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-627"></span><span>            </span><span id="local-6989586621682488773"><span class="annot"><span class="annottext">Maybe (Entity PoolRetirement)
</span><a href="#local-6989586621682488773"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Filter PoolRetirement]
-&gt; [SelectOpt PoolRetirement]
-&gt; ReaderT backend m (Maybe (Entity PoolRetirement))
forall backend (m :: * -&gt; *) record.
(PersistQueryRead backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m (Maybe (Entity record))
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectFirst</span></a></span><span>
</span><span id="line-628"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolRetirement PoolId
forall typ. (typ ~ PoolId) =&gt; EntityField PoolRetirement typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRetirementPoolId"><span class="hs-identifier hs-var">PoolRetirementPoolId</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRetirement PoolId
-&gt; PoolId -&gt; Filter PoolRetirement
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">==.</span></a></span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488774"><span class="hs-identifier hs-var">poolId</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-629"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolRetirement SlotNo -&gt; SelectOpt PoolRetirement
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Desc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRetirement SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField PoolRetirement typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRetirementSlot"><span class="hs-identifier hs-var">PoolRetirementSlot</span></a></span><span>
</span><span id="line-630"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField PoolRetirement Word64 -&gt; SelectOpt PoolRetirement
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Desc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolRetirement Word64
forall typ. (typ ~ Word64) =&gt; EntityField PoolRetirement typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRetirementSlotInternalIndex"><span class="hs-identifier hs-var">PoolRetirementSlotInternalIndex</span></a></span><span>
</span><span id="line-631"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-632"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Entity PoolRetirement)
-&gt; (Entity PoolRetirement
    -&gt; ReaderT
         backend m (CertificatePublicationTime, PoolRetirementCertificate))
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Entity PoolRetirement)
</span><a href="#local-6989586621682488773"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="annot"><span class="annottext">((Entity PoolRetirement
  -&gt; ReaderT
       backend m (CertificatePublicationTime, PoolRetirementCertificate))
 -&gt; ReaderT
      backend
      m
      (Maybe (CertificatePublicationTime, PoolRetirementCertificate)))
-&gt; (Entity PoolRetirement
    -&gt; ReaderT
         backend m (CertificatePublicationTime, PoolRetirementCertificate))
-&gt; ReaderT
     backend
     m
     (Maybe (CertificatePublicationTime, PoolRetirementCertificate))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682488771"><span class="annot"><span class="annottext">Entity PoolRetirement
</span><a href="#local-6989586621682488771"><span class="hs-identifier hs-var">meta</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-633"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolRetirement"><span class="hs-identifier hs-type">PoolRetirement</span></a></span><span>
</span><span id="line-634"></span><span>                        </span><span id="local-6989586621682488770"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488770"><span class="hs-identifier hs-var">_poolId</span></a></span></span><span>
</span><span id="line-635"></span><span>                        </span><span id="local-6989586621682488769"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488769"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span>
</span><span id="line-636"></span><span>                        </span><span id="local-6989586621682488768"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488768"><span class="hs-identifier hs-var">slotInternalIndex</span></a></span></span><span>
</span><span id="line-637"></span><span>                        </span><span id="local-6989586621682488767"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488767"><span class="hs-identifier hs-var">retirementEpochNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Entity PoolRetirement -&gt; PoolRetirement
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">Entity PoolRetirement
</span><a href="#local-6989586621682488771"><span class="hs-identifier hs-var">meta</span></a></span><span>
</span><span id="line-638"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488766"><span class="annot"><span class="annottext">retirementEpoch :: EpochNo
</span><a href="#local-6989586621682488766"><span class="hs-identifier hs-var hs-var">retirementEpoch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word31 -&gt; EpochNo
</span><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-var">EpochNo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Word31
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488767"><span class="hs-identifier hs-var">retirementEpochNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-639"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488765"><span class="annot"><span class="annottext">cert :: PoolRetirementCertificate
</span><a href="#local-6989586621682488765"><span class="hs-identifier hs-var hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolRetirementCertificate :: PoolId -&gt; EpochNo -&gt; PoolRetirementCertificate
</span><a href="Cardano.Wallet.Primitive.Types.html#PoolRetirementCertificate"><span class="hs-identifier hs-type">PoolRetirementCertificate</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">PoolId
$sel:poolId:PoolRetirementCertificate :: PoolId
poolId :: PoolId
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3ApoolId%3APoolRetirementCertificate"><span class="hs-identifier hs-var hs-var">poolId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EpochNo
$sel:retirementEpoch:PoolRetirementCertificate :: EpochNo
retirementEpoch :: EpochNo
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AretirementEpoch%3APoolRetirementCertificate"><span class="hs-identifier hs-var hs-var">retirementEpoch</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-640"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488762"><span class="annot"><span class="annottext">cpt :: CertificatePublicationTime
</span><a href="#local-6989586621682488762"><span class="hs-identifier hs-var hs-var">cpt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CertificatePublicationTime :: SlotNo -&gt; Word64 -&gt; CertificatePublicationTime
</span><a href="Cardano.Wallet.Primitive.Types.html#CertificatePublicationTime"><span class="hs-identifier hs-type">CertificatePublicationTime</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">SlotNo
slotNo :: SlotNo
$sel:slotNo:CertificatePublicationTime :: SlotNo
</span><a href="#local-6989586621682488769"><span class="hs-identifier hs-var hs-var">slotNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64
slotInternalIndex :: Word64
$sel:slotInternalIndex:CertificatePublicationTime :: Word64
</span><a href="#local-6989586621682488768"><span class="hs-identifier hs-var hs-var">slotInternalIndex</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-641"></span><span>                </span><span class="annot"><span class="annottext">(CertificatePublicationTime, PoolRetirementCertificate)
-&gt; ReaderT
     backend m (CertificatePublicationTime, PoolRetirementCertificate)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CertificatePublicationTime
</span><a href="#local-6989586621682488762"><span class="hs-identifier hs-var">cpt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PoolRetirementCertificate
</span><a href="#local-6989586621682488765"><span class="hs-identifier hs-var">cert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-642"></span><span>
</span><span id="line-643"></span><span>        </span><span id="local-6989586621682489040"><span class="annot"><span class="annottext">putHeader :: BlockHeader -&gt; ReaderT backend m ()
</span><a href="#local-6989586621682489040"><span class="hs-identifier hs-var hs-var">putHeader</span></a></span></span><span> </span><span id="local-6989586621682488761"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488761"><span class="hs-identifier hs-var">point</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-644"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682488760"><span class="annot"><span class="annottext">record :: BlockHeader
</span><a href="#local-6989586621682488760"><span class="hs-identifier hs-var hs-var">record</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHeader
</span><a href="Cardano.Pool.DB.Sqlite.html#mkBlockHeader"><span class="hs-identifier hs-var">mkBlockHeader</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488761"><span class="hs-identifier hs-var">point</span></a></span><span>
</span><span id="line-645"></span><span>                </span><span id="local-6989586621682488758"><span class="annot"><span class="annottext">key :: Word32
</span><a href="#local-6989586621682488758"><span class="hs-identifier hs-var hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; Word32
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#blockHeight"><span class="hs-identifier hs-var hs-var">TH.blockHeight</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488760"><span class="hs-identifier hs-var">record</span></a></span><span>
</span><span id="line-646"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Key BlockHeader -&gt; BlockHeader -&gt; ReaderT backend m ()
forall backend record (m :: * -&gt; *).
(PersistStoreWrite backend, MonadIO m,
 PersistRecordBackend record backend) =&gt;
Key record -&gt; record -&gt; ReaderT backend m ()
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">repsert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Key BlockHeader
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#BlockHeaderKey"><span class="hs-identifier hs-var">BlockHeaderKey</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682488758"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488760"><span class="hs-identifier hs-var">record</span></a></span><span>
</span><span id="line-647"></span><span>
</span><span id="line-648"></span><span>        </span><span id="local-6989586621682489039"><span class="annot"><span class="annottext">listHeaders :: Int -&gt; ReaderT backend m [BlockHeader]
</span><a href="#local-6989586621682489039"><span class="hs-identifier hs-var hs-var">listHeaders</span></a></span></span><span> </span><span id="local-6989586621682488756"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682488756"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-649"></span><span>            </span><span class="annot"><span class="annottext">[BlockHeader] -&gt; [BlockHeader]
forall a. [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockHeader] -&gt; [BlockHeader])
-&gt; ([Entity BlockHeader] -&gt; [BlockHeader])
-&gt; [Entity BlockHeader]
-&gt; [BlockHeader]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Entity BlockHeader -&gt; BlockHeader)
-&gt; [Entity BlockHeader] -&gt; [BlockHeader]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHeader
</span><a href="Cardano.Pool.DB.Sqlite.html#fromBlockHeaders"><span class="hs-identifier hs-var">fromBlockHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; BlockHeader)
-&gt; (Entity BlockHeader -&gt; BlockHeader)
-&gt; Entity BlockHeader
-&gt; BlockHeader
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entity BlockHeader -&gt; BlockHeader
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Entity BlockHeader] -&gt; [BlockHeader])
-&gt; ReaderT backend m [Entity BlockHeader]
-&gt; ReaderT backend m [BlockHeader]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter BlockHeader]
-&gt; [SelectOpt BlockHeader]
-&gt; ReaderT backend m [Entity BlockHeader]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-650"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField BlockHeader Word32 -&gt; SelectOpt BlockHeader
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Desc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField BlockHeader Word32
forall typ. (typ ~ Word32) =&gt; EntityField BlockHeader typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#BlockHeight"><span class="hs-identifier hs-var">BlockHeight</span></a></span><span>
</span><span id="line-651"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SelectOpt BlockHeader
forall record. Int -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">LimitTo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682488756"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-652"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-653"></span><span>
</span><span id="line-654"></span><span class="hs-comment">-- | Defines a raw SQL query, runnable with 'runRawQuery'.</span><span>
</span><span id="line-655"></span><span class="hs-comment">--</span><span>
</span><span id="line-656"></span><span class="hs-keyword">data</span><span> </span><span id="RawQuery"><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#RawQuery"><span class="hs-identifier hs-var">RawQuery</span></a></span></span><span> </span><span id="local-6989586621682489340"><span class="annot"><a href="#local-6989586621682489340"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621682489339"><span class="annot"><a href="#local-6989586621682489339"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RawQuery"><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#RawQuery"><span class="hs-identifier hs-var">RawQuery</span></a></span></span><span>
</span><span id="line-657"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AqueryName%3ARawQuery"><span class="annot"><span class="annottext">RawQuery a b -&gt; Text
</span><a href="Cardano.Pool.DB.Sqlite.html#%24sel%3AqueryName%3ARawQuery"><span class="hs-identifier hs-var hs-var">queryName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">Text</span></a></span><span>
</span><span id="line-658"></span><span>      </span><span class="hs-comment">-- ^ The name of the query.</span><span>
</span><span id="line-659"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AqueryDefinition%3ARawQuery"><span class="annot"><span class="annottext">RawQuery a b -&gt; Text
</span><a href="Cardano.Pool.DB.Sqlite.html#%24sel%3AqueryDefinition%3ARawQuery"><span class="hs-identifier hs-var hs-var">queryDefinition</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">Text</span></a></span><span>
</span><span id="line-660"></span><span>      </span><span class="hs-comment">-- ^ The SQL definition of the query.</span><span>
</span><span id="line-661"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AqueryParameters%3ARawQuery"><span class="annot"><span class="annottext">RawQuery a b -&gt; [PersistValue]
</span><a href="Cardano.Pool.DB.Sqlite.html#%24sel%3AqueryParameters%3ARawQuery"><span class="hs-identifier hs-var hs-var">queryParameters</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">PersistValue</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-662"></span><span>      </span><span class="hs-comment">-- ^ Parameters of the query.</span><span>
</span><span id="line-663"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AqueryParser%3ARawQuery"><span class="annot"><span class="annottext">RawQuery a b -&gt; a -&gt; Either Text b
</span><a href="Cardano.Pool.DB.Sqlite.html#%24sel%3AqueryParser%3ARawQuery"><span class="hs-identifier hs-var hs-var">queryParser</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621682489340"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489339"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-664"></span><span>      </span><span class="hs-comment">-- ^ A parser for a row of the result.</span><span>
</span><span id="line-665"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-666"></span><span>
</span><span id="line-667"></span><span class="hs-comment">-- | Runs a raw SQL query, logging any parse failures that occur.</span><span>
</span><span id="line-668"></span><span class="hs-comment">--</span><span>
</span><span id="line-669"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#runRawQuery"><span class="hs-identifier hs-type">runRawQuery</span></a></span><span>
</span><span id="line-670"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621682489344"><span class="annot"><a href="#local-6989586621682489344"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621682489342"><span class="annot"><a href="#local-6989586621682489342"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">RawSql</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489344"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-671"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-type">Tracer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Log.html#PoolDbLog"><span class="hs-identifier hs-type">PoolDbLog</span></a></span><span>
</span><span id="line-672"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#RawQuery"><span class="hs-identifier hs-type">RawQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489344"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489342"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-673"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621682489342"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-674"></span><span id="runRawQuery"><span class="annot"><span class="annottext">runRawQuery :: Tracer IO PoolDbLog -&gt; RawQuery a b -&gt; SqlPersistT IO [b]
</span><a href="Cardano.Pool.DB.Sqlite.html#runRawQuery"><span class="hs-identifier hs-var hs-var">runRawQuery</span></a></span></span><span> </span><span id="local-6989586621682488749"><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682488749"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621682488748"><span class="annot"><span class="annottext">RawQuery a b
</span><a href="#local-6989586621682488748"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-675"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682488747"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621682488747"><span class="hs-identifier hs-var">failures</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682488746"><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621682488746"><span class="hs-identifier hs-var">results</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Either Text b] -&gt; ([Text], [b])
forall a b. [Either a b] -&gt; ([a], [b])
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">partitionEithers</span></a></span><span> </span><span class="annot"><span class="annottext">([Either Text b] -&gt; ([Text], [b]))
-&gt; ([a] -&gt; [Either Text b]) -&gt; [a] -&gt; ([Text], [b])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Either Text b) -&gt; [a] -&gt; [Either Text b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RawQuery a b -&gt; a -&gt; Either Text b
forall a b. RawQuery a b -&gt; a -&gt; Either Text b
</span><a href="Cardano.Pool.DB.Sqlite.html#%24sel%3AqueryParser%3ARawQuery"><span class="hs-identifier hs-var hs-var">queryParser</span></a></span><span> </span><span class="annot"><span class="annottext">RawQuery a b
</span><a href="#local-6989586621682488748"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([a] -&gt; ([Text], [b]))
-&gt; ReaderT SqlBackend IO [a] -&gt; ReaderT SqlBackend IO ([Text], [b])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [PersistValue] -&gt; ReaderT SqlBackend IO [a]
forall a (m :: * -&gt; *) backend.
(RawSql a, MonadIO m, BackendCompatible SqlBackend backend) =&gt;
Text -&gt; [PersistValue] -&gt; ReaderT backend m [a]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">rawSql</span></a></span><span>
</span><span id="line-676"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RawQuery a b -&gt; Text
forall a b. RawQuery a b -&gt; Text
</span><a href="Cardano.Pool.DB.Sqlite.html#%24sel%3AqueryDefinition%3ARawQuery"><span class="hs-identifier hs-var hs-var">queryDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">RawQuery a b
</span><a href="#local-6989586621682488748"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RawQuery a b -&gt; [PersistValue]
forall a b. RawQuery a b -&gt; [PersistValue]
</span><a href="Cardano.Pool.DB.Sqlite.html#%24sel%3AqueryParameters%3ARawQuery"><span class="hs-identifier hs-var hs-var">queryParameters</span></a></span><span> </span><span class="annot"><span class="annottext">RawQuery a b
</span><a href="#local-6989586621682488748"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-678"></span><span>    </span><span class="annot"><span class="annottext">[Text]
-&gt; (Text -&gt; ReaderT SqlBackend IO ()) -&gt; ReaderT SqlBackend IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621682488747"><span class="hs-identifier hs-var">failures</span></a></span><span>
</span><span id="line-679"></span><span>        </span><span class="annot"><span class="annottext">((Text -&gt; ReaderT SqlBackend IO ()) -&gt; ReaderT SqlBackend IO ())
-&gt; (Text -&gt; ReaderT SqlBackend IO ()) -&gt; ReaderT SqlBackend IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; ReaderT SqlBackend IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span>
</span><span id="line-680"></span><span>        </span><span class="annot"><span class="annottext">(IO () -&gt; ReaderT SqlBackend IO ())
-&gt; (Text -&gt; IO ()) -&gt; Text -&gt; ReaderT SqlBackend IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog -&gt; PoolDbLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-var">traceWith</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682488749"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-681"></span><span>        </span><span class="annot"><span class="annottext">(PoolDbLog -&gt; IO ()) -&gt; (Text -&gt; PoolDbLog) -&gt; Text -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ParseFailure -&gt; PoolDbLog
</span><a href="Cardano.Pool.DB.Log.html#MsgParseFailure"><span class="hs-identifier hs-var">MsgParseFailure</span></a></span><span>
</span><span id="line-682"></span><span>        </span><span class="annot"><span class="annottext">(ParseFailure -&gt; PoolDbLog)
-&gt; (Text -&gt; ParseFailure) -&gt; Text -&gt; PoolDbLog
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; ParseFailure
</span><a href="Cardano.Pool.DB.Log.html#ParseFailure"><span class="hs-identifier hs-var">ParseFailure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RawQuery a b -&gt; Text
forall a b. RawQuery a b -&gt; Text
</span><a href="Cardano.Pool.DB.Sqlite.html#%24sel%3AqueryName%3ARawQuery"><span class="hs-identifier hs-var hs-var">queryName</span></a></span><span> </span><span class="annot"><span class="annottext">RawQuery a b
</span><a href="#local-6989586621682488748"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-683"></span><span>    </span><span class="annot"><span class="annottext">[b] -&gt; SqlPersistT IO [b]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621682488746"><span class="hs-identifier hs-var">results</span></a></span><span>
</span><span id="line-684"></span><span>
</span><span id="line-685"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#createViews"><span class="hs-identifier hs-type">createViews</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.DB.Sqlite.html#ManualMigration"><span class="hs-identifier hs-type">ManualMigration</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-686"></span><span id="createViews"><span class="annot"><span class="annottext">createViews :: [ManualMigration]
</span><a href="Cardano.Pool.DB.Sqlite.html#createViews"><span class="hs-identifier hs-var hs-var">createViews</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; ManualMigration
</span><a href="Cardano.DB.Sqlite.html#ManualMigration"><span class="hs-identifier hs-var">ManualMigration</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; ManualMigration)
-&gt; [Connection -&gt; IO ()] -&gt; [ManualMigration]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-687"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">DatabaseView -&gt; Connection -&gt; IO ()
</span><a href="Cardano.Pool.DB.Sqlite.html#createView"><span class="hs-identifier hs-var">createView</span></a></span><span> </span><span class="annot"><span class="annottext">DatabaseView
</span><a href="Cardano.Pool.DB.Sqlite.html#activePoolLifeCycleData"><span class="hs-identifier hs-var">activePoolLifeCycleData</span></a></span><span>
</span><span id="line-688"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DatabaseView -&gt; Connection -&gt; IO ()
</span><a href="Cardano.Pool.DB.Sqlite.html#createView"><span class="hs-identifier hs-var">createView</span></a></span><span> </span><span class="annot"><span class="annottext">DatabaseView
</span><a href="Cardano.Pool.DB.Sqlite.html#activePoolOwners"><span class="hs-identifier hs-var">activePoolOwners</span></a></span><span>
</span><span id="line-689"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DatabaseView -&gt; Connection -&gt; IO ()
</span><a href="Cardano.Pool.DB.Sqlite.html#createView"><span class="hs-identifier hs-var">createView</span></a></span><span> </span><span class="annot"><span class="annottext">DatabaseView
</span><a href="Cardano.Pool.DB.Sqlite.html#activePoolRegistrations"><span class="hs-identifier hs-var">activePoolRegistrations</span></a></span><span>
</span><span id="line-690"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DatabaseView -&gt; Connection -&gt; IO ()
</span><a href="Cardano.Pool.DB.Sqlite.html#createView"><span class="hs-identifier hs-var">createView</span></a></span><span> </span><span class="annot"><span class="annottext">DatabaseView
</span><a href="Cardano.Pool.DB.Sqlite.html#activePoolRetirements"><span class="hs-identifier hs-var">activePoolRetirements</span></a></span><span>
</span><span id="line-691"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-692"></span><span>
</span><span id="line-693"></span><span class="hs-comment">-- | Represents a database view.</span><span>
</span><span id="line-694"></span><span class="hs-comment">--</span><span>
</span><span id="line-695"></span><span class="hs-keyword">data</span><span> </span><span id="DatabaseView"><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#DatabaseView"><span class="hs-identifier hs-var">DatabaseView</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DatabaseView"><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#DatabaseView"><span class="hs-identifier hs-var">DatabaseView</span></a></span></span><span>
</span><span id="line-696"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AdatabaseViewName%3ADatabaseView"><span class="annot"><span class="annottext">DatabaseView -&gt; Text
</span><a href="Cardano.Pool.DB.Sqlite.html#%24sel%3AdatabaseViewName%3ADatabaseView"><span class="hs-identifier hs-var hs-var">databaseViewName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">Text</span></a></span><span>
</span><span id="line-697"></span><span>      </span><span class="hs-comment">-- ^ A name for the view.</span><span>
</span><span id="line-698"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AdatabaseViewDefinition%3ADatabaseView"><span class="annot"><span class="annottext">DatabaseView -&gt; Text
</span><a href="Cardano.Pool.DB.Sqlite.html#%24sel%3AdatabaseViewDefinition%3ADatabaseView"><span class="hs-identifier hs-var hs-var">databaseViewDefinition</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">Text</span></a></span><span>
</span><span id="line-699"></span><span>      </span><span class="hs-comment">-- ^ A select query to generate the view.</span><span>
</span><span id="line-700"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-701"></span><span>
</span><span id="line-702"></span><span class="hs-comment">-- | Creates the specified database view, if it does not already exist.</span><span>
</span><span id="line-703"></span><span class="hs-comment">--</span><span>
</span><span id="line-704"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#createView"><span class="hs-identifier hs-type">createView</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#DatabaseView"><span class="hs-identifier hs-type">DatabaseView</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent-sqlite/html/src"><span class="hs-identifier hs-type">Sqlite.Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-705"></span><span id="createView"><span class="annot"><span class="annottext">createView :: DatabaseView -&gt; Connection -&gt; IO ()
</span><a href="Cardano.Pool.DB.Sqlite.html#createView"><span class="hs-identifier hs-var hs-var">createView</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#DatabaseView"><span class="hs-identifier hs-type">DatabaseView</span></a></span><span> </span><span id="local-6989586621682488734"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488734"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621682488733"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488733"><span class="hs-identifier hs-var">definition</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682488732"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621682488732"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-706"></span><span>    </span><span id="local-6989586621682488731"><span class="annot"><span class="annottext">Statement
</span><a href="#local-6989586621682488731"><span class="hs-identifier hs-var">deleteQuery</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Text -&gt; IO Statement
</span><a href="../../../../persistent-sqlite/html/src"><span class="hs-identifier hs-var">Sqlite.prepare</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621682488732"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488729"><span class="hs-identifier hs-var">deleteQueryString</span></a></span><span>
</span><span id="line-707"></span><span>    </span><span class="annot"><span class="annottext">Statement -&gt; IO StepResult
</span><a href="../../../../persistent-sqlite/html/src"><span class="hs-identifier hs-var">Sqlite.step</span></a></span><span> </span><span class="annot"><span class="annottext">Statement
</span><a href="#local-6989586621682488731"><span class="hs-identifier hs-var">deleteQuery</span></a></span><span> </span><span class="annot"><span class="annottext">IO StepResult -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Statement -&gt; IO ()
</span><a href="../../../../persistent-sqlite/html/src"><span class="hs-identifier hs-var">Sqlite.finalize</span></a></span><span> </span><span class="annot"><span class="annottext">Statement
</span><a href="#local-6989586621682488731"><span class="hs-identifier hs-var">deleteQuery</span></a></span><span>
</span><span id="line-708"></span><span>    </span><span id="local-6989586621682488726"><span class="annot"><span class="annottext">Statement
</span><a href="#local-6989586621682488726"><span class="hs-identifier hs-var">createQuery</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Text -&gt; IO Statement
</span><a href="../../../../persistent-sqlite/html/src"><span class="hs-identifier hs-var">Sqlite.prepare</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621682488732"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488725"><span class="hs-identifier hs-var">createQueryString</span></a></span><span>
</span><span id="line-709"></span><span>    </span><span class="annot"><span class="annottext">Statement -&gt; IO StepResult
</span><a href="../../../../persistent-sqlite/html/src"><span class="hs-identifier hs-var">Sqlite.step</span></a></span><span> </span><span class="annot"><span class="annottext">Statement
</span><a href="#local-6989586621682488726"><span class="hs-identifier hs-var">createQuery</span></a></span><span> </span><span class="annot"><span class="annottext">IO StepResult -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Statement -&gt; IO ()
</span><a href="../../../../persistent-sqlite/html/src"><span class="hs-identifier hs-var">Sqlite.finalize</span></a></span><span> </span><span class="annot"><span class="annottext">Statement
</span><a href="#local-6989586621682488726"><span class="hs-identifier hs-var">createQuery</span></a></span><span>
</span><span id="line-710"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-711"></span><span>    </span><span id="local-6989586621682488729"><span class="annot"><span class="annottext">deleteQueryString :: Text
</span><a href="#local-6989586621682488729"><span class="hs-identifier hs-var hs-var">deleteQueryString</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">T.unlines</span></a></span><span>
</span><span id="line-712"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DROP VIEW IF EXISTS&quot;</span></span><span>
</span><span id="line-713"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488734"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-714"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;;&quot;</span></span><span>
</span><span id="line-715"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-716"></span><span>    </span><span id="local-6989586621682488725"><span class="annot"><span class="annottext">createQueryString :: Text
</span><a href="#local-6989586621682488725"><span class="hs-identifier hs-var hs-var">createQueryString</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">T.unlines</span></a></span><span>
</span><span id="line-717"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;CREATE VIEW&quot;</span></span><span>
</span><span id="line-718"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488734"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-719"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;AS&quot;</span></span><span>
</span><span id="line-720"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621682488733"><span class="hs-identifier hs-var">definition</span></a></span><span>
</span><span id="line-721"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-722"></span><span>
</span><span id="line-723"></span><span class="hs-comment">-- | Views active lifecycle data for every pool in the set of known pools.</span><span>
</span><span id="line-724"></span><span class="hs-comment">--</span><span>
</span><span id="line-725"></span><span class="hs-comment">-- This view has exactly ONE row for each known pool, where each row</span><span>
</span><span id="line-726"></span><span class="hs-comment">-- corresponds to the most-recently-seen registration certificate,</span><span>
</span><span id="line-727"></span><span class="hs-comment">-- retirement certificate, and set of owners for that pool.</span><span>
</span><span id="line-728"></span><span class="hs-comment">--</span><span>
</span><span id="line-729"></span><span class="hs-comment">-- This view does NOT exclude pools that have retired.</span><span>
</span><span id="line-730"></span><span class="hs-comment">--</span><span>
</span><span id="line-731"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#activePoolLifeCycleData"><span class="hs-identifier hs-type">activePoolLifeCycleData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#DatabaseView"><span class="hs-identifier hs-type">DatabaseView</span></a></span><span>
</span><span id="line-732"></span><span id="activePoolLifeCycleData"><span class="annot"><span class="annottext">activePoolLifeCycleData :: DatabaseView
</span><a href="Cardano.Pool.DB.Sqlite.html#activePoolLifeCycleData"><span class="hs-identifier hs-var hs-var">activePoolLifeCycleData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; DatabaseView
</span><a href="Cardano.Pool.DB.Sqlite.html#DatabaseView"><span class="hs-identifier hs-var">DatabaseView</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;active_pool_lifecycle_data&quot;</span></span><span> </span><span class="annot"><span class="">[i|
    SELECT
        active_pool_registrations.pool_id as pool_id,
        active_pool_retirements.retirement_epoch as retirement_epoch,
        active_pool_owners.pool_owners as pool_owners,
        cost,
        pledge,
        margin_numerator,
        margin_denominator,
        metadata_hash,
        metadata_url
    FROM
        active_pool_registrations
    LEFT JOIN
        active_pool_retirements
    ON active_pool_registrations.pool_id = active_pool_retirements.pool_id
    LEFT JOIN
        active_pool_owners
    ON active_pool_registrations.pool_id = active_pool_owners.pool_id;
|]</span></span><span>
</span><span id="line-752"></span><span>
</span><span id="line-753"></span><span class="hs-comment">-- | Views the set of active owners for all pools.</span><span>
</span><span id="line-754"></span><span class="hs-comment">--</span><span>
</span><span id="line-755"></span><span class="hs-comment">-- This view has exactly ONE row for each known pool, where each row</span><span>
</span><span id="line-756"></span><span class="hs-comment">-- corresponds to the most-recently-seen set of owners for that pool.</span><span>
</span><span id="line-757"></span><span class="hs-comment">--</span><span>
</span><span id="line-758"></span><span class="hs-comment">-- This view does NOT exclude pools that have retired.</span><span>
</span><span id="line-759"></span><span class="hs-comment">--</span><span>
</span><span id="line-760"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#activePoolOwners"><span class="hs-identifier hs-type">activePoolOwners</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#DatabaseView"><span class="hs-identifier hs-type">DatabaseView</span></a></span><span>
</span><span id="line-761"></span><span id="activePoolOwners"><span class="annot"><span class="annottext">activePoolOwners :: DatabaseView
</span><a href="Cardano.Pool.DB.Sqlite.html#activePoolOwners"><span class="hs-identifier hs-var hs-var">activePoolOwners</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; DatabaseView
</span><a href="Cardano.Pool.DB.Sqlite.html#DatabaseView"><span class="hs-identifier hs-var">DatabaseView</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;active_pool_owners&quot;</span></span><span> </span><span class="annot"><span class="">[i|
    SELECT pool_id, pool_owners FROM (
        SELECT row_number() OVER w AS r, *
        FROM (
            SELECT
                pool_id,
                slot,
                slot_internal_index,
                group_concat(pool_owner, ' ') as pool_owners
            FROM (
                SELECT * FROM pool_owner ORDER BY pool_owner_index
            )
            GROUP BY pool_id, slot, slot_internal_index
        )
        WINDOW w AS (ORDER BY pool_id, slot desc, slot_internal_index desc)
    )
    GROUP BY pool_id;
|]</span></span><span>
</span><span id="line-779"></span><span>
</span><span id="line-780"></span><span class="hs-comment">-- | Views the set of pool registrations that are currently active.</span><span>
</span><span id="line-781"></span><span class="hs-comment">--</span><span>
</span><span id="line-782"></span><span class="hs-comment">-- This view has exactly ONE row for each known pool, where each row</span><span>
</span><span id="line-783"></span><span class="hs-comment">-- corresponds to the most-recently-seen registration certificate for</span><span>
</span><span id="line-784"></span><span class="hs-comment">-- that pool.</span><span>
</span><span id="line-785"></span><span class="hs-comment">--</span><span>
</span><span id="line-786"></span><span class="hs-comment">-- This view does NOT exclude pools that have retired.</span><span>
</span><span id="line-787"></span><span class="hs-comment">--</span><span>
</span><span id="line-788"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#activePoolRegistrations"><span class="hs-identifier hs-type">activePoolRegistrations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#DatabaseView"><span class="hs-identifier hs-type">DatabaseView</span></a></span><span>
</span><span id="line-789"></span><span id="activePoolRegistrations"><span class="annot"><span class="annottext">activePoolRegistrations :: DatabaseView
</span><a href="Cardano.Pool.DB.Sqlite.html#activePoolRegistrations"><span class="hs-identifier hs-var hs-var">activePoolRegistrations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; DatabaseView
</span><a href="Cardano.Pool.DB.Sqlite.html#DatabaseView"><span class="hs-identifier hs-var">DatabaseView</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;active_pool_registrations&quot;</span></span><span> </span><span class="annot"><span class="">[i|
    SELECT
        pool_id,
        cost,
        pledge,
        margin_numerator,
        margin_denominator,
        metadata_hash,
        metadata_url
    FROM (
        SELECT row_number() OVER w AS r, *
        FROM pool_registration
        WINDOW w AS (ORDER BY pool_id, slot desc, slot_internal_index desc)
    )
    GROUP BY pool_id;
|]</span></span><span>
</span><span id="line-805"></span><span>
</span><span id="line-806"></span><span class="hs-comment">-- | Views the set of pool retirements that are currently active.</span><span>
</span><span id="line-807"></span><span class="hs-comment">--</span><span>
</span><span id="line-808"></span><span class="hs-comment">-- This view includes all pools for which there are published retirement</span><span>
</span><span id="line-809"></span><span class="hs-comment">-- certificates that have not been revoked or superseded.</span><span>
</span><span id="line-810"></span><span class="hs-comment">--</span><span>
</span><span id="line-811"></span><span class="hs-comment">-- This view does NOT include:</span><span>
</span><span id="line-812"></span><span class="hs-comment">--</span><span>
</span><span id="line-813"></span><span class="hs-comment">--    - pools for which there are no published retirement certificates.</span><span>
</span><span id="line-814"></span><span class="hs-comment">--</span><span>
</span><span id="line-815"></span><span class="hs-comment">--    - pools that have had their most-recently-published retirement</span><span>
</span><span id="line-816"></span><span class="hs-comment">--      certificates revoked by subsequent re-registration certificates.</span><span>
</span><span id="line-817"></span><span class="hs-comment">--</span><span>
</span><span id="line-818"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#activePoolRetirements"><span class="hs-identifier hs-type">activePoolRetirements</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#DatabaseView"><span class="hs-identifier hs-type">DatabaseView</span></a></span><span>
</span><span id="line-819"></span><span id="activePoolRetirements"><span class="annot"><span class="annottext">activePoolRetirements :: DatabaseView
</span><a href="Cardano.Pool.DB.Sqlite.html#activePoolRetirements"><span class="hs-identifier hs-var hs-var">activePoolRetirements</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; DatabaseView
</span><a href="Cardano.Pool.DB.Sqlite.html#DatabaseView"><span class="hs-identifier hs-var">DatabaseView</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;active_pool_retirements&quot;</span></span><span> </span><span class="annot"><span class="">[i|
    SELECT * FROM (
        SELECT
            pool_id,
            retirement_epoch
        FROM (
            SELECT row_number() OVER w AS r, *
            FROM (
                SELECT
                    pool_id, slot, slot_internal_index,
                    NULL as retirement_epoch
                    FROM pool_registration
                UNION
                SELECT
                    pool_id, slot, slot_internal_index,
                    epoch as retirement_epoch
                    FROM pool_retirement
            )
            WINDOW w AS (ORDER BY pool_id, slot desc, slot_internal_index desc)
        )
        GROUP BY pool_id
    )
    WHERE retirement_epoch IS NOT NULL;
|]</span></span><span>
</span><span id="line-843"></span><span>
</span><span id="line-844"></span><span class="hs-comment">-- | 'Temporary', catches migration error from previous versions and if any,</span><span>
</span><span id="line-845"></span><span class="hs-comment">-- _removes_ the database file completely before retrying to start the database.</span><span>
</span><span id="line-846"></span><span class="hs-comment">--</span><span>
</span><span id="line-847"></span><span class="hs-comment">-- This comes in handy to fix database schema in a non-backward compatible way</span><span>
</span><span id="line-848"></span><span class="hs-comment">-- without altering too much the user experience. Indeed, the pools' database</span><span>
</span><span id="line-849"></span><span class="hs-comment">-- can swiftly be re-synced from the chain, so instead of patching our mistakes</span><span>
</span><span id="line-850"></span><span class="hs-comment">-- with ugly work-around we can, at least for now, reset it semi-manually when</span><span>
</span><span id="line-851"></span><span class="hs-comment">-- needed to keep things tidy here.</span><span>
</span><span id="line-852"></span><span id="local-6989586621682489467"><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#handlingPersistError"><span class="hs-identifier hs-type">handlingPersistError</span></a></span><span>
</span><span id="line-853"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-type">Tracer</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Log.html#PoolDbLog"><span class="hs-identifier hs-type">PoolDbLog</span></a></span><span>
</span><span id="line-854"></span><span>       </span><span class="hs-comment">-- ^ Logging object</span><span>
</span><span id="line-855"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-856"></span><span>       </span><span class="hs-comment">-- ^ Database file location, or Nothing for in-memory database</span><span>
</span><span id="line-857"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489467"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-858"></span><span>       </span><span class="hs-comment">-- ^ Action to retry</span><span>
</span><span id="line-859"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682489467"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-860"></span><span id="handlingPersistError"><span class="annot"><span class="annottext">handlingPersistError :: Tracer IO PoolDbLog -&gt; FilePath -&gt; IO a -&gt; IO a
</span><a href="Cardano.Pool.DB.Sqlite.html#handlingPersistError"><span class="hs-identifier hs-var hs-var">handlingPersistError</span></a></span></span><span> </span><span id="local-6989586621682488719"><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682488719"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621682488718"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682488718"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span id="local-6989586621682488717"><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621682488717"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-861"></span><span>    </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621682488717"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; (MigrationError -&gt; IO a) -&gt; IO a
forall (m :: * -&gt; *) e a.
(MonadUnliftIO m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../../../../unliftio/html/src"><span class="hs-operator hs-var">`catch`</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621682488716"><span class="annot"><span class="annottext">MigrationError
</span><a href="#local-6989586621682488716"><span class="hs-identifier hs-var">_e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.DB.Sqlite.html#MigrationError"><span class="hs-identifier hs-type">MigrationError</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-862"></span><span>        </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog -&gt; PoolDbLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-var">traceWith</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO PoolDbLog
</span><a href="#local-6989586621682488719"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolDbLog -&gt; IO ()) -&gt; PoolDbLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DBLog -&gt; PoolDbLog
</span><a href="Cardano.Pool.DB.Log.html#MsgGeneric"><span class="hs-identifier hs-var">MsgGeneric</span></a></span><span> </span><span class="annot"><span class="annottext">DBLog
</span><a href="Cardano.DB.Sqlite.html#MsgDatabaseReset"><span class="hs-identifier hs-var">MsgDatabaseReset</span></a></span><span>
</span><span id="line-863"></span><span>        </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="../../../../directory/html/src"><span class="hs-identifier hs-var">removeFile</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682488718"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-864"></span><span>        </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621682488717"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-865"></span><span>
</span><span id="line-866"></span><span class="hs-comment">-- | Compute a new date from a base date, with an increasing delay.</span><span>
</span><span id="line-867"></span><span class="hs-comment">--</span><span>
</span><span id="line-868"></span><span class="hs-comment">-- &gt; backoff t 0</span><span>
</span><span id="line-869"></span><span class="hs-comment">-- t+3s</span><span>
</span><span id="line-870"></span><span class="hs-comment">--</span><span>
</span><span id="line-871"></span><span class="hs-comment">-- &gt; backoff t 1</span><span>
</span><span id="line-872"></span><span class="hs-comment">-- t+9s</span><span>
</span><span id="line-873"></span><span class="hs-comment">--</span><span>
</span><span id="line-874"></span><span class="hs-comment">-- &gt; backoff t 2</span><span>
</span><span id="line-875"></span><span class="hs-comment">-- t+27s</span><span>
</span><span id="line-876"></span><span class="hs-comment">--</span><span>
</span><span id="line-877"></span><span class="hs-comment">-- ...</span><span>
</span><span id="line-878"></span><span class="hs-comment">--</span><span>
</span><span id="line-879"></span><span class="hs-comment">-- &gt; backoff t 9</span><span>
</span><span id="line-880"></span><span class="hs-comment">-- t+16h</span><span>
</span><span id="line-881"></span><span class="hs-comment">--</span><span>
</span><span id="line-882"></span><span class="hs-comment">-- &gt; backoff t 10</span><span>
</span><span id="line-883"></span><span class="hs-comment">-- t+49h</span><span>
</span><span id="line-884"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#backoff"><span class="hs-identifier hs-type">backoff</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../time/html/src"><span class="hs-identifier hs-type">UTCTime</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../time/html/src"><span class="hs-identifier hs-type">UTCTime</span></a></span><span>
</span><span id="line-885"></span><span id="backoff"><span class="annot"><span class="annottext">backoff :: UTCTime -&gt; Word8 -&gt; UTCTime
</span><a href="Cardano.Pool.DB.Sqlite.html#backoff"><span class="hs-identifier hs-var hs-var">backoff</span></a></span></span><span> </span><span id="local-6989586621682488714"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621682488714"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span id="local-6989586621682488713"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621682488713"><span class="hs-identifier hs-var">iter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; UTCTime -&gt; UTCTime
</span><a href="../../../../time/html/src"><span class="hs-identifier hs-var">addUTCTime</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621682488712"><span class="hs-identifier hs-var">delay</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621682488714"><span class="hs-identifier hs-var">time</span></a></span><span>
</span><span id="line-886"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-887"></span><span>    </span><span id="local-6989586621682488712"><span class="annot"><span class="annottext">delay :: POSIXTime
</span><a href="#local-6989586621682488712"><span class="hs-identifier hs-var hs-var">delay</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b. (Integral Integer, Num b) =&gt; Integer -&gt; b
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; POSIXTime) -&gt; Integer -&gt; POSIXTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Integer -&gt; Integer) -&gt; Integer -&gt; [Integer] -&gt; Integer
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">(*)</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Integer -&gt; [Integer]
forall a. Int -&gt; a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">replicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621682488713"><span class="hs-identifier hs-var">iter</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">3</span></span><span class="hs-special">)</span><span>
</span><span id="line-888"></span><span>
</span><span id="line-889"></span><span class="hs-comment">{-------------------------------------------------------------------------------
                                   Queries
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-892"></span><span>
</span><span id="line-893"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#selectPoolProduction"><span class="hs-identifier hs-type">selectPoolProduction</span></a></span><span>
</span><span id="line-894"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Slotting.html#TimeInterpreter"><span class="hs-identifier hs-type">TimeInterpreter</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-895"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a></span><span>
</span><span id="line-896"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../persistent/html/src"><span class="hs-identifier hs-type">SqlPersistT</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolProduction"><span class="hs-identifier hs-type">PoolProduction</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-897"></span><span id="selectPoolProduction"><span class="annot"><span class="annottext">selectPoolProduction :: TimeInterpreter IO
-&gt; EpochNo -&gt; ReaderT SqlBackend IO [PoolProduction]
</span><a href="Cardano.Pool.DB.Sqlite.html#selectPoolProduction"><span class="hs-identifier hs-var hs-var">selectPoolProduction</span></a></span></span><span> </span><span id="local-6989586621682488708"><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682488708"><span class="hs-identifier hs-var">ti</span></a></span></span><span> </span><span id="local-6989586621682488707"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682488707"><span class="hs-identifier hs-var">epoch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-898"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682488706"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488706"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682488705"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488705"><span class="hs-identifier hs-var">eplus1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (SlotNo, SlotNo) -&gt; ReaderT SqlBackend IO (SlotNo, SlotNo)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (SlotNo, SlotNo) -&gt; ReaderT SqlBackend IO (SlotNo, SlotNo))
-&gt; IO (SlotNo, SlotNo) -&gt; ReaderT SqlBackend IO (SlotNo, SlotNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO -&gt; Qry (SlotNo, SlotNo) -&gt; IO (SlotNo, SlotNo)
forall (m :: * -&gt; *) a.
(HasCallStack, Monad m) =&gt;
TimeInterpreter m -&gt; Qry a -&gt; m a
</span><a href="Cardano.Wallet.Primitive.Slotting.html#interpretQuery"><span class="hs-identifier hs-var">interpretQuery</span></a></span><span> </span><span class="annot"><span class="annottext">TimeInterpreter IO
</span><a href="#local-6989586621682488708"><span class="hs-identifier hs-var">ti</span></a></span><span>
</span><span id="line-899"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; SlotNo -&gt; (SlotNo, SlotNo))
-&gt; Qry SlotNo -&gt; Qry (SlotNo -&gt; (SlotNo, SlotNo))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; Qry SlotNo
</span><a href="Cardano.Wallet.Primitive.Slotting.html#firstSlotInEpoch"><span class="hs-identifier hs-var">firstSlotInEpoch</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682488707"><span class="hs-identifier hs-var">epoch</span></a></span><span> </span><span class="annot"><span class="annottext">Qry (SlotNo -&gt; (SlotNo, SlotNo))
-&gt; Qry SlotNo -&gt; Qry (SlotNo, SlotNo)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; Qry SlotNo
</span><a href="Cardano.Wallet.Primitive.Slotting.html#firstSlotInEpoch"><span class="hs-identifier hs-var">firstSlotInEpoch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621682488707"><span class="hs-identifier hs-var">epoch</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; EpochNo -&gt; EpochNo
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-900"></span><span>    </span><span class="annot"><span class="annottext">(Entity PoolProduction -&gt; PoolProduction)
-&gt; [Entity PoolProduction] -&gt; [PoolProduction]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Entity PoolProduction -&gt; PoolProduction
forall record. Entity record -&gt; record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var hs-var">entityVal</span></a></span><span> </span><span class="annot"><span class="annottext">([Entity PoolProduction] -&gt; [PoolProduction])
-&gt; ReaderT SqlBackend IO [Entity PoolProduction]
-&gt; ReaderT SqlBackend IO [PoolProduction]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Filter PoolProduction]
-&gt; [SelectOpt PoolProduction]
-&gt; ReaderT SqlBackend IO [Entity PoolProduction]
forall record backend (m :: * -&gt; *).
(MonadIO m, PersistQueryRead backend,
 PersistRecordBackend record backend) =&gt;
[Filter record]
-&gt; [SelectOpt record] -&gt; ReaderT backend m [Entity record]
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-901"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntityField PoolProduction SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField PoolProduction typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolProductionSlot"><span class="hs-identifier hs-var">PoolProductionSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolProduction SlotNo
-&gt; SlotNo -&gt; Filter PoolProduction
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">&gt;=.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488706"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-902"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityField PoolProduction SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField PoolProduction typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolProductionSlot"><span class="hs-identifier hs-var">PoolProductionSlot</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolProduction SlotNo
-&gt; SlotNo -&gt; Filter PoolProduction
forall v typ.
PersistField typ =&gt;
EntityField v typ -&gt; typ -&gt; Filter v
</span><a href="../../../../persistent/html/src"><span class="hs-operator hs-var">&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488705"><span class="hs-identifier hs-var">eplus1</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-903"></span><span>        </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntityField PoolProduction SlotNo -&gt; SelectOpt PoolProduction
forall record typ. EntityField record typ -&gt; SelectOpt record
</span><a href="../../../../persistent/html/src"><span class="hs-identifier hs-var">Asc</span></a></span><span> </span><span class="annot"><span class="annottext">EntityField PoolProduction SlotNo
forall typ. (typ ~ SlotNo) =&gt; EntityField PoolProduction typ
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolProductionSlot"><span class="hs-identifier hs-var">PoolProductionSlot</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-904"></span><span>
</span><span id="line-905"></span><span class="hs-comment">{-------------------------------------------------------------------------------
                              To / From SQLite
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-908"></span><span>
</span><span id="line-909"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#mkPoolProduction"><span class="hs-identifier hs-type">mkPoolProduction</span></a></span><span>
</span><span id="line-910"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span>
</span><span id="line-911"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-912"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolProduction"><span class="hs-identifier hs-type">PoolProduction</span></a></span><span>
</span><span id="line-913"></span><span id="mkPoolProduction"><span class="annot"><span class="annottext">mkPoolProduction :: PoolId -&gt; BlockHeader -&gt; PoolProduction
</span><a href="Cardano.Pool.DB.Sqlite.html#mkPoolProduction"><span class="hs-identifier hs-var hs-var">mkPoolProduction</span></a></span></span><span> </span><span id="local-6989586621682488704"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488704"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span id="local-6989586621682488703"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488703"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolProduction :: PoolId -&gt; SlotNo -&gt; BlockId -&gt; BlockId -&gt; Word32 -&gt; PoolProduction
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolProduction"><span class="hs-identifier hs-type">PoolProduction</span></a></span><span>
</span><span id="line-914"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">poolProductionPoolId :: PoolId
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#poolProductionPoolId"><span class="hs-identifier hs-var">poolProductionPoolId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488704"><span class="hs-identifier hs-var">pool</span></a></span><span>
</span><span id="line-915"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">poolProductionSlot :: SlotNo
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#poolProductionSlot"><span class="hs-identifier hs-var">poolProductionSlot</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((SlotNo -&gt; Const SlotNo SlotNo)
 -&gt; BlockHeader -&gt; Const SlotNo BlockHeader)
-&gt; BlockHeader -&gt; SlotNo
forall a s. ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; s -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;slotNo&quot;
  ((SlotNo -&gt; Const SlotNo SlotNo)
   -&gt; BlockHeader -&gt; Const SlotNo BlockHeader)
(SlotNo -&gt; Const SlotNo SlotNo)
-&gt; BlockHeader -&gt; Const SlotNo BlockHeader
</span><a href="#local-6989586621682488699"><span class="hs-var">#slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488703"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-916"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">poolProductionHeaderHash :: BlockId
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#poolProductionHeaderHash"><span class="hs-identifier hs-var">poolProductionHeaderHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash &quot;BlockHeader&quot; -&gt; BlockId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#BlockId"><span class="hs-identifier hs-var">BlockId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; Hash &quot;BlockHeader&quot;
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AheaderHash%3ABlockHeader"><span class="hs-identifier hs-var hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488703"><span class="hs-identifier hs-var">block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-917"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">poolProductionParentHash :: BlockId
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#poolProductionParentHash"><span class="hs-identifier hs-var">poolProductionParentHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Hash &quot;BlockHeader&quot;) -&gt; BlockId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#fromMaybeHash"><span class="hs-identifier hs-var">fromMaybeHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; Maybe (Hash &quot;BlockHeader&quot;)
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AparentHeaderHash%3ABlockHeader"><span class="hs-identifier hs-var hs-var">parentHeaderHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488703"><span class="hs-identifier hs-var">block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-918"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">poolProductionBlockHeight :: Word32
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#poolProductionBlockHeight"><span class="hs-identifier hs-var">poolProductionBlockHeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Quantity &quot;block&quot; Word32 -&gt; Word32
forall (unit :: Symbol) a. Quantity unit a -&gt; a
</span><a href="Data.Quantity.html#getQuantity"><span class="hs-identifier hs-var hs-var">getQuantity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; Quantity &quot;block&quot; Word32
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AblockHeight%3ABlockHeader"><span class="hs-identifier hs-var hs-var">blockHeight</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488703"><span class="hs-identifier hs-var">block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-919"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-920"></span><span>
</span><span id="line-921"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#fromPoolProduction"><span class="hs-identifier hs-type">fromPoolProduction</span></a></span><span>
</span><span id="line-922"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolProduction"><span class="hs-identifier hs-type">PoolProduction</span></a></span><span>
</span><span id="line-923"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-924"></span><span id="fromPoolProduction"><span class="annot"><span class="annottext">fromPoolProduction :: PoolProduction -&gt; (PoolId, BlockHeader)
</span><a href="Cardano.Pool.DB.Sqlite.html#fromPoolProduction"><span class="hs-identifier hs-var hs-var">fromPoolProduction</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolProduction"><span class="hs-identifier hs-type">PoolProduction</span></a></span><span> </span><span id="local-6989586621682488690"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488690"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span id="local-6989586621682488689"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488689"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span id="local-6989586621682488688"><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682488688"><span class="hs-identifier hs-var">headerH</span></a></span></span><span> </span><span id="local-6989586621682488687"><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682488687"><span class="hs-identifier hs-var">parentH</span></a></span></span><span> </span><span id="local-6989586621682488686"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682488686"><span class="hs-identifier hs-var">height</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-925"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488690"><span class="hs-identifier hs-var">pool</span></a></span><span>
</span><span id="line-926"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockHeader :: SlotNo
-&gt; Quantity &quot;block&quot; Word32
-&gt; Hash &quot;BlockHeader&quot;
-&gt; Maybe (Hash &quot;BlockHeader&quot;)
-&gt; BlockHeader
</span><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-927"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:slotNo:BlockHeader :: SlotNo
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AslotNo%3ABlockHeader"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488689"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-928"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:blockHeight:BlockHeader :: Quantity &quot;block&quot; Word32
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AblockHeight%3ABlockHeader"><span class="hs-identifier hs-var">blockHeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Quantity &quot;block&quot; Word32
forall (unit :: Symbol) a. a -&gt; Quantity unit a
</span><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-var">Quantity</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682488686"><span class="hs-identifier hs-var">height</span></a></span><span>
</span><span id="line-929"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:headerHash:BlockHeader :: Hash &quot;BlockHeader&quot;
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AheaderHash%3ABlockHeader"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockId -&gt; Hash &quot;BlockHeader&quot;
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#getBlockId"><span class="hs-identifier hs-var hs-var">getBlockId</span></a></span><span> </span><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682488688"><span class="hs-identifier hs-var">headerH</span></a></span><span>
</span><span id="line-930"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:parentHeaderHash:BlockHeader :: Maybe (Hash &quot;BlockHeader&quot;)
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AparentHeaderHash%3ABlockHeader"><span class="hs-identifier hs-var">parentHeaderHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockId -&gt; Maybe (Hash &quot;BlockHeader&quot;)
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#toMaybeHash"><span class="hs-identifier hs-var">toMaybeHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682488687"><span class="hs-identifier hs-var">parentH</span></a></span><span>
</span><span id="line-931"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-932"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-933"></span><span>
</span><span id="line-934"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#mkBlockHeader"><span class="hs-identifier hs-type">mkBlockHeader</span></a></span><span>
</span><span id="line-935"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-936"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#BlockHeader"><span class="hs-identifier hs-type">TH.BlockHeader</span></a></span><span>
</span><span id="line-937"></span><span id="mkBlockHeader"><span class="annot"><span class="annottext">mkBlockHeader :: BlockHeader -&gt; BlockHeader
</span><a href="Cardano.Pool.DB.Sqlite.html#mkBlockHeader"><span class="hs-identifier hs-var hs-var">mkBlockHeader</span></a></span></span><span> </span><span id="local-6989586621682488682"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488682"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader :: SlotNo -&gt; BlockId -&gt; BlockId -&gt; Word32 -&gt; BlockHeader
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#BlockHeader"><span class="hs-identifier hs-type">TH.BlockHeader</span></a></span><span>
</span><span id="line-938"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">blockSlot :: SlotNo
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#blockSlot"><span class="hs-identifier hs-var">blockSlot</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((SlotNo -&gt; Const SlotNo SlotNo)
 -&gt; BlockHeader -&gt; Const SlotNo BlockHeader)
-&gt; BlockHeader -&gt; SlotNo
forall a s. ((a -&gt; Const a a) -&gt; s -&gt; Const a s) -&gt; s -&gt; a
</span><a href="../../../../generic-lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel
  &quot;slotNo&quot;
  ((SlotNo -&gt; Const SlotNo SlotNo)
   -&gt; BlockHeader -&gt; Const SlotNo BlockHeader)
(SlotNo -&gt; Const SlotNo SlotNo)
-&gt; BlockHeader -&gt; Const SlotNo BlockHeader
</span><a href="#local-6989586621682488680"><span class="hs-var">#slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488682"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-939"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blockHeaderHash :: BlockId
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#blockHeaderHash"><span class="hs-identifier hs-var">blockHeaderHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash &quot;BlockHeader&quot; -&gt; BlockId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#BlockId"><span class="hs-identifier hs-var">BlockId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; Hash &quot;BlockHeader&quot;
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AheaderHash%3ABlockHeader"><span class="hs-identifier hs-var hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488682"><span class="hs-identifier hs-var">block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-940"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blockParentHash :: BlockId
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#blockParentHash"><span class="hs-identifier hs-var">blockParentHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Hash &quot;BlockHeader&quot;) -&gt; BlockId
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#fromMaybeHash"><span class="hs-identifier hs-var">fromMaybeHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; Maybe (Hash &quot;BlockHeader&quot;)
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AparentHeaderHash%3ABlockHeader"><span class="hs-identifier hs-var hs-var">parentHeaderHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488682"><span class="hs-identifier hs-var">block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-941"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blockHeight :: Word32
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#blockHeight"><span class="hs-identifier hs-var">TH.blockHeight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Quantity &quot;block&quot; Word32 -&gt; Word32
forall (unit :: Symbol) a. Quantity unit a -&gt; a
</span><a href="Data.Quantity.html#getQuantity"><span class="hs-identifier hs-var hs-var">getQuantity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; Quantity &quot;block&quot; Word32
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3AblockHeight%3ABlockHeader"><span class="hs-identifier hs-var hs-var">blockHeight</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488682"><span class="hs-identifier hs-var">block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-942"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-943"></span><span>
</span><span id="line-944"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#fromBlockHeaders"><span class="hs-identifier hs-type">fromBlockHeaders</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#BlockHeader"><span class="hs-identifier hs-type">TH.BlockHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-945"></span><span id="fromBlockHeaders"><span class="annot"><span class="annottext">fromBlockHeaders :: BlockHeader -&gt; BlockHeader
</span><a href="Cardano.Pool.DB.Sqlite.html#fromBlockHeaders"><span class="hs-identifier hs-var hs-var">fromBlockHeaders</span></a></span></span><span> </span><span id="local-6989586621682488677"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488677"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-946"></span><span>    </span><span class="annot"><span class="annottext">SlotNo
-&gt; Quantity &quot;block&quot; Word32
-&gt; Hash &quot;BlockHeader&quot;
-&gt; Maybe (Hash &quot;BlockHeader&quot;)
-&gt; BlockHeader
</span><a href="Cardano.Wallet.Primitive.Types.html#BlockHeader"><span class="hs-identifier hs-var">BlockHeader</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621682488676"><span class="hs-identifier hs-var">blockSlot</span></a></span><span>
</span><span id="line-947"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Quantity &quot;block&quot; Word32
forall (unit :: Symbol) a. a -&gt; Quantity unit a
</span><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-var">Quantity</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621682488675"><span class="hs-identifier hs-var">blockHeight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-948"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockId -&gt; Hash &quot;BlockHeader&quot;
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#getBlockId"><span class="hs-identifier hs-var hs-var">getBlockId</span></a></span><span> </span><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682488674"><span class="hs-identifier hs-var">blockHeaderHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-949"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockId -&gt; Maybe (Hash &quot;BlockHeader&quot;)
</span><a href="Cardano.Wallet.DB.Sqlite.Types.html#toMaybeHash"><span class="hs-identifier hs-var">toMaybeHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockId
</span><a href="#local-6989586621682488673"><span class="hs-identifier hs-var">blockParentHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-950"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-951"></span><span>    </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#BlockHeader"><span class="hs-identifier hs-type">TH.BlockHeader</span></a></span><span>
</span><span id="line-952"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682488676"><span class="annot"><span class="annottext">SlotNo
blockSlot :: SlotNo
blockSlot :: BlockHeader -&gt; SlotNo
</span><a href="#local-6989586621682488676"><span class="hs-identifier hs-var hs-var">blockSlot</span></a></span></span><span>
</span><span id="line-953"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621682488675"><span class="annot"><span class="annottext">Word32
blockHeight :: Word32
blockHeight :: BlockHeader -&gt; Word32
</span><a href="#local-6989586621682488675"><span class="hs-identifier hs-var hs-var">blockHeight</span></a></span></span><span>
</span><span id="line-954"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621682488674"><span class="annot"><span class="annottext">BlockId
blockHeaderHash :: BlockId
blockHeaderHash :: BlockHeader -&gt; BlockId
</span><a href="#local-6989586621682488674"><span class="hs-identifier hs-var hs-var">blockHeaderHash</span></a></span></span><span>
</span><span id="line-955"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621682488673"><span class="annot"><span class="annottext">BlockId
blockParentHash :: BlockId
blockParentHash :: BlockHeader -&gt; BlockId
</span><a href="#local-6989586621682488673"><span class="hs-identifier hs-var hs-var">blockParentHash</span></a></span></span><span>
</span><span id="line-956"></span><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621682488677"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-957"></span><span>
</span><span id="line-958"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#mkStakeDistribution"><span class="hs-identifier hs-type">mkStakeDistribution</span></a></span><span>
</span><span id="line-959"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a></span><span>
</span><span id="line-960"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-type">Quantity</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;lovelace&quot;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-961"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#StakeDistribution"><span class="hs-identifier hs-type">StakeDistribution</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-962"></span><span id="mkStakeDistribution"><span class="annot"><span class="annottext">mkStakeDistribution :: EpochNo
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)] -&gt; [StakeDistribution]
</span><a href="Cardano.Pool.DB.Sqlite.html#mkStakeDistribution"><span class="hs-identifier hs-var hs-var">mkStakeDistribution</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a></span><span> </span><span id="local-6989586621682488672"><span class="annot"><span class="annottext">Word31
</span><a href="#local-6989586621682488672"><span class="hs-identifier hs-var">epoch</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((PoolId, Quantity &quot;lovelace&quot; Word64) -&gt; StakeDistribution)
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)] -&gt; [StakeDistribution]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(((PoolId, Quantity &quot;lovelace&quot; Word64) -&gt; StakeDistribution)
 -&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)] -&gt; [StakeDistribution])
-&gt; ((PoolId, Quantity &quot;lovelace&quot; Word64) -&gt; StakeDistribution)
-&gt; [(PoolId, Quantity &quot;lovelace&quot; Word64)]
-&gt; [StakeDistribution]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621682488671"><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488671"><span class="hs-identifier hs-var">pool</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-type">Quantity</span></a></span><span> </span><span id="local-6989586621682488670"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488670"><span class="hs-identifier hs-var">stake</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-963"></span><span>    </span><span class="annot"><span class="annottext">StakeDistribution :: PoolId -&gt; Word64 -&gt; Word64 -&gt; StakeDistribution
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#StakeDistribution"><span class="hs-identifier hs-type">StakeDistribution</span></a></span><span>
</span><span id="line-964"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">stakeDistributionPoolId :: PoolId
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#stakeDistributionPoolId"><span class="hs-identifier hs-var">stakeDistributionPoolId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolId
</span><a href="#local-6989586621682488671"><span class="hs-identifier hs-var">pool</span></a></span><span>
</span><span id="line-965"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">stakeDistributionEpoch :: Word64
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#stakeDistributionEpoch"><span class="hs-identifier hs-var">stakeDistributionEpoch</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word31 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word31
</span><a href="#local-6989586621682488672"><span class="hs-identifier hs-var">epoch</span></a></span><span>
</span><span id="line-966"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">stakeDistributionStake :: Word64
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#stakeDistributionStake"><span class="hs-identifier hs-var">stakeDistributionStake</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621682488670"><span class="hs-identifier hs-var">stake</span></a></span><span>
</span><span id="line-967"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-968"></span><span>
</span><span id="line-969"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#fromStakeDistribution"><span class="hs-identifier hs-type">fromStakeDistribution</span></a></span><span>
</span><span id="line-970"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#StakeDistribution"><span class="hs-identifier hs-type">StakeDistribution</span></a></span><span>
</span><span id="line-971"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#PoolId"><span class="hs-identifier hs-type">PoolId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-type">Quantity</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;lovelace&quot;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-972"></span><span id="fromStakeDistribution"><span class="annot"><span class="annottext">fromStakeDistribution :: StakeDistribution -&gt; (PoolId, Quantity &quot;lovelace&quot; Word64)
</span><a href="Cardano.Pool.DB.Sqlite.html#fromStakeDistribution"><span class="hs-identifier hs-var hs-var">fromStakeDistribution</span></a></span></span><span> </span><span id="local-6989586621682488665"><span class="annot"><span class="annottext">StakeDistribution
</span><a href="#local-6989586621682488665"><span class="hs-identifier hs-var">distribution</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-973"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">StakeDistribution -&gt; PoolId
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#stakeDistributionPoolId"><span class="hs-identifier hs-var hs-var">stakeDistributionPoolId</span></a></span><span> </span><span class="annot"><span class="annottext">StakeDistribution
</span><a href="#local-6989586621682488665"><span class="hs-identifier hs-var">distribution</span></a></span><span>
</span><span id="line-974"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Quantity &quot;lovelace&quot; Word64
forall (unit :: Symbol) a. a -&gt; Quantity unit a
</span><a href="Data.Quantity.html#Quantity"><span class="hs-identifier hs-var">Quantity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StakeDistribution -&gt; Word64
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#stakeDistributionStake"><span class="hs-identifier hs-var hs-var">stakeDistributionStake</span></a></span><span> </span><span class="annot"><span class="annottext">StakeDistribution
</span><a href="#local-6989586621682488665"><span class="hs-identifier hs-var">distribution</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-975"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-976"></span><span>
</span><span id="line-977"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#fromPoolMeta"><span class="hs-identifier hs-type">fromPoolMeta</span></a></span><span>
</span><span id="line-978"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#PoolMetadata"><span class="hs-identifier hs-type">PoolMetadata</span></a></span><span>
</span><span id="line-979"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadataHash"><span class="hs-identifier hs-type">StakePoolMetadataHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadata"><span class="hs-identifier hs-type">StakePoolMetadata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-980"></span><span id="fromPoolMeta"><span class="annot"><span class="annottext">fromPoolMeta :: PoolMetadata -&gt; (StakePoolMetadataHash, StakePoolMetadata)
</span><a href="Cardano.Pool.DB.Sqlite.html#fromPoolMeta"><span class="hs-identifier hs-var hs-var">fromPoolMeta</span></a></span></span><span> </span><span id="local-6989586621682488664"><span class="annot"><span class="annottext">PoolMetadata
</span><a href="#local-6989586621682488664"><span class="hs-identifier hs-var">meta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolMetadata -&gt; StakePoolMetadataHash
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#poolMetadataHash"><span class="hs-identifier hs-var hs-var">poolMetadataHash</span></a></span><span> </span><span class="annot"><span class="annottext">PoolMetadata
</span><a href="#local-6989586621682488664"><span class="hs-identifier hs-var">meta</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StakePoolMetadata -&gt; (StakePoolMetadataHash, StakePoolMetadata))
-&gt; StakePoolMetadata -&gt; (StakePoolMetadataHash, StakePoolMetadata)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-981"></span><span>    </span><span class="annot"><span class="annottext">StakePoolMetadata :: StakePoolTicker -&gt; Text -&gt; Maybe Text -&gt; Text -&gt; StakePoolMetadata
</span><a href="Cardano.Wallet.Primitive.Types.html#StakePoolMetadata"><span class="hs-identifier hs-type">StakePoolMetadata</span></a></span><span>
</span><span id="line-982"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:ticker:StakePoolMetadata :: StakePoolTicker
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3Aticker%3AStakePoolMetadata"><span class="hs-identifier hs-var">ticker</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolMetadata -&gt; StakePoolTicker
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#poolMetadataTicker"><span class="hs-identifier hs-var hs-var">poolMetadataTicker</span></a></span><span> </span><span class="annot"><span class="annottext">PoolMetadata
</span><a href="#local-6989586621682488664"><span class="hs-identifier hs-var">meta</span></a></span><span>
</span><span id="line-983"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:name:StakePoolMetadata :: Text
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3Aname%3AStakePoolMetadata"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolMetadata -&gt; Text
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#poolMetadataName"><span class="hs-identifier hs-var hs-var">poolMetadataName</span></a></span><span> </span><span class="annot"><span class="annottext">PoolMetadata
</span><a href="#local-6989586621682488664"><span class="hs-identifier hs-var">meta</span></a></span><span>
</span><span id="line-984"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:description:StakePoolMetadata :: Maybe Text
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3Adescription%3AStakePoolMetadata"><span class="hs-identifier hs-var">description</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolMetadata -&gt; Maybe Text
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#poolMetadataDescription"><span class="hs-identifier hs-var hs-var">poolMetadataDescription</span></a></span><span> </span><span class="annot"><span class="annottext">PoolMetadata
</span><a href="#local-6989586621682488664"><span class="hs-identifier hs-var">meta</span></a></span><span>
</span><span id="line-985"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:homepage:StakePoolMetadata :: Text
</span><a href="Cardano.Wallet.Primitive.Types.html#%24sel%3Ahomepage%3AStakePoolMetadata"><span class="hs-identifier hs-var">homepage</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolMetadata -&gt; Text
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#poolMetadataHomepage"><span class="hs-identifier hs-var hs-var">poolMetadataHomepage</span></a></span><span> </span><span class="annot"><span class="annottext">PoolMetadata
</span><a href="#local-6989586621682488664"><span class="hs-identifier hs-var">meta</span></a></span><span>
</span><span id="line-986"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-987"></span><span>
</span><span id="line-988"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#fromSettings"><span class="hs-identifier hs-type">fromSettings</span></a></span><span>
</span><span id="line-989"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span>
</span><span id="line-990"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Settings"><span class="hs-identifier hs-type">W.Settings</span></a></span><span>
</span><span id="line-991"></span><span id="fromSettings"><span class="annot"><span class="annottext">fromSettings :: Settings -&gt; Settings
</span><a href="Cardano.Pool.DB.Sqlite.html#fromSettings"><span class="hs-identifier hs-var hs-var">fromSettings</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span> </span><span id="local-6989586621682488657"><span class="annot"><span class="annottext">PoolMetadataSource
</span><a href="#local-6989586621682488657"><span class="hs-identifier hs-var">pms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolMetadataSource -&gt; Settings
</span><a href="Cardano.Wallet.Primitive.Types.html#Settings"><span class="hs-identifier hs-var">W.Settings</span></a></span><span> </span><span class="annot"><span class="annottext">PoolMetadataSource
</span><a href="#local-6989586621682488657"><span class="hs-identifier hs-var">pms</span></a></span><span>
</span><span id="line-992"></span><span>
</span><span id="line-993"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#toSettings"><span class="hs-identifier hs-type">toSettings</span></a></span><span>
</span><span id="line-994"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Settings"><span class="hs-identifier hs-type">W.Settings</span></a></span><span>
</span><span id="line-995"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span>
</span><span id="line-996"></span><span id="toSettings"><span class="annot"><span class="annottext">toSettings :: Settings -&gt; Settings
</span><a href="Cardano.Pool.DB.Sqlite.html#toSettings"><span class="hs-identifier hs-var hs-var">toSettings</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#Settings"><span class="hs-identifier hs-type">W.Settings</span></a></span><span> </span><span id="local-6989586621682488655"><span class="annot"><span class="annottext">PoolMetadataSource
</span><a href="#local-6989586621682488655"><span class="hs-identifier hs-var">pms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PoolMetadataSource -&gt; Settings
</span><a href="Cardano.Pool.DB.Sqlite.TH.html#Settings"><span class="hs-identifier hs-var">Settings</span></a></span><span> </span><span class="annot"><span class="annottext">PoolMetadataSource
</span><a href="#local-6989586621682488655"><span class="hs-identifier hs-var">pms</span></a></span><span>
</span><span id="line-997"></span><span>
</span><span id="line-998"></span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.html#fromInternalState"><span class="hs-identifier hs-type">fromInternalState</span></a></span><span>
</span><span id="line-999"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a></span><span>
</span><span id="line-1000"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Wallet.Primitive.Types.html#InternalState"><span class="hs-identifier hs-type">W.InternalState</span></a></span><span>
</span><span id="line-1001"></span><span id="fromInternalState"><span class="annot"><span class="annottext">fromInternalState :: InternalState -&gt; InternalState
</span><a href="Cardano.Pool.DB.Sqlite.html#fromInternalState"><span class="hs-identifier hs-var hs-var">fromInternalState</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Pool.DB.Sqlite.TH.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a></span><span> </span><span id="local-6989586621682488654"><span class="annot"><span class="annottext">Maybe POSIXTime
</span><a href="#local-6989586621682488654"><span class="hs-identifier hs-var">utc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe POSIXTime -&gt; InternalState
</span><a href="Cardano.Wallet.Primitive.Types.html#InternalState"><span class="hs-identifier hs-var">W.InternalState</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe POSIXTime
</span><a href="#local-6989586621682488654"><span class="hs-identifier hs-var">utc</span></a></span><span>
</span><span id="line-1002"></span></pre></body></html>