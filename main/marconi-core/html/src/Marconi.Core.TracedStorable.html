<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Marconi.Core.TracedStorable</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * State</span></span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Config"><span class="hs-identifier">Config</span></a></span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#memoryBufferSize"><span class="hs-identifier">memoryBufferSize</span></a></span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier">State</span></a></span><span>
</span><span id="line-6"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#handle"><span class="hs-identifier">handle</span></a></span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#config"><span class="hs-identifier">config</span></a></span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#emptyState"><span class="hs-identifier">emptyState</span></a></span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Storage"><span class="hs-identifier">Storage</span></a></span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#storage"><span class="hs-identifier">storage</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#events"><span class="hs-identifier">events</span></a></span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#cursor"><span class="hs-identifier">cursor</span></a></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#getMemoryEvents"><span class="hs-identifier">getMemoryEvents</span></a></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#getEvents"><span class="hs-identifier">getEvents</span></a></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier">StorableEvent</span></a></span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier">StorablePoint</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableQuery"><span class="hs-identifier">StorableQuery</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableResult"><span class="hs-identifier">StorableResult</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier">StorableMonad</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableNotifications"><span class="hs-identifier">StorableNotifications</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><span class="hs-comment">-- * API</span></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#SyntheticEvent"><span class="hs-identifier">SyntheticEvent</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#ControlNotification"><span class="hs-identifier">ControlNotification</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Buffered"><span class="hs-identifier">Buffered</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Queryable"><span class="hs-identifier">Queryable</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Resumable"><span class="hs-identifier">Resumable</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Rewindable"><span class="hs-identifier">Rewindable</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#HasPoint"><span class="hs-identifier">HasPoint</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#syntheticPoint"><span class="hs-identifier">syntheticPoint</span></a></span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#foldEvents"><span class="hs-identifier">foldEvents</span></a></span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#insert"><span class="hs-identifier">insert</span></a></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#checkpoint"><span class="hs-identifier">checkpoint</span></a></span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#insertMany"><span class="hs-identifier">insertMany</span></a></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#rewind"><span class="hs-identifier">rewind</span></a></span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#resume"><span class="hs-identifier">resume</span></a></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#query"><span class="hs-identifier">query</span></a></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">Control.Lens.Operators</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-operator">(%~)</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-operator">(.~)</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-operator">(^.)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">Control.Lens.TH</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Lens</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../primitive/html/src"><span class="hs-identifier">Control.Monad.Primitive</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../primitive/html/src"><span class="hs-identifier">PrimMonad</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../primitive/html/src"><span class="hs-identifier">PrimState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">foldl'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">foldlM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Function</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&amp;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Functor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&lt;&amp;&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Functor.Contravariant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">contramap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../vector/html/src"><span class="hs-identifier">Data.Vector</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../vector/html/src"><span class="hs-identifier">Data.Vector.Generic</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VG</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../vector/html/src"><span class="hs-identifier">Data.Vector.Mutable</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VM</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier">Control.Tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier">Tracer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier">traceWith</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-comment">{-
   The extensible parts of the indexers are the way data is stored into some form
   of persistent storage. The interface used for working blockchain events is defined
   in this module.

   There are quite a bit of type variables that are involed in defining this interface.
   Some of them stand for the type of database connection (h), the type of events (e),
   the type of points along the blockchain (denoted by p), the type of queries (q) and
   results.

   The following data families implement the observation that most of the variables
   can be derived from the way information is stored in the database, so there is
   quite a bit of convenience in reducing the number of type variables to just two.
   One that stands for the database connection (which should be a newtype for each
   indexer) and one for the monad in which the indexer runs (usually IO).
-}</span><span>
</span><span id="line-70"></span><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="StorableEvent"><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-var">StorableEvent</span></a></span></span><span> </span><span id="local-6989586621679132122"><span class="annot"><a href="#local-6989586621679132122"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-comment">-- | The resume and query functionality requires a way to specify points on the chain from which we</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- want to resume, or points up to which we want to query.</span><span>
</span><span id="line-74"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="StorablePoint"><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-var">StorablePoint</span></a></span></span><span> </span><span id="local-6989586621679132121"><span class="annot"><a href="#local-6989586621679132121"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="StorableQuery"><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableQuery"><span class="hs-identifier hs-var">StorableQuery</span></a></span></span><span> </span><span id="local-6989586621679132120"><span class="annot"><a href="#local-6989586621679132120"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="StorableResult"><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableResult"><span class="hs-identifier hs-var">StorableResult</span></a></span></span><span> </span><span id="local-6989586621679132119"><span class="annot"><a href="#local-6989586621679132119"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-comment">-- TODO: Rename `Storable` to `Indexer`.</span><span>
</span><span id="line-81"></span><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="StorableNotifications"><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableNotifications"><span class="hs-identifier hs-var">StorableNotifications</span></a></span></span><span> </span><span id="local-6989586621679132118"><span class="annot"><a href="#local-6989586621679132118"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span id="local-6989586621679132116"><span id="local-6989586621679132117"></span></span><span class="hs-keyword">data</span><span> </span><span id="ControlNotification"><span class="annot"><a href="Marconi.Core.TracedStorable.html#ControlNotification"><span class="hs-identifier hs-var">ControlNotification</span></a></span></span><span> </span><span id="local-6989586621679132203"><span class="annot"><a href="#local-6989586621679132203"><span class="hs-identifier hs-type">pt</span></a></span></span><span> </span><span id="local-6989586621679132204"><span class="annot"><a href="#local-6989586621679132204"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-84"></span><span>    </span><span id="CNRollForward"><span class="annot"><a href="Marconi.Core.TracedStorable.html#CNRollForward"><span class="hs-identifier hs-var">CNRollForward</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679132203"><span class="hs-identifier hs-type">pt</span></a></span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CNRollBack"><span class="annot"><a href="Marconi.Core.TracedStorable.html#CNRollBack"><span class="hs-identifier hs-var">CNRollBack</span></a></span></span><span>    </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679132203"><span class="hs-identifier hs-type">pt</span></a></span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CNApplication"><span class="annot"><a href="Marconi.Core.TracedStorable.html#CNApplication"><span class="hs-identifier hs-var">CNApplication</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679132204"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x.
 ControlNotification pt n -&gt; Rep (ControlNotification pt n) x)
-&gt; (forall x.
    Rep (ControlNotification pt n) x -&gt; ControlNotification pt n)
-&gt; Generic (ControlNotification pt n)
forall x.
Rep (ControlNotification pt n) x -&gt; ControlNotification pt n
forall x.
ControlNotification pt n -&gt; Rep (ControlNotification pt n) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall pt n x.
Rep (ControlNotification pt n) x -&gt; ControlNotification pt n
forall pt n x.
ControlNotification pt n -&gt; Rep (ControlNotification pt n) x
$cto :: forall pt n x.
Rep (ControlNotification pt n) x -&gt; ControlNotification pt n
$cfrom :: forall pt n x.
ControlNotification pt n -&gt; Rep (ControlNotification pt n) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="StorableMonad"><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-var">StorableMonad</span></a></span></span><span> </span><span id="local-6989586621679132109"><span class="annot"><a href="#local-6989586621679132109"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-operator">*</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-operator">*</span></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-keyword">type</span><span> </span><span id="ControlTracer"><span class="annot"><a href="Marconi.Core.TracedStorable.html#ControlTracer"><span class="hs-identifier hs-var">ControlTracer</span></a></span></span><span> </span><span id="local-6989586621679132108"><span class="annot"><a href="#local-6989586621679132108"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-type">Tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132108"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#ControlNotification"><span class="hs-identifier hs-type">ControlNotification</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132108"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableNotifications"><span class="hs-identifier hs-type">StorableNotifications</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132108"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-keyword">type</span><span> </span><span id="AppTracer"><span class="annot"><a href="Marconi.Core.TracedStorable.html#AppTracer"><span class="hs-identifier hs-var">AppTracer</span></a></span></span><span> </span><span id="local-6989586621679132107"><span class="annot"><a href="#local-6989586621679132107"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-type">Tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132107"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableNotifications"><span class="hs-identifier hs-type">StorableNotifications</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132107"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">{-
   The first, `Buffered` class explains what it means for an indexer to be accumulating
   a set of results that will be flushed to disk when the memory buffer is fully filled.

   The memory layout of the indexer has been simplified by a lot since the previous
   version and it looks something like this:

   |e|e|e|e|e|e|e|e|e|e|e|e|e|e|e|e|e|e|                                     |
   |-------------------|---------------|-------------------------------------|
   |   memory/buffer   |  disk/events  |       disk/aggregate (optional)     |

   When the buffer is filled with events, they all get flushed to disk. We need this
   operation for performance reasons. Most databases will have significantly improved
   performance for batch inserts.

   Rollbacks will only happen in the memory or disk/events storage area, so the
   developer has to make sure that the allocated space for the buffer and the
   disk/events is greater than the K parameter.

   The last part disk/aggregate represents some aggregated data. At some point the
   developer should write code to aggregate the disk/events into the aggregate
   section of the database. We did not provide any special handling of this for the
   following reasons:

     1) A lot of indexers will not require aggregated data. Only storing events should
        be enough for most applications.
     2) Data aggregation can be implemented at database level and probably be more
        efficient than what Haskell can do here.
     3) We can always extend the interface to include direct support for this pattern
        if there is a demand from the users of the API.
-}</span><span>
</span><span id="line-127"></span><span class="hs-keyword">class</span><span> </span><span id="Buffered"><span class="annot"><a href="Marconi.Core.TracedStorable.html#Buffered"><span class="hs-identifier hs-var">Buffered</span></a></span></span><span> </span><span id="local-6989586621679132220"><span class="annot"><a href="#local-6989586621679132220"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-128"></span><span>  </span><span class="hs-comment">-- | This function persists the memory/buffer events to disk when the memory buffer is filled.</span><span>
</span><span id="line-129"></span><span>  </span><span id="local-6989586621679132183"><span id="persistToStorage"><span class="annot"><a href="Marconi.Core.TracedStorable.html#persistToStorage"><span class="hs-identifier hs-type">persistToStorage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Foldable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132183"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#AppTracer"><span class="hs-identifier hs-type">AppTracer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132220"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132183"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132220"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132220"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132220"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132220"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-comment">{- This function retrieves the events from the disk/events area.
     If the user chooses to only store events, without accumulating them, this function
     is expected to return the events over which rollbacks can occur in order to keep
     things performant. Since this is used mostly for testing, no need to trace. -}</span><span>
</span><span id="line-135"></span><span>  </span><span id="getStoredEvents"><span class="annot"><a href="Marconi.Core.TracedStorable.html#getStoredEvents"><span class="hs-identifier hs-type">getStoredEvents</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679132220"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132220"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132220"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="hs-comment">{-
   All information from indexers should be made accessible through queries. Queries
   act a lot like folds over the event stream. Each query introduces two indexed types:
   one for the type of requests (called StorableQuery) and one for responses (called
   StorableResult).
-}</span><span>
</span><span id="line-143"></span><span class="hs-keyword">class</span><span> </span><span id="Queryable"><span class="annot"><a href="Marconi.Core.TracedStorable.html#Queryable"><span class="hs-identifier hs-var">Queryable</span></a></span></span><span> </span><span id="local-6989586621679132152"><span class="annot"><a href="#local-6989586621679132152"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-144"></span><span>  </span><span id="local-6989586621679132150"><span id="queryStorage"><span class="annot"><a href="Marconi.Core.TracedStorable.html#queryStorage"><span class="hs-identifier hs-type">queryStorage</span></a></span></span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Foldable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132150"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#AppTracer"><span class="hs-identifier hs-type">AppTracer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132152"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132152"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132150"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132152"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132152"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableQuery"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132152"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-151"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132152"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableResult"><span class="hs-identifier hs-type">StorableResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132152"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="hs-comment">{-
   One of the reasons why indexers were born was to solve one of the issues very specific
   to blockchains: rollbacks. The basic idea was simple, keep a history of the blockchain
   data and whenever we have a rollback restore the version which is the target of the
   rollback.

   This is what the next class is meant to do.
-}</span><span>
</span><span id="line-161"></span><span class="hs-keyword">class</span><span> </span><span id="Rewindable"><span class="annot"><a href="Marconi.Core.TracedStorable.html#Rewindable"><span class="hs-identifier hs-var">Rewindable</span></a></span></span><span> </span><span id="local-6989586621679132168"><span class="annot"><a href="#local-6989586621679132168"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-162"></span><span>  </span><span id="rewindStorage"><span class="annot"><a href="Marconi.Core.TracedStorable.html#rewindStorage"><span class="hs-identifier hs-type">rewindStorage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#AppTracer"><span class="hs-identifier hs-type">AppTracer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132168"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132168"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132168"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132168"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132168"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span class="hs-comment">{-
   Another feature of indexers is the ability to resume from a previously stored event.
   One way of implementing this is to make sure that there is always at least one event
   present on disk, event which includes the slot number when it was generated.

   This function should return the most recent resume point. The plan is to support
   multiple resume points, but for now there is no way to ensure that no data duplication
   happens (the same events get reinserted).

   This will not be a problem if the indexer learns how to remove the `old` slots
   so there will be no duplication. This may be implemented later if the API users
   request it.
-}</span><span>
</span><span id="line-177"></span><span class="hs-keyword">class</span><span> </span><span id="Resumable"><span class="annot"><a href="Marconi.Core.TracedStorable.html#Resumable"><span class="hs-identifier hs-var">Resumable</span></a></span></span><span> </span><span id="local-6989586621679132157"><span class="annot"><a href="#local-6989586621679132157"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-178"></span><span>  </span><span id="resumeFromStorage"><span class="annot"><a href="Marconi.Core.TracedStorable.html#resumeFromStorage"><span class="hs-identifier hs-type">resumeFromStorage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#AppTracer"><span class="hs-identifier hs-type">AppTracer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132157"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132157"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132157"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132157"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span class="hs-comment">{-
   The next class is witnessing the fact that events contain enough information to
   retrieve the point when they were produced.
-}</span><span>
</span><span id="line-184"></span><span class="hs-keyword">class</span><span> </span><span id="HasPoint"><span class="annot"><a href="Marconi.Core.TracedStorable.html#HasPoint"><span class="hs-identifier hs-var">HasPoint</span></a></span></span><span> </span><span id="local-6989586621679132289"><span class="annot"><a href="#local-6989586621679132289"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621679132288"><span class="annot"><a href="#local-6989586621679132288"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-185"></span><span>  </span><span id="getPoint"><span class="annot"><a href="Marconi.Core.TracedStorable.html#getPoint"><span class="hs-identifier hs-type">getPoint</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679132289"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132288"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span class="hs-comment">{-
   The configuration includes hints about the amount of events stored in memory and
   on disk. This information is used by the storage engine to decide how much memory
   to allocated and when to flush the memory buffer or roll the disk events into
   an aggregate database structure.
-}</span><span>
</span><span id="line-193"></span><span class="hs-keyword">newtype</span><span> </span><span id="Config"><span class="annot"><a href="Marconi.Core.TracedStorable.html#Config"><span class="hs-identifier hs-var">Config</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Config"><span class="annot"><a href="Marconi.Core.TracedStorable.html#Config"><span class="hs-identifier hs-var">Config</span></a></span></span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_memoryBufferSize"><span class="annot"><span class="annottext">Config -&gt; Int
</span><a href="Marconi.Core.TracedStorable.html#_memoryBufferSize"><span class="hs-identifier hs-var hs-var">_memoryBufferSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679132093"><span id="local-6989586621679132095"><span id="local-6989586621679132097"><span class="annot"><span class="annottext">Int -&gt; Config -&gt; ShowS
[Config] -&gt; ShowS
Config -&gt; String
(Int -&gt; Config -&gt; ShowS)
-&gt; (Config -&gt; String) -&gt; ([Config] -&gt; ShowS) -&gt; Show Config
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Config] -&gt; ShowS
$cshowList :: [Config] -&gt; ShowS
show :: Config -&gt; String
$cshow :: Config -&gt; String
showsPrec :: Int -&gt; Config -&gt; ShowS
$cshowsPrec :: Int -&gt; Config -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132088"><span id="local-6989586621679132090"><span class="annot"><span class="annottext">Config -&gt; Config -&gt; Bool
(Config -&gt; Config -&gt; Bool)
-&gt; (Config -&gt; Config -&gt; Bool) -&gt; Eq Config
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Config -&gt; Config -&gt; Bool
$c/= :: Config -&gt; Config -&gt; Bool
== :: Config -&gt; Config -&gt; Bool
$c== :: Config -&gt; Config -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span class="hs-special">$(</span><span id="memoryBufferSize"><span class="hs-identifier">Lens.makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Config</span></span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-keyword">data</span><span> </span><span id="SyntheticEvent"><span class="annot"><a href="Marconi.Core.TracedStorable.html#SyntheticEvent"><span class="hs-identifier hs-var">SyntheticEvent</span></a></span></span><span> </span><span id="local-6989586621679132212"><span class="annot"><a href="#local-6989586621679132212"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621679132213"><span class="annot"><a href="#local-6989586621679132213"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-199"></span><span>    </span><span id="Event"><span class="annot"><a href="Marconi.Core.TracedStorable.html#Event"><span class="hs-identifier hs-var">Event</span></a></span></span><span>     </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679132212"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Synthetic"><span class="annot"><a href="Marconi.Core.TracedStorable.html#Synthetic"><span class="hs-identifier hs-var">Synthetic</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679132213"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span id="local-6989586621679132160"><span id="local-6989586621679132161"><span class="annot"><a href="Marconi.Core.TracedStorable.html#syntheticPoint"><span class="hs-identifier hs-type">syntheticPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#HasPoint"><span class="hs-identifier hs-type">HasPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132161"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132160"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#SyntheticEvent"><span class="hs-identifier hs-type">SyntheticEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132161"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132160"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132160"><span class="hs-identifier hs-type">p</span></a></span></span></span><span>
</span><span id="line-203"></span><span id="syntheticPoint"><span class="annot"><span class="annottext">syntheticPoint :: SyntheticEvent e p -&gt; p
</span><a href="Marconi.Core.TracedStorable.html#syntheticPoint"><span class="hs-identifier hs-var hs-var">syntheticPoint</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span id="local-6989586621679132084"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679132084"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">e -&gt; p
forall e p. HasPoint e p =&gt; e -&gt; p
</span><a href="Marconi.Core.TracedStorable.html#getPoint"><span class="hs-identifier hs-var">getPoint</span></a></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679132084"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-204"></span><span class="annot"><a href="Marconi.Core.TracedStorable.html#syntheticPoint"><span class="hs-identifier hs-var">syntheticPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Synthetic"><span class="hs-identifier hs-type">Synthetic</span></a></span><span> </span><span id="local-6989586621679132083"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679132083"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679132083"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span class="annot"><a href="Marconi.Core.TracedStorable.html#foldEvents"><span class="hs-identifier hs-type">foldEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679132223"><span class="annot"><a href="#local-6989586621679132223"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621679132222"><span class="annot"><a href="#local-6989586621679132222"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Foldable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132223"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132223"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#SyntheticEvent"><span class="hs-identifier hs-type">SyntheticEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132222"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132222"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132222"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-207"></span><span id="foldEvents"><span class="annot"><span class="annottext">foldEvents :: f (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; [StorableEvent h]
</span><a href="Marconi.Core.TracedStorable.html#foldEvents"><span class="hs-identifier hs-var hs-var">foldEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[StorableEvent h] -&gt; [StorableEvent h]
forall a. [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">([StorableEvent h] -&gt; [StorableEvent h])
-&gt; (f (SyntheticEvent (StorableEvent h) (StorablePoint h))
    -&gt; [StorableEvent h])
-&gt; f (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; [StorableEvent h]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">([StorableEvent h]
 -&gt; SyntheticEvent (StorableEvent h) (StorablePoint h)
 -&gt; [StorableEvent h])
-&gt; [StorableEvent h]
-&gt; f (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; [StorableEvent h]
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
-&gt; SyntheticEvent (StorableEvent h) (StorablePoint h)
-&gt; [StorableEvent h]
</span><a href="#local-6989586621679132080"><span class="hs-identifier hs-var">unwrap</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-209"></span><span>    </span><span class="annot"><a href="#local-6989586621679132080"><span class="hs-identifier hs-type">unwrap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132222"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#SyntheticEvent"><span class="hs-identifier hs-type">SyntheticEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132222"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132222"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132222"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621679132080"><span class="annot"><span class="annottext">unwrap :: [StorableEvent h]
-&gt; SyntheticEvent (StorableEvent h) (StorablePoint h)
-&gt; [StorableEvent h]
</span><a href="#local-6989586621679132080"><span class="hs-identifier hs-var hs-var">unwrap</span></a></span></span><span> </span><span id="local-6989586621679132079"><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679132079"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Synthetic"><span class="hs-identifier hs-type">Synthetic</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint h
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679132079"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><a href="#local-6989586621679132080"><span class="hs-identifier hs-var">unwrap</span></a></span><span> </span><span id="local-6989586621679132078"><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679132078"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Event"><span class="hs-identifier hs-type">Event</span></a></span><span> </span><span id="local-6989586621679132077"><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679132077"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679132077"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent h -&gt; [StorableEvent h] -&gt; [StorableEvent h]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679132078"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="hs-keyword">data</span><span> </span><span id="Storage"><span class="annot"><a href="Marconi.Core.TracedStorable.html#Storage"><span class="hs-identifier hs-var">Storage</span></a></span></span><span> </span><span id="local-6989586621679132243"><span class="annot"><a href="#local-6989586621679132243"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Storage"><span class="annot"><a href="Marconi.Core.TracedStorable.html#Storage"><span class="hs-identifier hs-var">Storage</span></a></span></span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_events"><span class="annot"><span class="annottext">Storage h
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
</span><a href="Marconi.Core.TracedStorable.html#_events"><span class="hs-identifier hs-var hs-var">_events</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../vector/html/src"><span class="hs-identifier hs-type">VM.MVector</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../primitive/html/src"><span class="hs-identifier hs-type">PrimState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132243"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#SyntheticEvent"><span class="hs-identifier hs-type">SyntheticEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132243"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132243"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_cursor"><span class="annot"><span class="annottext">Storage h -&gt; Int
</span><a href="Marconi.Core.TracedStorable.html#_cursor"><span class="hs-identifier hs-var hs-var">_cursor</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-217"></span><span class="hs-special">$(</span><span id="cursor"><span id="events"><span id="local-6989586621679132235"><span id="local-6989586621679132243"><span class="hs-identifier">Lens.makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Storage</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="hs-keyword">data</span><span> </span><span id="State"><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-var">State</span></a></span></span><span> </span><span id="local-6989586621679132244"><span class="annot"><a href="#local-6989586621679132244"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="State"><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-var">State</span></a></span></span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_config"><span class="annot"><span class="annottext">State h -&gt; Config
</span><a href="Marconi.Core.TracedStorable.html#_config"><span class="hs-identifier hs-var hs-var">_config</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span>
</span><span id="line-221"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_storage"><span class="annot"><span class="annottext">State h -&gt; Storage h
</span><a href="Marconi.Core.TracedStorable.html#_storage"><span class="hs-identifier hs-var hs-var">_storage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Storage"><span class="hs-identifier hs-type">Storage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132244"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_handle"><span class="annot"><span class="annottext">State h -&gt; h
</span><a href="Marconi.Core.TracedStorable.html#_handle"><span class="hs-identifier hs-var hs-var">_handle</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679132244"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-224"></span><span class="hs-special">$(</span><span id="storage"><span id="config"><span id="handle"><span id="local-6989586621679132244"><span class="hs-identifier">Lens.makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">State</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span id="local-6989586621679132069"><span class="annot"><a href="Marconi.Core.TracedStorable.html#emptyState"><span class="hs-identifier hs-type">emptyState</span></a></span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132069"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132069"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132069"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132069"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-231"></span><span id="emptyState"><span class="annot"><span class="annottext">emptyState :: Int -&gt; h -&gt; StorableMonad h (State h)
</span><a href="Marconi.Core.TracedStorable.html#emptyState"><span class="hs-identifier hs-var hs-var">emptyState</span></a></span></span><span> </span><span id="local-6989586621679132068"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679132068"><span class="hs-identifier hs-var">memBuf</span></a></span></span><span> </span><span id="local-6989586621679132067"><span class="annot"><span class="annottext">h
</span><a href="#local-6989586621679132067"><span class="hs-identifier hs-var">hdl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>  </span><span id="local-6989586621679132066"><span class="annot"><span class="annottext">MVector
  (PrimState (StorableMonad h))
  (SyntheticEvent (StorableEvent h) (StorablePoint h))
</span><a href="#local-6989586621679132066"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; StorableMonad
     h
     (MVector
        (PrimState (StorableMonad h))
        (SyntheticEvent (StorableEvent h) (StorablePoint h)))
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
Int -&gt; m (MVector (PrimState m) a)
</span><a href="../../../../vector/html/src"><span class="hs-identifier hs-var">VM.new</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679132068"><span class="hs-identifier hs-var">memBuf</span></a></span><span>
</span><span id="line-233"></span><span>  </span><span class="annot"><span class="annottext">State h -&gt; StorableMonad h (State h)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(State h -&gt; StorableMonad h (State h))
-&gt; State h -&gt; StorableMonad h (State h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State :: forall h. Config -&gt; Storage h -&gt; h -&gt; State h
</span><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_config :: Config
</span><a href="Marconi.Core.TracedStorable.html#_config"><span class="hs-identifier hs-var">_config</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config :: Int -&gt; Config
</span><a href="Marconi.Core.TracedStorable.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_memoryBufferSize :: Int
</span><a href="Marconi.Core.TracedStorable.html#_memoryBufferSize"><span class="hs-identifier hs-var">_memoryBufferSize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679132068"><span class="hs-identifier hs-var">memBuf</span></a></span><span>
</span><span id="line-234"></span><span>                                  </span><span class="hs-special">}</span><span>
</span><span id="line-235"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_storage :: Storage h
</span><a href="Marconi.Core.TracedStorable.html#_storage"><span class="hs-identifier hs-var">_storage</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Storage :: forall h.
MVector
  (PrimState (StorableMonad h))
  (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; Int -&gt; Storage h
</span><a href="Marconi.Core.TracedStorable.html#Storage"><span class="hs-identifier hs-type">Storage</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_events :: MVector
  (PrimState (StorableMonad h))
  (SyntheticEvent (StorableEvent h) (StorablePoint h))
</span><a href="Marconi.Core.TracedStorable.html#_events"><span class="hs-identifier hs-var">_events</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVector
  (PrimState (StorableMonad h))
  (SyntheticEvent (StorableEvent h) (StorablePoint h))
</span><a href="#local-6989586621679132066"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-236"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_cursor :: Int
</span><a href="Marconi.Core.TracedStorable.html#_cursor"><span class="hs-identifier hs-var">_cursor</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-237"></span><span>                                    </span><span class="hs-special">}</span><span>
</span><span id="line-238"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_handle :: h
</span><a href="Marconi.Core.TracedStorable.html#_handle"><span class="hs-identifier hs-var">_handle</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">h
</span><a href="#local-6989586621679132067"><span class="hs-identifier hs-var">hdl</span></a></span><span>
</span><span id="line-239"></span><span>               </span><span class="hs-special">}</span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="hs-comment">-- Get events from the memory buffer.</span><span>
</span><span id="line-242"></span><span id="local-6989586621679132232"><span class="annot"><a href="Marconi.Core.TracedStorable.html#getMemoryEvents"><span class="hs-identifier hs-type">getMemoryEvents</span></a></span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Storage"><span class="hs-identifier hs-type">Storage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132232"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../vector/html/src"><span class="hs-identifier hs-type">V.MVector</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../primitive/html/src"><span class="hs-identifier hs-type">PrimState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132232"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#SyntheticEvent"><span class="hs-identifier hs-type">SyntheticEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132232"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132232"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-245"></span><span id="getMemoryEvents"><span class="annot"><span class="annottext">getMemoryEvents :: Storage h
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
</span><a href="Marconi.Core.TracedStorable.html#getMemoryEvents"><span class="hs-identifier hs-var hs-var">getMemoryEvents</span></a></span></span><span> </span><span id="local-6989586621679132064"><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679132064"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Int
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
forall s a. Int -&gt; Int -&gt; MVector s a -&gt; MVector s a
</span><a href="../../../../vector/html/src"><span class="hs-identifier hs-var">VM.slice</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679132064"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Storage h -&gt; Getting Int (Storage h) Int -&gt; Int
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting Int (Storage h) Int
forall h. Lens' (Storage h) Int
</span><a href="Marconi.Core.TracedStorable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679132064"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Storage h
-&gt; Getting
     (MVector
        (PrimState (StorableMonad h))
        (SyntheticEvent (StorableEvent h) (StorablePoint h)))
     (Storage h)
     (MVector
        (PrimState (StorableMonad h))
        (SyntheticEvent (StorableEvent h) (StorablePoint h)))
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting
  (MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h)))
  (Storage h)
  (MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h)))
forall h h.
Lens
  (Storage h)
  (Storage h)
  (MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h)))
  (MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h)))
</span><a href="Marconi.Core.TracedStorable.html#events"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span class="hs-comment">-- Get events from memory buffer and disk buffer.</span><span>
</span><span id="line-248"></span><span id="local-6989586621679132062"><span class="annot"><a href="Marconi.Core.TracedStorable.html#getEvents"><span class="hs-identifier hs-type">getEvents</span></a></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Buffered"><span class="hs-identifier hs-type">Buffered</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132062"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132062"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132062"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132062"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132062"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-253"></span><span id="getEvents"><span class="annot"><span class="annottext">getEvents :: State h -&gt; StorableMonad h [StorableEvent h]
</span><a href="Marconi.Core.TracedStorable.html#getEvents"><span class="hs-identifier hs-var hs-var">getEvents</span></a></span></span><span> </span><span id="local-6989586621679132061"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132061"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-254"></span><span>  </span><span id="local-6989586621679132060"><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679132060"><span class="hs-identifier hs-var">memoryEs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Storage h
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
forall h.
Storage h
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
</span><a href="Marconi.Core.TracedStorable.html#getMemoryEvents"><span class="hs-identifier hs-var">getMemoryEvents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132061"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting (Storage h) (State h) (Storage h) -&gt; Storage h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting (Storage h) (State h) (Storage h)
forall h. Lens' (State h) (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>              </span><span class="annot"><span class="annottext">MVector
  (PrimState (StorableMonad h))
  (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; (MVector
      (PrimState (StorableMonad h))
      (SyntheticEvent (StorableEvent h) (StorablePoint h))
    -&gt; StorableMonad
         h (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))))
-&gt; StorableMonad
     h (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h)))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">MVector
  (PrimState (StorableMonad h))
  (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; StorableMonad
     h (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h)))
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MVector (PrimState m) a -&gt; m (Vector a)
</span><a href="../../../../vector/html/src"><span class="hs-identifier hs-var">V.freeze</span></a></span><span> </span><span class="annot"><span class="annottext">StorableMonad
  h (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h)))
-&gt; (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))
    -&gt; [StorableEvent h])
-&gt; StorableMonad h [StorableEvent h]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&amp;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[SyntheticEvent (StorableEvent h) (StorablePoint h)]
-&gt; [StorableEvent h]
forall (f :: * -&gt; *) h.
Foldable f =&gt;
f (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; [StorableEvent h]
</span><a href="Marconi.Core.TracedStorable.html#foldEvents"><span class="hs-identifier hs-var">foldEvents</span></a></span><span> </span><span class="annot"><span class="annottext">([SyntheticEvent (StorableEvent h) (StorablePoint h)]
 -&gt; [StorableEvent h])
-&gt; (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))
    -&gt; [SyntheticEvent (StorableEvent h) (StorablePoint h)])
-&gt; Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; [StorableEvent h]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; [SyntheticEvent (StorableEvent h) (StorablePoint h)]
forall a. Vector a -&gt; [a]
</span><a href="../../../../vector/html/src"><span class="hs-identifier hs-var">V.toList</span></a></span><span>
</span><span id="line-256"></span><span>  </span><span id="local-6989586621679132057"><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679132057"><span class="hs-identifier hs-var">diskEs</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">h -&gt; StorableMonad h [StorableEvent h]
forall h. Buffered h =&gt; h -&gt; StorableMonad h [StorableEvent h]
</span><a href="Marconi.Core.TracedStorable.html#getStoredEvents"><span class="hs-identifier hs-var">getStoredEvents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132061"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting h (State h) h -&gt; h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting h (State h) h
forall h. Lens' (State h) h
</span><a href="Marconi.Core.TracedStorable.html#handle"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="annottext">[StorableEvent h] -&gt; StorableMonad h [StorableEvent h]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">([StorableEvent h] -&gt; StorableMonad h [StorableEvent h])
-&gt; [StorableEvent h] -&gt; StorableMonad h [StorableEvent h]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679132057"><span class="hs-identifier hs-var">diskEs</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent h] -&gt; [StorableEvent h] -&gt; [StorableEvent h]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679132060"><span class="hs-identifier hs-var">memoryEs</span></a></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span class="hs-comment">{- This function is used to add a checkpoint to the in-memory part of event indexers.
   You can use checkpoints to add synthetic events to the memory buffer. Filling the
   memory buffer with synthetic events will cause the real events to be flushed to
   disk when the number of blocks have been received, regardless of whether they are
   filtered or not.

   Note that the developer will have to use the `checkpoint` function to add synthetic
   events manually whenever the indexer event is filtered out.

   This is useful if the number of events is small and you run the risk of never
   storing them on-disk. When that happens, if the indexer is restarted it will
   resume from the Genesis block, which is something that is not an expected
   behaviour.

   Possible future uses of checkpoints:

   * We currently assume that the indexer has processed blocks up to the latest event
     processed. In case there are very few events this assumption introduces a big
     error. We may eventually use checkpoints to signal to the indexer that the latest
     block is more recent than the latest event processed.

   * Currently synthetic events cannot be stored in the persistent database. We may
     decide to offer this option to implementers if there is interest. This would
     allow for faster resumes if the last stored event is a lot older than the
     currently processed block (similar to the in-memory description of checkpoints).
-}</span><span>
</span><span id="line-285"></span><span id="local-6989586621679132056"><span class="annot"><a href="Marconi.Core.TracedStorable.html#checkpoint"><span class="hs-identifier hs-type">checkpoint</span></a></span><span>
</span><span id="line-286"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Buffered"><span class="hs-identifier hs-type">Buffered</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132056"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132056"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#AppTracer"><span class="hs-identifier hs-type">AppTracer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132056"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132056"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-290"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132056"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132056"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132056"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-292"></span><span id="checkpoint"><span class="annot"><span class="annottext">checkpoint :: AppTracer h
-&gt; StorablePoint h -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="Marconi.Core.TracedStorable.html#checkpoint"><span class="hs-identifier hs-var hs-var">checkpoint</span></a></span></span><span> </span><span id="local-6989586621679132055"><span class="annot"><span class="annottext">AppTracer h
</span><a href="#local-6989586621679132055"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679132054"><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679132054"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679132053"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132053"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-293"></span><span>  </span><span id="local-6989586621679132052"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132052"><span class="hs-identifier hs-var">state'</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AppTracer h -&gt; State h -&gt; StorableMonad h (State h)
forall h.
(Buffered h, PrimMonad (StorableMonad h)) =&gt;
AppTracer h -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="Marconi.Core.TracedStorable.html#flushBuffer"><span class="hs-identifier hs-var">flushBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">AppTracer h
</span><a href="#local-6989586621679132055"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132053"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-294"></span><span>  </span><span id="local-6989586621679132050"><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679132050"><span class="hs-identifier hs-var">storage'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SyntheticEvent (StorableEvent h) (StorablePoint h)
-&gt; Storage h -&gt; StorableMonad h (Storage h)
forall h.
PrimMonad (StorableMonad h) =&gt;
SyntheticEvent (StorableEvent h) (StorablePoint h)
-&gt; Storage h -&gt; StorableMonad h (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#appendEvent"><span class="hs-identifier hs-var">appendEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StorablePoint h
-&gt; SyntheticEvent (StorableEvent h) (StorablePoint h)
forall e p. p -&gt; SyntheticEvent e p
</span><a href="Marconi.Core.TracedStorable.html#Synthetic"><span class="hs-identifier hs-var">Synthetic</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679132054"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132052"><span class="hs-identifier hs-var">state'</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting (Storage h) (State h) (Storage h) -&gt; Storage h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting (Storage h) (State h) (Storage h)
forall h. Lens' (State h) (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>  </span><span class="annot"><span class="annottext">State h -&gt; StorableMonad h (State h)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(State h -&gt; StorableMonad h (State h))
-&gt; State h -&gt; StorableMonad h (State h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132052"><span class="hs-identifier hs-var">state'</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_storage :: Storage h
</span><a href="Marconi.Core.TracedStorable.html#_storage"><span class="hs-identifier hs-var">_storage</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679132050"><span class="hs-identifier hs-var">storage'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span id="local-6989586621679132172"><span class="annot"><a href="Marconi.Core.TracedStorable.html#insert"><span class="hs-identifier hs-type">insert</span></a></span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Buffered"><span class="hs-identifier hs-type">Buffered</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132172"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132172"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#HasPoint"><span class="hs-identifier hs-type">HasPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132172"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132172"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#ControlTracer"><span class="hs-identifier hs-type">ControlTracer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132172"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132172"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132172"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-304"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132172"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132172"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-305"></span><span id="insert"><span class="annot"><span class="annottext">insert :: ControlTracer h
-&gt; StorableEvent h -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="Marconi.Core.TracedStorable.html#insert"><span class="hs-identifier hs-var hs-var">insert</span></a></span></span><span> </span><span id="local-6989586621679132048"><span class="annot"><span class="annottext">ControlTracer h
</span><a href="#local-6989586621679132048"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679132047"><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679132047"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679132046"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132046"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-306"></span><span>  </span><span id="local-6989586621679132045"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132045"><span class="hs-identifier hs-var">state'</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AppTracer h -&gt; State h -&gt; StorableMonad h (State h)
forall h.
(Buffered h, PrimMonad (StorableMonad h)) =&gt;
AppTracer h -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="Marconi.Core.TracedStorable.html#flushBuffer"><span class="hs-identifier hs-var">flushBuffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StorableNotifications h
 -&gt; ControlNotification (StorablePoint h) (StorableNotifications h))
-&gt; ControlTracer h -&gt; AppTracer h
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">StorableNotifications h
-&gt; ControlNotification (StorablePoint h) (StorableNotifications h)
forall pt n. n -&gt; ControlNotification pt n
</span><a href="Marconi.Core.TracedStorable.html#CNApplication"><span class="hs-identifier hs-var">CNApplication</span></a></span><span> </span><span class="annot"><span class="annottext">ControlTracer h
</span><a href="#local-6989586621679132048"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132046"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-307"></span><span>  </span><span id="local-6989586621679132044"><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679132044"><span class="hs-identifier hs-var">storage'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SyntheticEvent (StorableEvent h) (StorablePoint h)
-&gt; Storage h -&gt; StorableMonad h (Storage h)
forall h.
PrimMonad (StorableMonad h) =&gt;
SyntheticEvent (StorableEvent h) (StorablePoint h)
-&gt; Storage h -&gt; StorableMonad h (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#appendEvent"><span class="hs-identifier hs-var">appendEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StorableEvent h
-&gt; SyntheticEvent (StorableEvent h) (StorablePoint h)
forall e p. e -&gt; SyntheticEvent e p
</span><a href="Marconi.Core.TracedStorable.html#Event"><span class="hs-identifier hs-var">Event</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679132047"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132045"><span class="hs-identifier hs-var">state'</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting (Storage h) (State h) (Storage h) -&gt; Storage h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting (Storage h) (State h) (Storage h)
forall h. Lens' (State h) (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>  </span><span class="annot"><span class="annottext">ControlTracer h
-&gt; ControlNotification (StorablePoint h) (StorableNotifications h)
-&gt; StorableMonad h ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-var">traceWith</span></a></span><span> </span><span class="annot"><span class="annottext">ControlTracer h
</span><a href="#local-6989586621679132048"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StorablePoint h
-&gt; ControlNotification (StorablePoint h) (StorableNotifications h)
forall pt n. pt -&gt; ControlNotification pt n
</span><a href="Marconi.Core.TracedStorable.html#CNRollForward"><span class="hs-identifier hs-var">CNRollForward</span></a></span><span> </span><span class="annot"><span class="annottext">(StorablePoint h
 -&gt; ControlNotification (StorablePoint h) (StorableNotifications h))
-&gt; StorablePoint h
-&gt; ControlNotification (StorablePoint h) (StorableNotifications h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent h -&gt; StorablePoint h
forall e p. HasPoint e p =&gt; e -&gt; p
</span><a href="Marconi.Core.TracedStorable.html#getPoint"><span class="hs-identifier hs-var">getPoint</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679132047"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><span class="annottext">State h -&gt; StorableMonad h (State h)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(State h -&gt; StorableMonad h (State h))
-&gt; State h -&gt; StorableMonad h (State h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132045"><span class="hs-identifier hs-var">state'</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_storage :: Storage h
</span><a href="Marconi.Core.TracedStorable.html#_storage"><span class="hs-identifier hs-var">_storage</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679132044"><span class="hs-identifier hs-var">storage'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span id="local-6989586621679132214"><span class="annot"><a href="Marconi.Core.TracedStorable.html#appendEvent"><span class="hs-identifier hs-type">appendEvent</span></a></span><span>
</span><span id="line-312"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132214"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#SyntheticEvent"><span class="hs-identifier hs-type">SyntheticEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132214"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132214"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Storage"><span class="hs-identifier hs-type">Storage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132214"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-315"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132214"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Storage"><span class="hs-identifier hs-type">Storage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132214"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-316"></span><span id="appendEvent"><span class="annot"><span class="annottext">appendEvent :: SyntheticEvent (StorableEvent h) (StorablePoint h)
-&gt; Storage h -&gt; StorableMonad h (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#appendEvent"><span class="hs-identifier hs-var hs-var">appendEvent</span></a></span></span><span> </span><span id="local-6989586621679132043"><span class="annot"><span class="annottext">SyntheticEvent (StorableEvent h) (StorablePoint h)
</span><a href="#local-6989586621679132043"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679132042"><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679132042"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-317"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679132041"><span class="annot"><span class="annottext">cr :: Int
</span><a href="#local-6989586621679132041"><span class="hs-identifier hs-var hs-var">cr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679132042"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Storage h -&gt; Getting Int (Storage h) Int -&gt; Int
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting Int (Storage h) Int
forall h. Lens' (Storage h) Int
</span><a href="Marconi.Core.TracedStorable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span>
</span><span id="line-318"></span><span>  </span><span class="annot"><span class="annottext">MVector
  (PrimState (StorableMonad h))
  (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; Int
-&gt; SyntheticEvent (StorableEvent h) (StorablePoint h)
-&gt; StorableMonad h ()
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MVector (PrimState m) a -&gt; Int -&gt; a -&gt; m ()
</span><a href="../../../../vector/html/src"><span class="hs-identifier hs-var">VM.write</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679132042"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Storage h
-&gt; Getting
     (MVector
        (PrimState (StorableMonad h))
        (SyntheticEvent (StorableEvent h) (StorablePoint h)))
     (Storage h)
     (MVector
        (PrimState (StorableMonad h))
        (SyntheticEvent (StorableEvent h) (StorablePoint h)))
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting
  (MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h)))
  (Storage h)
  (MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h)))
forall h h.
Lens
  (Storage h)
  (Storage h)
  (MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h)))
  (MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h)))
</span><a href="Marconi.Core.TracedStorable.html#events"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679132041"><span class="hs-identifier hs-var">cr</span></a></span><span> </span><span class="annot"><span class="annottext">SyntheticEvent (StorableEvent h) (StorablePoint h)
</span><a href="#local-6989586621679132043"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-319"></span><span>  </span><span class="annot"><span class="annottext">Storage h -&gt; StorableMonad h (Storage h)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h -&gt; StorableMonad h (Storage h))
-&gt; Storage h -&gt; StorableMonad h (Storage h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679132042"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Storage h -&gt; (Storage h -&gt; Storage h) -&gt; Storage h
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h)
forall h. Lens' (Storage h) Int
</span><a href="Marconi.Core.TracedStorable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h))
-&gt; (Int -&gt; Int) -&gt; Storage h -&gt; Storage h
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">%~</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span id="local-6989586621679132215"><span class="annot"><a href="Marconi.Core.TracedStorable.html#flushBuffer"><span class="hs-identifier hs-type">flushBuffer</span></a></span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Buffered"><span class="hs-identifier hs-type">Buffered</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132215"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-323"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132215"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#AppTracer"><span class="hs-identifier hs-type">AppTracer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132215"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-325"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132215"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-326"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132215"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132215"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-327"></span><span id="flushBuffer"><span class="annot"><span class="annottext">flushBuffer :: AppTracer h -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="Marconi.Core.TracedStorable.html#flushBuffer"><span class="hs-identifier hs-var hs-var">flushBuffer</span></a></span></span><span> </span><span id="local-6989586621679132038"><span class="annot"><span class="annottext">AppTracer h
</span><a href="#local-6989586621679132038"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679132037"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132037"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679132036"><span class="annot"><span class="annottext">cr :: Int
</span><a href="#local-6989586621679132036"><span class="hs-identifier hs-var hs-var">cr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132037"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting Int (State h) Int -&gt; Int
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h -&gt; Const Int (Storage h))
-&gt; State h -&gt; Const Int (State h)
forall h. Lens' (State h) (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span> </span><span class="annot"><span class="annottext">((Storage h -&gt; Const Int (Storage h))
 -&gt; State h -&gt; Const Int (State h))
-&gt; ((Int -&gt; Const Int Int) -&gt; Storage h -&gt; Const Int (Storage h))
-&gt; Getting Int (State h) Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Const Int Int) -&gt; Storage h -&gt; Const Int (Storage h)
forall h. Lens' (Storage h) Int
</span><a href="Marconi.Core.TracedStorable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span>
</span><span id="line-329"></span><span>      </span><span id="local-6989586621679132035"><span class="annot"><span class="annottext">es :: MVector
  (PrimState (StorableMonad h))
  (SyntheticEvent (StorableEvent h) (StorablePoint h))
</span><a href="#local-6989586621679132035"><span class="hs-identifier hs-var hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Storage h
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
forall h.
Storage h
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
</span><a href="Marconi.Core.TracedStorable.html#getMemoryEvents"><span class="hs-identifier hs-var">getMemoryEvents</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h
 -&gt; MVector
      (PrimState (StorableMonad h))
      (SyntheticEvent (StorableEvent h) (StorablePoint h)))
-&gt; Storage h
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132037"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting (Storage h) (State h) (Storage h) -&gt; Storage h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting (Storage h) (State h) (Storage h)
forall h. Lens' (State h) (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span>
</span><span id="line-330"></span><span>      </span><span id="local-6989586621679132034"><span class="annot"><span class="annottext">mx :: Int
</span><a href="#local-6989586621679132034"><span class="hs-identifier hs-var hs-var">mx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132037"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting Int (State h) Int -&gt; Int
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">(Config -&gt; Const Int Config) -&gt; State h -&gt; Const Int (State h)
forall h. Lens' (State h) Config
</span><a href="Marconi.Core.TracedStorable.html#config"><span class="hs-identifier hs-var">config</span></a></span><span> </span><span class="annot"><span class="annottext">((Config -&gt; Const Int Config) -&gt; State h -&gt; Const Int (State h))
-&gt; ((Int -&gt; Const Int Int) -&gt; Config -&gt; Const Int Config)
-&gt; Getting Int (State h) Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Const Int Int) -&gt; Config -&gt; Const Int Config
Iso' Config Int
</span><a href="Marconi.Core.TracedStorable.html#memoryBufferSize"><span class="hs-identifier hs-var">memoryBufferSize</span></a></span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679132034"><span class="hs-identifier hs-var">mx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679132036"><span class="hs-identifier hs-var">cr</span></a></span><span>
</span><span id="line-332"></span><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-333"></span><span>    </span><span id="local-6989586621679132033"><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679132033"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; [StorableEvent h]
forall (f :: * -&gt; *) h.
Foldable f =&gt;
f (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; [StorableEvent h]
</span><a href="Marconi.Core.TracedStorable.html#foldEvents"><span class="hs-identifier hs-var">foldEvents</span></a></span><span> </span><span class="annot"><span class="annottext">(Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))
 -&gt; [StorableEvent h])
-&gt; StorableMonad
     h (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h)))
-&gt; StorableMonad h [StorableEvent h]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MVector
  (PrimState (StorableMonad h))
  (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; StorableMonad
     h (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h)))
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MVector (PrimState m) a -&gt; m (Vector a)
</span><a href="../../../../vector/html/src"><span class="hs-identifier hs-var">V.freeze</span></a></span><span> </span><span class="annot"><span class="annottext">MVector
  (PrimState (StorableMonad h))
  (SyntheticEvent (StorableEvent h) (StorablePoint h))
</span><a href="#local-6989586621679132035"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-334"></span><span>    </span><span id="local-6989586621679132031"><span class="annot"><span class="annottext">h
</span><a href="#local-6989586621679132031"><span class="hs-identifier hs-var">h'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AppTracer h -&gt; [StorableEvent h] -&gt; h -&gt; StorableMonad h h
forall h (f :: * -&gt; *).
(Buffered h, Foldable f) =&gt;
AppTracer h -&gt; f (StorableEvent h) -&gt; h -&gt; StorableMonad h h
</span><a href="Marconi.Core.TracedStorable.html#persistToStorage"><span class="hs-identifier hs-var">persistToStorage</span></a></span><span> </span><span class="annot"><span class="annottext">AppTracer h
</span><a href="#local-6989586621679132038"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679132033"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132037"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting h (State h) h -&gt; h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting h (State h) h
forall h. Lens' (State h) h
</span><a href="Marconi.Core.TracedStorable.html#handle"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-335"></span><span>    </span><span class="annot"><span class="annottext">State h -&gt; StorableMonad h (State h)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(State h -&gt; StorableMonad h (State h))
-&gt; State h -&gt; StorableMonad h (State h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132037"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; (State h -&gt; State h) -&gt; State h
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h -&gt; Identity (Storage h))
-&gt; State h -&gt; Identity (State h)
forall h. Lens' (State h) (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span> </span><span class="annot"><span class="annottext">((Storage h -&gt; Identity (Storage h))
 -&gt; State h -&gt; Identity (State h))
-&gt; ((Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h))
-&gt; (Int -&gt; Identity Int)
-&gt; State h
-&gt; Identity (State h)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h)
forall h. Lens' (Storage h) Int
</span><a href="Marconi.Core.TracedStorable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Identity Int) -&gt; State h -&gt; Identity (State h))
-&gt; Int -&gt; State h -&gt; State h
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">.~</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-336"></span><span>             </span><span class="annot"><span class="annottext">State h -&gt; (State h -&gt; State h) -&gt; State h
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(h -&gt; Identity h) -&gt; State h -&gt; Identity (State h)
forall h. Lens' (State h) h
</span><a href="Marconi.Core.TracedStorable.html#handle"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">((h -&gt; Identity h) -&gt; State h -&gt; Identity (State h))
-&gt; h -&gt; State h -&gt; State h
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">.~</span></a></span><span> </span><span class="annot"><span class="annottext">h
</span><a href="#local-6989586621679132031"><span class="hs-identifier hs-var">h'</span></a></span><span>
</span><span id="line-337"></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">State h -&gt; StorableMonad h (State h)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132037"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-338"></span><span>
</span><span id="line-339"></span><span id="local-6989586621679132029"><span id="local-6989586621679132030"><span class="annot"><a href="Marconi.Core.TracedStorable.html#insertMany"><span class="hs-identifier hs-type">insertMany</span></a></span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Foldable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132030"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-341"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Buffered"><span class="hs-identifier hs-type">Buffered</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132029"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132029"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#HasPoint"><span class="hs-identifier hs-type">HasPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132029"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132029"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#ControlTracer"><span class="hs-identifier hs-type">ControlTracer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132029"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-345"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132030"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132029"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132029"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-347"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132029"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132029"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-348"></span><span id="insertMany"><span class="annot"><span class="annottext">insertMany :: ControlTracer h
-&gt; f (StorableEvent h) -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="Marconi.Core.TracedStorable.html#insertMany"><span class="hs-identifier hs-var hs-var">insertMany</span></a></span></span><span> </span><span id="local-6989586621679132028"><span class="annot"><span class="annottext">ControlTracer h
</span><a href="#local-6989586621679132028"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679132027"><span class="annot"><span class="annottext">f (StorableEvent h)
</span><a href="#local-6989586621679132027"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621679132026"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132026"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-349"></span><span>  </span><span class="annot"><span class="annottext">(State h -&gt; StorableEvent h -&gt; StorableMonad h (State h))
-&gt; State h -&gt; f (StorableEvent h) -&gt; StorableMonad h (State h)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldlM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679132025"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132025"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span id="local-6989586621679132024"><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679132024"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ControlTracer h
-&gt; StorableEvent h -&gt; State h -&gt; StorableMonad h (State h)
forall h.
(Buffered h, PrimMonad (StorableMonad h),
 HasPoint (StorableEvent h) (StorablePoint h)) =&gt;
ControlTracer h
-&gt; StorableEvent h -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="Marconi.Core.TracedStorable.html#insert"><span class="hs-identifier hs-var">insert</span></a></span><span> </span><span class="annot"><span class="annottext">ControlTracer h
</span><a href="#local-6989586621679132028"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679132024"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132025"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132026"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f (StorableEvent h)
</span><a href="#local-6989586621679132027"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span class="annot"><a href="Marconi.Core.TracedStorable.html#rewind"><span class="hs-identifier hs-type">rewind</span></a></span><span>
</span><span id="line-352"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679132023"><span class="annot"><a href="#local-6989586621679132023"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-353"></span><span>     </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Rewindable"><span class="hs-identifier hs-type">Rewindable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132023"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-354"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132023"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132023"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#HasPoint"><span class="hs-identifier hs-type">HasPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132023"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132023"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#ControlTracer"><span class="hs-identifier hs-type">ControlTracer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132023"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-358"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132023"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-359"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132023"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-360"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132023"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132023"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span id="rewind"><span class="annot"><span class="annottext">rewind :: ControlTracer h
-&gt; StorablePoint h -&gt; State h -&gt; StorableMonad h (Maybe (State h))
</span><a href="Marconi.Core.TracedStorable.html#rewind"><span class="hs-identifier hs-var hs-var">rewind</span></a></span></span><span> </span><span id="local-6989586621679132022"><span class="annot"><span class="annottext">ControlTracer h
</span><a href="#local-6989586621679132022"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679132021"><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679132021"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679132020"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132020"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-362"></span><span>  </span><span class="annot"><span class="annottext">ControlTracer h
-&gt; ControlNotification (StorablePoint h) (StorableNotifications h)
-&gt; StorableMonad h ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><a href="../../../../contra-tracer/html/src"><span class="hs-identifier hs-var">traceWith</span></a></span><span> </span><span class="annot"><span class="annottext">ControlTracer h
</span><a href="#local-6989586621679132022"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StorablePoint h
-&gt; ControlNotification (StorablePoint h) (StorableNotifications h)
forall pt n. pt -&gt; ControlNotification pt n
</span><a href="Marconi.Core.TracedStorable.html#CNRollBack"><span class="hs-identifier hs-var">CNRollBack</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679132021"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132020"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting Int (State h) Int -&gt; Int
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h -&gt; Const Int (Storage h))
-&gt; State h -&gt; Const Int (State h)
forall h. Lens' (State h) (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span> </span><span class="annot"><span class="annottext">((Storage h -&gt; Const Int (Storage h))
 -&gt; State h -&gt; Const Int (State h))
-&gt; ((Int -&gt; Const Int Int) -&gt; Storage h -&gt; Const Int (Storage h))
-&gt; Getting Int (State h) Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Const Int Int) -&gt; Storage h -&gt; Const Int (Storage h)
forall h. Lens' (Storage h) Int
</span><a href="Marconi.Core.TracedStorable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-364"></span><span>  </span><span class="hs-comment">-- Buffer is empty, rewind storage just in case:</span><span>
</span><span id="line-365"></span><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-366"></span><span>    </span><span class="annot"><span class="annottext">StorableMonad h (Maybe h) -&gt; StorableMonad h ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableMonad h (Maybe h) -&gt; StorableMonad h ())
-&gt; StorableMonad h (Maybe h) -&gt; StorableMonad h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AppTracer h -&gt; StorablePoint h -&gt; h -&gt; StorableMonad h (Maybe h)
forall h.
Rewindable h =&gt;
AppTracer h -&gt; StorablePoint h -&gt; h -&gt; StorableMonad h (Maybe h)
</span><a href="Marconi.Core.TracedStorable.html#rewindStorage"><span class="hs-identifier hs-var">rewindStorage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StorableNotifications h
 -&gt; ControlNotification (StorablePoint h) (StorableNotifications h))
-&gt; ControlTracer h -&gt; AppTracer h
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">StorableNotifications h
-&gt; ControlNotification (StorablePoint h) (StorableNotifications h)
forall pt n. n -&gt; ControlNotification pt n
</span><a href="Marconi.Core.TracedStorable.html#CNApplication"><span class="hs-identifier hs-var">CNApplication</span></a></span><span> </span><span class="annot"><span class="annottext">ControlTracer h
</span><a href="#local-6989586621679132022"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679132021"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132020"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting h (State h) h -&gt; h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting h (State h) h
forall h. Lens' (State h) h
</span><a href="Marconi.Core.TracedStorable.html#handle"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>    </span><span class="annot"><span class="annottext">Maybe (State h) -&gt; StorableMonad h (Maybe (State h))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (State h) -&gt; StorableMonad h (Maybe (State h)))
-&gt; Maybe (State h) -&gt; StorableMonad h (Maybe (State h))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Maybe (State h)
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132020"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-368"></span><span>  </span><span class="hs-comment">-- Something in buffer:</span><span>
</span><span id="line-369"></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-370"></span><span>    </span><span id="local-6989586621679132019"><span class="annot"><span class="annottext">Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))
</span><a href="#local-6989586621679132019"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVector
  (PrimState (StorableMonad h))
  (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; StorableMonad
     h (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h)))
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MVector (PrimState m) a -&gt; m (Vector a)
</span><a href="../../../../vector/html/src"><span class="hs-identifier hs-var">V.freeze</span></a></span><span> </span><span class="annot"><span class="annottext">(MVector
   (PrimState (StorableMonad h))
   (SyntheticEvent (StorableEvent h) (StorablePoint h))
 -&gt; StorableMonad
      h (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))))
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; StorableMonad
     h (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Int
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
forall s a. Int -&gt; Int -&gt; MVector s a -&gt; MVector s a
</span><a href="../../../../vector/html/src"><span class="hs-identifier hs-var">VM.slice</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132020"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting Int (State h) Int -&gt; Int
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h -&gt; Const Int (Storage h))
-&gt; State h -&gt; Const Int (State h)
forall h. Lens' (State h) (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span> </span><span class="annot"><span class="annottext">((Storage h -&gt; Const Int (Storage h))
 -&gt; State h -&gt; Const Int (State h))
-&gt; ((Int -&gt; Const Int Int) -&gt; Storage h -&gt; Const Int (Storage h))
-&gt; Getting Int (State h) Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Const Int Int) -&gt; Storage h -&gt; Const Int (Storage h)
forall h. Lens' (Storage h) Int
</span><a href="Marconi.Core.TracedStorable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132020"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h
-&gt; Getting
     (MVector
        (PrimState (StorableMonad h))
        (SyntheticEvent (StorableEvent h) (StorablePoint h)))
     (State h)
     (MVector
        (PrimState (StorableMonad h))
        (SyntheticEvent (StorableEvent h) (StorablePoint h)))
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h
 -&gt; Const
      (MVector
         (PrimState (StorableMonad h))
         (SyntheticEvent (StorableEvent h) (StorablePoint h)))
      (Storage h))
-&gt; State h
-&gt; Const
     (MVector
        (PrimState (StorableMonad h))
        (SyntheticEvent (StorableEvent h) (StorablePoint h)))
     (State h)
forall h. Lens' (State h) (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span> </span><span class="annot"><span class="annottext">((Storage h
  -&gt; Const
       (MVector
          (PrimState (StorableMonad h))
          (SyntheticEvent (StorableEvent h) (StorablePoint h)))
       (Storage h))
 -&gt; State h
 -&gt; Const
      (MVector
         (PrimState (StorableMonad h))
         (SyntheticEvent (StorableEvent h) (StorablePoint h)))
      (State h))
-&gt; ((MVector
       (PrimState (StorableMonad h))
       (SyntheticEvent (StorableEvent h) (StorablePoint h))
     -&gt; Const
          (MVector
             (PrimState (StorableMonad h))
             (SyntheticEvent (StorableEvent h) (StorablePoint h)))
          (MVector
             (PrimState (StorableMonad h))
             (SyntheticEvent (StorableEvent h) (StorablePoint h))))
    -&gt; Storage h
    -&gt; Const
         (MVector
            (PrimState (StorableMonad h))
            (SyntheticEvent (StorableEvent h) (StorablePoint h)))
         (Storage h))
-&gt; Getting
     (MVector
        (PrimState (StorableMonad h))
        (SyntheticEvent (StorableEvent h) (StorablePoint h)))
     (State h)
     (MVector
        (PrimState (StorableMonad h))
        (SyntheticEvent (StorableEvent h) (StorablePoint h)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(MVector
   (PrimState (StorableMonad h))
   (SyntheticEvent (StorableEvent h) (StorablePoint h))
 -&gt; Const
      (MVector
         (PrimState (StorableMonad h))
         (SyntheticEvent (StorableEvent h) (StorablePoint h)))
      (MVector
         (PrimState (StorableMonad h))
         (SyntheticEvent (StorableEvent h) (StorablePoint h))))
-&gt; Storage h
-&gt; Const
     (MVector
        (PrimState (StorableMonad h))
        (SyntheticEvent (StorableEvent h) (StorablePoint h)))
     (Storage h)
forall h h.
Lens
  (Storage h)
  (Storage h)
  (MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h)))
  (MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h)))
</span><a href="Marconi.Core.TracedStorable.html#events"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(SyntheticEvent (StorableEvent h) (StorablePoint h) -&gt; Bool)
-&gt; Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; Maybe Int
forall (v :: * -&gt; *) a.
Vector v a =&gt;
(a -&gt; Bool) -&gt; v a -&gt; Maybe Int
</span><a href="../../../../vector/html/src"><span class="hs-identifier hs-var">VG.findIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679132017"><span class="annot"><span class="annottext">SyntheticEvent (StorableEvent h) (StorablePoint h)
</span><a href="#local-6989586621679132017"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SyntheticEvent (StorableEvent h) (StorablePoint h)
-&gt; StorablePoint h
forall e p. HasPoint e p =&gt; SyntheticEvent e p -&gt; p
</span><a href="Marconi.Core.TracedStorable.html#syntheticPoint"><span class="hs-identifier hs-var">syntheticPoint</span></a></span><span> </span><span class="annot"><span class="annottext">SyntheticEvent (StorableEvent h) (StorablePoint h)
</span><a href="#local-6989586621679132017"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint h -&gt; StorablePoint h -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679132021"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))
</span><a href="#local-6989586621679132019"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-372"></span><span>      </span><span class="hs-comment">-- All of buffer is later than p, reset memory and rewind storage</span><span>
</span><span id="line-373"></span><span>      </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-374"></span><span>        </span><span class="annot"><span class="annottext">StorableMonad h (Maybe h) -&gt; StorableMonad h ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(StorableMonad h (Maybe h) -&gt; StorableMonad h ())
-&gt; StorableMonad h (Maybe h) -&gt; StorableMonad h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AppTracer h -&gt; StorablePoint h -&gt; h -&gt; StorableMonad h (Maybe h)
forall h.
Rewindable h =&gt;
AppTracer h -&gt; StorablePoint h -&gt; h -&gt; StorableMonad h (Maybe h)
</span><a href="Marconi.Core.TracedStorable.html#rewindStorage"><span class="hs-identifier hs-var">rewindStorage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StorableNotifications h
 -&gt; ControlNotification (StorablePoint h) (StorableNotifications h))
-&gt; ControlTracer h -&gt; AppTracer h
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">StorableNotifications h
-&gt; ControlNotification (StorablePoint h) (StorableNotifications h)
forall pt n. n -&gt; ControlNotification pt n
</span><a href="Marconi.Core.TracedStorable.html#CNApplication"><span class="hs-identifier hs-var">CNApplication</span></a></span><span> </span><span class="annot"><span class="annottext">ControlTracer h
</span><a href="#local-6989586621679132022"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679132021"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132020"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting h (State h) h -&gt; h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting h (State h) h
forall h. Lens' (State h) h
</span><a href="Marconi.Core.TracedStorable.html#handle"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>        </span><span class="annot"><span class="annottext">Maybe (State h) -&gt; StorableMonad h (Maybe (State h))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (State h) -&gt; StorableMonad h (Maybe (State h)))
-&gt; Maybe (State h) -&gt; StorableMonad h (Maybe (State h))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Maybe (State h)
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(State h -&gt; Maybe (State h)) -&gt; State h -&gt; Maybe (State h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132020"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; (State h -&gt; State h) -&gt; State h
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h -&gt; Identity (Storage h))
-&gt; State h -&gt; Identity (State h)
forall h. Lens' (State h) (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span> </span><span class="annot"><span class="annottext">((Storage h -&gt; Identity (Storage h))
 -&gt; State h -&gt; Identity (State h))
-&gt; ((Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h))
-&gt; (Int -&gt; Identity Int)
-&gt; State h
-&gt; Identity (State h)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h)
forall h. Lens' (Storage h) Int
</span><a href="Marconi.Core.TracedStorable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Identity Int) -&gt; State h -&gt; Identity (State h))
-&gt; Int -&gt; State h -&gt; State h
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">.~</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-376"></span><span>      </span><span class="hs-comment">-- Some of buffer is later than p, truncate memory to that</span><span>
</span><span id="line-377"></span><span>      </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679132015"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679132015"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (State h) -&gt; StorableMonad h (Maybe (State h))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (State h) -&gt; StorableMonad h (Maybe (State h)))
-&gt; Maybe (State h) -&gt; StorableMonad h (Maybe (State h))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Maybe (State h)
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(State h -&gt; Maybe (State h)) -&gt; State h -&gt; Maybe (State h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132020"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; (State h -&gt; State h) -&gt; State h
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h -&gt; Identity (Storage h))
-&gt; State h -&gt; Identity (State h)
forall h. Lens' (State h) (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span> </span><span class="annot"><span class="annottext">((Storage h -&gt; Identity (Storage h))
 -&gt; State h -&gt; Identity (State h))
-&gt; ((Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h))
-&gt; (Int -&gt; Identity Int)
-&gt; State h
-&gt; Identity (State h)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h)
forall h. Lens' (Storage h) Int
</span><a href="Marconi.Core.TracedStorable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Identity Int) -&gt; State h -&gt; Identity (State h))
-&gt; Int -&gt; State h -&gt; State h
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">.~</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679132015"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-378"></span><span>      </span><span class="hs-comment">-- No point is larger than p =&gt; everything is smaller. Since</span><span>
</span><span id="line-379"></span><span>      </span><span class="hs-comment">-- buffer was not empty then don't do anything:</span><span>
</span><span id="line-380"></span><span>      </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (State h) -&gt; StorableMonad h (Maybe (State h))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (State h) -&gt; StorableMonad h (Maybe (State h)))
-&gt; Maybe (State h) -&gt; StorableMonad h (Maybe (State h))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Maybe (State h)
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132020"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span id="local-6989586621679132014"><span class="annot"><a href="Marconi.Core.TracedStorable.html#resume"><span class="hs-identifier hs-type">resume</span></a></span><span>
</span><span id="line-383"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Resumable"><span class="hs-identifier hs-type">Resumable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132014"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-384"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#AppTracer"><span class="hs-identifier hs-type">AppTracer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132014"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-385"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132014"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-386"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132014"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132014"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-387"></span><span id="resume"><span class="annot"><span class="annottext">resume :: AppTracer h -&gt; State h -&gt; StorableMonad h [StorablePoint h]
</span><a href="Marconi.Core.TracedStorable.html#resume"><span class="hs-identifier hs-var hs-var">resume</span></a></span></span><span> </span><span id="local-6989586621679132013"><span class="annot"><span class="annottext">AppTracer h
</span><a href="#local-6989586621679132013"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679132012"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132012"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AppTracer h -&gt; h -&gt; StorableMonad h [StorablePoint h]
forall h.
Resumable h =&gt;
AppTracer h -&gt; h -&gt; StorableMonad h [StorablePoint h]
</span><a href="Marconi.Core.TracedStorable.html#resumeFromStorage"><span class="hs-identifier hs-var">resumeFromStorage</span></a></span><span> </span><span class="annot"><span class="annottext">AppTracer h
</span><a href="#local-6989586621679132013"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132012"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting h (State h) h -&gt; h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting h (State h) h
forall h. Lens' (State h) h
</span><a href="Marconi.Core.TracedStorable.html#handle"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span id="local-6989586621679132011"><span class="annot"><a href="Marconi.Core.TracedStorable.html#query"><span class="hs-identifier hs-type">query</span></a></span><span>
</span><span id="line-390"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#Queryable"><span class="hs-identifier hs-type">Queryable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132011"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-391"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132011"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#AppTracer"><span class="hs-identifier hs-type">AppTracer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132011"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132011"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-394"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132011"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-395"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableQuery"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132011"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-396"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132011"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Marconi.Core.TracedStorable.html#StorableResult"><span class="hs-identifier hs-type">StorableResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132011"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-397"></span><span id="query"><span class="annot"><span class="annottext">query :: AppTracer h
-&gt; StorablePoint h
-&gt; State h
-&gt; StorableQuery h
-&gt; StorableMonad h (StorableResult h)
</span><a href="Marconi.Core.TracedStorable.html#query"><span class="hs-identifier hs-var hs-var">query</span></a></span></span><span> </span><span id="local-6989586621679132010"><span class="annot"><span class="annottext">AppTracer h
</span><a href="#local-6989586621679132010"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679132009"><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679132009"><span class="hs-identifier hs-var">sp</span></a></span></span><span> </span><span id="local-6989586621679132008"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132008"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679132007"><span class="annot"><span class="annottext">StorableQuery h
</span><a href="#local-6989586621679132007"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-398"></span><span>  </span><span id="local-6989586621679132006"><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679132006"><span class="hs-identifier hs-var">es</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Storage h
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
forall h.
Storage h
-&gt; MVector
     (PrimState (StorableMonad h))
     (SyntheticEvent (StorableEvent h) (StorablePoint h))
</span><a href="Marconi.Core.TracedStorable.html#getMemoryEvents"><span class="hs-identifier hs-var">getMemoryEvents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132008"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting (Storage h) (State h) (Storage h) -&gt; Storage h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting (Storage h) (State h) (Storage h)
forall h. Lens' (State h) (Storage h)
</span><a href="Marconi.Core.TracedStorable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MVector
  (PrimState (StorableMonad h))
  (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; (MVector
      (PrimState (StorableMonad h))
      (SyntheticEvent (StorableEvent h) (StorablePoint h))
    -&gt; StorableMonad
         h (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))))
-&gt; StorableMonad
     h (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h)))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">MVector
  (PrimState (StorableMonad h))
  (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; StorableMonad
     h (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h)))
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MVector (PrimState m) a -&gt; m (Vector a)
</span><a href="../../../../vector/html/src"><span class="hs-identifier hs-var">V.freeze</span></a></span><span> </span><span class="annot"><span class="annottext">StorableMonad
  h (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h)))
-&gt; (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))
    -&gt; [StorableEvent h])
-&gt; StorableMonad h [StorableEvent h]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&amp;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[SyntheticEvent (StorableEvent h) (StorablePoint h)]
-&gt; [StorableEvent h]
forall (f :: * -&gt; *) h.
Foldable f =&gt;
f (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; [StorableEvent h]
</span><a href="Marconi.Core.TracedStorable.html#foldEvents"><span class="hs-identifier hs-var">foldEvents</span></a></span><span> </span><span class="annot"><span class="annottext">([SyntheticEvent (StorableEvent h) (StorablePoint h)]
 -&gt; [StorableEvent h])
-&gt; (Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))
    -&gt; [SyntheticEvent (StorableEvent h) (StorablePoint h)])
-&gt; Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; [StorableEvent h]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (SyntheticEvent (StorableEvent h) (StorablePoint h))
-&gt; [SyntheticEvent (StorableEvent h) (StorablePoint h)]
forall a. Vector a -&gt; [a]
</span><a href="../../../../vector/html/src"><span class="hs-identifier hs-var">V.toList</span></a></span><span>
</span><span id="line-399"></span><span>  </span><span class="annot"><span class="annottext">AppTracer h
-&gt; StorablePoint h
-&gt; [StorableEvent h]
-&gt; h
-&gt; StorableQuery h
-&gt; StorableMonad h (StorableResult h)
forall h (f :: * -&gt; *).
(Queryable h, Foldable f) =&gt;
AppTracer h
-&gt; StorablePoint h
-&gt; f (StorableEvent h)
-&gt; h
-&gt; StorableQuery h
-&gt; StorableMonad h (StorableResult h)
</span><a href="Marconi.Core.TracedStorable.html#queryStorage"><span class="hs-identifier hs-var">queryStorage</span></a></span><span> </span><span class="annot"><span class="annottext">AppTracer h
</span><a href="#local-6989586621679132010"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679132009"><span class="hs-identifier hs-var">sp</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679132006"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679132008"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting h (State h) h -&gt; h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting h (State h) h
forall h. Lens' (State h) h
</span><a href="Marconi.Core.TracedStorable.html#handle"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StorableQuery h
</span><a href="#local-6989586621679132007"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-400"></span></pre></body></html>