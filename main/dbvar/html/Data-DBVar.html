<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Data.DBVar</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">dbvar-2021.8.23: Mutable variables that are written to disk using delta encodings.</span><ul class="links" id="page-menu"><li><a href="src/Data.DBVar.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Data.DBVar</p></div><div id="table-of-contents"><div id="contents-list"><p class="caption" onclick="window.scrollTo(0,0)">Contents</p><ul><li><a href="#g:1">Synopsis</a></li><li><a href="#g:2">DBVar</a></li><li><a href="#g:3">Store</a></li><li><a href="#g:4">Testing</a></li></ul></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><span class="keyword">data</span> <a href="#t:DBVar">DBVar</a> m delta</li><li class="src short"><a href="#v:readDBVar">readDBVar</a> :: (<a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da, a ~ <a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a> da) =&gt; <a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a> m da -&gt; m a</li><li class="src short"><a href="#v:updateDBVar">updateDBVar</a> :: (<a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da, <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Monad.html#t:Monad" title="Control.Monad">Monad</a> m) =&gt; <a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a> m da -&gt; da -&gt; m ()</li><li class="src short"><a href="#v:modifyDBVar">modifyDBVar</a> :: (<a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da, <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Monad.html#t:Monad" title="Control.Monad">Monad</a> m, a ~ <a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a> da) =&gt; <a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a> m da -&gt; (a -&gt; (da, b)) -&gt; m b</li><li class="src short"><a href="#v:modifyDBMaybe">modifyDBMaybe</a> :: (<a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da, <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Monad.html#t:Monad" title="Control.Monad">Monad</a> m, a ~ <a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a> da) =&gt; <a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a> m da -&gt; (a -&gt; (<a href="../../ghc/html/libraries/base-4.14.3.0/Data-Maybe.html#t:Maybe" title="Data.Maybe">Maybe</a> da, b)) -&gt; m b</li><li class="src short"><a href="#v:initDBVar">initDBVar</a> :: (<a href="../../io-classes/html/Control-Monad-Class-MonadSTM.html#t:MonadSTM" title="Control.Monad.Class.MonadSTM">MonadSTM</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadThrow" title="Control.Monad.Class.MonadThrow">MonadThrow</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadEvaluate" title="Control.Monad.Class.MonadThrow">MonadEvaluate</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadMask" title="Control.Monad.Class.MonadThrow">MonadMask</a> m, <a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da, a ~ <a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a> da) =&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m da -&gt; a -&gt; m (<a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a> m da)</li><li class="src short"><a href="#v:loadDBVar">loadDBVar</a> :: (<a href="../../io-classes/html/Control-Monad-Class-MonadSTM.html#t:MonadSTM" title="Control.Monad.Class.MonadSTM">MonadSTM</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadThrow" title="Control.Monad.Class.MonadThrow">MonadThrow</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadEvaluate" title="Control.Monad.Class.MonadThrow">MonadEvaluate</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadMask" title="Control.Monad.Class.MonadThrow">MonadMask</a> m, <a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da) =&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m da -&gt; m (<a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a> m da)</li><li class="src short"><span class="keyword">data</span> <a href="#t:Store">Store</a> m da = <a href="#v:Store">Store</a> {<ul class="subs"><li><a href="#v:loadS">loadS</a> :: m (<a href="../../ghc/html/libraries/base-4.14.3.0/Data-Either.html#t:Either" title="Data.Either">Either</a> <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Exception-Base.html#t:SomeException" title="Control.Exception.Base">SomeException</a> (<a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a> da))</li><li><a href="#v:writeS">writeS</a> :: <a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a> da -&gt; m ()</li><li><a href="#v:updateS">updateS</a> :: <a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a> da -&gt; da -&gt; m ()</li></ul>}</li><li class="src short"><a href="#v:newStore">newStore</a> :: (<a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da, <a href="../../io-classes/html/Control-Monad-Class-MonadSTM.html#t:MonadSTM" title="Control.Monad.Class.MonadSTM">MonadSTM</a> m) =&gt; m (<a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m da)</li><li class="src short"><span class="keyword">data</span> <a href="#t:NotInitialized">NotInitialized</a> = <a href="#v:NotInitialized">NotInitialized</a></li><li class="src short"><a href="#v:embedStore">embedStore</a> :: (<a href="../../io-classes/html/Control-Monad-Class-MonadSTM.html#t:MonadSTM" title="Control.Monad.Class.MonadSTM">MonadSTM</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadMask" title="Control.Monad.Class.MonadThrow">MonadMask</a> m, <a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da) =&gt; <a href="Data-Delta.html#t:Embedding" title="Data.Delta">Embedding</a> da db -&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m db -&gt; m (<a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m da)</li><li class="src short"><a href="#v:pairStores">pairStores</a> :: <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Monad.html#t:Monad" title="Control.Monad">Monad</a> m =&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m da -&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m db -&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m (da, db)</li><li class="src short"><a href="#v:embedStore-39-">embedStore'</a> :: (<a href="../../ghc/html/libraries/base-4.14.3.0/Control-Monad.html#t:Monad" title="Control.Monad">Monad</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadThrow" title="Control.Monad.Class.MonadThrow">MonadThrow</a> m) =&gt; <a href="Data-Delta.html#t:Embedding-39-" title="Data.Delta">Embedding'</a> da db -&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m db -&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m da</li></ul></details></div><div id="interface"><a href="#g:1" id="g:1"><h1>Synopsis</h1></a><div class="doc"><p><code><a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a></code> represents a mutable variable whose value is kept in memory,
 but which is written to the hard drive on every update.
 This provides a convenient interface for persisting
 values across program runs.
 For efficient updates, delta encodings are used, see <a href="Data-Delta.html">Data.Delta</a>.</p><p><code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code> represent a storage facility to which the <code><a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a></code>
 is written.</p></div><a href="#g:2" id="g:2"><h1>DBVar</h1></a><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:DBVar" class="def">DBVar</a> m delta <a href="src/Data.DBVar.html#DBVar" class="link">Source</a> <a href="#t:DBVar" class="selflink">#</a></p><div class="doc"><p>A <code><a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a></code><code> m delta</code> is a mutable reference to a Haskell value of type <code>a</code>.
 The type <code>delta</code> is a delta encoding for this value type <code>a</code>,
 that is we have <code>a ~ </code><code><a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a></code><code> delta</code>.</p><p>The Haskell value is cached in memory, in weak head normal form (WHNF).
 However, whenever the value is updated, a copy of will be written
 to persistent storage like a file or database on the hard disk;
 any particular storage is specified by the <code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code> type.
 For efficient updates, the delta encoding <code>delta</code> is used in the update.</p><p>Concurrency:</p><ul><li>Updates are atomic and will block other updates.</li><li>Reads will <em>not</em> be blocked during an update
   (except for a small moment where the new value atomically
    replaces the old one).</li></ul></div></div><div class="top"><p class="src"><a id="v:readDBVar" class="def">readDBVar</a> :: (<a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da, a ~ <a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a> da) =&gt; <a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a> m da -&gt; m a <a href="src/Data.DBVar.html#readDBVar" class="link">Source</a> <a href="#v:readDBVar" class="selflink">#</a></p><div class="doc"><p>Read the current value of the <code><a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a></code>.</p></div></div><div class="top"><p class="src"><a id="v:updateDBVar" class="def">updateDBVar</a> :: (<a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da, <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Monad.html#t:Monad" title="Control.Monad">Monad</a> m) =&gt; <a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a> m da -&gt; da -&gt; m () <a href="src/Data.DBVar.html#updateDBVar" class="link">Source</a> <a href="#v:updateDBVar" class="selflink">#</a></p><div class="doc"><p>Update the value of the <code><a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a></code> using a delta encoding.</p><p>The new value will be evaluated to weak head normal form.</p></div></div><div class="top"><p class="src"><a id="v:modifyDBVar" class="def">modifyDBVar</a> :: (<a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da, <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Monad.html#t:Monad" title="Control.Monad">Monad</a> m, a ~ <a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a> da) =&gt; <a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a> m da -&gt; (a -&gt; (da, b)) -&gt; m b <a href="src/Data.DBVar.html#modifyDBVar" class="link">Source</a> <a href="#v:modifyDBVar" class="selflink">#</a></p><div class="doc"><p>Modify the value in a <code><a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a></code>.</p><p>The new value will be evaluated to weak head normal form.</p></div></div><div class="top"><p class="src"><a id="v:modifyDBMaybe" class="def">modifyDBMaybe</a> :: (<a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da, <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Monad.html#t:Monad" title="Control.Monad">Monad</a> m, a ~ <a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a> da) =&gt; <a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a> m da -&gt; (a -&gt; (<a href="../../ghc/html/libraries/base-4.14.3.0/Data-Maybe.html#t:Maybe" title="Data.Maybe">Maybe</a> da, b)) -&gt; m b <a href="src/Data.DBVar.html#modifyDBMaybe" class="link">Source</a> <a href="#v:modifyDBMaybe" class="selflink">#</a></p><div class="doc"><p>Maybe modify the value in a <code><a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a></code></p><p>If updated, the new value will be evaluated to weak head normal form.</p></div></div><div class="top"><p class="src"><a id="v:initDBVar" class="def">initDBVar</a> <a href="src/Data.DBVar.html#initDBVar" class="link">Source</a> <a href="#v:initDBVar" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: (<a href="../../io-classes/html/Control-Monad-Class-MonadSTM.html#t:MonadSTM" title="Control.Monad.Class.MonadSTM">MonadSTM</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadThrow" title="Control.Monad.Class.MonadThrow">MonadThrow</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadEvaluate" title="Control.Monad.Class.MonadThrow">MonadEvaluate</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadMask" title="Control.Monad.Class.MonadThrow">MonadMask</a> m, <a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da, a ~ <a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a> da)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m da</td><td class="doc"><p><code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code> for writing.</p></td></tr><tr><td class="src">-&gt; a</td><td class="doc"><p>Initial value.</p></td></tr><tr><td class="src">-&gt; m (<a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a> m da)</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Initialize a new <code><a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a></code> for a given <code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code>.</p></div></div><div class="top"><p class="src"><a id="v:loadDBVar" class="def">loadDBVar</a> <a href="src/Data.DBVar.html#loadDBVar" class="link">Source</a> <a href="#v:loadDBVar" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: (<a href="../../io-classes/html/Control-Monad-Class-MonadSTM.html#t:MonadSTM" title="Control.Monad.Class.MonadSTM">MonadSTM</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadThrow" title="Control.Monad.Class.MonadThrow">MonadThrow</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadEvaluate" title="Control.Monad.Class.MonadThrow">MonadEvaluate</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadMask" title="Control.Monad.Class.MonadThrow">MonadMask</a> m, <a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m da</td><td class="doc"><p><code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code> for writing and for reading the initial value.</p></td></tr><tr><td class="src">-&gt; m (<a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a> m da)</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Create a <code><a href="Data-DBVar.html#t:DBVar" title="Data.DBVar">DBVar</a></code> by loading its value from an existing <code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code>
 Throws an exception if the value cannot be loaded.</p></div></div><a href="#g:3" id="g:3"><h1>Store</h1></a><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:Store" class="def">Store</a> m da <a href="src/Data.DBVar.html#Store" class="link">Source</a> <a href="#t:Store" class="selflink">#</a></p><div class="doc"><p>A <code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code> is a storage facility for Haskell values of type <code>a ~</code><code><a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a></code><code> da</code>.
Typical use cases are a file or a database on the hard disk.</p><p>A <code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code> has many similarities with an <code><a href="Data-Delta.html#t:Embedding" title="Data.Delta">Embedding</a></code>.
The main difference is that storing value in a <code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code> has side effects.
A <code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code> is described by three action:</p><ul><li><code><a href="Data-DBVar.html#v:writeS" title="Data.DBVar">writeS</a></code> writes a value to the store.</li><li><code><a href="Data-DBVar.html#v:loadS" title="Data.DBVar">loadS</a></code> loads a value from the store.</li><li><code><a href="Data-DBVar.html#v:updateS" title="Data.DBVar">updateS</a></code> uses a delta encoding of type <code>da</code> to efficiently update
    the store.
    In order to avoid performing an expensive <code><a href="Data-DBVar.html#v:loadS" title="Data.DBVar">loadS</a></code> operation,
    the action <code><a href="Data-DBVar.html#v:updateS" title="Data.DBVar">updateS</a></code> expects the value described by the store
    as an argument, but no check is performed whether the provided
    value matches the contents of the store.
    Also, not every store inspects this argument.</li></ul><p>A <code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code> is characterized by the following properties:</p><ul><li><p>The store <strong>need not contain</strong> a properly formatted <strong>value</strong>:
    Loading a value from the store may fail, and this is why <code><a href="Data-DBVar.html#v:loadS" title="Data.DBVar">loadS</a></code>
    has an <code><a href="../../ghc/html/libraries/base-4.14.3.0/Data-Either.html#t:Either" title="Data.Either">Either</a></code> result.
    For example, if the <code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code> represents
    a file on disk, then the file may corrupted or in an incompatible
    file format when first opened.
    In such a case of failure, the result <code><a href="../../ghc/html/libraries/base-4.14.3.0/Data-Either.html#v:Left" title="Data.Either">Left</a></code><code> (e :: </code><code><a href="../../ghc/html/libraries/base-4.14.3.0/Control-Exception-Base.html#t:SomeException" title="Control.Exception.Base">SomeException</a></code><code>)</code>
    is returned, where the exception <code>e</code> gives more information
    about the failure.</p><p>However, loading a value after writing it should always succeed,
we have</p><pre>writeS s a &gt;&gt; loadS s  =  pure (Right a)</pre></li><li><p>The store is <strong>redundant</strong>:
    Two stores with different contents may describe
    the same value of type <code>a</code>.
    For example, two files with different whitespace
    may describe the same JSON value.
    In general, we have</p><pre>loadS s &gt;&gt;= either (const $ pure ()) (writeS s) &#8800;  pure ()</pre></li><li><p>Updating a store <strong>commutes with <code><a href="Data-Delta.html#v:apply" title="Data.Delta">apply</a></code></strong>:
    We have</p><pre>updateS s a da &gt;&gt; loadS s  =  pure $ Right $ apply a da</pre><p>However, since the store is redundant, we often have</p><pre>updateS s a da  &#8800;  writeS s (apply a da)</pre></li><li><strong>Exceptions</strong>:
    It is expected that the functions <code><a href="Data-DBVar.html#v:loadS" title="Data.DBVar">loadS</a></code>, <code><a href="Data-DBVar.html#v:updateS" title="Data.DBVar">updateS</a></code>, <code><a href="Data-DBVar.html#v:writeS" title="Data.DBVar">writeS</a></code>
    do not throw synchronous exceptions. In the worst case,
    <code><a href="Data-DBVar.html#v:loadS" title="Data.DBVar">loadS</a></code> should return <code><a href="../../ghc/html/libraries/base-4.14.3.0/Data-Either.html#v:Left" title="Data.Either">Left</a></code> after reading or writing
    to the store was unsuccessful.</li><li><strong>Concurrency</strong>:
    It is expected that the functions <code><a href="Data-DBVar.html#v:updateS" title="Data.DBVar">updateS</a></code> and <code><a href="Data-DBVar.html#v:writeS" title="Data.DBVar">writeS</a></code>
    are <em>atomic</em>: Either they succeed in updating / writing
    the new value in its entirety, or the old value is kept.
    In particular, we expect this even when one of these
    functions receives an asynchronous exception and needs to abort
    normal operation.</li></ul></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:Store" class="def">Store</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:loadS" class="def">loadS</a> :: m (<a href="../../ghc/html/libraries/base-4.14.3.0/Data-Either.html#t:Either" title="Data.Either">Either</a> <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Exception-Base.html#t:SomeException" title="Control.Exception.Base">SomeException</a> (<a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a> da))</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:writeS" class="def">writeS</a> :: <a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a> da -&gt; m ()</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:updateS" class="def">updateS</a> :: <a href="Data-Delta.html#t:Base" title="Data.Delta">Base</a> da -&gt; da -&gt; m ()</dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr></table></div></div><div class="top"><p class="src"><a id="v:newStore" class="def">newStore</a> :: (<a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da, <a href="../../io-classes/html/Control-Monad-Class-MonadSTM.html#t:MonadSTM" title="Control.Monad.Class.MonadSTM">MonadSTM</a> m) =&gt; m (<a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m da) <a href="src/Data.DBVar.html#newStore" class="link">Source</a> <a href="#v:newStore" class="selflink">#</a></p><div class="doc"><p>An in-memory <code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code> from a mutable variable (<code>TVar</code>).
 Useful for testing.</p></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:NotInitialized" class="def">NotInitialized</a> <a href="src/Data.DBVar.html#NotInitialized" class="link">Source</a> <a href="#t:NotInitialized" class="selflink">#</a></p><div class="doc"><p>$EitherSomeException</p><p>NOTE: [EitherSomeException]</p><p>In this version of the library, the error case returned by <code><a href="Data-DBVar.html#v:loadS" title="Data.DBVar">loadS</a></code> and <code><a href="Data-Delta.html#v:load" title="Data.Delta">load</a></code>
is the general <code><a href="../../ghc/html/libraries/base-4.14.3.0/Control-Exception-Base.html#t:SomeException" title="Control.Exception.Base">SomeException</a></code> type, which is a disjoint sum of all possible
error types (that is, members of the <code><a href="../../ghc/html/libraries/base-4.14.3.0/Control-Exception-Base.html#t:Exception" title="Control.Exception.Base">Exception</a></code> class).</p><p>In a future version of this library, this may be replaced by a more specific
error type, but at the price of introducing a new type parameter <code>e</code> in the
<code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code> type.</p><p>For now, I have opted to explore a region of the design space
where the number of type parameters is kept to a minimum.
I would argue that making errors visible on the type level is not as
useful as one might hope for, because in exchange for making the types noisier,
the amount of type-safety we gain is very small.
Specifically, if we encounter an element of the <code><a href="../../ghc/html/libraries/base-4.14.3.0/Control-Exception-Base.html#t:SomeException" title="Control.Exception.Base">SomeException</a></code> type that
we did not expect, it is entirely ok to <code>throw</code> it.
For example, consider the following code:
<code>
let ea :: Either SomeException ()
    ea = [..]
in
    case ea of
        Right _ -&gt; &quot;everything is ok&quot;
        Left e -&gt; case fromException e of
            Just (AssertionFailed _) -&gt; &quot;bad things happened&quot;
            Nothing -&gt; throw e
</code>
In this example, using the more specific type <code>ea :: Either AssertionFailed ()</code>
would have eliminated the need to handle the <code><a href="../../ghc/html/libraries/base-4.14.3.0/Data-Maybe.html#v:Nothing" title="Data.Maybe">Nothing</a></code> case.
But as we are dealing with exceptions, this case does have a default handler,
and there is less need to exclude it at compile as opposed to, say,
the case of an empty list.</p><p>Failure that occurs when calling <code><a href="Data-DBVar.html#v:loadS" title="Data.DBVar">loadS</a></code> on a <code><a href="Data-DBVar.html#v:newStore" title="Data.DBVar">newStore</a></code> that is empty.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:NotInitialized" class="def">NotInitialized</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="subs instances"><h4 class="instances details-toggle-control details-toggle" data-details-id="i:NotInitialized">Instances</h4><details id="i:NotInitialized" open="open"><summary class="hide-when-js-enabled">Instances details</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:NotInitialized:Eq:1"></span> <a href="../../ghc/html/libraries/base-4.14.3.0/Data-Eq.html#t:Eq" title="Data.Eq">Eq</a> <a href="Data-DBVar.html#t:NotInitialized" title="Data.DBVar">NotInitialized</a></span> <a href="src/Data.DBVar.html#line-302" class="link">Source</a> <a href="#t:NotInitialized" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:NotInitialized:Eq:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Data-DBVar.html">Data.DBVar</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:-61--61-">(==)</a> :: <a href="Data-DBVar.html#t:NotInitialized" title="Data.DBVar">NotInitialized</a> -&gt; <a href="Data-DBVar.html#t:NotInitialized" title="Data.DBVar">NotInitialized</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a> <a href="../../ghc/html/libraries/ghc-prim-0.6.1/src" class="link">Source</a> <a href="#v:-61--61-" class="selflink">#</a></p><p class="src"><a href="#v:-47--61-">(/=)</a> :: <a href="Data-DBVar.html#t:NotInitialized" title="Data.DBVar">NotInitialized</a> -&gt; <a href="Data-DBVar.html#t:NotInitialized" title="Data.DBVar">NotInitialized</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a> <a href="../../ghc/html/libraries/ghc-prim-0.6.1/src" class="link">Source</a> <a href="#v:-47--61-" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:NotInitialized:Show:2"></span> <a href="../../ghc/html/libraries/base-4.14.3.0/Text-Show.html#t:Show" title="Text.Show">Show</a> <a href="Data-DBVar.html#t:NotInitialized" title="Data.DBVar">NotInitialized</a></span> <a href="src/Data.DBVar.html#line-302" class="link">Source</a> <a href="#t:NotInitialized" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:NotInitialized:Show:2"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Data-DBVar.html">Data.DBVar</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:showsPrec">showsPrec</a> :: <a href="../../ghc/html/libraries/base-4.14.3.0/Data-Int.html#t:Int" title="Data.Int">Int</a> -&gt; <a href="Data-DBVar.html#t:NotInitialized" title="Data.DBVar">NotInitialized</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/Text-Show.html#t:ShowS" title="Text.Show">ShowS</a> <a href="../../ghc/html/libraries/base-4.14.3.0/src" class="link">Source</a> <a href="#v:showsPrec" class="selflink">#</a></p><p class="src"><a href="#v:show">show</a> :: <a href="Data-DBVar.html#t:NotInitialized" title="Data.DBVar">NotInitialized</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/Data-String.html#t:String" title="Data.String">String</a> <a href="../../ghc/html/libraries/base-4.14.3.0/src" class="link">Source</a> <a href="#v:show" class="selflink">#</a></p><p class="src"><a href="#v:showList">showList</a> :: [<a href="Data-DBVar.html#t:NotInitialized" title="Data.DBVar">NotInitialized</a>] -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/Text-Show.html#t:ShowS" title="Text.Show">ShowS</a> <a href="../../ghc/html/libraries/base-4.14.3.0/src" class="link">Source</a> <a href="#v:showList" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:NotInitialized:Exception:3"></span> <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Exception-Base.html#t:Exception" title="Control.Exception.Base">Exception</a> <a href="Data-DBVar.html#t:NotInitialized" title="Data.DBVar">NotInitialized</a></span> <a href="src/Data.DBVar.html#line-303" class="link">Source</a> <a href="#t:NotInitialized" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:NotInitialized:Exception:3"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Data-DBVar.html">Data.DBVar</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:toException">toException</a> :: <a href="Data-DBVar.html#t:NotInitialized" title="Data.DBVar">NotInitialized</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Exception-Base.html#t:SomeException" title="Control.Exception.Base">SomeException</a> <a href="../../ghc/html/libraries/base-4.14.3.0/src" class="link">Source</a> <a href="#v:toException" class="selflink">#</a></p><p class="src"><a href="#v:fromException">fromException</a> :: <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Exception-Base.html#t:SomeException" title="Control.Exception.Base">SomeException</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/Data-Maybe.html#t:Maybe" title="Data.Maybe">Maybe</a> <a href="Data-DBVar.html#t:NotInitialized" title="Data.DBVar">NotInitialized</a> <a href="../../ghc/html/libraries/base-4.14.3.0/src" class="link">Source</a> <a href="#v:fromException" class="selflink">#</a></p><p class="src"><a href="#v:displayException">displayException</a> :: <a href="Data-DBVar.html#t:NotInitialized" title="Data.DBVar">NotInitialized</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/Data-String.html#t:String" title="Data.String">String</a> <a href="../../ghc/html/libraries/base-4.14.3.0/src" class="link">Source</a> <a href="#v:displayException" class="selflink">#</a></p></div></details></td></tr></table></details></div></div><div class="top"><p class="src"><a id="v:embedStore" class="def">embedStore</a> :: (<a href="../../io-classes/html/Control-Monad-Class-MonadSTM.html#t:MonadSTM" title="Control.Monad.Class.MonadSTM">MonadSTM</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadMask" title="Control.Monad.Class.MonadThrow">MonadMask</a> m, <a href="Data-Delta.html#t:Delta" title="Data.Delta">Delta</a> da) =&gt; <a href="Data-Delta.html#t:Embedding" title="Data.Delta">Embedding</a> da db -&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m db -&gt; m (<a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m da) <a href="src/Data.DBVar.html#embedStore" class="link">Source</a> <a href="#v:embedStore" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:pairStores" class="def">pairStores</a> :: <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Monad.html#t:Monad" title="Control.Monad">Monad</a> m =&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m da -&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m db -&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m (da, db) <a href="src/Data.DBVar.html#pairStores" class="link">Source</a> <a href="#v:pairStores" class="selflink">#</a></p><div class="doc"><p>Combine two <code>Stores</code> into a store for pairs.</p><p>WARNING: The <code><a href="Data-DBVar.html#v:updateS" title="Data.DBVar">updateS</a></code> and <code><a href="Data-DBVar.html#v:writeS" title="Data.DBVar">writeS</a></code> functions of the result are not atomic
 in the presence of asynchronous exceptions.
 For example, the update of the first store may succeed while the update of
 the second store may fail.
 In other words, this combinator works for some monads, such as <code>m = </code><code>STM</code>,
 but fails for others, such as <code>m = <code><a href="../../ghc/html/libraries/base-4.14.3.0/System-IO.html#t:IO" title="System.IO">IO</a></code></code>.</p></div></div><a href="#g:4" id="g:4"><h1>Testing</h1></a><div class="top"><p class="src"><a id="v:embedStore-39-" class="def">embedStore'</a> :: (<a href="../../ghc/html/libraries/base-4.14.3.0/Control-Monad.html#t:Monad" title="Control.Monad">Monad</a> m, <a href="../../io-classes/html/Control-Monad-Class-MonadThrow.html#t:MonadThrow" title="Control.Monad.Class.MonadThrow">MonadThrow</a> m) =&gt; <a href="Data-Delta.html#t:Embedding-39-" title="Data.Delta">Embedding'</a> da db -&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m db -&gt; <a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a> m da <a href="src/Data.DBVar.html#embedStore%27" class="link">Source</a> <a href="#v:embedStore-39-" class="selflink">#</a></p><div class="doc"><p>Obtain a <code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code> for one type <code>a1</code> from a <code><a href="Data-DBVar.html#t:Store" title="Data.DBVar">Store</a></code> for another type <code>a2</code>
 via an <code><a href="Data-Delta.html#t:Embedding-39-" title="Data.Delta">Embedding'</a></code> of the first type into the second type.</p><p>Note: This function is exported for testing and documentation only,
 use the more efficient <code><a href="Data-DBVar.html#v:embedStore" title="Data.DBVar">embedStore</a></code> instead.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.24.2</p></div></body></html>