<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# OPTIONS_GHC -Wno-redundant-constraints#-}</span><span>
</span><span id="line-2"></span><span class="hs-comment">-- We intentionally specify more constraints than necessary for some exports.</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.DBVar</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Synopsis</span></span><span>
</span><span id="line-10"></span><span>    </span><span class="hs-comment">-- | 'DBVar' represents a mutable variable whose value is kept in memory,</span><span>
</span><span id="line-11"></span><span>    </span><span class="hs-comment">-- but which is written to the hard drive on every update.</span><span>
</span><span id="line-12"></span><span>    </span><span class="hs-comment">-- This provides a convenient interface for persisting</span><span>
</span><span id="line-13"></span><span>    </span><span class="hs-comment">-- values across program runs.</span><span>
</span><span id="line-14"></span><span>    </span><span class="hs-comment">-- For efficient updates, delta encodings are used, see &quot;Data.Delta&quot;.</span><span>
</span><span id="line-15"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-16"></span><span>    </span><span class="hs-comment">-- 'Store' represent a storage facility to which the 'DBVar'</span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-comment">-- is written.</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><span class="hs-comment">-- * DBVar</span></span><span>
</span><span id="line-20"></span><span>      </span><span class="annot"><a href="Data.DBVar.html#DBVar"><span class="hs-identifier">DBVar</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.DBVar.html#readDBVar"><span class="hs-identifier">readDBVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.DBVar.html#updateDBVar"><span class="hs-identifier">updateDBVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.DBVar.html#modifyDBVar"><span class="hs-identifier">modifyDBVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.DBVar.html#modifyDBMaybe"><span class="hs-identifier">modifyDBMaybe</span></a></span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.DBVar.html#initDBVar"><span class="hs-identifier">initDBVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.DBVar.html#loadDBVar"><span class="hs-identifier">loadDBVar</span></a></span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Store</span></span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.DBVar.html#Store"><span class="hs-identifier">Store</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.DBVar.html#newStore"><span class="hs-identifier">newStore</span></a></span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.DBVar.html#NotInitialized"><span class="hs-identifier">NotInitialized</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><span class="hs-comment">-- $EitherSomeException</span></span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.DBVar.html#embedStore"><span class="hs-identifier">embedStore</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.DBVar.html#pairStores"><span class="hs-identifier">pairStores</span></a></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Testing</span></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.DBVar.html#embedStore%27"><span class="hs-identifier">embedStore'</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Prelude</span></a></span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Applicative</span></a></span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">liftA2</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Exception</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">SomeException</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">toException</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">Control.Monad.Class.MonadSTM</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">MonadSTM</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">atomically</span></a></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">modifyTVar'</span></a></span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">newTVarIO</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">readTVar</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">readTVarIO</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">retry</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">writeTVar</span></a></span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></a></span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">MonadEvaluate</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">MonadMask</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">MonadThrow</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">bracket</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">evaluate</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">mask</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier">throwIO</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Delta.html"><span class="hs-identifier">Data.Delta</span></a></span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Data.Delta.html#Delta"><span class="hs-identifier">Delta</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Delta.html#Embedding"><span class="hs-identifier">Embedding</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Delta.html#Embedding%27"><span class="hs-identifier">Embedding'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Delta.html#Machine"><span class="hs-identifier">Machine</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Delta.html#inject"><span class="hs-identifier">inject</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Delta.html#project"><span class="hs-identifier">project</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    DBVar
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- | A 'DBVar'@ m delta@ is a mutable reference to a Haskell value of type @a@.</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- The type @delta@ is a delta encoding for this value type @a@,</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- that is we have @a ~ @'Base'@ delta@.</span><span>
</span><span id="line-62"></span><span class="hs-comment">--</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- The Haskell value is cached in memory, in weak head normal form (WHNF).</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- However, whenever the value is updated, a copy of will be written</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- to persistent storage like a file or database on the hard disk;</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- any particular storage is specified by the 'Store' type.</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- For efficient updates, the delta encoding @delta@ is used in the update.</span><span>
</span><span id="line-68"></span><span class="hs-comment">--</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- Concurrency:</span><span>
</span><span id="line-70"></span><span class="hs-comment">--</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- * Updates are atomic and will block other updates.</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- * Reads will /not/ be blocked during an update</span><span>
</span><span id="line-73"></span><span class="hs-comment">--   (except for a small moment where the new value atomically</span><span>
</span><span id="line-74"></span><span class="hs-comment">--    replaces the old one).</span><span>
</span><span id="line-75"></span><span class="hs-keyword">data</span><span> </span><span id="DBVar"><span class="annot"><a href="Data.DBVar.html#DBVar"><span class="hs-identifier hs-var">DBVar</span></a></span></span><span> </span><span id="local-6989586621679209762"><span class="annot"><a href="#local-6989586621679209762"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679209761"><span class="annot"><a href="#local-6989586621679209761"><span class="hs-identifier hs-type">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DBVar"><span class="annot"><a href="Data.DBVar.html#DBVar"><span class="hs-identifier hs-var">DBVar</span></a></span></span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="readDBVar_"><span class="annot"><span class="annottext">DBVar m delta -&gt; m (Base delta)
</span><a href="Data.DBVar.html#readDBVar_"><span class="hs-identifier hs-var hs-var">readDBVar_</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679209762"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Delta.html#Base"><span class="hs-identifier hs-type">Base</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209761"><span class="hs-identifier hs-type">delta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="modifyDBMaybe_"><span class="annot"><span class="annottext">DBVar m delta -&gt; forall b. (Base delta -&gt; (Maybe delta, b)) -&gt; m b
</span><a href="Data.DBVar.html#modifyDBMaybe_"><span class="hs-identifier hs-var hs-var">modifyDBMaybe_</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679209766"><span class="annot"><a href="#local-6989586621679209766"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Delta.html#Base"><span class="hs-identifier hs-type">Base</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209761"><span class="hs-identifier hs-type">delta</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209761"><span class="hs-identifier hs-type">delta</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679209766"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209762"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209766"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-comment">-- | Read the current value of the 'DBVar'.</span><span>
</span><span id="line-81"></span><span id="local-6989586621679209608"><span id="local-6989586621679209609"><span id="local-6989586621679209610"><span class="annot"><a href="Data.DBVar.html#readDBVar"><span class="hs-identifier hs-type">readDBVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Delta.html#Delta"><span class="hs-identifier hs-type">Delta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209610"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679209609"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="Data.Delta.html#Base"><span class="hs-identifier hs-type">Base</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209610"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.DBVar.html#DBVar"><span class="hs-identifier hs-type">DBVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209608"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209610"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209608"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209609"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-82"></span><span id="readDBVar"><span class="annot"><span class="annottext">readDBVar :: DBVar m da -&gt; m a
</span><a href="Data.DBVar.html#readDBVar"><span class="hs-identifier hs-var hs-var">readDBVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DBVar m da -&gt; m a
forall (m :: * -&gt; *) delta. DBVar m delta -&gt; m (Base delta)
</span><a href="Data.DBVar.html#readDBVar_"><span class="hs-identifier hs-var hs-var">readDBVar_</span></a></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-comment">-- | Update the value of the 'DBVar' using a delta encoding.</span><span>
</span><span id="line-85"></span><span class="hs-comment">--</span><span>
</span><span id="line-86"></span><span class="hs-comment">-- The new value will be evaluated to weak head normal form.</span><span>
</span><span id="line-87"></span><span id="local-6989586621679209606"><span id="local-6989586621679209607"><span class="annot"><a href="Data.DBVar.html#updateDBVar"><span class="hs-identifier hs-type">updateDBVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Delta.html#Delta"><span class="hs-identifier hs-type">Delta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209607"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209606"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.DBVar.html#DBVar"><span class="hs-identifier hs-type">DBVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209606"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209607"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209607"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209606"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-88"></span><span id="updateDBVar"><span class="annot"><span class="annottext">updateDBVar :: DBVar m da -&gt; da -&gt; m ()
</span><a href="Data.DBVar.html#updateDBVar"><span class="hs-identifier hs-var hs-var">updateDBVar</span></a></span></span><span> </span><span id="local-6989586621679209605"><span class="annot"><span class="annottext">DBVar m da
</span><a href="#local-6989586621679209605"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621679209604"><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679209604"><span class="hs-identifier hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DBVar m da -&gt; (Base da -&gt; (Maybe da, ())) -&gt; m ()
forall da (m :: * -&gt; *) a b.
(Delta da, Monad m, a ~ Base da) =&gt;
DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
</span><a href="Data.DBVar.html#modifyDBMaybe"><span class="hs-identifier hs-var">modifyDBMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar m da
</span><a href="#local-6989586621679209605"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">((Base da -&gt; (Maybe da, ())) -&gt; m ())
-&gt; (Base da -&gt; (Maybe da, ())) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Base da
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">da -&gt; Maybe da
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679209604"><span class="hs-identifier hs-var">delta</span></a></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-comment">-- | Modify the value in a 'DBVar'.</span><span>
</span><span id="line-91"></span><span class="hs-comment">--</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- The new value will be evaluated to weak head normal form.</span><span>
</span><span id="line-93"></span><span id="local-6989586621679209600"><span id="local-6989586621679209601"><span id="local-6989586621679209602"><span id="local-6989586621679209603"><span class="annot"><a href="Data.DBVar.html#modifyDBVar"><span class="hs-identifier hs-type">modifyDBVar</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Delta.html#Delta"><span class="hs-identifier hs-type">Delta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209603"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209602"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679209601"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="Data.Delta.html#Base"><span class="hs-identifier hs-type">Base</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209603"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.DBVar.html#DBVar"><span class="hs-identifier hs-type">DBVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209602"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209603"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679209601"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679209603"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679209600"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209602"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209600"><span class="hs-identifier hs-type">b</span></a></span></span></span></span></span><span>
</span><span id="line-96"></span><span id="modifyDBVar"><span class="annot"><span class="annottext">modifyDBVar :: DBVar m da -&gt; (a -&gt; (da, b)) -&gt; m b
</span><a href="Data.DBVar.html#modifyDBVar"><span class="hs-identifier hs-var hs-var">modifyDBVar</span></a></span></span><span> </span><span id="local-6989586621679209599"><span class="annot"><span class="annottext">DBVar m da
</span><a href="#local-6989586621679209599"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621679209598"><span class="annot"><span class="annottext">a -&gt; (da, b)
</span><a href="#local-6989586621679209598"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
forall da (m :: * -&gt; *) a b.
(Delta da, Monad m, a ~ Base da) =&gt;
DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
</span><a href="Data.DBVar.html#modifyDBMaybe"><span class="hs-identifier hs-var">modifyDBMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar m da
</span><a href="#local-6989586621679209599"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">((a -&gt; (Maybe da, b)) -&gt; m b) -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679209597"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679209597"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679209596"><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679209596"><span class="hs-identifier hs-var">da</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679209595"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679209595"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; (da, b)
</span><a href="#local-6989586621679209598"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679209597"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">da -&gt; Maybe da
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679209596"><span class="hs-identifier hs-var">da</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679209595"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="hs-comment">-- | Maybe modify the value in a 'DBVar'</span><span>
</span><span id="line-99"></span><span class="hs-comment">--</span><span>
</span><span id="line-100"></span><span class="hs-comment">-- If updated, the new value will be evaluated to weak head normal form.</span><span>
</span><span id="line-101"></span><span id="local-6989586621679209754"><span id="local-6989586621679209755"><span id="local-6989586621679209756"><span id="local-6989586621679209758"><span class="annot"><a href="Data.DBVar.html#modifyDBMaybe"><span class="hs-identifier hs-type">modifyDBMaybe</span></a></span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Delta.html#Delta"><span class="hs-identifier hs-type">Delta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209758"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209756"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679209755"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="Data.Delta.html#Base"><span class="hs-identifier hs-type">Base</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209758"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.DBVar.html#DBVar"><span class="hs-identifier hs-type">DBVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209756"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209758"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679209755"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209758"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679209754"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209756"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209754"><span class="hs-identifier hs-type">b</span></a></span></span></span></span></span><span>
</span><span id="line-104"></span><span id="modifyDBMaybe"><span class="annot"><span class="annottext">modifyDBMaybe :: DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
</span><a href="Data.DBVar.html#modifyDBMaybe"><span class="hs-identifier hs-var hs-var">modifyDBMaybe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DBVar m da -&gt; (a -&gt; (Maybe da, b)) -&gt; m b
forall (m :: * -&gt; *) delta.
DBVar m delta -&gt; forall b. (Base delta -&gt; (Maybe delta, b)) -&gt; m b
</span><a href="Data.DBVar.html#modifyDBMaybe_"><span class="hs-identifier hs-var hs-var">modifyDBMaybe_</span></a></span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span class="hs-comment">-- | Initialize a new 'DBVar' for a given 'Store'.</span><span>
</span><span id="line-107"></span><span id="local-6989586621679209592"><span id="local-6989586621679209593"><span id="local-6989586621679209594"><span class="annot"><a href="Data.DBVar.html#initDBVar"><span class="hs-identifier hs-type">initDBVar</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-glyph">::</span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209594"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadThrow</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209594"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadEvaluate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209594"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadMask</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209594"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-109"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Delta.html#Delta"><span class="hs-identifier hs-type">Delta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209593"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679209592"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="Data.Delta.html#Base"><span class="hs-identifier hs-type">Base</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209593"><span class="hs-identifier hs-type">da</span></a></span><span>
</span><span id="line-110"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209593"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-comment">-- ^ 'Store' for writing.</span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209592"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-comment">-- ^ Initial value.</span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.DBVar.html#DBVar"><span class="hs-identifier hs-type">DBVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209593"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-114"></span><span id="initDBVar"><span class="annot"><span class="annottext">initDBVar :: Store m da -&gt; a -&gt; m (DBVar m da)
</span><a href="Data.DBVar.html#initDBVar"><span class="hs-identifier hs-var hs-var">initDBVar</span></a></span></span><span> </span><span id="local-6989586621679209591"><span class="annot"><span class="annottext">Store m da
</span><a href="#local-6989586621679209591"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679209590"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679209590"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-115"></span><span>    </span><span class="annot"><span class="annottext">Store m da -&gt; Base da -&gt; m ()
forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; m ()
</span><a href="Data.DBVar.html#writeS"><span class="hs-identifier hs-var hs-var">writeS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m da
</span><a href="#local-6989586621679209591"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">a
Base da
</span><a href="#local-6989586621679209590"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-116"></span><span>    </span><span class="annot"><span class="annottext">(a -&gt; da -&gt; m ()) -&gt; a -&gt; m (DBVar m da)
forall (m :: * -&gt; *) da a.
(MonadSTM m, MonadThrow m, MonadMask m, MonadEvaluate m, Delta da,
 a ~ Base da) =&gt;
(a -&gt; da -&gt; m ()) -&gt; a -&gt; m (DBVar m da)
</span><a href="Data.DBVar.html#newWithCache"><span class="hs-identifier hs-var">newWithCache</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Store m da -&gt; Base da -&gt; da -&gt; m ()
forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; da -&gt; m ()
</span><a href="Data.DBVar.html#updateS"><span class="hs-identifier hs-var hs-var">updateS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m da
</span><a href="#local-6989586621679209591"><span class="hs-identifier hs-var">store</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679209590"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span class="hs-comment">-- | Create a 'DBVar' by loading its value from an existing 'Store'</span><span>
</span><span id="line-119"></span><span class="hs-comment">-- Throws an exception if the value cannot be loaded.</span><span>
</span><span id="line-120"></span><span id="local-6989586621679209585"><span id="local-6989586621679209586"><span class="annot"><a href="Data.DBVar.html#loadDBVar"><span class="hs-identifier hs-type">loadDBVar</span></a></span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-glyph">::</span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209586"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadThrow</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209586"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadEvaluate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209586"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadMask</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209586"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-122"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Delta.html#Delta"><span class="hs-identifier hs-type">Delta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209585"><span class="hs-identifier hs-type">da</span></a></span><span>
</span><span id="line-123"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209586"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209585"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-comment">-- ^ 'Store' for writing and for reading the initial value.</span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209586"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.DBVar.html#DBVar"><span class="hs-identifier hs-type">DBVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209586"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209585"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-126"></span><span id="loadDBVar"><span class="annot"><span class="annottext">loadDBVar :: Store m da -&gt; m (DBVar m da)
</span><a href="Data.DBVar.html#loadDBVar"><span class="hs-identifier hs-var hs-var">loadDBVar</span></a></span></span><span> </span><span id="local-6989586621679209584"><span class="annot"><span class="annottext">Store m da
</span><a href="#local-6989586621679209584"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><span class="annottext">Store m da -&gt; m (Either SomeException (Base da))
forall (m :: * -&gt; *) da.
Store m da -&gt; m (Either SomeException (Base da))
</span><a href="Data.DBVar.html#loadS"><span class="hs-identifier hs-var hs-var">loadS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m da
</span><a href="#local-6989586621679209584"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (Base da))
-&gt; (Either SomeException (Base da) -&gt; m (DBVar m da))
-&gt; m (DBVar m da)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-128"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span id="local-6989586621679209582"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679209582"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; m (DBVar m da)
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679209582"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-129"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679209581"><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679209581"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Base da -&gt; da -&gt; m ()) -&gt; Base da -&gt; m (DBVar m da)
forall (m :: * -&gt; *) da a.
(MonadSTM m, MonadThrow m, MonadMask m, MonadEvaluate m, Delta da,
 a ~ Base da) =&gt;
(a -&gt; da -&gt; m ()) -&gt; a -&gt; m (DBVar m da)
</span><a href="Data.DBVar.html#newWithCache"><span class="hs-identifier hs-var">newWithCache</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Store m da -&gt; Base da -&gt; da -&gt; m ()
forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; da -&gt; m ()
</span><a href="Data.DBVar.html#updateS"><span class="hs-identifier hs-var hs-var">updateS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m da
</span><a href="#local-6989586621679209584"><span class="hs-identifier hs-var">store</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679209581"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-comment">-- | Create 'DBVar' from an initial value and an update function</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- using a 'TVar' as in-memory cache.</span><span>
</span><span id="line-133"></span><span class="hs-comment">--</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- Space: The value in the 'TVar' will be evaluated to weak head normal form.</span><span>
</span><span id="line-135"></span><span class="hs-comment">--</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- Concurrency: The update function needs to be atomic even in the presence</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- of asynchronous exceptions.</span><span>
</span><span id="line-138"></span><span id="local-6989586621679209729"><span id="local-6989586621679209730"><span id="local-6989586621679209735"><span class="annot"><a href="Data.DBVar.html#newWithCache"><span class="hs-identifier hs-type">newWithCache</span></a></span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-glyph">::</span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209735"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadThrow</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209735"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadMask</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209735"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadEvaluate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209735"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-140"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Delta.html#Delta"><span class="hs-identifier hs-type">Delta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209730"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679209729"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="Data.Delta.html#Base"><span class="hs-identifier hs-type">Base</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209730"><span class="hs-identifier hs-type">da</span></a></span><span>
</span><span id="line-141"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679209729"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209730"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209729"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.DBVar.html#DBVar"><span class="hs-identifier hs-type">DBVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209730"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-143"></span><span id="newWithCache"><span class="annot"><span class="annottext">newWithCache :: (a -&gt; da -&gt; m ()) -&gt; a -&gt; m (DBVar m da)
</span><a href="Data.DBVar.html#newWithCache"><span class="hs-identifier hs-var hs-var">newWithCache</span></a></span></span><span> </span><span id="local-6989586621679209580"><span class="annot"><span class="annottext">a -&gt; da -&gt; m ()
</span><a href="#local-6989586621679209580"><span class="hs-identifier hs-var">update</span></a></span></span><span> </span><span id="local-6989586621679209579"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679209579"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-144"></span><span>    </span><span id="local-6989586621679209578"><span class="annot"><span class="annottext">TVar m a
</span><a href="#local-6989586621679209578"><span class="hs-identifier hs-var">cache</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; m (TVar m a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (TVar m a)
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679209579"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-145"></span><span>    </span><span id="local-6989586621679209577"><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679209577"><span class="hs-identifier hs-var">locked</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m (TVar m Bool)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (TVar m a)
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>   </span><span class="hs-comment">-- lock for updating the cache</span><span>
</span><span id="line-146"></span><span>    </span><span class="annot"><span class="annottext">DBVar m da -&gt; m (DBVar m da)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(DBVar m da -&gt; m (DBVar m da)) -&gt; DBVar m da -&gt; m (DBVar m da)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DBVar :: forall (m :: * -&gt; *) delta.
m (Base delta)
-&gt; (forall b. (Base delta -&gt; (Maybe delta, b)) -&gt; m b)
-&gt; DBVar m delta
</span><a href="Data.DBVar.html#DBVar"><span class="hs-identifier hs-type">DBVar</span></a></span><span>
</span><span id="line-147"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">readDBVar_ :: m (Base da)
</span><a href="Data.DBVar.html#readDBVar_"><span class="hs-identifier hs-var">readDBVar_</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar m a -&gt; m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">readTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m a
</span><a href="#local-6989586621679209578"><span class="hs-identifier hs-var">cache</span></a></span><span>
</span><span id="line-148"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">modifyDBMaybe_ :: forall b. (Base da -&gt; (Maybe da, b)) -&gt; m b
</span><a href="Data.DBVar.html#modifyDBMaybe_"><span class="hs-identifier hs-var">modifyDBMaybe_</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679209576"><span class="annot"><span class="annottext">Base da -&gt; (Maybe da, b)
</span><a href="#local-6989586621679209576"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209575"><span class="annot"><span class="annottext">before :: m a
</span><a href="#local-6989586621679209575"><span class="hs-identifier hs-var hs-var">before</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m a -&gt; m a) -&gt; STM m a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-150"></span><span>                    </span><span class="annot"><span class="annottext">TVar m Bool -&gt; STM m Bool
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679209577"><span class="hs-identifier hs-var">locked</span></a></span><span> </span><span class="annot"><span class="annottext">STM m Bool -&gt; (Bool -&gt; STM m a) -&gt; STM m a
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-151"></span><span>                        </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">retry</span></a></span><span>
</span><span id="line-152"></span><span>                        </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-153"></span><span>                            </span><span class="annot"><span class="annottext">TVar m Bool -&gt; Bool -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679209577"><span class="hs-identifier hs-var">locked</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-154"></span><span>                            </span><span class="annot"><span class="annottext">TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m a
</span><a href="#local-6989586621679209578"><span class="hs-identifier hs-var">cache</span></a></span><span>
</span><span id="line-155"></span><span>                </span><span id="local-6989586621679209574"><span class="annot"><span class="annottext">after :: a -&gt; m ()
</span><a href="#local-6989586621679209574"><span class="hs-identifier hs-var hs-var">after</span></a></span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m Bool -&gt; Bool -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679209577"><span class="hs-identifier hs-var">locked</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-156"></span><span>                </span><span id="local-6989586621679209573"><span class="annot"><span class="annottext">action :: a -&gt; m b
</span><a href="#local-6989586621679209573"><span class="hs-identifier hs-var hs-var">action</span></a></span></span><span> </span><span id="local-6989586621679209572"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679209572"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-157"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679209571"><span class="annot"><span class="annottext">Maybe da
</span><a href="#local-6989586621679209571"><span class="hs-identifier hs-var">mdelta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679209570"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679209570"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Base da -&gt; (Maybe da, b)
</span><a href="#local-6989586621679209576"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
Base da
</span><a href="#local-6989586621679209572"><span class="hs-identifier hs-var">old</span></a></span><span>
</span><span id="line-158"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe da
</span><a href="#local-6989586621679209571"><span class="hs-identifier hs-var">mdelta</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-159"></span><span>                        </span><span class="annot"><span class="annottext">Maybe da
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>                        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679209569"><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679209569"><span class="hs-identifier hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-161"></span><span>                            </span><span id="local-6989586621679209568"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679209568"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. MonadEvaluate m =&gt; a -&gt; m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">evaluate</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; m a) -&gt; a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">da -&gt; Base da -&gt; Base da
forall delta. Delta delta =&gt; delta -&gt; Base delta -&gt; Base delta
</span><a href="Data.Delta.html#apply"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679209569"><span class="hs-identifier hs-var">delta</span></a></span><span> </span><span class="annot"><span class="annottext">a
Base da
</span><a href="#local-6989586621679209572"><span class="hs-identifier hs-var">old</span></a></span><span>
</span><span id="line-162"></span><span>                            </span><span class="annot"><span class="annottext">((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">(((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ())
-&gt; ((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679209566"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679209566"><span class="hs-identifier hs-var">restore</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-163"></span><span>                                </span><span class="hs-comment">-- We mask asynchronous exceptions here</span><span>
</span><span id="line-164"></span><span>                                </span><span class="hs-comment">-- to ensure that the TVar will be updated</span><span>
</span><span id="line-165"></span><span>                                </span><span class="hs-comment">-- whenever @update@ succeeds without exception.</span><span>
</span><span id="line-166"></span><span>                                </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall a. m a -&gt; m a
</span><a href="#local-6989586621679209566"><span class="hs-identifier hs-var">restore</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; da -&gt; m ()
</span><a href="#local-6989586621679209580"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679209572"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679209569"><span class="hs-identifier hs-var">delta</span></a></span><span>
</span><span id="line-167"></span><span>                                </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m a
</span><a href="#local-6989586621679209578"><span class="hs-identifier hs-var">cache</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679209568"><span class="hs-identifier hs-var">new</span></a></span><span>
</span><span id="line-168"></span><span>                    </span><span class="annot"><span class="annottext">b -&gt; m b
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679209570"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-169"></span><span>            </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m ()) -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b c.
MonadThrow m =&gt;
m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">bracket</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679209575"><span class="hs-identifier hs-var">before</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m ()
</span><a href="#local-6989586621679209574"><span class="hs-identifier hs-var">after</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679209573"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-170"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Store
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-175"></span><span class="hs-comment">{- |
A 'Store' is a storage facility for Haskell values of type @a ~@'Base'@ da@.
Typical use cases are a file or a database on the hard disk.

A 'Store' has many similarities with an 'Embedding'.
The main difference is that storing value in a 'Store' has side effects.
A 'Store' is described by three action:

* 'writeS' writes a value to the store.
* 'loadS' loads a value from the store.
* 'updateS' uses a delta encoding of type @da@ to efficiently update
    the store.
    In order to avoid performing an expensive 'loadS' operation,
    the action 'updateS' expects the value described by the store
    as an argument, but no check is performed whether the provided
    value matches the contents of the store.
    Also, not every store inspects this argument.

A 'Store' is characterized by the following properties:

* The store __need not contain__ a properly formatted __value__:
    Loading a value from the store may fail, and this is why 'loadS'
    has an 'Either' result.
    For example, if the 'Store' represents
    a file on disk, then the file may corrupted or in an incompatible
    file format when first opened.
    In such a case of failure, the result 'Left'@ (e :: @'SomeException'@)@
    is returned, where the exception @e@ gives more information
    about the failure.

    However, loading a value after writing it should always succeed,
    we have

        &gt; writeS s a &gt;&gt; loadS s  =  pure (Right a)

* The store is __redundant__:
    Two stores with different contents may describe
    the same value of type @a@.
    For example, two files with different whitespace
    may describe the same JSON value.
    In general, we have

        &gt; loadS s &gt;&gt;= either (const $ pure ()) (writeS s) &#8800;  pure ()

* Updating a store __commutes with 'apply'__:
    We have

        &gt; updateS s a da &gt;&gt; loadS s  =  pure $ Right $ apply a da

    However, since the store is redundant, we often have

        &gt; updateS s a da  &#8800;  writeS s (apply a da)

* __Exceptions__:
    It is expected that the functions 'loadS', 'updateS', 'writeS'
    do not throw synchronous exceptions. In the worst case,
    'loadS' should return 'Left' after reading or writing
    to the store was unsuccessful.

* __Concurrency__:
    It is expected that the functions 'updateS' and 'writeS'
    are /atomic/: Either they succeed in updating / writing
    the new value in its entirety, or the old value is kept.
    In particular, we expect this even when one of these
    functions receives an asynchronous exception and needs to abort
    normal operation.
-}</span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="hs-keyword">data</span><span> </span><span id="Store"><span class="annot"><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-var">Store</span></a></span></span><span> </span><span id="local-6989586621679209737"><span class="annot"><a href="#local-6989586621679209737"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679209736"><span class="annot"><a href="#local-6989586621679209736"><span class="hs-identifier hs-type">da</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Store"><span class="annot"><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-var">Store</span></a></span></span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="loadS"><span class="annot"><span class="annottext">Store m da -&gt; m (Either SomeException (Base da))
</span><a href="Data.DBVar.html#loadS"><span class="hs-identifier hs-var hs-var">loadS</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679209737"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">SomeException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Delta.html#Base"><span class="hs-identifier hs-type">Base</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209736"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="writeS"><span class="annot"><span class="annottext">Store m da -&gt; Base da -&gt; m ()
</span><a href="Data.DBVar.html#writeS"><span class="hs-identifier hs-var hs-var">writeS</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Delta.html#Base"><span class="hs-identifier hs-type">Base</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209736"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209737"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="updateS"><span class="annot"><span class="annottext">Store m da -&gt; Base da -&gt; da -&gt; m ()
</span><a href="Data.DBVar.html#updateS"><span class="hs-identifier hs-var hs-var">updateS</span></a></span></span><span>
</span><span id="line-247"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Delta.html#Base"><span class="hs-identifier hs-type">Base</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209736"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-comment">-- old value</span><span>
</span><span id="line-248"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209736"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-comment">-- delta to new value</span><span>
</span><span id="line-249"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209737"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- write new value</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="hs-comment">{- HLINT ignore newStore &quot;Use readTVarIO&quot; -}</span><span>
</span><span id="line-253"></span><span class="hs-comment">-- | An in-memory 'Store' from a mutable variable ('TVar').</span><span>
</span><span id="line-254"></span><span class="hs-comment">-- Useful for testing.</span><span>
</span><span id="line-255"></span><span id="local-6989586621679209563"><span id="local-6989586621679209564"><span class="annot"><a href="Data.DBVar.html#newStore"><span class="hs-identifier hs-type">newStore</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Delta.html#Delta"><span class="hs-identifier hs-type">Delta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209564"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209563"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209563"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209563"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209564"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-256"></span><span id="newStore"><span class="annot"><span class="annottext">newStore :: m (Store m da)
</span><a href="Data.DBVar.html#newStore"><span class="hs-identifier hs-var hs-var">newStore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-257"></span><span>    </span><span id="local-6989586621679209562"><span class="annot"><span class="annottext">TVar m (Either SomeException (Base da))
</span><a href="#local-6989586621679209562"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either SomeException (Base da)
-&gt; m (TVar m (Either SomeException (Base da)))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (TVar m a)
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (Base da)
 -&gt; m (TVar m (Either SomeException (Base da))))
-&gt; Either SomeException (Base da)
-&gt; m (TVar m (Either SomeException (Base da)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Either SomeException (Base da)
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; Either SomeException (Base da))
-&gt; SomeException -&gt; Either SomeException (Base da)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NotInitialized -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toException</span></a></span><span> </span><span class="annot"><span class="annottext">NotInitialized
</span><a href="Data.DBVar.html#NotInitialized"><span class="hs-identifier hs-var">NotInitialized</span></a></span><span>
</span><span id="line-258"></span><span>    </span><span class="annot"><span class="annottext">Store m da -&gt; m (Store m da)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Store m da -&gt; m (Store m da)) -&gt; Store m da -&gt; m (Store m da)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Store :: forall (m :: * -&gt; *) da.
m (Either SomeException (Base da))
-&gt; (Base da -&gt; m ()) -&gt; (Base da -&gt; da -&gt; m ()) -&gt; Store m da
</span><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span>
</span><span id="line-259"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">loadS :: m (Either SomeException (Base da))
</span><a href="Data.DBVar.html#loadS"><span class="hs-identifier hs-var">loadS</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m (Either SomeException (Base da))
-&gt; m (Either SomeException (Base da))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (Either SomeException (Base da))
 -&gt; m (Either SomeException (Base da)))
-&gt; STM m (Either SomeException (Base da))
-&gt; m (Either SomeException (Base da))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Either SomeException (Base da))
-&gt; STM m (Either SomeException (Base da))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Either SomeException (Base da))
</span><a href="#local-6989586621679209562"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-260"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">writeS :: Base da -&gt; m ()
</span><a href="Data.DBVar.html#writeS"><span class="hs-identifier hs-var">writeS</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; (Base da -&gt; STM m ()) -&gt; Base da -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Either SomeException (Base da))
-&gt; Either SomeException (Base da) -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Either SomeException (Base da))
</span><a href="#local-6989586621679209562"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (Base da) -&gt; STM m ())
-&gt; (Base da -&gt; Either SomeException (Base da))
-&gt; Base da
-&gt; STM m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Base da -&gt; Either SomeException (Base da)
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span>
</span><span id="line-261"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">updateS :: Base da -&gt; da -&gt; m ()
</span><a href="Data.DBVar.html#updateS"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Base da
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; (da -&gt; STM m ()) -&gt; da -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Either SomeException (Base da))
-&gt; (Either SomeException (Base da)
    -&gt; Either SomeException (Base da))
-&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">modifyTVar'</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Either SomeException (Base da))
</span><a href="#local-6989586621679209562"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">((Either SomeException (Base da) -&gt; Either SomeException (Base da))
 -&gt; STM m ())
-&gt; (da
    -&gt; Either SomeException (Base da)
    -&gt; Either SomeException (Base da))
-&gt; da
-&gt; STM m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Base da -&gt; Base da)
-&gt; Either SomeException (Base da) -&gt; Either SomeException (Base da)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">((Base da -&gt; Base da)
 -&gt; Either SomeException (Base da)
 -&gt; Either SomeException (Base da))
-&gt; (da -&gt; Base da -&gt; Base da)
-&gt; da
-&gt; Either SomeException (Base da)
-&gt; Either SomeException (Base da)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">da -&gt; Base da -&gt; Base da
forall delta. Delta delta =&gt; delta -&gt; Base delta -&gt; Base delta
</span><a href="Data.Delta.html#apply"><span class="hs-identifier hs-var">apply</span></a></span><span>
</span><span id="line-262"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span class="hs-comment">{- | $EitherSomeException

NOTE: [EitherSomeException]

In this version of the library, the error case returned by 'loadS' and 'load'
is the general 'SomeException' type, which is a disjoint sum of all possible
error types (that is, members of the 'Exception' class).

In a future version of this library, this may be replaced by a more specific
error type, but at the price of introducing a new type parameter @e@ in the
'Store' type.

For now, I have opted to explore a region of the design space
where the number of type parameters is kept to a minimum.
I would argue that making errors visible on the type level is not as
useful as one might hope for, because in exchange for making the types noisier,
the amount of type-safety we gain is very small.
Specifically, if we encounter an element of the 'SomeException' type that
we did not expect, it is entirely ok to 'throw' it.
For example, consider the following code:
@
let ea :: Either SomeException ()
    ea = [..]
in
    case ea of
        Right _ -&gt; &quot;everything is ok&quot;
        Left e -&gt; case fromException e of
            Just (AssertionFailed _) -&gt; &quot;bad things happened&quot;
            Nothing -&gt; throw e
@
In this example, using the more specific type @ea :: Either AssertionFailed ()@
would have eliminated the need to handle the 'Nothing' case.
But as we are dealing with exceptions, this case does have a default handler,
and there is less need to exclude it at compile as opposed to, say,
the case of an empty list.
-}</span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span class="hs-comment">-- | Failure that occurs when calling 'loadS' on a 'newStore' that is empty.</span><span>
</span><span id="line-302"></span><span class="hs-keyword">data</span><span> </span><span id="NotInitialized"><span class="annot"><a href="Data.DBVar.html#NotInitialized"><span class="hs-identifier hs-var">NotInitialized</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NotInitialized"><span class="annot"><a href="Data.DBVar.html#NotInitialized"><span class="hs-identifier hs-var">NotInitialized</span></a></span></span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679209556"><span id="local-6989586621679209558"><span class="annot"><span class="annottext">NotInitialized -&gt; NotInitialized -&gt; Bool
(NotInitialized -&gt; NotInitialized -&gt; Bool)
-&gt; (NotInitialized -&gt; NotInitialized -&gt; Bool) -&gt; Eq NotInitialized
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: NotInitialized -&gt; NotInitialized -&gt; Bool
$c/= :: NotInitialized -&gt; NotInitialized -&gt; Bool
== :: NotInitialized -&gt; NotInitialized -&gt; Bool
$c== :: NotInitialized -&gt; NotInitialized -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679209549"><span id="local-6989586621679209551"><span id="local-6989586621679209553"><span class="annot"><span class="annottext">Int -&gt; NotInitialized -&gt; ShowS
[NotInitialized] -&gt; ShowS
NotInitialized -&gt; String
(Int -&gt; NotInitialized -&gt; ShowS)
-&gt; (NotInitialized -&gt; String)
-&gt; ([NotInitialized] -&gt; ShowS)
-&gt; Show NotInitialized
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [NotInitialized] -&gt; ShowS
$cshowList :: [NotInitialized] -&gt; ShowS
show :: NotInitialized -&gt; String
$cshow :: NotInitialized -&gt; String
showsPrec :: Int -&gt; NotInitialized -&gt; ShowS
$cshowsPrec :: Int -&gt; NotInitialized -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679209540"><span id="local-6989586621679209542"><span id="local-6989586621679209544"><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Data.DBVar.html#NotInitialized"><span class="hs-identifier hs-type">NotInitialized</span></a></span></span></span></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="hs-comment">{-
-- | Add a caching layer to a 'Store'.
--
-- Access to the underlying 'Store' is enforced to be sequential,
-- but the cache can be accessed in parallel.
--
-- FIXME: Safety with respect to asynchronous exceptions?
cachedStore
    :: forall m da. (MonadSTM m, Delta da)
    =&gt; Store m da -&gt; m (Store m da)
cachedStore Store{loadS,writeS,updateS} = do
    -- Lock that puts loadS, writeS and updateS into sequence
    islocked &lt;- newTVarIO False
    let withLock :: forall b. m b -&gt; m b
        withLock action = do
            atomically $ readTVar islocked &gt;&gt;= \case
                True  -&gt; retry
                False -&gt; writeTVar islocked True
            a &lt;- action
            atomically $ writeTVar islocked False
            pure a

    -- Cache that need not be filled in the beginning
    iscached &lt;- newTVarIO False
    cache    &lt;- newTVarIO (Nothing :: Maybe (Base da))
    let writeCache ma = writeTVar cache ma &gt;&gt; writeTVar iscached True

    -- Load the value from the Store only if it is not cached and
    -- nobody else is writing to the store.
    let load :: m (Maybe (Base da))
        load = do
            action &lt;- atomically $
                readTVar iscached &gt;&gt;= \case
                    True  -&gt; do
                        ma &lt;- readTVar cache  -- read from cache
                        pure $ pure ma
                    False -&gt; readTVar islocked &gt;&gt;= \case
                        True  -&gt; retry  -- somebody is writing
                        False -&gt; pure $ withLock $ do
                            ma &lt;- loadS
                            atomically $ writeCache ma
                            pure ma
            action

    pure $ Store
        { loadS = load
        , writeS = \a -&gt; withLock $ do
            atomically $ writeCache (Just a)
            writeS a
        , updateS = \old delta -&gt; withLock $ do
            atomically $ writeCache $ Just $ apply delta old
            updateS old delta
        }
-}</span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span id="local-6989586621679209536"><span id="local-6989586621679209537"><span id="local-6989586621679209538"><span class="annot"><a href="Data.DBVar.html#embedStore"><span class="hs-identifier hs-type">embedStore</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209538"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadMask</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209538"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Delta.html#Delta"><span class="hs-identifier hs-type">Delta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209537"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.Delta.html#Embedding"><span class="hs-identifier hs-type">Embedding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209537"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209536"><span class="hs-identifier hs-type">db</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209538"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209536"><span class="hs-identifier hs-type">db</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679209538"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209538"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209537"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-362"></span><span id="embedStore"><span class="annot"><span class="annottext">embedStore :: Embedding da db -&gt; Store m db -&gt; m (Store m da)
</span><a href="Data.DBVar.html#embedStore"><span class="hs-identifier hs-var hs-var">embedStore</span></a></span></span><span> </span><span id="local-6989586621679209535"><span class="annot"><span class="annottext">Embedding da db
</span><a href="#local-6989586621679209535"><span class="hs-identifier hs-var">embed</span></a></span></span><span> </span><span id="local-6989586621679209534"><span class="annot"><span class="annottext">Store m db
</span><a href="#local-6989586621679209534"><span class="hs-identifier hs-var">bstore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-363"></span><span>    </span><span class="hs-comment">-- For reasons of efficiency, we have to store the 'Machine'</span><span>
</span><span id="line-364"></span><span>    </span><span class="hs-comment">-- that is created within the 'Embedding'.</span><span>
</span><span id="line-365"></span><span>    </span><span id="local-6989586621679209533"><span class="annot"><span class="annottext">TVar m (Maybe (Machine da db))
</span><a href="#local-6989586621679209533"><span class="hs-identifier hs-var">machine</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (Machine da db) -&gt; m (TVar m (Maybe (Machine da db)))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (TVar m a)
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Machine da db)
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-366"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209532"><span class="annot"><span class="annottext">readMachine :: m (Maybe (Machine da db))
</span><a href="#local-6989586621679209532"><span class="hs-identifier hs-var hs-var">readMachine</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe (Machine da db)) -&gt; m (Maybe (Machine da db))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">readTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe (Machine da db))
</span><a href="#local-6989586621679209533"><span class="hs-identifier hs-var">machine</span></a></span><span>
</span><span id="line-367"></span><span>        </span><span id="local-6989586621679209531"><span class="annot"><span class="annottext">writeMachine :: Machine da db -&gt; m ()
</span><a href="#local-6989586621679209531"><span class="hs-identifier hs-var hs-var">writeMachine</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ())
-&gt; (Machine da db -&gt; STM m ()) -&gt; Machine da db -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe (Machine da db)) -&gt; Maybe (Machine da db) -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe (Machine da db))
</span><a href="#local-6989586621679209533"><span class="hs-identifier hs-var">machine</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Machine da db) -&gt; STM m ())
-&gt; (Machine da db -&gt; Maybe (Machine da db))
-&gt; Machine da db
-&gt; STM m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Machine da db -&gt; Maybe (Machine da db)
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span>    </span><span class="hs-comment">-- Operations of the result 'Store'.</span><span>
</span><span id="line-370"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209530"><span class="annot"><span class="annottext">load :: m (Either SomeException (Base da))
</span><a href="#local-6989586621679209530"><span class="hs-identifier hs-var hs-var">load</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store m db -&gt; m (Either SomeException (Base db))
forall (m :: * -&gt; *) da.
Store m da -&gt; m (Either SomeException (Base da))
</span><a href="Data.DBVar.html#loadS"><span class="hs-identifier hs-var hs-var">loadS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m db
</span><a href="#local-6989586621679209534"><span class="hs-identifier hs-var">bstore</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (Base db))
-&gt; (Either SomeException (Base db)
    -&gt; m (Either SomeException (Base da)))
-&gt; m (Either SomeException (Base da))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-371"></span><span>            </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span id="local-6989586621679209529"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679209529"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either SomeException (Base da)
-&gt; m (Either SomeException (Base da))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (Base da)
 -&gt; m (Either SomeException (Base da)))
-&gt; Either SomeException (Base da)
-&gt; m (Either SomeException (Base da))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Either SomeException (Base da)
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679209529"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-372"></span><span>            </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679209528"><span class="annot"><span class="annottext">Base db
</span><a href="#local-6989586621679209528"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Embedding da db
-&gt; Base db -&gt; Either SomeException (Base da, Machine da db)
forall da db.
Embedding da db
-&gt; Base db -&gt; Either SomeException (Base da, Machine da db)
</span><a href="Data.Delta.html#project"><span class="hs-identifier hs-var hs-var">project</span></a></span><span> </span><span class="annot"><span class="annottext">Embedding da db
</span><a href="#local-6989586621679209535"><span class="hs-identifier hs-var">embed</span></a></span><span> </span><span class="annot"><span class="annottext">Base db
</span><a href="#local-6989586621679209528"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-373"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span id="local-6989586621679209527"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679209527"><span class="hs-identifier hs-var">e</span></a></span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either SomeException (Base da)
-&gt; m (Either SomeException (Base da))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (Base da)
 -&gt; m (Either SomeException (Base da)))
-&gt; Either SomeException (Base da)
-&gt; m (Either SomeException (Base da))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Either SomeException (Base da)
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679209527"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-374"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679209526"><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679209526"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679209525"><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679209525"><span class="hs-identifier hs-var">mab</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-375"></span><span>                    </span><span class="annot"><span class="annottext">Machine da db -&gt; m ()
</span><a href="#local-6989586621679209531"><span class="hs-identifier hs-var">writeMachine</span></a></span><span> </span><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679209525"><span class="hs-identifier hs-var">mab</span></a></span><span>
</span><span id="line-376"></span><span>                    </span><span class="annot"><span class="annottext">Either SomeException (Base da)
-&gt; m (Either SomeException (Base da))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (Base da)
 -&gt; m (Either SomeException (Base da)))
-&gt; Either SomeException (Base da)
-&gt; m (Either SomeException (Base da))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Base da -&gt; Either SomeException (Base da)
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679209526"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-377"></span><span>        </span><span id="local-6989586621679209524"><span class="annot"><span class="annottext">write :: Base da -&gt; m ()
</span><a href="#local-6989586621679209524"><span class="hs-identifier hs-var hs-var">write</span></a></span></span><span> </span><span id="local-6989586621679209523"><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679209523"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-378"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679209522"><span class="annot"><span class="annottext">mab :: Machine da db
</span><a href="#local-6989586621679209522"><span class="hs-identifier hs-var hs-var">mab</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Embedding da db -&gt; Base da -&gt; Machine da db
forall da db. Embedding da db -&gt; Base da -&gt; Machine da db
</span><a href="Data.Delta.html#inject"><span class="hs-identifier hs-var hs-var">inject</span></a></span><span> </span><span class="annot"><span class="annottext">Embedding da db
</span><a href="#local-6989586621679209535"><span class="hs-identifier hs-var">embed</span></a></span><span> </span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679209523"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-379"></span><span>            </span><span class="annot"><span class="annottext">((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">(((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ())
-&gt; ((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679209521"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679209521"><span class="hs-identifier hs-var">restore</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-380"></span><span>                </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall a. m a -&gt; m a
</span><a href="#local-6989586621679209521"><span class="hs-identifier hs-var">restore</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Store m db -&gt; Base db -&gt; m ()
forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; m ()
</span><a href="Data.DBVar.html#writeS"><span class="hs-identifier hs-var hs-var">writeS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m db
</span><a href="#local-6989586621679209534"><span class="hs-identifier hs-var">bstore</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Machine da db -&gt; Base db
forall da db. Machine da db -&gt; Base db
</span><a href="Data.Delta.html#state_"><span class="hs-identifier hs-var hs-var">state_</span></a></span><span> </span><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679209522"><span class="hs-identifier hs-var">mab</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-381"></span><span>                </span><span class="annot"><span class="annottext">Machine da db -&gt; m ()
</span><a href="#local-6989586621679209531"><span class="hs-identifier hs-var">writeMachine</span></a></span><span> </span><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679209522"><span class="hs-identifier hs-var">mab</span></a></span><span>
</span><span id="line-382"></span><span>        </span><span id="local-6989586621679209519"><span class="annot"><span class="annottext">update :: Base da -&gt; da -&gt; m ()
</span><a href="#local-6989586621679209519"><span class="hs-identifier hs-var hs-var">update</span></a></span></span><span> </span><span id="local-6989586621679209518"><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679209518"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679209517"><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679209517"><span class="hs-identifier hs-var">da</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-383"></span><span>            </span><span class="annot"><span class="annottext">m (Maybe (Machine da db))
</span><a href="#local-6989586621679209532"><span class="hs-identifier hs-var">readMachine</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe (Machine da db))
-&gt; (Maybe (Machine da db) -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-384"></span><span>                </span><span class="annot"><span class="annottext">Maybe (Machine da db)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- we were missing the initial write</span><span>
</span><span id="line-385"></span><span>                    </span><span class="annot"><span class="annottext">Base da -&gt; m ()
</span><a href="#local-6989586621679209524"><span class="hs-identifier hs-var">write</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">da -&gt; Base da -&gt; Base da
forall delta. Delta delta =&gt; delta -&gt; Base delta -&gt; Base delta
</span><a href="Data.Delta.html#apply"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679209517"><span class="hs-identifier hs-var">da</span></a></span><span> </span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679209518"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679209516"><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679209516"><span class="hs-identifier hs-var">mab1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- advance the machine by one step</span><span>
</span><span id="line-387"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679209515"><span class="annot"><span class="annottext">db
</span><a href="#local-6989586621679209515"><span class="hs-identifier hs-var">db</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679209514"><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679209514"><span class="hs-identifier hs-var">mab2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Machine da db -&gt; (Base da, da) -&gt; (db, Machine da db)
forall da db. Machine da db -&gt; (Base da, da) -&gt; (db, Machine da db)
</span><a href="Data.Delta.html#step_"><span class="hs-identifier hs-var hs-var">step_</span></a></span><span> </span><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679209516"><span class="hs-identifier hs-var">mab1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679209518"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679209517"><span class="hs-identifier hs-var">da</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>                    </span><span class="annot"><span class="annottext">((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
</span><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-var">mask</span></a></span><span> </span><span class="annot"><span class="annottext">(((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ())
-&gt; ((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679209512"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679209512"><span class="hs-identifier hs-var">restore</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-389"></span><span>                        </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall a. m a -&gt; m a
</span><a href="#local-6989586621679209512"><span class="hs-identifier hs-var">restore</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Store m db -&gt; Base db -&gt; db -&gt; m ()
forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; da -&gt; m ()
</span><a href="Data.DBVar.html#updateS"><span class="hs-identifier hs-var hs-var">updateS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m db
</span><a href="#local-6989586621679209534"><span class="hs-identifier hs-var">bstore</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Machine da db -&gt; Base db
forall da db. Machine da db -&gt; Base db
</span><a href="Data.Delta.html#state_"><span class="hs-identifier hs-var hs-var">state_</span></a></span><span> </span><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679209514"><span class="hs-identifier hs-var">mab2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">db
</span><a href="#local-6989586621679209515"><span class="hs-identifier hs-var">db</span></a></span><span>
</span><span id="line-390"></span><span>                        </span><span class="annot"><span class="annottext">Machine da db -&gt; m ()
</span><a href="#local-6989586621679209531"><span class="hs-identifier hs-var">writeMachine</span></a></span><span> </span><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679209514"><span class="hs-identifier hs-var">mab2</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span class="annot"><span class="annottext">Store m da -&gt; m (Store m da)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Store m da -&gt; m (Store m da)) -&gt; Store m da -&gt; m (Store m da)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Store :: forall (m :: * -&gt; *) da.
m (Either SomeException (Base da))
-&gt; (Base da -&gt; m ()) -&gt; (Base da -&gt; da -&gt; m ()) -&gt; Store m da
</span><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">loadS :: m (Either SomeException (Base da))
</span><a href="Data.DBVar.html#loadS"><span class="hs-identifier hs-var">loadS</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">m (Either SomeException (Base da))
</span><a href="#local-6989586621679209530"><span class="hs-identifier hs-var">load</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">writeS :: Base da -&gt; m ()
</span><a href="Data.DBVar.html#writeS"><span class="hs-identifier hs-var">writeS</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">Base da -&gt; m ()
</span><a href="#local-6989586621679209524"><span class="hs-identifier hs-var">write</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">updateS :: Base da -&gt; da -&gt; m ()
</span><a href="Data.DBVar.html#updateS"><span class="hs-identifier hs-var">updateS</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">Base da -&gt; da -&gt; m ()
</span><a href="#local-6989586621679209519"><span class="hs-identifier hs-var">update</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span class="hs-comment">-- | Obtain a 'Store' for one type @a1@ from a 'Store' for another type @a2@</span><span>
</span><span id="line-395"></span><span class="hs-comment">-- via an 'Embedding'' of the first type into the second type.</span><span>
</span><span id="line-396"></span><span class="hs-comment">--</span><span>
</span><span id="line-397"></span><span class="hs-comment">-- Note: This function is exported for testing and documentation only,</span><span>
</span><span id="line-398"></span><span class="hs-comment">-- use the more efficient 'embedStore' instead.</span><span>
</span><span id="line-399"></span><span id="local-6989586621679209509"><span id="local-6989586621679209510"><span id="local-6989586621679209511"><span class="annot"><a href="Data.DBVar.html#embedStore%27"><span class="hs-identifier hs-type">embedStore'</span></a></span><span>
</span><span id="line-400"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209511"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../io-classes/html/src"><span class="hs-identifier hs-type">MonadThrow</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209511"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-401"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.Delta.html#Embedding%27"><span class="hs-identifier hs-type">Embedding'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209510"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209509"><span class="hs-identifier hs-type">db</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209511"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209509"><span class="hs-identifier hs-type">db</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209511"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209510"><span class="hs-identifier hs-type">da</span></a></span></span></span></span><span>
</span><span id="line-402"></span><span id="embedStore%27"><span class="annot"><span class="annottext">embedStore' :: Embedding' da db -&gt; Store m db -&gt; Store m da
</span><a href="Data.DBVar.html#embedStore%27"><span class="hs-identifier hs-var hs-var">embedStore'</span></a></span></span><span> </span><span class="annot"><a href="Data.Delta.html#Embedding%27"><span class="hs-identifier hs-type">Embedding'</span></a></span><span class="hs-special">{</span><span id="local-6989586621679209507"><span class="annot"><span class="annottext">b -&gt; Either SomeException a
load :: ()
load :: b -&gt; Either SomeException a
</span><a href="Data.Delta.html#load"><span class="hs-identifier hs-var hs-var">load</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679209505"><span class="annot"><span class="annottext">a -&gt; b
write :: ()
write :: a -&gt; b
</span><a href="Data.Delta.html#write"><span class="hs-identifier hs-var hs-var">write</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679209503"><span class="annot"><span class="annottext">a -&gt; b -&gt; da -&gt; db
update :: ()
update :: a -&gt; b -&gt; da -&gt; db
</span><a href="Data.Delta.html#update"><span class="hs-identifier hs-var hs-var">update</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span class="hs-special">{</span><span id="local-6989586621679209501"><span class="annot"><span class="annottext">m (Either SomeException (Base db))
loadS :: m (Either SomeException (Base db))
loadS :: forall (m :: * -&gt; *) da.
Store m da -&gt; m (Either SomeException (Base da))
</span><a href="#local-6989586621679209501"><span class="hs-identifier hs-var hs-var">loadS</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679209500"><span class="annot"><span class="annottext">Base db -&gt; m ()
writeS :: Base db -&gt; m ()
writeS :: forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; m ()
</span><a href="#local-6989586621679209500"><span class="hs-identifier hs-var hs-var">writeS</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679209499"><span class="annot"><span class="annottext">Base db -&gt; db -&gt; m ()
updateS :: Base db -&gt; db -&gt; m ()
updateS :: forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; da -&gt; m ()
</span><a href="#local-6989586621679209499"><span class="hs-identifier hs-var hs-var">updateS</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store :: forall (m :: * -&gt; *) da.
m (Either SomeException (Base da))
-&gt; (Base da -&gt; m ()) -&gt; (Base da -&gt; da -&gt; m ()) -&gt; Store m da
</span><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">loadS :: m (Either SomeException (Base da))
</span><a href="Data.DBVar.html#loadS"><span class="hs-identifier hs-var">loadS</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Either SomeException a
</span><a href="#local-6989586621679209507"><span class="hs-identifier hs-var">load</span></a></span><span> </span><span class="annot"><span class="annottext">(b -&gt; Either SomeException a)
-&gt; Either SomeException b -&gt; Either SomeException a
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Either SomeException b -&gt; Either SomeException a)
-&gt; m (Either SomeException b) -&gt; m (Either SomeException a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException b)
m (Either SomeException (Base db))
</span><a href="#local-6989586621679209501"><span class="hs-identifier hs-var">loadS</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">writeS :: Base da -&gt; m ()
</span><a href="Data.DBVar.html#writeS"><span class="hs-identifier hs-var">writeS</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b -&gt; m ()
Base db -&gt; m ()
</span><a href="#local-6989586621679209500"><span class="hs-identifier hs-var">writeS</span></a></span><span> </span><span class="annot"><span class="annottext">(b -&gt; m ()) -&gt; (a -&gt; b) -&gt; a -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621679209505"><span class="hs-identifier hs-var">write</span></a></span><span>
</span><span id="line-405"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">updateS :: Base da -&gt; da -&gt; m ()
</span><a href="Data.DBVar.html#updateS"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679209496"><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679209496"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679209495"><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679209495"><span class="hs-identifier hs-var">da</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (Either SomeException b)
m (Either SomeException (Base db))
</span><a href="#local-6989586621679209501"><span class="hs-identifier hs-var">loadS</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException b)
-&gt; (Either SomeException b -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-406"></span><span>            </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>            </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679209494"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679209494"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Base db -&gt; db -&gt; m ()
</span><a href="#local-6989586621679209499"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="annot"><span class="annottext">b
Base db
</span><a href="#local-6989586621679209494"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; b -&gt; da -&gt; db
</span><a href="#local-6989586621679209503"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">a
Base da
</span><a href="#local-6989586621679209496"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679209494"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679209495"><span class="hs-identifier hs-var">da</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span class="hs-comment">-- | Combine two 'Stores' into a store for pairs.</span><span>
</span><span id="line-411"></span><span class="hs-comment">--</span><span>
</span><span id="line-412"></span><span class="hs-comment">-- WARNING: The 'updateS' and 'writeS' functions of the result are not atomic</span><span>
</span><span id="line-413"></span><span class="hs-comment">-- in the presence of asynchronous exceptions.</span><span>
</span><span id="line-414"></span><span class="hs-comment">-- For example, the update of the first store may succeed while the update of</span><span>
</span><span id="line-415"></span><span class="hs-comment">-- the second store may fail.</span><span>
</span><span id="line-416"></span><span class="hs-comment">-- In other words, this combinator works for some monads, such as @m = @'STM',</span><span>
</span><span id="line-417"></span><span class="hs-comment">-- but fails for others, such as @m = 'IO'@.</span><span>
</span><span id="line-418"></span><span id="local-6989586621679209491"><span id="local-6989586621679209492"><span id="local-6989586621679209493"><span class="annot"><a href="Data.DBVar.html#pairStores"><span class="hs-identifier hs-type">pairStores</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209493"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209493"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209492"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209493"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209491"><span class="hs-identifier hs-type">db</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679209493"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679209492"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679209491"><span class="hs-identifier hs-type">db</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-419"></span><span id="pairStores"><span class="annot"><span class="annottext">pairStores :: Store m da -&gt; Store m db -&gt; Store m (da, db)
</span><a href="Data.DBVar.html#pairStores"><span class="hs-identifier hs-var hs-var">pairStores</span></a></span></span><span> </span><span id="local-6989586621679209490"><span class="annot"><span class="annottext">Store m da
</span><a href="#local-6989586621679209490"><span class="hs-identifier hs-var">sa</span></a></span></span><span> </span><span id="local-6989586621679209489"><span class="annot"><span class="annottext">Store m db
</span><a href="#local-6989586621679209489"><span class="hs-identifier hs-var">sb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store :: forall (m :: * -&gt; *) da.
m (Either SomeException (Base da))
-&gt; (Base da -&gt; m ()) -&gt; (Base da -&gt; da -&gt; m ()) -&gt; Store m da
</span><a href="Data.DBVar.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span>
</span><span id="line-420"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">loadS :: m (Either SomeException (Base (da, db)))
</span><a href="Data.DBVar.html#loadS"><span class="hs-identifier hs-var">loadS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Base da -&gt; Base db -&gt; (Base da, Base db))
-&gt; Either SomeException (Base da)
-&gt; Either SomeException (Base db)
-&gt; Either SomeException (Base da, Base db)
forall (f :: * -&gt; *) a b c.
Applicative f =&gt;
(a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftA2</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Either SomeException (Base da)
 -&gt; Either SomeException (Base db)
 -&gt; Either SomeException (Base da, Base db))
-&gt; m (Either SomeException (Base da))
-&gt; m (Either SomeException (Base db)
      -&gt; Either SomeException (Base da, Base db))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Store m da -&gt; m (Either SomeException (Base da))
forall (m :: * -&gt; *) da.
Store m da -&gt; m (Either SomeException (Base da))
</span><a href="Data.DBVar.html#loadS"><span class="hs-identifier hs-var hs-var">loadS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m da
</span><a href="#local-6989586621679209490"><span class="hs-identifier hs-var">sa</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (Base db)
   -&gt; Either SomeException (Base da, Base db))
-&gt; m (Either SomeException (Base db))
-&gt; m (Either SomeException (Base da, Base db))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Store m db -&gt; m (Either SomeException (Base db))
forall (m :: * -&gt; *) da.
Store m da -&gt; m (Either SomeException (Base da))
</span><a href="Data.DBVar.html#loadS"><span class="hs-identifier hs-var hs-var">loadS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m db
</span><a href="#local-6989586621679209489"><span class="hs-identifier hs-var">sb</span></a></span><span>
</span><span id="line-421"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">writeS :: Base (da, db) -&gt; m ()
</span><a href="Data.DBVar.html#writeS"><span class="hs-identifier hs-var">writeS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679209488"><span class="annot"><a href="#local-6989586621679209488"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679209487"><span class="annot"><a href="#local-6989586621679209487"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Store m da -&gt; Base da -&gt; m ()
forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; m ()
</span><a href="Data.DBVar.html#writeS"><span class="hs-identifier hs-var hs-var">writeS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m da
</span><a href="#local-6989586621679209490"><span class="hs-identifier hs-var">sa</span></a></span><span> </span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679209488"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Store m db -&gt; Base db -&gt; m ()
forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; m ()
</span><a href="Data.DBVar.html#writeS"><span class="hs-identifier hs-var hs-var">writeS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m db
</span><a href="#local-6989586621679209489"><span class="hs-identifier hs-var">sb</span></a></span><span> </span><span class="annot"><span class="annottext">Base db
</span><a href="#local-6989586621679209487"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-422"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">updateS :: Base (da, db) -&gt; (da, db) -&gt; m ()
</span><a href="Data.DBVar.html#updateS"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679209486"><span class="annot"><a href="#local-6989586621679209486"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679209485"><span class="annot"><a href="#local-6989586621679209485"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679209484"><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679209484"><span class="hs-identifier hs-var">da</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679209483"><span class="annot"><span class="annottext">db
</span><a href="#local-6989586621679209483"><span class="hs-identifier hs-var">db</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Store m da -&gt; Base da -&gt; da -&gt; m ()
forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; da -&gt; m ()
</span><a href="Data.DBVar.html#updateS"><span class="hs-identifier hs-var hs-var">updateS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m da
</span><a href="#local-6989586621679209490"><span class="hs-identifier hs-var">sa</span></a></span><span> </span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679209486"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679209484"><span class="hs-identifier hs-var">da</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Store m db -&gt; Base db -&gt; db -&gt; m ()
forall (m :: * -&gt; *) da. Store m da -&gt; Base da -&gt; da -&gt; m ()
</span><a href="Data.DBVar.html#updateS"><span class="hs-identifier hs-var hs-var">updateS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m db
</span><a href="#local-6989586621679209489"><span class="hs-identifier hs-var">sb</span></a></span><span> </span><span class="annot"><span class="annottext">Base db
</span><a href="#local-6989586621679209485"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">db
</span><a href="#local-6989586621679209483"><span class="hs-identifier hs-var">db</span></a></span><span>
</span><span id="line-423"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-424"></span></pre></body></html>