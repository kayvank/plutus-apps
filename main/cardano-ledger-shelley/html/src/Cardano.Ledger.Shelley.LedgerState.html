<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE DerivingVia #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE GADTs #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-17"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving #-}</span><span>
</span><span id="line-18"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-19"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-20"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-21"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- Module      : LedgerState</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- Description : Operational Rules</span><span>
</span><span id="line-26"></span><span class="hs-comment">--</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- This module implements the operation rules for treating UTxO transactions ('Tx')</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- as state transformations on a ledger state ('LedgerState'),</span><span>
</span><span id="line-29"></span><span class="hs-comment">-- as specified in /A Simplified Formal Specification of a UTxO Ledger/.</span><span>
</span><span id="line-30"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Cardano.Ledger.Shelley.LedgerState</span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#AccountState"><span class="hs-identifier">AccountState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier">DPState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier">DState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#emptyDState"><span class="hs-identifier">emptyDState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#rewards"><span class="hs-identifier">rewards</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#delegations"><span class="hs-identifier">delegations</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#ptrsMap"><span class="hs-identifier">ptrsMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier">EpochState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UpecState"><span class="hs-identifier">UpecState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#PulsingRewUpdate"><span class="hs-identifier">PulsingRewUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#FutureGenDeleg"><span class="hs-identifier">FutureGenDeleg</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#InstantaneousRewards"><span class="hs-identifier">InstantaneousRewards</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#KeyPairs"><span class="hs-identifier">KeyPairs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier">LedgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PPUPState"><span class="hs-identifier">PPUPState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier">PState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#RewardAccounts"><span class="hs-identifier">RewardAccounts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardUpdate"><span class="hs-identifier">RewardUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardSnapShot"><span class="hs-identifier">RewardSnapShot</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier">UTxOState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#smartUTxOState"><span class="hs-identifier">smartUTxOState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-52"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier">IncrementalStake</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#depositPoolChange"><span class="hs-identifier">depositPoolChange</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-54"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#emptyRewardUpdate"><span class="hs-identifier">emptyRewardUpdate</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#pvCanFollow"><span class="hs-identifier">pvCanFollow</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#reapRewards"><span class="hs-identifier">reapRewards</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#availableAfterMIR"><span class="hs-identifier">availableAfterMIR</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Genesis State</span></span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#genesisState"><span class="hs-identifier">genesisState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Validation</span></span><span>
</span><span id="line-63"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier">WitHashes</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-64"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#nullWitHashes"><span class="hs-identifier">nullWitHashes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#diffWitHashes"><span class="hs-identifier">diffWitHashes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-66"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#minfee"><span class="hs-identifier">minfee</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-67"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#txsizeBound"><span class="hs-identifier">txsizeBound</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#produced"><span class="hs-identifier">produced</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#consumed"><span class="hs-identifier">consumed</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#witsFromTxWitnesses"><span class="hs-identifier">witsFromTxWitnesses</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#propWits"><span class="hs-identifier">propWits</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><span class="hs-comment">-- * DelegationState</span></span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#keyRefunds"><span class="hs-identifier">keyRefunds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Epoch boundary</span></span><span>
</span><span id="line-77"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#incrementalStakeDistr"><span class="hs-identifier">incrementalStakeDistr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-78"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#updateStakeDistribution"><span class="hs-identifier">updateStakeDistribution</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#applyRUpd"><span class="hs-identifier">applyRUpd</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#applyRUpd%27"><span class="hs-identifier">applyRUpd'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-81"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#filterAllRewards"><span class="hs-identifier">filterAllRewards</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#createRUpd"><span class="hs-identifier">createRUpd</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#completeRupd"><span class="hs-identifier">completeRupd</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#startStep"><span class="hs-identifier">startStep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-85"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#pulseStep"><span class="hs-identifier">pulseStep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#completeStep"><span class="hs-identifier">completeStep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier">NewEpochState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier">NewEpochState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#nesEL"><span class="hs-identifier">nesEL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#nesEs"><span class="hs-identifier">nesEs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#nesRu"><span class="hs-identifier">nesRu</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#nesPd"><span class="hs-identifier">nesPd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#nesBprev"><span class="hs-identifier">nesBprev</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#nesBcur"><span class="hs-identifier">nesBcur</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-88"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#StashedAVVMAddresses"><span class="hs-identifier">StashedAVVMAddresses</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#stashedAVVMAddresses"><span class="hs-identifier">stashedAVVMAddresses</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#getGKeys"><span class="hs-identifier">getGKeys</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-91"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#updateNES"><span class="hs-identifier">updateNES</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#circulation"><span class="hs-identifier">circulation</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Decay</span></span><span>
</span><span id="line-95"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#decayFactor"><span class="hs-identifier">decayFactor</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Remove Bootstrap Redeem Addresses</span></span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#returnRedeemAddrsToReserves"><span class="hs-identifier">returnRedeemAddrsToReserves</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-99"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#updateNonMyopic"><span class="hs-identifier">updateNonMyopic</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span class="hs-keyword">where</span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier">Cardano.Binary</span></a></span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><a href="../../../../cborg/html/src"><span class="hs-identifier">encodeListLen</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Address</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Addr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">isBootstrapRedeemer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.BaseTypes</span></a></span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">ActiveSlotCoeff</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-111"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">BlocksMade</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">BoundedRational</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-113"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">NonNegativeInterval</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-114"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">ProtVer</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-115"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">ShelleyBase</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-116"></span><span>    </span><span class="annot"><a href="../../../../strict-containers/html/src"><span class="hs-identifier">StrictMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-117"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">UnitInterval</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-118"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">activeSlotVal</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Coin</span></a></span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Coin</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-122"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">DeltaCoin</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">addDeltaCoin</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">rationalToCoinViaFloor</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">toDeltaCoin</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Compactible</span></a></span><span>
</span><span id="line-128"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Core</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">PParamsDelta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Core</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Core</span></span><span>
</span><span id="line-130"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Credential</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Credential</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">StakeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">StakeRefBase</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">StakeRefPtr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Crypto</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Crypto</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Era</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Era</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">getTxOutBootstrapAddress</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Keys</span></a></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">GenDelegPair</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-135"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">GenDelegs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-136"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">KeyHash</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-137"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">KeyPair</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">KeyRole</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-139"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">asWitness</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.PoolDistr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">PoolDistr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.SafeHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">HashAnnotated</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Serialization</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">decodeRecordNamedT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">mapFromCBOR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">mapToCBOR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.html"><span class="hs-identifier">Cardano.Ledger.Shelley</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.html#ShelleyEra"><span class="hs-identifier">ShelleyEra</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.Address.Bootstrap.html"><span class="hs-identifier">Cardano.Ledger.Shelley.Address.Bootstrap</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.Address.Bootstrap.html#BootstrapWitness"><span class="hs-identifier">BootstrapWitness</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-147"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.Address.Bootstrap.html#bootstrapWitKeyHash"><span class="hs-identifier">bootstrapWitKeyHash</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.Constraints.html"><span class="hs-identifier">Cardano.Ledger.Shelley.Constraints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.Constraints.html#TransValue"><span class="hs-identifier">TransValue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.Delegation.Certificates.html"><span class="hs-identifier">Cardano.Ledger.Shelley.Delegation.Certificates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#DCert"><span class="hs-identifier">DCert</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.Delegation.Certificates.html#isDeRegKey"><span class="hs-identifier">isDeRegKey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.EpochBoundary.html"><span class="hs-identifier">Cardano.Ledger.Shelley.EpochBoundary</span></a></span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.EpochBoundary.html#SnapShot"><span class="hs-identifier">SnapShot</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-153"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.EpochBoundary.html#SnapShots"><span class="hs-identifier">SnapShots</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-154"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.EpochBoundary.html#Stake"><span class="hs-identifier">Stake</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-155"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.EpochBoundary.html#sumAllStake"><span class="hs-identifier">sumAllStake</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-156"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.EpochBoundary.html#sumStakePerPool"><span class="hs-identifier">sumStakePerPool</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.HardForks.html"><span class="hs-identifier">Cardano.Ledger.Shelley.HardForks</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HardForks</span></span><span>
</span><span id="line-159"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.PParams.html"><span class="hs-identifier">Cardano.Ledger.Shelley.PParams</span></a></span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.PParams.html#PParams"><span class="hs-identifier">PParams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-161"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.PParams.html#PParams%27"><span class="hs-identifier">PParams'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.PParams.html#ProposedPPUpdates"><span class="hs-identifier">ProposedPPUpdates</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-163"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.PParams.html#Update"><span class="hs-identifier">Update</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-164"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.PParams.html#emptyPPPUpdates"><span class="hs-identifier">emptyPPPUpdates</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-165"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.PoolRank.html"><span class="hs-identifier">Cardano.Ledger.Shelley.PoolRank</span></a></span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.PoolRank.html#Likelihood"><span class="hs-identifier">Likelihood</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-168"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.PoolRank.html#NonMyopic"><span class="hs-identifier">NonMyopic</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.PoolRank.html#applyDecay"><span class="hs-identifier">applyDecay</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-170"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.PoolRank.html#leaderProbability"><span class="hs-identifier">leaderProbability</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.PoolRank.html#likelihood"><span class="hs-identifier">likelihood</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardProvenance.html"><span class="hs-identifier">Cardano.Ledger.Shelley.RewardProvenance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardProvenance.html#RewardProvenance"><span class="hs-identifier">RewardProvenance</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardProvenance.html"><span class="hs-identifier">Cardano.Ledger.Shelley.RewardProvenance</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">RP</span></span><span>
</span><span id="line-175"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html"><span class="hs-identifier">Cardano.Ledger.Shelley.RewardUpdate</span></a></span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#FreeVars"><span class="hs-identifier">FreeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Pulser"><span class="hs-identifier">Pulser</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#PulsingRewUpdate"><span class="hs-identifier">PulsingRewUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardAns"><span class="hs-identifier">RewardAns</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardEvent"><span class="hs-identifier">RewardEvent</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardPulser"><span class="hs-identifier">RewardPulser</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-182"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardSnapShot"><span class="hs-identifier">RewardSnapShot</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-183"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardUpdate"><span class="hs-identifier">RewardUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#emptyRewardUpdate"><span class="hs-identifier">emptyRewardUpdate</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html"><span class="hs-identifier">Cardano.Ledger.Shelley.Rewards</span></a></span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#PoolRewardInfo"><span class="hs-identifier">PoolRewardInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-188"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#Reward"><span class="hs-identifier">Reward</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-189"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#StakeShare"><span class="hs-identifier">StakeShare</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-190"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#aggregateRewards"><span class="hs-identifier">aggregateRewards</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#filterRewards"><span class="hs-identifier">filterRewards</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-192"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#leaderRewardToGeneral"><span class="hs-identifier">leaderRewardToGeneral</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-193"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#mkPoolRewardInfo"><span class="hs-identifier">mkPoolRewardInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#sumRewards"><span class="hs-identifier">sumRewards</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html"><span class="hs-identifier">Cardano.Ledger.Shelley.TxBody</span></a></span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">EraIndependentTxBody</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#MIRPot"><span class="hs-identifier">MIRPot</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-199"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#PoolParams"><span class="hs-identifier">PoolParams</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-200"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Ptr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">RewardAcnt</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#Wdrl"><span class="hs-identifier">Wdrl</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#WitVKey"><span class="hs-identifier">WitVKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-204"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">getRwdCred</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#witKeyHash"><span class="hs-identifier">witKeyHash</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html"><span class="hs-identifier">Cardano.Ledger.Shelley.UTxO</span></a></span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier">UTxO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-209"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#balance"><span class="hs-identifier">balance</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-210"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#totalDeposits"><span class="hs-identifier">totalDeposits</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#txins"><span class="hs-identifier">txins</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-212"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#txouts"><span class="hs-identifier">txouts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Slot</span></a></span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier">EpochNo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier">EpochSize</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-217"></span><span>    </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier">SlotNo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.TxIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">TxIn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.UnifiedMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">Trip</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Triple</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">UMap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">UnifiedMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">View</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">ViewMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator">(&lt;+&gt;)</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator">(&lt;-&gt;)</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator">(&lt;&#215;&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier">Cardano.Ledger.Val</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Val</span></span><span>
</span><span id="line-223"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier">Control.DeepSeq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier">NFData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../mtl/html/src"><span class="hs-identifier">Control.Monad.State.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">evalStateT</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../mtl/html/src"><span class="hs-identifier">Control.Monad.Trans</span></a></span><span>
</span><span id="line-226"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier">Control.Provenance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier">ProvM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier">modifyM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier">runProvM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../set-algebra/html/src"><span class="hs-identifier">Control.SetAlgebra</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../set-algebra/html/src"><span class="hs-identifier">dom</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../set-algebra/html/src"><span class="hs-identifier">eval</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../set-algebra/html/src"><span class="hs-operator">(&#8712;)</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../set-algebra/html/src"><span class="hs-operator">(&#9665;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier">Control.State.Transition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier">STS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier">State</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">Data.Coders</span></a></span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">Decode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">From</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">RecD</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-231"></span><span>    </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">decode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-232"></span><span>    </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">decodeRecordNamed</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-233"></span><span>    </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-operator">(&lt;!)</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier">Data.Default.Class</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier">Default</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier">def</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">fold</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">toList</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../groups/html/src"><span class="hs-identifier">Data.Group</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../groups/html/src"><span class="hs-identifier">Group</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../groups/html/src"><span class="hs-identifier">invert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-240"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">Data.Pulse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">Pulsable</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">completeM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Ratio</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(%)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../strict-containers/html/src"><span class="hs-identifier">Data.Sequence.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../strict-containers/html/src"><span class="hs-identifier">StrictSeq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-245"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">Data.Sharing</span></a></span><span>
</span><span id="line-246"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Typeable</span></a></span><span>
</span><span id="line-247"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier">Data.UMap</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UM</span></span><span>
</span><span id="line-248"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../vector-map/html/src"><span class="hs-identifier">Data.VMap</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VMap</span></span><span>
</span><span id="line-249"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Word</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Word64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Records</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">HasField</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../microlens/html/src"><span class="hs-identifier">Lens.Micro</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../microlens/html/src"><span class="hs-identifier">_1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../microlens/html/src"><span class="hs-identifier">_2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier">NoThunks.Class</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Numeric.Natural</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Natural</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../quiet/html/src"><span class="hs-identifier">Quiet</span></a></span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="hs-comment">-- | Representation of a list of pairs of key pairs, e.g., pay and stake keys</span><span>
</span><span id="line-258"></span><span class="hs-keyword">type</span><span> </span><span id="KeyPairs"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#KeyPairs"><span class="hs-identifier hs-var">KeyPairs</span></a></span></span><span> </span><span id="local-6989586621679474272"><span class="annot"><a href="#local-6989586621679474272"><span class="hs-identifier hs-type">crypto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyPair</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Payment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474272"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyPair</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474272"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span class="hs-keyword">type</span><span> </span><span id="RewardAccounts"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#RewardAccounts"><span class="hs-identifier hs-var">RewardAccounts</span></a></span></span><span> </span><span id="local-6989586621679474270"><span class="annot"><a href="#local-6989586621679474270"><span class="hs-identifier hs-type">crypto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-261"></span><span>  </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474270"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span id="local-6989586621679474268"><span id="local-6989586621679474269"></span></span><span class="hs-keyword">data</span><span> </span><span id="FutureGenDeleg"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#FutureGenDeleg"><span class="hs-identifier hs-var">FutureGenDeleg</span></a></span></span><span> </span><span id="local-6989586621679475053"><span class="annot"><a href="#local-6989586621679475053"><span class="hs-identifier hs-type">crypto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FutureGenDeleg"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#FutureGenDeleg"><span class="hs-identifier hs-var">FutureGenDeleg</span></a></span></span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="fGenDelegSlot"><span class="annot"><span class="annottext">FutureGenDeleg crypto -&gt; SlotNo
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#fGenDelegSlot"><span class="hs-identifier hs-var hs-var">fGenDelegSlot</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">SlotNo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-265"></span><span>    </span><span id="fGenDelegGenKeyHash"><span class="annot"><span class="annottext">FutureGenDeleg crypto -&gt; KeyHash 'Genesis crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#fGenDelegGenKeyHash"><span class="hs-identifier hs-var hs-var">fGenDelegGenKeyHash</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Genesis</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679475053"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679474259"><span id="local-6989586621679474261"><span id="local-6989586621679474263"><span class="annot"><span class="annottext">Int -&gt; FutureGenDeleg crypto -&gt; ShowS
[FutureGenDeleg crypto] -&gt; ShowS
FutureGenDeleg crypto -&gt; String
(Int -&gt; FutureGenDeleg crypto -&gt; ShowS)
-&gt; (FutureGenDeleg crypto -&gt; String)
-&gt; ([FutureGenDeleg crypto] -&gt; ShowS)
-&gt; Show (FutureGenDeleg crypto)
forall crypto. Int -&gt; FutureGenDeleg crypto -&gt; ShowS
forall crypto. [FutureGenDeleg crypto] -&gt; ShowS
forall crypto. FutureGenDeleg crypto -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [FutureGenDeleg crypto] -&gt; ShowS
$cshowList :: forall crypto. [FutureGenDeleg crypto] -&gt; ShowS
show :: FutureGenDeleg crypto -&gt; String
$cshow :: forall crypto. FutureGenDeleg crypto -&gt; String
showsPrec :: Int -&gt; FutureGenDeleg crypto -&gt; ShowS
$cshowsPrec :: forall crypto. Int -&gt; FutureGenDeleg crypto -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679474254"><span id="local-6989586621679474256"><span class="annot"><span class="annottext">FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
(FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool)
-&gt; (FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool)
-&gt; Eq (FutureGenDeleg crypto)
forall crypto.
FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
$c/= :: forall crypto.
FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
== :: FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
$c== :: forall crypto.
FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679474238"><span id="local-6989586621679474240"><span id="local-6989586621679474242"><span id="local-6989586621679474244"><span id="local-6989586621679474246"><span id="local-6989586621679474248"><span id="local-6989586621679474250"><span class="annot"><span class="annottext">Eq (FutureGenDeleg crypto)
Eq (FutureGenDeleg crypto)
-&gt; (FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Ordering)
-&gt; (FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool)
-&gt; (FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool)
-&gt; (FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool)
-&gt; (FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool)
-&gt; (FutureGenDeleg crypto
    -&gt; FutureGenDeleg crypto -&gt; FutureGenDeleg crypto)
-&gt; (FutureGenDeleg crypto
    -&gt; FutureGenDeleg crypto -&gt; FutureGenDeleg crypto)
-&gt; Ord (FutureGenDeleg crypto)
FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Ordering
FutureGenDeleg crypto
-&gt; FutureGenDeleg crypto -&gt; FutureGenDeleg crypto
forall crypto. Eq (FutureGenDeleg crypto)
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
forall crypto.
FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
forall crypto.
FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Ordering
forall crypto.
FutureGenDeleg crypto
-&gt; FutureGenDeleg crypto -&gt; FutureGenDeleg crypto
min :: FutureGenDeleg crypto
-&gt; FutureGenDeleg crypto -&gt; FutureGenDeleg crypto
$cmin :: forall crypto.
FutureGenDeleg crypto
-&gt; FutureGenDeleg crypto -&gt; FutureGenDeleg crypto
max :: FutureGenDeleg crypto
-&gt; FutureGenDeleg crypto -&gt; FutureGenDeleg crypto
$cmax :: forall crypto.
FutureGenDeleg crypto
-&gt; FutureGenDeleg crypto -&gt; FutureGenDeleg crypto
&gt;= :: FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
$c&gt;= :: forall crypto.
FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
&gt; :: FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
$c&gt; :: forall crypto.
FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
&lt;= :: FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
$c&lt;= :: forall crypto.
FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
&lt; :: FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
$c&lt; :: forall crypto.
FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Bool
compare :: FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Ordering
$ccompare :: forall crypto.
FutureGenDeleg crypto -&gt; FutureGenDeleg crypto -&gt; Ordering
$cp1Ord :: forall crypto. Eq (FutureGenDeleg crypto)
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. FutureGenDeleg crypto -&gt; Rep (FutureGenDeleg crypto) x)
-&gt; (forall x.
    Rep (FutureGenDeleg crypto) x -&gt; FutureGenDeleg crypto)
-&gt; Generic (FutureGenDeleg crypto)
forall x. Rep (FutureGenDeleg crypto) x -&gt; FutureGenDeleg crypto
forall x. FutureGenDeleg crypto -&gt; Rep (FutureGenDeleg crypto) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall crypto x.
Rep (FutureGenDeleg crypto) x -&gt; FutureGenDeleg crypto
forall crypto x.
FutureGenDeleg crypto -&gt; Rep (FutureGenDeleg crypto) x
$cto :: forall crypto x.
Rep (FutureGenDeleg crypto) x -&gt; FutureGenDeleg crypto
$cfrom :: forall crypto x.
FutureGenDeleg crypto -&gt; Rep (FutureGenDeleg crypto) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span id="local-6989586621679474233"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474227"><span id="local-6989586621679474229"><span id="local-6989586621679474231"><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#FutureGenDeleg"><span class="hs-identifier hs-type">FutureGenDeleg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474233"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span id="local-6989586621679474225"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474223"><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#FutureGenDeleg"><span class="hs-identifier hs-type">FutureGenDeleg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474225"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span id="local-6989586621679474221"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474215"><span id="local-6989586621679474217"><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474221"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#FutureGenDeleg"><span class="hs-identifier hs-type">FutureGenDeleg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474221"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-274"></span><span>  </span><span id="local-6989586621679474213"><span class="annot"><span class="annottext">toCBOR :: FutureGenDeleg crypto -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">toCBOR</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#FutureGenDeleg"><span class="hs-identifier hs-type">FutureGenDeleg</span></a></span><span> </span><span id="local-6989586621679474211"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679474211"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679474210"><span class="annot"><span class="annottext">KeyHash 'Genesis crypto
</span><a href="#local-6989586621679474210"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-275"></span><span>    </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><a href="../../../../cborg/html/src"><span class="hs-identifier hs-var">encodeListLen</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679474211"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">KeyHash 'Genesis crypto -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">KeyHash 'Genesis crypto
</span><a href="#local-6989586621679474210"><span class="hs-identifier hs-var">b</span></a></span></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span id="local-6989586621679474209"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474205"><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474209"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#FutureGenDeleg"><span class="hs-identifier hs-type">FutureGenDeleg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474209"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-278"></span><span>  </span><span id="local-6989586621679474203"><span class="annot"><span class="annottext">fromCBOR :: Decoder s (FutureGenDeleg crypto)
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromCBOR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-279"></span><span>    </span><span class="annot"><span class="annottext">Text
-&gt; (FutureGenDeleg crypto -&gt; Int)
-&gt; Decoder s (FutureGenDeleg crypto)
-&gt; Decoder s (FutureGenDeleg crypto)
forall a s. Text -&gt; (a -&gt; Int) -&gt; Decoder s a -&gt; Decoder s a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">decodeRecordNamed</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;FutureGenDeleg&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; FutureGenDeleg crypto -&gt; Int
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Decoder s (FutureGenDeleg crypto)
 -&gt; Decoder s (FutureGenDeleg crypto))
-&gt; Decoder s (FutureGenDeleg crypto)
-&gt; Decoder s (FutureGenDeleg crypto)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-280"></span><span>      </span><span class="annot"><span class="annottext">SlotNo -&gt; KeyHash 'Genesis crypto -&gt; FutureGenDeleg crypto
forall crypto.
SlotNo -&gt; KeyHash 'Genesis crypto -&gt; FutureGenDeleg crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#FutureGenDeleg"><span class="hs-identifier hs-var">FutureGenDeleg</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; KeyHash 'Genesis crypto -&gt; FutureGenDeleg crypto)
-&gt; Decoder s SlotNo
-&gt; Decoder s (KeyHash 'Genesis crypto -&gt; FutureGenDeleg crypto)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s SlotNo
forall a s. FromCBOR a =&gt; Decoder s a
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">fromCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s (KeyHash 'Genesis crypto -&gt; FutureGenDeleg crypto)
-&gt; Decoder s (KeyHash 'Genesis crypto)
-&gt; Decoder s (FutureGenDeleg crypto)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s (KeyHash 'Genesis crypto)
forall a s. FromCBOR a =&gt; Decoder s a
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">fromCBOR</span></a></span></span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span class="hs-comment">-- | InstantaneousRewards captures the pending changes to the ledger</span><span>
</span><span id="line-283"></span><span class="hs-comment">-- state caused by MIR certificates. It consists of two mappings,</span><span>
</span><span id="line-284"></span><span class="hs-comment">-- the rewards which will be paid out from the reserves and the rewards</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- which will be paid out from the treasury. It also consists of</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- two coin values which represent the transfer of coins from</span><span>
</span><span id="line-287"></span><span class="hs-comment">-- one pot to the other pot.</span><span>
</span><span id="line-288"></span><span class="hs-comment">-- NOTE that the following property should always hold:</span><span>
</span><span id="line-289"></span><span class="hs-comment">--   deltaReserves + deltaTreasury = 0</span><span>
</span><span id="line-290"></span><span id="local-6989586621679474198"><span id="local-6989586621679474199"></span></span><span class="hs-keyword">data</span><span> </span><span id="InstantaneousRewards"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#InstantaneousRewards"><span class="hs-identifier hs-var">InstantaneousRewards</span></a></span></span><span> </span><span id="local-6989586621679475028"><span class="annot"><a href="#local-6989586621679475028"><span class="hs-identifier hs-type">crypto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="InstantaneousRewards"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#InstantaneousRewards"><span class="hs-identifier hs-var">InstantaneousRewards</span></a></span></span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="iRReserves"><span class="annot"><span class="annottext">InstantaneousRewards crypto
-&gt; Map (Credential 'Staking crypto) Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#iRReserves"><span class="hs-identifier hs-var hs-var">iRReserves</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679475028"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-292"></span><span>    </span><span id="iRTreasury"><span class="annot"><span class="annottext">InstantaneousRewards crypto
-&gt; Map (Credential 'Staking crypto) Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#iRTreasury"><span class="hs-identifier hs-var hs-var">iRTreasury</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679475028"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-293"></span><span>    </span><span id="deltaReserves"><span class="annot"><span class="annottext">InstantaneousRewards crypto -&gt; DeltaCoin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#deltaReserves"><span class="hs-identifier hs-var hs-var">deltaReserves</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">DeltaCoin</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-294"></span><span>    </span><span id="deltaTreasury"><span class="annot"><span class="annottext">InstantaneousRewards crypto -&gt; DeltaCoin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#deltaTreasury"><span class="hs-identifier hs-var hs-var">deltaTreasury</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">DeltaCoin</span></a></span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679474187"><span id="local-6989586621679474189"><span id="local-6989586621679474191"><span class="annot"><span class="annottext">Int -&gt; InstantaneousRewards crypto -&gt; ShowS
[InstantaneousRewards crypto] -&gt; ShowS
InstantaneousRewards crypto -&gt; String
(Int -&gt; InstantaneousRewards crypto -&gt; ShowS)
-&gt; (InstantaneousRewards crypto -&gt; String)
-&gt; ([InstantaneousRewards crypto] -&gt; ShowS)
-&gt; Show (InstantaneousRewards crypto)
forall crypto. Int -&gt; InstantaneousRewards crypto -&gt; ShowS
forall crypto. [InstantaneousRewards crypto] -&gt; ShowS
forall crypto. InstantaneousRewards crypto -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [InstantaneousRewards crypto] -&gt; ShowS
$cshowList :: forall crypto. [InstantaneousRewards crypto] -&gt; ShowS
show :: InstantaneousRewards crypto -&gt; String
$cshow :: forall crypto. InstantaneousRewards crypto -&gt; String
showsPrec :: Int -&gt; InstantaneousRewards crypto -&gt; ShowS
$cshowsPrec :: forall crypto. Int -&gt; InstantaneousRewards crypto -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679474183"><span id="local-6989586621679474185"><span class="annot"><span class="annottext">InstantaneousRewards crypto -&gt; InstantaneousRewards crypto -&gt; Bool
(InstantaneousRewards crypto
 -&gt; InstantaneousRewards crypto -&gt; Bool)
-&gt; (InstantaneousRewards crypto
    -&gt; InstantaneousRewards crypto -&gt; Bool)
-&gt; Eq (InstantaneousRewards crypto)
forall crypto.
InstantaneousRewards crypto -&gt; InstantaneousRewards crypto -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: InstantaneousRewards crypto -&gt; InstantaneousRewards crypto -&gt; Bool
$c/= :: forall crypto.
InstantaneousRewards crypto -&gt; InstantaneousRewards crypto -&gt; Bool
== :: InstantaneousRewards crypto -&gt; InstantaneousRewards crypto -&gt; Bool
$c== :: forall crypto.
InstantaneousRewards crypto -&gt; InstantaneousRewards crypto -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x.
 InstantaneousRewards crypto -&gt; Rep (InstantaneousRewards crypto) x)
-&gt; (forall x.
    Rep (InstantaneousRewards crypto) x -&gt; InstantaneousRewards crypto)
-&gt; Generic (InstantaneousRewards crypto)
forall x.
Rep (InstantaneousRewards crypto) x -&gt; InstantaneousRewards crypto
forall x.
InstantaneousRewards crypto -&gt; Rep (InstantaneousRewards crypto) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall crypto x.
Rep (InstantaneousRewards crypto) x -&gt; InstantaneousRewards crypto
forall crypto x.
InstantaneousRewards crypto -&gt; Rep (InstantaneousRewards crypto) x
$cto :: forall crypto x.
Rep (InstantaneousRewards crypto) x -&gt; InstantaneousRewards crypto
$cfrom :: forall crypto x.
InstantaneousRewards crypto -&gt; Rep (InstantaneousRewards crypto) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span class="hs-comment">-- | This function returns the coin balance of a given pot, either the</span><span>
</span><span id="line-299"></span><span class="hs-comment">-- reserves or the treasury, after the instantaneous rewards and pot</span><span>
</span><span id="line-300"></span><span class="hs-comment">-- transfers are accounted for.</span><span>
</span><span id="line-301"></span><span id="local-6989586621679474180"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#availableAfterMIR"><span class="hs-identifier hs-type">availableAfterMIR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#MIRPot"><span class="hs-identifier hs-type">MIRPot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#AccountState"><span class="hs-identifier hs-type">AccountState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#InstantaneousRewards"><span class="hs-identifier hs-type">InstantaneousRewards</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474180"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span></span><span>
</span><span id="line-302"></span><span id="availableAfterMIR"><span class="annot"><span class="annottext">availableAfterMIR :: MIRPot -&gt; AccountState -&gt; InstantaneousRewards crypto -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#availableAfterMIR"><span class="hs-identifier hs-var hs-var">availableAfterMIR</span></a></span></span><span> </span><span class="annot"><span class="annottext">MIRPot
</span><a href="Cardano.Ledger.Shelley.TxBody.html#ReservesMIR"><span class="hs-identifier hs-var">ReservesMIR</span></a></span><span> </span><span id="local-6989586621679474178"><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679474178"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621679474177"><span class="annot"><span class="annottext">InstantaneousRewards crypto
</span><a href="#local-6989586621679474177"><span class="hs-identifier hs-var">ir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-303"></span><span>  </span><span class="annot"><span class="annottext">AccountState -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_reserves"><span class="hs-identifier hs-var hs-var">_reserves</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679474178"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; DeltaCoin -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">`addDeltaCoin`</span></a></span><span> </span><span class="annot"><span class="annottext">InstantaneousRewards crypto -&gt; DeltaCoin
forall crypto. InstantaneousRewards crypto -&gt; DeltaCoin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#deltaReserves"><span class="hs-identifier hs-var hs-var">deltaReserves</span></a></span><span> </span><span class="annot"><span class="annottext">InstantaneousRewards crypto
</span><a href="#local-6989586621679474177"><span class="hs-identifier hs-var">ir</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall t. Val t =&gt; t -&gt; t -&gt; t
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">&lt;-&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin -&gt; Coin
forall (t :: * -&gt; *) m. (Foldable t, Monoid m) =&gt; t m -&gt; m
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fold</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstantaneousRewards crypto
-&gt; Map (Credential 'Staking crypto) Coin
forall crypto.
InstantaneousRewards crypto
-&gt; Map (Credential 'Staking crypto) Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#iRReserves"><span class="hs-identifier hs-var hs-var">iRReserves</span></a></span><span> </span><span class="annot"><span class="annottext">InstantaneousRewards crypto
</span><a href="#local-6989586621679474177"><span class="hs-identifier hs-var">ir</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#availableAfterMIR"><span class="hs-identifier hs-var">availableAfterMIR</span></a></span><span> </span><span class="annot"><span class="annottext">MIRPot
</span><a href="Cardano.Ledger.Shelley.TxBody.html#TreasuryMIR"><span class="hs-identifier hs-var">TreasuryMIR</span></a></span><span> </span><span id="local-6989586621679474174"><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679474174"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621679474173"><span class="annot"><span class="annottext">InstantaneousRewards crypto
</span><a href="#local-6989586621679474173"><span class="hs-identifier hs-var">ir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-305"></span><span>  </span><span class="annot"><span class="annottext">AccountState -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_treasury"><span class="hs-identifier hs-var hs-var">_treasury</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679474174"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; DeltaCoin -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">`addDeltaCoin`</span></a></span><span> </span><span class="annot"><span class="annottext">InstantaneousRewards crypto -&gt; DeltaCoin
forall crypto. InstantaneousRewards crypto -&gt; DeltaCoin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#deltaTreasury"><span class="hs-identifier hs-var hs-var">deltaTreasury</span></a></span><span> </span><span class="annot"><span class="annottext">InstantaneousRewards crypto
</span><a href="#local-6989586621679474173"><span class="hs-identifier hs-var">ir</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall t. Val t =&gt; t -&gt; t -&gt; t
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">&lt;-&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin -&gt; Coin
forall (t :: * -&gt; *) m. (Foldable t, Monoid m) =&gt; t m -&gt; m
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fold</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstantaneousRewards crypto
-&gt; Map (Credential 'Staking crypto) Coin
forall crypto.
InstantaneousRewards crypto
-&gt; Map (Credential 'Staking crypto) Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#iRTreasury"><span class="hs-identifier hs-var hs-var">iRTreasury</span></a></span><span> </span><span class="annot"><span class="annottext">InstantaneousRewards crypto
</span><a href="#local-6989586621679474173"><span class="hs-identifier hs-var">ir</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span id="local-6989586621679474171"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474165"><span id="local-6989586621679474167"><span id="local-6989586621679474169"><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#InstantaneousRewards"><span class="hs-identifier hs-type">InstantaneousRewards</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474171"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span id="local-6989586621679474164"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474162"><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#InstantaneousRewards"><span class="hs-identifier hs-type">InstantaneousRewards</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474164"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span id="local-6989586621679474161"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474155"><span id="local-6989586621679474157"><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474161"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#InstantaneousRewards"><span class="hs-identifier hs-type">InstantaneousRewards</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474161"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-312"></span><span>  </span><span id="local-6989586621679474154"><span class="annot"><span class="annottext">toCBOR :: InstantaneousRewards crypto -&gt; Encoding
</span><a href="#local-6989586621679474154"><span class="hs-identifier hs-var hs-var hs-var hs-var">toCBOR</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#InstantaneousRewards"><span class="hs-identifier hs-type">InstantaneousRewards</span></a></span><span> </span><span id="local-6989586621679474153"><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679474153"><span class="hs-identifier hs-var">irR</span></a></span></span><span> </span><span id="local-6989586621679474152"><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679474152"><span class="hs-identifier hs-var">irT</span></a></span></span><span> </span><span id="local-6989586621679474151"><span class="annot"><span class="annottext">DeltaCoin
</span><a href="#local-6989586621679474151"><span class="hs-identifier hs-var">dR</span></a></span></span><span> </span><span id="local-6989586621679474150"><span class="annot"><span class="annottext">DeltaCoin
</span><a href="#local-6989586621679474150"><span class="hs-identifier hs-var">dT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-313"></span><span>    </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><a href="../../../../cborg/html/src"><span class="hs-identifier hs-var">encodeListLen</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">4</span></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin -&gt; Encoding
forall a b. (ToCBOR a, ToCBOR b) =&gt; Map a b -&gt; Encoding
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">mapToCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679474153"><span class="hs-identifier hs-var">irR</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin -&gt; Encoding
forall a b. (ToCBOR a, ToCBOR b) =&gt; Map a b -&gt; Encoding
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">mapToCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679474152"><span class="hs-identifier hs-var">irT</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaCoin -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaCoin
</span><a href="#local-6989586621679474151"><span class="hs-identifier hs-var">dR</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaCoin -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaCoin
</span><a href="#local-6989586621679474150"><span class="hs-identifier hs-var">dT</span></a></span></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span id="local-6989586621679474149"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474144"><span id="local-6989586621679474146"><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474149"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">FromSharedCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#InstantaneousRewards"><span class="hs-identifier hs-type">InstantaneousRewards</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474149"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-316"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="Share"><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">Share</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#InstantaneousRewards"><span class="hs-identifier hs-type">InstantaneousRewards</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474149"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Interns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474149"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>  </span><span id="local-6989586621679474141"><span class="annot"><span class="annottext">fromSharedPlusCBOR :: StateT
  (Share (InstantaneousRewards crypto))
  (Decoder s)
  (InstantaneousRewards crypto)
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromSharedPlusCBOR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>    </span><span class="annot"><span class="annottext">Text
-&gt; (InstantaneousRewards crypto -&gt; Int)
-&gt; StateT
     (Interns (Credential 'Staking crypto))
     (Decoder s)
     (InstantaneousRewards crypto)
-&gt; StateT
     (Interns (Credential 'Staking crypto))
     (Decoder s)
     (InstantaneousRewards crypto)
forall (m :: (* -&gt; *) -&gt; * -&gt; *) s a.
(MonadTrans m, Monad (m (Decoder s))) =&gt;
Text -&gt; (a -&gt; Int) -&gt; m (Decoder s) a -&gt; m (Decoder s) a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">decodeRecordNamedT</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;InstantaneousRewards&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; InstantaneousRewards crypto -&gt; Int
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT
   (Interns (Credential 'Staking crypto))
   (Decoder s)
   (InstantaneousRewards crypto)
 -&gt; StateT
      (Interns (Credential 'Staking crypto))
      (Decoder s)
      (InstantaneousRewards crypto))
-&gt; StateT
     (Interns (Credential 'Staking crypto))
     (Decoder s)
     (InstantaneousRewards crypto)
-&gt; StateT
     (Interns (Credential 'Staking crypto))
     (Decoder s)
     (InstantaneousRewards crypto)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-319"></span><span>      </span><span id="local-6989586621679474139"><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679474139"><span class="hs-identifier hs-var">irR</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lens'
  (Interns (Credential 'Staking crypto))
  (Share (Map (Credential 'Staking crypto) Coin))
-&gt; StateT
     (Interns (Credential 'Staking crypto))
     (Decoder s)
     (Map (Credential 'Staking crypto) Coin)
forall b bs s.
FromSharedCBOR b =&gt;
Lens' bs (Share b) -&gt; StateT bs (Decoder s) b
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedPlusLensCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lens'
  (Interns (Credential 'Staking crypto), Interns Coin)
  (Interns (Credential 'Staking crypto))
-&gt; Lens'
     (Interns (Credential 'Staking crypto))
     (Interns (Credential 'Staking crypto))
-&gt; Lens'
     (Interns (Credential 'Staking crypto))
     (Interns (Credential 'Staking crypto), Interns Coin)
forall a b c. Monoid a =&gt; Lens' a b -&gt; Lens' c b -&gt; Lens' c a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">toMemptyLens</span></a></span><span> </span><span class="annot"><span class="annottext">forall s t a b. Field1 s t a b =&gt; Lens s t a b
Lens'
  (Interns (Credential 'Staking crypto), Interns Coin)
  (Interns (Credential 'Staking crypto))
</span><a href="../../../../microlens/html/src"><span class="hs-identifier hs-var">_1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
Lens'
  (Interns (Credential 'Staking crypto))
  (Interns (Credential 'Staking crypto))
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>      </span><span id="local-6989586621679474135"><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679474135"><span class="hs-identifier hs-var">irT</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lens'
  (Interns (Credential 'Staking crypto))
  (Share (Map (Credential 'Staking crypto) Coin))
-&gt; StateT
     (Interns (Credential 'Staking crypto))
     (Decoder s)
     (Map (Credential 'Staking crypto) Coin)
forall b bs s.
FromSharedCBOR b =&gt;
Lens' bs (Share b) -&gt; StateT bs (Decoder s) b
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedPlusLensCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lens'
  (Interns (Credential 'Staking crypto), Interns Coin)
  (Interns (Credential 'Staking crypto))
-&gt; Lens'
     (Interns (Credential 'Staking crypto))
     (Interns (Credential 'Staking crypto))
-&gt; Lens'
     (Interns (Credential 'Staking crypto))
     (Interns (Credential 'Staking crypto), Interns Coin)
forall a b c. Monoid a =&gt; Lens' a b -&gt; Lens' c b -&gt; Lens' c a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">toMemptyLens</span></a></span><span> </span><span class="annot"><span class="annottext">forall s t a b. Field1 s t a b =&gt; Lens s t a b
Lens'
  (Interns (Credential 'Staking crypto), Interns Coin)
  (Interns (Credential 'Staking crypto))
</span><a href="../../../../microlens/html/src"><span class="hs-identifier hs-var">_1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
Lens'
  (Interns (Credential 'Staking crypto))
  (Interns (Credential 'Staking crypto))
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span>      </span><span id="local-6989586621679474134"><span class="annot"><span class="annottext">DeltaCoin
</span><a href="#local-6989586621679474134"><span class="hs-identifier hs-var">dR</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s DeltaCoin
-&gt; StateT
     (Interns (Credential 'Staking crypto)) (Decoder s) DeltaCoin
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s DeltaCoin
forall a s. FromCBOR a =&gt; Decoder s a
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">fromCBOR</span></a></span><span>
</span><span id="line-322"></span><span>      </span><span id="local-6989586621679474132"><span class="annot"><span class="annottext">DeltaCoin
</span><a href="#local-6989586621679474132"><span class="hs-identifier hs-var">dT</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s DeltaCoin
-&gt; StateT
     (Interns (Credential 'Staking crypto)) (Decoder s) DeltaCoin
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s DeltaCoin
forall a s. FromCBOR a =&gt; Decoder s a
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">fromCBOR</span></a></span><span>
</span><span id="line-323"></span><span>      </span><span class="annot"><span class="annottext">InstantaneousRewards crypto
-&gt; StateT
     (Interns (Credential 'Staking crypto))
     (Decoder s)
     (InstantaneousRewards crypto)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(InstantaneousRewards crypto
 -&gt; StateT
      (Interns (Credential 'Staking crypto))
      (Decoder s)
      (InstantaneousRewards crypto))
-&gt; InstantaneousRewards crypto
-&gt; StateT
     (Interns (Credential 'Staking crypto))
     (Decoder s)
     (InstantaneousRewards crypto)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
-&gt; Map (Credential 'Staking crypto) Coin
-&gt; DeltaCoin
-&gt; DeltaCoin
-&gt; InstantaneousRewards crypto
forall crypto.
Map (Credential 'Staking crypto) Coin
-&gt; Map (Credential 'Staking crypto) Coin
-&gt; DeltaCoin
-&gt; DeltaCoin
-&gt; InstantaneousRewards crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#InstantaneousRewards"><span class="hs-identifier hs-var">InstantaneousRewards</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679474139"><span class="hs-identifier hs-var">irR</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679474135"><span class="hs-identifier hs-var">irT</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaCoin
</span><a href="#local-6989586621679474134"><span class="hs-identifier hs-var">dR</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaCoin
</span><a href="#local-6989586621679474132"><span class="hs-identifier hs-var">dT</span></a></span></span><span>
</span><span id="line-324"></span><span>
</span><span id="line-325"></span><span class="hs-comment">-- | State of staking pool delegations and rewards</span><span>
</span><span id="line-326"></span><span id="local-6989586621679474130"><span id="local-6989586621679474131"></span></span><span class="hs-keyword">data</span><span> </span><span id="DState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-var">DState</span></a></span></span><span> </span><span id="local-6989586621679474952"><span class="annot"><a href="#local-6989586621679474952"><span class="hs-identifier hs-type">crypto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-var">DState</span></a></span></span><span>
</span><span id="line-327"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | Unified Reward Maps</span><span>
</span><span id="line-328"></span><span>    </span><span id="_unified"><span class="annot"><span class="annottext">DState crypto -&gt; UnifiedMap crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_unified"><span class="hs-identifier hs-var hs-var">_unified</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">UnifiedMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474952"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-329"></span><span>    </span><span class="hs-comment">-- | Future genesis key delegations</span><span>
</span><span id="line-330"></span><span>    </span><span id="_fGenDelegs"><span class="annot"><span class="annottext">DState crypto -&gt; Map (FutureGenDeleg crypto) (GenDelegPair crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_fGenDelegs"><span class="hs-identifier hs-var hs-var">_fGenDelegs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#FutureGenDeleg"><span class="hs-identifier hs-type">FutureGenDeleg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474952"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">GenDelegPair</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474952"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-331"></span><span>    </span><span class="hs-comment">-- | Genesis key delegations</span><span>
</span><span id="line-332"></span><span>    </span><span id="_genDelegs"><span class="annot"><span class="annottext">DState crypto -&gt; GenDelegs crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_genDelegs"><span class="hs-identifier hs-var hs-var">_genDelegs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">GenDelegs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474952"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-333"></span><span>    </span><span class="hs-comment">-- | Instantaneous Rewards</span><span>
</span><span id="line-334"></span><span>    </span><span id="_irwd"><span class="annot"><span class="annottext">DState crypto -&gt; InstantaneousRewards crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_irwd"><span class="hs-identifier hs-var hs-var">_irwd</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#InstantaneousRewards"><span class="hs-identifier hs-type">InstantaneousRewards</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474952"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-335"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679474119"><span id="local-6989586621679474121"><span id="local-6989586621679474123"><span class="annot"><span class="annottext">Int -&gt; DState crypto -&gt; ShowS
[DState crypto] -&gt; ShowS
DState crypto -&gt; String
(Int -&gt; DState crypto -&gt; ShowS)
-&gt; (DState crypto -&gt; String)
-&gt; ([DState crypto] -&gt; ShowS)
-&gt; Show (DState crypto)
forall crypto. Int -&gt; DState crypto -&gt; ShowS
forall crypto. [DState crypto] -&gt; ShowS
forall crypto. DState crypto -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [DState crypto] -&gt; ShowS
$cshowList :: forall crypto. [DState crypto] -&gt; ShowS
show :: DState crypto -&gt; String
$cshow :: forall crypto. DState crypto -&gt; String
showsPrec :: Int -&gt; DState crypto -&gt; ShowS
$cshowsPrec :: forall crypto. Int -&gt; DState crypto -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679474115"><span id="local-6989586621679474117"><span class="annot"><span class="annottext">DState crypto -&gt; DState crypto -&gt; Bool
(DState crypto -&gt; DState crypto -&gt; Bool)
-&gt; (DState crypto -&gt; DState crypto -&gt; Bool) -&gt; Eq (DState crypto)
forall crypto. DState crypto -&gt; DState crypto -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: DState crypto -&gt; DState crypto -&gt; Bool
$c/= :: forall crypto. DState crypto -&gt; DState crypto -&gt; Bool
== :: DState crypto -&gt; DState crypto -&gt; Bool
$c== :: forall crypto. DState crypto -&gt; DState crypto -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. DState crypto -&gt; Rep (DState crypto) x)
-&gt; (forall x. Rep (DState crypto) x -&gt; DState crypto)
-&gt; Generic (DState crypto)
forall x. Rep (DState crypto) x -&gt; DState crypto
forall x. DState crypto -&gt; Rep (DState crypto) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall crypto x. Rep (DState crypto) x -&gt; DState crypto
forall crypto x. DState crypto -&gt; Rep (DState crypto) x
$cto :: forall crypto x. Rep (DState crypto) x -&gt; DState crypto
$cfrom :: forall crypto x. DState crypto -&gt; Rep (DState crypto) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span class="hs-comment">-- ========================</span><span>
</span><span id="line-339"></span><span class="hs-comment">-- Virtual selectors, which get the appropriate view from a DState from the embedded UnifiedMap</span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span id="local-6989586621679474532"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#rewards"><span class="hs-identifier hs-type">rewards</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474532"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ViewMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474532"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474532"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span></span><span>
</span><span id="line-342"></span><span id="rewards"><span class="annot"><span class="annottext">rewards :: DState crypto -&gt; ViewMap crypto (Credential 'Staking crypto) Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#rewards"><span class="hs-identifier hs-var hs-var">rewards</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span id="local-6989586621679474112"><span class="annot"><span class="annottext">UnifiedMap crypto
</span><a href="#local-6989586621679474112"><span class="hs-identifier hs-var">unified</span></a></span></span><span> </span><span class="annot"><span class="annottext">Map (FutureGenDeleg crypto) (GenDelegPair crypto)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">GenDelegs crypto
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">InstantaneousRewards crypto
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifiedMap crypto
-&gt; ViewMap crypto (Credential 'Staking crypto) Coin
forall coin cr pl ptr.
UMap coin cr pl ptr -&gt; View coin cr pl ptr cr coin
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">Rewards</span></a></span><span> </span><span class="annot"><span class="annottext">UnifiedMap crypto
</span><a href="#local-6989586621679474112"><span class="hs-identifier hs-var">unified</span></a></span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span id="local-6989586621679474572"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#delegations"><span class="hs-identifier hs-type">delegations</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-345"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474572"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-346"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ViewMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474572"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474572"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">StakePool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474572"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-347"></span><span id="delegations"><span class="annot"><span class="annottext">delegations :: DState crypto
-&gt; ViewMap
     crypto (Credential 'Staking crypto) (KeyHash 'StakePool crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#delegations"><span class="hs-identifier hs-var hs-var">delegations</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span id="local-6989586621679474110"><span class="annot"><span class="annottext">UnifiedMap crypto
</span><a href="#local-6989586621679474110"><span class="hs-identifier hs-var">unified</span></a></span></span><span> </span><span class="annot"><span class="annottext">Map (FutureGenDeleg crypto) (GenDelegPair crypto)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">GenDelegs crypto
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">InstantaneousRewards crypto
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifiedMap crypto
-&gt; ViewMap
     crypto (Credential 'Staking crypto) (KeyHash 'StakePool crypto)
forall coin cr pl ptr.
UMap coin cr pl ptr -&gt; View coin cr pl ptr cr pl
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">Delegations</span></a></span><span> </span><span class="annot"><span class="annottext">UnifiedMap crypto
</span><a href="#local-6989586621679474110"><span class="hs-identifier hs-var">unified</span></a></span><span>
</span><span id="line-348"></span><span>
</span><span id="line-349"></span><span class="hs-comment">-- | get the actual ptrs map, we don't need a view</span><span>
</span><span id="line-350"></span><span id="local-6989586621679474108"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#ptrsMap"><span class="hs-identifier hs-type">ptrsMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474108"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474108"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-351"></span><span id="ptrsMap"><span class="annot"><span class="annottext">ptrsMap :: DState crypto -&gt; Map Ptr (Credential 'Staking crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#ptrsMap"><span class="hs-identifier hs-var hs-var">ptrsMap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">UnifiedMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking crypto)
  (Trip Coin Ptr (KeyHash 'StakePool crypto))
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679474106"><span class="annot"><span class="annottext">Map Ptr (Credential 'Staking crypto)
</span><a href="#local-6989586621679474106"><span class="hs-identifier hs-var">ptrmap</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map (FutureGenDeleg crypto) (GenDelegPair crypto)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">GenDelegs crypto
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">InstantaneousRewards crypto
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Ptr (Credential 'Staking crypto)
</span><a href="#local-6989586621679474106"><span class="hs-identifier hs-var">ptrmap</span></a></span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span class="hs-comment">-- =======================</span><span>
</span><span id="line-354"></span><span class="hs-comment">-- CBOR instances</span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span id="local-6989586621679474105"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474099"><span id="local-6989586621679474101"><span id="local-6989586621679474103"><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474105"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-357"></span><span>
</span><span id="line-358"></span><span id="local-6989586621679474098"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474096"><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474098"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span id="local-6989586621679474095"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474089"><span id="local-6989586621679474091"><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474095"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474095"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-361"></span><span>  </span><span id="local-6989586621679474088"><span class="annot"><span class="annottext">toCBOR :: DState crypto -&gt; Encoding
</span><a href="#local-6989586621679474088"><span class="hs-identifier hs-var hs-var hs-var hs-var">toCBOR</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span id="local-6989586621679474087"><span class="annot"><span class="annottext">UnifiedMap crypto
</span><a href="#local-6989586621679474087"><span class="hs-identifier hs-var">unified</span></a></span></span><span> </span><span id="local-6989586621679474086"><span class="annot"><span class="annottext">Map (FutureGenDeleg crypto) (GenDelegPair crypto)
</span><a href="#local-6989586621679474086"><span class="hs-identifier hs-var">fgs</span></a></span></span><span> </span><span id="local-6989586621679474085"><span class="annot"><span class="annottext">GenDelegs crypto
</span><a href="#local-6989586621679474085"><span class="hs-identifier hs-var">gs</span></a></span></span><span> </span><span id="local-6989586621679474084"><span class="annot"><span class="annottext">InstantaneousRewards crypto
</span><a href="#local-6989586621679474084"><span class="hs-identifier hs-var">ir</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-362"></span><span>    </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><a href="../../../../cborg/html/src"><span class="hs-identifier hs-var">encodeListLen</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">4</span></span><span>
</span><span id="line-363"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UnifiedMap crypto -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">UnifiedMap crypto
</span><a href="#local-6989586621679474087"><span class="hs-identifier hs-var">unified</span></a></span><span>
</span><span id="line-364"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (FutureGenDeleg crypto) (GenDelegPair crypto) -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Map (FutureGenDeleg crypto) (GenDelegPair crypto)
</span><a href="#local-6989586621679474086"><span class="hs-identifier hs-var">fgs</span></a></span><span>
</span><span id="line-365"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">GenDelegs crypto -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">GenDelegs crypto
</span><a href="#local-6989586621679474085"><span class="hs-identifier hs-var">gs</span></a></span><span>
</span><span id="line-366"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">InstantaneousRewards crypto -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">InstantaneousRewards crypto
</span><a href="#local-6989586621679474084"><span class="hs-identifier hs-var">ir</span></a></span></span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span id="local-6989586621679474083"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474078"><span id="local-6989586621679474080"><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474083"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">FromSharedCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474083"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-369"></span><span>  </span><span class="hs-keyword">type</span><span>
</span><span id="line-370"></span><span>    </span><span id="Share"><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">Share</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474083"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-371"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Interns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474083"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Interns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">StakePool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474083"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>  </span><span id="local-6989586621679474076"><span class="annot"><span class="annottext">fromSharedPlusCBOR :: StateT (Share (DState crypto)) (Decoder s) (DState crypto)
</span><a href="#local-6989586621679474076"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromSharedPlusCBOR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-373"></span><span>    </span><span class="annot"><span class="annottext">Text
-&gt; (DState crypto -&gt; Int)
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (DState crypto)
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (DState crypto)
forall (m :: (* -&gt; *) -&gt; * -&gt; *) s a.
(MonadTrans m, Monad (m (Decoder s))) =&gt;
Text -&gt; (a -&gt; Int) -&gt; m (Decoder s) a -&gt; m (Decoder s) a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">decodeRecordNamedT</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DState&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; DState crypto -&gt; Int
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT
   (Interns (Credential 'Staking crypto),
    Interns (KeyHash 'StakePool crypto))
   (Decoder s)
   (DState crypto)
 -&gt; StateT
      (Interns (Credential 'Staking crypto),
       Interns (KeyHash 'StakePool crypto))
      (Decoder s)
      (DState crypto))
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (DState crypto)
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (DState crypto)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-374"></span><span>      </span><span id="local-6989586621679474075"><span class="annot"><span class="annottext">UnifiedMap crypto
</span><a href="#local-6989586621679474075"><span class="hs-identifier hs-var">unified</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  (Interns (Credential 'Staking crypto),
   Interns (KeyHash 'StakePool crypto))
  (Decoder s)
  (UnifiedMap crypto)
forall a s. FromSharedCBOR a =&gt; StateT (Share a) (Decoder s) a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedPlusCBOR</span></a></span><span>
</span><span id="line-375"></span><span>      </span><span id="local-6989586621679474074"><span class="annot"><span class="annottext">Map (FutureGenDeleg crypto) (GenDelegPair crypto)
</span><a href="#local-6989586621679474074"><span class="hs-identifier hs-var">fgs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s (Map (FutureGenDeleg crypto) (GenDelegPair crypto))
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (Map (FutureGenDeleg crypto) (GenDelegPair crypto))
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s (Map (FutureGenDeleg crypto) (GenDelegPair crypto))
forall a s. FromCBOR a =&gt; Decoder s a
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">fromCBOR</span></a></span><span>
</span><span id="line-376"></span><span>      </span><span id="local-6989586621679474073"><span class="annot"><span class="annottext">GenDelegs crypto
</span><a href="#local-6989586621679474073"><span class="hs-identifier hs-var">gs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s (GenDelegs crypto)
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (GenDelegs crypto)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s (GenDelegs crypto)
forall a s. FromCBOR a =&gt; Decoder s a
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">fromCBOR</span></a></span><span>
</span><span id="line-377"></span><span>      </span><span id="local-6989586621679474072"><span class="annot"><span class="annottext">InstantaneousRewards crypto
</span><a href="#local-6989586621679474072"><span class="hs-identifier hs-var">ir</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lens'
  (Interns (Credential 'Staking crypto),
   Interns (KeyHash 'StakePool crypto))
  (Share (InstantaneousRewards crypto))
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (InstantaneousRewards crypto)
forall b bs s.
FromSharedCBOR b =&gt;
Lens' bs (Share b) -&gt; StateT bs (Decoder s) b
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedPlusLensCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">forall s t a b. Field1 s t a b =&gt; Lens s t a b
Lens'
  (Interns (Credential 'Staking crypto),
   Interns (KeyHash 'StakePool crypto))
  (Share (InstantaneousRewards crypto))
</span><a href="../../../../microlens/html/src"><span class="hs-identifier hs-var">_1</span></a></span><span>
</span><span id="line-378"></span><span>      </span><span class="annot"><span class="annottext">DState crypto
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (DState crypto)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(DState crypto
 -&gt; StateT
      (Interns (Credential 'Staking crypto),
       Interns (KeyHash 'StakePool crypto))
      (Decoder s)
      (DState crypto))
-&gt; DState crypto
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (DState crypto)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">UnifiedMap crypto
-&gt; Map (FutureGenDeleg crypto) (GenDelegPair crypto)
-&gt; GenDelegs crypto
-&gt; InstantaneousRewards crypto
-&gt; DState crypto
forall crypto.
UnifiedMap crypto
-&gt; Map (FutureGenDeleg crypto) (GenDelegPair crypto)
-&gt; GenDelegs crypto
-&gt; InstantaneousRewards crypto
-&gt; DState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-var">DState</span></a></span><span> </span><span class="annot"><span class="annottext">UnifiedMap crypto
</span><a href="#local-6989586621679474075"><span class="hs-identifier hs-var">unified</span></a></span><span> </span><span class="annot"><span class="annottext">Map (FutureGenDeleg crypto) (GenDelegPair crypto)
</span><a href="#local-6989586621679474074"><span class="hs-identifier hs-var">fgs</span></a></span><span> </span><span class="annot"><span class="annottext">GenDelegs crypto
</span><a href="#local-6989586621679474073"><span class="hs-identifier hs-var">gs</span></a></span><span> </span><span class="annot"><span class="annottext">InstantaneousRewards crypto
</span><a href="#local-6989586621679474072"><span class="hs-identifier hs-var">ir</span></a></span></span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span class="hs-comment">-- | Current state of staking pools and their certificate counters.</span><span>
</span><span id="line-381"></span><span id="local-6989586621679474070"><span id="local-6989586621679474071"></span></span><span class="hs-keyword">data</span><span> </span><span id="PState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier hs-var">PState</span></a></span></span><span> </span><span id="local-6989586621679474931"><span class="annot"><a href="#local-6989586621679474931"><span class="hs-identifier hs-type">crypto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier hs-var">PState</span></a></span></span><span>
</span><span id="line-382"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | The pool parameters.</span><span>
</span><span id="line-383"></span><span>    </span><span id="_pParams"><span class="annot"><span class="annottext">PState crypto
-&gt; Map (KeyHash 'StakePool crypto) (PoolParams crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_pParams"><span class="hs-identifier hs-var hs-var">_pParams</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">StakePool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474931"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#PoolParams"><span class="hs-identifier hs-type">PoolParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474931"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-384"></span><span>    </span><span class="hs-comment">-- | The future pool parameters.</span><span>
</span><span id="line-385"></span><span>    </span><span id="_fPParams"><span class="annot"><span class="annottext">PState crypto
-&gt; Map (KeyHash 'StakePool crypto) (PoolParams crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_fPParams"><span class="hs-identifier hs-var hs-var">_fPParams</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">StakePool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474931"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#PoolParams"><span class="hs-identifier hs-type">PoolParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474931"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-386"></span><span>    </span><span class="hs-comment">-- | A map of retiring stake pools to the epoch when they retire.</span><span>
</span><span id="line-387"></span><span>    </span><span id="_retiring"><span class="annot"><span class="annottext">PState crypto -&gt; Map (KeyHash 'StakePool crypto) EpochNo
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_retiring"><span class="hs-identifier hs-var hs-var">_retiring</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">StakePool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474931"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">EpochNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-389"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679474060"><span id="local-6989586621679474062"><span id="local-6989586621679474064"><span class="annot"><span class="annottext">Int -&gt; PState crypto -&gt; ShowS
[PState crypto] -&gt; ShowS
PState crypto -&gt; String
(Int -&gt; PState crypto -&gt; ShowS)
-&gt; (PState crypto -&gt; String)
-&gt; ([PState crypto] -&gt; ShowS)
-&gt; Show (PState crypto)
forall crypto. Int -&gt; PState crypto -&gt; ShowS
forall crypto. [PState crypto] -&gt; ShowS
forall crypto. PState crypto -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PState crypto] -&gt; ShowS
$cshowList :: forall crypto. [PState crypto] -&gt; ShowS
show :: PState crypto -&gt; String
$cshow :: forall crypto. PState crypto -&gt; String
showsPrec :: Int -&gt; PState crypto -&gt; ShowS
$cshowsPrec :: forall crypto. Int -&gt; PState crypto -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679474056"><span id="local-6989586621679474058"><span class="annot"><span class="annottext">PState crypto -&gt; PState crypto -&gt; Bool
(PState crypto -&gt; PState crypto -&gt; Bool)
-&gt; (PState crypto -&gt; PState crypto -&gt; Bool) -&gt; Eq (PState crypto)
forall crypto. PState crypto -&gt; PState crypto -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PState crypto -&gt; PState crypto -&gt; Bool
$c/= :: forall crypto. PState crypto -&gt; PState crypto -&gt; Bool
== :: PState crypto -&gt; PState crypto -&gt; Bool
$c== :: forall crypto. PState crypto -&gt; PState crypto -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. PState crypto -&gt; Rep (PState crypto) x)
-&gt; (forall x. Rep (PState crypto) x -&gt; PState crypto)
-&gt; Generic (PState crypto)
forall x. Rep (PState crypto) x -&gt; PState crypto
forall x. PState crypto -&gt; Rep (PState crypto) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall crypto x. Rep (PState crypto) x -&gt; PState crypto
forall crypto x. PState crypto -&gt; Rep (PState crypto) x
$cto :: forall crypto x. Rep (PState crypto) x -&gt; PState crypto
$cfrom :: forall crypto x. PState crypto -&gt; Rep (PState crypto) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-390"></span><span>
</span><span id="line-391"></span><span id="local-6989586621679474053"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474047"><span id="local-6989586621679474049"><span id="local-6989586621679474051"><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier hs-type">PState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474053"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span id="local-6989586621679474046"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474044"><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier hs-type">PState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474046"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span id="local-6989586621679474043"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474037"><span id="local-6989586621679474039"><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474043"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier hs-type">PState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474043"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-396"></span><span>  </span><span id="local-6989586621679474036"><span class="annot"><span class="annottext">toCBOR :: PState crypto -&gt; Encoding
</span><a href="#local-6989586621679474036"><span class="hs-identifier hs-var hs-var hs-var hs-var">toCBOR</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier hs-type">PState</span></a></span><span> </span><span id="local-6989586621679474035"><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
</span><a href="#local-6989586621679474035"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679474034"><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
</span><a href="#local-6989586621679474034"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679474033"><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) EpochNo
</span><a href="#local-6989586621679474033"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-397"></span><span>    </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><a href="../../../../cborg/html/src"><span class="hs-identifier hs-var">encodeListLen</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">3</span></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto) -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
</span><a href="#local-6989586621679474035"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto) -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
</span><a href="#local-6989586621679474034"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) EpochNo -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) EpochNo
</span><a href="#local-6989586621679474033"><span class="hs-identifier hs-var">c</span></a></span></span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span id="local-6989586621679474032"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679474027"><span id="local-6989586621679474029"><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474032"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">FromSharedCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier hs-type">PState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474032"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-400"></span><span>  </span><span class="hs-keyword">type</span><span>
</span><span id="line-401"></span><span>    </span><span id="Share"><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">Share</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier hs-type">PState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474032"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-402"></span><span>      </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Interns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">StakePool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474032"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>  </span><span id="local-6989586621679474025"><span class="annot"><span class="annottext">fromSharedPlusCBOR :: StateT (Share (PState crypto)) (Decoder s) (PState crypto)
</span><a href="#local-6989586621679474025"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromSharedPlusCBOR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; (PState crypto -&gt; Int)
-&gt; StateT
     (Interns (KeyHash 'StakePool crypto)) (Decoder s) (PState crypto)
-&gt; StateT
     (Interns (KeyHash 'StakePool crypto)) (Decoder s) (PState crypto)
forall (m :: (* -&gt; *) -&gt; * -&gt; *) s a.
(MonadTrans m, Monad (m (Decoder s))) =&gt;
Text -&gt; (a -&gt; Int) -&gt; m (Decoder s) a -&gt; m (Decoder s) a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">decodeRecordNamedT</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;PState&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; PState crypto -&gt; Int
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT
   (Interns (KeyHash 'StakePool crypto)) (Decoder s) (PState crypto)
 -&gt; StateT
      (Interns (KeyHash 'StakePool crypto)) (Decoder s) (PState crypto))
-&gt; StateT
     (Interns (KeyHash 'StakePool crypto)) (Decoder s) (PState crypto)
-&gt; StateT
     (Interns (KeyHash 'StakePool crypto)) (Decoder s) (PState crypto)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-404"></span><span>    </span><span id="local-6989586621679474024"><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
</span><a href="#local-6989586621679474024"><span class="hs-identifier hs-var">_pParams</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lens'
  (Interns (KeyHash 'StakePool crypto))
  (Share (Map (KeyHash 'StakePool crypto) (PoolParams crypto)))
-&gt; StateT
     (Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (Map (KeyHash 'StakePool crypto) (PoolParams crypto))
forall b bs s.
FromSharedCBOR b =&gt;
Lens' bs (Share b) -&gt; StateT bs (Decoder s) b
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedPlusLensCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lens'
  (Interns (KeyHash 'StakePool crypto), Interns (PoolParams crypto))
  (Interns (KeyHash 'StakePool crypto))
-&gt; Lens'
     (Interns (KeyHash 'StakePool crypto))
     (Interns (KeyHash 'StakePool crypto))
-&gt; Lens'
     (Interns (KeyHash 'StakePool crypto))
     (Interns (KeyHash 'StakePool crypto), Interns (PoolParams crypto))
forall a b c. Monoid a =&gt; Lens' a b -&gt; Lens' c b -&gt; Lens' c a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">toMemptyLens</span></a></span><span> </span><span class="annot"><span class="annottext">forall s t a b. Field1 s t a b =&gt; Lens s t a b
Lens'
  (Interns (KeyHash 'StakePool crypto), Interns (PoolParams crypto))
  (Interns (KeyHash 'StakePool crypto))
</span><a href="../../../../microlens/html/src"><span class="hs-identifier hs-var">_1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
Lens'
  (Interns (KeyHash 'StakePool crypto))
  (Interns (KeyHash 'StakePool crypto))
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>    </span><span id="local-6989586621679474023"><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
</span><a href="#local-6989586621679474023"><span class="hs-identifier hs-var">_fPParams</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lens'
  (Interns (KeyHash 'StakePool crypto))
  (Share (Map (KeyHash 'StakePool crypto) (PoolParams crypto)))
-&gt; StateT
     (Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (Map (KeyHash 'StakePool crypto) (PoolParams crypto))
forall b bs s.
FromSharedCBOR b =&gt;
Lens' bs (Share b) -&gt; StateT bs (Decoder s) b
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedPlusLensCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lens'
  (Interns (KeyHash 'StakePool crypto), Interns (PoolParams crypto))
  (Interns (KeyHash 'StakePool crypto))
-&gt; Lens'
     (Interns (KeyHash 'StakePool crypto))
     (Interns (KeyHash 'StakePool crypto))
-&gt; Lens'
     (Interns (KeyHash 'StakePool crypto))
     (Interns (KeyHash 'StakePool crypto), Interns (PoolParams crypto))
forall a b c. Monoid a =&gt; Lens' a b -&gt; Lens' c b -&gt; Lens' c a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">toMemptyLens</span></a></span><span> </span><span class="annot"><span class="annottext">forall s t a b. Field1 s t a b =&gt; Lens s t a b
Lens'
  (Interns (KeyHash 'StakePool crypto), Interns (PoolParams crypto))
  (Interns (KeyHash 'StakePool crypto))
</span><a href="../../../../microlens/html/src"><span class="hs-identifier hs-var">_1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
Lens'
  (Interns (KeyHash 'StakePool crypto))
  (Interns (KeyHash 'StakePool crypto))
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>    </span><span id="local-6989586621679474022"><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) EpochNo
</span><a href="#local-6989586621679474022"><span class="hs-identifier hs-var">_retiring</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lens'
  (Interns (KeyHash 'StakePool crypto))
  (Share (Map (KeyHash 'StakePool crypto) EpochNo))
-&gt; StateT
     (Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (Map (KeyHash 'StakePool crypto) EpochNo)
forall b bs s.
FromSharedCBOR b =&gt;
Lens' bs (Share b) -&gt; StateT bs (Decoder s) b
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedPlusLensCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lens'
  (Interns (KeyHash 'StakePool crypto), Interns EpochNo)
  (Interns (KeyHash 'StakePool crypto))
-&gt; Lens'
     (Interns (KeyHash 'StakePool crypto))
     (Interns (KeyHash 'StakePool crypto))
-&gt; Lens'
     (Interns (KeyHash 'StakePool crypto))
     (Interns (KeyHash 'StakePool crypto), Interns EpochNo)
forall a b c. Monoid a =&gt; Lens' a b -&gt; Lens' c b -&gt; Lens' c a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">toMemptyLens</span></a></span><span> </span><span class="annot"><span class="annottext">forall s t a b. Field1 s t a b =&gt; Lens s t a b
Lens'
  (Interns (KeyHash 'StakePool crypto), Interns EpochNo)
  (Interns (KeyHash 'StakePool crypto))
</span><a href="../../../../microlens/html/src"><span class="hs-identifier hs-var">_1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
Lens'
  (Interns (KeyHash 'StakePool crypto))
  (Interns (KeyHash 'StakePool crypto))
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>    </span><span class="annot"><span class="annottext">PState crypto
-&gt; StateT
     (Interns (KeyHash 'StakePool crypto)) (Decoder s) (PState crypto)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">PState :: forall crypto.
Map (KeyHash 'StakePool crypto) (PoolParams crypto)
-&gt; Map (KeyHash 'StakePool crypto) (PoolParams crypto)
-&gt; Map (KeyHash 'StakePool crypto) EpochNo
-&gt; PState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier hs-type">PState</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
_pParams :: Map (KeyHash 'StakePool crypto) (PoolParams crypto)
_pParams :: Map (KeyHash 'StakePool crypto) (PoolParams crypto)
</span><a href="#local-6989586621679474024"><span class="hs-identifier hs-var hs-var">_pParams</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
_fPParams :: Map (KeyHash 'StakePool crypto) (PoolParams crypto)
_fPParams :: Map (KeyHash 'StakePool crypto) (PoolParams crypto)
</span><a href="#local-6989586621679474023"><span class="hs-identifier hs-var hs-var">_fPParams</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) EpochNo
_retiring :: Map (KeyHash 'StakePool crypto) EpochNo
_retiring :: Map (KeyHash 'StakePool crypto) EpochNo
</span><a href="#local-6989586621679474022"><span class="hs-identifier hs-var hs-var">_retiring</span></a></span><span class="hs-special">}</span></span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span class="hs-comment">-- | The state associated with the current stake delegation.</span><span>
</span><span id="line-410"></span><span id="local-6989586621679474020"><span id="local-6989586621679474021"></span></span><span class="hs-keyword">data</span><span> </span><span id="DPState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier hs-var">DPState</span></a></span></span><span> </span><span id="local-6989586621679474919"><span class="annot"><a href="#local-6989586621679474919"><span class="hs-identifier hs-type">crypto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DPState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier hs-var">DPState</span></a></span></span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="dpsDState"><span class="annot"><span class="annottext">DPState crypto -&gt; DState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#dpsDState"><span class="hs-identifier hs-var hs-var">dpsDState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474919"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-412"></span><span>    </span><span id="dpsPState"><span class="annot"><span class="annottext">DPState crypto -&gt; PState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#dpsPState"><span class="hs-identifier hs-var hs-var">dpsPState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier hs-type">PState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474919"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-414"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679474011"><span id="local-6989586621679474013"><span id="local-6989586621679474015"><span class="annot"><span class="annottext">Int -&gt; DPState crypto -&gt; ShowS
[DPState crypto] -&gt; ShowS
DPState crypto -&gt; String
(Int -&gt; DPState crypto -&gt; ShowS)
-&gt; (DPState crypto -&gt; String)
-&gt; ([DPState crypto] -&gt; ShowS)
-&gt; Show (DPState crypto)
forall crypto. Int -&gt; DPState crypto -&gt; ShowS
forall crypto. [DPState crypto] -&gt; ShowS
forall crypto. DPState crypto -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [DPState crypto] -&gt; ShowS
$cshowList :: forall crypto. [DPState crypto] -&gt; ShowS
show :: DPState crypto -&gt; String
$cshow :: forall crypto. DPState crypto -&gt; String
showsPrec :: Int -&gt; DPState crypto -&gt; ShowS
$cshowsPrec :: forall crypto. Int -&gt; DPState crypto -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679474007"><span id="local-6989586621679474009"><span class="annot"><span class="annottext">DPState crypto -&gt; DPState crypto -&gt; Bool
(DPState crypto -&gt; DPState crypto -&gt; Bool)
-&gt; (DPState crypto -&gt; DPState crypto -&gt; Bool)
-&gt; Eq (DPState crypto)
forall crypto. DPState crypto -&gt; DPState crypto -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: DPState crypto -&gt; DPState crypto -&gt; Bool
$c/= :: forall crypto. DPState crypto -&gt; DPState crypto -&gt; Bool
== :: DPState crypto -&gt; DPState crypto -&gt; Bool
$c== :: forall crypto. DPState crypto -&gt; DPState crypto -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. DPState crypto -&gt; Rep (DPState crypto) x)
-&gt; (forall x. Rep (DPState crypto) x -&gt; DPState crypto)
-&gt; Generic (DPState crypto)
forall x. Rep (DPState crypto) x -&gt; DPState crypto
forall x. DPState crypto -&gt; Rep (DPState crypto) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall crypto x. Rep (DPState crypto) x -&gt; DPState crypto
forall crypto x. DPState crypto -&gt; Rep (DPState crypto) x
$cto :: forall crypto x. Rep (DPState crypto) x -&gt; DPState crypto
$cfrom :: forall crypto x. DPState crypto -&gt; Rep (DPState crypto) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span id="local-6989586621679474004"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473998"><span id="local-6989586621679474000"><span id="local-6989586621679474002"><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier hs-type">DPState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474004"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-417"></span><span>
</span><span id="line-418"></span><span id="local-6989586621679473997"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473995"><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier hs-type">DPState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473997"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span id="local-6989586621679473994"><span class="hs-keyword">instance</span><span>
</span><span id="line-421"></span><span>  </span><span id="local-6989586621679473988"><span id="local-6989586621679473990"><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473994"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-422"></span><span>  </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier hs-type">DPState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473994"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-424"></span><span>  </span><span id="local-6989586621679473987"><span class="annot"><span class="annottext">toCBOR :: DPState crypto -&gt; Encoding
</span><a href="#local-6989586621679473987"><span class="hs-identifier hs-var hs-var hs-var hs-var">toCBOR</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier hs-type">DPState</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679473986"><span class="annot"><span class="annottext">PState crypto
dpsPState :: PState crypto
dpsPState :: forall crypto. DPState crypto -&gt; PState crypto
</span><a href="#local-6989586621679473986"><span class="hs-identifier hs-var hs-var">dpsPState</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473985"><span class="annot"><span class="annottext">DState crypto
dpsDState :: DState crypto
dpsDState :: forall crypto. DPState crypto -&gt; DState crypto
</span><a href="#local-6989586621679473985"><span class="hs-identifier hs-var hs-var">dpsDState</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-425"></span><span>    </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><a href="../../../../cborg/html/src"><span class="hs-identifier hs-var">encodeListLen</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span>
</span><span id="line-426"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PState crypto -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">PState crypto
</span><a href="#local-6989586621679473986"><span class="hs-identifier hs-var">dpsPState</span></a></span><span> </span><span class="hs-comment">-- We get better sharing when encoding pstate before dstate</span><span>
</span><span id="line-427"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">DState crypto -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">DState crypto
</span><a href="#local-6989586621679473985"><span class="hs-identifier hs-var">dpsDState</span></a></span></span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span id="local-6989586621679473984"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473979"><span id="local-6989586621679473981"><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473984"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">FromSharedCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier hs-type">DPState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473984"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-430"></span><span>  </span><span class="hs-keyword">type</span><span>
</span><span id="line-431"></span><span>    </span><span id="Share"><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">Share</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier hs-type">DPState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473984"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-432"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Interns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473984"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-433"></span><span>        </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Interns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">StakePool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473984"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>  </span><span id="local-6989586621679473977"><span class="annot"><span class="annottext">fromSharedPlusCBOR :: StateT (Share (DPState crypto)) (Decoder s) (DPState crypto)
</span><a href="#local-6989586621679473977"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromSharedPlusCBOR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; (DPState crypto -&gt; Int)
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (DPState crypto)
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (DPState crypto)
forall (m :: (* -&gt; *) -&gt; * -&gt; *) s a.
(MonadTrans m, Monad (m (Decoder s))) =&gt;
Text -&gt; (a -&gt; Int) -&gt; m (Decoder s) a -&gt; m (Decoder s) a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">decodeRecordNamedT</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;DPState&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; DPState crypto -&gt; Int
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT
   (Interns (Credential 'Staking crypto),
    Interns (KeyHash 'StakePool crypto))
   (Decoder s)
   (DPState crypto)
 -&gt; StateT
      (Interns (Credential 'Staking crypto),
       Interns (KeyHash 'StakePool crypto))
      (Decoder s)
      (DPState crypto))
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (DPState crypto)
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (DPState crypto)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-436"></span><span>    </span><span id="local-6989586621679473976"><span class="annot"><span class="annottext">PState crypto
</span><a href="#local-6989586621679473976"><span class="hs-identifier hs-var">dpsPState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lens'
  (Interns (Credential 'Staking crypto),
   Interns (KeyHash 'StakePool crypto))
  (Share (PState crypto))
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (PState crypto)
forall b bs s.
FromSharedCBOR b =&gt;
Lens' bs (Share b) -&gt; StateT bs (Decoder s) b
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedPlusLensCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">forall s t a b. Field2 s t a b =&gt; Lens s t a b
Lens'
  (Interns (Credential 'Staking crypto),
   Interns (KeyHash 'StakePool crypto))
  (Share (PState crypto))
</span><a href="../../../../microlens/html/src"><span class="hs-identifier hs-var">_2</span></a></span><span>
</span><span id="line-437"></span><span>    </span><span id="local-6989586621679473975"><span class="annot"><span class="annottext">DState crypto
</span><a href="#local-6989586621679473975"><span class="hs-identifier hs-var">dpsDState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  (Interns (Credential 'Staking crypto),
   Interns (KeyHash 'StakePool crypto))
  (Decoder s)
  (DState crypto)
forall a s. FromSharedCBOR a =&gt; StateT (Share a) (Decoder s) a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedPlusCBOR</span></a></span><span>
</span><span id="line-438"></span><span>    </span><span class="annot"><span class="annottext">DPState crypto
-&gt; StateT
     (Interns (Credential 'Staking crypto),
      Interns (KeyHash 'StakePool crypto))
     (Decoder s)
     (DPState crypto)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">DPState :: forall crypto. DState crypto -&gt; PState crypto -&gt; DPState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier hs-type">DPState</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">PState crypto
dpsPState :: PState crypto
dpsPState :: PState crypto
</span><a href="#local-6989586621679473976"><span class="hs-identifier hs-var hs-var">dpsPState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DState crypto
dpsDState :: DState crypto
dpsDState :: DState crypto
</span><a href="#local-6989586621679473975"><span class="hs-identifier hs-var hs-var">dpsDState</span></a></span><span class="hs-special">}</span></span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span id="local-6989586621679473973"><span id="local-6989586621679473974"></span></span><span class="hs-keyword">data</span><span> </span><span id="AccountState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#AccountState"><span class="hs-identifier hs-var">AccountState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AccountState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#AccountState"><span class="hs-identifier hs-var">AccountState</span></a></span></span><span>
</span><span id="line-441"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_treasury"><span class="annot"><span class="annottext">AccountState -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_treasury"><span class="hs-identifier hs-var hs-var">_treasury</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-442"></span><span>    </span><span id="_reserves"><span class="annot"><span class="annottext">AccountState -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_reserves"><span class="hs-identifier hs-var hs-var">_reserves</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span>
</span><span id="line-443"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-444"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679473966"><span id="local-6989586621679473968"><span id="local-6989586621679473970"><span class="annot"><span class="annottext">Int -&gt; AccountState -&gt; ShowS
[AccountState] -&gt; ShowS
AccountState -&gt; String
(Int -&gt; AccountState -&gt; ShowS)
-&gt; (AccountState -&gt; String)
-&gt; ([AccountState] -&gt; ShowS)
-&gt; Show AccountState
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [AccountState] -&gt; ShowS
$cshowList :: [AccountState] -&gt; ShowS
show :: AccountState -&gt; String
$cshow :: AccountState -&gt; String
showsPrec :: Int -&gt; AccountState -&gt; ShowS
$cshowsPrec :: Int -&gt; AccountState -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473962"><span id="local-6989586621679473964"><span class="annot"><span class="annottext">AccountState -&gt; AccountState -&gt; Bool
(AccountState -&gt; AccountState -&gt; Bool)
-&gt; (AccountState -&gt; AccountState -&gt; Bool) -&gt; Eq AccountState
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: AccountState -&gt; AccountState -&gt; Bool
$c/= :: AccountState -&gt; AccountState -&gt; Bool
== :: AccountState -&gt; AccountState -&gt; Bool
$c== :: AccountState -&gt; AccountState -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. AccountState -&gt; Rep AccountState x)
-&gt; (forall x. Rep AccountState x -&gt; AccountState)
-&gt; Generic AccountState
forall x. Rep AccountState x -&gt; AccountState
forall x. AccountState -&gt; Rep AccountState x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep AccountState x -&gt; AccountState
$cfrom :: forall x. AccountState -&gt; Rep AccountState x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473954"><span id="local-6989586621679473956"><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#AccountState"><span class="hs-identifier hs-type">AccountState</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-447"></span><span>  </span><span id="local-6989586621679473953"><span class="annot"><span class="annottext">toCBOR :: AccountState -&gt; Encoding
</span><a href="#local-6989586621679473953"><span class="hs-identifier hs-var hs-var hs-var hs-var">toCBOR</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#AccountState"><span class="hs-identifier hs-type">AccountState</span></a></span><span> </span><span id="local-6989586621679473952"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473952"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679473951"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473951"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-448"></span><span>    </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><a href="../../../../cborg/html/src"><span class="hs-identifier hs-var">encodeListLen</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473952"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473951"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473947"><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#AccountState"><span class="hs-identifier hs-type">AccountState</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-451"></span><span>  </span><span id="local-6989586621679473946"><span class="annot"><span class="annottext">fromCBOR :: Decoder s AccountState
</span><a href="#local-6989586621679473946"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromCBOR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-452"></span><span>    </span><span class="annot"><span class="annottext">Text
-&gt; (AccountState -&gt; Int)
-&gt; Decoder s AccountState
-&gt; Decoder s AccountState
forall a s. Text -&gt; (a -&gt; Int) -&gt; Decoder s a -&gt; Decoder s a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">decodeRecordNamed</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;AccountState&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; AccountState -&gt; Int
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Decoder s AccountState -&gt; Decoder s AccountState)
-&gt; Decoder s AccountState -&gt; Decoder s AccountState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; AccountState
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#AccountState"><span class="hs-identifier hs-var">AccountState</span></a></span><span> </span><span class="annot"><span class="annottext">(Coin -&gt; Coin -&gt; AccountState)
-&gt; Decoder s Coin -&gt; Decoder s (Coin -&gt; AccountState)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s Coin
forall a s. FromCBOR a =&gt; Decoder s a
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">fromCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s (Coin -&gt; AccountState)
-&gt; Decoder s Coin -&gt; Decoder s AccountState
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s Coin
forall a s. FromCBOR a =&gt; Decoder s a
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">fromCBOR</span></a></span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473940"><span id="local-6989586621679473942"><span id="local-6989586621679473944"><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#AccountState"><span class="hs-identifier hs-type">AccountState</span></a></span></span></span></span><span>
</span><span id="line-455"></span><span>
</span><span id="line-456"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473938"><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#AccountState"><span class="hs-identifier hs-type">AccountState</span></a></span></span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span id="local-6989586621679473936"><span id="local-6989586621679473937"></span></span><span class="hs-keyword">data</span><span> </span><span id="EpochState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-var">EpochState</span></a></span></span><span> </span><span id="local-6989586621679474881"><span class="annot"><a href="#local-6989586621679474881"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EpochState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-var">EpochState</span></a></span></span><span>
</span><span id="line-459"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="esAccountState"><span class="annot"><span class="annottext">EpochState era -&gt; AccountState
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#esAccountState"><span class="hs-identifier hs-var hs-var">esAccountState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#AccountState"><span class="hs-identifier hs-type">AccountState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-460"></span><span>    </span><span id="esSnapshots"><span class="annot"><span class="annottext">EpochState era -&gt; SnapShots (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#esSnapshots"><span class="hs-identifier hs-var hs-var">esSnapshots</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.EpochBoundary.html#SnapShots"><span class="hs-identifier hs-type">SnapShots</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474881"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-461"></span><span>    </span><span id="esLState"><span class="annot"><span class="annottext">EpochState era -&gt; LedgerState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#esLState"><span class="hs-identifier hs-var hs-var">esLState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474881"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-462"></span><span>    </span><span id="esPrevPp"><span class="annot"><span class="annottext">EpochState era -&gt; PParams era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#esPrevPp"><span class="hs-identifier hs-var hs-var">esPrevPp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474881"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-463"></span><span>    </span><span id="esPp"><span class="annot"><span class="annottext">EpochState era -&gt; PParams era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#esPp"><span class="hs-identifier hs-var hs-var">esPp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474881"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-comment">-- | This field, esNonMyopic, does not appear in the formal spec</span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-comment">-- and is not a part of the protocol. It is only used for providing</span><span>
</span><span id="line-466"></span><span>    </span><span class="hs-comment">-- data to the stake pool ranking calculation @getNonMyopicMemberRewards@.</span><span>
</span><span id="line-467"></span><span>    </span><span class="hs-comment">-- See https://hydra.iohk.io/job/Cardano/cardano-ledger/specs.pool-ranking/latest/download-by-type/doc-pdf/pool-ranking</span><span>
</span><span id="line-468"></span><span>    </span><span id="esNonMyopic"><span class="annot"><span class="annottext">EpochState era -&gt; NonMyopic (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#esNonMyopic"><span class="hs-identifier hs-var hs-var">esNonMyopic</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.PoolRank.html#NonMyopic"><span class="hs-identifier hs-type">NonMyopic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474881"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-470"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. EpochState era -&gt; Rep (EpochState era) x)
-&gt; (forall x. Rep (EpochState era) x -&gt; EpochState era)
-&gt; Generic (EpochState era)
forall x. Rep (EpochState era) x -&gt; EpochState era
forall x. EpochState era -&gt; Rep (EpochState era) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall era x. Rep (EpochState era) x -&gt; EpochState era
forall era x. EpochState era -&gt; Rep (EpochState era) x
$cto :: forall era x. Rep (EpochState era) x -&gt; EpochState era
$cfrom :: forall era x. EpochState era -&gt; Rep (EpochState era) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-471"></span><span>
</span><span id="line-472"></span><span id="local-6989586621679473921"><span id="local-6989586621679473923"><span id="local-6989586621679473925"><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679473920"><span class="annot"><a href="#local-6989586621679473920"><span class="hs-keyword hs-type">stock</span></a></span></span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-473"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473920"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-474"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473920"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-475"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473920"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-476"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473920"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-477"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-478"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473920"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span id="local-6989586621679473916"><span id="local-6989586621679473918"><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679473915"><span class="annot"><a href="#local-6989586621679473915"><span class="hs-keyword hs-type">stock</span></a></span></span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-481"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473915"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-482"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473915"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-483"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473915"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-484"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473915"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-485"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-486"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473915"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span id="local-6989586621679473914"><span class="hs-keyword">instance</span><span>
</span><span id="line-489"></span><span>  </span><span id="local-6989586621679473908"><span id="local-6989586621679473910"><span id="local-6989586621679473912"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473914"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-490"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473914"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-491"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473914"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-492"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.Value</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473914"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-493"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473914"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-494"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473914"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-495"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473914"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-496"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.Value</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473914"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-498"></span><span>  </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473914"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span id="local-6989586621679473907"><span class="hs-keyword">instance</span><span>
</span><span id="line-501"></span><span>  </span><span id="local-6989586621679473905"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473907"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-502"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473907"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-503"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473907"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-504"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473907"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-506"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473907"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span id="local-6989586621679473904"><span class="hs-keyword">instance</span><span>
</span><span id="line-509"></span><span>  </span><span id="local-6989586621679473898"><span id="local-6989586621679473900"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473904"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-510"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473904"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-511"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473904"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-512"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473904"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-514"></span><span>  </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473904"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-515"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-516"></span><span>  </span><span id="local-6989586621679473897"><span class="annot"><span class="annottext">toCBOR :: EpochState era -&gt; Encoding
</span><a href="#local-6989586621679473897"><span class="hs-identifier hs-var hs-var hs-var hs-var">toCBOR</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679473896"><span class="annot"><span class="annottext">AccountState
esAccountState :: AccountState
esAccountState :: forall era. EpochState era -&gt; AccountState
</span><a href="#local-6989586621679473896"><span class="hs-identifier hs-var hs-var">esAccountState</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473895"><span class="annot"><span class="annottext">LedgerState era
esLState :: LedgerState era
esLState :: forall era. EpochState era -&gt; LedgerState era
</span><a href="#local-6989586621679473895"><span class="hs-identifier hs-var hs-var">esLState</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473894"><span class="annot"><span class="annottext">SnapShots (Crypto era)
esSnapshots :: SnapShots (Crypto era)
esSnapshots :: forall era. EpochState era -&gt; SnapShots (Crypto era)
</span><a href="#local-6989586621679473894"><span class="hs-identifier hs-var hs-var">esSnapshots</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473893"><span class="annot"><span class="annottext">PParams era
esPrevPp :: PParams era
esPrevPp :: forall era. EpochState era -&gt; PParams era
</span><a href="#local-6989586621679473893"><span class="hs-identifier hs-var hs-var">esPrevPp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473892"><span class="annot"><span class="annottext">PParams era
esPp :: PParams era
esPp :: forall era. EpochState era -&gt; PParams era
</span><a href="#local-6989586621679473892"><span class="hs-identifier hs-var hs-var">esPp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473891"><span class="annot"><span class="annottext">NonMyopic (Crypto era)
esNonMyopic :: NonMyopic (Crypto era)
esNonMyopic :: forall era. EpochState era -&gt; NonMyopic (Crypto era)
</span><a href="#local-6989586621679473891"><span class="hs-identifier hs-var hs-var">esNonMyopic</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-517"></span><span>    </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><a href="../../../../cborg/html/src"><span class="hs-identifier hs-var">encodeListLen</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">6</span></span><span>
</span><span id="line-518"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473896"><span class="hs-identifier hs-var">esAccountState</span></a></span><span>
</span><span id="line-519"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473895"><span class="hs-identifier hs-var">esLState</span></a></span><span> </span><span class="hs-comment">-- We get better sharing when encoding ledger state before snaphots</span><span>
</span><span id="line-520"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SnapShots (Crypto era) -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">SnapShots (Crypto era)
</span><a href="#local-6989586621679473894"><span class="hs-identifier hs-var">esSnapshots</span></a></span><span>
</span><span id="line-521"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473893"><span class="hs-identifier hs-var">esPrevPp</span></a></span><span>
</span><span id="line-522"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473892"><span class="hs-identifier hs-var">esPp</span></a></span><span>
</span><span id="line-523"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">NonMyopic (Crypto era) -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">NonMyopic (Crypto era)
</span><a href="#local-6989586621679473891"><span class="hs-identifier hs-var">esNonMyopic</span></a></span></span><span>
</span><span id="line-524"></span><span>
</span><span id="line-525"></span><span id="local-6989586621679473890"><span class="hs-keyword">instance</span><span>
</span><span id="line-526"></span><span>  </span><span id="local-6989586621679473886"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473890"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-527"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.Constraints.html#TransValue"><span class="hs-identifier hs-type">TransValue</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473890"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-528"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">HashAnnotated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473890"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">EraIndependentTxBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473890"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-529"></span><span>    </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">FromSharedCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473890"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-530"></span><span>    </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Share</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473890"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Interns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473890"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-531"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473890"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-532"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473890"><span class="hs-identifier hs-type">era</span></a></span><span>
</span><span id="line-533"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-534"></span><span>  </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473890"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-535"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-536"></span><span>  </span><span id="local-6989586621679473885"><span class="annot"><span class="annottext">fromCBOR :: Decoder s (EpochState era)
</span><a href="#local-6989586621679473885"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromCBOR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-537"></span><span>    </span><span class="annot"><span class="annottext">Text
-&gt; (EpochState era -&gt; Int)
-&gt; Decoder s (EpochState era)
-&gt; Decoder s (EpochState era)
forall a s. Text -&gt; (a -&gt; Int) -&gt; Decoder s a -&gt; Decoder s a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">decodeRecordNamed</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;EpochState&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; EpochState era -&gt; Int
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">6</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Decoder s (EpochState era) -&gt; Decoder s (EpochState era))
-&gt; Decoder s (EpochState era) -&gt; Decoder s (EpochState era)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-538"></span><span>      </span><span class="annot"><span class="annottext">(StateT
   (Interns (Credential 'Staking (Crypto era)),
    Interns (KeyHash 'StakePool (Crypto era)))
   (Decoder s)
   (EpochState era)
 -&gt; (Interns (Credential 'Staking (Crypto era)),
     Interns (KeyHash 'StakePool (Crypto era)))
 -&gt; Decoder s (EpochState era))
-&gt; (Interns (Credential 'Staking (Crypto era)),
    Interns (KeyHash 'StakePool (Crypto era)))
-&gt; StateT
     (Interns (Credential 'Staking (Crypto era)),
      Interns (KeyHash 'StakePool (Crypto era)))
     (Decoder s)
     (EpochState era)
-&gt; Decoder s (EpochState era)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">StateT
  (Interns (Credential 'Staking (Crypto era)),
   Interns (KeyHash 'StakePool (Crypto era)))
  (Decoder s)
  (EpochState era)
-&gt; (Interns (Credential 'Staking (Crypto era)),
    Interns (KeyHash 'StakePool (Crypto era)))
-&gt; Decoder s (EpochState era)
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">evalStateT</span></a></span><span> </span><span class="annot"><span class="annottext">(Interns (Credential 'Staking (Crypto era)),
 Interns (KeyHash 'StakePool (Crypto era)))
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT
   (Interns (Credential 'Staking (Crypto era)),
    Interns (KeyHash 'StakePool (Crypto era)))
   (Decoder s)
   (EpochState era)
 -&gt; Decoder s (EpochState era))
-&gt; StateT
     (Interns (Credential 'Staking (Crypto era)),
      Interns (KeyHash 'StakePool (Crypto era)))
     (Decoder s)
     (EpochState era)
-&gt; Decoder s (EpochState era)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-539"></span><span>        </span><span id="local-6989586621679473883"><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473883"><span class="hs-identifier hs-var">esAccountState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s AccountState
-&gt; StateT
     (Interns (Credential 'Staking (Crypto era)),
      Interns (KeyHash 'StakePool (Crypto era)))
     (Decoder s)
     AccountState
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s AccountState
forall a s. FromCBOR a =&gt; Decoder s a
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">fromCBOR</span></a></span><span>
</span><span id="line-540"></span><span>        </span><span id="local-6989586621679473882"><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473882"><span class="hs-identifier hs-var">esLState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  (Interns (Credential 'Staking (Crypto era)),
   Interns (KeyHash 'StakePool (Crypto era)))
  (Decoder s)
  (LedgerState era)
forall a s. FromSharedCBOR a =&gt; StateT (Share a) (Decoder s) a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedPlusCBOR</span></a></span><span>
</span><span id="line-541"></span><span>        </span><span id="local-6989586621679473881"><span class="annot"><span class="annottext">SnapShots (Crypto era)
</span><a href="#local-6989586621679473881"><span class="hs-identifier hs-var">esSnapshots</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  (Interns (Credential 'Staking (Crypto era)),
   Interns (KeyHash 'StakePool (Crypto era)))
  (Decoder s)
  (SnapShots (Crypto era))
forall a s. FromSharedCBOR a =&gt; StateT (Share a) (Decoder s) a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedPlusCBOR</span></a></span><span>
</span><span id="line-542"></span><span>        </span><span id="local-6989586621679473880"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473880"><span class="hs-identifier hs-var">esPrevPp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s (PParams era)
-&gt; StateT
     (Interns (Credential 'Staking (Crypto era)),
      Interns (KeyHash 'StakePool (Crypto era)))
     (Decoder s)
     (PParams era)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s (PParams era)
forall a s. FromCBOR a =&gt; Decoder s a
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">fromCBOR</span></a></span><span>
</span><span id="line-543"></span><span>        </span><span id="local-6989586621679473879"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473879"><span class="hs-identifier hs-var">esPp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s (PParams era)
-&gt; StateT
     (Interns (Credential 'Staking (Crypto era)),
      Interns (KeyHash 'StakePool (Crypto era)))
     (Decoder s)
     (PParams era)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s (PParams era)
forall a s. FromCBOR a =&gt; Decoder s a
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">fromCBOR</span></a></span><span>
</span><span id="line-544"></span><span>        </span><span id="local-6989586621679473878"><span class="annot"><span class="annottext">NonMyopic (Crypto era)
</span><a href="#local-6989586621679473878"><span class="hs-identifier hs-var">esNonMyopic</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleGetter
  (Interns (Credential 'Staking (Crypto era)),
   Interns (KeyHash 'StakePool (Crypto era)))
  (Share (NonMyopic (Crypto era)))
-&gt; StateT
     (Interns (Credential 'Staking (Crypto era)),
      Interns (KeyHash 'StakePool (Crypto era)))
     (Decoder s)
     (NonMyopic (Crypto era))
forall b bs s.
FromSharedCBOR b =&gt;
SimpleGetter bs (Share b) -&gt; StateT bs (Decoder s) b
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedLensCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleGetter
  (Interns (Credential 'Staking (Crypto era)),
   Interns (KeyHash 'StakePool (Crypto era)))
  (Share (NonMyopic (Crypto era)))
forall s t a b. Field2 s t a b =&gt; Lens s t a b
</span><a href="../../../../microlens/html/src"><span class="hs-identifier hs-var">_2</span></a></span><span>
</span><span id="line-545"></span><span>        </span><span class="annot"><span class="annottext">EpochState era
-&gt; StateT
     (Interns (Credential 'Staking (Crypto era)),
      Interns (KeyHash 'StakePool (Crypto era)))
     (Decoder s)
     (EpochState era)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState :: forall era.
AccountState
-&gt; SnapShots (Crypto era)
-&gt; LedgerState era
-&gt; PParams era
-&gt; PParams era
-&gt; NonMyopic (Crypto era)
-&gt; EpochState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">AccountState
esAccountState :: AccountState
esAccountState :: AccountState
</span><a href="#local-6989586621679473883"><span class="hs-identifier hs-var hs-var">esAccountState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SnapShots (Crypto era)
esSnapshots :: SnapShots (Crypto era)
esSnapshots :: SnapShots (Crypto era)
</span><a href="#local-6989586621679473881"><span class="hs-identifier hs-var hs-var">esSnapshots</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LedgerState era
esLState :: LedgerState era
esLState :: LedgerState era
</span><a href="#local-6989586621679473882"><span class="hs-identifier hs-var hs-var">esLState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PParams era
esPrevPp :: PParams era
esPrevPp :: PParams era
</span><a href="#local-6989586621679473880"><span class="hs-identifier hs-var hs-var">esPrevPp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PParams era
esPp :: PParams era
esPp :: PParams era
</span><a href="#local-6989586621679473879"><span class="hs-identifier hs-var hs-var">esPp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">NonMyopic (Crypto era)
esNonMyopic :: NonMyopic (Crypto era)
esNonMyopic :: NonMyopic (Crypto era)
</span><a href="#local-6989586621679473878"><span class="hs-identifier hs-var hs-var">esNonMyopic</span></a></span><span class="hs-special">}</span></span><span>
</span><span id="line-546"></span><span>
</span><span id="line-547"></span><span class="hs-keyword">data</span><span> </span><span id="UpecState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UpecState"><span class="hs-identifier hs-var">UpecState</span></a></span></span><span> </span><span id="local-6989586621679473876"><span class="annot"><a href="#local-6989586621679473876"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="UpecState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UpecState"><span class="hs-identifier hs-var">UpecState</span></a></span></span><span>
</span><span id="line-548"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | Current protocol parameters.</span><span>
</span><span id="line-549"></span><span>    </span><span id="currentPp"><span class="annot"><span class="annottext">UpecState era -&gt; PParams era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#currentPp"><span class="hs-identifier hs-var hs-var">currentPp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473876"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-550"></span><span>    </span><span class="hs-comment">-- | State of the protocol update transition system.</span><span>
</span><span id="line-551"></span><span>    </span><span id="ppupState"><span class="annot"><span class="annottext">UpecState era -&gt; State (EraRule &quot;PPUP&quot; era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#ppupState"><span class="hs-identifier hs-var hs-var">ppupState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473876"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-552"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-553"></span><span>
</span><span id="line-554"></span><span id="local-6989586621679473867"><span id="local-6989586621679473869"><span id="local-6989586621679473871"><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679473866"><span class="annot"><a href="#local-6989586621679473866"><span class="hs-keyword hs-type">stock</span></a></span></span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-555"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473866"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-556"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473866"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-558"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UpecState"><span class="hs-identifier hs-type">UpecState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473866"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-559"></span><span>
</span><span id="line-560"></span><span id="local-6989586621679473864"><span id="local-6989586621679473865"></span></span><span class="hs-keyword">data</span><span> </span><span id="PPUPState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PPUPState"><span class="hs-identifier hs-var">PPUPState</span></a></span></span><span> </span><span id="local-6989586621679474837"><span class="annot"><a href="#local-6989586621679474837"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PPUPState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PPUPState"><span class="hs-identifier hs-var">PPUPState</span></a></span></span><span>
</span><span id="line-561"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="proposals"><span class="annot"><span class="annottext">PPUPState era -&gt; ProposedPPUpdates era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#proposals"><span class="hs-identifier hs-var hs-var">proposals</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.PParams.html#ProposedPPUpdates"><span class="hs-identifier hs-type">ProposedPPUpdates</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474837"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-562"></span><span>    </span><span id="futureProposals"><span class="annot"><span class="annottext">PPUPState era -&gt; ProposedPPUpdates era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#futureProposals"><span class="hs-identifier hs-var hs-var">futureProposals</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.PParams.html#ProposedPPUpdates"><span class="hs-identifier hs-type">ProposedPPUpdates</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474837"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-563"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-564"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. PPUPState era -&gt; Rep (PPUPState era) x)
-&gt; (forall x. Rep (PPUPState era) x -&gt; PPUPState era)
-&gt; Generic (PPUPState era)
forall x. Rep (PPUPState era) x -&gt; PPUPState era
forall x. PPUPState era -&gt; Rep (PPUPState era) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall era x. Rep (PPUPState era) x -&gt; PPUPState era
forall era x. PPUPState era -&gt; Rep (PPUPState era) x
$cto :: forall era x. Rep (PPUPState era) x -&gt; PPUPState era
$cfrom :: forall era x. PPUPState era -&gt; Rep (PPUPState era) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-565"></span><span>
</span><span id="line-566"></span><span id="local-6989586621679473852"><span id="local-6989586621679473854"><span id="local-6989586621679473856"><span id="local-6989586621679473858"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">PParamsDelta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473858"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PPUPState"><span class="hs-identifier hs-type">PPUPState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473858"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-567"></span><span>
</span><span id="line-568"></span><span id="local-6989586621679473847"><span id="local-6989586621679473849"><span id="local-6989586621679473851"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">PParamsDelta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473851"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PPUPState"><span class="hs-identifier hs-type">PPUPState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473851"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-569"></span><span>
</span><span id="line-570"></span><span id="local-6989586621679473844"><span id="local-6989586621679473846"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">PParamsDelta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473846"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PPUPState"><span class="hs-identifier hs-type">PPUPState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473846"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-571"></span><span>
</span><span id="line-572"></span><span id="local-6989586621679473843"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473837"><span id="local-6989586621679473839"><span id="local-6989586621679473841"><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">PParamsDelta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473843"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PPUPState"><span class="hs-identifier hs-type">PPUPState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473843"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span id="local-6989586621679473836"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473830"><span id="local-6989586621679473832"><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473836"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">PParamsDelta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473836"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PPUPState"><span class="hs-identifier hs-type">PPUPState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473836"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-575"></span><span>  </span><span id="local-6989586621679473829"><span class="annot"><span class="annottext">toCBOR :: PPUPState era -&gt; Encoding
</span><a href="#local-6989586621679473829"><span class="hs-identifier hs-var hs-var hs-var hs-var">toCBOR</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PPUPState"><span class="hs-identifier hs-type">PPUPState</span></a></span><span> </span><span id="local-6989586621679473828"><span class="annot"><span class="annottext">ProposedPPUpdates era
</span><a href="#local-6989586621679473828"><span class="hs-identifier hs-var">ppup</span></a></span></span><span> </span><span id="local-6989586621679473827"><span class="annot"><span class="annottext">ProposedPPUpdates era
</span><a href="#local-6989586621679473827"><span class="hs-identifier hs-var">fppup</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-576"></span><span>    </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><a href="../../../../cborg/html/src"><span class="hs-identifier hs-var">encodeListLen</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ProposedPPUpdates era -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">ProposedPPUpdates era
</span><a href="#local-6989586621679473828"><span class="hs-identifier hs-var">ppup</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ProposedPPUpdates era -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">ProposedPPUpdates era
</span><a href="#local-6989586621679473827"><span class="hs-identifier hs-var">fppup</span></a></span></span><span>
</span><span id="line-577"></span><span>
</span><span id="line-578"></span><span id="local-6989586621679473826"><span class="hs-keyword">instance</span><span>
</span><span id="line-579"></span><span>  </span><span id="local-6989586621679473822"><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473826"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">PParamsDelta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473826"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-580"></span><span>  </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PPUPState"><span class="hs-identifier hs-type">PPUPState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473826"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-581"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-582"></span><span>  </span><span id="local-6989586621679473821"><span class="annot"><span class="annottext">fromCBOR :: Decoder s (PPUPState era)
</span><a href="#local-6989586621679473821"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromCBOR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-583"></span><span>    </span><span class="annot"><span class="annottext">Decode ('Closed 'Dense) (PPUPState era)
-&gt; Decoder s (PPUPState era)
forall (w :: Wrapped) t s. Decode w t -&gt; Decoder s t
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">decode</span></a></span><span> </span><span class="annot"><span class="annottext">(Decode ('Closed 'Dense) (PPUPState era)
 -&gt; Decoder s (PPUPState era))
-&gt; Decode ('Closed 'Dense) (PPUPState era)
-&gt; Decoder s (PPUPState era)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-584"></span><span>      </span><span class="annot"><span class="annottext">(ProposedPPUpdates era -&gt; ProposedPPUpdates era -&gt; PPUPState era)
-&gt; Decode
     ('Closed 'Dense)
     (ProposedPPUpdates era -&gt; ProposedPPUpdates era -&gt; PPUPState era)
forall t. t -&gt; Decode ('Closed 'Dense) t
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">RecD</span></a></span><span> </span><span class="annot"><span class="annottext">ProposedPPUpdates era -&gt; ProposedPPUpdates era -&gt; PPUPState era
forall era.
ProposedPPUpdates era -&gt; ProposedPPUpdates era -&gt; PPUPState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#PPUPState"><span class="hs-identifier hs-var">PPUPState</span></a></span><span>
</span><span id="line-585"></span><span>        </span><span class="annot"><span class="annottext">Decode
  ('Closed 'Dense)
  (ProposedPPUpdates era -&gt; ProposedPPUpdates era -&gt; PPUPState era)
-&gt; Decode ('Closed Any) (ProposedPPUpdates era)
-&gt; Decode ('Closed 'Dense) (ProposedPPUpdates era -&gt; PPUPState era)
forall (w1 :: Wrapped) a t (w :: Density).
Decode w1 (a -&gt; t) -&gt; Decode ('Closed w) a -&gt; Decode w1 t
</span><a href="../../../../cardano-data/html/src"><span class="hs-operator hs-var">&lt;!</span></a></span><span> </span><span class="annot"><span class="annottext">Decode ('Closed Any) (ProposedPPUpdates era)
forall t (w :: Wrapped). FromCBOR t =&gt; Decode w t
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">From</span></a></span><span>
</span><span id="line-586"></span><span>        </span><span class="annot"><span class="annottext">Decode ('Closed 'Dense) (ProposedPPUpdates era -&gt; PPUPState era)
-&gt; Decode ('Closed Any) (ProposedPPUpdates era)
-&gt; Decode ('Closed 'Dense) (PPUPState era)
forall (w1 :: Wrapped) a t (w :: Density).
Decode w1 (a -&gt; t) -&gt; Decode ('Closed w) a -&gt; Decode w1 t
</span><a href="../../../../cardano-data/html/src"><span class="hs-operator hs-var">&lt;!</span></a></span><span> </span><span class="annot"><span class="annottext">Decode ('Closed Any) (ProposedPPUpdates era)
forall t (w :: Wrapped). FromCBOR t =&gt; Decode w t
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">From</span></a></span></span><span>
</span><span id="line-587"></span><span>
</span><span id="line-588"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#pvCanFollow"><span class="hs-identifier hs-type">pvCanFollow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ProtVer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../strict-containers/html/src"><span class="hs-identifier hs-type">StrictMaybe</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ProtVer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-589"></span><span id="pvCanFollow"><span class="annot"><span class="annottext">pvCanFollow :: ProtVer -&gt; StrictMaybe ProtVer -&gt; Bool
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#pvCanFollow"><span class="hs-identifier hs-var hs-var">pvCanFollow</span></a></span></span><span> </span><span class="annot"><span class="annottext">ProtVer
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StrictMaybe ProtVer
</span><a href="../../../../strict-containers/html/src"><span class="hs-identifier hs-var">SNothing</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-590"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#pvCanFollow"><span class="hs-identifier hs-var">pvCanFollow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ProtVer</span></a></span><span> </span><span id="local-6989586621679473818"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679473818"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679473817"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679473817"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../strict-containers/html/src"><span class="hs-identifier hs-type">SJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ProtVer</span></a></span><span> </span><span id="local-6989586621679473815"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679473815"><span class="hs-identifier hs-var">m'</span></a></span></span><span> </span><span id="local-6989586621679473814"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679473814"><span class="hs-identifier hs-var">n'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-591"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679473818"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Natural, Natural) -&gt; (Natural, Natural) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679473815"><span class="hs-identifier hs-var">m'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679473814"><span class="hs-identifier hs-var">n'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679473818"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679473817"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Natural, Natural) -&gt; (Natural, Natural) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679473815"><span class="hs-identifier hs-var">m'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679473814"><span class="hs-identifier hs-var">n'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-592"></span><span>
</span><span id="line-593"></span><span class="hs-comment">-- =============================</span><span>
</span><span id="line-594"></span><span>
</span><span id="line-595"></span><span class="hs-comment">-- | Incremental Stake, Stake along with possible missed coins from danging Ptrs.</span><span>
</span><span id="line-596"></span><span class="hs-comment">--   Transactions can use Ptrs to refer to a stake credential in a TxOut. The Ptr</span><span>
</span><span id="line-597"></span><span class="hs-comment">--   does not have to point to anything until the epoch boundary, when we compute</span><span>
</span><span id="line-598"></span><span class="hs-comment">--   rewards and aggregate staking information for ranking. This is unusual but legal.</span><span>
</span><span id="line-599"></span><span class="hs-comment">--   In a non incremental system, we use whatever 'legal' Ptrs exist at the epoch</span><span>
</span><span id="line-600"></span><span class="hs-comment">--   boundary. Here we are computing things incrementally, so we need to remember Ptrs</span><span>
</span><span id="line-601"></span><span class="hs-comment">--   that might point to something by the time the epoch boundary is reached. When</span><span>
</span><span id="line-602"></span><span class="hs-comment">--   the epoch boundary is reached we 'resolve' these pointers, to see if any have</span><span>
</span><span id="line-603"></span><span class="hs-comment">--   become non-dangling since the time they were first used in the incremental computation.</span><span>
</span><span id="line-604"></span><span id="local-6989586621679473810"><span id="local-6989586621679473811"></span></span><span class="hs-keyword">data</span><span> </span><span id="IncrementalStake"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-var">IncrementalStake</span></a></span></span><span> </span><span id="local-6989586621679474809"><span class="annot"><a href="#local-6989586621679474809"><span class="hs-identifier hs-type">crypto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="IStake"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-var">IStake</span></a></span></span><span>
</span><span id="line-605"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="credMap"><span class="annot"><span class="annottext">IncrementalStake crypto -&gt; Map (Credential 'Staking crypto) Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#credMap"><span class="hs-identifier hs-var hs-var">credMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474809"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-606"></span><span>    </span><span id="ptrMap"><span class="annot"><span class="annottext">IncrementalStake crypto -&gt; Map Ptr Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#ptrMap"><span class="hs-identifier hs-var hs-var">ptrMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-607"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-608"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x.
 IncrementalStake crypto -&gt; Rep (IncrementalStake crypto) x)
-&gt; (forall x.
    Rep (IncrementalStake crypto) x -&gt; IncrementalStake crypto)
-&gt; Generic (IncrementalStake crypto)
forall x.
Rep (IncrementalStake crypto) x -&gt; IncrementalStake crypto
forall x.
IncrementalStake crypto -&gt; Rep (IncrementalStake crypto) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall crypto x.
Rep (IncrementalStake crypto) x -&gt; IncrementalStake crypto
forall crypto x.
IncrementalStake crypto -&gt; Rep (IncrementalStake crypto) x
$cto :: forall crypto x.
Rep (IncrementalStake crypto) x -&gt; IncrementalStake crypto
$cfrom :: forall crypto x.
IncrementalStake crypto -&gt; Rep (IncrementalStake crypto) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473799"><span id="local-6989586621679473801"><span id="local-6989586621679473803"><span class="annot"><span class="annottext">Int -&gt; IncrementalStake crypto -&gt; ShowS
[IncrementalStake crypto] -&gt; ShowS
IncrementalStake crypto -&gt; String
(Int -&gt; IncrementalStake crypto -&gt; ShowS)
-&gt; (IncrementalStake crypto -&gt; String)
-&gt; ([IncrementalStake crypto] -&gt; ShowS)
-&gt; Show (IncrementalStake crypto)
forall crypto. Int -&gt; IncrementalStake crypto -&gt; ShowS
forall crypto. [IncrementalStake crypto] -&gt; ShowS
forall crypto. IncrementalStake crypto -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [IncrementalStake crypto] -&gt; ShowS
$cshowList :: forall crypto. [IncrementalStake crypto] -&gt; ShowS
show :: IncrementalStake crypto -&gt; String
$cshow :: forall crypto. IncrementalStake crypto -&gt; String
showsPrec :: Int -&gt; IncrementalStake crypto -&gt; ShowS
$cshowsPrec :: forall crypto. Int -&gt; IncrementalStake crypto -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473795"><span id="local-6989586621679473797"><span class="annot"><span class="annottext">IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
(IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool)
-&gt; (IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool)
-&gt; Eq (IncrementalStake crypto)
forall crypto.
IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
$c/= :: forall crypto.
IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
== :: IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
$c== :: forall crypto.
IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473780"><span id="local-6989586621679473782"><span id="local-6989586621679473784"><span id="local-6989586621679473786"><span id="local-6989586621679473788"><span id="local-6989586621679473790"><span id="local-6989586621679473792"><span class="annot"><span class="annottext">Eq (IncrementalStake crypto)
Eq (IncrementalStake crypto)
-&gt; (IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Ordering)
-&gt; (IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool)
-&gt; (IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool)
-&gt; (IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool)
-&gt; (IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool)
-&gt; (IncrementalStake crypto
    -&gt; IncrementalStake crypto -&gt; IncrementalStake crypto)
-&gt; (IncrementalStake crypto
    -&gt; IncrementalStake crypto -&gt; IncrementalStake crypto)
-&gt; Ord (IncrementalStake crypto)
IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Ordering
IncrementalStake crypto
-&gt; IncrementalStake crypto -&gt; IncrementalStake crypto
forall crypto. Eq (IncrementalStake crypto)
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
forall crypto.
IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
forall crypto.
IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Ordering
forall crypto.
IncrementalStake crypto
-&gt; IncrementalStake crypto -&gt; IncrementalStake crypto
min :: IncrementalStake crypto
-&gt; IncrementalStake crypto -&gt; IncrementalStake crypto
$cmin :: forall crypto.
IncrementalStake crypto
-&gt; IncrementalStake crypto -&gt; IncrementalStake crypto
max :: IncrementalStake crypto
-&gt; IncrementalStake crypto -&gt; IncrementalStake crypto
$cmax :: forall crypto.
IncrementalStake crypto
-&gt; IncrementalStake crypto -&gt; IncrementalStake crypto
&gt;= :: IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
$c&gt;= :: forall crypto.
IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
&gt; :: IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
$c&gt; :: forall crypto.
IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
&lt;= :: IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
$c&lt;= :: forall crypto.
IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
&lt; :: IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
$c&lt; :: forall crypto.
IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Bool
compare :: IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Ordering
$ccompare :: forall crypto.
IncrementalStake crypto -&gt; IncrementalStake crypto -&gt; Ordering
$cp1Ord :: forall crypto. Eq (IncrementalStake crypto)
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473774"><span id="local-6989586621679473776"><span id="local-6989586621679473778"><span class="annot"><span class="annottext">Context -&gt; IncrementalStake crypto -&gt; IO (Maybe ThunkInfo)
Proxy (IncrementalStake crypto) -&gt; String
(Context -&gt; IncrementalStake crypto -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; IncrementalStake crypto -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (IncrementalStake crypto) -&gt; String)
-&gt; NoThunks (IncrementalStake crypto)
forall crypto.
Context -&gt; IncrementalStake crypto -&gt; IO (Maybe ThunkInfo)
forall crypto. Proxy (IncrementalStake crypto) -&gt; String
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
showTypeOf :: Proxy (IncrementalStake crypto) -&gt; String
$cshowTypeOf :: forall crypto. Proxy (IncrementalStake crypto) -&gt; String
wNoThunks :: Context -&gt; IncrementalStake crypto -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall crypto.
Context -&gt; IncrementalStake crypto -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; IncrementalStake crypto -&gt; IO (Maybe ThunkInfo)
$cnoThunks :: forall crypto.
Context -&gt; IncrementalStake crypto -&gt; IO (Maybe ThunkInfo)
</span><a href="#local-6989586621679473774"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473772"><span class="annot"><span class="annottext">IncrementalStake crypto -&gt; ()
(IncrementalStake crypto -&gt; ()) -&gt; NFData (IncrementalStake crypto)
forall crypto. IncrementalStake crypto -&gt; ()
forall a. (a -&gt; ()) -&gt; NFData a
rnf :: IncrementalStake crypto -&gt; ()
$crnf :: forall crypto. IncrementalStake crypto -&gt; ()
</span><a href="#local-6989586621679473772"><span class="hs-identifier hs-var hs-var hs-var hs-var">NFData</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span>
</span><span id="line-610"></span><span id="local-6989586621679473771"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473765"><span id="local-6989586621679473767"><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473771"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473771"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-611"></span><span>  </span><span id="local-6989586621679473764"><span class="annot"><span class="annottext">toCBOR :: IncrementalStake crypto -&gt; Encoding
</span><a href="#local-6989586621679473764"><span class="hs-identifier hs-var hs-var hs-var hs-var">toCBOR</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-type">IStake</span></a></span><span> </span><span id="local-6989586621679473763"><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473763"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679473762"><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473762"><span class="hs-identifier hs-var">dangle</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-612"></span><span>    </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><a href="../../../../cborg/html/src"><span class="hs-identifier hs-var">encodeListLen</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin -&gt; Encoding
forall a b. (ToCBOR a, ToCBOR b) =&gt; Map a b -&gt; Encoding
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">mapToCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473763"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin -&gt; Encoding
forall a b. (ToCBOR a, ToCBOR b) =&gt; Map a b -&gt; Encoding
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">mapToCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473762"><span class="hs-identifier hs-var">dangle</span></a></span></span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span id="local-6989586621679473761"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473755"><span id="local-6989586621679473758"><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473761"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">FromSharedCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473761"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-615"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="Share"><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">Share</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473761"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Interns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473761"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-616"></span><span>  </span><span id="local-6989586621679473754"><span class="annot"><span class="annottext">fromSharedCBOR :: Share (IncrementalStake crypto)
-&gt; Decoder s (IncrementalStake crypto)
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromSharedCBOR</span></a></span></span><span> </span><span id="local-6989586621679473752"><span class="annot"><span class="annottext">Share (IncrementalStake crypto)
</span><a href="#local-6989586621679473752"><span class="hs-identifier hs-var">credInterns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-617"></span><span>    </span><span class="annot"><span class="annottext">Text
-&gt; (IncrementalStake crypto -&gt; Int)
-&gt; Decoder s (IncrementalStake crypto)
-&gt; Decoder s (IncrementalStake crypto)
forall a s. Text -&gt; (a -&gt; Int) -&gt; Decoder s a -&gt; Decoder s a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">decodeRecordNamed</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Stake&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; IncrementalStake crypto -&gt; Int
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Decoder s (IncrementalStake crypto)
 -&gt; Decoder s (IncrementalStake crypto))
-&gt; Decoder s (IncrementalStake crypto)
-&gt; Decoder s (IncrementalStake crypto)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-618"></span><span>      </span><span id="local-6989586621679473751"><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473751"><span class="hs-identifier hs-var">stake</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Share (Map (Credential 'Staking crypto) Coin)
-&gt; Decoder s (Map (Credential 'Staking crypto) Coin)
forall a s. FromSharedCBOR a =&gt; Share a -&gt; Decoder s a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Interns (Credential 'Staking crypto)
Share (IncrementalStake crypto)
</span><a href="#local-6989586621679473752"><span class="hs-identifier hs-var">credInterns</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Interns Coin
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>      </span><span id="local-6989586621679473750"><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473750"><span class="hs-identifier hs-var">dangle</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s (Map Ptr Coin)
forall a b s.
(Ord a, FromCBOR a, FromCBOR b) =&gt;
Decoder s (Map a b)
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">mapFromCBOR</span></a></span><span>
</span><span id="line-620"></span><span>      </span><span class="annot"><span class="annottext">IncrementalStake crypto -&gt; Decoder s (IncrementalStake crypto)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(IncrementalStake crypto -&gt; Decoder s (IncrementalStake crypto))
-&gt; IncrementalStake crypto -&gt; Decoder s (IncrementalStake crypto)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake crypto
forall crypto.
Map (Credential 'Staking crypto) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-var">IStake</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473751"><span class="hs-identifier hs-var">stake</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473750"><span class="hs-identifier hs-var">dangle</span></a></span></span><span>
</span><span id="line-621"></span><span>
</span><span id="line-622"></span><span id="local-6989586621679473749"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473744"><span id="local-6989586621679473746"><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Semigroup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473749"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-623"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-type">IStake</span></a></span><span> </span><span id="local-6989586621679473742"><span class="annot"><span class="annottext">Map (Credential 'Staking c) Coin
</span><a href="#local-6989586621679473742"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679473741"><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473741"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473740"><span class="annot"><span class="annottext">&lt;&gt; :: IncrementalStake c -&gt; IncrementalStake c -&gt; IncrementalStake c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var hs-var hs-var hs-var">&lt;&gt;</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-type">IStake</span></a></span><span> </span><span id="local-6989586621679473739"><span class="annot"><span class="annottext">Map (Credential 'Staking c) Coin
</span><a href="#local-6989586621679473739"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679473738"><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473738"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking c) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake c
forall crypto.
Map (Credential 'Staking crypto) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-var">IStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Coin -&gt; Coin -&gt; Coin)
-&gt; Map (Credential 'Staking c) Coin
-&gt; Map (Credential 'Staking c) Coin
-&gt; Map (Credential 'Staking c) Coin
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.unionWith</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">(&lt;&gt;)</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking c) Coin
</span><a href="#local-6989586621679473742"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking c) Coin
</span><a href="#local-6989586621679473739"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Coin -&gt; Coin -&gt; Coin)
-&gt; Map Ptr Coin -&gt; Map Ptr Coin -&gt; Map Ptr Coin
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.unionWith</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">(&lt;&gt;)</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473741"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473738"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-624"></span><span>
</span><span id="line-625"></span><span id="local-6989586621679473736"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473730"><span id="local-6989586621679473732"><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Monoid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473736"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-626"></span><span>  </span><span id="local-6989586621679473728"><span class="annot"><span class="annottext">mempty :: IncrementalStake c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">mempty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking c) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake c
forall crypto.
Map (Credential 'Staking crypto) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-var">IStake</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking c) Coin
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span></span><span>
</span><span id="line-627"></span><span>
</span><span id="line-628"></span><span id="local-6989586621679473726"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473720"><span id="local-6989586621679473722"><span class="annot"><a href="../../../../groups/html/src"><span class="hs-identifier hs-type">Data.Group.Group</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473726"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-629"></span><span>  </span><span id="local-6989586621679473718"><span class="annot"><span class="annottext">invert :: IncrementalStake c -&gt; IncrementalStake c
</span><a href="#local-6989586621679473718"><span class="hs-identifier hs-var hs-var hs-var hs-var">invert</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-type">IStake</span></a></span><span> </span><span id="local-6989586621679473717"><span class="annot"><span class="annottext">Map (Credential 'Staking c) Coin
</span><a href="#local-6989586621679473717"><span class="hs-identifier hs-var">m1</span></a></span></span><span> </span><span id="local-6989586621679473716"><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473716"><span class="hs-identifier hs-var">m2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking c) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake c
forall crypto.
Map (Credential 'Staking crypto) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-var">IStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Coin -&gt; Coin)
-&gt; Map (Credential 'Staking c) Coin
-&gt; Map (Credential 'Staking c) Coin
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.map</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin
forall m. Group m =&gt; m -&gt; m
</span><a href="../../../../groups/html/src"><span class="hs-identifier hs-var">invert</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking c) Coin
</span><a href="#local-6989586621679473717"><span class="hs-identifier hs-var">m1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Coin -&gt; Coin) -&gt; Map Ptr Coin -&gt; Map Ptr Coin
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.map</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin
forall m. Group m =&gt; m -&gt; m
</span><a href="../../../../groups/html/src"><span class="hs-identifier hs-var">invert</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473716"><span class="hs-identifier hs-var">m2</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-630"></span><span>
</span><span id="line-631"></span><span id="local-6989586621679473714"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473714"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-632"></span><span>  </span><span id="local-6989586621679473711"><span class="annot"><span class="annottext">def :: IncrementalStake c
</span><a href="#local-6989586621679473711"><span class="hs-identifier hs-var hs-var hs-var hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking c) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake c
forall crypto.
Map (Credential 'Staking crypto) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-var">IStake</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking c) Coin
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span></span><span>
</span><span id="line-633"></span><span>
</span><span id="line-634"></span><span class="hs-comment">-- =============================</span><span>
</span><span id="line-635"></span><span>
</span><span id="line-636"></span><span class="hs-comment">-- | There is a serious invariant that we must maintain in the UTxOState.</span><span>
</span><span id="line-637"></span><span class="hs-comment">--   Given (UTxOState utxo _ _ _ istake) it must be the case that</span><span>
</span><span id="line-638"></span><span class="hs-comment">--   istake == (updateStakeDistribution (UTxO Map.empty) (UTxO Map.empty) utxo)</span><span>
</span><span id="line-639"></span><span class="hs-comment">--   Of course computing the RHS of the above equality can be very expensive, so we only</span><span>
</span><span id="line-640"></span><span class="hs-comment">--   use this route in the testing function smartUTxO. But we are very carefull, wherever</span><span>
</span><span id="line-641"></span><span class="hs-comment">--   we update the UTxO, we carefully make INCREMENTAL changes to istake to maintain</span><span>
</span><span id="line-642"></span><span class="hs-comment">--   this invariant. This happens in the UTxO rule.</span><span>
</span><span id="line-643"></span><span id="local-6989586621679473709"><span id="local-6989586621679473710"></span></span><span class="hs-keyword">data</span><span> </span><span id="UTxOState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-var">UTxOState</span></a></span></span><span> </span><span id="local-6989586621679474770"><span class="annot"><a href="#local-6989586621679474770"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="UTxOState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-var">UTxOState</span></a></span></span><span>
</span><span id="line-644"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_utxo"><span class="annot"><span class="annottext">UTxOState era -&gt; UTxO era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_utxo"><span class="hs-identifier hs-var hs-var">_utxo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474770"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-645"></span><span>    </span><span id="_deposited"><span class="annot"><span class="annottext">UTxOState era -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_deposited"><span class="hs-identifier hs-var hs-var">_deposited</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-646"></span><span>    </span><span id="_fees"><span class="annot"><span class="annottext">UTxOState era -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_fees"><span class="hs-identifier hs-var hs-var">_fees</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-647"></span><span>    </span><span id="_ppups"><span class="annot"><span class="annottext">UTxOState era -&gt; State (EraRule &quot;PPUP&quot; era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_ppups"><span class="hs-identifier hs-var hs-var">_ppups</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679474770"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-648"></span><span>    </span><span id="_stakeDistro"><span class="annot"><span class="annottext">UTxOState era -&gt; IncrementalStake (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_stakeDistro"><span class="hs-identifier hs-var hs-var">_stakeDistro</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474770"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-649"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-650"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. UTxOState era -&gt; Rep (UTxOState era) x)
-&gt; (forall x. Rep (UTxOState era) x -&gt; UTxOState era)
-&gt; Generic (UTxOState era)
forall x. Rep (UTxOState era) x -&gt; UTxOState era
forall x. UTxOState era -&gt; Rep (UTxOState era) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall era x. Rep (UTxOState era) x -&gt; UTxOState era
forall era x. UTxOState era -&gt; Rep (UTxOState era) x
$cto :: forall era x. Rep (UTxOState era) x -&gt; UTxOState era
$cfrom :: forall era x. UTxOState era -&gt; Rep (UTxOState era) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-651"></span><span>
</span><span id="line-652"></span><span id="local-6989586621679473700"><span class="hs-keyword">instance</span><span>
</span><span id="line-653"></span><span>  </span><span id="local-6989586621679473698"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473700"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-654"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473700"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-655"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473700"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-656"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-657"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-type">UTxOState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473700"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-658"></span><span>
</span><span id="line-659"></span><span id="local-6989586621679473692"><span id="local-6989586621679473694"><span id="local-6989586621679473696"><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679473691"><span class="annot"><a href="#local-6989586621679473691"><span class="hs-keyword hs-type">stock</span></a></span></span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-660"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473691"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-661"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473691"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-662"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473691"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-663"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-664"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-type">UTxOState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473691"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span id="local-6989586621679473687"><span id="local-6989586621679473689"><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679473686"><span class="annot"><a href="#local-6989586621679473686"><span class="hs-keyword hs-type">stock</span></a></span></span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-667"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473686"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-668"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473686"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-669"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473686"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-670"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-671"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-type">UTxOState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473686"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-672"></span><span>
</span><span id="line-673"></span><span id="local-6989586621679473685"><span class="hs-keyword">instance</span><span>
</span><span id="line-674"></span><span>  </span><span id="local-6989586621679473679"><span id="local-6989586621679473681"><span id="local-6989586621679473683"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473685"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-675"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473685"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-676"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473685"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-677"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.Value</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473685"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-678"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473685"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-679"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473685"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-680"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.Value</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473685"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-681"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-682"></span><span>  </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-type">UTxOState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473685"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-683"></span><span>
</span><span id="line-684"></span><span id="local-6989586621679473678"><span class="hs-keyword">instance</span><span>
</span><span id="line-685"></span><span>  </span><span id="local-6989586621679473672"><span id="local-6989586621679473674"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473678"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-686"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473678"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-687"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473678"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-688"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-689"></span><span>  </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-type">UTxOState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473678"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-690"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-691"></span><span>  </span><span id="local-6989586621679473671"><span class="annot"><span class="annottext">toCBOR :: UTxOState era -&gt; Encoding
</span><a href="#local-6989586621679473671"><span class="hs-identifier hs-var hs-var hs-var hs-var">toCBOR</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-type">UTxOState</span></a></span><span> </span><span id="local-6989586621679473670"><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679473670"><span class="hs-identifier hs-var">ut</span></a></span></span><span> </span><span id="local-6989586621679473669"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473669"><span class="hs-identifier hs-var">dp</span></a></span></span><span> </span><span id="local-6989586621679473668"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473668"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span id="local-6989586621679473667"><span class="annot"><span class="annottext">State (EraRule &quot;PPUP&quot; era)
</span><a href="#local-6989586621679473667"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span id="local-6989586621679473666"><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473666"><span class="hs-identifier hs-var">sd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-692"></span><span>    </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><a href="../../../../cborg/html/src"><span class="hs-identifier hs-var">encodeListLen</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">5</span></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UTxO era -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679473670"><span class="hs-identifier hs-var">ut</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473669"><span class="hs-identifier hs-var">dp</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473668"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">State (EraRule &quot;PPUP&quot; era) -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">State (EraRule &quot;PPUP&quot; era)
</span><a href="#local-6989586621679473667"><span class="hs-identifier hs-var">us</span></a></span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IncrementalStake (Crypto era) -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473666"><span class="hs-identifier hs-var">sd</span></a></span></span><span>
</span><span id="line-693"></span><span>
</span><span id="line-694"></span><span id="local-6989586621679473665"><span class="hs-keyword">instance</span><span>
</span><span id="line-695"></span><span>  </span><span id="local-6989586621679473659"><span id="local-6989586621679473662"><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.Constraints.html#TransValue"><span class="hs-identifier hs-type">TransValue</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473665"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-696"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473665"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-697"></span><span>    </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">FromSharedCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473665"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-698"></span><span>    </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Share</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473665"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Interns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473665"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-699"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">HashAnnotated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473665"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">EraIndependentTxBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473665"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-700"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-701"></span><span>  </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">FromSharedCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-type">UTxOState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473665"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-702"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-703"></span><span>  </span><span class="hs-keyword">type</span><span>
</span><span id="line-704"></span><span>    </span><span id="Share"><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">Share</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-type">UTxOState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473665"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-705"></span><span>      </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Interns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473665"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-706"></span><span>  </span><span id="local-6989586621679473658"><span class="annot"><span class="annottext">fromSharedCBOR :: Share (UTxOState era) -&gt; Decoder s (UTxOState era)
</span><a href="#local-6989586621679473658"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromSharedCBOR</span></a></span></span><span> </span><span id="local-6989586621679473657"><span class="annot"><span class="annottext">Share (UTxOState era)
</span><a href="#local-6989586621679473657"><span class="hs-identifier hs-var">credInterns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-707"></span><span>    </span><span class="annot"><span class="annottext">Text
-&gt; (UTxOState era -&gt; Int)
-&gt; Decoder s (UTxOState era)
-&gt; Decoder s (UTxOState era)
forall a s. Text -&gt; (a -&gt; Int) -&gt; Decoder s a -&gt; Decoder s a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">decodeRecordNamed</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;UTxOState&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; UTxOState era -&gt; Int
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">5</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Decoder s (UTxOState era) -&gt; Decoder s (UTxOState era))
-&gt; Decoder s (UTxOState era) -&gt; Decoder s (UTxOState era)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-708"></span><span>      </span><span id="local-6989586621679473656"><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679473656"><span class="hs-identifier hs-var">_utxo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Share (UTxO era) -&gt; Decoder s (UTxO era)
forall a s. FromSharedCBOR a =&gt; Share a -&gt; Decoder s a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Share (UTxO era)
Share (UTxOState era)
</span><a href="#local-6989586621679473657"><span class="hs-identifier hs-var">credInterns</span></a></span><span>
</span><span id="line-709"></span><span>      </span><span id="local-6989586621679473655"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473655"><span class="hs-identifier hs-var">_deposited</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s Coin
forall a s. FromCBOR a =&gt; Decoder s a
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">fromCBOR</span></a></span><span>
</span><span id="line-710"></span><span>      </span><span id="local-6989586621679473654"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473654"><span class="hs-identifier hs-var">_fees</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s Coin
forall a s. FromCBOR a =&gt; Decoder s a
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">fromCBOR</span></a></span><span>
</span><span id="line-711"></span><span>      </span><span id="local-6989586621679473653"><span class="annot"><span class="annottext">State (EraRule &quot;PPUP&quot; era)
</span><a href="#local-6989586621679473653"><span class="hs-identifier hs-var">_ppups</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Decoder s (State (EraRule &quot;PPUP&quot; era))
forall a s. FromCBOR a =&gt; Decoder s a
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">fromCBOR</span></a></span><span>
</span><span id="line-712"></span><span>      </span><span id="local-6989586621679473652"><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473652"><span class="hs-identifier hs-var">_stakeDistro</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Share (IncrementalStake (Crypto era))
-&gt; Decoder s (IncrementalStake (Crypto era))
forall a s. FromSharedCBOR a =&gt; Share a -&gt; Decoder s a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">Share (UTxOState era)
Share (IncrementalStake (Crypto era))
</span><a href="#local-6989586621679473657"><span class="hs-identifier hs-var">credInterns</span></a></span><span>
</span><span id="line-713"></span><span>      </span><span class="annot"><span class="annottext">UTxOState era -&gt; Decoder s (UTxOState era)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">UTxOState :: forall era.
UTxO era
-&gt; Coin
-&gt; Coin
-&gt; State (EraRule &quot;PPUP&quot; era)
-&gt; IncrementalStake (Crypto era)
-&gt; UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-type">UTxOState</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">UTxO era
_utxo :: UTxO era
_utxo :: UTxO era
</span><a href="#local-6989586621679473656"><span class="hs-identifier hs-var hs-var">_utxo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coin
_deposited :: Coin
_deposited :: Coin
</span><a href="#local-6989586621679473655"><span class="hs-identifier hs-var hs-var">_deposited</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coin
_fees :: Coin
_fees :: Coin
</span><a href="#local-6989586621679473654"><span class="hs-identifier hs-var hs-var">_fees</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State (EraRule &quot;PPUP&quot; era)
_ppups :: State (EraRule &quot;PPUP&quot; era)
_ppups :: State (EraRule &quot;PPUP&quot; era)
</span><a href="#local-6989586621679473653"><span class="hs-identifier hs-var hs-var">_ppups</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
_stakeDistro :: IncrementalStake (Crypto era)
_stakeDistro :: IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473652"><span class="hs-identifier hs-var hs-var">_stakeDistro</span></a></span><span class="hs-special">}</span></span><span>
</span><span id="line-714"></span><span>
</span><span id="line-715"></span><span class="hs-comment">-- | New Epoch state and environment</span><span>
</span><span id="line-716"></span><span id="local-6989586621679473650"><span id="local-6989586621679473651"></span></span><span class="hs-keyword">data</span><span> </span><span id="NewEpochState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-var">NewEpochState</span></a></span></span><span> </span><span id="local-6989586621679474747"><span class="annot"><a href="#local-6989586621679474747"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NewEpochState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-var">NewEpochState</span></a></span></span><span>
</span><span id="line-717"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | Last epoch</span><span>
</span><span id="line-718"></span><span>    </span><span id="nesEL"><span class="annot"><span class="annottext">NewEpochState era -&gt; EpochNo
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#nesEL"><span class="hs-identifier hs-var hs-var">nesEL</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">EpochNo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-719"></span><span>    </span><span class="hs-comment">-- | Blocks made before current epoch</span><span>
</span><span id="line-720"></span><span>    </span><span id="nesBprev"><span class="annot"><span class="annottext">NewEpochState era -&gt; BlocksMade (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#nesBprev"><span class="hs-identifier hs-var hs-var">nesBprev</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">BlocksMade</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474747"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-721"></span><span>    </span><span class="hs-comment">-- | Blocks made in current epoch</span><span>
</span><span id="line-722"></span><span>    </span><span id="nesBcur"><span class="annot"><span class="annottext">NewEpochState era -&gt; BlocksMade (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#nesBcur"><span class="hs-identifier hs-var hs-var">nesBcur</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">BlocksMade</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474747"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-723"></span><span>    </span><span class="hs-comment">-- | Epoch state before current</span><span>
</span><span id="line-724"></span><span>    </span><span id="nesEs"><span class="annot"><span class="annottext">NewEpochState era -&gt; EpochState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#nesEs"><span class="hs-identifier hs-var hs-var">nesEs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474747"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-725"></span><span>    </span><span class="hs-comment">-- | Possible reward update</span><span>
</span><span id="line-726"></span><span>    </span><span id="nesRu"><span class="annot"><span class="annottext">NewEpochState era -&gt; StrictMaybe (PulsingRewUpdate (Crypto era))
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#nesRu"><span class="hs-identifier hs-var hs-var">nesRu</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../strict-containers/html/src"><span class="hs-identifier hs-type">StrictMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#PulsingRewUpdate"><span class="hs-identifier hs-type">PulsingRewUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474747"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-727"></span><span>    </span><span class="hs-comment">-- | Stake distribution within the stake pool</span><span>
</span><span id="line-728"></span><span>    </span><span id="nesPd"><span class="annot"><span class="annottext">NewEpochState era -&gt; PoolDistr (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#nesPd"><span class="hs-identifier hs-var hs-var">nesPd</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">PoolDistr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474747"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-729"></span><span>    </span><span class="hs-comment">-- | AVVM addresses to be removed at the end of the Shelley era. Note that</span><span>
</span><span id="line-730"></span><span>    </span><span class="hs-comment">-- the existence of this field is a hack, related to the transition of UTxO</span><span>
</span><span id="line-731"></span><span>    </span><span class="hs-comment">-- to disk. We remove AVVM addresses from the UTxO on the Shelley/Allegra</span><span>
</span><span id="line-732"></span><span>    </span><span class="hs-comment">-- boundary. However, by this point the UTxO will be moved to disk, and</span><span>
</span><span id="line-733"></span><span>    </span><span class="hs-comment">-- hence doing a scan of the UTxO for AVVM addresses will be expensive. Our</span><span>
</span><span id="line-734"></span><span>    </span><span class="hs-comment">-- solution to this is to do a scan of the UTxO on the Byron/Shelley</span><span>
</span><span id="line-735"></span><span>    </span><span class="hs-comment">-- boundary (since Byron UTxO are still on disk), stash the results here,</span><span>
</span><span id="line-736"></span><span>    </span><span class="hs-comment">-- and then remove them at the Shelley/Allegra boundary.</span><span>
</span><span id="line-737"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-738"></span><span>    </span><span class="hs-comment">-- This is very much an awkward implementation hack, and hence we hide it</span><span>
</span><span id="line-739"></span><span>    </span><span class="hs-comment">-- from as many places as possible.</span><span>
</span><span id="line-740"></span><span>    </span><span id="stashedAVVMAddresses"><span class="annot"><span class="annottext">NewEpochState era -&gt; StashedAVVMAddresses era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#stashedAVVMAddresses"><span class="hs-identifier hs-var hs-var">stashedAVVMAddresses</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#StashedAVVMAddresses"><span class="hs-identifier hs-type">StashedAVVMAddresses</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474747"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-741"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-742"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. NewEpochState era -&gt; Rep (NewEpochState era) x)
-&gt; (forall x. Rep (NewEpochState era) x -&gt; NewEpochState era)
-&gt; Generic (NewEpochState era)
forall x. Rep (NewEpochState era) x -&gt; NewEpochState era
forall x. NewEpochState era -&gt; Rep (NewEpochState era) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall era x. Rep (NewEpochState era) x -&gt; NewEpochState era
forall era x. NewEpochState era -&gt; Rep (NewEpochState era) x
$cto :: forall era x. Rep (NewEpochState era) x -&gt; NewEpochState era
$cfrom :: forall era x. NewEpochState era -&gt; Rep (NewEpochState era) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-743"></span><span>
</span><span id="line-744"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="StashedAVVMAddresses"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#StashedAVVMAddresses"><span class="hs-identifier hs-var">StashedAVVMAddresses</span></a></span></span><span> </span><span id="local-6989586621679473647"><span class="annot"><a href="#local-6989586621679473647"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-745"></span><span>  </span><span id="StashedAVVMAddresses"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#StashedAVVMAddresses"><span class="hs-identifier hs-var">StashedAVVMAddresses</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.html#ShelleyEra"><span class="hs-identifier hs-type">ShelleyEra</span></a></span><span> </span><span id="local-6989586621679473646"><span class="annot"><a href="#local-6989586621679473646"><span class="hs-identifier hs-type hs-type">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.html#ShelleyEra"><span class="hs-identifier hs-type">ShelleyEra</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473646"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-746"></span><span>  </span><span id="StashedAVVMAddresses"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#StashedAVVMAddresses"><span class="hs-identifier hs-var">StashedAVVMAddresses</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-747"></span><span>
</span><span id="line-748"></span><span id="local-6989586621679473640"><span id="local-6989586621679473642"><span id="local-6989586621679473644"><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679473639"><span class="annot"><a href="#local-6989586621679473639"><span class="hs-keyword hs-type">stock</span></a></span></span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-749"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473639"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-750"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473639"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-751"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473639"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-752"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473639"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-753"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#StashedAVVMAddresses"><span class="hs-identifier hs-type">StashedAVVMAddresses</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473639"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-754"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-755"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473639"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-756"></span><span>
</span><span id="line-757"></span><span id="local-6989586621679473635"><span id="local-6989586621679473637"><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679473634"><span class="annot"><a href="#local-6989586621679473634"><span class="hs-keyword hs-type">stock</span></a></span></span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-758"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473634"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-759"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473634"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-760"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473634"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-761"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473634"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-762"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#StashedAVVMAddresses"><span class="hs-identifier hs-type">StashedAVVMAddresses</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473634"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-763"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-764"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473634"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-765"></span><span>
</span><span id="line-766"></span><span id="local-6989586621679473633"><span class="hs-keyword">instance</span><span>
</span><span id="line-767"></span><span>  </span><span id="local-6989586621679473631"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473633"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-768"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473633"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-769"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473633"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-770"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473633"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-771"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#StashedAVVMAddresses"><span class="hs-identifier hs-type">StashedAVVMAddresses</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473633"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-772"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-773"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473633"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-774"></span><span>
</span><span id="line-775"></span><span id="local-6989586621679473630"><span class="hs-keyword">instance</span><span>
</span><span id="line-776"></span><span>  </span><span id="local-6989586621679473624"><span id="local-6989586621679473626"><span id="local-6989586621679473628"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473630"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-777"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473630"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-778"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473630"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-779"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473630"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-780"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.Value</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473630"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-781"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#StashedAVVMAddresses"><span class="hs-identifier hs-type">StashedAVVMAddresses</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473630"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-782"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473630"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-783"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473630"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-784"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.Value</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473630"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-785"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-786"></span><span>  </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473630"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-787"></span><span>
</span><span id="line-788"></span><span id="local-6989586621679473623"><span class="hs-keyword">instance</span><span>
</span><span id="line-789"></span><span>  </span><span id="local-6989586621679473617"><span id="local-6989586621679473619"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473623"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-790"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473623"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-791"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473623"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-792"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473623"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-793"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#StashedAVVMAddresses"><span class="hs-identifier hs-type">StashedAVVMAddresses</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473623"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-794"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-795"></span><span>  </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473623"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-796"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-797"></span><span>  </span><span id="local-6989586621679473616"><span class="annot"><span class="annottext">toCBOR :: NewEpochState era -&gt; Encoding
</span><a href="#local-6989586621679473616"><span class="hs-identifier hs-var hs-var hs-var hs-var">toCBOR</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span id="local-6989586621679473615"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679473615"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679473614"><span class="annot"><span class="annottext">BlocksMade (Crypto era)
</span><a href="#local-6989586621679473614"><span class="hs-identifier hs-var">bp</span></a></span></span><span> </span><span id="local-6989586621679473613"><span class="annot"><span class="annottext">BlocksMade (Crypto era)
</span><a href="#local-6989586621679473613"><span class="hs-identifier hs-var">bc</span></a></span></span><span> </span><span id="local-6989586621679473612"><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473612"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621679473611"><span class="annot"><span class="annottext">StrictMaybe (PulsingRewUpdate (Crypto era))
</span><a href="#local-6989586621679473611"><span class="hs-identifier hs-var">ru</span></a></span></span><span> </span><span id="local-6989586621679473610"><span class="annot"><span class="annottext">PoolDistr (Crypto era)
</span><a href="#local-6989586621679473610"><span class="hs-identifier hs-var">pd</span></a></span></span><span> </span><span id="local-6989586621679473609"><span class="annot"><span class="annottext">StashedAVVMAddresses era
</span><a href="#local-6989586621679473609"><span class="hs-identifier hs-var">av</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-798"></span><span>    </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><a href="../../../../cborg/html/src"><span class="hs-identifier hs-var">encodeListLen</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">7</span></span><span>
</span><span id="line-799"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679473615"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-800"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">BlocksMade (Crypto era) -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">BlocksMade (Crypto era)
</span><a href="#local-6989586621679473614"><span class="hs-identifier hs-var">bp</span></a></span><span>
</span><span id="line-801"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">BlocksMade (Crypto era) -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">BlocksMade (Crypto era)
</span><a href="#local-6989586621679473613"><span class="hs-identifier hs-var">bc</span></a></span><span>
</span><span id="line-802"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473612"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-803"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictMaybe (PulsingRewUpdate (Crypto era)) -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">StrictMaybe (PulsingRewUpdate (Crypto era))
</span><a href="#local-6989586621679473611"><span class="hs-identifier hs-var">ru</span></a></span><span>
</span><span id="line-804"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PoolDistr (Crypto era) -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">PoolDistr (Crypto era)
</span><a href="#local-6989586621679473610"><span class="hs-identifier hs-var">pd</span></a></span><span>
</span><span id="line-805"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StashedAVVMAddresses era -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">StashedAVVMAddresses era
</span><a href="#local-6989586621679473609"><span class="hs-identifier hs-var">av</span></a></span></span><span>
</span><span id="line-806"></span><span>
</span><span id="line-807"></span><span id="local-6989586621679473608"><span class="hs-keyword">instance</span><span>
</span><span id="line-808"></span><span>  </span><span id="local-6989586621679473604"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473608"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-809"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473608"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-810"></span><span>    </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">FromSharedCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473608"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-811"></span><span>    </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Share</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473608"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Interns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473608"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-812"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.Value</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473608"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-813"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473608"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-814"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#StashedAVVMAddresses"><span class="hs-identifier hs-type">StashedAVVMAddresses</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473608"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-815"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-816"></span><span>  </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473608"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-817"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-818"></span><span>  </span><span id="local-6989586621679473603"><span class="annot"><span class="annottext">fromCBOR :: Decoder s (NewEpochState era)
</span><a href="#local-6989586621679473603"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromCBOR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-819"></span><span>    </span><span class="annot"><span class="annottext">Decode ('Closed 'Dense) (NewEpochState era)
-&gt; Decoder s (NewEpochState era)
forall (w :: Wrapped) t s. Decode w t -&gt; Decoder s t
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">decode</span></a></span><span> </span><span class="annot"><span class="annottext">(Decode ('Closed 'Dense) (NewEpochState era)
 -&gt; Decoder s (NewEpochState era))
-&gt; Decode ('Closed 'Dense) (NewEpochState era)
-&gt; Decoder s (NewEpochState era)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-820"></span><span>      </span><span class="annot"><span class="annottext">(EpochNo
 -&gt; BlocksMade (Crypto era)
 -&gt; BlocksMade (Crypto era)
 -&gt; EpochState era
 -&gt; StrictMaybe (PulsingRewUpdate (Crypto era))
 -&gt; PoolDistr (Crypto era)
 -&gt; StashedAVVMAddresses era
 -&gt; NewEpochState era)
-&gt; Decode
     ('Closed 'Dense)
     (EpochNo
      -&gt; BlocksMade (Crypto era)
      -&gt; BlocksMade (Crypto era)
      -&gt; EpochState era
      -&gt; StrictMaybe (PulsingRewUpdate (Crypto era))
      -&gt; PoolDistr (Crypto era)
      -&gt; StashedAVVMAddresses era
      -&gt; NewEpochState era)
forall t. t -&gt; Decode ('Closed 'Dense) t
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">RecD</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
-&gt; BlocksMade (Crypto era)
-&gt; BlocksMade (Crypto era)
-&gt; EpochState era
-&gt; StrictMaybe (PulsingRewUpdate (Crypto era))
-&gt; PoolDistr (Crypto era)
-&gt; StashedAVVMAddresses era
-&gt; NewEpochState era
forall era.
EpochNo
-&gt; BlocksMade (Crypto era)
-&gt; BlocksMade (Crypto era)
-&gt; EpochState era
-&gt; StrictMaybe (PulsingRewUpdate (Crypto era))
-&gt; PoolDistr (Crypto era)
-&gt; StashedAVVMAddresses era
-&gt; NewEpochState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-var">NewEpochState</span></a></span><span>
</span><span id="line-821"></span><span>        </span><span class="annot"><span class="annottext">Decode
  ('Closed 'Dense)
  (EpochNo
   -&gt; BlocksMade (Crypto era)
   -&gt; BlocksMade (Crypto era)
   -&gt; EpochState era
   -&gt; StrictMaybe (PulsingRewUpdate (Crypto era))
   -&gt; PoolDistr (Crypto era)
   -&gt; StashedAVVMAddresses era
   -&gt; NewEpochState era)
-&gt; Decode ('Closed Any) EpochNo
-&gt; Decode
     ('Closed 'Dense)
     (BlocksMade (Crypto era)
      -&gt; BlocksMade (Crypto era)
      -&gt; EpochState era
      -&gt; StrictMaybe (PulsingRewUpdate (Crypto era))
      -&gt; PoolDistr (Crypto era)
      -&gt; StashedAVVMAddresses era
      -&gt; NewEpochState era)
forall (w1 :: Wrapped) a t (w :: Density).
Decode w1 (a -&gt; t) -&gt; Decode ('Closed w) a -&gt; Decode w1 t
</span><a href="../../../../cardano-data/html/src"><span class="hs-operator hs-var">&lt;!</span></a></span><span> </span><span class="annot"><span class="annottext">Decode ('Closed Any) EpochNo
forall t (w :: Wrapped). FromCBOR t =&gt; Decode w t
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">From</span></a></span><span>
</span><span id="line-822"></span><span>        </span><span class="annot"><span class="annottext">Decode
  ('Closed 'Dense)
  (BlocksMade (Crypto era)
   -&gt; BlocksMade (Crypto era)
   -&gt; EpochState era
   -&gt; StrictMaybe (PulsingRewUpdate (Crypto era))
   -&gt; PoolDistr (Crypto era)
   -&gt; StashedAVVMAddresses era
   -&gt; NewEpochState era)
-&gt; Decode ('Closed Any) (BlocksMade (Crypto era))
-&gt; Decode
     ('Closed 'Dense)
     (BlocksMade (Crypto era)
      -&gt; EpochState era
      -&gt; StrictMaybe (PulsingRewUpdate (Crypto era))
      -&gt; PoolDistr (Crypto era)
      -&gt; StashedAVVMAddresses era
      -&gt; NewEpochState era)
forall (w1 :: Wrapped) a t (w :: Density).
Decode w1 (a -&gt; t) -&gt; Decode ('Closed w) a -&gt; Decode w1 t
</span><a href="../../../../cardano-data/html/src"><span class="hs-operator hs-var">&lt;!</span></a></span><span> </span><span class="annot"><span class="annottext">Decode ('Closed Any) (BlocksMade (Crypto era))
forall t (w :: Wrapped). FromCBOR t =&gt; Decode w t
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">From</span></a></span><span>
</span><span id="line-823"></span><span>        </span><span class="annot"><span class="annottext">Decode
  ('Closed 'Dense)
  (BlocksMade (Crypto era)
   -&gt; EpochState era
   -&gt; StrictMaybe (PulsingRewUpdate (Crypto era))
   -&gt; PoolDistr (Crypto era)
   -&gt; StashedAVVMAddresses era
   -&gt; NewEpochState era)
-&gt; Decode ('Closed Any) (BlocksMade (Crypto era))
-&gt; Decode
     ('Closed 'Dense)
     (EpochState era
      -&gt; StrictMaybe (PulsingRewUpdate (Crypto era))
      -&gt; PoolDistr (Crypto era)
      -&gt; StashedAVVMAddresses era
      -&gt; NewEpochState era)
forall (w1 :: Wrapped) a t (w :: Density).
Decode w1 (a -&gt; t) -&gt; Decode ('Closed w) a -&gt; Decode w1 t
</span><a href="../../../../cardano-data/html/src"><span class="hs-operator hs-var">&lt;!</span></a></span><span> </span><span class="annot"><span class="annottext">Decode ('Closed Any) (BlocksMade (Crypto era))
forall t (w :: Wrapped). FromCBOR t =&gt; Decode w t
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">From</span></a></span><span>
</span><span id="line-824"></span><span>        </span><span class="annot"><span class="annottext">Decode
  ('Closed 'Dense)
  (EpochState era
   -&gt; StrictMaybe (PulsingRewUpdate (Crypto era))
   -&gt; PoolDistr (Crypto era)
   -&gt; StashedAVVMAddresses era
   -&gt; NewEpochState era)
-&gt; Decode ('Closed Any) (EpochState era)
-&gt; Decode
     ('Closed 'Dense)
     (StrictMaybe (PulsingRewUpdate (Crypto era))
      -&gt; PoolDistr (Crypto era)
      -&gt; StashedAVVMAddresses era
      -&gt; NewEpochState era)
forall (w1 :: Wrapped) a t (w :: Density).
Decode w1 (a -&gt; t) -&gt; Decode ('Closed w) a -&gt; Decode w1 t
</span><a href="../../../../cardano-data/html/src"><span class="hs-operator hs-var">&lt;!</span></a></span><span> </span><span class="annot"><span class="annottext">Decode ('Closed Any) (EpochState era)
forall t (w :: Wrapped). FromCBOR t =&gt; Decode w t
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">From</span></a></span><span>
</span><span id="line-825"></span><span>        </span><span class="annot"><span class="annottext">Decode
  ('Closed 'Dense)
  (StrictMaybe (PulsingRewUpdate (Crypto era))
   -&gt; PoolDistr (Crypto era)
   -&gt; StashedAVVMAddresses era
   -&gt; NewEpochState era)
-&gt; Decode
     ('Closed Any) (StrictMaybe (PulsingRewUpdate (Crypto era)))
-&gt; Decode
     ('Closed 'Dense)
     (PoolDistr (Crypto era)
      -&gt; StashedAVVMAddresses era -&gt; NewEpochState era)
forall (w1 :: Wrapped) a t (w :: Density).
Decode w1 (a -&gt; t) -&gt; Decode ('Closed w) a -&gt; Decode w1 t
</span><a href="../../../../cardano-data/html/src"><span class="hs-operator hs-var">&lt;!</span></a></span><span> </span><span class="annot"><span class="annottext">Decode ('Closed Any) (StrictMaybe (PulsingRewUpdate (Crypto era)))
forall t (w :: Wrapped). FromCBOR t =&gt; Decode w t
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">From</span></a></span><span>
</span><span id="line-826"></span><span>        </span><span class="annot"><span class="annottext">Decode
  ('Closed 'Dense)
  (PoolDistr (Crypto era)
   -&gt; StashedAVVMAddresses era -&gt; NewEpochState era)
-&gt; Decode ('Closed Any) (PoolDistr (Crypto era))
-&gt; Decode
     ('Closed 'Dense) (StashedAVVMAddresses era -&gt; NewEpochState era)
forall (w1 :: Wrapped) a t (w :: Density).
Decode w1 (a -&gt; t) -&gt; Decode ('Closed w) a -&gt; Decode w1 t
</span><a href="../../../../cardano-data/html/src"><span class="hs-operator hs-var">&lt;!</span></a></span><span> </span><span class="annot"><span class="annottext">Decode ('Closed Any) (PoolDistr (Crypto era))
forall t (w :: Wrapped). FromCBOR t =&gt; Decode w t
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">From</span></a></span><span>
</span><span id="line-827"></span><span>        </span><span class="annot"><span class="annottext">Decode
  ('Closed 'Dense) (StashedAVVMAddresses era -&gt; NewEpochState era)
-&gt; Decode ('Closed Any) (StashedAVVMAddresses era)
-&gt; Decode ('Closed 'Dense) (NewEpochState era)
forall (w1 :: Wrapped) a t (w :: Density).
Decode w1 (a -&gt; t) -&gt; Decode ('Closed w) a -&gt; Decode w1 t
</span><a href="../../../../cardano-data/html/src"><span class="hs-operator hs-var">&lt;!</span></a></span><span> </span><span class="annot"><span class="annottext">Decode ('Closed Any) (StashedAVVMAddresses era)
forall t (w :: Wrapped). FromCBOR t =&gt; Decode w t
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">From</span></a></span></span><span>
</span><span id="line-828"></span><span>
</span><span id="line-829"></span><span id="local-6989586621679473602"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#getGKeys"><span class="hs-identifier hs-type">getGKeys</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-830"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473602"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-831"></span><span>  </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Genesis</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473602"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-832"></span><span id="getGKeys"><span class="annot"><span class="annottext">getGKeys :: NewEpochState era -&gt; Set (KeyHash 'Genesis (Crypto era))
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#getGKeys"><span class="hs-identifier hs-var hs-var">getGKeys</span></a></span></span><span> </span><span id="local-6989586621679473601"><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621679473601"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era))
-&gt; Set (KeyHash 'Genesis (Crypto era))
forall k a. Map k a -&gt; Set k
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.keysSet</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era))
</span><a href="#local-6989586621679473599"><span class="hs-identifier hs-var">genDelegs</span></a></span><span>
</span><span id="line-833"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-834"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BlocksMade (Crypto era)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BlocksMade (Crypto era)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679473598"><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473598"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="annot"><span class="annottext">StrictMaybe (PulsingRewUpdate (Crypto era))
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PoolDistr (Crypto era)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StashedAVVMAddresses era
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621679473601"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-835"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SnapShots (Crypto era)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679473597"><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473597"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">NonMyopic (Crypto era)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473598"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-836"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">UTxOState era
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier hs-type">DPState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><span class="annottext">UnifiedMap (Crypto era)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Map (FutureGenDeleg (Crypto era)) (GenDelegPair (Crypto era))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">GenDelegs</span></a></span><span> </span><span id="local-6989586621679473599"><span class="annot"><span class="annottext">Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era))
</span><a href="#local-6989586621679473599"><span class="hs-identifier hs-var">genDelegs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InstantaneousRewards (Crypto era)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PState (Crypto era)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473597"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-837"></span><span>
</span><span id="line-838"></span><span class="hs-comment">-- | The state associated with a 'Ledger'.</span><span>
</span><span id="line-839"></span><span id="local-6989586621679473593"><span id="local-6989586621679473594"></span></span><span class="hs-keyword">data</span><span> </span><span id="LedgerState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-var">LedgerState</span></a></span></span><span> </span><span id="local-6989586621679474732"><span class="annot"><a href="#local-6989586621679474732"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LedgerState"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-var">LedgerState</span></a></span></span><span>
</span><span id="line-840"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | The current unspent transaction outputs.</span><span>
</span><span id="line-841"></span><span>    </span><span id="lsUTxOState"><span class="annot"><span class="annottext">LedgerState era -&gt; UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#lsUTxOState"><span class="hs-identifier hs-var hs-var">lsUTxOState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-type">UTxOState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474732"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-842"></span><span>    </span><span class="hs-comment">-- | The current delegation state</span><span>
</span><span id="line-843"></span><span>    </span><span id="lsDPState"><span class="annot"><span class="annottext">LedgerState era -&gt; DPState (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#lsDPState"><span class="hs-identifier hs-var hs-var">lsDPState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier hs-type">DPState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474732"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-844"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-845"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. LedgerState era -&gt; Rep (LedgerState era) x)
-&gt; (forall x. Rep (LedgerState era) x -&gt; LedgerState era)
-&gt; Generic (LedgerState era)
forall x. Rep (LedgerState era) x -&gt; LedgerState era
forall x. LedgerState era -&gt; Rep (LedgerState era) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall era x. Rep (LedgerState era) x -&gt; LedgerState era
forall era x. LedgerState era -&gt; Rep (LedgerState era) x
$cto :: forall era x. Rep (LedgerState era) x -&gt; LedgerState era
$cfrom :: forall era x. LedgerState era -&gt; Rep (LedgerState era) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-846"></span><span>
</span><span id="line-847"></span><span id="local-6989586621679473583"><span id="local-6989586621679473585"><span id="local-6989586621679473587"><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679473582"><span class="annot"><a href="#local-6989586621679473582"><span class="hs-keyword hs-type">stock</span></a></span></span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-848"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473582"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-849"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473582"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-850"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473582"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-851"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-852"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473582"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-853"></span><span>
</span><span id="line-854"></span><span id="local-6989586621679473578"><span id="local-6989586621679473580"><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679473577"><span class="annot"><a href="#local-6989586621679473577"><span class="hs-keyword hs-type">stock</span></a></span></span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-855"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473577"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-856"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473577"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-857"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473577"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-858"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-859"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473577"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-860"></span><span>
</span><span id="line-861"></span><span id="local-6989586621679473576"><span class="hs-keyword">instance</span><span>
</span><span id="line-862"></span><span>  </span><span id="local-6989586621679473570"><span id="local-6989586621679473572"><span id="local-6989586621679473574"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473576"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-863"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473576"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-864"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473576"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-865"></span><span>    </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.Value</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473576"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-866"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473576"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-867"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473576"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-868"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.Value</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473576"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-869"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-870"></span><span>  </span><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473576"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-871"></span><span>
</span><span id="line-872"></span><span id="local-6989586621679473569"><span class="hs-keyword">instance</span><span>
</span><span id="line-873"></span><span>  </span><span id="local-6989586621679473567"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473569"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-874"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473569"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-875"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473569"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-876"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-877"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.4.0/src"><span class="hs-identifier hs-type">NFData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473569"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-878"></span><span>
</span><span id="line-879"></span><span id="local-6989586621679473566"><span class="hs-keyword">instance</span><span>
</span><span id="line-880"></span><span>  </span><span id="local-6989586621679473560"><span id="local-6989586621679473562"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473566"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-881"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473566"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-882"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473566"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-883"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-884"></span><span>  </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">ToCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473566"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-885"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-886"></span><span>  </span><span id="local-6989586621679473559"><span class="annot"><span class="annottext">toCBOR :: LedgerState era -&gt; Encoding
</span><a href="#local-6989586621679473559"><span class="hs-identifier hs-var hs-var hs-var hs-var">toCBOR</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679473558"><span class="annot"><span class="annottext">UTxOState era
lsUTxOState :: UTxOState era
lsUTxOState :: forall era. LedgerState era -&gt; UTxOState era
</span><a href="#local-6989586621679473558"><span class="hs-identifier hs-var hs-var">lsUTxOState</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473557"><span class="annot"><span class="annottext">DPState (Crypto era)
lsDPState :: DPState (Crypto era)
lsDPState :: forall era. LedgerState era -&gt; DPState (Crypto era)
</span><a href="#local-6989586621679473557"><span class="hs-identifier hs-var hs-var">lsDPState</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-887"></span><span>    </span><span class="annot"><span class="annottext">Word -&gt; Encoding
</span><a href="../../../../cborg/html/src"><span class="hs-identifier hs-var">encodeListLen</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span>
</span><span id="line-888"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">DPState (Crypto era) -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">DPState (Crypto era)
</span><a href="#local-6989586621679473557"><span class="hs-identifier hs-var">lsDPState</span></a></span><span> </span><span class="hs-comment">-- encode delegation state first to improve sharing</span><span>
</span><span id="line-889"></span><span>      </span><span class="annot"><span class="annottext">Encoding -&gt; Encoding -&gt; Encoding
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UTxOState era -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-var">toCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">UTxOState era
</span><a href="#local-6989586621679473558"><span class="hs-identifier hs-var">lsUTxOState</span></a></span></span><span>
</span><span id="line-890"></span><span>
</span><span id="line-891"></span><span id="local-6989586621679473556"><span class="hs-keyword">instance</span><span>
</span><span id="line-892"></span><span>  </span><span id="local-6989586621679473551"><span id="local-6989586621679473553"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473556"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-893"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">HashAnnotated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473556"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">EraIndependentTxBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473556"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-894"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.Value</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473556"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-895"></span><span>    </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">FromSharedCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473556"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-896"></span><span>    </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Share</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxOut</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473556"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Interns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473556"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-897"></span><span>    </span><span class="annot"><a href="../../../../cardano-binary/html/src"><span class="hs-identifier hs-type">FromCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473556"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-898"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-899"></span><span>  </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">FromSharedCBOR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473556"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-900"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-901"></span><span>  </span><span class="hs-keyword">type</span><span>
</span><span id="line-902"></span><span>    </span><span id="Share"><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">Share</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473556"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-903"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Interns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473556"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Interns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">StakePool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473556"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-904"></span><span>  </span><span id="local-6989586621679473549"><span class="annot"><span class="annottext">fromSharedPlusCBOR :: StateT (Share (LedgerState era)) (Decoder s) (LedgerState era)
</span><a href="#local-6989586621679473549"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromSharedPlusCBOR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-905"></span><span>    </span><span class="annot"><span class="annottext">Text
-&gt; (LedgerState era -&gt; Int)
-&gt; StateT
     (Interns (Credential 'Staking (Crypto era)),
      Interns (KeyHash 'StakePool (Crypto era)))
     (Decoder s)
     (LedgerState era)
-&gt; StateT
     (Interns (Credential 'Staking (Crypto era)),
      Interns (KeyHash 'StakePool (Crypto era)))
     (Decoder s)
     (LedgerState era)
forall (m :: (* -&gt; *) -&gt; * -&gt; *) s a.
(MonadTrans m, Monad (m (Decoder s))) =&gt;
Text -&gt; (a -&gt; Int) -&gt; m (Decoder s) a -&gt; m (Decoder s) a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">decodeRecordNamedT</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;LedgerState&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; LedgerState era -&gt; Int
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT
   (Interns (Credential 'Staking (Crypto era)),
    Interns (KeyHash 'StakePool (Crypto era)))
   (Decoder s)
   (LedgerState era)
 -&gt; StateT
      (Interns (Credential 'Staking (Crypto era)),
       Interns (KeyHash 'StakePool (Crypto era)))
      (Decoder s)
      (LedgerState era))
-&gt; StateT
     (Interns (Credential 'Staking (Crypto era)),
      Interns (KeyHash 'StakePool (Crypto era)))
     (Decoder s)
     (LedgerState era)
-&gt; StateT
     (Interns (Credential 'Staking (Crypto era)),
      Interns (KeyHash 'StakePool (Crypto era)))
     (Decoder s)
     (LedgerState era)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-906"></span><span>      </span><span id="local-6989586621679473548"><span class="annot"><span class="annottext">DPState (Crypto era)
</span><a href="#local-6989586621679473548"><span class="hs-identifier hs-var">lsDPState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  (Interns (Credential 'Staking (Crypto era)),
   Interns (KeyHash 'StakePool (Crypto era)))
  (Decoder s)
  (DPState (Crypto era))
forall a s. FromSharedCBOR a =&gt; StateT (Share a) (Decoder s) a
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedPlusCBOR</span></a></span><span>
</span><span id="line-907"></span><span>      </span><span id="local-6989586621679473547"><span class="annot"><span class="annottext">UTxOState era
</span><a href="#local-6989586621679473547"><span class="hs-identifier hs-var">lsUTxOState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleGetter
  (Interns (Credential 'Staking (Crypto era)),
   Interns (KeyHash 'StakePool (Crypto era)))
  (Share (UTxOState era))
-&gt; StateT
     (Interns (Credential 'Staking (Crypto era)),
      Interns (KeyHash 'StakePool (Crypto era)))
     (Decoder s)
     (UTxOState era)
forall b bs s.
FromSharedCBOR b =&gt;
SimpleGetter bs (Share b) -&gt; StateT bs (Decoder s) b
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">fromSharedLensCBOR</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleGetter
  (Interns (Credential 'Staking (Crypto era)),
   Interns (KeyHash 'StakePool (Crypto era)))
  (Share (UTxOState era))
forall s t a b. Field1 s t a b =&gt; Lens s t a b
</span><a href="../../../../microlens/html/src"><span class="hs-identifier hs-var">_1</span></a></span><span>
</span><span id="line-908"></span><span>      </span><span class="annot"><span class="annottext">LedgerState era
-&gt; StateT
     (Interns (Credential 'Staking (Crypto era)),
      Interns (KeyHash 'StakePool (Crypto era)))
     (Decoder s)
     (LedgerState era)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState :: forall era.
UTxOState era -&gt; DPState (Crypto era) -&gt; LedgerState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">UTxOState era
lsUTxOState :: UTxOState era
lsUTxOState :: UTxOState era
</span><a href="#local-6989586621679473547"><span class="hs-identifier hs-var hs-var">lsUTxOState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DPState (Crypto era)
lsDPState :: DPState (Crypto era)
lsDPState :: DPState (Crypto era)
</span><a href="#local-6989586621679473548"><span class="hs-identifier hs-var hs-var">lsDPState</span></a></span><span class="hs-special">}</span></span><span>
</span><span id="line-909"></span><span>
</span><span id="line-910"></span><span class="hs-comment">-- | Creates the ledger state for an empty ledger which</span><span>
</span><span id="line-911"></span><span class="hs-comment">--  contains the specified transaction outputs.</span><span>
</span><span id="line-912"></span><span id="local-6989586621679473546"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#genesisState"><span class="hs-identifier hs-type">genesisState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-913"></span><span>  </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473546"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-914"></span><span>  </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Genesis</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473546"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">GenDelegPair</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473546"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-915"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473546"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-916"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473546"><span class="hs-identifier hs-type">era</span></a></span></span><span>
</span><span id="line-917"></span><span id="genesisState"><span class="annot"><span class="annottext">genesisState :: Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era))
-&gt; UTxO era -&gt; LedgerState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#genesisState"><span class="hs-identifier hs-var hs-var">genesisState</span></a></span></span><span> </span><span id="local-6989586621679473545"><span class="annot"><span class="annottext">Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era))
</span><a href="#local-6989586621679473545"><span class="hs-identifier hs-var">genDelegs0</span></a></span></span><span> </span><span id="local-6989586621679473544"><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679473544"><span class="hs-identifier hs-var">utxo0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-918"></span><span>  </span><span class="annot"><span class="annottext">UTxOState era -&gt; DPState (Crypto era) -&gt; LedgerState era
forall era.
UTxOState era -&gt; DPState (Crypto era) -&gt; LedgerState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-var">LedgerState</span></a></span><span>
</span><span id="line-919"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">UTxO era
-&gt; Coin
-&gt; Coin
-&gt; State (EraRule &quot;PPUP&quot; era)
-&gt; IncrementalStake (Crypto era)
-&gt; UTxOState era
forall era.
UTxO era
-&gt; Coin
-&gt; Coin
-&gt; State (EraRule &quot;PPUP&quot; era)
-&gt; IncrementalStake (Crypto era)
-&gt; UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-var">UTxOState</span></a></span><span>
</span><span id="line-920"></span><span>        </span><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679473544"><span class="hs-identifier hs-var">utxo0</span></a></span><span>
</span><span id="line-921"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-922"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-923"></span><span>        </span><span class="annot"><span class="annottext">State (EraRule &quot;PPUP&quot; era)
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span><span>
</span><span id="line-924"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake (Crypto era)
forall crypto.
Map (Credential 'Staking crypto) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-var">IStake</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) Coin
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-925"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-926"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DState (Crypto era) -&gt; PState (Crypto era) -&gt; DPState (Crypto era)
forall crypto. DState crypto -&gt; PState crypto -&gt; DPState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier hs-var">DPState</span></a></span><span> </span><span class="annot"><span class="annottext">DState (Crypto era)
</span><a href="#local-6989586621679473542"><span class="hs-identifier hs-var">dState</span></a></span><span> </span><span class="annot"><span class="annottext">PState (Crypto era)
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-927"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-928"></span><span>    </span><span id="local-6989586621679473542"><span class="annot"><span class="annottext">dState :: DState (Crypto era)
</span><a href="#local-6989586621679473542"><span class="hs-identifier hs-var hs-var">dState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DState (Crypto era)
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">_genDelegs :: GenDelegs (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_genDelegs"><span class="hs-identifier hs-var">_genDelegs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era))
-&gt; GenDelegs (Crypto era)
forall crypto.
Map (KeyHash 'Genesis crypto) (GenDelegPair crypto)
-&gt; GenDelegs crypto
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">GenDelegs</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era))
</span><a href="#local-6989586621679473545"><span class="hs-identifier hs-var">genDelegs0</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-929"></span><span>
</span><span id="line-930"></span><span class="hs-comment">-- | Convenience Function to bound the txsize function.</span><span>
</span><span id="line-931"></span><span class="hs-comment">-- | It can be helpful for coin selection.</span><span>
</span><span id="line-932"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#txsizeBound"><span class="hs-identifier hs-type">txsizeBound</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-933"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679473541"><span class="annot"><a href="#local-6989586621679473541"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span id="local-6989586621679473540"><span class="annot"><a href="#local-6989586621679473540"><span class="hs-identifier hs-type">out</span></a></span></span><span> </span><span id="local-6989586621679473539"><span class="annot"><a href="#local-6989586621679473539"><span class="hs-identifier hs-type">tx</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-934"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;outputs&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473541"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../strict-containers/html/src"><span class="hs-identifier hs-type">StrictSeq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473540"><span class="hs-identifier hs-type">out</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-935"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;inputs&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473541"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">TxIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473541"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-936"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;body&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473539"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473541"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-937"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;txsize&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473539"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-938"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-939"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473541"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-940"></span><span>  </span><span class="annot"><a href="#local-6989586621679473539"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-941"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-942"></span><span id="txsizeBound"><span class="annot"><span class="annottext">txsizeBound :: Proxy era -&gt; tx -&gt; Integer
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#txsizeBound"><span class="hs-identifier hs-var hs-var">txsizeBound</span></a></span></span><span> </span><span class="annot"><span class="annottext">Proxy era
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span id="local-6989586621679473537"><span class="annot"><span class="annottext">tx
</span><a href="#local-6989586621679473537"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473536"><span class="hs-identifier hs-var">numInputs</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473534"><span class="hs-identifier hs-var">inputSize</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473533"><span class="hs-identifier hs-var">numOutputs</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473532"><span class="hs-identifier hs-var">outputSize</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473531"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-943"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-944"></span><span>    </span><span id="local-6989586621679473530"><span class="annot"><span class="annottext">uint :: Integer
</span><a href="#local-6989586621679473530"><span class="hs-identifier hs-var hs-var">uint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">5</span></span><span>
</span><span id="line-945"></span><span>    </span><span id="local-6989586621679473529"><span class="annot"><span class="annottext">smallArray :: Integer
</span><a href="#local-6989586621679473529"><span class="hs-identifier hs-var hs-var">smallArray</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span>
</span><span id="line-946"></span><span>    </span><span id="local-6989586621679473528"><span class="annot"><span class="annottext">hashLen :: Integer
</span><a href="#local-6989586621679473528"><span class="hs-identifier hs-var hs-var">hashLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">32</span></span><span>
</span><span id="line-947"></span><span>    </span><span id="local-6989586621679473527"><span class="annot"><span class="annottext">hashObj :: Integer
</span><a href="#local-6989586621679473527"><span class="hs-identifier hs-var hs-var">hashObj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473528"><span class="hs-identifier hs-var">hashLen</span></a></span><span>
</span><span id="line-948"></span><span>    </span><span id="local-6989586621679473526"><span class="annot"><span class="annottext">addrHashLen :: Integer
</span><a href="#local-6989586621679473526"><span class="hs-identifier hs-var hs-var">addrHashLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">28</span></span><span>
</span><span id="line-949"></span><span>    </span><span id="local-6989586621679473525"><span class="annot"><span class="annottext">addrHeader :: Integer
</span><a href="#local-6989586621679473525"><span class="hs-identifier hs-var hs-var">addrHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span>
</span><span id="line-950"></span><span>    </span><span id="local-6989586621679473524"><span class="annot"><span class="annottext">address :: Integer
</span><a href="#local-6989586621679473524"><span class="hs-identifier hs-var hs-var">address</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473525"><span class="hs-identifier hs-var">addrHeader</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473526"><span class="hs-identifier hs-var">addrHashLen</span></a></span><span>
</span><span id="line-951"></span><span>    </span><span id="local-6989586621679473523"><span class="annot"><span class="annottext">txbody :: TxBody era
</span><a href="#local-6989586621679473523"><span class="hs-identifier hs-var hs-var">txbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">tx -&gt; TxBody era
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;body&quot;</span></span><span> </span><span class="annot"><span class="annottext">tx
</span><a href="#local-6989586621679473537"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-952"></span><span>    </span><span id="local-6989586621679473536"><span class="annot"><span class="annottext">numInputs :: Integer
</span><a href="#local-6989586621679473536"><span class="hs-identifier hs-var hs-var">numInputs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Integer
forall a. Integral a =&gt; a -&gt; Integer
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toInteger</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Integer) -&gt; (TxBody era -&gt; Int) -&gt; TxBody era -&gt; Integer
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Set (TxIn (Crypto era)) -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">(Set (TxIn (Crypto era)) -&gt; Int)
-&gt; (TxBody era -&gt; Set (TxIn (Crypto era))) -&gt; TxBody era -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
forall r a. HasField &quot;inputs&quot; r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;inputs&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TxBody era -&gt; Integer) -&gt; TxBody era -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679473523"><span class="hs-identifier hs-var">txbody</span></a></span><span>
</span><span id="line-953"></span><span>    </span><span id="local-6989586621679473534"><span class="annot"><span class="annottext">inputSize :: Integer
</span><a href="#local-6989586621679473534"><span class="hs-identifier hs-var hs-var">inputSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473529"><span class="hs-identifier hs-var">smallArray</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473530"><span class="hs-identifier hs-var">uint</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473527"><span class="hs-identifier hs-var">hashObj</span></a></span><span>
</span><span id="line-954"></span><span>    </span><span id="local-6989586621679473533"><span class="annot"><span class="annottext">numOutputs :: Integer
</span><a href="#local-6989586621679473533"><span class="hs-identifier hs-var hs-var">numOutputs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Integer
forall a. Integral a =&gt; a -&gt; Integer
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toInteger</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Integer) -&gt; (TxBody era -&gt; Int) -&gt; TxBody era -&gt; Integer
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq out -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">(StrictSeq out -&gt; Int)
-&gt; (TxBody era -&gt; StrictSeq out) -&gt; TxBody era -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
forall r a. HasField &quot;outputs&quot; r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;outputs&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TxBody era -&gt; Integer) -&gt; TxBody era -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679473523"><span class="hs-identifier hs-var">txbody</span></a></span><span>
</span><span id="line-955"></span><span>    </span><span id="local-6989586621679473532"><span class="annot"><span class="annottext">outputSize :: Integer
</span><a href="#local-6989586621679473532"><span class="hs-identifier hs-var hs-var">outputSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473529"><span class="hs-identifier hs-var">smallArray</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473530"><span class="hs-identifier hs-var">uint</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473524"><span class="hs-identifier hs-var">address</span></a></span><span>
</span><span id="line-956"></span><span>    </span><span id="local-6989586621679473531"><span class="annot"><span class="annottext">rest :: Integer
</span><a href="#local-6989586621679473531"><span class="hs-identifier hs-var hs-var">rest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">tx -&gt; Integer
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;txsize&quot;</span></span><span> </span><span class="annot"><span class="annottext">tx
</span><a href="#local-6989586621679473537"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-957"></span><span>
</span><span id="line-958"></span><span class="hs-comment">-- | Minimum fee calculation</span><span>
</span><span id="line-959"></span><span id="local-6989586621679473518"><span id="local-6989586621679473519"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#minfee"><span class="hs-identifier hs-type">minfee</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-960"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_minfeeA&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473519"><span class="hs-identifier hs-type">pp</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Natural</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-961"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_minfeeB&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473519"><span class="hs-identifier hs-type">pp</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Natural</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-962"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;txsize&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473518"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-963"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-964"></span><span>  </span><span class="annot"><a href="#local-6989586621679473519"><span class="hs-identifier hs-type">pp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-965"></span><span>  </span><span class="annot"><a href="#local-6989586621679473518"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-966"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span></span></span><span>
</span><span id="line-967"></span><span id="minfee"><span class="annot"><span class="annottext">minfee :: pp -&gt; tx -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#minfee"><span class="hs-identifier hs-var hs-var">minfee</span></a></span></span><span> </span><span id="local-6989586621679473517"><span class="annot"><span class="annottext">pp
</span><a href="#local-6989586621679473517"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span id="local-6989586621679473516"><span class="annot"><span class="annottext">tx
</span><a href="#local-6989586621679473516"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-968"></span><span>  </span><span class="annot"><span class="annottext">Integer -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Coin) -&gt; Integer -&gt; Coin
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-969"></span><span>    </span><span class="annot"><span class="annottext">Natural -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">pp -&gt; Natural
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;_minfeeA&quot;</span></span><span> </span><span class="annot"><span class="annottext">pp
</span><a href="#local-6989586621679473517"><span class="hs-identifier hs-var">pp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-970"></span><span>      </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">tx -&gt; Integer
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;txsize&quot;</span></span><span> </span><span class="annot"><span class="annottext">tx
</span><a href="#local-6989586621679473516"><span class="hs-identifier hs-var">tx</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">pp -&gt; Natural
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;_minfeeB&quot;</span></span><span> </span><span class="annot"><span class="annottext">pp
</span><a href="#local-6989586621679473517"><span class="hs-identifier hs-var">pp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-971"></span><span>
</span><span id="line-972"></span><span class="hs-comment">-- | Compute the lovelace which are created by the transaction</span><span>
</span><span id="line-973"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#produced"><span class="hs-identifier hs-type">produced</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-974"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679473515"><span class="annot"><a href="#local-6989586621679473515"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span id="local-6989586621679473514"><span class="annot"><a href="#local-6989586621679473514"><span class="hs-identifier hs-type">pp</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-975"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473515"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-976"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;certs&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473515"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../strict-containers/html/src"><span class="hs-identifier hs-type">StrictSeq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#DCert"><span class="hs-identifier hs-type">DCert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473515"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-977"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_keyDeposit&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473514"><span class="hs-identifier hs-type">pp</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-978"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_poolDeposit&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473514"><span class="hs-identifier hs-type">pp</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span>
</span><span id="line-979"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-980"></span><span>  </span><span class="annot"><a href="#local-6989586621679473514"><span class="hs-identifier hs-type">pp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-981"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">StakePool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473515"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-982"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473515"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-983"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.Value</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473515"><span class="hs-identifier hs-type">era</span></a></span><span>
</span><span id="line-984"></span><span id="produced"><span class="annot"><span class="annottext">produced :: pp
-&gt; (KeyHash 'StakePool (Crypto era) -&gt; Bool)
-&gt; TxBody era
-&gt; Value era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#produced"><span class="hs-identifier hs-var hs-var">produced</span></a></span></span><span> </span><span id="local-6989586621679473513"><span class="annot"><span class="annottext">pp
</span><a href="#local-6989586621679473513"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span id="local-6989586621679473512"><span class="annot"><span class="annottext">KeyHash 'StakePool (Crypto era) -&gt; Bool
</span><a href="#local-6989586621679473512"><span class="hs-identifier hs-var">isNewPool</span></a></span></span><span> </span><span id="local-6989586621679473511"><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679473511"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-985"></span><span>  </span><span class="annot"><span class="annottext">UTxO era -&gt; Value era
forall era. Era era =&gt; UTxO era -&gt; Value era
</span><a href="Cardano.Ledger.Shelley.UTxO.html#balance"><span class="hs-identifier hs-var">balance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxBody era -&gt; UTxO era
forall era. Era era =&gt; TxBody era -&gt; UTxO era
</span><a href="Cardano.Ledger.Shelley.UTxO.html#txouts"><span class="hs-identifier hs-var">txouts</span></a></span><span> </span><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679473511"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-986"></span><span>    </span><span class="annot"><span class="annottext">Value era -&gt; Value era -&gt; Value era
forall t. Val t =&gt; t -&gt; t -&gt; t
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Value era
forall t. Val t =&gt; Coin -&gt; t
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Val.inject</span></a></span><span>
</span><span id="line-987"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TxBody era -&gt; Coin
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;txfee&quot;</span></span><span> </span><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679473511"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-988"></span><span>          </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall t. Val t =&gt; t -&gt; t -&gt; t
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">pp
-&gt; (KeyHash 'StakePool (Crypto era) -&gt; Bool)
-&gt; [DCert (Crypto era)]
-&gt; Coin
forall pp crypto.
(HasField &quot;_poolDeposit&quot; pp Coin,
 HasField &quot;_keyDeposit&quot; pp Coin) =&gt;
pp -&gt; (KeyHash 'StakePool crypto -&gt; Bool) -&gt; [DCert crypto] -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.UTxO.html#totalDeposits"><span class="hs-identifier hs-var">totalDeposits</span></a></span><span> </span><span class="annot"><span class="annottext">pp
</span><a href="#local-6989586621679473513"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">KeyHash 'StakePool (Crypto era) -&gt; Bool
</span><a href="#local-6989586621679473512"><span class="hs-identifier hs-var">isNewPool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictSeq (DCert (Crypto era)) -&gt; [DCert (Crypto era)]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">(StrictSeq (DCert (Crypto era)) -&gt; [DCert (Crypto era)])
-&gt; StrictSeq (DCert (Crypto era)) -&gt; [DCert (Crypto era)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxBody era -&gt; StrictSeq (DCert (Crypto era))
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;certs&quot;</span></span><span> </span><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679473511"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-989"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-990"></span><span>
</span><span id="line-991"></span><span class="hs-comment">-- | Compute the key deregistration refunds in a transaction</span><span>
</span><span id="line-992"></span><span id="local-6989586621679474681"><span id="local-6989586621679474682"><span id="local-6989586621679474683"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#keyRefunds"><span class="hs-identifier hs-type">keyRefunds</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-993"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;certs&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679474683"><span class="hs-identifier hs-type">txb</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../strict-containers/html/src"><span class="hs-identifier hs-type">StrictSeq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#DCert"><span class="hs-identifier hs-type">DCert</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474682"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-994"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_keyDeposit&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679474681"><span class="hs-identifier hs-type">pp</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span>
</span><span id="line-995"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-996"></span><span>  </span><span class="annot"><a href="#local-6989586621679474681"><span class="hs-identifier hs-type">pp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-997"></span><span>  </span><span class="annot"><a href="#local-6989586621679474683"><span class="hs-identifier hs-type">txb</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-998"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span></span></span></span><span>
</span><span id="line-999"></span><span id="keyRefunds"><span class="annot"><span class="annottext">keyRefunds :: pp -&gt; txb -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#keyRefunds"><span class="hs-identifier hs-var hs-var">keyRefunds</span></a></span></span><span> </span><span id="local-6989586621679473509"><span class="annot"><span class="annottext">pp
</span><a href="#local-6989586621679473509"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span id="local-6989586621679473508"><span class="annot"><span class="annottext">txb
</span><a href="#local-6989586621679473508"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DCert crypto] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[DCert crypto]
</span><a href="#local-6989586621679473507"><span class="hs-identifier hs-var">deregistrations</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Coin -&gt; Coin
forall t i. (Val t, Integral i) =&gt; i -&gt; t -&gt; t
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">&lt;&#215;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">pp -&gt; Coin
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;_keyDeposit&quot;</span></span><span> </span><span class="annot"><span class="annottext">pp
</span><a href="#local-6989586621679473509"><span class="hs-identifier hs-var">pp</span></a></span><span>
</span><span id="line-1000"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1001"></span><span>    </span><span id="local-6989586621679473507"><span class="annot"><span class="annottext">deregistrations :: [DCert crypto]
</span><a href="#local-6989586621679473507"><span class="hs-identifier hs-var hs-var">deregistrations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DCert crypto -&gt; Bool) -&gt; [DCert crypto] -&gt; [DCert crypto]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">DCert crypto -&gt; Bool
forall crypto. DCert crypto -&gt; Bool
</span><a href="Cardano.Ledger.Shelley.Delegation.Certificates.html#isDeRegKey"><span class="hs-identifier hs-var">isDeRegKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictSeq (DCert crypto) -&gt; [DCert crypto]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">(StrictSeq (DCert crypto) -&gt; [DCert crypto])
-&gt; StrictSeq (DCert crypto) -&gt; [DCert crypto]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">txb -&gt; StrictSeq (DCert crypto)
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;certs&quot;</span></span><span> </span><span class="annot"><span class="annottext">txb
</span><a href="#local-6989586621679473508"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1002"></span><span>
</span><span id="line-1003"></span><span class="hs-comment">-- | Compute the lovelace which are destroyed by the transaction</span><span>
</span><span id="line-1004"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#consumed"><span class="hs-identifier hs-type">consumed</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1005"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679473506"><span class="annot"><a href="#local-6989586621679473506"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span id="local-6989586621679473505"><span class="annot"><a href="#local-6989586621679473505"><span class="hs-identifier hs-type">pp</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1006"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473506"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1007"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;certs&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473506"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../strict-containers/html/src"><span class="hs-identifier hs-type">StrictSeq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#DCert"><span class="hs-identifier hs-type">DCert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473506"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1008"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;inputs&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473506"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">TxIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473506"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1009"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;wdrls&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473506"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#Wdrl"><span class="hs-identifier hs-type">Wdrl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473506"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1010"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_keyDeposit&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473505"><span class="hs-identifier hs-type">pp</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span>
</span><span id="line-1011"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1012"></span><span>  </span><span class="annot"><a href="#local-6989586621679473505"><span class="hs-identifier hs-type">pp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1013"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473506"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1014"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473506"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1015"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.Value</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473506"><span class="hs-identifier hs-type">era</span></a></span><span>
</span><span id="line-1016"></span><span id="consumed"><span class="annot"><span class="annottext">consumed :: pp -&gt; UTxO era -&gt; TxBody era -&gt; Value era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#consumed"><span class="hs-identifier hs-var hs-var">consumed</span></a></span></span><span> </span><span id="local-6989586621679473504"><span class="annot"><span class="annottext">pp
</span><a href="#local-6989586621679473504"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span id="local-6989586621679473502"><span class="annot"><span class="annottext">Map (TxIn (Crypto era)) (TxOut era)
</span><a href="#local-6989586621679473502"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473501"><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679473501"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1017"></span><span>  </span><span class="hs-comment">{- balance (txins tx &#9665; u) + wbalance (txwdrls tx) + keyRefunds pp tx -}</span><span>
</span><span id="line-1018"></span><span>  </span><span class="annot"><span class="annottext">(Value era -&gt; TxIn (Crypto era) -&gt; Value era)
-&gt; Value era -&gt; Set (TxIn (Crypto era)) -&gt; Value era
forall a b. (a -&gt; b -&gt; a) -&gt; a -&gt; Set b -&gt; a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">Value era -&gt; TxIn (Crypto era) -&gt; Value era
</span><a href="#local-6989586621679473499"><span class="hs-identifier hs-var">lookupAddTxOut</span></a></span><span> </span><span class="annot"><span class="annottext">Value era
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxBody era -&gt; Set (TxIn (Crypto era))
forall era.
HasField &quot;inputs&quot; (TxBody era) (Set (TxIn (Crypto era))) =&gt;
TxBody era -&gt; Set (TxIn (Crypto era))
</span><a href="Cardano.Ledger.Shelley.UTxO.html#txins"><span class="hs-identifier hs-var">txins</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679473506"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679473501"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1019"></span><span>    </span><span class="annot"><span class="annottext">Value era -&gt; Value era -&gt; Value era
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Value era
forall t. Val t =&gt; Coin -&gt; t
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Val.inject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473498"><span class="hs-identifier hs-var">refunds</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall t. Val t =&gt; t -&gt; t -&gt; t
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473497"><span class="hs-identifier hs-var">withdrawals</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1020"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1021"></span><span>    </span><span id="local-6989586621679473499"><span class="annot"><span class="annottext">lookupAddTxOut :: Value era -&gt; TxIn (Crypto era) -&gt; Value era
</span><a href="#local-6989586621679473499"><span class="hs-identifier hs-var hs-var">lookupAddTxOut</span></a></span></span><span> </span><span id="local-6989586621679473496"><span class="annot"><span class="annottext">Value era
</span><a href="#local-6989586621679473496"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621679473495"><span class="annot"><span class="annottext">TxIn (Crypto era)
</span><a href="#local-6989586621679473495"><span class="hs-identifier hs-var">txin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value era
-&gt; (TxOut era -&gt; Value era) -&gt; Maybe (TxOut era) -&gt; Value era
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Value era
</span><a href="#local-6989586621679473496"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value era -&gt; TxOut era -&gt; Value era
forall t r. (Val t, HasField &quot;value&quot; r t) =&gt; t -&gt; r -&gt; t
</span><a href="#local-6989586621679473493"><span class="hs-identifier hs-var">addTxOut</span></a></span><span> </span><span class="annot"><span class="annottext">Value era
</span><a href="#local-6989586621679473496"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (TxOut era) -&gt; Value era) -&gt; Maybe (TxOut era) -&gt; Value era
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxIn (Crypto era)
-&gt; Map (TxIn (Crypto era)) (TxOut era) -&gt; Maybe (TxOut era)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">TxIn (Crypto era)
</span><a href="#local-6989586621679473495"><span class="hs-identifier hs-var">txin</span></a></span><span> </span><span class="annot"><span class="annottext">Map (TxIn (Crypto era)) (TxOut era)
</span><a href="#local-6989586621679473502"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-1022"></span><span>    </span><span id="local-6989586621679473493"><span class="annot"><span class="annottext">addTxOut :: t -&gt; r -&gt; t
</span><a href="#local-6989586621679473493"><span class="hs-identifier hs-var hs-var">addTxOut</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679473491"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679473491"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679473490"><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621679473490"><span class="hs-identifier hs-var">out</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">r -&gt; t
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621679473490"><span class="hs-identifier hs-var">out</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; t
forall t. Val t =&gt; t -&gt; t -&gt; t
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679473491"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1023"></span><span>    </span><span id="local-6989586621679473498"><span class="annot"><span class="annottext">refunds :: Coin
</span><a href="#local-6989586621679473498"><span class="hs-identifier hs-var hs-var">refunds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">pp -&gt; TxBody era -&gt; Coin
forall txb crypto pp.
(HasField &quot;certs&quot; txb (StrictSeq (DCert crypto)),
 HasField &quot;_keyDeposit&quot; pp Coin) =&gt;
pp -&gt; txb -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#keyRefunds"><span class="hs-identifier hs-var">keyRefunds</span></a></span><span> </span><span class="annot"><span class="annottext">pp
</span><a href="#local-6989586621679473504"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679473501"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-1024"></span><span>    </span><span id="local-6989586621679473497"><span class="annot"><span class="annottext">withdrawals :: Coin
</span><a href="#local-6989586621679473497"><span class="hs-identifier hs-var hs-var">withdrawals</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (RewardAcnt (Crypto era)) Coin -&gt; Coin
forall (t :: * -&gt; *) m. (Foldable t, Monoid m) =&gt; t m -&gt; m
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fold</span></a></span><span> </span><span class="annot"><span class="annottext">(Map (RewardAcnt (Crypto era)) Coin -&gt; Coin)
-&gt; (Wdrl (Crypto era) -&gt; Map (RewardAcnt (Crypto era)) Coin)
-&gt; Wdrl (Crypto era)
-&gt; Coin
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Wdrl (Crypto era) -&gt; Map (RewardAcnt (Crypto era)) Coin
forall crypto. Wdrl crypto -&gt; Map (RewardAcnt crypto) Coin
</span><a href="Cardano.Ledger.Shelley.TxBody.html#unWdrl"><span class="hs-identifier hs-var hs-var">unWdrl</span></a></span><span> </span><span class="annot"><span class="annottext">(Wdrl (Crypto era) -&gt; Coin) -&gt; Wdrl (Crypto era) -&gt; Coin
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxBody era -&gt; Wdrl (Crypto era)
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;wdrls&quot;</span></span><span> </span><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679473501"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-1025"></span><span>
</span><span id="line-1026"></span><span class="hs-comment">-- ====================================================</span><span>
</span><span id="line-1027"></span><span>
</span><span id="line-1028"></span><span id="local-6989586621679473487"><span id="local-6989586621679473488"></span></span><span class="hs-keyword">newtype</span><span> </span><span id="WitHashes"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier hs-var">WitHashes</span></a></span></span><span> </span><span id="local-6989586621679474665"><span class="annot"><a href="#local-6989586621679474665"><span class="hs-identifier hs-type">crypto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="WitHashes"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier hs-var">WitHashes</span></a></span></span><span>
</span><span id="line-1029"></span><span>  </span><span class="hs-special">{</span><span id="unWitHashes"><span class="annot"><span class="annottext">WitHashes crypto -&gt; Set (KeyHash 'Witness crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#unWitHashes"><span class="hs-identifier hs-var hs-var">unWitHashes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Witness</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474665"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><span id="line-1030"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679473481"><span id="local-6989586621679473483"><span class="annot"><span class="annottext">WitHashes crypto -&gt; WitHashes crypto -&gt; Bool
(WitHashes crypto -&gt; WitHashes crypto -&gt; Bool)
-&gt; (WitHashes crypto -&gt; WitHashes crypto -&gt; Bool)
-&gt; Eq (WitHashes crypto)
forall crypto. WitHashes crypto -&gt; WitHashes crypto -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: WitHashes crypto -&gt; WitHashes crypto -&gt; Bool
$c/= :: forall crypto. WitHashes crypto -&gt; WitHashes crypto -&gt; Bool
== :: WitHashes crypto -&gt; WitHashes crypto -&gt; Bool
$c== :: forall crypto. WitHashes crypto -&gt; WitHashes crypto -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. WitHashes crypto -&gt; Rep (WitHashes crypto) x)
-&gt; (forall x. Rep (WitHashes crypto) x -&gt; WitHashes crypto)
-&gt; Generic (WitHashes crypto)
forall x. Rep (WitHashes crypto) x -&gt; WitHashes crypto
forall x. WitHashes crypto -&gt; Rep (WitHashes crypto) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall crypto x. Rep (WitHashes crypto) x -&gt; WitHashes crypto
forall crypto x. WitHashes crypto -&gt; Rep (WitHashes crypto) x
$cto :: forall crypto x. Rep (WitHashes crypto) x -&gt; WitHashes crypto
$cfrom :: forall crypto x. WitHashes crypto -&gt; Rep (WitHashes crypto) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1031"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679473473"><span id="local-6989586621679473475"><span id="local-6989586621679473477"><span class="annot"><span class="annottext">Int -&gt; WitHashes crypto -&gt; ShowS
[WitHashes crypto] -&gt; ShowS
WitHashes crypto -&gt; String
(Int -&gt; WitHashes crypto -&gt; ShowS)
-&gt; (WitHashes crypto -&gt; String)
-&gt; ([WitHashes crypto] -&gt; ShowS)
-&gt; Show (WitHashes crypto)
forall crypto. Int -&gt; WitHashes crypto -&gt; ShowS
forall crypto. [WitHashes crypto] -&gt; ShowS
forall crypto. WitHashes crypto -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [WitHashes crypto] -&gt; ShowS
$cshowList :: forall crypto. [WitHashes crypto] -&gt; ShowS
show :: WitHashes crypto -&gt; String
$cshow :: forall crypto. WitHashes crypto -&gt; String
showsPrec :: Int -&gt; WitHashes crypto -&gt; ShowS
$cshowsPrec :: forall crypto. Int -&gt; WitHashes crypto -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><a href="../../../../quiet/html/src"><span class="hs-identifier hs-type">Quiet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier hs-type">WitHashes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474665"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1032"></span><span>
</span><span id="line-1033"></span><span id="local-6989586621679473471"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679473465"><span id="local-6989586621679473467"><span id="local-6989586621679473469"><span class="annot"><a href="../../../../nothunks/html/src"><span class="hs-identifier hs-type">NoThunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier hs-type">WitHashes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473471"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1034"></span><span>
</span><span id="line-1035"></span><span class="hs-comment">-- | Check if a set of witness hashes is empty.</span><span>
</span><span id="line-1036"></span><span id="local-6989586621679473464"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#nullWitHashes"><span class="hs-identifier hs-type">nullWitHashes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier hs-type">WitHashes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473464"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-1037"></span><span id="nullWitHashes"><span class="annot"><span class="annottext">nullWitHashes :: WitHashes crypto -&gt; Bool
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#nullWitHashes"><span class="hs-identifier hs-var hs-var">nullWitHashes</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier hs-type">WitHashes</span></a></span><span> </span><span id="local-6989586621679473463"><span class="annot"><span class="annottext">Set (KeyHash 'Witness crypto)
</span><a href="#local-6989586621679473463"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set (KeyHash 'Witness crypto) -&gt; Bool
forall a. Set a -&gt; Bool
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.null</span></a></span><span> </span><span class="annot"><span class="annottext">Set (KeyHash 'Witness crypto)
</span><a href="#local-6989586621679473463"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1038"></span><span>
</span><span id="line-1039"></span><span class="hs-comment">-- | Extract the difference between two sets of witness hashes.</span><span>
</span><span id="line-1040"></span><span id="local-6989586621679473461"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#diffWitHashes"><span class="hs-identifier hs-type">diffWitHashes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier hs-type">WitHashes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473461"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier hs-type">WitHashes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473461"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier hs-type">WitHashes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473461"><span class="hs-identifier hs-type">crypto</span></a></span></span><span>
</span><span id="line-1041"></span><span id="diffWitHashes"><span class="annot"><span class="annottext">diffWitHashes :: WitHashes crypto -&gt; WitHashes crypto -&gt; WitHashes crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#diffWitHashes"><span class="hs-identifier hs-var hs-var">diffWitHashes</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier hs-type">WitHashes</span></a></span><span> </span><span id="local-6989586621679473460"><span class="annot"><span class="annottext">Set (KeyHash 'Witness crypto)
</span><a href="#local-6989586621679473460"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier hs-type">WitHashes</span></a></span><span> </span><span id="local-6989586621679473459"><span class="annot"><span class="annottext">Set (KeyHash 'Witness crypto)
</span><a href="#local-6989586621679473459"><span class="hs-identifier hs-var">x'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1042"></span><span>  </span><span class="annot"><span class="annottext">Set (KeyHash 'Witness crypto) -&gt; WitHashes crypto
forall crypto. Set (KeyHash 'Witness crypto) -&gt; WitHashes crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier hs-var">WitHashes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set (KeyHash 'Witness crypto)
</span><a href="#local-6989586621679473460"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Set (KeyHash 'Witness crypto)
-&gt; Set (KeyHash 'Witness crypto) -&gt; Set (KeyHash 'Witness crypto)
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-operator hs-var">`Set.difference`</span></a></span><span> </span><span class="annot"><span class="annottext">Set (KeyHash 'Witness crypto)
</span><a href="#local-6989586621679473459"><span class="hs-identifier hs-var">x'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1043"></span><span>
</span><span id="line-1044"></span><span class="hs-comment">-- | Extract the witness hashes from the Transaction.</span><span>
</span><span id="line-1045"></span><span id="local-6989586621679473456"><span id="local-6989586621679473457"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#witsFromTxWitnesses"><span class="hs-identifier hs-type">witsFromTxWitnesses</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1046"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473457"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1047"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;addrWits&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473456"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#WitVKey"><span class="hs-identifier hs-type">WitVKey</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Witness</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473457"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1048"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;bootWits&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473456"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.Address.Bootstrap.html#BootstrapWitness"><span class="hs-identifier hs-type">BootstrapWitness</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473457"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1049"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1050"></span><span>  </span><span class="annot"><a href="#local-6989586621679473456"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1051"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier hs-type">WitHashes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473457"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1052"></span><span id="witsFromTxWitnesses"><span class="annot"><span class="annottext">witsFromTxWitnesses :: tx -&gt; WitHashes (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#witsFromTxWitnesses"><span class="hs-identifier hs-var hs-var">witsFromTxWitnesses</span></a></span></span><span> </span><span id="local-6989586621679473455"><span class="annot"><span class="annottext">tx
</span><a href="#local-6989586621679473455"><span class="hs-identifier hs-var">coreTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1053"></span><span>  </span><span class="annot"><span class="annottext">Set (KeyHash 'Witness (Crypto era)) -&gt; WitHashes (Crypto era)
forall crypto. Set (KeyHash 'Witness crypto) -&gt; WitHashes crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#WitHashes"><span class="hs-identifier hs-var">WitHashes</span></a></span><span> </span><span class="annot"><span class="annottext">(Set (KeyHash 'Witness (Crypto era)) -&gt; WitHashes (Crypto era))
-&gt; Set (KeyHash 'Witness (Crypto era)) -&gt; WitHashes (Crypto era)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1054"></span><span>    </span><span class="annot"><span class="annottext">(WitVKey 'Witness (Crypto era) -&gt; KeyHash 'Witness (Crypto era))
-&gt; Set (WitVKey 'Witness (Crypto era))
-&gt; Set (KeyHash 'Witness (Crypto era))
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.map</span></a></span><span> </span><span class="annot"><span class="annottext">WitVKey 'Witness (Crypto era) -&gt; KeyHash 'Witness (Crypto era)
forall (kr :: KeyRole) crypto.
WitVKey kr crypto -&gt; KeyHash 'Witness crypto
</span><a href="Cardano.Ledger.Shelley.TxBody.html#witKeyHash"><span class="hs-identifier hs-var">witKeyHash</span></a></span><span> </span><span class="annot"><span class="annottext">Set (WitVKey 'Witness (Crypto era))
</span><a href="#local-6989586621679473453"><span class="hs-identifier hs-var">addWits</span></a></span><span>
</span><span id="line-1055"></span><span>      </span><span class="annot"><span class="annottext">Set (KeyHash 'Witness (Crypto era))
-&gt; Set (KeyHash 'Witness (Crypto era))
-&gt; Set (KeyHash 'Witness (Crypto era))
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-operator hs-var">`Set.union`</span></a></span><span> </span><span class="annot"><span class="annottext">(BootstrapWitness (Crypto era) -&gt; KeyHash 'Witness (Crypto era))
-&gt; Set (BootstrapWitness (Crypto era))
-&gt; Set (KeyHash 'Witness (Crypto era))
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.map</span></a></span><span> </span><span class="annot"><span class="annottext">BootstrapWitness (Crypto era) -&gt; KeyHash 'Witness (Crypto era)
forall crypto.
Crypto crypto =&gt;
BootstrapWitness crypto -&gt; KeyHash 'Witness crypto
</span><a href="Cardano.Ledger.Shelley.Address.Bootstrap.html#bootstrapWitKeyHash"><span class="hs-identifier hs-var">bootstrapWitKeyHash</span></a></span><span> </span><span class="annot"><span class="annottext">Set (BootstrapWitness (Crypto era))
</span><a href="#local-6989586621679473451"><span class="hs-identifier hs-var">bsWits</span></a></span><span>
</span><span id="line-1056"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1057"></span><span>    </span><span id="local-6989586621679473451"><span class="annot"><span class="annottext">bsWits :: Set (BootstrapWitness (Crypto era))
</span><a href="#local-6989586621679473451"><span class="hs-identifier hs-var hs-var">bsWits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">tx -&gt; Set (BootstrapWitness (Crypto era))
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;bootWits&quot;</span></span><span> </span><span class="annot"><span class="annottext">tx
</span><a href="#local-6989586621679473455"><span class="hs-identifier hs-var">coreTx</span></a></span><span>
</span><span id="line-1058"></span><span>    </span><span id="local-6989586621679473453"><span class="annot"><span class="annottext">addWits :: Set (WitVKey 'Witness (Crypto era))
</span><a href="#local-6989586621679473453"><span class="hs-identifier hs-var hs-var">addWits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">tx -&gt; Set (WitVKey 'Witness (Crypto era))
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;addrWits&quot;</span></span><span> </span><span class="annot"><span class="annottext">tx
</span><a href="#local-6989586621679473455"><span class="hs-identifier hs-var">coreTx</span></a></span><span>
</span><span id="line-1059"></span><span>
</span><span id="line-1060"></span><span class="hs-comment">-- | Calculate the set of hash keys of the required witnesses for update</span><span>
</span><span id="line-1061"></span><span class="hs-comment">-- proposals.</span><span>
</span><span id="line-1062"></span><span id="local-6989586621679473450"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#propWits"><span class="hs-identifier hs-type">propWits</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1063"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.PParams.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473450"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1064"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">GenDelegs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473450"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1065"></span><span>  </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Witness</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473450"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1066"></span><span id="propWits"><span class="annot"><span class="annottext">propWits :: Maybe (Update era)
-&gt; GenDelegs (Crypto era) -&gt; Set (KeyHash 'Witness (Crypto era))
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#propWits"><span class="hs-identifier hs-var hs-var">propWits</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (Update era)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">GenDelegs (Crypto era)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set (KeyHash 'Witness (Crypto era))
forall a. Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.empty</span></a></span><span>
</span><span id="line-1067"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#propWits"><span class="hs-identifier hs-var">propWits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.PParams.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.PParams.html#ProposedPPUpdates"><span class="hs-identifier hs-type">ProposedPPUpdates</span></a></span><span> </span><span id="local-6989586621679473446"><span class="annot"><span class="annottext">Map (KeyHash 'Genesis (Crypto era)) (PParamsDelta era)
</span><a href="#local-6989586621679473446"><span class="hs-identifier hs-var">pup</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">GenDelegs</span></a></span><span> </span><span id="local-6989586621679473445"><span class="annot"><span class="annottext">Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era))
</span><a href="#local-6989586621679473445"><span class="hs-identifier hs-var">genDelegs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1068"></span><span>  </span><span class="annot"><span class="annottext">(KeyHash 'GenesisDelegate (Crypto era)
 -&gt; KeyHash 'Witness (Crypto era))
-&gt; Set (KeyHash 'GenesisDelegate (Crypto era))
-&gt; Set (KeyHash 'Witness (Crypto era))
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.map</span></a></span><span> </span><span class="annot"><span class="annottext">KeyHash 'GenesisDelegate (Crypto era)
-&gt; KeyHash 'Witness (Crypto era)
forall (a :: KeyRole -&gt; * -&gt; *) (r :: KeyRole) crypto.
HasKeyRole a =&gt;
a r crypto -&gt; a 'Witness crypto
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">asWitness</span></a></span><span> </span><span class="annot"><span class="annottext">(Set (KeyHash 'GenesisDelegate (Crypto era))
 -&gt; Set (KeyHash 'Witness (Crypto era)))
-&gt; ([KeyHash 'GenesisDelegate (Crypto era)]
    -&gt; Set (KeyHash 'GenesisDelegate (Crypto era)))
-&gt; [KeyHash 'GenesisDelegate (Crypto era)]
-&gt; Set (KeyHash 'Witness (Crypto era))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[KeyHash 'GenesisDelegate (Crypto era)]
-&gt; Set (KeyHash 'GenesisDelegate (Crypto era))
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([KeyHash 'GenesisDelegate (Crypto era)]
 -&gt; Set (KeyHash 'Witness (Crypto era)))
-&gt; [KeyHash 'GenesisDelegate (Crypto era)]
-&gt; Set (KeyHash 'Witness (Crypto era))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (KeyHash 'Genesis (Crypto era))
  (KeyHash 'GenesisDelegate (Crypto era))
-&gt; [KeyHash 'GenesisDelegate (Crypto era)]
forall k a. Map k a -&gt; [a]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.elems</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (KeyHash 'Genesis (Crypto era))
  (KeyHash 'GenesisDelegate (Crypto era))
</span><a href="#local-6989586621679473442"><span class="hs-identifier hs-var">updateKeys</span></a></span><span>
</span><span id="line-1069"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1070"></span><span>    </span><span id="local-6989586621679473441"><span class="annot"><span class="annottext">updateKeys' :: Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era))
</span><a href="#local-6989586621679473441"><span class="hs-identifier hs-var hs-var">updateKeys'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp
  (Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era)))
-&gt; Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era))
forall s t. Embed s t =&gt; Exp t -&gt; s
</span><a href="../../../../set-algebra/html/src"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (KeyHash 'Genesis (Crypto era)) (PParamsDelta era)
-&gt; Set (KeyHash 'Genesis (Crypto era))
forall k a. Map k a -&gt; Set k
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.keysSet</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'Genesis (Crypto era)) (PParamsDelta era)
</span><a href="#local-6989586621679473446"><span class="hs-identifier hs-var">pup</span></a></span><span> </span><span class="annot"><span class="annottext">Set (KeyHash 'Genesis (Crypto era))
-&gt; Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era))
-&gt; Exp
     (Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era)))
forall k s1 s2 (f :: * -&gt; * -&gt; *) v.
(Ord k, HasExp s1 (Sett k ()), HasExp s2 (f k v)) =&gt;
s1 -&gt; s2 -&gt; Exp (f k v)
</span><a href="../../../../set-algebra/html/src"><span class="hs-operator hs-var">&#9665;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era))
</span><a href="#local-6989586621679473445"><span class="hs-identifier hs-var">genDelegs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1071"></span><span>    </span><span id="local-6989586621679473442"><span class="annot"><span class="annottext">updateKeys :: Map
  (KeyHash 'Genesis (Crypto era))
  (KeyHash 'GenesisDelegate (Crypto era))
</span><a href="#local-6989586621679473442"><span class="hs-identifier hs-var hs-var">updateKeys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(GenDelegPair (Crypto era)
 -&gt; KeyHash 'GenesisDelegate (Crypto era))
-&gt; Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era))
-&gt; Map
     (KeyHash 'Genesis (Crypto era))
     (KeyHash 'GenesisDelegate (Crypto era))
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.map</span></a></span><span> </span><span class="annot"><span class="annottext">GenDelegPair (Crypto era) -&gt; KeyHash 'GenesisDelegate (Crypto era)
forall crypto.
GenDelegPair crypto -&gt; KeyHash 'GenesisDelegate crypto
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var hs-var">genDelegKeyHash</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'Genesis (Crypto era)) (GenDelegPair (Crypto era))
</span><a href="#local-6989586621679473441"><span class="hs-identifier hs-var">updateKeys'</span></a></span><span>
</span><span id="line-1072"></span><span>
</span><span id="line-1073"></span><span class="hs-comment">-- Functions for stake delegation model</span><span>
</span><span id="line-1074"></span><span>
</span><span id="line-1075"></span><span class="hs-comment">-- | Calculate the change to the deposit pool for a given transaction.</span><span>
</span><span id="line-1076"></span><span id="local-6989586621679473439"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#depositPoolChange"><span class="hs-identifier hs-type">depositPoolChange</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1077"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;certs&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473439"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../strict-containers/html/src"><span class="hs-identifier hs-type">StrictSeq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.TxBody.html#DCert"><span class="hs-identifier hs-type">DCert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473439"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1078"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1079"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473439"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1080"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.PParams.html#PParams"><span class="hs-identifier hs-type">PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473439"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1081"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.TxBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473439"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1082"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span></span><span>
</span><span id="line-1083"></span><span id="depositPoolChange"><span class="annot"><span class="annottext">depositPoolChange :: LedgerState era -&gt; PParams era -&gt; TxBody era -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#depositPoolChange"><span class="hs-identifier hs-var hs-var">depositPoolChange</span></a></span></span><span> </span><span id="local-6989586621679473438"><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473438"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span id="local-6989586621679473437"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473437"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span id="local-6989586621679473436"><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679473436"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473435"><span class="hs-identifier hs-var">currentPool</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall t. Val t =&gt; t -&gt; t -&gt; t
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473434"><span class="hs-identifier hs-var">txDeposits</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall t. Val t =&gt; t -&gt; t -&gt; t
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">&lt;-&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473433"><span class="hs-identifier hs-var">txRefunds</span></a></span><span>
</span><span id="line-1084"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1085"></span><span>    </span><span class="hs-comment">-- Note that while (currentPool + txDeposits) &gt;= txRefunds,</span><span>
</span><span id="line-1086"></span><span>    </span><span class="hs-comment">-- it could be that txDeposits &lt; txRefunds. We keep the parenthesis above</span><span>
</span><span id="line-1087"></span><span>    </span><span class="hs-comment">-- to emphasize this point.</span><span>
</span><span id="line-1088"></span><span>
</span><span id="line-1089"></span><span>    </span><span id="local-6989586621679473435"><span class="annot"><span class="annottext">currentPool :: Coin
</span><a href="#local-6989586621679473435"><span class="hs-identifier hs-var hs-var">currentPool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UTxOState era -&gt; Coin
forall era. UTxOState era -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_deposited"><span class="hs-identifier hs-var hs-var">_deposited</span></a></span><span> </span><span class="annot"><span class="annottext">(UTxOState era -&gt; Coin)
-&gt; (LedgerState era -&gt; UTxOState era) -&gt; LedgerState era -&gt; Coin
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era -&gt; UTxOState era
forall era. LedgerState era -&gt; UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#lsUTxOState"><span class="hs-identifier hs-var hs-var">lsUTxOState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473438"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-1090"></span><span>    </span><span id="local-6989586621679473432"><span class="annot"><span class="annottext">pools :: Map (KeyHash 'StakePool (Crypto era)) (PoolParams (Crypto era))
</span><a href="#local-6989586621679473432"><span class="hs-identifier hs-var hs-var">pools</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PState (Crypto era)
-&gt; Map (KeyHash 'StakePool (Crypto era)) (PoolParams (Crypto era))
forall crypto.
PState crypto
-&gt; Map (KeyHash 'StakePool crypto) (PoolParams crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_pParams"><span class="hs-identifier hs-var hs-var">_pParams</span></a></span><span> </span><span class="annot"><span class="annottext">(PState (Crypto era)
 -&gt; Map (KeyHash 'StakePool (Crypto era)) (PoolParams (Crypto era)))
-&gt; (LedgerState era -&gt; PState (Crypto era))
-&gt; LedgerState era
-&gt; Map (KeyHash 'StakePool (Crypto era)) (PoolParams (Crypto era))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DPState (Crypto era) -&gt; PState (Crypto era)
forall crypto. DPState crypto -&gt; PState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#dpsPState"><span class="hs-identifier hs-var hs-var">dpsPState</span></a></span><span> </span><span class="annot"><span class="annottext">(DPState (Crypto era) -&gt; PState (Crypto era))
-&gt; (LedgerState era -&gt; DPState (Crypto era))
-&gt; LedgerState era
-&gt; PState (Crypto era)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era -&gt; DPState (Crypto era)
forall era. LedgerState era -&gt; DPState (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#lsDPState"><span class="hs-identifier hs-var hs-var">lsDPState</span></a></span><span> </span><span class="annot"><span class="annottext">(LedgerState era
 -&gt; Map (KeyHash 'StakePool (Crypto era)) (PoolParams (Crypto era)))
-&gt; LedgerState era
-&gt; Map (KeyHash 'StakePool (Crypto era)) (PoolParams (Crypto era))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473438"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-1091"></span><span>    </span><span id="local-6989586621679473434"><span class="annot"><span class="annottext">txDeposits :: Coin
</span><a href="#local-6989586621679473434"><span class="hs-identifier hs-var hs-var">txDeposits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1092"></span><span>      </span><span class="annot"><span class="annottext">PParams era
-&gt; (KeyHash 'StakePool (Crypto era) -&gt; Bool)
-&gt; [DCert (Crypto era)]
-&gt; Coin
forall pp crypto.
(HasField &quot;_poolDeposit&quot; pp Coin,
 HasField &quot;_keyDeposit&quot; pp Coin) =&gt;
pp -&gt; (KeyHash 'StakePool crypto -&gt; Bool) -&gt; [DCert crypto] -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.UTxO.html#totalDeposits"><span class="hs-identifier hs-var">totalDeposits</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473437"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyHash 'StakePool (Crypto era)
-&gt; Map (KeyHash 'StakePool (Crypto era)) (PoolParams (Crypto era))
-&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="../../../../containers/html/src"><span class="hs-operator hs-var">`Map.notMember`</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool (Crypto era)) (PoolParams (Crypto era))
</span><a href="#local-6989586621679473432"><span class="hs-identifier hs-var">pools</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictSeq (DCert (Crypto era)) -&gt; [DCert (Crypto era)]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">(StrictSeq (DCert (Crypto era)) -&gt; [DCert (Crypto era)])
-&gt; StrictSeq (DCert (Crypto era)) -&gt; [DCert (Crypto era)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxBody era -&gt; StrictSeq (DCert (Crypto era))
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;certs&quot;</span></span><span> </span><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679473436"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1093"></span><span>    </span><span id="local-6989586621679473433"><span class="annot"><span class="annottext">txRefunds :: Coin
</span><a href="#local-6989586621679473433"><span class="hs-identifier hs-var hs-var">txRefunds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PParams era -&gt; TxBody era -&gt; Coin
forall txb crypto pp.
(HasField &quot;certs&quot; txb (StrictSeq (DCert crypto)),
 HasField &quot;_keyDeposit&quot; pp Coin) =&gt;
pp -&gt; txb -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#keyRefunds"><span class="hs-identifier hs-var">keyRefunds</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473437"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">TxBody era
</span><a href="#local-6989586621679473436"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-1094"></span><span>
</span><span id="line-1095"></span><span id="local-6989586621679473430"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#reapRewards"><span class="hs-identifier hs-type">reapRewards</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1096"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">UnifiedMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473430"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1097"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#RewardAccounts"><span class="hs-identifier hs-type">RewardAccounts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473430"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1098"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">UnifiedMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473430"><span class="hs-identifier hs-type">crypto</span></a></span></span><span>
</span><span id="line-1099"></span><span id="reapRewards"><span class="annot"><span class="annottext">reapRewards :: UnifiedMap crypto -&gt; RewardAccounts crypto -&gt; UnifiedMap crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#reapRewards"><span class="hs-identifier hs-var hs-var">reapRewards</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">UnifiedMap</span></a></span><span> </span><span id="local-6989586621679473429"><span class="annot"><span class="annottext">Map
  (Credential 'Staking crypto)
  (Trip Coin Ptr (KeyHash 'StakePool crypto))
</span><a href="#local-6989586621679473429"><span class="hs-identifier hs-var">tmap</span></a></span></span><span> </span><span id="local-6989586621679473428"><span class="annot"><span class="annottext">Map Ptr (Credential 'Staking crypto)
</span><a href="#local-6989586621679473428"><span class="hs-identifier hs-var">ptrmap</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473427"><span class="annot"><span class="annottext">RewardAccounts crypto
</span><a href="#local-6989586621679473427"><span class="hs-identifier hs-var">withdrawals</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking crypto)
  (Trip Coin Ptr (KeyHash 'StakePool crypto))
-&gt; Map Ptr (Credential 'Staking crypto) -&gt; UnifiedMap crypto
forall coin cred pool ptr.
Map cred (Trip coin ptr pool)
-&gt; Map ptr cred -&gt; UMap coin cred pool ptr
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">UnifiedMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Credential 'Staking crypto
 -&gt; Trip Coin Ptr (KeyHash 'StakePool crypto)
 -&gt; Trip Coin Ptr (KeyHash 'StakePool crypto))
-&gt; Map
     (Credential 'Staking crypto)
     (Trip Coin Ptr (KeyHash 'StakePool crypto))
-&gt; Map
     (Credential 'Staking crypto)
     (Trip Coin Ptr (KeyHash 'StakePool crypto))
forall k a b. (k -&gt; a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.mapWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking crypto
-&gt; Trip Coin Ptr (KeyHash 'StakePool crypto)
-&gt; Trip Coin Ptr (KeyHash 'StakePool crypto)
</span><a href="#local-6989586621679473425"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking crypto)
  (Trip Coin Ptr (KeyHash 'StakePool crypto))
</span><a href="#local-6989586621679473429"><span class="hs-identifier hs-var">tmap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Ptr (Credential 'Staking crypto)
</span><a href="#local-6989586621679473428"><span class="hs-identifier hs-var">ptrmap</span></a></span><span>
</span><span id="line-1100"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1101"></span><span>    </span><span id="local-6989586621679473425"><span class="annot"><span class="annottext">g :: Credential 'Staking crypto
-&gt; Trip Coin Ptr (KeyHash 'StakePool crypto)
-&gt; Trip Coin Ptr (KeyHash 'StakePool crypto)
</span><a href="#local-6989586621679473425"><span class="hs-identifier hs-var hs-var">g</span></a></span></span><span> </span><span id="local-6989586621679473424"><span class="annot"><span class="annottext">Credential 'Staking crypto
</span><a href="#local-6989586621679473424"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">Triple</span></a></span><span> </span><span id="local-6989586621679473422"><span class="annot"><span class="annottext">StrictMaybe Coin
</span><a href="#local-6989586621679473422"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679473421"><span class="annot"><span class="annottext">Set Ptr
</span><a href="#local-6989586621679473421"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621679473420"><span class="annot"><span class="annottext">StrictMaybe (KeyHash 'StakePool crypto)
</span><a href="#local-6989586621679473420"><span class="hs-identifier hs-var">z</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictMaybe Coin
-&gt; Set Ptr
-&gt; StrictMaybe (KeyHash 'StakePool crypto)
-&gt; Trip Coin Ptr (KeyHash 'StakePool crypto)
forall coin ptr pool.
StrictMaybe coin
-&gt; Set ptr -&gt; StrictMaybe pool -&gt; Trip coin ptr pool
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">Triple</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Coin -&gt; Coin) -&gt; StrictMaybe Coin -&gt; StrictMaybe Coin
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Credential 'Staking crypto -&gt; Coin -&gt; Coin
</span><a href="#local-6989586621679473419"><span class="hs-identifier hs-var">removeRewards</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking crypto
</span><a href="#local-6989586621679473424"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StrictMaybe Coin
</span><a href="#local-6989586621679473422"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set Ptr
</span><a href="#local-6989586621679473421"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">StrictMaybe (KeyHash 'StakePool crypto)
</span><a href="#local-6989586621679473420"><span class="hs-identifier hs-var">z</span></a></span><span>
</span><span id="line-1102"></span><span>    </span><span id="local-6989586621679473419"><span class="annot"><span class="annottext">removeRewards :: Credential 'Staking crypto -&gt; Coin -&gt; Coin
</span><a href="#local-6989586621679473419"><span class="hs-identifier hs-var hs-var">removeRewards</span></a></span></span><span> </span><span id="local-6989586621679473418"><span class="annot"><span class="annottext">Credential 'Staking crypto
</span><a href="#local-6989586621679473418"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679473417"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473417"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Credential 'Staking crypto
</span><a href="#local-6989586621679473418"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking crypto -&gt; RewardAccounts crypto -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="../../../../containers/html/src"><span class="hs-operator hs-var">`Map.member`</span></a></span><span> </span><span class="annot"><span class="annottext">RewardAccounts crypto
</span><a href="#local-6989586621679473427"><span class="hs-identifier hs-var">withdrawals</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473417"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1103"></span><span>
</span><span id="line-1104"></span><span class="hs-comment">---------------------------------</span><span>
</span><span id="line-1105"></span><span class="hs-comment">-- epoch boundary calculations --</span><span>
</span><span id="line-1106"></span><span class="hs-comment">---------------------------------</span><span>
</span><span id="line-1107"></span><span>
</span><span id="line-1108"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#compactCoinOrError"><span class="hs-identifier hs-type">compactCoinOrError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CompactForm</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span>
</span><span id="line-1109"></span><span id="compactCoinOrError"><span class="annot"><span class="annottext">compactCoinOrError :: Coin -&gt; CompactForm Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#compactCoinOrError"><span class="hs-identifier hs-var hs-var">compactCoinOrError</span></a></span></span><span> </span><span id="local-6989586621679473414"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473414"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1110"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Maybe (CompactForm Coin)
forall a. Compactible a =&gt; a -&gt; Maybe (CompactForm a)
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">toCompact</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473414"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1111"></span><span>    </span><span class="annot"><span class="annottext">Maybe (CompactForm Coin)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; CompactForm Coin
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; CompactForm Coin) -&gt; String -&gt; CompactForm Coin
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Invalid ADA value in staking: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473414"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-1112"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679473410"><span class="annot"><span class="annottext">CompactForm Coin
</span><a href="#local-6989586621679473410"><span class="hs-identifier hs-var">compactCoin</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CompactForm Coin
</span><a href="#local-6989586621679473410"><span class="hs-identifier hs-var">compactCoin</span></a></span><span>
</span><span id="line-1113"></span><span>
</span><span id="line-1114"></span><span class="hs-comment">-- ==============================</span><span>
</span><span id="line-1115"></span><span class="hs-comment">-- operations on IncrementalStake</span><span>
</span><span id="line-1116"></span><span>
</span><span id="line-1117"></span><span class="hs-comment">-- | Incrementally add the inserts 'utxoAdd' and the deletes 'utxoDel' to the IncrementalStake.</span><span>
</span><span id="line-1118"></span><span id="local-6989586621679474542"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#updateStakeDistribution"><span class="hs-identifier hs-type">updateStakeDistribution</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1119"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474542"><span class="hs-identifier hs-type">era</span></a></span><span>
</span><span id="line-1120"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1121"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474542"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1122"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474542"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1123"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474542"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1124"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474542"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1125"></span><span id="updateStakeDistribution"><span class="annot"><span class="annottext">updateStakeDistribution :: IncrementalStake (Crypto era)
-&gt; UTxO era -&gt; UTxO era -&gt; IncrementalStake (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#updateStakeDistribution"><span class="hs-identifier hs-var hs-var">updateStakeDistribution</span></a></span></span><span> </span><span id="local-6989586621679473409"><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473409"><span class="hs-identifier hs-var">incStake0</span></a></span></span><span> </span><span id="local-6989586621679473408"><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679473408"><span class="hs-identifier hs-var">utxoDel</span></a></span></span><span> </span><span id="local-6989586621679473407"><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679473407"><span class="hs-identifier hs-var">utxoAdd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473406"><span class="hs-identifier hs-var">incStake2</span></a></span><span>
</span><span id="line-1126"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1127"></span><span>    </span><span id="local-6989586621679473405"><span class="annot"><span class="annottext">incStake1 :: IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473405"><span class="hs-identifier hs-var hs-var">incStake1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coin -&gt; Coin)
-&gt; UTxO era
-&gt; IncrementalStake (Crypto era)
-&gt; IncrementalStake (Crypto era)
forall era.
Era era =&gt;
(Coin -&gt; Coin)
-&gt; UTxO era
-&gt; IncrementalStake (Crypto era)
-&gt; IncrementalStake (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#incrementalAggregateUtxoCoinByCredential"><span class="hs-identifier hs-var">incrementalAggregateUtxoCoinByCredential</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin
forall a. a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679473407"><span class="hs-identifier hs-var">utxoAdd</span></a></span><span> </span><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473409"><span class="hs-identifier hs-var">incStake0</span></a></span><span>
</span><span id="line-1128"></span><span>    </span><span id="local-6989586621679473406"><span class="annot"><span class="annottext">incStake2 :: IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473406"><span class="hs-identifier hs-var hs-var">incStake2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Coin -&gt; Coin)
-&gt; UTxO era
-&gt; IncrementalStake (Crypto era)
-&gt; IncrementalStake (Crypto era)
forall era.
Era era =&gt;
(Coin -&gt; Coin)
-&gt; UTxO era
-&gt; IncrementalStake (Crypto era)
-&gt; IncrementalStake (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#incrementalAggregateUtxoCoinByCredential"><span class="hs-identifier hs-var">incrementalAggregateUtxoCoinByCredential</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin
forall m. Group m =&gt; m -&gt; m
</span><a href="../../../../groups/html/src"><span class="hs-identifier hs-var">invert</span></a></span><span> </span><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679473408"><span class="hs-identifier hs-var">utxoDel</span></a></span><span> </span><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473405"><span class="hs-identifier hs-var">incStake1</span></a></span><span>
</span><span id="line-1129"></span><span>
</span><span id="line-1130"></span><span class="hs-comment">-- | Incrementally sum up all the Coin for each staking Credential, use different 'mode' operations</span><span>
</span><span id="line-1131"></span><span class="hs-comment">--   for UTxO that are inserts (id) and UTxO that are deletes (invert). Never store a (Coin 0) balance,</span><span>
</span><span id="line-1132"></span><span class="hs-comment">--   since these do not occur in the non-incremental style that works directly from the whole UTxO.</span><span>
</span><span id="line-1133"></span><span class="hs-comment">--   This function has a non-incremental analog 'aggregateUtxoCoinByCredential' . In this incremental</span><span>
</span><span id="line-1134"></span><span class="hs-comment">--   version we expect the size of the UTxO to be fairly small. I.e the number of inputs and outputs</span><span>
</span><span id="line-1135"></span><span class="hs-comment">--   in a transaction, which is aways &lt; 4096, not millions, and very often &lt; 10).</span><span>
</span><span id="line-1136"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#incrementalAggregateUtxoCoinByCredential"><span class="hs-identifier hs-type">incrementalAggregateUtxoCoinByCredential</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1137"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679474604"><span class="annot"><a href="#local-6989586621679474604"><span class="hs-identifier hs-type">era</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1138"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474604"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1139"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1140"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474604"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1141"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474604"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1142"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474604"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1143"></span><span id="incrementalAggregateUtxoCoinByCredential"><span class="annot"><span class="annottext">incrementalAggregateUtxoCoinByCredential :: (Coin -&gt; Coin)
-&gt; UTxO era
-&gt; IncrementalStake (Crypto era)
-&gt; IncrementalStake (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#incrementalAggregateUtxoCoinByCredential"><span class="hs-identifier hs-var hs-var">incrementalAggregateUtxoCoinByCredential</span></a></span></span><span> </span><span id="local-6989586621679473403"><span class="annot"><span class="annottext">Coin -&gt; Coin
</span><a href="#local-6989586621679473403"><span class="hs-identifier hs-var">mode</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span id="local-6989586621679473402"><span class="annot"><span class="annottext">Map (TxIn (Crypto era)) (TxOut era)
</span><a href="#local-6989586621679473402"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473401"><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473401"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1144"></span><span>  </span><span class="annot"><span class="annottext">(IncrementalStake (Crypto era)
 -&gt; TxOut era -&gt; IncrementalStake (Crypto era))
-&gt; IncrementalStake (Crypto era)
-&gt; Map (TxIn (Crypto era)) (TxOut era)
-&gt; IncrementalStake (Crypto era)
forall a b k. (a -&gt; b -&gt; a) -&gt; a -&gt; Map k b -&gt; a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
-&gt; TxOut era -&gt; IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473399"><span class="hs-identifier hs-var">accum</span></a></span><span> </span><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473401"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">Map (TxIn (Crypto era)) (TxOut era)
</span><a href="#local-6989586621679473402"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-1145"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1146"></span><span>    </span><span id="local-6989586621679473398"><span class="annot"><span class="annottext">keepOrDelete :: Coin -&gt; Maybe Coin -&gt; Maybe Coin
</span><a href="#local-6989586621679473398"><span class="hs-identifier hs-var hs-var">keepOrDelete</span></a></span></span><span> </span><span id="local-6989586621679473397"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473397"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Coin
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1147"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin
</span><a href="#local-6989586621679473403"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473397"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1148"></span><span>        </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Coin
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1149"></span><span>        </span><span id="local-6989586621679473396"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473396"><span class="hs-identifier hs-var">final</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Maybe Coin
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473396"><span class="hs-identifier hs-var">final</span></a></span><span>
</span><span id="line-1150"></span><span>    </span><span class="annot"><a href="#local-6989586621679473398"><span class="hs-identifier hs-var">keepOrDelete</span></a></span><span> </span><span id="local-6989586621679473395"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473395"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679473394"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473394"><span class="hs-identifier hs-var">old</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1151"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin
</span><a href="#local-6989586621679473403"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473395"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473394"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1152"></span><span>        </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Coin
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1153"></span><span>        </span><span id="local-6989586621679473393"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473393"><span class="hs-identifier hs-var">final</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Maybe Coin
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473393"><span class="hs-identifier hs-var">final</span></a></span><span>
</span><span id="line-1154"></span><span>    </span><span id="local-6989586621679473399"><span class="annot"><span class="annottext">accum :: IncrementalStake (Crypto era)
-&gt; TxOut era -&gt; IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473399"><span class="hs-identifier hs-var hs-var">accum</span></a></span></span><span> </span><span id="local-6989586621679473392"><span class="annot"><span class="annottext">ans :: IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473392"><span class="hs-identifier hs-var">ans</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-type">IStake</span></a></span><span> </span><span id="local-6989586621679473391"><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) Coin
</span><a href="#local-6989586621679473391"><span class="hs-identifier hs-var">stake</span></a></span></span><span> </span><span id="local-6989586621679473390"><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473390"><span class="hs-identifier hs-var">ptrs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473389"><span class="annot"><span class="annottext">TxOut era
</span><a href="#local-6989586621679473389"><span class="hs-identifier hs-var">out</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1155"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473388"><span class="annot"><span class="annottext">c :: Coin
</span><a href="#local-6989586621679473388"><span class="hs-identifier hs-var hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value era -&gt; Coin
forall t. Val t =&gt; t -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Val.coin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxOut era -&gt; Value era
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span> </span><span class="annot"><span class="annottext">TxOut era
</span><a href="#local-6989586621679473389"><span class="hs-identifier hs-var">out</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1156"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TxOut era -&gt; Addr (Crypto era)
forall e. Era e =&gt; TxOut e -&gt; Addr (Crypto e)
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">getTxOutAddr</span></a></span><span> </span><span class="annot"><span class="annottext">TxOut era
</span><a href="#local-6989586621679473389"><span class="hs-identifier hs-var">out</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1157"></span><span>            </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Addr</span></a></span><span> </span><span class="annot"><span class="annottext">Network
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PaymentCredential (Crypto era)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">StakeRefPtr</span></a></span><span> </span><span id="local-6989586621679473384"><span class="annot"><span class="annottext">Ptr
</span><a href="#local-6989586621679473384"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake (Crypto era)
forall crypto.
Map (Credential 'Staking crypto) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-var">IStake</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) Coin
</span><a href="#local-6989586621679473391"><span class="hs-identifier hs-var">stake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Maybe Coin -&gt; Maybe Coin) -&gt; Ptr -&gt; Map Ptr Coin -&gt; Map Ptr Coin
forall k a.
Ord k =&gt;
(Maybe a -&gt; Maybe a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.alter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin -&gt; Maybe Coin -&gt; Maybe Coin
</span><a href="#local-6989586621679473398"><span class="hs-identifier hs-var">keepOrDelete</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473388"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ptr
</span><a href="#local-6989586621679473384"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473390"><span class="hs-identifier hs-var">ptrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1158"></span><span>            </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Addr</span></a></span><span> </span><span class="annot"><span class="annottext">Network
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PaymentCredential (Crypto era)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">StakeRefBase</span></a></span><span> </span><span id="local-6989586621679473382"><span class="annot"><span class="annottext">Credential 'Staking (Crypto era)
</span><a href="#local-6989586621679473382"><span class="hs-identifier hs-var">hk</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake (Crypto era)
forall crypto.
Map (Credential 'Staking crypto) Coin
-&gt; Map Ptr Coin -&gt; IncrementalStake crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-var">IStake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Maybe Coin -&gt; Maybe Coin)
-&gt; Credential 'Staking (Crypto era)
-&gt; Map (Credential 'Staking (Crypto era)) Coin
-&gt; Map (Credential 'Staking (Crypto era)) Coin
forall k a.
Ord k =&gt;
(Maybe a -&gt; Maybe a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.alter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin -&gt; Maybe Coin -&gt; Maybe Coin
</span><a href="#local-6989586621679473398"><span class="hs-identifier hs-var">keepOrDelete</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473388"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Credential 'Staking (Crypto era)
</span><a href="#local-6989586621679473382"><span class="hs-identifier hs-var">hk</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) Coin
</span><a href="#local-6989586621679473391"><span class="hs-identifier hs-var">stake</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473390"><span class="hs-identifier hs-var">ptrs</span></a></span><span>
</span><span id="line-1159"></span><span>            </span><span id="local-6989586621679473381"><span class="annot"><span class="annottext">Addr (Crypto era)
</span><a href="#local-6989586621679473381"><span class="hs-identifier hs-var">_other</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
</span><a href="#local-6989586621679473392"><span class="hs-identifier hs-var">ans</span></a></span><span>
</span><span id="line-1160"></span><span>
</span><span id="line-1161"></span><span class="hs-comment">-- A TxOut has 4 different shapes, depending on the shape of its embedded Addr.</span><span>
</span><span id="line-1162"></span><span class="hs-comment">-- Credentials are stored in only 2 of the 4 cases.</span><span>
</span><span id="line-1163"></span><span class="hs-comment">-- 1) TxOut (Addr _ _ (StakeRefBase cred)) coin   -&gt; HERE</span><span>
</span><span id="line-1164"></span><span class="hs-comment">-- 2) TxOut (Addr _ _ (StakeRefPtr ptr)) coin     -&gt; HERE</span><span>
</span><span id="line-1165"></span><span class="hs-comment">-- 3) TxOut (Addr _ _ StakeRefNull) coin          -&gt; NOT HERE</span><span>
</span><span id="line-1166"></span><span class="hs-comment">-- 4) TxOut (AddrBootstrap _) coin                -&gt; NOT HERE</span><span>
</span><span id="line-1167"></span><span>
</span><span id="line-1168"></span><span class="hs-comment">-- ========================================================================</span><span>
</span><span id="line-1169"></span><span>
</span><span id="line-1170"></span><span class="hs-comment">-- | Compute the current state distribution by using the IncrementalStake,</span><span>
</span><span id="line-1171"></span><span>
</span><span id="line-1172"></span><span class="hs-comment">-- | This computes the stake distribution using IncrementalStake (which is an</span><span>
</span><span id="line-1173"></span><span class="hs-comment">--   aggregate of the current UTxO) and UnifiedMap (which tracks Coin,</span><span>
</span><span id="line-1174"></span><span class="hs-comment">--   Delegations, and Ptrs simultaneously).  Note that logically:</span><span>
</span><span id="line-1175"></span><span class="hs-comment">--   1) IncrementalStake = (credStake, ptrStake)</span><span>
</span><span id="line-1176"></span><span class="hs-comment">--   2) UnifiedMap = (rewards, activeDelegs, ptrmap :: Map ptr cred)</span><span>
</span><span id="line-1177"></span><span class="hs-comment">--</span><span>
</span><span id="line-1178"></span><span class="hs-comment">--   Using this scheme the logic can do 3 things in one go, without touching the UTxO.</span><span>
</span><span id="line-1179"></span><span class="hs-comment">--   1) Resolve Pointers</span><span>
</span><span id="line-1180"></span><span class="hs-comment">--   2) Throw away things not actively delegated</span><span>
</span><span id="line-1181"></span><span class="hs-comment">--   3) Add up the coin</span><span>
</span><span id="line-1182"></span><span class="hs-comment">--</span><span>
</span><span id="line-1183"></span><span class="hs-comment">--   The Stake distribution function (Map cred coin) (the first component of a SnapShot)</span><span>
</span><span id="line-1184"></span><span class="hs-comment">--   is defined by this SetAlgebra expression:</span><span>
</span><span id="line-1185"></span><span class="hs-comment">--   (dom activeDelegs) &#9665; (aggregate+ (credStake &#8746; ptrStake &#8746; rewards))</span><span>
</span><span id="line-1186"></span><span class="hs-comment">--</span><span>
</span><span id="line-1187"></span><span class="hs-comment">--   We can apply meaning preserving operations to get equivalent expressions</span><span>
</span><span id="line-1188"></span><span class="hs-comment">--</span><span>
</span><span id="line-1189"></span><span class="hs-comment">--   (dom activeDelegs) &#9665; (aggregate+ (credStake &#8746; ptrStake &#8746; rewards))</span><span>
</span><span id="line-1190"></span><span class="hs-comment">--   aggregate+ (dom activeDelegs &#9665; (credStake &#8746; ptrStake &#8746; rewards))</span><span>
</span><span id="line-1191"></span><span class="hs-comment">--   aggregate+ ((dom activeDelegs &#9665; credStake) &#8746; (dom activeDelegs &#9665; ptrStake) &#8746; (dom activeDelegs &#9665; rewards))</span><span>
</span><span id="line-1192"></span><span class="hs-comment">--</span><span>
</span><span id="line-1193"></span><span class="hs-comment">--   We will compute this in several steps</span><span>
</span><span id="line-1194"></span><span class="hs-comment">--   step1 = (dom activeDelegs &#9665; credStake) &#8746; (dom activeDelegs &#9665; ptrStake)</span><span>
</span><span id="line-1195"></span><span class="hs-comment">--   step2 =  aggregate (dom activeDelegs &#9665; rewards) step1</span><span>
</span><span id="line-1196"></span><span class="hs-comment">--   This function has a non-incremental analog, 'stakeDistr', mosty used in tests, which does use the UTxO.</span><span>
</span><span id="line-1197"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#incrementalStakeDistr"><span class="hs-identifier hs-type">incrementalStakeDistr</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1198"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679473380"><span class="annot"><a href="#local-6989586621679473380"><span class="hs-identifier hs-type">crypto</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1199"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473380"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1200"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473380"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1201"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier hs-type">PState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473380"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1202"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.EpochBoundary.html#SnapShot"><span class="hs-identifier hs-type">SnapShot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473380"><span class="hs-identifier hs-type">crypto</span></a></span><span>
</span><span id="line-1203"></span><span id="incrementalStakeDistr"><span class="annot"><span class="annottext">incrementalStakeDistr :: IncrementalStake crypto
-&gt; DState crypto -&gt; PState crypto -&gt; SnapShot crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#incrementalStakeDistr"><span class="hs-identifier hs-var hs-var">incrementalStakeDistr</span></a></span></span><span> </span><span id="local-6989586621679473379"><span class="annot"><span class="annottext">IncrementalStake crypto
</span><a href="#local-6989586621679473379"><span class="hs-identifier hs-var">incstake</span></a></span></span><span> </span><span id="local-6989586621679473378"><span class="annot"><span class="annottext">DState crypto
</span><a href="#local-6989586621679473378"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span id="local-6989586621679473377"><span class="annot"><span class="annottext">PState crypto
</span><a href="#local-6989586621679473377"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1204"></span><span>  </span><span class="annot"><span class="annottext">Stake crypto
-&gt; VMap
     VB VB (Credential 'Staking crypto) (KeyHash 'StakePool crypto)
-&gt; VMap VB VB (KeyHash 'StakePool crypto) (PoolParams crypto)
-&gt; SnapShot crypto
forall crypto.
Stake crypto
-&gt; VMap
     VB VB (Credential 'Staking crypto) (KeyHash 'StakePool crypto)
-&gt; VMap VB VB (KeyHash 'StakePool crypto) (PoolParams crypto)
-&gt; SnapShot crypto
</span><a href="Cardano.Ledger.Shelley.EpochBoundary.html#SnapShot"><span class="hs-identifier hs-var">SnapShot</span></a></span><span>
</span><span id="line-1205"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VMap VB VP (Credential 'Staking crypto) (CompactForm Coin)
-&gt; Stake crypto
forall crypto.
VMap VB VP (Credential 'Staking crypto) (CompactForm Coin)
-&gt; Stake crypto
</span><a href="Cardano.Ledger.Shelley.EpochBoundary.html#Stake"><span class="hs-identifier hs-var">Stake</span></a></span><span> </span><span class="annot"><span class="annottext">(VMap VB VP (Credential 'Staking crypto) (CompactForm Coin)
 -&gt; Stake crypto)
-&gt; VMap VB VP (Credential 'Staking crypto) (CompactForm Coin)
-&gt; Stake crypto
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) (CompactForm Coin)
-&gt; VMap VB VP (Credential 'Staking crypto) (CompactForm Coin)
forall (kv :: * -&gt; *) k (vv :: * -&gt; *) v.
(Vector kv k, Vector vv v) =&gt;
Map k v -&gt; VMap kv vv k v
</span><a href="../../../../vector-map/html/src"><span class="hs-identifier hs-var">VMap.fromMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin -&gt; CompactForm Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#compactCoinOrError"><span class="hs-identifier hs-var">compactCoinOrError</span></a></span><span> </span><span class="annot"><span class="annottext">(Coin -&gt; CompactForm Coin)
-&gt; Map (Credential 'Staking crypto) Coin
-&gt; Map (Credential 'Staking crypto) (CompactForm Coin)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473373"><span class="hs-identifier hs-var">step2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1206"></span><span>    </span><span class="annot"><span class="annottext">VMap VB VB (Credential 'Staking crypto) (KeyHash 'StakePool crypto)
</span><a href="#local-6989586621679473372"><span class="hs-identifier hs-var">delegs</span></a></span><span>
</span><span id="line-1207"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
-&gt; VMap VB VB (KeyHash 'StakePool crypto) (PoolParams crypto)
forall (kv :: * -&gt; *) k (vv :: * -&gt; *) v.
(Vector kv k, Vector vv v) =&gt;
Map k v -&gt; VMap kv vv k v
</span><a href="../../../../vector-map/html/src"><span class="hs-identifier hs-var">VMap.fromMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
</span><a href="#local-6989586621679473371"><span class="hs-identifier hs-var">poolParams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1208"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1209"></span><span>    </span><span class="annot"><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-type">UnifiedMap</span></a></span><span> </span><span id="local-6989586621679473370"><span class="annot"><span class="annottext">Map
  (Credential 'Staking crypto)
  (Trip Coin Ptr (KeyHash 'StakePool crypto))
</span><a href="#local-6989586621679473370"><span class="hs-identifier hs-var">tripmap</span></a></span></span><span> </span><span id="local-6989586621679473369"><span class="annot"><span class="annottext">Map Ptr (Credential 'Staking crypto)
</span><a href="#local-6989586621679473369"><span class="hs-identifier hs-var">ptrmap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DState crypto
-&gt; UMap
     Coin (Credential 'Staking crypto) (KeyHash 'StakePool crypto) Ptr
forall crypto. DState crypto -&gt; UnifiedMap crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_unified"><span class="hs-identifier hs-var hs-var">_unified</span></a></span><span> </span><span class="annot"><span class="annottext">DState crypto
</span><a href="#local-6989586621679473378"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-1210"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier hs-type">PState</span></a></span><span> </span><span id="local-6989586621679473371"><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
</span><a href="#local-6989586621679473371"><span class="hs-identifier hs-var">poolParams</span></a></span></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) EpochNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PState crypto
</span><a href="#local-6989586621679473377"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-1211"></span><span>    </span><span id="local-6989586621679473372"><span class="annot"><span class="annottext">delegs :: VMap VB VB (Credential 'Staking crypto) (KeyHash 'StakePool crypto)
</span><a href="#local-6989586621679473372"><span class="hs-identifier hs-var hs-var">delegs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">View
  Coin
  (Credential 'Staking crypto)
  (KeyHash 'StakePool crypto)
  Ptr
  (Credential 'Staking crypto)
  (KeyHash 'StakePool crypto)
-&gt; VMap
     VB VB (Credential 'Staking crypto) (KeyHash 'StakePool crypto)
forall cred coin pool ptr k v.
Ord cred =&gt;
View coin cred pool ptr k v -&gt; VMap VB VB k v
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">UM.viewToVMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DState crypto
-&gt; View
     Coin
     (Credential 'Staking crypto)
     (KeyHash 'StakePool crypto)
     Ptr
     (Credential 'Staking crypto)
     (KeyHash 'StakePool crypto)
forall crypto.
DState crypto
-&gt; ViewMap
     crypto (Credential 'Staking crypto) (KeyHash 'StakePool crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#delegations"><span class="hs-identifier hs-var">delegations</span></a></span><span> </span><span class="annot"><span class="annottext">DState crypto
</span><a href="#local-6989586621679473378"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1212"></span><span>    </span><span class="hs-comment">-- A credential is active, only if it is being delegated</span><span>
</span><span id="line-1213"></span><span>    </span><span id="local-6989586621679473367"><span class="annot"><span class="annottext">step1 :: Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473367"><span class="hs-identifier hs-var hs-var">step1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Credential 'Staking crypto -&gt; Bool)
-&gt; Map Ptr (Credential 'Staking crypto)
-&gt; IncrementalStake crypto
-&gt; Map (Credential 'Staking crypto) Coin
forall crypto.
(Credential 'Staking crypto -&gt; Bool)
-&gt; Map Ptr (Credential 'Staking crypto)
-&gt; IncrementalStake crypto
-&gt; Map (Credential 'Staking crypto) Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#resolveActiveIncrementalPtrs"><span class="hs-identifier hs-var">resolveActiveIncrementalPtrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Credential 'Staking crypto
-&gt; VMap
     VB VB (Credential 'Staking crypto) (KeyHash 'StakePool crypto)
-&gt; Bool
forall k (kv :: * -&gt; *) (vv :: * -&gt; *) v.
(Ord k, Vector kv k) =&gt;
k -&gt; VMap kv vv k v -&gt; Bool
</span><a href="../../../../vector-map/html/src"><span class="hs-operator hs-var">`VMap.member`</span></a></span><span> </span><span class="annot"><span class="annottext">VMap VB VB (Credential 'Staking crypto) (KeyHash 'StakePool crypto)
</span><a href="#local-6989586621679473372"><span class="hs-identifier hs-var">delegs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Ptr (Credential 'Staking crypto)
</span><a href="#local-6989586621679473369"><span class="hs-identifier hs-var">ptrmap</span></a></span><span> </span><span class="annot"><span class="annottext">IncrementalStake crypto
</span><a href="#local-6989586621679473379"><span class="hs-identifier hs-var">incstake</span></a></span><span>
</span><span id="line-1214"></span><span>    </span><span id="local-6989586621679473373"><span class="annot"><span class="annottext">step2 :: Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473373"><span class="hs-identifier hs-var hs-var">step2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking crypto)
  (Trip Coin Ptr (KeyHash 'StakePool crypto))
-&gt; Map (Credential 'Staking crypto) Coin
-&gt; Map (Credential 'Staking crypto) Coin
forall k crypto.
Ord k =&gt;
Map k (Triple crypto) -&gt; Map k Coin -&gt; Map k Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#aggregateActiveStake"><span class="hs-identifier hs-var">aggregateActiveStake</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (Credential 'Staking crypto)
  (Trip Coin Ptr (KeyHash 'StakePool crypto))
</span><a href="#local-6989586621679473370"><span class="hs-identifier hs-var">tripmap</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473367"><span class="hs-identifier hs-var">step1</span></a></span><span>
</span><span id="line-1215"></span><span>
</span><span id="line-1216"></span><span class="hs-comment">-- | Resolve inserts and deletes which were indexed by Ptrs, by looking them</span><span>
</span><span id="line-1217"></span><span class="hs-comment">--   up in 'ptrs' and combining the result of the lookup with the ordinary stake.</span><span>
</span><span id="line-1218"></span><span class="hs-comment">--   keep ony the active credentials.</span><span>
</span><span id="line-1219"></span><span class="hs-comment">--   This is  step1 = (dom activeDelegs &#9665; credStake) &#8746; (dom activeDelegs &#9665; ptrStake)</span><span>
</span><span id="line-1220"></span><span id="local-6989586621679474571"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#resolveActiveIncrementalPtrs"><span class="hs-identifier hs-type">resolveActiveIncrementalPtrs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1221"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474571"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1222"></span><span>  </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474571"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1223"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IncrementalStake"><span class="hs-identifier hs-type">IncrementalStake</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474571"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1224"></span><span>  </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474571"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span></span><span>
</span><span id="line-1225"></span><span id="resolveActiveIncrementalPtrs"><span class="annot"><span class="annottext">resolveActiveIncrementalPtrs :: (Credential 'Staking crypto -&gt; Bool)
-&gt; Map Ptr (Credential 'Staking crypto)
-&gt; IncrementalStake crypto
-&gt; Map (Credential 'Staking crypto) Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#resolveActiveIncrementalPtrs"><span class="hs-identifier hs-var hs-var">resolveActiveIncrementalPtrs</span></a></span></span><span> </span><span id="local-6989586621679473363"><span class="annot"><span class="annottext">Credential 'Staking crypto -&gt; Bool
</span><a href="#local-6989586621679473363"><span class="hs-identifier hs-var">isActive</span></a></span></span><span> </span><span id="local-6989586621679473362"><span class="annot"><span class="annottext">Map Ptr (Credential 'Staking crypto)
</span><a href="#local-6989586621679473362"><span class="hs-identifier hs-var">ptrMap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#IStake"><span class="hs-identifier hs-type">IStake</span></a></span><span> </span><span id="local-6989586621679473361"><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473361"><span class="hs-identifier hs-var">credStake</span></a></span></span><span> </span><span id="local-6989586621679473360"><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473360"><span class="hs-identifier hs-var">ptrStake</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1226"></span><span>  </span><span class="annot"><span class="annottext">(Map (Credential 'Staking crypto) Coin
 -&gt; Ptr -&gt; Coin -&gt; Map (Credential 'Staking crypto) Coin)
-&gt; Map (Credential 'Staking crypto) Coin
-&gt; Map Ptr Coin
-&gt; Map (Credential 'Staking crypto) Coin
forall a k b. (a -&gt; k -&gt; b -&gt; a) -&gt; a -&gt; Map k b -&gt; a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.foldlWithKey'</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
-&gt; Ptr -&gt; Coin -&gt; Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473358"><span class="hs-identifier hs-var">accum</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473357"><span class="hs-identifier hs-var">step1A</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr Coin
</span><a href="#local-6989586621679473360"><span class="hs-identifier hs-var">ptrStake</span></a></span><span> </span><span class="hs-comment">-- step1A  &#8746; (dom activeDelegs &#9665; ptrStake)</span><span>
</span><span id="line-1227"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1228"></span><span>    </span><span class="hs-comment">-- (dom activeDelegs &#9665; credStake)</span><span>
</span><span id="line-1229"></span><span>    </span><span id="local-6989586621679473357"><span class="annot"><span class="annottext">step1A :: Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473357"><span class="hs-identifier hs-var hs-var">step1A</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Credential 'Staking crypto -&gt; Coin -&gt; Bool)
-&gt; Map (Credential 'Staking crypto) Coin
-&gt; Map (Credential 'Staking crypto) Coin
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.filterWithKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679473355"><span class="annot"><span class="annottext">Credential 'Staking crypto
</span><a href="#local-6989586621679473355"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coin
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Credential 'Staking crypto -&gt; Bool
</span><a href="#local-6989586621679473363"><span class="hs-identifier hs-var">isActive</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking crypto
</span><a href="#local-6989586621679473355"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473361"><span class="hs-identifier hs-var">credStake</span></a></span><span>
</span><span id="line-1230"></span><span>    </span><span id="local-6989586621679473358"><span class="annot"><span class="annottext">accum :: Map (Credential 'Staking crypto) Coin
-&gt; Ptr -&gt; Coin -&gt; Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473358"><span class="hs-identifier hs-var hs-var">accum</span></a></span></span><span> </span><span id="local-6989586621679473354"><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473354"><span class="hs-identifier hs-var">ans</span></a></span></span><span> </span><span id="local-6989586621679473353"><span class="annot"><span class="annottext">Ptr
</span><a href="#local-6989586621679473353"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span id="local-6989586621679473352"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473352"><span class="hs-identifier hs-var">coin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1231"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ptr
-&gt; Map Ptr (Credential 'Staking crypto)
-&gt; Maybe (Credential 'Staking crypto)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr
</span><a href="#local-6989586621679473353"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Map Ptr (Credential 'Staking crypto)
</span><a href="#local-6989586621679473362"><span class="hs-identifier hs-var">ptrMap</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-comment">-- Map ptrs to Credentials</span><span>
</span><span id="line-1232"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Credential 'Staking crypto)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473354"><span class="hs-identifier hs-var">ans</span></a></span><span>
</span><span id="line-1233"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679473351"><span class="annot"><span class="annottext">Credential 'Staking crypto
</span><a href="#local-6989586621679473351"><span class="hs-identifier hs-var">cred</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1234"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Credential 'Staking crypto -&gt; Bool
</span><a href="#local-6989586621679473363"><span class="hs-identifier hs-var">isActive</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking crypto
</span><a href="#local-6989586621679473351"><span class="hs-identifier hs-var">cred</span></a></span><span>
</span><span id="line-1235"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(Coin -&gt; Coin -&gt; Coin)
-&gt; Credential 'Staking crypto
-&gt; Coin
-&gt; Map (Credential 'Staking crypto) Coin
-&gt; Map (Credential 'Staking crypto) Coin
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.insertWith</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">(&lt;&gt;)</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking crypto
</span><a href="#local-6989586621679473351"><span class="hs-identifier hs-var">cred</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473352"><span class="hs-identifier hs-var">coin</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473354"><span class="hs-identifier hs-var">ans</span></a></span><span>
</span><span id="line-1236"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
</span><a href="#local-6989586621679473354"><span class="hs-identifier hs-var">ans</span></a></span><span>
</span><span id="line-1237"></span><span>
</span><span id="line-1238"></span><span class="hs-comment">-- | Aggregate active stake by merging two maps. The triple map from the</span><span>
</span><span id="line-1239"></span><span class="hs-comment">--   UnifiedMap, and the IncrementalStake Only keep the active stake. Active can</span><span>
</span><span id="line-1240"></span><span class="hs-comment">--   be determined if there is a (SJust deleg) in the Triple.  This is step2 =</span><span>
</span><span id="line-1241"></span><span class="hs-comment">--   aggregate (dom activeDelegs &#9665; rewards) step1</span><span>
</span><span id="line-1242"></span><span id="local-6989586621679474565"><span id="local-6989586621679474566"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#aggregateActiveStake"><span class="hs-identifier hs-type">aggregateActiveStake</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474566"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474566"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Triple</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474565"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474566"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474566"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span></span></span><span>
</span><span id="line-1243"></span><span id="aggregateActiveStake"><span class="annot"><span class="annottext">aggregateActiveStake :: Map k (Triple crypto) -&gt; Map k Coin -&gt; Map k Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#aggregateActiveStake"><span class="hs-identifier hs-var hs-var">aggregateActiveStake</span></a></span></span><span> </span><span id="local-6989586621679473349"><span class="annot"><span class="annottext">Map k (Triple crypto)
</span><a href="#local-6989586621679473349"><span class="hs-identifier hs-var">tripmap</span></a></span></span><span> </span><span id="local-6989586621679473348"><span class="annot"><span class="annottext">Map k Coin
</span><a href="#local-6989586621679473348"><span class="hs-identifier hs-var">incremental</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1244"></span><span>  </span><span class="annot"><span class="annottext">(k -&gt; Triple crypto -&gt; Coin -&gt; Maybe Coin)
-&gt; (Map k (Triple crypto) -&gt; Map k Coin)
-&gt; (Map k Coin -&gt; Map k Coin)
-&gt; Map k (Triple crypto)
-&gt; Map k Coin
-&gt; Map k Coin
forall k a b c.
Ord k =&gt;
(k -&gt; a -&gt; b -&gt; Maybe c)
-&gt; (Map k a -&gt; Map k c)
-&gt; (Map k b -&gt; Map k c)
-&gt; Map k a
-&gt; Map k b
-&gt; Map k c
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.mergeWithKey</span></a></span><span>
</span><span id="line-1245"></span><span>    </span><span class="hs-comment">-- How to merge the ranges of the two maps where they have a common key. Below</span><span>
</span><span id="line-1246"></span><span>    </span><span class="hs-comment">-- 'coin1' and 'coin2' have the same key, '_k', and the stake is active if the delegation is SJust</span><span>
</span><span id="line-1247"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679473346"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621679473346"><span class="hs-identifier hs-var">_k</span></a></span></span><span> </span><span id="local-6989586621679473345"><span class="annot"><span class="annottext">Triple crypto
</span><a href="#local-6989586621679473345"><span class="hs-identifier hs-var">trip</span></a></span></span><span> </span><span id="local-6989586621679473344"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473344"><span class="hs-identifier hs-var">coin2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473344"><span class="hs-identifier hs-var">coin2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Coin -&gt; Coin) -&gt; Maybe Coin -&gt; Maybe Coin
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Triple crypto -&gt; Maybe Coin
forall coin ptr pool. Trip coin ptr pool -&gt; Maybe coin
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">UM.tripRewardActiveDelegation</span></a></span><span> </span><span class="annot"><span class="annottext">Triple crypto
</span><a href="#local-6989586621679473345"><span class="hs-identifier hs-var">trip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1248"></span><span>    </span><span class="hs-comment">-- what to do when a key appears just in 'tripmap', we only add the coin if the key is active</span><span>
</span><span id="line-1249"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Triple crypto -&gt; Maybe Coin)
-&gt; Map k (Triple crypto) -&gt; Map k Coin
forall a b k. (a -&gt; Maybe b) -&gt; Map k a -&gt; Map k b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.mapMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Triple crypto -&gt; Maybe Coin
forall coin ptr pool. Trip coin ptr pool -&gt; Maybe coin
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">UM.tripRewardActiveDelegation</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1250"></span><span>    </span><span class="hs-comment">-- what to do when a key is only in 'incremental', keep everything, because at</span><span>
</span><span id="line-1251"></span><span>    </span><span class="hs-comment">-- the call site of aggregateActiveStake, the arg 'incremental' is filtered by</span><span>
</span><span id="line-1252"></span><span>    </span><span class="hs-comment">-- 'resolveActiveIncrementalPtrs' which guarantees that only active stake is included.</span><span>
</span><span id="line-1253"></span><span>    </span><span class="annot"><span class="annottext">Map k Coin -&gt; Map k Coin
forall a. a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-1254"></span><span>    </span><span class="annot"><span class="annottext">Map k (Triple crypto)
</span><a href="#local-6989586621679473349"><span class="hs-identifier hs-var">tripmap</span></a></span><span>
</span><span id="line-1255"></span><span>    </span><span class="annot"><span class="annottext">Map k Coin
</span><a href="#local-6989586621679473348"><span class="hs-identifier hs-var">incremental</span></a></span><span>
</span><span id="line-1256"></span><span>
</span><span id="line-1257"></span><span class="hs-comment">-- ================================================</span><span>
</span><span id="line-1258"></span><span>
</span><span id="line-1259"></span><span class="hs-comment">-- | A valid (or self-consistent) UTxOState{_utxo, _deposited, _fees, _ppups, _stakeDistro}</span><span>
</span><span id="line-1260"></span><span class="hs-comment">--   maintains an invariant between the _utxo and _stakeDistro fields. the _stakeDistro field is</span><span>
</span><span id="line-1261"></span><span class="hs-comment">--   the aggregation of Coin over the StakeReferences in the UTxO. It can be computed by a pure</span><span>
</span><span id="line-1262"></span><span class="hs-comment">--   function from the _utxo field. In some situations, mostly unit or example tests, or when</span><span>
</span><span id="line-1263"></span><span class="hs-comment">--   initializing a small UTxO, we want to create a UTxOState that computes the _stakeDistro from</span><span>
</span><span id="line-1264"></span><span class="hs-comment">--   the _utxo. This is aways safe to do, but if the _utxo field is big, this can be very expensive,</span><span>
</span><span id="line-1265"></span><span class="hs-comment">--   which defeats the purpose of memoizing the _stakeDistro field. So use of this function should be</span><span>
</span><span id="line-1266"></span><span class="hs-comment">--   restricted to tests and initializations, where the invariant should be maintained.</span><span>
</span><span id="line-1267"></span><span id="local-6989586621679473341"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#smartUTxOState"><span class="hs-identifier hs-type">smartUTxOState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1268"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473341"><span class="hs-identifier hs-type">era</span></a></span><span>
</span><span id="line-1269"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1270"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473341"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1271"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1272"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1273"></span><span>  </span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473341"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1274"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-type">UTxOState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473341"><span class="hs-identifier hs-type">era</span></a></span></span><span>
</span><span id="line-1275"></span><span id="smartUTxOState"><span class="annot"><span class="annottext">smartUTxOState :: UTxO era
-&gt; Coin -&gt; Coin -&gt; State (EraRule &quot;PPUP&quot; era) -&gt; UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#smartUTxOState"><span class="hs-identifier hs-var hs-var">smartUTxOState</span></a></span></span><span> </span><span id="local-6989586621679473340"><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679473340"><span class="hs-identifier hs-var">utxo</span></a></span></span><span> </span><span id="local-6989586621679473339"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473339"><span class="hs-identifier hs-var">c1</span></a></span></span><span> </span><span id="local-6989586621679473338"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473338"><span class="hs-identifier hs-var">c2</span></a></span></span><span> </span><span id="local-6989586621679473337"><span class="annot"><span class="annottext">State (EraRule &quot;PPUP&quot; era)
</span><a href="#local-6989586621679473337"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1276"></span><span>  </span><span class="annot"><span class="annottext">UTxO era
-&gt; Coin
-&gt; Coin
-&gt; State (EraRule &quot;PPUP&quot; era)
-&gt; IncrementalStake (Crypto era)
-&gt; UTxOState era
forall era.
UTxO era
-&gt; Coin
-&gt; Coin
-&gt; State (EraRule &quot;PPUP&quot; era)
-&gt; IncrementalStake (Crypto era)
-&gt; UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-var">UTxOState</span></a></span><span>
</span><span id="line-1277"></span><span>    </span><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679473340"><span class="hs-identifier hs-var">utxo</span></a></span><span>
</span><span id="line-1278"></span><span>    </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473339"><span class="hs-identifier hs-var">c1</span></a></span><span>
</span><span id="line-1279"></span><span>    </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473338"><span class="hs-identifier hs-var">c2</span></a></span><span>
</span><span id="line-1280"></span><span>    </span><span class="annot"><span class="annottext">State (EraRule &quot;PPUP&quot; era)
</span><a href="#local-6989586621679473337"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1281"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
-&gt; UTxO era -&gt; UTxO era -&gt; IncrementalStake (Crypto era)
forall era.
Era era =&gt;
IncrementalStake (Crypto era)
-&gt; UTxO era -&gt; UTxO era -&gt; IncrementalStake (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#updateStakeDistribution"><span class="hs-identifier hs-var">updateStakeDistribution</span></a></span><span> </span><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">UTxO era
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679473340"><span class="hs-identifier hs-var">utxo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1282"></span><span>
</span><span id="line-1283"></span><span class="hs-comment">-- ==============================</span><span>
</span><span id="line-1284"></span><span>
</span><span id="line-1285"></span><span class="hs-comment">-- | Apply a reward update</span><span>
</span><span id="line-1286"></span><span id="local-6989586621679473336"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#applyRUpd"><span class="hs-identifier hs-type">applyRUpd</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1287"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_protocolVersion&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473336"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ProtVer</span></a></span><span>
</span><span id="line-1288"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1289"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardUpdate"><span class="hs-identifier hs-type">RewardUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473336"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1290"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473336"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1291"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473336"><span class="hs-identifier hs-type">era</span></a></span></span><span>
</span><span id="line-1292"></span><span id="applyRUpd"><span class="annot"><span class="annottext">applyRUpd :: RewardUpdate (Crypto era) -&gt; EpochState era -&gt; EpochState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#applyRUpd"><span class="hs-identifier hs-var hs-var">applyRUpd</span></a></span></span><span> </span><span id="local-6989586621679473335"><span class="annot"><span class="annottext">RewardUpdate (Crypto era)
</span><a href="#local-6989586621679473335"><span class="hs-identifier hs-var">ru</span></a></span></span><span> </span><span id="local-6989586621679473334"><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473334"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1293"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679473333"><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473333"><span class="hs-identifier hs-var">es'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set (Credential 'Staking (Crypto era))
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewardUpdate (Crypto era)
-&gt; EpochState era
-&gt; (EpochState era,
    Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))),
    Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))),
    Set (Credential 'Staking (Crypto era)))
forall era.
HasField &quot;_protocolVersion&quot; (PParams era) ProtVer =&gt;
RewardUpdate (Crypto era)
-&gt; EpochState era
-&gt; (EpochState era,
    Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))),
    Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))),
    Set (Credential 'Staking (Crypto era)))
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#applyRUpd%27"><span class="hs-identifier hs-var">applyRUpd'</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate (Crypto era)
</span><a href="#local-6989586621679473335"><span class="hs-identifier hs-var">ru</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473334"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-1294"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473333"><span class="hs-identifier hs-var">es'</span></a></span><span>
</span><span id="line-1295"></span><span>
</span><span id="line-1296"></span><span id="local-6989586621679474538"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#applyRUpd%27"><span class="hs-identifier hs-type">applyRUpd'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1297"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_protocolVersion&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474538"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ProtVer</span></a></span><span>
</span><span id="line-1298"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1299"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardUpdate"><span class="hs-identifier hs-type">RewardUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474538"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1300"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474538"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1301"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474538"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1302"></span><span>    </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474538"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#Reward"><span class="hs-identifier hs-type">Reward</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474538"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1303"></span><span>    </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474538"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#Reward"><span class="hs-identifier hs-type">Reward</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474538"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1304"></span><span>    </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474538"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1305"></span><span>  </span><span class="hs-special">)</span></span><span>
</span><span id="line-1306"></span><span id="applyRUpd%27"><span class="annot"><span class="annottext">applyRUpd' :: RewardUpdate (Crypto era)
-&gt; EpochState era
-&gt; (EpochState era,
    Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))),
    Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))),
    Set (Credential 'Staking (Crypto era)))
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#applyRUpd%27"><span class="hs-identifier hs-var hs-var">applyRUpd'</span></a></span></span><span>
</span><span id="line-1307"></span><span>  </span><span id="local-6989586621679473332"><span class="annot"><span class="annottext">RewardUpdate (Crypto era)
</span><a href="#local-6989586621679473332"><span class="hs-identifier hs-var">ru</span></a></span></span><span>
</span><span id="line-1308"></span><span>  </span><span id="local-6989586621679473331"><span class="annot"><span class="annottext">es :: EpochState era
</span><a href="#local-6989586621679473331"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span id="local-6989586621679473330"><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473330"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621679473329"><span class="annot"><span class="annottext">SnapShots (Crypto era)
</span><a href="#local-6989586621679473329"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621679473328"><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473328"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span id="local-6989586621679473327"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473327"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span id="local-6989586621679473326"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473326"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span id="local-6989586621679473325"><span class="annot"><span class="annottext">NonMyopic (Crypto era)
</span><a href="#local-6989586621679473325"><span class="hs-identifier hs-var">_nm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1309"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AccountState
-&gt; SnapShots (Crypto era)
-&gt; LedgerState era
-&gt; PParams era
-&gt; PParams era
-&gt; NonMyopic (Crypto era)
-&gt; EpochState era
forall era.
AccountState
-&gt; SnapShots (Crypto era)
-&gt; LedgerState era
-&gt; PParams era
-&gt; PParams era
-&gt; NonMyopic (Crypto era)
-&gt; EpochState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-var">EpochState</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473324"><span class="hs-identifier hs-var">as'</span></a></span><span> </span><span class="annot"><span class="annottext">SnapShots (Crypto era)
</span><a href="#local-6989586621679473329"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473323"><span class="hs-identifier hs-var">ls'</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473327"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473326"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">NonMyopic (Crypto era)
</span><a href="#local-6989586621679473322"><span class="hs-identifier hs-var">nm'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473321"><span class="hs-identifier hs-var">registered</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473320"><span class="hs-identifier hs-var">eraIgnored</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set (Credential 'Staking (Crypto era))
</span><a href="#local-6989586621679473319"><span class="hs-identifier hs-var">unregistered</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1310"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1311"></span><span>      </span><span id="local-6989586621679473318"><span class="annot"><span class="annottext">utxoState_ :: UTxOState era
</span><a href="#local-6989586621679473318"><span class="hs-identifier hs-var hs-var">utxoState_</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerState era -&gt; UTxOState era
forall era. LedgerState era -&gt; UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#lsUTxOState"><span class="hs-identifier hs-var hs-var">lsUTxOState</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473328"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-1312"></span><span>      </span><span id="local-6989586621679473317"><span class="annot"><span class="annottext">delegState :: DPState (Crypto era)
</span><a href="#local-6989586621679473317"><span class="hs-identifier hs-var hs-var">delegState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerState era -&gt; DPState (Crypto era)
forall era. LedgerState era -&gt; DPState (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#lsDPState"><span class="hs-identifier hs-var hs-var">lsDPState</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473328"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-1313"></span><span>      </span><span id="local-6989586621679473316"><span class="annot"><span class="annottext">dState :: DState (Crypto era)
</span><a href="#local-6989586621679473316"><span class="hs-identifier hs-var hs-var">dState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DPState (Crypto era) -&gt; DState (Crypto era)
forall crypto. DPState crypto -&gt; DState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#dpsDState"><span class="hs-identifier hs-var hs-var">dpsDState</span></a></span><span> </span><span class="annot"><span class="annottext">DPState (Crypto era)
</span><a href="#local-6989586621679473317"><span class="hs-identifier hs-var">delegState</span></a></span><span>
</span><span id="line-1314"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679473321"><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473321"><span class="hs-identifier hs-var">registered</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473320"><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473320"><span class="hs-identifier hs-var">eraIgnored</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473319"><span class="annot"><span class="annottext">Set (Credential 'Staking (Crypto era))
</span><a href="#local-6989586621679473319"><span class="hs-identifier hs-var">unregistered</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473315"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473315"><span class="hs-identifier hs-var">totalUnregistered</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1315"></span><span>        </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
-&gt; EpochState era
-&gt; (Map
      (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))),
    Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))),
    Set (Credential 'Staking (Crypto era)), Coin)
forall era.
HasField &quot;_protocolVersion&quot; (PParams era) ProtVer =&gt;
Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
-&gt; EpochState era
-&gt; (Map
      (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))),
    Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))),
    Set (Credential 'Staking (Crypto era)), Coin)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#filterAllRewards"><span class="hs-identifier hs-var">filterAllRewards</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewardUpdate (Crypto era)
-&gt; Map
     (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
forall crypto.
RewardUpdate crypto
-&gt; Map (Credential 'Staking crypto) (Set (Reward crypto))
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rs"><span class="hs-identifier hs-var hs-var">rs</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate (Crypto era)
</span><a href="#local-6989586621679473332"><span class="hs-identifier hs-var">ru</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473331"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-1316"></span><span>      </span><span id="local-6989586621679473313"><span class="annot"><span class="annottext">registeredAggregated :: Map (Credential 'Staking (Crypto era)) Coin
</span><a href="#local-6989586621679473313"><span class="hs-identifier hs-var hs-var">registeredAggregated</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PParams era
-&gt; Map
     (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
-&gt; Map (Credential 'Staking (Crypto era)) Coin
forall crypto pp.
HasField &quot;_protocolVersion&quot; pp ProtVer =&gt;
pp
-&gt; Map (Credential 'Staking crypto) (Set (Reward crypto))
-&gt; Map (Credential 'Staking crypto) Coin
</span><a href="Cardano.Ledger.Shelley.Rewards.html#aggregateRewards"><span class="hs-identifier hs-var">aggregateRewards</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473326"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473321"><span class="hs-identifier hs-var">registered</span></a></span><span>
</span><span id="line-1317"></span><span>      </span><span id="local-6989586621679473324"><span class="annot"><span class="annottext">as' :: AccountState
</span><a href="#local-6989586621679473324"><span class="hs-identifier hs-var hs-var">as'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1318"></span><span>        </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473330"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-1319"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_treasury :: Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_treasury"><span class="hs-identifier hs-var">_treasury</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; DeltaCoin -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">addDeltaCoin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AccountState -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_treasury"><span class="hs-identifier hs-var hs-var">_treasury</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473330"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewardUpdate (Crypto era) -&gt; DeltaCoin
forall crypto. RewardUpdate crypto -&gt; DeltaCoin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#deltaT"><span class="hs-identifier hs-var hs-var">deltaT</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate (Crypto era)
</span><a href="#local-6989586621679473332"><span class="hs-identifier hs-var">ru</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473315"><span class="hs-identifier hs-var">totalUnregistered</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1320"></span><span>            </span><span class="annot"><span class="annottext">_reserves :: Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_reserves"><span class="hs-identifier hs-var">_reserves</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; DeltaCoin -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">addDeltaCoin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AccountState -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_reserves"><span class="hs-identifier hs-var hs-var">_reserves</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473330"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewardUpdate (Crypto era) -&gt; DeltaCoin
forall crypto. RewardUpdate crypto -&gt; DeltaCoin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#deltaR"><span class="hs-identifier hs-var hs-var">deltaR</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate (Crypto era)
</span><a href="#local-6989586621679473332"><span class="hs-identifier hs-var">ru</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1321"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-1322"></span><span>      </span><span id="local-6989586621679473323"><span class="annot"><span class="annottext">ls' :: LedgerState era
</span><a href="#local-6989586621679473323"><span class="hs-identifier hs-var hs-var">ls'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1323"></span><span>        </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473328"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-1324"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lsUTxOState :: UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#lsUTxOState"><span class="hs-identifier hs-var">lsUTxOState</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1325"></span><span>              </span><span class="annot"><span class="annottext">UTxOState era
</span><a href="#local-6989586621679473318"><span class="hs-identifier hs-var">utxoState_</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">_fees :: Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_fees"><span class="hs-identifier hs-var">_fees</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTxOState era -&gt; Coin
forall era. UTxOState era -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_fees"><span class="hs-identifier hs-var hs-var">_fees</span></a></span><span> </span><span class="annot"><span class="annottext">UTxOState era
</span><a href="#local-6989586621679473318"><span class="hs-identifier hs-var">utxoState_</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; DeltaCoin -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">`addDeltaCoin`</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate (Crypto era) -&gt; DeltaCoin
forall crypto. RewardUpdate crypto -&gt; DeltaCoin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#deltaF"><span class="hs-identifier hs-var hs-var">deltaF</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate (Crypto era)
</span><a href="#local-6989586621679473332"><span class="hs-identifier hs-var">ru</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-1326"></span><span>            </span><span class="annot"><span class="annottext">lsDPState :: DPState (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#lsDPState"><span class="hs-identifier hs-var">lsDPState</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1327"></span><span>              </span><span class="annot"><span class="annottext">DPState (Crypto era)
</span><a href="#local-6989586621679473317"><span class="hs-identifier hs-var">delegState</span></a></span><span>
</span><span id="line-1328"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">dpsDState :: DState (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#dpsDState"><span class="hs-identifier hs-var">dpsDState</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1329"></span><span>                    </span><span class="annot"><span class="annottext">DState (Crypto era)
</span><a href="#local-6989586621679473316"><span class="hs-identifier hs-var">dState</span></a></span><span>
</span><span id="line-1330"></span><span>                      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_unified :: UnifiedMap (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_unified"><span class="hs-identifier hs-var">_unified</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DState (Crypto era)
-&gt; ViewMap (Crypto era) (Credential 'Staking (Crypto era)) Coin
forall crypto.
DState crypto -&gt; ViewMap crypto (Credential 'Staking crypto) Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#rewards"><span class="hs-identifier hs-var">rewards</span></a></span><span> </span><span class="annot"><span class="annottext">DState (Crypto era)
</span><a href="#local-6989586621679473316"><span class="hs-identifier hs-var">dState</span></a></span><span> </span><span class="annot"><span class="annottext">ViewMap (Crypto era) (Credential 'Staking (Crypto era)) Coin
-&gt; Map (Credential 'Staking (Crypto era)) Coin
-&gt; UnifiedMap (Crypto era)
forall cred coin pool ptr k.
(Ord cred, Monoid coin) =&gt;
View coin cred pool ptr k coin
-&gt; Map k coin -&gt; UMap coin cred pool ptr
</span><a href="../../../../cardano-data/html/src"><span class="hs-operator hs-var">UM.&#8746;+</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) Coin
</span><a href="#local-6989586621679473313"><span class="hs-identifier hs-var">registeredAggregated</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1331"></span><span>                      </span><span class="hs-special">}</span><span>
</span><span id="line-1332"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-1333"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-1334"></span><span>      </span><span id="local-6989586621679473322"><span class="annot"><span class="annottext">nm' :: NonMyopic (Crypto era)
</span><a href="#local-6989586621679473322"><span class="hs-identifier hs-var hs-var">nm'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewardUpdate (Crypto era) -&gt; NonMyopic (Crypto era)
forall crypto. RewardUpdate crypto -&gt; NonMyopic crypto
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#nonMyopic"><span class="hs-identifier hs-var hs-var">nonMyopic</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate (Crypto era)
</span><a href="#local-6989586621679473332"><span class="hs-identifier hs-var">ru</span></a></span><span>
</span><span id="line-1335"></span><span>
</span><span id="line-1336"></span><span id="local-6989586621679474536"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#filterAllRewards"><span class="hs-identifier hs-type">filterAllRewards</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1337"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_protocolVersion&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474536"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ProtVer</span></a></span><span>
</span><span id="line-1338"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1339"></span><span>  </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474536"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#Reward"><span class="hs-identifier hs-type">Reward</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474536"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1340"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474536"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1341"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474536"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#Reward"><span class="hs-identifier hs-type">Reward</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474536"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1342"></span><span>    </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474536"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#Reward"><span class="hs-identifier hs-type">Reward</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474536"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1343"></span><span>    </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Credential</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Staking</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474536"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1344"></span><span>    </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span>
</span><span id="line-1345"></span><span>  </span><span class="hs-special">)</span></span><span>
</span><span id="line-1346"></span><span id="filterAllRewards"><span class="annot"><span class="annottext">filterAllRewards :: Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
-&gt; EpochState era
-&gt; (Map
      (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))),
    Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))),
    Set (Credential 'Staking (Crypto era)), Coin)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#filterAllRewards"><span class="hs-identifier hs-var hs-var">filterAllRewards</span></a></span></span><span> </span><span id="local-6989586621679473307"><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473307"><span class="hs-identifier hs-var">rs'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span id="local-6989586621679473306"><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473306"><span class="hs-identifier hs-var">_as</span></a></span></span><span> </span><span id="local-6989586621679473305"><span class="annot"><span class="annottext">SnapShots (Crypto era)
</span><a href="#local-6989586621679473305"><span class="hs-identifier hs-var">_ss</span></a></span></span><span> </span><span id="local-6989586621679473304"><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473304"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span id="local-6989586621679473303"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473303"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span id="local-6989586621679473302"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473302"><span class="hs-identifier hs-var">_pp</span></a></span></span><span> </span><span id="local-6989586621679473301"><span class="annot"><span class="annottext">NonMyopic (Crypto era)
</span><a href="#local-6989586621679473301"><span class="hs-identifier hs-var">_nm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1347"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473300"><span class="hs-identifier hs-var">registered</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473299"><span class="hs-identifier hs-var">eraIgnored</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set (Credential 'Staking (Crypto era))
</span><a href="#local-6989586621679473298"><span class="hs-identifier hs-var">unregistered</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473297"><span class="hs-identifier hs-var">totalUnregistered</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1348"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1349"></span><span>    </span><span id="local-6989586621679473296"><span class="annot"><span class="annottext">delegState :: DPState (Crypto era)
</span><a href="#local-6989586621679473296"><span class="hs-identifier hs-var hs-var">delegState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerState era -&gt; DPState (Crypto era)
forall era. LedgerState era -&gt; DPState (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#lsDPState"><span class="hs-identifier hs-var hs-var">lsDPState</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473304"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-1350"></span><span>    </span><span id="local-6989586621679473295"><span class="annot"><span class="annottext">dState :: DState (Crypto era)
</span><a href="#local-6989586621679473295"><span class="hs-identifier hs-var hs-var">dState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DPState (Crypto era) -&gt; DState (Crypto era)
forall crypto. DPState crypto -&gt; DState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#dpsDState"><span class="hs-identifier hs-var hs-var">dpsDState</span></a></span><span> </span><span class="annot"><span class="annottext">DPState (Crypto era)
</span><a href="#local-6989586621679473296"><span class="hs-identifier hs-var">delegState</span></a></span><span>
</span><span id="line-1351"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679473294"><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473294"><span class="hs-identifier hs-var">regRU</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473293"><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473293"><span class="hs-identifier hs-var">unregRU</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1352"></span><span>      </span><span class="annot"><span class="annottext">(Credential 'Staking (Crypto era)
 -&gt; Set (Reward (Crypto era)) -&gt; Bool)
-&gt; Map
     (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
-&gt; (Map
      (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))),
    Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))))
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; (Map k a, Map k a)
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.partitionWithKey</span></a></span><span>
</span><span id="line-1353"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679473291"><span class="annot"><span class="annottext">Credential 'Staking (Crypto era)
</span><a href="#local-6989586621679473291"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">Set (Reward (Crypto era))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Exp Bool -&gt; Bool
forall s t. Embed s t =&gt; Exp t -&gt; s
</span><a href="../../../../set-algebra/html/src"><span class="hs-identifier hs-var">eval</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Credential 'Staking (Crypto era)
</span><a href="#local-6989586621679473291"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking (Crypto era)
-&gt; Exp (Sett (Credential 'Staking (Crypto era)) ()) -&gt; Exp Bool
forall k (g :: * -&gt; * -&gt; *) s.
(Show k, Ord k, Iter g, HasExp s (g k ())) =&gt;
k -&gt; s -&gt; Exp Bool
</span><a href="../../../../set-algebra/html/src"><span class="hs-operator hs-var">&#8712;</span></a></span><span> </span><span class="annot"><span class="annottext">ViewMap (Crypto era) (Credential 'Staking (Crypto era)) Coin
-&gt; Exp (Sett (Credential 'Staking (Crypto era)) ())
forall k s (f :: * -&gt; * -&gt; *) v.
(Ord k, HasExp s (f k v)) =&gt;
s -&gt; Exp (Sett k ())
</span><a href="../../../../set-algebra/html/src"><span class="hs-identifier hs-var">dom</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DState (Crypto era)
-&gt; ViewMap (Crypto era) (Credential 'Staking (Crypto era)) Coin
forall crypto.
DState crypto -&gt; ViewMap crypto (Credential 'Staking crypto) Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#rewards"><span class="hs-identifier hs-var">rewards</span></a></span><span> </span><span class="annot"><span class="annottext">DState (Crypto era)
</span><a href="#local-6989586621679473295"><span class="hs-identifier hs-var">dState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1354"></span><span>        </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473307"><span class="hs-identifier hs-var">rs'</span></a></span><span>
</span><span id="line-1355"></span><span>    </span><span id="local-6989586621679473297"><span class="annot"><span class="annottext">totalUnregistered :: Coin
</span><a href="#local-6989586621679473297"><span class="hs-identifier hs-var hs-var">totalUnregistered</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) Coin -&gt; Coin
forall (t :: * -&gt; *) m. (Foldable t, Monoid m) =&gt; t m -&gt; m
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fold</span></a></span><span> </span><span class="annot"><span class="annottext">(Map (Credential 'Staking (Crypto era)) Coin -&gt; Coin)
-&gt; Map (Credential 'Staking (Crypto era)) Coin -&gt; Coin
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
-&gt; Map
     (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
-&gt; Map (Credential 'Staking (Crypto era)) Coin
forall crypto pp.
HasField &quot;_protocolVersion&quot; pp ProtVer =&gt;
pp
-&gt; Map (Credential 'Staking crypto) (Set (Reward crypto))
-&gt; Map (Credential 'Staking crypto) Coin
</span><a href="Cardano.Ledger.Shelley.Rewards.html#aggregateRewards"><span class="hs-identifier hs-var">aggregateRewards</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473303"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473293"><span class="hs-identifier hs-var">unregRU</span></a></span><span>
</span><span id="line-1356"></span><span>    </span><span id="local-6989586621679473298"><span class="annot"><span class="annottext">unregistered :: Set (Credential 'Staking (Crypto era))
</span><a href="#local-6989586621679473298"><span class="hs-identifier hs-var hs-var">unregistered</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
-&gt; Set (Credential 'Staking (Crypto era))
forall k a. Map k a -&gt; Set k
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.keysSet</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473293"><span class="hs-identifier hs-var">unregRU</span></a></span><span>
</span><span id="line-1357"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679473300"><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473300"><span class="hs-identifier hs-var">registered</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473299"><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473299"><span class="hs-identifier hs-var">eraIgnored</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PParams era
-&gt; Map
     (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
-&gt; (Map
      (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))),
    Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))))
forall crypto pp.
HasField &quot;_protocolVersion&quot; pp ProtVer =&gt;
pp
-&gt; Map (Credential 'Staking crypto) (Set (Reward crypto))
-&gt; (Map (Credential 'Staking crypto) (Set (Reward crypto)),
    Map (Credential 'Staking crypto) (Set (Reward crypto)))
</span><a href="Cardano.Ledger.Shelley.Rewards.html#filterRewards"><span class="hs-identifier hs-var">filterRewards</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473303"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473294"><span class="hs-identifier hs-var">regRU</span></a></span><span>
</span><span id="line-1358"></span><span>
</span><span id="line-1359"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#decayFactor"><span class="hs-identifier hs-type">decayFactor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Float</span></a></span><span>
</span><span id="line-1360"></span><span id="decayFactor"><span class="annot"><span class="annottext">decayFactor :: Float
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#decayFactor"><span class="hs-identifier hs-var hs-var">decayFactor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0.9</span></span><span>
</span><span id="line-1361"></span><span>
</span><span id="line-1362"></span><span id="local-6989586621679474408"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#updateNonMyopic"><span class="hs-identifier hs-type">updateNonMyopic</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1363"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.PoolRank.html#NonMyopic"><span class="hs-identifier hs-type">NonMyopic</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474408"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1364"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1365"></span><span>  </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">KeyHash</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">StakePool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474408"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.PoolRank.html#Likelihood"><span class="hs-identifier hs-type">Likelihood</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1366"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.PoolRank.html#NonMyopic"><span class="hs-identifier hs-type">NonMyopic</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474408"><span class="hs-identifier hs-type">crypto</span></a></span></span><span>
</span><span id="line-1367"></span><span id="updateNonMyopic"><span class="annot"><span class="annottext">updateNonMyopic :: NonMyopic crypto
-&gt; Coin
-&gt; Map (KeyHash 'StakePool crypto) Likelihood
-&gt; NonMyopic crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#updateNonMyopic"><span class="hs-identifier hs-var hs-var">updateNonMyopic</span></a></span></span><span> </span><span id="local-6989586621679473290"><span class="annot"><span class="annottext">NonMyopic crypto
</span><a href="#local-6989586621679473290"><span class="hs-identifier hs-var">nm</span></a></span></span><span> </span><span id="local-6989586621679473289"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473289"><span class="hs-identifier hs-var">rPot</span></a></span></span><span> </span><span id="local-6989586621679473288"><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) Likelihood
</span><a href="#local-6989586621679473288"><span class="hs-identifier hs-var">newLikelihoods</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1368"></span><span>  </span><span class="annot"><span class="annottext">NonMyopic crypto
</span><a href="#local-6989586621679473290"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-1369"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">likelihoodsNM :: Map (KeyHash 'StakePool crypto) Likelihood
</span><a href="Cardano.Ledger.Shelley.PoolRank.html#likelihoodsNM"><span class="hs-identifier hs-var">likelihoodsNM</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) Likelihood
</span><a href="#local-6989586621679473286"><span class="hs-identifier hs-var">updatedLikelihoods</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1370"></span><span>      </span><span class="annot"><span class="annottext">rewardPotNM :: Coin
</span><a href="Cardano.Ledger.Shelley.PoolRank.html#rewardPotNM"><span class="hs-identifier hs-var">rewardPotNM</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473289"><span class="hs-identifier hs-var">rPot</span></a></span><span>
</span><span id="line-1371"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-1372"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1373"></span><span>    </span><span id="local-6989586621679473284"><span class="annot"><span class="annottext">history :: Map (KeyHash 'StakePool crypto) Likelihood
</span><a href="#local-6989586621679473284"><span class="hs-identifier hs-var hs-var">history</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonMyopic crypto -&gt; Map (KeyHash 'StakePool crypto) Likelihood
forall crypto.
NonMyopic crypto -&gt; Map (KeyHash 'StakePool crypto) Likelihood
</span><a href="Cardano.Ledger.Shelley.PoolRank.html#likelihoodsNM"><span class="hs-identifier hs-var hs-var">likelihoodsNM</span></a></span><span> </span><span class="annot"><span class="annottext">NonMyopic crypto
</span><a href="#local-6989586621679473290"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-1374"></span><span>    </span><span id="local-6989586621679473283"><span class="annot"><span class="annottext">performance :: KeyHash 'StakePool crypto -&gt; Likelihood -&gt; Likelihood
</span><a href="#local-6989586621679473283"><span class="hs-identifier hs-var hs-var">performance</span></a></span></span><span> </span><span id="local-6989586621679473282"><span class="annot"><span class="annottext">KeyHash 'StakePool crypto
</span><a href="#local-6989586621679473282"><span class="hs-identifier hs-var">kh</span></a></span></span><span> </span><span id="local-6989586621679473281"><span class="annot"><span class="annottext">Likelihood
</span><a href="#local-6989586621679473281"><span class="hs-identifier hs-var">newPerf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1375"></span><span>      </span><span class="annot"><span class="annottext">Likelihood
-&gt; (Likelihood -&gt; Likelihood) -&gt; Maybe Likelihood -&gt; Likelihood
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span>
</span><span id="line-1376"></span><span>        </span><span class="annot"><span class="annottext">Likelihood
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-1377"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float -&gt; Likelihood -&gt; Likelihood
</span><a href="Cardano.Ledger.Shelley.PoolRank.html#applyDecay"><span class="hs-identifier hs-var">applyDecay</span></a></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#decayFactor"><span class="hs-identifier hs-var">decayFactor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1378"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyHash 'StakePool crypto
-&gt; Map (KeyHash 'StakePool crypto) Likelihood -&gt; Maybe Likelihood
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">KeyHash 'StakePool crypto
</span><a href="#local-6989586621679473282"><span class="hs-identifier hs-var">kh</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) Likelihood
</span><a href="#local-6989586621679473284"><span class="hs-identifier hs-var">history</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1379"></span><span>        </span><span class="annot"><span class="annottext">Likelihood -&gt; Likelihood -&gt; Likelihood
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Likelihood
</span><a href="#local-6989586621679473281"><span class="hs-identifier hs-var">newPerf</span></a></span><span>
</span><span id="line-1380"></span><span>    </span><span id="local-6989586621679473286"><span class="annot"><span class="annottext">updatedLikelihoods :: Map (KeyHash 'StakePool crypto) Likelihood
</span><a href="#local-6989586621679473286"><span class="hs-identifier hs-var hs-var">updatedLikelihoods</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(KeyHash 'StakePool crypto -&gt; Likelihood -&gt; Likelihood)
-&gt; Map (KeyHash 'StakePool crypto) Likelihood
-&gt; Map (KeyHash 'StakePool crypto) Likelihood
forall k a b. (k -&gt; a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.mapWithKey</span></a></span><span> </span><span class="annot"><span class="annottext">KeyHash 'StakePool crypto -&gt; Likelihood -&gt; Likelihood
</span><a href="#local-6989586621679473283"><span class="hs-identifier hs-var">performance</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) Likelihood
</span><a href="#local-6989586621679473288"><span class="hs-identifier hs-var">newLikelihoods</span></a></span><span>
</span><span id="line-1381"></span><span>
</span><span id="line-1382"></span><span class="hs-comment">-- =============================</span><span>
</span><span id="line-1383"></span><span class="hs-comment">-- To prevent a huge pause, at the stability point, we spread out the</span><span>
</span><span id="line-1384"></span><span class="hs-comment">-- Calculation of rewards over many blocks. We do this in 3 phases. Phase 1</span><span>
</span><span id="line-1385"></span><span class="hs-comment">-- of a reward upate is a pure computation, computing some parameters which</span><span>
</span><span id="line-1386"></span><span class="hs-comment">-- become fixed at the time when we reach the stability point. One of these</span><span>
</span><span id="line-1387"></span><span class="hs-comment">-- parameters is a Pulser, i.e. a computation that when pulseM'ed computes</span><span>
</span><span id="line-1388"></span><span class="hs-comment">-- a portion of what is required, so that the whole compuation can be spread out in time.</span><span>
</span><span id="line-1389"></span><span>
</span><span id="line-1390"></span><span class="hs-comment">-- | The EpochState has a field which is (Core.PParams era). We need these</span><span>
</span><span id="line-1391"></span><span class="hs-comment">--     fields, a subset of the fields in PParams, in: startStep and createRUpd.</span><span>
</span><span id="line-1392"></span><span class="hs-keyword">type</span><span> </span><span id="UsesPP"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UsesPP"><span class="hs-identifier hs-var">UsesPP</span></a></span></span><span> </span><span id="local-6989586621679473280"><span class="annot"><a href="#local-6989586621679473280"><span class="hs-identifier hs-type">era</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1393"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_d&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473280"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">UnitInterval</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1394"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_tau&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473280"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">UnitInterval</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1395"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_a0&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473280"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">NonNegativeInterval</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1396"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_rho&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473280"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">UnitInterval</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1397"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_nOpt&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473280"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Natural</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1398"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">HasField</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;_protocolVersion&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473280"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ProtVer</span></a></span><span>
</span><span id="line-1399"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-1400"></span><span>
</span><span id="line-1401"></span><span class="hs-comment">-- | Assemble the components for, and then create, a Pulser.</span><span>
</span><span id="line-1402"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#startStep"><span class="hs-identifier hs-type">startStep</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1403"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679474406"><span class="annot"><a href="#local-6989586621679474406"><span class="hs-identifier hs-type">era</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1404"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UsesPP"><span class="hs-identifier hs-type">UsesPP</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474406"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1405"></span><span>  </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">EpochSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1406"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">BlocksMade</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474406"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1407"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474406"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1408"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1409"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ActiveSlotCoeff</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1410"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1411"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#PulsingRewUpdate"><span class="hs-identifier hs-type">PulsingRewUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474406"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardProvenance.html#RewardProvenance"><span class="hs-identifier hs-type">RewardProvenance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474406"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1412"></span><span id="startStep"><span class="annot"><span class="annottext">startStep :: EpochSize
-&gt; BlocksMade (Crypto era)
-&gt; EpochState era
-&gt; Coin
-&gt; ActiveSlotCoeff
-&gt; Word64
-&gt; (PulsingRewUpdate (Crypto era), RewardProvenance (Crypto era))
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#startStep"><span class="hs-identifier hs-var hs-var">startStep</span></a></span></span><span> </span><span id="local-6989586621679473279"><span class="annot"><span class="annottext">EpochSize
</span><a href="#local-6989586621679473279"><span class="hs-identifier hs-var">slotsPerEpoch</span></a></span></span><span> </span><span id="local-6989586621679473278"><span class="annot"><span class="annottext">b :: BlocksMade (Crypto era)
</span><a href="#local-6989586621679473278"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">BlocksMade</span></a></span><span> </span><span id="local-6989586621679473276"><span class="annot"><span class="annottext">Map (KeyHash 'StakePool (Crypto era)) Natural
</span><a href="#local-6989586621679473276"><span class="hs-identifier hs-var">b'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473275"><span class="annot"><span class="annottext">es :: EpochState era
</span><a href="#local-6989586621679473275"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span id="local-6989586621679473274"><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473274"><span class="hs-identifier hs-var">acnt</span></a></span></span><span> </span><span id="local-6989586621679473273"><span class="annot"><span class="annottext">SnapShots (Crypto era)
</span><a href="#local-6989586621679473273"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621679473272"><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473272"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span id="local-6989586621679473271"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473271"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679473270"><span class="annot"><span class="annottext">NonMyopic (Crypto era)
</span><a href="#local-6989586621679473270"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473269"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473269"><span class="hs-identifier hs-var">maxSupply</span></a></span></span><span> </span><span id="local-6989586621679473268"><span class="annot"><span class="annottext">ActiveSlotCoeff
</span><a href="#local-6989586621679473268"><span class="hs-identifier hs-var">asc</span></a></span></span><span> </span><span id="local-6989586621679473267"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679473267"><span class="hs-identifier hs-var">secparam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1413"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.EpochBoundary.html#SnapShot"><span class="hs-identifier hs-type">SnapShot</span></a></span><span> </span><span id="local-6989586621679473266"><span class="annot"><span class="annottext">Stake (Crypto era)
</span><a href="#local-6989586621679473266"><span class="hs-identifier hs-var">stake'</span></a></span></span><span> </span><span id="local-6989586621679473265"><span class="annot"><span class="annottext">VMap
  VB
  VB
  (Credential 'Staking (Crypto era))
  (KeyHash 'StakePool (Crypto era))
</span><a href="#local-6989586621679473265"><span class="hs-identifier hs-var">delegs'</span></a></span></span><span> </span><span id="local-6989586621679473264"><span class="annot"><span class="annottext">VMap
  VB VB (KeyHash 'StakePool (Crypto era)) (PoolParams (Crypto era))
</span><a href="#local-6989586621679473264"><span class="hs-identifier hs-var">poolParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SnapShots (Crypto era) -&gt; SnapShot (Crypto era)
forall crypto. SnapShots crypto -&gt; SnapShot crypto
</span><a href="Cardano.Ledger.Shelley.EpochBoundary.html#%24sel%3A_pstakeGo%3ASnapShots"><span class="hs-identifier hs-var hs-var">_pstakeGo</span></a></span><span> </span><span class="annot"><span class="annottext">SnapShots (Crypto era)
</span><a href="#local-6989586621679473273"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-1414"></span><span>      </span><span class="annot"><a href="#local-6989586621679473262"><span class="hs-identifier hs-type">numStakeCreds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679473261"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Rational</span></a></span><span>
</span><span id="line-1415"></span><span>      </span><span id="local-6989586621679473262"><span class="annot"><span class="annottext">numStakeCreds :: Rational
</span><a href="#local-6989586621679473262"><span class="hs-identifier hs-var hs-var">numStakeCreds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Rational
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VMap VB VP (Credential 'Staking (Crypto era)) (CompactForm Coin)
-&gt; Int
forall (kv :: * -&gt; *) k (vv :: * -&gt; *) v.
Vector kv k =&gt;
VMap kv vv k v -&gt; Int
</span><a href="../../../../vector-map/html/src"><span class="hs-identifier hs-var">VMap.size</span></a></span><span> </span><span class="annot"><span class="annottext">(VMap VB VP (Credential 'Staking (Crypto era)) (CompactForm Coin)
 -&gt; Int)
-&gt; VMap VB VP (Credential 'Staking (Crypto era)) (CompactForm Coin)
-&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Stake (Crypto era)
-&gt; VMap VB VP (Credential 'Staking (Crypto era)) (CompactForm Coin)
forall crypto.
Stake crypto
-&gt; VMap VB VP (Credential 'Staking crypto) (CompactForm Coin)
</span><a href="Cardano.Ledger.Shelley.EpochBoundary.html#%24sel%3AunStake%3AStake"><span class="hs-identifier hs-var hs-var">unStake</span></a></span><span> </span><span class="annot"><span class="annottext">Stake (Crypto era)
</span><a href="#local-6989586621679473266"><span class="hs-identifier hs-var">stake'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1416"></span><span>      </span><span id="local-6989586621679473261"><span class="annot"><span class="annottext">k :: Rational
</span><a href="#local-6989586621679473261"><span class="hs-identifier hs-var hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Rational
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679473267"><span class="hs-identifier hs-var">secparam</span></a></span><span>
</span><span id="line-1417"></span><span>
</span><span id="line-1418"></span><span>      </span><span class="hs-comment">-- We expect approximately 10k-many blocks to be produced each epoch.</span><span>
</span><span id="line-1419"></span><span>      </span><span class="hs-comment">-- The reward calculation begins (4k/f)-many slots into the epoch,</span><span>
</span><span id="line-1420"></span><span>      </span><span class="hs-comment">-- and we guarantee that it ends (2k/f)-many slots before the end</span><span>
</span><span id="line-1421"></span><span>      </span><span class="hs-comment">-- of the epoch (to allow tools such as db-sync to see the reward</span><span>
</span><span id="line-1422"></span><span>      </span><span class="hs-comment">-- values in advance of them being applied to the ledger state).</span><span>
</span><span id="line-1423"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-1424"></span><span>      </span><span class="hs-comment">-- Therefore to evenly space out the reward calculation, we divide</span><span>
</span><span id="line-1425"></span><span>      </span><span class="hs-comment">-- the number of stake credentials by 4k in order to determine how many</span><span>
</span><span id="line-1426"></span><span>      </span><span class="hs-comment">-- stake credential rewards we should calculate each block.</span><span>
</span><span id="line-1427"></span><span>      </span><span class="hs-comment">-- If it does not finish in this amount of time, the calculation is</span><span>
</span><span id="line-1428"></span><span>      </span><span class="hs-comment">-- forced to completion.</span><span>
</span><span id="line-1429"></span><span>      </span><span id="local-6989586621679473258"><span class="annot"><span class="annottext">pulseSize :: Int
</span><a href="#local-6989586621679473258"><span class="hs-identifier hs-var hs-var">pulseSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">max</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rational -&gt; Int
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">ceiling</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621679473262"><span class="hs-identifier hs-var">numStakeCreds</span></a></span><span> </span><span class="annot"><span class="annottext">Rational -&gt; Rational -&gt; Rational
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">/</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rational
</span><span class="hs-number">4</span></span><span> </span><span class="annot"><span class="annottext">Rational -&gt; Rational -&gt; Rational
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621679473261"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1430"></span><span>
</span><span id="line-1431"></span><span>      </span><span class="hs-comment">-- We now compute the amount of total rewards that can potentially be given</span><span>
</span><span id="line-1432"></span><span>      </span><span class="hs-comment">-- out this epoch, and the adjustments to the reserves and the treasury.</span><span>
</span><span id="line-1433"></span><span>      </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span id="local-6989586621679473254"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473254"><span class="hs-identifier hs-var">reserves</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AccountState -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_reserves"><span class="hs-identifier hs-var hs-var">_reserves</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473274"><span class="hs-identifier hs-var">acnt</span></a></span><span>
</span><span id="line-1434"></span><span>      </span><span id="local-6989586621679473253"><span class="annot"><span class="annottext">ds :: DState (Crypto era)
</span><a href="#local-6989586621679473253"><span class="hs-identifier hs-var hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DPState (Crypto era) -&gt; DState (Crypto era)
forall crypto. DPState crypto -&gt; DState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#dpsDState"><span class="hs-identifier hs-var hs-var">dpsDState</span></a></span><span> </span><span class="annot"><span class="annottext">(DPState (Crypto era) -&gt; DState (Crypto era))
-&gt; DPState (Crypto era) -&gt; DState (Crypto era)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era -&gt; DPState (Crypto era)
forall era. LedgerState era -&gt; DPState (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#lsDPState"><span class="hs-identifier hs-var hs-var">lsDPState</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473272"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-1435"></span><span>      </span><span class="hs-comment">-- reserves and rewards change</span><span>
</span><span id="line-1436"></span><span>      </span><span id="local-6989586621679473252"><span class="annot"><span class="annottext">deltaR1 :: Coin
</span><a href="#local-6989586621679473252"><span class="hs-identifier hs-var hs-var">deltaR1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1437"></span><span>        </span><span class="annot"><span class="annottext">Rational -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">rationalToCoinViaFloor</span></a></span><span> </span><span class="annot"><span class="annottext">(Rational -&gt; Coin) -&gt; Rational -&gt; Coin
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1438"></span><span>          </span><span class="annot"><span class="annottext">Rational -&gt; Rational -&gt; Rational
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">min</span></a></span><span> </span><span class="annot"><span class="annottext">Rational
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621679473250"><span class="hs-identifier hs-var">eta</span></a></span><span>
</span><span id="line-1439"></span><span>            </span><span class="annot"><span class="annottext">Rational -&gt; Rational -&gt; Rational
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">UnitInterval -&gt; Rational
forall r. BoundedRational r =&gt; r -&gt; Rational
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">unboundRational</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PParams era -&gt; UnitInterval
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;_rho&quot;</span></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473271"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1440"></span><span>            </span><span class="annot"><span class="annottext">Rational -&gt; Rational -&gt; Rational
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Rational
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473254"><span class="hs-identifier hs-var">reserves</span></a></span><span>
</span><span id="line-1441"></span><span>      </span><span id="local-6989586621679473248"><span class="annot"><span class="annottext">d :: Rational
</span><a href="#local-6989586621679473248"><span class="hs-identifier hs-var hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnitInterval -&gt; Rational
forall r. BoundedRational r =&gt; r -&gt; Rational
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">unboundRational</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PParams era -&gt; UnitInterval
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;_d&quot;</span></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473271"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1442"></span><span>      </span><span id="local-6989586621679473247"><span class="annot"><span class="annottext">expectedBlocks :: Integer
</span><a href="#local-6989586621679473247"><span class="hs-identifier hs-var hs-var">expectedBlocks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1443"></span><span>        </span><span class="annot"><span class="annottext">Rational -&gt; Integer
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">floor</span></a></span><span> </span><span class="annot"><span class="annottext">(Rational -&gt; Integer) -&gt; Rational -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1444"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rational
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Rational -&gt; Rational -&gt; Rational
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621679473248"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rational -&gt; Rational -&gt; Rational
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">PositiveUnitInterval -&gt; Rational
forall r. BoundedRational r =&gt; r -&gt; Rational
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">unboundRational</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ActiveSlotCoeff -&gt; PositiveUnitInterval
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">activeSlotVal</span></a></span><span> </span><span class="annot"><span class="annottext">ActiveSlotCoeff
</span><a href="#local-6989586621679473268"><span class="hs-identifier hs-var">asc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rational -&gt; Rational -&gt; Rational
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">EpochSize -&gt; Rational
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">EpochSize
</span><a href="#local-6989586621679473279"><span class="hs-identifier hs-var">slotsPerEpoch</span></a></span><span>
</span><span id="line-1445"></span><span>      </span><span class="hs-comment">-- TODO asc is a global constant, and slotsPerEpoch should not change often at all,</span><span>
</span><span id="line-1446"></span><span>      </span><span class="hs-comment">-- it would be nice to not have to compute expectedBlocks every epoch</span><span>
</span><span id="line-1447"></span><span>      </span><span id="local-6989586621679473245"><span class="annot"><span class="annottext">blocksMade :: Integer
</span><a href="#local-6989586621679473245"><span class="hs-identifier hs-var hs-var">blocksMade</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; Integer) -&gt; Natural -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; Natural -&gt; Natural)
-&gt; Natural
-&gt; Map (KeyHash 'StakePool (Crypto era)) Natural
-&gt; Natural
forall a b k. (a -&gt; b -&gt; b) -&gt; b -&gt; Map k a -&gt; b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.foldr</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">(+)</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool (Crypto era)) Natural
</span><a href="#local-6989586621679473276"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-1448"></span><span>      </span><span id="local-6989586621679473250"><span class="annot"><span class="annottext">eta :: Rational
</span><a href="#local-6989586621679473250"><span class="hs-identifier hs-var hs-var">eta</span></a></span></span><span>
</span><span id="line-1449"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UnitInterval -&gt; Rational
forall r. BoundedRational r =&gt; r -&gt; Rational
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">unboundRational</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PParams era -&gt; UnitInterval
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;_d&quot;</span></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473271"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rational -&gt; Rational -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Rational
</span><span class="hs-number">0.8</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rational
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1450"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473245"><span class="hs-identifier hs-var">blocksMade</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Rational
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">%</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473247"><span class="hs-identifier hs-var">expectedBlocks</span></a></span><span>
</span><span id="line-1451"></span><span>      </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span id="local-6989586621679473243"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473243"><span class="hs-identifier hs-var">rPot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SnapShots (Crypto era) -&gt; Coin
forall crypto. SnapShots crypto -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.EpochBoundary.html#%24sel%3A_feeSS%3ASnapShots"><span class="hs-identifier hs-var hs-var">_feeSS</span></a></span><span> </span><span class="annot"><span class="annottext">SnapShots (Crypto era)
</span><a href="#local-6989586621679473273"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473252"><span class="hs-identifier hs-var">deltaR1</span></a></span><span>
</span><span id="line-1452"></span><span>      </span><span id="local-6989586621679473241"><span class="annot"><span class="annottext">deltaT1 :: Integer
</span><a href="#local-6989586621679473241"><span class="hs-identifier hs-var hs-var">deltaT1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rational -&gt; Integer
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">floor</span></a></span><span> </span><span class="annot"><span class="annottext">(Rational -&gt; Integer) -&gt; Rational -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">UnitInterval -&gt; Rational
forall r. BoundedRational r =&gt; r -&gt; Rational
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">unboundRational</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PParams era -&gt; UnitInterval
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;_tau&quot;</span></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473271"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rational -&gt; Rational -&gt; Rational
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Rational
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473243"><span class="hs-identifier hs-var">rPot</span></a></span><span>
</span><span id="line-1453"></span><span>      </span><span id="local-6989586621679473240"><span class="annot"><span class="annottext">_R :: Coin
</span><a href="#local-6989586621679473240"><span class="hs-identifier hs-var hs-var">_R</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Coin) -&gt; Integer -&gt; Coin
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473243"><span class="hs-identifier hs-var">rPot</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473241"><span class="hs-identifier hs-var">deltaT1</span></a></span><span>
</span><span id="line-1454"></span><span>
</span><span id="line-1455"></span><span>      </span><span class="hs-comment">-- We now compute stake pool specific values that are needed for computing</span><span>
</span><span id="line-1456"></span><span>      </span><span class="hs-comment">-- member and leader rewards.</span><span>
</span><span id="line-1457"></span><span>      </span><span id="local-6989586621679473239"><span class="annot"><span class="annottext">activestake :: Coin
</span><a href="#local-6989586621679473239"><span class="hs-identifier hs-var hs-var">activestake</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stake (Crypto era) -&gt; Coin
forall crypto. Stake crypto -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.EpochBoundary.html#sumAllStake"><span class="hs-identifier hs-var">sumAllStake</span></a></span><span> </span><span class="annot"><span class="annottext">Stake (Crypto era)
</span><a href="#local-6989586621679473266"><span class="hs-identifier hs-var">stake'</span></a></span><span>
</span><span id="line-1458"></span><span>      </span><span id="local-6989586621679473238"><span class="annot"><span class="annottext">totalStake :: Coin
</span><a href="#local-6989586621679473238"><span class="hs-identifier hs-var hs-var">totalStake</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochState era -&gt; Coin -&gt; Coin
forall era. EpochState era -&gt; Coin -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#circulation"><span class="hs-identifier hs-var">circulation</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473275"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473269"><span class="hs-identifier hs-var">maxSupply</span></a></span><span>
</span><span id="line-1459"></span><span>      </span><span id="local-6989586621679473237"><span class="annot"><span class="annottext">stakePerPool :: Map (KeyHash 'StakePool (Crypto era)) Coin
</span><a href="#local-6989586621679473237"><span class="hs-identifier hs-var hs-var">stakePerPool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VMap
  VB
  VB
  (Credential 'Staking (Crypto era))
  (KeyHash 'StakePool (Crypto era))
-&gt; Stake (Crypto era) -&gt; Map (KeyHash 'StakePool (Crypto era)) Coin
forall crypto.
VMap VB VB (Credential 'Staking crypto) (KeyHash 'StakePool crypto)
-&gt; Stake crypto -&gt; Map (KeyHash 'StakePool crypto) Coin
</span><a href="Cardano.Ledger.Shelley.EpochBoundary.html#sumStakePerPool"><span class="hs-identifier hs-var">sumStakePerPool</span></a></span><span> </span><span class="annot"><span class="annottext">VMap
  VB
  VB
  (Credential 'Staking (Crypto era))
  (KeyHash 'StakePool (Crypto era))
</span><a href="#local-6989586621679473265"><span class="hs-identifier hs-var">delegs'</span></a></span><span> </span><span class="annot"><span class="annottext">Stake (Crypto era)
</span><a href="#local-6989586621679473266"><span class="hs-identifier hs-var">stake'</span></a></span><span>
</span><span id="line-1460"></span><span>      </span><span id="local-6989586621679473236"><span class="annot"><span class="annottext">mkPoolRewardInfoCurry :: PoolParams (Crypto era)
-&gt; Either StakeShare (PoolRewardInfo (Crypto era))
</span><a href="#local-6989586621679473236"><span class="hs-identifier hs-var hs-var">mkPoolRewardInfoCurry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1461"></span><span>        </span><span class="annot"><span class="annottext">PParams era
-&gt; Coin
-&gt; BlocksMade (Crypto era)
-&gt; Natural
-&gt; Stake (Crypto era)
-&gt; VMap
     VB
     VB
     (Credential 'Staking (Crypto era))
     (KeyHash 'StakePool (Crypto era))
-&gt; Map (KeyHash 'StakePool (Crypto era)) Coin
-&gt; Coin
-&gt; Coin
-&gt; PoolParams (Crypto era)
-&gt; Either StakeShare (PoolRewardInfo (Crypto era))
forall era.
(HasField &quot;_d&quot; (PParams era) UnitInterval,
 HasField &quot;_a0&quot; (PParams era) NonNegativeInterval,
 HasField &quot;_nOpt&quot; (PParams era) Natural) =&gt;
PParams era
-&gt; Coin
-&gt; BlocksMade (Crypto era)
-&gt; Natural
-&gt; Stake (Crypto era)
-&gt; VMap
     VB
     VB
     (Credential 'Staking (Crypto era))
     (KeyHash 'StakePool (Crypto era))
-&gt; Map (KeyHash 'StakePool (Crypto era)) Coin
-&gt; Coin
-&gt; Coin
-&gt; PoolParams (Crypto era)
-&gt; Either StakeShare (PoolRewardInfo (Crypto era))
</span><a href="Cardano.Ledger.Shelley.Rewards.html#mkPoolRewardInfo"><span class="hs-identifier hs-var">mkPoolRewardInfo</span></a></span><span>
</span><span id="line-1462"></span><span>          </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473271"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-1463"></span><span>          </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473240"><span class="hs-identifier hs-var">_R</span></a></span><span>
</span><span id="line-1464"></span><span>          </span><span class="annot"><span class="annottext">BlocksMade (Crypto era)
</span><a href="#local-6989586621679473278"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1465"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Natural
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473245"><span class="hs-identifier hs-var">blocksMade</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1466"></span><span>          </span><span class="annot"><span class="annottext">Stake (Crypto era)
</span><a href="#local-6989586621679473266"><span class="hs-identifier hs-var">stake'</span></a></span><span>
</span><span id="line-1467"></span><span>          </span><span class="annot"><span class="annottext">VMap
  VB
  VB
  (Credential 'Staking (Crypto era))
  (KeyHash 'StakePool (Crypto era))
</span><a href="#local-6989586621679473265"><span class="hs-identifier hs-var">delegs'</span></a></span><span>
</span><span id="line-1468"></span><span>          </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool (Crypto era)) Coin
</span><a href="#local-6989586621679473237"><span class="hs-identifier hs-var">stakePerPool</span></a></span><span>
</span><span id="line-1469"></span><span>          </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473238"><span class="hs-identifier hs-var">totalStake</span></a></span><span>
</span><span id="line-1470"></span><span>          </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473239"><span class="hs-identifier hs-var">activestake</span></a></span><span>
</span><span id="line-1471"></span><span>
</span><span id="line-1472"></span><span>      </span><span class="hs-comment">-- We map over the registered stake pools to compute the revelant</span><span>
</span><span id="line-1473"></span><span>      </span><span class="hs-comment">-- stake pool specific values.</span><span>
</span><span id="line-1474"></span><span>      </span><span id="local-6989586621679473235"><span class="annot"><span class="annottext">allPoolInfo :: VMap
  VB
  VB
  (KeyHash 'StakePool (Crypto era))
  (Either StakeShare (PoolRewardInfo (Crypto era)))
</span><a href="#local-6989586621679473235"><span class="hs-identifier hs-var hs-var">allPoolInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PoolParams (Crypto era)
 -&gt; Either StakeShare (PoolRewardInfo (Crypto era)))
-&gt; VMap
     VB VB (KeyHash 'StakePool (Crypto era)) (PoolParams (Crypto era))
-&gt; VMap
     VB
     VB
     (KeyHash 'StakePool (Crypto era))
     (Either StakeShare (PoolRewardInfo (Crypto era)))
forall (vv :: * -&gt; *) a b (kv :: * -&gt; *) k.
(Vector vv a, Vector vv b) =&gt;
(a -&gt; b) -&gt; VMap kv vv k a -&gt; VMap kv vv k b
</span><a href="../../../../vector-map/html/src"><span class="hs-identifier hs-var">VMap.map</span></a></span><span> </span><span class="annot"><span class="annottext">PoolParams (Crypto era)
-&gt; Either StakeShare (PoolRewardInfo (Crypto era))
</span><a href="#local-6989586621679473236"><span class="hs-identifier hs-var">mkPoolRewardInfoCurry</span></a></span><span> </span><span class="annot"><span class="annottext">VMap
  VB VB (KeyHash 'StakePool (Crypto era)) (PoolParams (Crypto era))
</span><a href="#local-6989586621679473264"><span class="hs-identifier hs-var">poolParams</span></a></span><span>
</span><span id="line-1475"></span><span>
</span><span id="line-1476"></span><span>      </span><span class="hs-comment">-- Stake pools that do not produce any blocks get no rewards,</span><span>
</span><span id="line-1477"></span><span>      </span><span class="hs-comment">-- but some information is still needed from non-block-producing</span><span>
</span><span id="line-1478"></span><span>      </span><span class="hs-comment">-- pools for the ranking algorithm used by the wallets.</span><span>
</span><span id="line-1479"></span><span>      </span><span id="local-6989586621679473233"><span class="annot"><span class="annottext">blockProducingPoolInfo :: Map (KeyHash 'StakePool (Crypto era)) (PoolRewardInfo (Crypto era))
</span><a href="#local-6989586621679473233"><span class="hs-identifier hs-var hs-var">blockProducingPoolInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VMap
  VB
  VB
  (KeyHash 'StakePool (Crypto era))
  (PoolRewardInfo (Crypto era))
-&gt; Map
     (KeyHash 'StakePool (Crypto era)) (PoolRewardInfo (Crypto era))
forall (kv :: * -&gt; *) k (vv :: * -&gt; *) v.
(Vector kv k, Vector vv v) =&gt;
VMap kv vv k v -&gt; Map k v
</span><a href="../../../../vector-map/html/src"><span class="hs-identifier hs-var">VMap.toMap</span></a></span><span> </span><span class="annot"><span class="annottext">(VMap
   VB
   VB
   (KeyHash 'StakePool (Crypto era))
   (PoolRewardInfo (Crypto era))
 -&gt; Map
      (KeyHash 'StakePool (Crypto era)) (PoolRewardInfo (Crypto era)))
-&gt; VMap
     VB
     VB
     (KeyHash 'StakePool (Crypto era))
     (PoolRewardInfo (Crypto era))
-&gt; Map
     (KeyHash 'StakePool (Crypto era)) (PoolRewardInfo (Crypto era))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Either StakeShare (PoolRewardInfo (Crypto era))
 -&gt; Maybe (PoolRewardInfo (Crypto era)))
-&gt; VMap
     VB
     VB
     (KeyHash 'StakePool (Crypto era))
     (Either StakeShare (PoolRewardInfo (Crypto era)))
-&gt; VMap
     VB
     VB
     (KeyHash 'StakePool (Crypto era))
     (PoolRewardInfo (Crypto era))
forall (kv :: * -&gt; *) k (vv :: * -&gt; *) a b.
(Vector kv k, Vector vv a, Vector vv b) =&gt;
(a -&gt; Maybe b) -&gt; VMap kv vv k a -&gt; VMap kv vv k b
</span><a href="../../../../vector-map/html/src"><span class="hs-identifier hs-var">VMap.mapMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StakeShare -&gt; Maybe (PoolRewardInfo (Crypto era)))
-&gt; (PoolRewardInfo (Crypto era)
    -&gt; Maybe (PoolRewardInfo (Crypto era)))
-&gt; Either StakeShare (PoolRewardInfo (Crypto era))
-&gt; Maybe (PoolRewardInfo (Crypto era))
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (PoolRewardInfo (Crypto era))
-&gt; StakeShare -&gt; Maybe (PoolRewardInfo (Crypto era))
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PoolRewardInfo (Crypto era))
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PoolRewardInfo (Crypto era) -&gt; Maybe (PoolRewardInfo (Crypto era))
forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VMap
  VB
  VB
  (KeyHash 'StakePool (Crypto era))
  (Either StakeShare (PoolRewardInfo (Crypto era)))
</span><a href="#local-6989586621679473235"><span class="hs-identifier hs-var">allPoolInfo</span></a></span><span>
</span><span id="line-1480"></span><span>
</span><span id="line-1481"></span><span>      </span><span id="local-6989586621679473229"><span class="annot"><span class="annottext">getSigma :: PoolRewardInfo crypto -&gt; Rational
</span><a href="#local-6989586621679473229"><span class="hs-identifier hs-var hs-var">getSigma</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StakeShare -&gt; Rational
</span><a href="Cardano.Ledger.Shelley.Rewards.html#unStakeShare"><span class="hs-identifier hs-var hs-var">unStakeShare</span></a></span><span> </span><span class="annot"><span class="annottext">(StakeShare -&gt; Rational)
-&gt; (PoolRewardInfo crypto -&gt; StakeShare)
-&gt; PoolRewardInfo crypto
-&gt; Rational
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRewardInfo crypto -&gt; StakeShare
forall crypto. PoolRewardInfo crypto -&gt; StakeShare
</span><a href="Cardano.Ledger.Shelley.Rewards.html#poolRelativeStake"><span class="hs-identifier hs-var hs-var">poolRelativeStake</span></a></span><span>
</span><span id="line-1482"></span><span>      </span><span id="local-6989586621679473226"><span class="annot"><span class="annottext">makeLikelihoods :: Either StakeShare (PoolRewardInfo (Crypto era)) -&gt; Likelihood
</span><a href="#local-6989586621679473226"><span class="hs-identifier hs-var hs-var">makeLikelihoods</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1483"></span><span>        </span><span class="hs-comment">-- This pool produced no blocks this epoch</span><span>
</span><span id="line-1484"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.Rewards.html#StakeShare"><span class="hs-identifier hs-type">StakeShare</span></a></span><span> </span><span id="local-6989586621679473224"><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621679473224"><span class="hs-identifier hs-var">sigma</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1485"></span><span>          </span><span class="annot"><span class="annottext">Natural -&gt; Double -&gt; EpochSize -&gt; Likelihood
</span><a href="Cardano.Ledger.Shelley.PoolRank.html#likelihood"><span class="hs-identifier hs-var">likelihood</span></a></span><span>
</span><span id="line-1486"></span><span>            </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1487"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ActiveSlotCoeff -&gt; Rational -&gt; UnitInterval -&gt; Double
</span><a href="Cardano.Ledger.Shelley.PoolRank.html#leaderProbability"><span class="hs-identifier hs-var">leaderProbability</span></a></span><span> </span><span class="annot"><span class="annottext">ActiveSlotCoeff
</span><a href="#local-6989586621679473268"><span class="hs-identifier hs-var">asc</span></a></span><span> </span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621679473224"><span class="hs-identifier hs-var">sigma</span></a></span><span> </span><span class="annot"><span class="annottext">(UnitInterval -&gt; Double) -&gt; UnitInterval -&gt; Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era -&gt; UnitInterval
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;_d&quot;</span></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473271"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1488"></span><span>            </span><span class="annot"><span class="annottext">EpochSize
</span><a href="#local-6989586621679473279"><span class="hs-identifier hs-var">slotsPerEpoch</span></a></span><span>
</span><span id="line-1489"></span><span>        </span><span class="hs-comment">-- This pool produced at least one block this epoch</span><span>
</span><span id="line-1490"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679473223"><span class="annot"><span class="annottext">PoolRewardInfo (Crypto era)
</span><a href="#local-6989586621679473223"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1491"></span><span>          </span><span class="annot"><span class="annottext">Natural -&gt; Double -&gt; EpochSize -&gt; Likelihood
</span><a href="Cardano.Ledger.Shelley.PoolRank.html#likelihood"><span class="hs-identifier hs-var">likelihood</span></a></span><span>
</span><span id="line-1492"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolRewardInfo (Crypto era) -&gt; Natural
forall crypto. PoolRewardInfo crypto -&gt; Natural
</span><a href="Cardano.Ledger.Shelley.Rewards.html#poolBlocks"><span class="hs-identifier hs-var hs-var">poolBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRewardInfo (Crypto era)
</span><a href="#local-6989586621679473223"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1493"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ActiveSlotCoeff -&gt; Rational -&gt; UnitInterval -&gt; Double
</span><a href="Cardano.Ledger.Shelley.PoolRank.html#leaderProbability"><span class="hs-identifier hs-var">leaderProbability</span></a></span><span> </span><span class="annot"><span class="annottext">ActiveSlotCoeff
</span><a href="#local-6989586621679473268"><span class="hs-identifier hs-var">asc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolRewardInfo (Crypto era) -&gt; Rational
forall crypto. PoolRewardInfo crypto -&gt; Rational
</span><a href="#local-6989586621679473229"><span class="hs-identifier hs-var">getSigma</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRewardInfo (Crypto era)
</span><a href="#local-6989586621679473223"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UnitInterval -&gt; Double) -&gt; UnitInterval -&gt; Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era -&gt; UnitInterval
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;_d&quot;</span></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473271"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1494"></span><span>            </span><span class="annot"><span class="annottext">EpochSize
</span><a href="#local-6989586621679473279"><span class="hs-identifier hs-var">slotsPerEpoch</span></a></span><span>
</span><span id="line-1495"></span><span>      </span><span id="local-6989586621679473221"><span class="annot"><span class="annottext">newLikelihoods :: Map (KeyHash 'StakePool (Crypto era)) Likelihood
</span><a href="#local-6989586621679473221"><span class="hs-identifier hs-var hs-var">newLikelihoods</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VMap VB VB (KeyHash 'StakePool (Crypto era)) Likelihood
-&gt; Map (KeyHash 'StakePool (Crypto era)) Likelihood
forall (kv :: * -&gt; *) k (vv :: * -&gt; *) v.
(Vector kv k, Vector vv v) =&gt;
VMap kv vv k v -&gt; Map k v
</span><a href="../../../../vector-map/html/src"><span class="hs-identifier hs-var">VMap.toMap</span></a></span><span> </span><span class="annot"><span class="annottext">(VMap VB VB (KeyHash 'StakePool (Crypto era)) Likelihood
 -&gt; Map (KeyHash 'StakePool (Crypto era)) Likelihood)
-&gt; VMap VB VB (KeyHash 'StakePool (Crypto era)) Likelihood
-&gt; Map (KeyHash 'StakePool (Crypto era)) Likelihood
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Either StakeShare (PoolRewardInfo (Crypto era)) -&gt; Likelihood)
-&gt; VMap
     VB
     VB
     (KeyHash 'StakePool (Crypto era))
     (Either StakeShare (PoolRewardInfo (Crypto era)))
-&gt; VMap VB VB (KeyHash 'StakePool (Crypto era)) Likelihood
forall (vv :: * -&gt; *) a b (kv :: * -&gt; *) k.
(Vector vv a, Vector vv b) =&gt;
(a -&gt; b) -&gt; VMap kv vv k a -&gt; VMap kv vv k b
</span><a href="../../../../vector-map/html/src"><span class="hs-identifier hs-var">VMap.map</span></a></span><span> </span><span class="annot"><span class="annottext">Either StakeShare (PoolRewardInfo (Crypto era)) -&gt; Likelihood
</span><a href="#local-6989586621679473226"><span class="hs-identifier hs-var">makeLikelihoods</span></a></span><span> </span><span class="annot"><span class="annottext">VMap
  VB
  VB
  (KeyHash 'StakePool (Crypto era))
  (Either StakeShare (PoolRewardInfo (Crypto era)))
</span><a href="#local-6989586621679473235"><span class="hs-identifier hs-var">allPoolInfo</span></a></span><span>
</span><span id="line-1496"></span><span>
</span><span id="line-1497"></span><span>      </span><span class="hs-comment">-- We now compute the leader rewards for each stake pool.</span><span>
</span><span id="line-1498"></span><span>      </span><span id="local-6989586621679473220"><span class="annot"><span class="annottext">collectLRs :: Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
-&gt; PoolRewardInfo (Crypto era)
-&gt; Map
     (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473220"><span class="hs-identifier hs-var hs-var">collectLRs</span></a></span></span><span> </span><span id="local-6989586621679473219"><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473219"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621679473218"><span class="annot"><span class="annottext">PoolRewardInfo (Crypto era)
</span><a href="#local-6989586621679473218"><span class="hs-identifier hs-var">poolRI</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1499"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473217"><span class="annot"><span class="annottext">rewardAcnt :: Credential 'Staking (Crypto era)
</span><a href="#local-6989586621679473217"><span class="hs-identifier hs-var hs-var">rewardAcnt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewardAcnt (Crypto era) -&gt; Credential 'Staking (Crypto era)
forall crypto. RewardAcnt crypto -&gt; Credential 'Staking crypto
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var hs-var">getRwdCred</span></a></span><span> </span><span class="annot"><span class="annottext">(RewardAcnt (Crypto era) -&gt; Credential 'Staking (Crypto era))
-&gt; (PoolRewardInfo (Crypto era) -&gt; RewardAcnt (Crypto era))
-&gt; PoolRewardInfo (Crypto era)
-&gt; Credential 'Staking (Crypto era)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">PoolParams (Crypto era) -&gt; RewardAcnt (Crypto era)
forall crypto. PoolParams crypto -&gt; RewardAcnt crypto
</span><a href="Cardano.Ledger.Shelley.TxBody.html#_poolRAcnt"><span class="hs-identifier hs-var hs-var">_poolRAcnt</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolParams (Crypto era) -&gt; RewardAcnt (Crypto era))
-&gt; (PoolRewardInfo (Crypto era) -&gt; PoolParams (Crypto era))
-&gt; PoolRewardInfo (Crypto era)
-&gt; RewardAcnt (Crypto era)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRewardInfo (Crypto era) -&gt; PoolParams (Crypto era)
forall crypto. PoolRewardInfo crypto -&gt; PoolParams crypto
</span><a href="Cardano.Ledger.Shelley.Rewards.html#poolPs"><span class="hs-identifier hs-var hs-var">poolPs</span></a></span><span> </span><span class="annot"><span class="annottext">(PoolRewardInfo (Crypto era) -&gt; Credential 'Staking (Crypto era))
-&gt; PoolRewardInfo (Crypto era) -&gt; Credential 'Staking (Crypto era)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRewardInfo (Crypto era)
</span><a href="#local-6989586621679473218"><span class="hs-identifier hs-var">poolRI</span></a></span><span>
</span><span id="line-1500"></span><span>            </span><span id="local-6989586621679473214"><span class="annot"><span class="annottext">packageLeaderReward :: PoolRewardInfo c -&gt; Set (Reward c)
</span><a href="#local-6989586621679473214"><span class="hs-identifier hs-var hs-var">packageLeaderReward</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reward c -&gt; Set (Reward c)
forall a. a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.singleton</span></a></span><span> </span><span class="annot"><span class="annottext">(Reward c -&gt; Set (Reward c))
-&gt; (PoolRewardInfo c -&gt; Reward c)
-&gt; PoolRewardInfo c
-&gt; Set (Reward c)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">LeaderOnlyReward c -&gt; Reward c
forall c. LeaderOnlyReward c -&gt; Reward c
</span><a href="Cardano.Ledger.Shelley.Rewards.html#leaderRewardToGeneral"><span class="hs-identifier hs-var">leaderRewardToGeneral</span></a></span><span> </span><span class="annot"><span class="annottext">(LeaderOnlyReward c -&gt; Reward c)
-&gt; (PoolRewardInfo c -&gt; LeaderOnlyReward c)
-&gt; PoolRewardInfo c
-&gt; Reward c
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRewardInfo c -&gt; LeaderOnlyReward c
forall crypto. PoolRewardInfo crypto -&gt; LeaderOnlyReward crypto
</span><a href="Cardano.Ledger.Shelley.Rewards.html#poolLeaderReward"><span class="hs-identifier hs-var hs-var">poolLeaderReward</span></a></span><span>
</span><span id="line-1501"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">PParams era -&gt; Bool
forall pp. HasField &quot;_protocolVersion&quot; pp ProtVer =&gt; pp -&gt; Bool
</span><a href="Cardano.Ledger.Shelley.HardForks.html#forgoRewardPrefilter"><span class="hs-identifier hs-var">HardForks.forgoRewardPrefilter</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473271"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking (Crypto era)
</span><a href="#local-6989586621679473217"><span class="hs-identifier hs-var">rewardAcnt</span></a></span><span> </span><span class="annot"><span class="annottext">Credential 'Staking (Crypto era)
-&gt; View
     Coin
     (Credential 'Staking (Crypto era))
     (KeyHash 'StakePool (Crypto era))
     Ptr
     (Credential 'Staking (Crypto era))
     Coin
-&gt; Bool
forall cr ptr k coin pool v.
(Ord cr, Ord ptr) =&gt;
k -&gt; View coin cr pool ptr k v -&gt; Bool
</span><a href="../../../../cardano-data/html/src"><span class="hs-operator hs-var">`UM.member`</span></a></span><span> </span><span class="annot"><span class="annottext">DState (Crypto era)
-&gt; View
     Coin
     (Credential 'Staking (Crypto era))
     (KeyHash 'StakePool (Crypto era))
     Ptr
     (Credential 'Staking (Crypto era))
     Coin
forall crypto.
DState crypto -&gt; ViewMap crypto (Credential 'Staking crypto) Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#rewards"><span class="hs-identifier hs-var">rewards</span></a></span><span> </span><span class="annot"><span class="annottext">DState (Crypto era)
</span><a href="#local-6989586621679473253"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-1502"></span><span>              </span><span class="hs-keyword">then</span><span>
</span><span id="line-1503"></span><span>                </span><span class="annot"><span class="annottext">(Set (Reward (Crypto era))
 -&gt; Set (Reward (Crypto era)) -&gt; Set (Reward (Crypto era)))
-&gt; Credential 'Staking (Crypto era)
-&gt; Set (Reward (Crypto era))
-&gt; Map
     (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
-&gt; Map
     (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.insertWith</span></a></span><span>
</span><span id="line-1504"></span><span>                  </span><span class="annot"><span class="annottext">Set (Reward (Crypto era))
-&gt; Set (Reward (Crypto era)) -&gt; Set (Reward (Crypto era))
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span>
</span><span id="line-1505"></span><span>                  </span><span class="annot"><span class="annottext">Credential 'Staking (Crypto era)
</span><a href="#local-6989586621679473217"><span class="hs-identifier hs-var">rewardAcnt</span></a></span><span>
</span><span id="line-1506"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PoolRewardInfo (Crypto era) -&gt; Set (Reward (Crypto era))
forall c. PoolRewardInfo c -&gt; Set (Reward c)
</span><a href="#local-6989586621679473214"><span class="hs-identifier hs-var">packageLeaderReward</span></a></span><span> </span><span class="annot"><span class="annottext">PoolRewardInfo (Crypto era)
</span><a href="#local-6989586621679473218"><span class="hs-identifier hs-var">poolRI</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1507"></span><span>                  </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473219"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1508"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473219"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1509"></span><span>
</span><span id="line-1510"></span><span>      </span><span class="hs-comment">-- The data in 'RewardSnapShot' will be used to finish up the reward calculation</span><span>
</span><span id="line-1511"></span><span>      </span><span class="hs-comment">-- once all the member rewards are complete.</span><span>
</span><span id="line-1512"></span><span>      </span><span id="local-6989586621679473209"><span class="annot"><span class="annottext">rewsnap :: RewardSnapShot (Crypto era)
</span><a href="#local-6989586621679473209"><span class="hs-identifier hs-var hs-var">rewsnap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1513"></span><span>        </span><span class="annot"><span class="annottext">RewardSnapShot :: forall crypto.
Coin
-&gt; ProtVer
-&gt; NonMyopic crypto
-&gt; Coin
-&gt; Coin
-&gt; Coin
-&gt; Map (KeyHash 'StakePool crypto) Likelihood
-&gt; Map (Credential 'Staking crypto) (Set (Reward crypto))
-&gt; RewardSnapShot crypto
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardSnapShot"><span class="hs-identifier hs-type">RewardSnapShot</span></a></span><span>
</span><span id="line-1514"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rewFees :: Coin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewFees"><span class="hs-identifier hs-var">rewFees</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SnapShots (Crypto era) -&gt; Coin
forall crypto. SnapShots crypto -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.EpochBoundary.html#%24sel%3A_feeSS%3ASnapShots"><span class="hs-identifier hs-var hs-var">_feeSS</span></a></span><span> </span><span class="annot"><span class="annottext">SnapShots (Crypto era)
</span><a href="#local-6989586621679473273"><span class="hs-identifier hs-var">ss</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1515"></span><span>            </span><span class="annot"><span class="annottext">rewprotocolVersion :: ProtVer
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewprotocolVersion"><span class="hs-identifier hs-var">rewprotocolVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PParams era -&gt; ProtVer
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;_protocolVersion&quot;</span></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473271"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1516"></span><span>            </span><span class="annot"><span class="annottext">rewNonMyopic :: NonMyopic (Crypto era)
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewNonMyopic"><span class="hs-identifier hs-var">rewNonMyopic</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonMyopic (Crypto era)
</span><a href="#local-6989586621679473270"><span class="hs-identifier hs-var">nm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1517"></span><span>            </span><span class="annot"><span class="annottext">rewDeltaR1 :: Coin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewDeltaR1"><span class="hs-identifier hs-var">rewDeltaR1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473252"><span class="hs-identifier hs-var">deltaR1</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1518"></span><span>            </span><span class="annot"><span class="annottext">rewR :: Coin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewR"><span class="hs-identifier hs-var">rewR</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473240"><span class="hs-identifier hs-var">_R</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1519"></span><span>            </span><span class="annot"><span class="annottext">rewDeltaT1 :: Coin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewDeltaT1"><span class="hs-identifier hs-var">rewDeltaT1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473241"><span class="hs-identifier hs-var">deltaT1</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1520"></span><span>            </span><span class="annot"><span class="annottext">rewLikelihoods :: Map (KeyHash 'StakePool (Crypto era)) Likelihood
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewLikelihoods"><span class="hs-identifier hs-var">rewLikelihoods</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool (Crypto era)) Likelihood
</span><a href="#local-6989586621679473221"><span class="hs-identifier hs-var">newLikelihoods</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1521"></span><span>            </span><span class="annot"><span class="annottext">rewLeaders :: Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewLeaders"><span class="hs-identifier hs-var">rewLeaders</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
 -&gt; PoolRewardInfo (Crypto era)
 -&gt; Map
      (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era))))
-&gt; Map
     (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
-&gt; Map
     (KeyHash 'StakePool (Crypto era)) (PoolRewardInfo (Crypto era))
-&gt; Map
     (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
forall a b k. (a -&gt; b -&gt; a) -&gt; a -&gt; Map k b -&gt; a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
-&gt; PoolRewardInfo (Crypto era)
-&gt; Map
     (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
</span><a href="#local-6989586621679473220"><span class="hs-identifier hs-var">collectLRs</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool (Crypto era)) (PoolRewardInfo (Crypto era))
</span><a href="#local-6989586621679473233"><span class="hs-identifier hs-var">blockProducingPoolInfo</span></a></span><span>
</span><span id="line-1522"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-1523"></span><span>
</span><span id="line-1524"></span><span>      </span><span class="hs-comment">-- The data in 'FreeVars' to supply individual stake pool members with</span><span>
</span><span id="line-1525"></span><span>      </span><span class="hs-comment">-- the neccessary information to compute their individual rewards.</span><span>
</span><span id="line-1526"></span><span>      </span><span id="local-6989586621679473199"><span class="annot"><span class="annottext">free :: FreeVars (Crypto era)
</span><a href="#local-6989586621679473199"><span class="hs-identifier hs-var hs-var">free</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1527"></span><span>        </span><span class="annot"><span class="annottext">VMap
  VB
  VB
  (Credential 'Staking (Crypto era))
  (KeyHash 'StakePool (Crypto era))
-&gt; Set (Credential 'Staking (Crypto era))
-&gt; Integer
-&gt; ProtVer
-&gt; Map
     (KeyHash 'StakePool (Crypto era)) (PoolRewardInfo (Crypto era))
-&gt; FreeVars (Crypto era)
forall crypto.
VMap VB VB (Credential 'Staking crypto) (KeyHash 'StakePool crypto)
-&gt; Set (Credential 'Staking crypto)
-&gt; Integer
-&gt; ProtVer
-&gt; Map (KeyHash 'StakePool crypto) (PoolRewardInfo crypto)
-&gt; FreeVars crypto
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#FreeVars"><span class="hs-identifier hs-var">FreeVars</span></a></span><span>
</span><span id="line-1528"></span><span>          </span><span class="annot"><span class="annottext">VMap
  VB
  VB
  (Credential 'Staking (Crypto era))
  (KeyHash 'StakePool (Crypto era))
</span><a href="#local-6989586621679473265"><span class="hs-identifier hs-var">delegs'</span></a></span><span>
</span><span id="line-1529"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">View
  Coin
  (Credential 'Staking (Crypto era))
  (KeyHash 'StakePool (Crypto era))
  Ptr
  (Credential 'Staking (Crypto era))
  Coin
-&gt; Set (Credential 'Staking (Crypto era))
forall cr coin pool ptr k v.
Ord cr =&gt;
View coin cr pool ptr k v -&gt; Set k
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">UM.domain</span></a></span><span> </span><span class="annot"><span class="annottext">(View
   Coin
   (Credential 'Staking (Crypto era))
   (KeyHash 'StakePool (Crypto era))
   Ptr
   (Credential 'Staking (Crypto era))
   Coin
 -&gt; Set (Credential 'Staking (Crypto era)))
-&gt; View
     Coin
     (Credential 'Staking (Crypto era))
     (KeyHash 'StakePool (Crypto era))
     Ptr
     (Credential 'Staking (Crypto era))
     Coin
-&gt; Set (Credential 'Staking (Crypto era))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DState (Crypto era)
-&gt; View
     Coin
     (Credential 'Staking (Crypto era))
     (KeyHash 'StakePool (Crypto era))
     Ptr
     (Credential 'Staking (Crypto era))
     Coin
forall crypto.
DState crypto -&gt; ViewMap crypto (Credential 'Staking crypto) Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#rewards"><span class="hs-identifier hs-var">rewards</span></a></span><span> </span><span class="annot"><span class="annottext">DState (Crypto era)
</span><a href="#local-6989586621679473253"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1530"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin -&gt; Integer
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var hs-var">unCoin</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473238"><span class="hs-identifier hs-var">totalStake</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1531"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PParams era -&gt; ProtVer
forall k (x :: k) r a. HasField x r a =&gt; r -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">getField</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;_protocolVersion&quot;</span></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473271"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1532"></span><span>          </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool (Crypto era)) (PoolRewardInfo (Crypto era))
</span><a href="#local-6989586621679473233"><span class="hs-identifier hs-var">blockProducingPoolInfo</span></a></span><span>
</span><span id="line-1533"></span><span>      </span><span class="annot"><a href="#local-6989586621679473195"><span class="hs-identifier hs-type">pulser</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Pulser"><span class="hs-identifier hs-type">Pulser</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474406"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1534"></span><span>      </span><span id="local-6989586621679473195"><span class="annot"><span class="annottext">pulser :: Pulser (Crypto era)
</span><a href="#local-6989586621679473195"><span class="hs-identifier hs-var hs-var">pulser</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1535"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; FreeVars (Crypto era)
-&gt; VMap VB VP (Credential 'Staking (Crypto era)) (CompactForm Coin)
-&gt; RewardAns (Crypto era)
-&gt; Pulser (Crypto era)
forall ans c (m :: * -&gt; *).
(ans ~ RewardAns c, m ~ ShelleyBase) =&gt;
Int
-&gt; FreeVars c
-&gt; VMap VB VP (Credential 'Staking c) (CompactForm Coin)
-&gt; ans
-&gt; RewardPulser c m ans
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RSLP"><span class="hs-identifier hs-var">RSLP</span></a></span><span>
</span><span id="line-1536"></span><span>          </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679473258"><span class="hs-identifier hs-var">pulseSize</span></a></span><span>
</span><span id="line-1537"></span><span>          </span><span class="annot"><span class="annottext">FreeVars (Crypto era)
</span><a href="#local-6989586621679473199"><span class="hs-identifier hs-var">free</span></a></span><span>
</span><span id="line-1538"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stake (Crypto era)
-&gt; VMap VB VP (Credential 'Staking (Crypto era)) (CompactForm Coin)
forall crypto.
Stake crypto
-&gt; VMap VB VP (Credential 'Staking crypto) (CompactForm Coin)
</span><a href="Cardano.Ledger.Shelley.EpochBoundary.html#%24sel%3AunStake%3AStake"><span class="hs-identifier hs-var hs-var">unStake</span></a></span><span> </span><span class="annot"><span class="annottext">Stake (Crypto era)
</span><a href="#local-6989586621679473266"><span class="hs-identifier hs-var">stake'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1539"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Reward (Crypto era))
-&gt; Map
     (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
-&gt; RewardAns (Crypto era)
forall c.
Map (Credential 'Staking c) (Reward c)
-&gt; RewardEvent c -&gt; RewardAns c
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardAns"><span class="hs-identifier hs-var">RewardAns</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Reward (Crypto era))
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking (Crypto era)) (Set (Reward (Crypto era)))
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1540"></span><span>      </span><span id="local-6989586621679473192"><span class="annot"><span class="annottext">provenance :: RewardProvenance (Crypto era)
</span><a href="#local-6989586621679473192"><span class="hs-identifier hs-var hs-var">provenance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1541"></span><span>        </span><span class="annot"><span class="annottext">RewardProvenance (Crypto era)
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span><span>
</span><span id="line-1542"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">spe :: Word64
</span><a href="Cardano.Ledger.Shelley.RewardProvenance.html#spe"><span class="hs-identifier hs-var">spe</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EpochSize
</span><a href="#local-6989586621679473279"><span class="hs-identifier hs-var">slotsPerEpoch</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">EpochSize</span></a></span><span> </span><span id="local-6989586621679473189"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679473189"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679473189"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1543"></span><span>            </span><span class="annot"><span class="annottext">blocks :: BlocksMade (Crypto era)
</span><a href="Cardano.Ledger.Shelley.RewardProvenance.html#blocks"><span class="hs-identifier hs-var">blocks</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlocksMade (Crypto era)
</span><a href="#local-6989586621679473278"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1544"></span><span>            </span><span class="annot"><span class="annottext">blocksCount :: Integer
</span><a href="Cardano.Ledger.Shelley.RewardProvenance.html#blocksCount"><span class="hs-identifier hs-var">blocksCount</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473245"><span class="hs-identifier hs-var">blocksMade</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1545"></span><span>            </span><span class="annot"><span class="annottext">maxLL :: Coin
</span><a href="Cardano.Ledger.Shelley.RewardProvenance.html#maxLL"><span class="hs-identifier hs-var">maxLL</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473269"><span class="hs-identifier hs-var">maxSupply</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1546"></span><span>            </span><span class="annot"><span class="annottext">deltaR1 :: Coin
</span><a href="Cardano.Ledger.Shelley.RewardProvenance.html#deltaR1"><span class="hs-identifier hs-var">deltaR1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473252"><span class="hs-identifier hs-var">deltaR1</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1547"></span><span>            </span><span class="annot"><span class="annottext">r :: Coin
</span><a href="Cardano.Ledger.Shelley.RewardProvenance.html#r"><span class="hs-identifier hs-var">RP.r</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473240"><span class="hs-identifier hs-var">_R</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1548"></span><span>            </span><span class="annot"><span class="annottext">totalStake :: Coin
</span><a href="Cardano.Ledger.Shelley.RewardProvenance.html#totalStake"><span class="hs-identifier hs-var">RP.totalStake</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473238"><span class="hs-identifier hs-var">totalStake</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1549"></span><span>            </span><span class="annot"><span class="annottext">activeStake :: Coin
</span><a href="Cardano.Ledger.Shelley.RewardProvenance.html#activeStake"><span class="hs-identifier hs-var">RP.activeStake</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473239"><span class="hs-identifier hs-var">activestake</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1550"></span><span>            </span><span class="annot"><span class="annottext">d :: Rational
</span><a href="Cardano.Ledger.Shelley.RewardProvenance.html#d"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621679473248"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1551"></span><span>            </span><span class="annot"><span class="annottext">expBlocks :: Integer
</span><a href="Cardano.Ledger.Shelley.RewardProvenance.html#expBlocks"><span class="hs-identifier hs-var">expBlocks</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473247"><span class="hs-identifier hs-var">expectedBlocks</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1552"></span><span>            </span><span class="annot"><span class="annottext">eta :: Rational
</span><a href="Cardano.Ledger.Shelley.RewardProvenance.html#eta"><span class="hs-identifier hs-var">eta</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621679473250"><span class="hs-identifier hs-var">eta</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1553"></span><span>            </span><span class="annot"><span class="annottext">rPot :: Coin
</span><a href="Cardano.Ledger.Shelley.RewardProvenance.html#rPot"><span class="hs-identifier hs-var">rPot</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473243"><span class="hs-identifier hs-var">rPot</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1554"></span><span>            </span><span class="annot"><span class="annottext">deltaT1 :: Coin
</span><a href="Cardano.Ledger.Shelley.RewardProvenance.html#deltaT1"><span class="hs-identifier hs-var">deltaT1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473241"><span class="hs-identifier hs-var">deltaT1</span></a></span><span>
</span><span id="line-1555"></span><span>            </span><span class="hs-comment">-- The reward provenance is in the process of being deprecated,</span><span>
</span><span id="line-1556"></span><span>            </span><span class="hs-comment">-- some fields are not populated anymore, such as the pool provenance</span><span>
</span><span id="line-1557"></span><span>            </span><span class="hs-comment">-- and the desireabilities.</span><span>
</span><span id="line-1558"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-1559"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewardSnapShot (Crypto era)
-&gt; Pulser (Crypto era) -&gt; PulsingRewUpdate (Crypto era)
forall crypto.
RewardSnapShot crypto -&gt; Pulser crypto -&gt; PulsingRewUpdate crypto
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Pulsing"><span class="hs-identifier hs-var">Pulsing</span></a></span><span> </span><span class="annot"><span class="annottext">RewardSnapShot (Crypto era)
</span><a href="#local-6989586621679473209"><span class="hs-identifier hs-var">rewsnap</span></a></span><span> </span><span class="annot"><span class="annottext">Pulser (Crypto era)
</span><a href="#local-6989586621679473195"><span class="hs-identifier hs-var">pulser</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewardProvenance (Crypto era)
</span><a href="#local-6989586621679473192"><span class="hs-identifier hs-var">provenance</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1560"></span><span>
</span><span id="line-1561"></span><span class="hs-comment">-- Phase 2</span><span>
</span><span id="line-1562"></span><span>
</span><span id="line-1563"></span><span class="hs-comment">-- | Run the pulser for a bit. If is has nothing left to do, complete it.</span><span>
</span><span id="line-1564"></span><span id="local-6989586621679473175"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#pulseStep"><span class="hs-identifier hs-type">pulseStep</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1565"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#PulsingRewUpdate"><span class="hs-identifier hs-type">PulsingRewUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473175"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1566"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ShelleyBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#PulsingRewUpdate"><span class="hs-identifier hs-type">PulsingRewUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473175"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardEvent"><span class="hs-identifier hs-type">RewardEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473175"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1567"></span><span id="pulseStep"><span class="annot"><span class="annottext">pulseStep :: PulsingRewUpdate crypto
-&gt; ShelleyBase (PulsingRewUpdate crypto, RewardEvent crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#pulseStep"><span class="hs-identifier hs-var hs-var">pulseStep</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Complete"><span class="hs-identifier hs-type">Complete</span></a></span><span> </span><span id="local-6989586621679473173"><span class="annot"><span class="annottext">RewardUpdate crypto
</span><a href="#local-6989586621679473173"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PulsingRewUpdate crypto, RewardEvent crypto)
-&gt; ShelleyBase (PulsingRewUpdate crypto, RewardEvent crypto)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewardUpdate crypto -&gt; PulsingRewUpdate crypto
forall crypto. RewardUpdate crypto -&gt; PulsingRewUpdate crypto
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Complete"><span class="hs-identifier hs-var">Complete</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate crypto
</span><a href="#local-6989586621679473173"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewardEvent crypto
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1568"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#pulseStep"><span class="hs-identifier hs-var">pulseStep</span></a></span><span> </span><span id="local-6989586621679473172"><span class="annot"><span class="annottext">p :: PulsingRewUpdate crypto
</span><a href="#local-6989586621679473172"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Pulsing"><span class="hs-identifier hs-type">Pulsing</span></a></span><span> </span><span class="annot"><span class="annottext">RewardSnapShot crypto
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679473171"><span class="annot"><span class="annottext">Pulser crypto
</span><a href="#local-6989586621679473171"><span class="hs-identifier hs-var">pulser</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Pulser crypto -&gt; Bool
forall (pulse :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) ans.
Pulsable pulse =&gt;
pulse m ans -&gt; Bool
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="annot"><span class="annottext">Pulser crypto
</span><a href="#local-6989586621679473171"><span class="hs-identifier hs-var">pulser</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PulsingRewUpdate crypto
-&gt; ShelleyBase (PulsingRewUpdate crypto, RewardEvent crypto)
forall crypto.
PulsingRewUpdate crypto
-&gt; ShelleyBase (PulsingRewUpdate crypto, RewardEvent crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#completeStep"><span class="hs-identifier hs-var">completeStep</span></a></span><span> </span><span class="annot"><span class="annottext">PulsingRewUpdate crypto
</span><a href="#local-6989586621679473172"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1569"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#pulseStep"><span class="hs-identifier hs-var">pulseStep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Pulsing"><span class="hs-identifier hs-type">Pulsing</span></a></span><span> </span><span id="local-6989586621679473169"><span class="annot"><span class="annottext">RewardSnapShot crypto
</span><a href="#local-6989586621679473169"><span class="hs-identifier hs-var">rewsnap</span></a></span></span><span> </span><span id="local-6989586621679473168"><span class="annot"><span class="annottext">Pulser crypto
</span><a href="#local-6989586621679473168"><span class="hs-identifier hs-var">pulser</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1570"></span><span>  </span><span class="hs-comment">-- The pulser might compute provenance, but using pulseM here does not compute it</span><span>
</span><span id="line-1571"></span><span>  </span><span id="local-6989586621679473167"><span class="annot"><span class="annottext">p2 :: Pulser crypto
</span><a href="#local-6989586621679473167"><span class="hs-identifier hs-var">p2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RSLP"><span class="hs-identifier hs-type">RSLP</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FreeVars crypto
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">VMap VB VP (Credential 'Staking crypto) (CompactForm Coin)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardAns"><span class="hs-identifier hs-type">RewardAns</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) (Reward crypto)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679473166"><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473166"><span class="hs-identifier hs-var">event</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pulser crypto -&gt; ShelleyBase (Pulser crypto)
forall (pulse :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) ans.
(Pulsable pulse, Monad m) =&gt;
pulse m ans -&gt; m (pulse m ans)
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">pulseM</span></a></span><span> </span><span class="annot"><span class="annottext">Pulser crypto
</span><a href="#local-6989586621679473168"><span class="hs-identifier hs-var">pulser</span></a></span><span>
</span><span id="line-1572"></span><span>  </span><span class="annot"><span class="annottext">(PulsingRewUpdate crypto, RewardEvent crypto)
-&gt; ShelleyBase (PulsingRewUpdate crypto, RewardEvent crypto)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewardSnapShot crypto -&gt; Pulser crypto -&gt; PulsingRewUpdate crypto
forall crypto.
RewardSnapShot crypto -&gt; Pulser crypto -&gt; PulsingRewUpdate crypto
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Pulsing"><span class="hs-identifier hs-var">Pulsing</span></a></span><span> </span><span class="annot"><span class="annottext">RewardSnapShot crypto
</span><a href="#local-6989586621679473169"><span class="hs-identifier hs-var">rewsnap</span></a></span><span> </span><span class="annot"><span class="annottext">Pulser crypto
</span><a href="#local-6989586621679473167"><span class="hs-identifier hs-var">p2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473166"><span class="hs-identifier hs-var">event</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1573"></span><span>
</span><span id="line-1574"></span><span class="hs-comment">-- Phase 3</span><span>
</span><span id="line-1575"></span><span>
</span><span id="line-1576"></span><span id="local-6989586621679474426"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#completeStep"><span class="hs-identifier hs-type">completeStep</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1577"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#PulsingRewUpdate"><span class="hs-identifier hs-type">PulsingRewUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474426"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1578"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ShelleyBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#PulsingRewUpdate"><span class="hs-identifier hs-type">PulsingRewUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474426"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardEvent"><span class="hs-identifier hs-type">RewardEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474426"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1579"></span><span id="completeStep"><span class="annot"><span class="annottext">completeStep :: PulsingRewUpdate crypto
-&gt; ShelleyBase (PulsingRewUpdate crypto, RewardEvent crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#completeStep"><span class="hs-identifier hs-var hs-var">completeStep</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Complete"><span class="hs-identifier hs-type">Complete</span></a></span><span> </span><span id="local-6989586621679473164"><span class="annot"><span class="annottext">RewardUpdate crypto
</span><a href="#local-6989586621679473164"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PulsingRewUpdate crypto, RewardEvent crypto)
-&gt; ShelleyBase (PulsingRewUpdate crypto, RewardEvent crypto)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewardUpdate crypto -&gt; PulsingRewUpdate crypto
forall crypto. RewardUpdate crypto -&gt; PulsingRewUpdate crypto
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Complete"><span class="hs-identifier hs-var">Complete</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate crypto
</span><a href="#local-6989586621679473164"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewardEvent crypto
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1580"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#completeStep"><span class="hs-identifier hs-var">completeStep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Pulsing"><span class="hs-identifier hs-type">Pulsing</span></a></span><span> </span><span id="local-6989586621679473163"><span class="annot"><span class="annottext">RewardSnapShot crypto
</span><a href="#local-6989586621679473163"><span class="hs-identifier hs-var">rewsnap</span></a></span></span><span> </span><span id="local-6989586621679473162"><span class="annot"><span class="annottext">Pulser crypto
</span><a href="#local-6989586621679473162"><span class="hs-identifier hs-var">pulser</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1581"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679473161"><span class="annot"><span class="annottext">RewardUpdate crypto
</span><a href="#local-6989586621679473161"><span class="hs-identifier hs-var">p2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679473160"><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473160"><span class="hs-identifier hs-var">event</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ProvM
  (RewardProvenance crypto)
  ShelleyBase
  (RewardUpdate crypto, RewardEvent crypto)
-&gt; ShelleyBase (RewardUpdate crypto, RewardEvent crypto)
forall (m :: * -&gt; *) s b. Monad m =&gt; ProvM s m b -&gt; m b
</span><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-var">runProvM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PulsingRewUpdate crypto
-&gt; ProvM
     (RewardProvenance crypto)
     ShelleyBase
     (RewardUpdate crypto, RewardEvent crypto)
forall crypto.
PulsingRewUpdate crypto
-&gt; ProvM
     (RewardProvenance crypto)
     ShelleyBase
     (RewardUpdate crypto, RewardEvent crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#completeRupd"><span class="hs-identifier hs-var">completeRupd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewardSnapShot crypto -&gt; Pulser crypto -&gt; PulsingRewUpdate crypto
forall crypto.
RewardSnapShot crypto -&gt; Pulser crypto -&gt; PulsingRewUpdate crypto
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Pulsing"><span class="hs-identifier hs-var">Pulsing</span></a></span><span> </span><span class="annot"><span class="annottext">RewardSnapShot crypto
</span><a href="#local-6989586621679473163"><span class="hs-identifier hs-var">rewsnap</span></a></span><span> </span><span class="annot"><span class="annottext">Pulser crypto
</span><a href="#local-6989586621679473162"><span class="hs-identifier hs-var">pulser</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1582"></span><span>  </span><span class="annot"><span class="annottext">(PulsingRewUpdate crypto, RewardEvent crypto)
-&gt; ShelleyBase (PulsingRewUpdate crypto, RewardEvent crypto)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewardUpdate crypto -&gt; PulsingRewUpdate crypto
forall crypto. RewardUpdate crypto -&gt; PulsingRewUpdate crypto
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Complete"><span class="hs-identifier hs-var">Complete</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate crypto
</span><a href="#local-6989586621679473161"><span class="hs-identifier hs-var">p2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473160"><span class="hs-identifier hs-var">event</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1583"></span><span>
</span><span id="line-1584"></span><span class="hs-comment">-- | Phase 3 of reward update has several parts</span><span>
</span><span id="line-1585"></span><span class="hs-comment">--   a) completeM the pulser (in case there are still computions to run)</span><span>
</span><span id="line-1586"></span><span class="hs-comment">--   b) Combine the pulser provenance with the RewardProvenance</span><span>
</span><span id="line-1587"></span><span class="hs-comment">--   c) Construct the final RewardUpdate</span><span>
</span><span id="line-1588"></span><span class="hs-comment">--   d) Add the leader rewards to both the events and the computed Rewards</span><span>
</span><span id="line-1589"></span><span id="local-6989586621679474418"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#completeRupd"><span class="hs-identifier hs-type">completeRupd</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1590"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#PulsingRewUpdate"><span class="hs-identifier hs-type">PulsingRewUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474418"><span class="hs-identifier hs-type">crypto</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1591"></span><span>  </span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">ProvM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardProvenance.html#RewardProvenance"><span class="hs-identifier hs-type">RewardProvenance</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474418"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ShelleyBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardUpdate"><span class="hs-identifier hs-type">RewardUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474418"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardEvent"><span class="hs-identifier hs-type">RewardEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474418"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1592"></span><span id="completeRupd"><span class="annot"><span class="annottext">completeRupd :: PulsingRewUpdate crypto
-&gt; ProvM
     (RewardProvenance crypto)
     ShelleyBase
     (RewardUpdate crypto, RewardEvent crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#completeRupd"><span class="hs-identifier hs-var hs-var">completeRupd</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Complete"><span class="hs-identifier hs-type">Complete</span></a></span><span> </span><span id="local-6989586621679473159"><span class="annot"><span class="annottext">RewardUpdate crypto
</span><a href="#local-6989586621679473159"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RewardUpdate crypto, RewardEvent crypto)
-&gt; ProvM
     (RewardProvenance crypto)
     ShelleyBase
     (RewardUpdate crypto, RewardEvent crypto)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewardUpdate crypto
</span><a href="#local-6989586621679473159"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewardEvent crypto
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1593"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#completeRupd"><span class="hs-identifier hs-var">completeRupd</span></a></span><span>
</span><span id="line-1594"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Pulsing"><span class="hs-identifier hs-type">Pulsing</span></a></span><span>
</span><span id="line-1595"></span><span>      </span><span id="local-6989586621679473158"><span class="annot"><span class="annottext">rewsnap :: RewardSnapShot crypto
</span><a href="#local-6989586621679473158"><span class="hs-identifier hs-var">rewsnap</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardSnapShot"><span class="hs-identifier hs-type">RewardSnapShot</span></a></span><span>
</span><span id="line-1596"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rewDeltaR1 :: forall crypto. RewardSnapShot crypto -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewDeltaR1"><span class="hs-identifier hs-var">rewDeltaR1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679473157"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473157"><span class="hs-identifier hs-var">deltaR1</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1597"></span><span>          </span><span class="annot"><span class="annottext">rewFees :: forall crypto. RewardSnapShot crypto -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewFees"><span class="hs-identifier hs-var">rewFees</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679473156"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473156"><span class="hs-identifier hs-var">feesSS</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1598"></span><span>          </span><span class="annot"><span class="annottext">rewR :: forall crypto. RewardSnapShot crypto -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewR"><span class="hs-identifier hs-var">rewR</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679473155"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473155"><span class="hs-identifier hs-var">oldr</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1599"></span><span>          </span><span class="annot"><span class="annottext">rewDeltaT1 :: forall crypto. RewardSnapShot crypto -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewDeltaT1"><span class="hs-identifier hs-var">rewDeltaT1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span id="local-6989586621679473154"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473154"><span class="hs-identifier hs-var">deltaT1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1600"></span><span>          </span><span class="annot"><span class="annottext">rewNonMyopic :: forall crypto. RewardSnapShot crypto -&gt; NonMyopic crypto
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewNonMyopic"><span class="hs-identifier hs-var">rewNonMyopic</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679473153"><span class="annot"><span class="annottext">NonMyopic crypto
</span><a href="#local-6989586621679473153"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1601"></span><span>          </span><span class="annot"><span class="annottext">rewLikelihoods :: forall crypto.
RewardSnapShot crypto -&gt; Map (KeyHash 'StakePool crypto) Likelihood
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewLikelihoods"><span class="hs-identifier hs-var">rewLikelihoods</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679473152"><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) Likelihood
</span><a href="#local-6989586621679473152"><span class="hs-identifier hs-var">newLikelihoods</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1602"></span><span>          </span><span class="annot"><span class="annottext">rewLeaders :: forall crypto.
RewardSnapShot crypto
-&gt; Map (Credential 'Staking crypto) (Set (Reward crypto))
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rewLeaders"><span class="hs-identifier hs-var">rewLeaders</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679473151"><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473151"><span class="hs-identifier hs-var">lrewards</span></a></span></span><span>
</span><span id="line-1603"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1604"></span><span>      </span><span id="local-6989586621679473150"><span class="annot"><span class="annottext">pulser :: Pulser crypto
</span><a href="#local-6989586621679473150"><span class="hs-identifier hs-var">pulser</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RSLP"><span class="hs-identifier hs-type">RSLP</span></a></span><span> </span><span id="local-6989586621679473149"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679473149"><span class="hs-identifier hs-var">_size</span></a></span></span><span> </span><span id="local-6989586621679473148"><span class="annot"><span class="annottext">FreeVars crypto
</span><a href="#local-6989586621679473148"><span class="hs-identifier hs-var">_free</span></a></span></span><span> </span><span id="local-6989586621679473147"><span class="annot"><span class="annottext">VMap VB VP (Credential 'Staking crypto) (CompactForm Coin)
</span><a href="#local-6989586621679473147"><span class="hs-identifier hs-var">_source</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardAns"><span class="hs-identifier hs-type">RewardAns</span></a></span><span> </span><span id="local-6989586621679473146"><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) (Reward crypto)
</span><a href="#local-6989586621679473146"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span id="local-6989586621679473145"><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473145"><span class="hs-identifier hs-var">_now</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- If prev is Map.empty, we have never pulsed.</span><span>
</span><span id="line-1605"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1606"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardAns"><span class="hs-identifier hs-type">RewardAns</span></a></span><span> </span><span id="local-6989586621679473144"><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) (Reward crypto)
</span><a href="#local-6989586621679473144"><span class="hs-identifier hs-var">rs_</span></a></span></span><span> </span><span id="local-6989586621679473143"><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473143"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ShelleyBase (RewardAns crypto)
-&gt; ProvM (RewardProvenance crypto) ShelleyBase (RewardAns crypto)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pulser crypto -&gt; ShelleyBase (RewardAns crypto)
forall (pulse :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) ans.
(Pulsable pulse, Monad m) =&gt;
pulse m ans -&gt; m ans
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">completeM</span></a></span><span> </span><span class="annot"><span class="annottext">Pulser crypto
</span><a href="#local-6989586621679473150"><span class="hs-identifier hs-var">pulser</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1607"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473142"><span class="annot"><span class="annottext">rs' :: RewardEvent crypto
</span><a href="#local-6989586621679473142"><span class="hs-identifier hs-var hs-var">rs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Reward crypto -&gt; Set (Reward crypto))
-&gt; Map (Credential 'Staking crypto) (Reward crypto)
-&gt; RewardEvent crypto
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.map</span></a></span><span> </span><span class="annot"><span class="annottext">Reward crypto -&gt; Set (Reward crypto)
forall a. a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.singleton</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) (Reward crypto)
</span><a href="#local-6989586621679473144"><span class="hs-identifier hs-var">rs_</span></a></span><span>
</span><span id="line-1608"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473141"><span class="annot"><span class="annottext">rs'' :: RewardEvent crypto
</span><a href="#local-6989586621679473141"><span class="hs-identifier hs-var hs-var">rs''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Set (Reward crypto) -&gt; Set (Reward crypto) -&gt; Set (Reward crypto))
-&gt; RewardEvent crypto -&gt; RewardEvent crypto -&gt; RewardEvent crypto
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.unionWith</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Reward crypto) -&gt; Set (Reward crypto) -&gt; Set (Reward crypto)
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473142"><span class="hs-identifier hs-var">rs'</span></a></span><span> </span><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473151"><span class="hs-identifier hs-var">lrewards</span></a></span><span>
</span><span id="line-1609"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679473140"><span class="annot"><span class="annottext">events' :: RewardEvent crypto
</span><a href="#local-6989586621679473140"><span class="hs-identifier hs-var hs-var">events'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Set (Reward crypto) -&gt; Set (Reward crypto) -&gt; Set (Reward crypto))
-&gt; RewardEvent crypto -&gt; RewardEvent crypto -&gt; RewardEvent crypto
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.unionWith</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Reward crypto) -&gt; Set (Reward crypto) -&gt; Set (Reward crypto)
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473143"><span class="hs-identifier hs-var">events</span></a></span><span> </span><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473151"><span class="hs-identifier hs-var">lrewards</span></a></span><span>
</span><span id="line-1610"></span><span>
</span><span id="line-1611"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473139"><span class="annot"><span class="annottext">deltaR2 :: Coin
</span><a href="#local-6989586621679473139"><span class="hs-identifier hs-var hs-var">deltaR2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473155"><span class="hs-identifier hs-var">oldr</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall t. Val t =&gt; t -&gt; t -&gt; t
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">&lt;-&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RewardSnapShot crypto -&gt; RewardEvent crypto -&gt; Coin
forall crypto pp.
HasField &quot;_protocolVersion&quot; pp ProtVer =&gt;
pp
-&gt; Map (Credential 'Staking crypto) (Set (Reward crypto)) -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.Rewards.html#sumRewards"><span class="hs-identifier hs-var">sumRewards</span></a></span><span> </span><span class="annot"><span class="annottext">RewardSnapShot crypto
</span><a href="#local-6989586621679473158"><span class="hs-identifier hs-var">rewsnap</span></a></span><span> </span><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473141"><span class="hs-identifier hs-var">rs''</span></a></span><span>
</span><span id="line-1612"></span><span>    </span><span class="annot"><span class="annottext">(RewardProvenance crypto -&gt; RewardProvenance crypto)
-&gt; ProvM (RewardProvenance crypto) ShelleyBase ()
forall (m :: * -&gt; *) t. Monad m =&gt; (t -&gt; t) -&gt; ProvM t m ()
</span><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-var">modifyM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679473138"><span class="annot"><span class="annottext">RewardProvenance crypto
</span><a href="#local-6989586621679473138"><span class="hs-identifier hs-var">rp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RewardProvenance crypto
</span><a href="#local-6989586621679473138"><span class="hs-identifier hs-var">rp</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">deltaR2 :: Coin
</span><a href="Cardano.Ledger.Shelley.RewardProvenance.html#deltaR2"><span class="hs-identifier hs-var">deltaR2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473139"><span class="hs-identifier hs-var">deltaR2</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1613"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473136"><span class="annot"><span class="annottext">neverpulsed :: Bool
</span><a href="#local-6989586621679473136"><span class="hs-identifier hs-var hs-var">neverpulsed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) (Reward crypto) -&gt; Bool
forall k a. Map k a -&gt; Bool
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.null</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) (Reward crypto)
</span><a href="#local-6989586621679473146"><span class="hs-identifier hs-var">prev</span></a></span><span>
</span><span id="line-1614"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679473134"><span class="annot"><span class="annottext">newevent :: RewardEvent crypto
</span><a href="#local-6989586621679473134"><span class="hs-identifier hs-var hs-var">newevent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1615"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679473136"><span class="hs-identifier hs-var">neverpulsed</span></a></span><span> </span><span class="hs-comment">-- If we have never pulsed then everything in the computed needs to added to the event</span><span>
</span><span id="line-1616"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(Set (Reward crypto) -&gt; Set (Reward crypto) -&gt; Set (Reward crypto))
-&gt; RewardEvent crypto -&gt; RewardEvent crypto -&gt; RewardEvent crypto
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.unionWith</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Reward crypto) -&gt; Set (Reward crypto) -&gt; Set (Reward crypto)
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473142"><span class="hs-identifier hs-var">rs'</span></a></span><span> </span><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473140"><span class="hs-identifier hs-var">events'</span></a></span><span>
</span><span id="line-1617"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473140"><span class="hs-identifier hs-var">events'</span></a></span><span>
</span><span id="line-1618"></span><span>    </span><span class="annot"><span class="annottext">(RewardUpdate crypto, RewardEvent crypto)
-&gt; ProvM
     (RewardProvenance crypto)
     ShelleyBase
     (RewardUpdate crypto, RewardEvent crypto)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span>
</span><span id="line-1619"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">RewardUpdate :: forall crypto.
DeltaCoin
-&gt; DeltaCoin
-&gt; Map (Credential 'Staking crypto) (Set (Reward crypto))
-&gt; DeltaCoin
-&gt; NonMyopic crypto
-&gt; RewardUpdate crypto
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardUpdate"><span class="hs-identifier hs-type">RewardUpdate</span></a></span><span>
</span><span id="line-1620"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">deltaT :: DeltaCoin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#deltaT"><span class="hs-identifier hs-var">deltaT</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; DeltaCoin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">DeltaCoin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679473154"><span class="hs-identifier hs-var">deltaT1</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1621"></span><span>            </span><span class="annot"><span class="annottext">deltaR :: DeltaCoin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#deltaR"><span class="hs-identifier hs-var">deltaR</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DeltaCoin -&gt; DeltaCoin
forall m. Group m =&gt; m -&gt; m
</span><a href="../../../../groups/html/src"><span class="hs-identifier hs-var">invert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin -&gt; DeltaCoin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">toDeltaCoin</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473157"><span class="hs-identifier hs-var">deltaR1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DeltaCoin -&gt; DeltaCoin -&gt; DeltaCoin
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; DeltaCoin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">toDeltaCoin</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473139"><span class="hs-identifier hs-var">deltaR2</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1622"></span><span>            </span><span class="annot"><span class="annottext">rs :: RewardEvent crypto
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#rs"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473141"><span class="hs-identifier hs-var">rs''</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1623"></span><span>            </span><span class="annot"><span class="annottext">deltaF :: DeltaCoin
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#deltaF"><span class="hs-identifier hs-var">deltaF</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DeltaCoin -&gt; DeltaCoin
forall m. Group m =&gt; m -&gt; m
</span><a href="../../../../groups/html/src"><span class="hs-identifier hs-var">invert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coin -&gt; DeltaCoin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">toDeltaCoin</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473156"><span class="hs-identifier hs-var">feesSS</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1624"></span><span>            </span><span class="annot"><span class="annottext">nonMyopic :: NonMyopic crypto
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#nonMyopic"><span class="hs-identifier hs-var">nonMyopic</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonMyopic crypto
-&gt; Coin
-&gt; Map (KeyHash 'StakePool crypto) Likelihood
-&gt; NonMyopic crypto
forall crypto.
NonMyopic crypto
-&gt; Coin
-&gt; Map (KeyHash 'StakePool crypto) Likelihood
-&gt; NonMyopic crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#updateNonMyopic"><span class="hs-identifier hs-var">updateNonMyopic</span></a></span><span> </span><span class="annot"><span class="annottext">NonMyopic crypto
</span><a href="#local-6989586621679473153"><span class="hs-identifier hs-var">nm</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473155"><span class="hs-identifier hs-var">oldr</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) Likelihood
</span><a href="#local-6989586621679473152"><span class="hs-identifier hs-var">newLikelihoods</span></a></span><span>
</span><span id="line-1625"></span><span>          </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-1626"></span><span>        </span><span class="annot"><span class="annottext">RewardEvent crypto
</span><a href="#local-6989586621679473134"><span class="hs-identifier hs-var">newevent</span></a></span><span>
</span><span id="line-1627"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-1628"></span><span>
</span><span id="line-1629"></span><span class="hs-comment">-- | To create a reward update, run all 3 phases</span><span>
</span><span id="line-1630"></span><span class="hs-comment">--   This function is not used in the rules, so it ignores RewardEvents</span><span>
</span><span id="line-1631"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#createRUpd"><span class="hs-identifier hs-type">createRUpd</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1632"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679473131"><span class="annot"><a href="#local-6989586621679473131"><span class="hs-identifier hs-type">era</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1633"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UsesPP"><span class="hs-identifier hs-type">UsesPP</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473131"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1634"></span><span>  </span><span class="annot"><a href="../../../../cardano-slotting/html/src"><span class="hs-identifier hs-type">EpochSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1635"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">BlocksMade</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473131"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1636"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473131"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1637"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1638"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ActiveSlotCoeff</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1639"></span><span>  </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1640"></span><span>  </span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">ProvM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardProvenance.html#RewardProvenance"><span class="hs-identifier hs-type">RewardProvenance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473131"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">ShelleyBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#RewardUpdate"><span class="hs-identifier hs-type">RewardUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473131"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1641"></span><span id="createRUpd"><span class="annot"><span class="annottext">createRUpd :: EpochSize
-&gt; BlocksMade (Crypto era)
-&gt; EpochState era
-&gt; Coin
-&gt; ActiveSlotCoeff
-&gt; Word64
-&gt; ProvM
     (RewardProvenance (Crypto era))
     ShelleyBase
     (RewardUpdate (Crypto era))
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#createRUpd"><span class="hs-identifier hs-var hs-var">createRUpd</span></a></span></span><span> </span><span id="local-6989586621679473130"><span class="annot"><span class="annottext">EpochSize
</span><a href="#local-6989586621679473130"><span class="hs-identifier hs-var">slotsPerEpoch</span></a></span></span><span> </span><span id="local-6989586621679473129"><span class="annot"><span class="annottext">BlocksMade (Crypto era)
</span><a href="#local-6989586621679473129"><span class="hs-identifier hs-var">blocksmade</span></a></span></span><span> </span><span id="local-6989586621679473128"><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473128"><span class="hs-identifier hs-var">epstate</span></a></span></span><span> </span><span id="local-6989586621679473127"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473127"><span class="hs-identifier hs-var">maxSupply</span></a></span></span><span> </span><span id="local-6989586621679473126"><span class="annot"><span class="annottext">ActiveSlotCoeff
</span><a href="#local-6989586621679473126"><span class="hs-identifier hs-var">asc</span></a></span></span><span> </span><span id="local-6989586621679473125"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679473125"><span class="hs-identifier hs-var">secparam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1642"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679473124"><span class="annot"><span class="annottext">PulsingRewUpdate (Crypto era)
</span><a href="#local-6989586621679473124"><span class="hs-identifier hs-var">step1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473123"><span class="annot"><span class="annottext">RewardProvenance (Crypto era)
</span><a href="#local-6989586621679473123"><span class="hs-identifier hs-var">initialProvenance</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochSize
-&gt; BlocksMade (Crypto era)
-&gt; EpochState era
-&gt; Coin
-&gt; ActiveSlotCoeff
-&gt; Word64
-&gt; (PulsingRewUpdate (Crypto era), RewardProvenance (Crypto era))
forall era.
UsesPP era =&gt;
EpochSize
-&gt; BlocksMade (Crypto era)
-&gt; EpochState era
-&gt; Coin
-&gt; ActiveSlotCoeff
-&gt; Word64
-&gt; (PulsingRewUpdate (Crypto era), RewardProvenance (Crypto era))
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#startStep"><span class="hs-identifier hs-var">startStep</span></a></span><span> </span><span class="annot"><span class="annottext">EpochSize
</span><a href="#local-6989586621679473130"><span class="hs-identifier hs-var">slotsPerEpoch</span></a></span><span> </span><span class="annot"><span class="annottext">BlocksMade (Crypto era)
</span><a href="#local-6989586621679473129"><span class="hs-identifier hs-var">blocksmade</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473128"><span class="hs-identifier hs-var">epstate</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473127"><span class="hs-identifier hs-var">maxSupply</span></a></span><span> </span><span class="annot"><span class="annottext">ActiveSlotCoeff
</span><a href="#local-6989586621679473126"><span class="hs-identifier hs-var">asc</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679473125"><span class="hs-identifier hs-var">secparam</span></a></span><span>
</span><span id="line-1643"></span><span>  </span><span class="annot"><span class="annottext">(RewardProvenance (Crypto era) -&gt; RewardProvenance (Crypto era))
-&gt; ProvM (RewardProvenance (Crypto era)) ShelleyBase ()
forall (m :: * -&gt; *) t. Monad m =&gt; (t -&gt; t) -&gt; ProvM t m ()
</span><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-var">modifyM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">RewardProvenance (Crypto era)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RewardProvenance (Crypto era)
</span><a href="#local-6989586621679473123"><span class="hs-identifier hs-var">initialProvenance</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1644"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679473122"><span class="annot"><span class="annottext">PulsingRewUpdate (Crypto era)
</span><a href="#local-6989586621679473122"><span class="hs-identifier hs-var">step2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473121"><span class="annot"><span class="annottext">RewardEvent (Crypto era)
</span><a href="#local-6989586621679473121"><span class="hs-identifier hs-var">_event</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT
  Globals
  Identity
  (PulsingRewUpdate (Crypto era), RewardEvent (Crypto era))
-&gt; ProvM
     (RewardProvenance (Crypto era))
     ShelleyBase
     (PulsingRewUpdate (Crypto era), RewardEvent (Crypto era))
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PulsingRewUpdate (Crypto era)
-&gt; ReaderT
     Globals
     Identity
     (PulsingRewUpdate (Crypto era), RewardEvent (Crypto era))
forall crypto.
PulsingRewUpdate crypto
-&gt; ShelleyBase (PulsingRewUpdate crypto, RewardEvent crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#pulseStep"><span class="hs-identifier hs-var">pulseStep</span></a></span><span> </span><span class="annot"><span class="annottext">PulsingRewUpdate (Crypto era)
</span><a href="#local-6989586621679473124"><span class="hs-identifier hs-var">step1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1645"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PulsingRewUpdate (Crypto era)
</span><a href="#local-6989586621679473122"><span class="hs-identifier hs-var">step2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1646"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Complete"><span class="hs-identifier hs-type">Complete</span></a></span><span> </span><span id="local-6989586621679473120"><span class="annot"><span class="annottext">RewardUpdate (Crypto era)
</span><a href="#local-6989586621679473120"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RewardUpdate (Crypto era)
-&gt; ProvM
     (RewardProvenance (Crypto era))
     ShelleyBase
     (RewardUpdate (Crypto era))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">RewardUpdate (Crypto era)
</span><a href="#local-6989586621679473120"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1647"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Pulsing"><span class="hs-identifier hs-type">Pulsing</span></a></span><span> </span><span id="local-6989586621679473119"><span class="annot"><span class="annottext">RewardSnapShot (Crypto era)
</span><a href="#local-6989586621679473119"><span class="hs-identifier hs-var">rewsnap</span></a></span></span><span> </span><span id="local-6989586621679473118"><span class="annot"><span class="annottext">Pulser (Crypto era)
</span><a href="#local-6989586621679473118"><span class="hs-identifier hs-var">pulser</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(RewardUpdate (Crypto era), RewardEvent (Crypto era))
-&gt; RewardUpdate (Crypto era)
forall a b. (a, b) -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">((RewardUpdate (Crypto era), RewardEvent (Crypto era))
 -&gt; RewardUpdate (Crypto era))
-&gt; ProvM
     (RewardProvenance (Crypto era))
     ShelleyBase
     (RewardUpdate (Crypto era), RewardEvent (Crypto era))
-&gt; ProvM
     (RewardProvenance (Crypto era))
     ShelleyBase
     (RewardUpdate (Crypto era))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PulsingRewUpdate (Crypto era)
-&gt; ProvM
     (RewardProvenance (Crypto era))
     ShelleyBase
     (RewardUpdate (Crypto era), RewardEvent (Crypto era))
forall crypto.
PulsingRewUpdate crypto
-&gt; ProvM
     (RewardProvenance crypto)
     ShelleyBase
     (RewardUpdate crypto, RewardEvent crypto)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#completeRupd"><span class="hs-identifier hs-var">completeRupd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewardSnapShot (Crypto era)
-&gt; Pulser (Crypto era) -&gt; PulsingRewUpdate (Crypto era)
forall crypto.
RewardSnapShot crypto -&gt; Pulser crypto -&gt; PulsingRewUpdate crypto
</span><a href="Cardano.Ledger.Shelley.RewardUpdate.html#Pulsing"><span class="hs-identifier hs-var">Pulsing</span></a></span><span> </span><span class="annot"><span class="annottext">RewardSnapShot (Crypto era)
</span><a href="#local-6989586621679473119"><span class="hs-identifier hs-var">rewsnap</span></a></span><span> </span><span class="annot"><span class="annottext">Pulser (Crypto era)
</span><a href="#local-6989586621679473118"><span class="hs-identifier hs-var">pulser</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1648"></span><span>
</span><span id="line-1649"></span><span class="hs-comment">-- =====================================================================</span><span>
</span><span id="line-1650"></span><span>
</span><span id="line-1651"></span><span class="hs-comment">-- | Calculate the current circulation</span><span>
</span><span id="line-1652"></span><span class="hs-comment">--</span><span>
</span><span id="line-1653"></span><span class="hs-comment">-- This is used in the rewards calculation, and for API endpoints for pool ranking.</span><span>
</span><span id="line-1654"></span><span id="local-6989586621679474489"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#circulation"><span class="hs-identifier hs-type">circulation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474489"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Coin</span></a></span></span><span>
</span><span id="line-1655"></span><span id="circulation"><span class="annot"><span class="annottext">circulation :: EpochState era -&gt; Coin -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#circulation"><span class="hs-identifier hs-var hs-var">circulation</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span id="local-6989586621679473117"><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473117"><span class="hs-identifier hs-var">acnt</span></a></span></span><span> </span><span class="annot"><span class="annottext">SnapShots (Crypto era)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">NonMyopic (Crypto era)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473116"><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473116"><span class="hs-identifier hs-var">supply</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1656"></span><span>  </span><span class="annot"><span class="annottext">Coin
</span><a href="#local-6989586621679473116"><span class="hs-identifier hs-var">supply</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall t. Val t =&gt; t -&gt; t -&gt; t
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">&lt;-&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_reserves"><span class="hs-identifier hs-var hs-var">_reserves</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473117"><span class="hs-identifier hs-var">acnt</span></a></span><span>
</span><span id="line-1657"></span><span>
</span><span id="line-1658"></span><span class="hs-comment">-- | Update new epoch state</span><span>
</span><span id="line-1659"></span><span id="local-6989586621679473115"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#updateNES"><span class="hs-identifier hs-type">updateNES</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1660"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473115"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1661"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">BlocksMade</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473115"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1662"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473115"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1663"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473115"><span class="hs-identifier hs-type">era</span></a></span></span><span>
</span><span id="line-1664"></span><span id="updateNES"><span class="annot"><span class="annottext">updateNES :: NewEpochState era
-&gt; BlocksMade (Crypto era) -&gt; LedgerState era -&gt; NewEpochState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#updateNES"><span class="hs-identifier hs-var hs-var">updateNES</span></a></span></span><span>
</span><span id="line-1665"></span><span>  </span><span id="local-6989586621679473114"><span class="annot"><span class="annottext">oldNes :: NewEpochState era
</span><a href="#local-6989586621679473114"><span class="hs-identifier hs-var">oldNes</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#NewEpochState"><span class="hs-identifier hs-type">NewEpochState</span></a></span><span>
</span><span id="line-1666"></span><span>             </span><span id="local-6989586621679473113"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679473113"><span class="hs-identifier hs-var">_eL</span></a></span></span><span>
</span><span id="line-1667"></span><span>             </span><span id="local-6989586621679473112"><span class="annot"><span class="annottext">BlocksMade (Crypto era)
</span><a href="#local-6989586621679473112"><span class="hs-identifier hs-var">_bprev</span></a></span></span><span>
</span><span id="line-1668"></span><span>             </span><span class="annot"><span class="annottext">BlocksMade (Crypto era)
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-1669"></span><span>             </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span id="local-6989586621679473111"><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473111"><span class="hs-identifier hs-var">acnt</span></a></span></span><span> </span><span id="local-6989586621679473110"><span class="annot"><span class="annottext">SnapShots (Crypto era)
</span><a href="#local-6989586621679473110"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679473109"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473109"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span id="local-6989586621679473108"><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473108"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span id="local-6989586621679473107"><span class="annot"><span class="annottext">NonMyopic (Crypto era)
</span><a href="#local-6989586621679473107"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1670"></span><span>             </span><span id="local-6989586621679473106"><span class="annot"><span class="annottext">StrictMaybe (PulsingRewUpdate (Crypto era))
</span><a href="#local-6989586621679473106"><span class="hs-identifier hs-var">_ru</span></a></span></span><span>
</span><span id="line-1671"></span><span>             </span><span id="local-6989586621679473105"><span class="annot"><span class="annottext">PoolDistr (Crypto era)
</span><a href="#local-6989586621679473105"><span class="hs-identifier hs-var">_pd</span></a></span></span><span>
</span><span id="line-1672"></span><span>             </span><span id="local-6989586621679473104"><span class="annot"><span class="annottext">StashedAVVMAddresses era
</span><a href="#local-6989586621679473104"><span class="hs-identifier hs-var">_avvm</span></a></span></span><span>
</span><span id="line-1673"></span><span>           </span><span class="hs-special">)</span><span>
</span><span id="line-1674"></span><span>  </span><span id="local-6989586621679473103"><span class="annot"><span class="annottext">BlocksMade (Crypto era)
</span><a href="#local-6989586621679473103"><span class="hs-identifier hs-var">bcur</span></a></span></span><span>
</span><span id="line-1675"></span><span>  </span><span id="local-6989586621679473102"><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473102"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1676"></span><span>    </span><span class="annot"><span class="annottext">NewEpochState era
</span><a href="#local-6989586621679473114"><span class="hs-identifier hs-var">oldNes</span></a></span><span>
</span><span id="line-1677"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">nesBcur :: BlocksMade (Crypto era)
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#nesBcur"><span class="hs-identifier hs-var">nesBcur</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlocksMade (Crypto era)
</span><a href="#local-6989586621679473103"><span class="hs-identifier hs-var">bcur</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1678"></span><span>        </span><span class="annot"><span class="annottext">nesEs :: EpochState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#nesEs"><span class="hs-identifier hs-var">nesEs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AccountState
-&gt; SnapShots (Crypto era)
-&gt; LedgerState era
-&gt; PParams era
-&gt; PParams era
-&gt; NonMyopic (Crypto era)
-&gt; EpochState era
forall era.
AccountState
-&gt; SnapShots (Crypto era)
-&gt; LedgerState era
-&gt; PParams era
-&gt; PParams era
-&gt; NonMyopic (Crypto era)
-&gt; EpochState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-var">EpochState</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473111"><span class="hs-identifier hs-var">acnt</span></a></span><span> </span><span class="annot"><span class="annottext">SnapShots (Crypto era)
</span><a href="#local-6989586621679473110"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473102"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473109"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
</span><a href="#local-6989586621679473108"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">NonMyopic (Crypto era)
</span><a href="#local-6989586621679473107"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-1679"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-1680"></span><span>
</span><span id="line-1681"></span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#returnRedeemAddrsToReserves"><span class="hs-identifier hs-type">returnRedeemAddrsToReserves</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1682"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679473101"><span class="annot"><a href="#local-6989586621679473101"><span class="hs-identifier hs-type">era</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1683"></span><span>  </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Era</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473101"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1684"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473101"><span class="hs-identifier hs-type">era</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1685"></span><span>  </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473101"><span class="hs-identifier hs-type">era</span></a></span><span>
</span><span id="line-1686"></span><span id="returnRedeemAddrsToReserves"><span class="annot"><span class="annottext">returnRedeemAddrsToReserves :: EpochState era -&gt; EpochState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#returnRedeemAddrsToReserves"><span class="hs-identifier hs-var hs-var">returnRedeemAddrsToReserves</span></a></span></span><span> </span><span id="local-6989586621679473100"><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473100"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473100"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">esAccountState :: AccountState
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#esAccountState"><span class="hs-identifier hs-var">esAccountState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473099"><span class="hs-identifier hs-var">acnt'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">esLState :: LedgerState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#esLState"><span class="hs-identifier hs-var">esLState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473098"><span class="hs-identifier hs-var">ls'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1687"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1688"></span><span>    </span><span id="local-6989586621679473097"><span class="annot"><span class="annottext">ls :: LedgerState era
</span><a href="#local-6989586621679473097"><span class="hs-identifier hs-var hs-var">ls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochState era -&gt; LedgerState era
forall era. EpochState era -&gt; LedgerState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#esLState"><span class="hs-identifier hs-var hs-var">esLState</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473100"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-1689"></span><span>    </span><span id="local-6989586621679473096"><span class="annot"><span class="annottext">us :: UTxOState era
</span><a href="#local-6989586621679473096"><span class="hs-identifier hs-var hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerState era -&gt; UTxOState era
forall era. LedgerState era -&gt; UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#lsUTxOState"><span class="hs-identifier hs-var hs-var">lsUTxOState</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473097"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-1690"></span><span>    </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span id="local-6989586621679473095"><span class="annot"><span class="annottext">Map (TxIn (Crypto era)) (TxOut era)
</span><a href="#local-6989586621679473095"><span class="hs-identifier hs-var">utxo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTxOState era -&gt; UTxO era
forall era. UTxOState era -&gt; UTxO era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_utxo"><span class="hs-identifier hs-var hs-var">_utxo</span></a></span><span> </span><span class="annot"><span class="annottext">UTxOState era
</span><a href="#local-6989586621679473096"><span class="hs-identifier hs-var">us</span></a></span><span>
</span><span id="line-1691"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679473094"><span class="annot"><span class="annottext">Map (TxIn (Crypto era)) (TxOut era)
</span><a href="#local-6989586621679473094"><span class="hs-identifier hs-var">redeemers</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473093"><span class="annot"><span class="annottext">Map (TxIn (Crypto era)) (TxOut era)
</span><a href="#local-6989586621679473093"><span class="hs-identifier hs-var">nonredeemers</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1692"></span><span>      </span><span class="annot"><span class="annottext">(TxOut era -&gt; Bool)
-&gt; Map (TxIn (Crypto era)) (TxOut era)
-&gt; (Map (TxIn (Crypto era)) (TxOut era),
    Map (TxIn (Crypto era)) (TxOut era))
forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; (Map k a, Map k a)
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.partition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
-&gt; (BootstrapAddress (Crypto era) -&gt; Bool)
-&gt; Maybe (BootstrapAddress (Crypto era))
-&gt; Bool
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="annot"><span class="annottext">BootstrapAddress (Crypto era) -&gt; Bool
forall crypto. BootstrapAddress crypto -&gt; Bool
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">isBootstrapRedeemer</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (BootstrapAddress (Crypto era)) -&gt; Bool)
-&gt; (TxOut era -&gt; Maybe (BootstrapAddress (Crypto era)))
-&gt; TxOut era
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TxOut era -&gt; Maybe (BootstrapAddress (Crypto era))
forall era.
Era era =&gt;
TxOut era -&gt; Maybe (BootstrapAddress (Crypto era))
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">getTxOutBootstrapAddress</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map (TxIn (Crypto era)) (TxOut era)
</span><a href="#local-6989586621679473095"><span class="hs-identifier hs-var">utxo</span></a></span><span>
</span><span id="line-1693"></span><span>    </span><span id="local-6989586621679473091"><span class="annot"><span class="annottext">acnt :: AccountState
</span><a href="#local-6989586621679473091"><span class="hs-identifier hs-var hs-var">acnt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochState era -&gt; AccountState
forall era. EpochState era -&gt; AccountState
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#esAccountState"><span class="hs-identifier hs-var hs-var">esAccountState</span></a></span><span> </span><span class="annot"><span class="annottext">EpochState era
</span><a href="#local-6989586621679473100"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-1694"></span><span>    </span><span id="local-6989586621679473090"><span class="annot"><span class="annottext">utxoR :: UTxO era
</span><a href="#local-6989586621679473090"><span class="hs-identifier hs-var hs-var">utxoR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (TxIn (Crypto era)) (TxOut era) -&gt; UTxO era
forall era. Map (TxIn (Crypto era)) (TxOut era) -&gt; UTxO era
</span><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-var">UTxO</span></a></span><span> </span><span class="annot"><span class="annottext">Map (TxIn (Crypto era)) (TxOut era)
</span><a href="#local-6989586621679473094"><span class="hs-identifier hs-var">redeemers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473101"><span class="hs-identifier hs-type">era</span></a></span><span>
</span><span id="line-1695"></span><span>    </span><span id="local-6989586621679473099"><span class="annot"><span class="annottext">acnt' :: AccountState
</span><a href="#local-6989586621679473099"><span class="hs-identifier hs-var hs-var">acnt'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1696"></span><span>      </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473091"><span class="hs-identifier hs-var">acnt</span></a></span><span>
</span><span id="line-1697"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_reserves :: Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_reserves"><span class="hs-identifier hs-var">_reserves</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AccountState -&gt; Coin
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_reserves"><span class="hs-identifier hs-var hs-var">_reserves</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
</span><a href="#local-6989586621679473091"><span class="hs-identifier hs-var">acnt</span></a></span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; Coin
forall t. Val t =&gt; t -&gt; t -&gt; t
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Value era -&gt; Coin
forall t. Val t =&gt; t -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Val.coin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UTxO era -&gt; Value era
forall era. Era era =&gt; UTxO era -&gt; Value era
</span><a href="Cardano.Ledger.Shelley.UTxO.html#balance"><span class="hs-identifier hs-var">balance</span></a></span><span> </span><span class="annot"><span class="annottext">UTxO era
</span><a href="#local-6989586621679473090"><span class="hs-identifier hs-var">utxoR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1698"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1699"></span><span>    </span><span id="local-6989586621679473089"><span class="annot"><span class="annottext">us' :: UTxOState era
</span><a href="#local-6989586621679473089"><span class="hs-identifier hs-var hs-var">us'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTxOState era
</span><a href="#local-6989586621679473096"><span class="hs-identifier hs-var">us</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">_utxo :: UTxO era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#_utxo"><span class="hs-identifier hs-var">_utxo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (TxIn (Crypto era)) (TxOut era) -&gt; UTxO era
forall era. Map (TxIn (Crypto era)) (TxOut era) -&gt; UTxO era
</span><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-var">UTxO</span></a></span><span> </span><span class="annot"><span class="annottext">Map (TxIn (Crypto era)) (TxOut era)
</span><a href="#local-6989586621679473093"><span class="hs-identifier hs-var">nonredeemers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.UTxO.html#UTxO"><span class="hs-identifier hs-type">UTxO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473101"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1700"></span><span>    </span><span id="local-6989586621679473098"><span class="annot"><span class="annottext">ls' :: LedgerState era
</span><a href="#local-6989586621679473098"><span class="hs-identifier hs-var hs-var">ls'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerState era
</span><a href="#local-6989586621679473097"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lsUTxOState :: UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#lsUTxOState"><span class="hs-identifier hs-var">lsUTxOState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTxOState era
</span><a href="#local-6989586621679473089"><span class="hs-identifier hs-var">us'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1701"></span><span>
</span><span id="line-1702"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-1703"></span><span class="hs-comment">-- Default instances</span><span>
</span><span id="line-1704"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-1705"></span><span>
</span><span id="line-1706"></span><span id="local-6989586621679473088"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PPUPState"><span class="hs-identifier hs-type">PPUPState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473088"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1707"></span><span>  </span><span id="local-6989586621679473086"><span class="annot"><span class="annottext">def :: PPUPState era
</span><a href="#local-6989586621679473086"><span class="hs-identifier hs-var hs-var hs-var hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProposedPPUpdates era -&gt; ProposedPPUpdates era -&gt; PPUPState era
forall era.
ProposedPPUpdates era -&gt; ProposedPPUpdates era -&gt; PPUPState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#PPUPState"><span class="hs-identifier hs-var">PPUPState</span></a></span><span> </span><span class="annot"><span class="annottext">ProposedPPUpdates era
forall era. ProposedPPUpdates era
</span><a href="Cardano.Ledger.Shelley.PParams.html#emptyPPPUpdates"><span class="hs-identifier hs-var">emptyPPPUpdates</span></a></span><span> </span><span class="annot"><span class="annottext">ProposedPPUpdates era
forall era. ProposedPPUpdates era
</span><a href="Cardano.Ledger.Shelley.PParams.html#emptyPPPUpdates"><span class="hs-identifier hs-var">emptyPPPUpdates</span></a></span></span><span>
</span><span id="line-1708"></span><span>
</span><span id="line-1709"></span><span id="local-6989586621679473085"><span class="hs-keyword">instance</span><span>
</span><span id="line-1710"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../small-steps/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.EraRule</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;PPUP&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679473085"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">CC.Crypto</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Crypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473085"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1711"></span><span>  </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-type">UTxOState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473085"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1712"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1713"></span><span>  </span><span id="local-6989586621679473083"><span class="annot"><span class="annottext">def :: UTxOState era
</span><a href="#local-6989586621679473083"><span class="hs-identifier hs-var hs-var hs-var hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTxO era
-&gt; Coin
-&gt; Coin
-&gt; State (EraRule &quot;PPUP&quot; era)
-&gt; IncrementalStake (Crypto era)
-&gt; UTxOState era
forall era.
UTxO era
-&gt; Coin
-&gt; Coin
-&gt; State (EraRule &quot;PPUP&quot; era)
-&gt; IncrementalStake (Crypto era)
-&gt; UTxOState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-var">UTxOState</span></a></span><span> </span><span class="annot"><span class="annottext">UTxO era
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Coin
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">State (EraRule &quot;PPUP&quot; era)
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span><span> </span><span class="annot"><span class="annottext">IncrementalStake (Crypto era)
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span></span><span>
</span><span id="line-1714"></span><span>
</span><span id="line-1715"></span><span id="local-6989586621679473082"><span class="hs-keyword">instance</span><span>
</span><span id="line-1716"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473082"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-type">Core.PParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473082"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1717"></span><span>  </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-type">EpochState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473082"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1718"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1719"></span><span>  </span><span id="local-6989586621679473080"><span class="annot"><span class="annottext">def :: EpochState era
</span><a href="#local-6989586621679473080"><span class="hs-identifier hs-var hs-var hs-var hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AccountState
-&gt; SnapShots (Crypto era)
-&gt; LedgerState era
-&gt; PParams era
-&gt; PParams era
-&gt; NonMyopic (Crypto era)
-&gt; EpochState era
forall era.
AccountState
-&gt; SnapShots (Crypto era)
-&gt; LedgerState era
-&gt; PParams era
-&gt; PParams era
-&gt; NonMyopic (Crypto era)
-&gt; EpochState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#EpochState"><span class="hs-identifier hs-var">EpochState</span></a></span><span> </span><span class="annot"><span class="annottext">AccountState
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span><span> </span><span class="annot"><span class="annottext">SnapShots (Crypto era)
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState era
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span><span> </span><span class="annot"><span class="annottext">PParams era
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span><span> </span><span class="annot"><span class="annottext">NonMyopic (Crypto era)
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span></span><span>
</span><span id="line-1720"></span><span>
</span><span id="line-1721"></span><span id="local-6989586621679473079"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#UTxOState"><span class="hs-identifier hs-type">UTxOState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473079"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473079"><span class="hs-identifier hs-type">era</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1722"></span><span>  </span><span id="local-6989586621679473077"><span class="annot"><span class="annottext">def :: LedgerState era
</span><a href="#local-6989586621679473077"><span class="hs-identifier hs-var hs-var hs-var hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTxOState era -&gt; DPState (Crypto era) -&gt; LedgerState era
forall era.
UTxOState era -&gt; DPState (Crypto era) -&gt; LedgerState era
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#LedgerState"><span class="hs-identifier hs-var">LedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">UTxOState era
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span><span> </span><span class="annot"><span class="annottext">DPState (Crypto era)
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span></span><span>
</span><span id="line-1723"></span><span>
</span><span id="line-1724"></span><span id="local-6989586621679473076"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier hs-type">DPState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473076"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1725"></span><span>  </span><span id="local-6989586621679473074"><span class="annot"><span class="annottext">def :: DPState crypto
</span><a href="#local-6989586621679473074"><span class="hs-identifier hs-var hs-var hs-var hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DState crypto -&gt; PState crypto -&gt; DPState crypto
forall crypto. DState crypto -&gt; PState crypto -&gt; DPState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#DPState"><span class="hs-identifier hs-var">DPState</span></a></span><span> </span><span class="annot"><span class="annottext">DState crypto
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span><span> </span><span class="annot"><span class="annottext">PState crypto
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span></span><span>
</span><span id="line-1726"></span><span>
</span><span id="line-1727"></span><span id="local-6989586621679473073"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#InstantaneousRewards"><span class="hs-identifier hs-type">InstantaneousRewards</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473073"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1728"></span><span>  </span><span id="local-6989586621679473071"><span class="annot"><span class="annottext">def :: InstantaneousRewards crypto
</span><a href="#local-6989586621679473071"><span class="hs-identifier hs-var hs-var hs-var hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
-&gt; Map (Credential 'Staking crypto) Coin
-&gt; DeltaCoin
-&gt; DeltaCoin
-&gt; InstantaneousRewards crypto
forall crypto.
Map (Credential 'Staking crypto) Coin
-&gt; Map (Credential 'Staking crypto) Coin
-&gt; DeltaCoin
-&gt; DeltaCoin
-&gt; InstantaneousRewards crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#InstantaneousRewards"><span class="hs-identifier hs-var">InstantaneousRewards</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Credential 'Staking crypto) Coin
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaCoin
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">DeltaCoin
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span></span><span>
</span><span id="line-1729"></span><span>
</span><span id="line-1730"></span><span id="local-6989586621679473070"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473070"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1731"></span><span>  </span><span id="local-6989586621679473068"><span class="annot"><span class="annottext">def :: DState crypto
</span><a href="#local-6989586621679473068"><span class="hs-identifier hs-var hs-var hs-var hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DState crypto
forall crypto. DState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#emptyDState"><span class="hs-identifier hs-var">emptyDState</span></a></span></span><span>
</span><span id="line-1732"></span><span>
</span><span id="line-1733"></span><span id="local-6989586621679473067"><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#emptyDState"><span class="hs-identifier hs-type">emptyDState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-type">DState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473067"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1734"></span><span id="emptyDState"><span class="annot"><span class="annottext">emptyDState :: DState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#emptyDState"><span class="hs-identifier hs-var hs-var">emptyDState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1735"></span><span>  </span><span class="annot"><span class="annottext">UnifiedMap crypto
-&gt; Map (FutureGenDeleg crypto) (GenDelegPair crypto)
-&gt; GenDelegs crypto
-&gt; InstantaneousRewards crypto
-&gt; DState crypto
forall crypto.
UnifiedMap crypto
-&gt; Map (FutureGenDeleg crypto) (GenDelegPair crypto)
-&gt; GenDelegs crypto
-&gt; InstantaneousRewards crypto
-&gt; DState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#DState"><span class="hs-identifier hs-var">DState</span></a></span><span>
</span><span id="line-1736"></span><span>    </span><span class="annot"><span class="annottext">UnifiedMap crypto
forall coin cr pool ptr. UMap coin cr pool ptr
</span><a href="../../../../cardano-data/html/src"><span class="hs-identifier hs-var">UM.empty</span></a></span><span>
</span><span id="line-1737"></span><span>    </span><span class="annot"><span class="annottext">Map (FutureGenDeleg crypto) (GenDelegPair crypto)
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-1738"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (KeyHash 'Genesis crypto) (GenDelegPair crypto)
-&gt; GenDelegs crypto
forall crypto.
Map (KeyHash 'Genesis crypto) (GenDelegPair crypto)
-&gt; GenDelegs crypto
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">GenDelegs</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'Genesis crypto) (GenDelegPair crypto)
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1739"></span><span>    </span><span class="annot"><span class="annottext">InstantaneousRewards crypto
forall a. Default a =&gt; a
</span><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-var">def</span></a></span><span>
</span><span id="line-1740"></span><span>
</span><span id="line-1741"></span><span id="local-6989586621679473065"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier hs-type">PState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473065"><span class="hs-identifier hs-type">crypto</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1742"></span><span>  </span><span id="local-6989586621679473063"><span class="annot"><span class="annottext">def :: PState crypto
</span><a href="#local-6989586621679473063"><span class="hs-identifier hs-var hs-var hs-var hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1743"></span><span>    </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
-&gt; Map (KeyHash 'StakePool crypto) (PoolParams crypto)
-&gt; Map (KeyHash 'StakePool crypto) EpochNo
-&gt; PState crypto
forall crypto.
Map (KeyHash 'StakePool crypto) (PoolParams crypto)
-&gt; Map (KeyHash 'StakePool crypto) (PoolParams crypto)
-&gt; Map (KeyHash 'StakePool crypto) EpochNo
-&gt; PState crypto
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#PState"><span class="hs-identifier hs-var">PState</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) (PoolParams crypto)
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">Map (KeyHash 'StakePool crypto) EpochNo
forall k a. Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span></span><span>
</span><span id="line-1744"></span><span>
</span><span id="line-1745"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="annot"><a href="Cardano.Ledger.Shelley.LedgerState.html#AccountState"><span class="hs-identifier hs-type">AccountState</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1746"></span><span>  </span><span id="local-6989586621679473061"><span class="annot"><span class="annottext">def :: AccountState
</span><a href="#local-6989586621679473061"><span class="hs-identifier hs-var hs-var hs-var hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coin -&gt; Coin -&gt; AccountState
</span><a href="Cardano.Ledger.Shelley.LedgerState.html#AccountState"><span class="hs-identifier hs-var">AccountState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Coin
</span><a href="../../../../cardano-ledger-core/html/src"><span class="hs-identifier hs-var">Coin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1747"></span></pre></body></html>