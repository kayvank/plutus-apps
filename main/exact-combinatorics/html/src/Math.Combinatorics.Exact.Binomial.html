<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# OPTIONS_GHC -Wall -fwarn-tabs #-}</span><span>
</span><span id="line-2"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-3"></span><span class="hs-comment">--                                                    2021.10.17</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- Module      :  Math.Combinatorics.Exact.Binomial</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- Copyright   :  Copyright (c) 2011--2021 wren gayle romano</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- License     :  BSD</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- Maintainer  :  wren@cpan.org</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- Stability   :  experimental</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- Portability :  Haskell98</span><span>
</span><span id="line-11"></span><span class="hs-comment">--</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- Binomial coefficients (&lt;http://oeis.org/A007318&gt;), aka the count</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- of possible combinations. For negative inputs, all functions</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- return 0 (rather than throwing an exception or using 'Maybe').</span><span>
</span><span id="line-15"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-16"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Math.Combinatorics.Exact.Binomial</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Math.Combinatorics.Exact.Binomial.html#choose"><span class="hs-identifier">choose</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List</span></a></span><span>                       </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">foldl'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Math.Combinatorics.Exact.Primes.html"><span class="hs-identifier">Math.Combinatorics.Exact.Primes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Math.Combinatorics.Exact.Primes.html#primes"><span class="hs-identifier">primes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-comment">{-
&lt;http://mathworld.wolfram.com/BinomialCoefficient.html&gt;

Some identities, but not really material for RULES:
    n `choose` 0     = 1
    n `choose` 1     = n
    n `choose` 2     = 2*n*(n-1)
    n `choose` k     = n `choose` (n-k) when 0&lt;=k&lt;=n
    n `choose` k     = (-1)^k * ((k-n-1) `choose` k)
    n `choose` (k+1) = (n `choose` k) * ((n-k) / (k+1))
    (n+1) `choose` k = (n `choose` k) * (n `choose` (k-1))
    n `choose` j     = ((n-1)`choose` j) + ((n-1)`choose`(j-1)) when 0&lt;j&lt;n

Regarding the prime factorization/carries thing, also cf:
    Kummer (1852);
    Graham et al. (1989), Exercise 5.36, p. 245;
    Ribenboim (1989);
    Vardi (1991), p. 68

To extend to negative arguments and to complex numbers, see (Kronenburg 2011):
    n `choose` k
        | k &gt;= 0    = (-1)^k     * ((-n+k-1) `choose` k)
        | k &lt;= n    = (-1)^(n-k) * ((-k-1) `choose` (n-k))
        | otherwise = 0

According to Grinstead&amp;Snell, p.95, when using the naive implementation
if you alternatete the multiplications and divisions then all
intermediate values are integers and none of the intermediate values
exceeds the final value. This property is retained in the fast
implementation.
-}</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-comment">-- TODO: give a version that returns the prime-power factorization as [(Int,Int)]</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-comment">-- | Exact binomial coefficients. For a fast approximation see</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- @math-functions:Numeric.SpecFunctions.choose@ instead. The naive</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- definition of the binomial coefficients is:</span><span>
</span><span id="line-60"></span><span class="hs-comment">--</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- &gt; n `choose` k</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- &gt;     | k &lt; 0     = 0</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- &gt;     | k &gt; n     = 0</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- &gt;     | otherwise = factorial n `div` (factorial k * factorial (n-k))</span><span>
</span><span id="line-65"></span><span class="hs-comment">--</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- However, we use a fast implementation based on the prime-power</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- factorization of the result (Goetgheluck, 1987). Each time @n@</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- is larger than the previous calls, there will be some slowdown</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- as the prime numbers must be computed (though it is still much</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- faster than the naive implementation); however, subsequent calls</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- will be extremely fast, since we memoize the list of 'primes'.</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- Do note, however, that this will result in a space leak if you</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- call @choose@ for an extremely large @n@ and then don't need</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- that many primes in the future. Hopefully future versions will</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- correct this issue.</span><span>
</span><span id="line-76"></span><span class="hs-comment">--</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- * P. Goetgheluck (1987)</span><span>
</span><span id="line-78"></span><span class="hs-comment">--    /Computing Binomial Coefficients/,</span><span>
</span><span id="line-79"></span><span class="hs-comment">--    American Mathematical Monthly, 94(4). pp.360--365.</span><span>
</span><span id="line-80"></span><span class="hs-comment">--    &lt;http://www.jstor.org/stable/2323099&gt;,</span><span>
</span><span id="line-81"></span><span class="hs-comment">--    &lt;http://dl.acm.org/citation.cfm?id=26272&gt;</span><span>
</span><span id="line-82"></span><span class="hs-comment">--</span><span>
</span><span id="line-83"></span><span id="local-6989586621679026204"><span class="annot"><a href="Math.Combinatorics.Exact.Binomial.html#choose"><span class="hs-identifier hs-type">choose</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Integral</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679026204"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679026204"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679026204"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679026204"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-comment">-- The result type could be any (Num b) if desired.</span><span>
</span><span id="line-85"></span><span class="hs-pragma">{-# SPECIALIZE</span><span> </span><span class="annot"><a href="Math.Combinatorics.Exact.Binomial.html#choose"><span class="hs-pragma hs-type">choose</span></a></span><span> </span><span class="hs-pragma">::</span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-pragma hs-type">Integer</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-pragma hs-type">Integer</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-pragma hs-type">Integer</span></a></span><span class="hs-pragma">,</span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-pragma hs-type">Int</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-pragma hs-type">Int</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-pragma hs-type">Int</span></a></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-89"></span><span id="local-6989586621679026203"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026203"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="choose"><span class="annot"><span class="annottext">choose :: a -&gt; a -&gt; a
</span><a href="Math.Combinatorics.Exact.Binomial.html#choose"><span class="hs-operator hs-var hs-var">`choose`</span></a></span></span><span> </span><span id="local-6989586621679026202"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026202"><span class="hs-identifier hs-var">k_</span></a></span></span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026203"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`seq`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026202"><span class="hs-identifier hs-var">k_</span></a></span><span class="annot"><span class="annottext">a -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`seq`</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
forall a. HasCallStack =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">undefined</span></a></span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026202"><span class="hs-identifier hs-var">k_</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026202"><span class="hs-identifier hs-var">k_</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026203"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-92"></span><span>        </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026198"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`seq`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026197"><span class="hs-identifier hs-var">nk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`seq`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026196"><span class="hs-identifier hs-var">sqrtN</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`seq`</span></a></span><span>
</span><span id="line-93"></span><span>            </span><span class="annot"><span class="annottext">(a -&gt; Int -&gt; a) -&gt; a -&gt; [Int] -&gt; a
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldl'</span></a></span><span>
</span><span id="line-94"></span><span>                </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679026195"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026195"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621679026194"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679026194"><span class="hs-identifier hs-var">prime</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
</span><a href="#local-6989586621679026193"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026195"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; a
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679026194"><span class="hs-identifier hs-var">prime</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>                </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span>
</span><span id="line-96"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int -&gt; Bool) -&gt; [Int] -&gt; [Int]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">takeWhile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026203"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="Math.Combinatorics.Exact.Primes.html#primes"><span class="hs-identifier hs-var">primes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>        </span><span class="hs-comment">-- BUG: 'takeWhile' isn't a good producer, so we shouldn't</span><span>
</span><span id="line-98"></span><span>        </span><span class="hs-comment">-- just @map fromIntegral@. In newer GHC my patch will make</span><span>
</span><span id="line-99"></span><span>        </span><span class="hs-comment">-- it in for it to be a good producer (and a good consumer).</span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026202"><span class="hs-identifier hs-var">k_</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026202"><span class="hs-identifier hs-var">k_</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026203"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span> </span><span class="hs-comment">-- N.B., @binomial_naive 0 0 == 1@</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-comment">-- TODO: since we know the second operands to quot/rem are</span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-comment">-- positive, we should use quotInt/remInt directly to avoid the</span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-comment">-- extra tests (the overflow errors are not optimized away).</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span>    </span><span id="local-6989586621679026198"><span class="annot"><span class="annottext">k :: a
</span><a href="#local-6989586621679026198"><span class="hs-identifier hs-var hs-var">k</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; a
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; a) -&gt; a -&gt; a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026202"><span class="hs-identifier hs-var">k_</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026203"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">2</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026203"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026202"><span class="hs-identifier hs-var">k_</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026202"><span class="hs-identifier hs-var">k_</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span id="local-6989586621679026197"><span class="annot"><span class="annottext">nk :: a
</span><a href="#local-6989586621679026197"><span class="hs-identifier hs-var hs-var">nk</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026203"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026198"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-109"></span><span>    </span><span id="local-6989586621679026196"><span class="annot"><span class="annottext">sqrtN :: a
</span><a href="#local-6989586621679026196"><span class="hs-identifier hs-var hs-var">sqrtN</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double -&gt; a
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">floor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Double -&gt; Double
forall a. Floating a =&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">sqrt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Double
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026203"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Double</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`asTypeOf`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026203"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span>    </span><span id="local-6989586621679026193"><span class="annot"><span class="annottext">step :: a -&gt; a -&gt; a
</span><a href="#local-6989586621679026193"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679026184"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026184"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621679026183"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span></span><span>
</span><span id="line-112"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026184"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`seq`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`seq`</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
forall a. HasCallStack =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">undefined</span></a></span><span>
</span><span id="line-113"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026197"><span class="hs-identifier hs-var">nk</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026184"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span>
</span><span id="line-114"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026203"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026184"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-115"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026196"><span class="hs-identifier hs-var">sqrtN</span></a></span><span>      </span><span class="hs-glyph">=</span><span>
</span><span id="line-116"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026203"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026198"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span>
</span><span id="line-117"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026184"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span>
</span><span id="line-118"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026184"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-119"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026184"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a -&gt; a -&gt; a
</span><a href="#local-6989586621679026180"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026203"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026198"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span>
</span><span id="line-120"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-121"></span><span>        </span><span id="local-6989586621679026180"><span class="annot"><span class="annottext">go :: a -&gt; a -&gt; a -&gt; a -&gt; a
</span><a href="#local-6989586621679026180"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679026179"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026179"><span class="hs-identifier hs-var">n'</span></a></span></span><span> </span><span id="local-6989586621679026178"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026178"><span class="hs-identifier hs-var">k'</span></a></span></span><span> </span><span id="local-6989586621679026177"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026177"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621679026176"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026176"><span class="hs-identifier hs-var">p</span></a></span></span><span>
</span><span id="line-122"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026179"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`seq`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026178"><span class="hs-identifier hs-var">k'</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`seq`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026177"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`seq`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026176"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`seq`</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
forall a. HasCallStack =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">undefined</span></a></span><span>
</span><span id="line-123"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026179"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026176"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-124"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026179"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026178"><span class="hs-identifier hs-var">k'</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026177"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-125"></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a -&gt; a -&gt; a
</span><a href="#local-6989586621679026180"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026179"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026178"><span class="hs-identifier hs-var">k'</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; a) -&gt; a -&gt; a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026176"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span>
</span><span id="line-126"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a -&gt; a -&gt; a
</span><a href="#local-6989586621679026180"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026179"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026178"><span class="hs-identifier hs-var">k'</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026183"><span class="hs-identifier hs-var">prime</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679026176"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span>        </span><span class="hs-comment">{- -- BENCH: apparently this is an unreliable optimization.
        | otherwise = acc * (prime ^ go n k 0 0)
        where
        go n' k' r p
            | n' &lt;= 0   = p `asTypeOf` acc
            | n' `rem` prime &lt; (k' `rem` prime) + r
                        = go (n' `quot` prime) (k' `quot` prime) 1 $! p+1
            | otherwise = go (n' `quot` prime) (k' `quot` prime) 0 p
        -}</span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-139"></span><span class="hs-comment">----------------------------------------------------------- fin.</span><span>
</span><span id="line-140"></span></pre></body></html>