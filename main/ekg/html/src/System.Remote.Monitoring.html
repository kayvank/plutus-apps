<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP, OverloadedStrings #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-comment">-- | This module provides remote monitoring of a running process over</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- HTTP.  It can be used to run an HTTP server that provides both a</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- web-based user interface and a machine-readable API (e.g. JSON.)</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- The former can be used by a human to get an overview of what the</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- program is doing and the latter can be used by automated monitoring</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- tools.</span><span>
</span><span id="line-9"></span><span class="hs-comment">--</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- Typical usage is to start the monitoring server at program startup</span><span>
</span><span id="line-11"></span><span class="hs-comment">--</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- &gt; main = do</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- &gt;     forkServer &quot;localhost&quot; 8000</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- &gt;     ...</span><span>
</span><span id="line-15"></span><span class="hs-comment">--</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- and then periodically check the stats using a web browser or a</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- command line tool (e.g. curl)</span><span>
</span><span id="line-18"></span><span class="hs-comment">--</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- &gt; $ curl -H &quot;Accept: application/json&quot; http://localhost:8000/</span><span>
</span><span id="line-20"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">System.Remote.Monitoring</span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">(</span><span>
</span><span id="line-22"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Required configuration</span></span><span>
</span><span id="line-23"></span><span>      </span><span class="annot"><span class="hs-comment">-- $configuration</span></span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Security considerations</span></span><span>
</span><span id="line-26"></span><span>      </span><span class="annot"><span class="hs-comment">-- $security</span></span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span>      </span><span class="annot"><span class="hs-comment">-- * REST API</span></span><span>
</span><span id="line-29"></span><span>      </span><span class="annot"><span class="hs-comment">-- $api</span></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span>      </span><span class="annot"><span class="hs-comment">-- * The monitoring server</span></span><span>
</span><span id="line-32"></span><span>      </span><span class="annot"><a href="System.Remote.Monitoring.html#Server"><span class="hs-identifier">Server</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.Remote.Monitoring.html#serverThreadId"><span class="hs-identifier">serverThreadId</span></a></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.Remote.Monitoring.html#serverMetricStore"><span class="hs-identifier">serverMetricStore</span></a></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.Remote.Monitoring.html#forkServer"><span class="hs-identifier">forkServer</span></a></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.Remote.Monitoring.html#forkServerWith"><span class="hs-identifier">forkServerWith</span></a></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span>      </span><span class="annot"><span class="hs-comment">-- * Defining metrics</span></span><span>
</span><span id="line-39"></span><span>      </span><span class="annot"><span class="hs-comment">-- $userdefined</span></span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.Remote.Monitoring.html#getCounter"><span class="hs-identifier">getCounter</span></a></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.Remote.Monitoring.html#getGauge"><span class="hs-identifier">getGauge</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.Remote.Monitoring.html#getLabel"><span class="hs-identifier">getLabel</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.Remote.Monitoring.html#getDistribution"><span class="hs-identifier">getDistribution</span></a></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Concurrent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">ThreadId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">myThreadId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">throwTo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">AsyncException</span></a></span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">ThreadKilled</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">fromException</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../bytestring/html/src"><span class="hs-identifier">Data.ByteString</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Int</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Int64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../time/html/src"><span class="hs-identifier">Data.Time.Clock.POSIX</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../time/html/src"><span class="hs-identifier">getPOSIXTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Prelude</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">read</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../ekg-core/html/src"><span class="hs-identifier">System.Metrics</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Metrics</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../ekg-core/html/src"><span class="hs-identifier">System.Metrics.Counter</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Counter</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../ekg-core/html/src"><span class="hs-identifier">System.Metrics.Distribution</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Distribution</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../ekg-core/html/src"><span class="hs-identifier">System.Metrics.Gauge</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Gauge</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../../../ekg-core/html/src"><span class="hs-identifier">System.Metrics.Label</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Label</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="System.Remote.Snap.html"><span class="hs-identifier">System.Remote.Snap</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../network/html/src"><span class="hs-identifier">Network.Socket</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../network/html/src"><span class="hs-identifier">withSocketsDo</span></a></span><span class="hs-special">)</span><span class="hs-cpp">

#if __GLASGOW_HASKELL__ &gt;= 706
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Concurrent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">forkFinally</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">forkIO</span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">SomeException</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mask</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">try</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- $configuration</span><span>
</span><span id="line-70"></span><span class="hs-comment">--</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- To make full use out of this module you must first enable GC</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- statistics collection in the run-time system. To enable GC</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- statistics collection, either run your program with</span><span>
</span><span id="line-74"></span><span class="hs-comment">--</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- &gt; +RTS -T</span><span>
</span><span id="line-76"></span><span class="hs-comment">--</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- or compile it with</span><span>
</span><span id="line-78"></span><span class="hs-comment">--</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- &gt; -with-rtsopts=-T</span><span>
</span><span id="line-80"></span><span class="hs-comment">--</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- The runtime overhead of @-T@ is very small so it's safe to always</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- leave it enabled.</span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-comment">-- $security</span><span>
</span><span id="line-85"></span><span class="hs-comment">-- Be aware that if the server started by 'forkServer' is not bound to</span><span>
</span><span id="line-86"></span><span class="hs-comment">-- \&quot;localhost\&quot; (or equivalent) anyone on the network can access the</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- monitoring server. Either make sure the network is secure or bind</span><span>
</span><span id="line-88"></span><span class="hs-comment">-- the server to \&quot;localhost\&quot;.</span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-comment">-- $api</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- To use the machine-readable REST API, send an HTTP GET request to</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- the host and port passed to 'forkServer'.</span><span>
</span><span id="line-93"></span><span class="hs-comment">--</span><span>
</span><span id="line-94"></span><span class="hs-comment">-- The API is versioned to allow for API evolution. This document is</span><span>
</span><span id="line-95"></span><span class="hs-comment">-- for version 1. To ensure you're using this version, append @?v=1@</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- to your resource URLs. Omitting the version number will give you</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- the latest version of the API.</span><span>
</span><span id="line-98"></span><span class="hs-comment">--</span><span>
</span><span id="line-99"></span><span class="hs-comment">-- The following resources (i.e. URLs) are available:</span><span>
</span><span id="line-100"></span><span class="hs-comment">--</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- [\/] JSON object containing all metrics. Metrics are stored as</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- nested objects, with one new object layer per \&quot;.\&quot; in the metric</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- name (see example below.) Content types: \&quot;text\/html\&quot; (default),</span><span>
</span><span id="line-104"></span><span class="hs-comment">-- \&quot;application\/json\&quot;</span><span>
</span><span id="line-105"></span><span class="hs-comment">--</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- [\/\&lt;namespace\&gt;/\&lt;metric\&gt;] JSON object for a single metric. The</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- metric name is created by converting all \&quot;\/\&quot; to \&quot;.\&quot;. Example:</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- \&quot;\/foo\/bar\&quot; corresponds to the metric \&quot;foo.bar\&quot;. Content</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- types: \&quot;application\/json\&quot;</span><span>
</span><span id="line-110"></span><span class="hs-comment">--</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- Each metric is returned as an object containing a @type@ field.  Available types</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- are:</span><span>
</span><span id="line-113"></span><span class="hs-comment">--</span><span>
</span><span id="line-114"></span><span class="hs-comment">--  * \&quot;c\&quot; - 'Counter.Counter'</span><span>
</span><span id="line-115"></span><span class="hs-comment">--</span><span>
</span><span id="line-116"></span><span class="hs-comment">--  * \&quot;g\&quot; - 'Gauge.Gauge'</span><span>
</span><span id="line-117"></span><span class="hs-comment">--</span><span>
</span><span id="line-118"></span><span class="hs-comment">--  * \&quot;l\&quot; - 'Label.Label'</span><span>
</span><span id="line-119"></span><span class="hs-comment">--</span><span>
</span><span id="line-120"></span><span class="hs-comment">--  * \&quot;d\&quot; - 'Distribution.Distribution'</span><span>
</span><span id="line-121"></span><span class="hs-comment">--</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- In addition to the @type@ field, there are metric specific fields:</span><span>
</span><span id="line-123"></span><span class="hs-comment">--</span><span>
</span><span id="line-124"></span><span class="hs-comment">--  * Counters, gauges, and labels: the @val@ field contains the</span><span>
</span><span id="line-125"></span><span class="hs-comment">--    actual value (i.e. an integer or a string).</span><span>
</span><span id="line-126"></span><span class="hs-comment">--</span><span>
</span><span id="line-127"></span><span class="hs-comment">--  * Distributions: the @mean@, @variance@, @count@, @sum@, @min@,</span><span>
</span><span id="line-128"></span><span class="hs-comment">--    and @max@ fields contain their statistical equivalents.</span><span>
</span><span id="line-129"></span><span class="hs-comment">--</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- Example of a response containing the metrics \&quot;myapp.visitors\&quot; and</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- \&quot;myapp.args\&quot;:</span><span>
</span><span id="line-132"></span><span class="hs-comment">--</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- &gt; {</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- &gt;   &quot;myapp&quot;: {</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- &gt;     &quot;visitors&quot;: {</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- &gt;       &quot;val&quot;: 10,</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- &gt;       &quot;type&quot;: &quot;c&quot;</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- &gt;     },</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- &gt;     &quot;args&quot;: {</span><span>
</span><span id="line-140"></span><span class="hs-comment">-- &gt;       &quot;val&quot;: &quot;--a-flag&quot;,</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- &gt;       &quot;type&quot;: &quot;l&quot;</span><span>
</span><span id="line-142"></span><span class="hs-comment">-- &gt;     }</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- &gt;   }</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- &gt; }</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-comment">-- $userdefined</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- The monitoring server can store and serve integer-valued counters</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- and gauges, string-valued labels, and statistical distributions. A</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- counter is a monotonically increasing value (e.g. TCP connections</span><span>
</span><span id="line-150"></span><span class="hs-comment">-- established since program start.) A gauge is a variable value (e.g.</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- the current number of concurrent connections.) A label is a</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- free-form string value (e.g. exporting the command line arguments</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- or host name.) A distribution is a statistic summary of events</span><span>
</span><span id="line-154"></span><span class="hs-comment">-- (e.g. processing time per request.) Each metric is associated with</span><span>
</span><span id="line-155"></span><span class="hs-comment">-- a name, which is used when it is displayed in the UI or returned in</span><span>
</span><span id="line-156"></span><span class="hs-comment">-- a JSON object.</span><span>
</span><span id="line-157"></span><span class="hs-comment">--</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- Metrics share the same namespace so it's not possible to create</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- e.g. a counter and a gauge with the same. Attempting to do so will</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- result in an 'error'.</span><span>
</span><span id="line-161"></span><span class="hs-comment">--</span><span>
</span><span id="line-162"></span><span class="hs-comment">-- To create and use a counter, simply call 'getCounter' to create it</span><span>
</span><span id="line-163"></span><span class="hs-comment">-- and then call e.g. 'Counter.inc' or 'Counter.add' to modify its</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- value. Example:</span><span>
</span><span id="line-165"></span><span class="hs-comment">--</span><span>
</span><span id="line-166"></span><span class="hs-comment">-- &gt; main = do</span><span>
</span><span id="line-167"></span><span class="hs-comment">-- &gt;     handle &lt;- forkServer &quot;localhost&quot; 8000</span><span>
</span><span id="line-168"></span><span class="hs-comment">-- &gt;     counter &lt;- getCounter &quot;iterations&quot; handle</span><span>
</span><span id="line-169"></span><span class="hs-comment">-- &gt;     let loop n = do</span><span>
</span><span id="line-170"></span><span class="hs-comment">-- &gt;             inc counter</span><span>
</span><span id="line-171"></span><span class="hs-comment">-- &gt;             loop</span><span>
</span><span id="line-172"></span><span class="hs-comment">-- &gt;     loop</span><span>
</span><span id="line-173"></span><span class="hs-comment">--</span><span>
</span><span id="line-174"></span><span class="hs-comment">-- To create a gauge, use 'getGauge' instead of 'getCounter' and then</span><span>
</span><span id="line-175"></span><span class="hs-comment">-- call e.g. 'System.Remote.Gauge.set'. Similar for the other metric</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- types.</span><span>
</span><span id="line-177"></span><span class="hs-comment">--</span><span>
</span><span id="line-178"></span><span class="hs-comment">-- It's also possible to register metrics directly using the</span><span>
</span><span id="line-179"></span><span class="hs-comment">-- @System.Metrics@ module in the ekg-core package. This gives you a</span><span>
</span><span id="line-180"></span><span class="hs-comment">-- bit more control over how metric values are retrieved.</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-183"></span><span class="hs-comment">-- * The monitoring server</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="hs-comment">-- | A handle that can be used to control the monitoring server.</span><span>
</span><span id="line-186"></span><span class="hs-comment">-- Created by 'forkServer'.</span><span>
</span><span id="line-187"></span><span class="hs-keyword">data</span><span> </span><span id="Server"><span class="annot"><a href="System.Remote.Monitoring.html#Server"><span class="hs-identifier hs-var">Server</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Server"><span class="annot"><a href="System.Remote.Monitoring.html#Server"><span class="hs-identifier hs-var">Server</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-188"></span><span>      </span><span class="hs-comment">-- | The thread ID of the server. You can kill the server by</span><span>
</span><span id="line-189"></span><span>      </span><span class="hs-comment">-- killing this thread (i.e. by throwing it an asynchronous</span><span>
</span><span id="line-190"></span><span>      </span><span class="hs-comment">-- exception.)</span><span>
</span><span id="line-191"></span><span>      </span><span id="serverThreadId"><span class="annot"><span class="annottext">Server -&gt; ThreadId
</span><a href="System.Remote.Monitoring.html#serverThreadId"><span class="hs-identifier hs-var hs-var">serverThreadId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">ThreadId</span></a></span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span>      </span><span class="hs-comment">-- | The metric store associated with the server. If you want to</span><span>
</span><span id="line-194"></span><span>      </span><span class="hs-comment">-- add metric to the default store created by 'forkServer' you</span><span>
</span><span id="line-195"></span><span>      </span><span class="hs-comment">-- need to use this function to retrieve it.</span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="serverMetricStore"><span class="annot"><span class="annottext">Server -&gt; Store
</span><a href="System.Remote.Monitoring.html#serverMetricStore"><span class="hs-identifier hs-var hs-var">serverMetricStore</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../ekg-core/html/src"><span class="hs-identifier hs-type">Metrics.Store</span></a></span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span class="hs-comment">-- | Like 'forkServerWith', but creates a default metric store with</span><span>
</span><span id="line-200"></span><span class="hs-comment">-- some predefined metrics. The predefined metrics are those given in</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- 'System.Metrics.registerGcMetrics'.</span><span>
</span><span id="line-202"></span><span class="annot"><a href="System.Remote.Monitoring.html#forkServer"><span class="hs-identifier hs-type">forkServer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../bytestring/html/src"><span class="hs-identifier hs-type">S.ByteString</span></a></span><span>  </span><span class="hs-comment">-- ^ Host to listen on (e.g. \&quot;localhost\&quot;)</span><span>
</span><span id="line-203"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>           </span><span class="hs-comment">-- ^ Port to listen on (e.g. 8000)</span><span>
</span><span id="line-204"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="System.Remote.Monitoring.html#Server"><span class="hs-identifier hs-type">Server</span></a></span><span>
</span><span id="line-205"></span><span id="forkServer"><span class="annot"><span class="annottext">forkServer :: ByteString -&gt; Int -&gt; IO Server
</span><a href="System.Remote.Monitoring.html#forkServer"><span class="hs-identifier hs-var hs-var">forkServer</span></a></span></span><span> </span><span id="local-6989586621679083304"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679083304"><span class="hs-identifier hs-var">host</span></a></span></span><span> </span><span id="local-6989586621679083303"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679083303"><span class="hs-identifier hs-var">port</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-206"></span><span>    </span><span id="local-6989586621679083302"><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679083302"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Store
</span><a href="../../../../ekg-core/html/src"><span class="hs-identifier hs-var">Metrics.newStore</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><span class="annottext">Store -&gt; IO ()
</span><a href="../../../../ekg-core/html/src"><span class="hs-identifier hs-var">Metrics.registerGcMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679083302"><span class="hs-identifier hs-var">store</span></a></span><span>
</span><span id="line-208"></span><span>    </span><span class="annot"><span class="annottext">Store -&gt; ByteString -&gt; Int -&gt; IO Server
</span><a href="System.Remote.Monitoring.html#forkServerWith"><span class="hs-identifier hs-var">forkServerWith</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679083302"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679083304"><span class="hs-identifier hs-var">host</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679083303"><span class="hs-identifier hs-var">port</span></a></span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span class="hs-comment">-- | Start an HTTP server in a new thread.  The server replies to GET</span><span>
</span><span id="line-211"></span><span class="hs-comment">-- requests to the given host and port.  The host argument can be</span><span>
</span><span id="line-212"></span><span class="hs-comment">-- either a numeric network address (dotted quad for IPv4,</span><span>
</span><span id="line-213"></span><span class="hs-comment">-- colon-separated hex for IPv6) or a hostname (e.g. \&quot;localhost\&quot;.)</span><span>
</span><span id="line-214"></span><span class="hs-comment">-- The client can control the Content-Type used in responses by</span><span>
</span><span id="line-215"></span><span class="hs-comment">-- setting the Accept header.  At the moment two content types are</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- available: \&quot;application\/json\&quot; and \&quot;text\/html\&quot;.</span><span>
</span><span id="line-217"></span><span class="hs-comment">--</span><span>
</span><span id="line-218"></span><span class="hs-comment">-- Registers the following counter, used by the UI:</span><span>
</span><span id="line-219"></span><span class="hs-comment">--</span><span>
</span><span id="line-220"></span><span class="hs-comment">-- [@ekg.server_time_ms@] The server time when the sample was taken,</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- in milliseconds.</span><span>
</span><span id="line-222"></span><span class="hs-comment">--</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- Note that this function, unlike 'forkServer', doesn't register any</span><span>
</span><span id="line-224"></span><span class="hs-comment">-- other predefined metrics. This allows other libraries to create and</span><span>
</span><span id="line-225"></span><span class="hs-comment">-- provide a metric store for use with this library. If the metric</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- store isn't created by you and the creator doesn't register the</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- metrics registered by 'forkServer', you might want to register them</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- yourself.</span><span>
</span><span id="line-229"></span><span class="annot"><a href="System.Remote.Monitoring.html#forkServerWith"><span class="hs-identifier hs-type">forkServerWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ekg-core/html/src"><span class="hs-identifier hs-type">Metrics.Store</span></a></span><span>  </span><span class="hs-comment">-- ^ Metric store</span><span>
</span><span id="line-230"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../bytestring/html/src"><span class="hs-identifier hs-type">S.ByteString</span></a></span><span>   </span><span class="hs-comment">-- ^ Host to listen on (e.g. \&quot;localhost\&quot;)</span><span>
</span><span id="line-231"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>            </span><span class="hs-comment">-- ^ Port to listen on (e.g. 8000)</span><span>
</span><span id="line-232"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="System.Remote.Monitoring.html#Server"><span class="hs-identifier hs-type">Server</span></a></span><span>
</span><span id="line-233"></span><span id="forkServerWith"><span class="annot"><span class="annottext">forkServerWith :: Store -&gt; ByteString -&gt; Int -&gt; IO Server
</span><a href="System.Remote.Monitoring.html#forkServerWith"><span class="hs-identifier hs-var hs-var">forkServerWith</span></a></span></span><span> </span><span id="local-6989586621679083299"><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679083299"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679083298"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679083298"><span class="hs-identifier hs-var">host</span></a></span></span><span> </span><span id="local-6989586621679083297"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679083297"><span class="hs-identifier hs-var">port</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-234"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; IO Int64 -&gt; Store -&gt; IO ()
</span><a href="../../../../ekg-core/html/src"><span class="hs-identifier hs-var">Metrics.registerCounter</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;ekg.server_timestamp_ms&quot;</span></span><span> </span><span class="annot"><span class="annottext">IO Int64
</span><a href="#local-6989586621679083295"><span class="hs-identifier hs-var">getTimeMs</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679083299"><span class="hs-identifier hs-var">store</span></a></span><span>
</span><span id="line-235"></span><span>    </span><span id="local-6989586621679083294"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679083294"><span class="hs-identifier hs-var">me</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">myThreadId</span></a></span><span>
</span><span id="line-236"></span><span>    </span><span id="local-6989586621679083293"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679083293"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ThreadId
forall a. IO a -&gt; IO a
</span><a href="../../../../network/html/src"><span class="hs-identifier hs-var">withSocketsDo</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ThreadId) -&gt; IO ThreadId -&gt; IO ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; (Either SomeException () -&gt; IO ()) -&gt; IO ThreadId
forall a. IO a -&gt; (Either SomeException a -&gt; IO ()) -&gt; IO ThreadId
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forkFinally</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Store -&gt; ByteString -&gt; Int -&gt; IO ()
</span><a href="System.Remote.Snap.html#startServer"><span class="hs-identifier hs-var">startServer</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679083299"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679083298"><span class="hs-identifier hs-var">host</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679083297"><span class="hs-identifier hs-var">port</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Either SomeException () -&gt; IO ()) -&gt; IO ThreadId)
-&gt; (Either SomeException () -&gt; IO ()) -&gt; IO ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621679083291"><span class="annot"><span class="annottext">Either SomeException ()
</span><a href="#local-6989586621679083291"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-237"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either SomeException ()
</span><a href="#local-6989586621679083291"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-238"></span><span>            </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>            </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679083290"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679083290"><span class="hs-identifier hs-var">e</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe AsyncException
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679083290"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-240"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">AsyncException
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">ThreadKilled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>                </span><span class="annot"><span class="annottext">Maybe AsyncException
</span><span class="hs-identifier">_</span></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; SomeException -&gt; IO ()
forall e. Exception e =&gt; ThreadId -&gt; e -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">throwTo</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679083294"><span class="hs-identifier hs-var">me</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679083290"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-242"></span><span>    </span><span class="annot"><span class="annottext">Server -&gt; IO Server
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Server -&gt; IO Server) -&gt; Server -&gt; IO Server
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; Store -&gt; Server
</span><a href="System.Remote.Monitoring.html#Server"><span class="hs-identifier hs-var">Server</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679083293"><span class="hs-identifier hs-var">tid</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679083299"><span class="hs-identifier hs-var">store</span></a></span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><a href="#local-6989586621679083295"><span class="hs-identifier hs-type">getTimeMs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Int64</span></a></span><span>
</span><span id="line-245"></span><span>    </span><span id="local-6989586621679083295"><span class="annot"><span class="annottext">getTimeMs :: IO Int64
</span><a href="#local-6989586621679083295"><span class="hs-identifier hs-var hs-var">getTimeMs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">POSIXTime -&gt; Int64
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">round</span></a></span><span> </span><span class="annot"><span class="annottext">(POSIXTime -&gt; Int64)
-&gt; (POSIXTime -&gt; POSIXTime) -&gt; POSIXTime -&gt; Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">POSIXTime -&gt; POSIXTime -&gt; POSIXTime
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><span class="hs-number">1000</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(POSIXTime -&gt; Int64) -&gt; IO POSIXTime -&gt; IO Int64
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">`fmap`</span></a></span><span> </span><span class="annot"><span class="annottext">IO POSIXTime
</span><a href="../../../../time/html/src"><span class="hs-identifier hs-var">getPOSIXTime</span></a></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-248"></span><span class="hs-comment">-- * Defining metrics</span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span class="hs-comment">-- | Return a new, zero-initialized counter associated with the given</span><span>
</span><span id="line-251"></span><span class="hs-comment">-- name and server. Multiple calls to 'getCounter' with the same</span><span>
</span><span id="line-252"></span><span class="hs-comment">-- arguments will result in an 'error'.</span><span>
</span><span id="line-253"></span><span class="annot"><a href="System.Remote.Monitoring.html#getCounter"><span class="hs-identifier hs-type">getCounter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">T.Text</span></a></span><span>  </span><span class="hs-comment">-- ^ Counter name</span><span>
</span><span id="line-254"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Remote.Monitoring.html#Server"><span class="hs-identifier hs-type">Server</span></a></span><span>  </span><span class="hs-comment">-- ^ Server that will serve the counter</span><span>
</span><span id="line-255"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../../../../ekg-core/html/src"><span class="hs-identifier hs-type">Counter.Counter</span></a></span><span>
</span><span id="line-256"></span><span id="getCounter"><span class="annot"><span class="annottext">getCounter :: Text -&gt; Server -&gt; IO Counter
</span><a href="System.Remote.Monitoring.html#getCounter"><span class="hs-identifier hs-var hs-var">getCounter</span></a></span></span><span> </span><span id="local-6989586621679083285"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679083285"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679083284"><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621679083284"><span class="hs-identifier hs-var">server</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Store -&gt; IO Counter
</span><a href="../../../../ekg-core/html/src"><span class="hs-identifier hs-var">Metrics.createCounter</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679083285"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Server -&gt; Store
</span><a href="System.Remote.Monitoring.html#serverMetricStore"><span class="hs-identifier hs-var hs-var">serverMetricStore</span></a></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621679083284"><span class="hs-identifier hs-var">server</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span class="hs-comment">-- | Return a new, zero-initialized gauge associated with the given</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- name and server. Multiple calls to 'getGauge' with the same</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- arguments will result in an 'error'.</span><span>
</span><span id="line-261"></span><span class="annot"><a href="System.Remote.Monitoring.html#getGauge"><span class="hs-identifier hs-type">getGauge</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">T.Text</span></a></span><span>  </span><span class="hs-comment">-- ^ Gauge name</span><span>
</span><span id="line-262"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Remote.Monitoring.html#Server"><span class="hs-identifier hs-type">Server</span></a></span><span>  </span><span class="hs-comment">-- ^ Server that will serve the gauge</span><span>
</span><span id="line-263"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../../../../ekg-core/html/src"><span class="hs-identifier hs-type">Gauge.Gauge</span></a></span><span>
</span><span id="line-264"></span><span id="getGauge"><span class="annot"><span class="annottext">getGauge :: Text -&gt; Server -&gt; IO Gauge
</span><a href="System.Remote.Monitoring.html#getGauge"><span class="hs-identifier hs-var hs-var">getGauge</span></a></span></span><span> </span><span id="local-6989586621679083282"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679083282"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679083281"><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621679083281"><span class="hs-identifier hs-var">server</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Store -&gt; IO Gauge
</span><a href="../../../../ekg-core/html/src"><span class="hs-identifier hs-var">Metrics.createGauge</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679083282"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Server -&gt; Store
</span><a href="System.Remote.Monitoring.html#serverMetricStore"><span class="hs-identifier hs-var hs-var">serverMetricStore</span></a></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621679083281"><span class="hs-identifier hs-var">server</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span class="hs-comment">-- | Return a new, empty label associated with the given name and</span><span>
</span><span id="line-267"></span><span class="hs-comment">-- server. Multiple calls to 'getLabel' with the same arguments will</span><span>
</span><span id="line-268"></span><span class="hs-comment">-- result in an 'error'.</span><span>
</span><span id="line-269"></span><span class="annot"><a href="System.Remote.Monitoring.html#getLabel"><span class="hs-identifier hs-type">getLabel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">T.Text</span></a></span><span>  </span><span class="hs-comment">-- ^ Label name</span><span>
</span><span id="line-270"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Remote.Monitoring.html#Server"><span class="hs-identifier hs-type">Server</span></a></span><span>  </span><span class="hs-comment">-- ^ Server that will serve the label</span><span>
</span><span id="line-271"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../../../../ekg-core/html/src"><span class="hs-identifier hs-type">Label.Label</span></a></span><span>
</span><span id="line-272"></span><span id="getLabel"><span class="annot"><span class="annottext">getLabel :: Text -&gt; Server -&gt; IO Label
</span><a href="System.Remote.Monitoring.html#getLabel"><span class="hs-identifier hs-var hs-var">getLabel</span></a></span></span><span> </span><span id="local-6989586621679083279"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679083279"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679083278"><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621679083278"><span class="hs-identifier hs-var">server</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Store -&gt; IO Label
</span><a href="../../../../ekg-core/html/src"><span class="hs-identifier hs-var">Metrics.createLabel</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679083279"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Server -&gt; Store
</span><a href="System.Remote.Monitoring.html#serverMetricStore"><span class="hs-identifier hs-var hs-var">serverMetricStore</span></a></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621679083278"><span class="hs-identifier hs-var">server</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span class="hs-comment">-- | Return a new distribution associated with the given name and</span><span>
</span><span id="line-275"></span><span class="hs-comment">-- server. Multiple calls to 'getDistribution' with the same arguments</span><span>
</span><span id="line-276"></span><span class="hs-comment">-- will result in an 'error'.</span><span>
</span><span id="line-277"></span><span class="annot"><a href="System.Remote.Monitoring.html#getDistribution"><span class="hs-identifier hs-type">getDistribution</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">T.Text</span></a></span><span>  </span><span class="hs-comment">-- ^ Distribution name</span><span>
</span><span id="line-278"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Remote.Monitoring.html#Server"><span class="hs-identifier hs-type">Server</span></a></span><span>  </span><span class="hs-comment">-- ^ Server that will serve the distribution</span><span>
</span><span id="line-279"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../../../../ekg-core/html/src"><span class="hs-identifier hs-type">Distribution.Distribution</span></a></span><span>
</span><span id="line-280"></span><span id="getDistribution"><span class="annot"><span class="annottext">getDistribution :: Text -&gt; Server -&gt; IO Distribution
</span><a href="System.Remote.Monitoring.html#getDistribution"><span class="hs-identifier hs-var hs-var">getDistribution</span></a></span></span><span> </span><span id="local-6989586621679083276"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679083276"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679083275"><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621679083275"><span class="hs-identifier hs-var">server</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-281"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; Store -&gt; IO Distribution
</span><a href="../../../../ekg-core/html/src"><span class="hs-identifier hs-var">Metrics.createDistribution</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679083276"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Server -&gt; Store
</span><a href="System.Remote.Monitoring.html#serverMetricStore"><span class="hs-identifier hs-var hs-var">serverMetricStore</span></a></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621679083275"><span class="hs-identifier hs-var">server</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><span id="line-284"></span><span class="hs-comment">-- Backwards compatibility shims</span><span class="hs-cpp">

#if __GLASGOW_HASKELL__ &lt; 706
</span><span class="hs-identifier">forkFinally</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Either</span><span> </span><span class="hs-identifier">SomeException</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">ThreadId</span><span>
</span><span id="line-288"></span><span class="hs-identifier">forkFinally</span><span> </span><span class="hs-identifier">action</span><span> </span><span class="hs-identifier">and_then</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-identifier">mask</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">restore</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-290"></span><span>    </span><span class="hs-identifier">forkIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">try</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">restore</span><span> </span><span class="hs-identifier">action</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">and_then</span><span class="hs-cpp">
#endif
</span></pre></body></html>