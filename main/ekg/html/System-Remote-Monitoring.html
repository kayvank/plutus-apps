<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>System.Remote.Monitoring</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">ekg-0.4.0.15: Remote monitoring of processes</span><ul class="links" id="page-menu"><li><a href="src/System.Remote.Monitoring.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell98</td></tr></table><p class="caption">System.Remote.Monitoring</p></div><div id="table-of-contents"><div id="contents-list"><p class="caption" onclick="window.scrollTo(0,0)">Contents</p><ul><li><a href="#g:1">Required configuration</a></li><li><a href="#g:2">Security considerations</a></li><li><a href="#g:3">REST API</a></li><li><a href="#g:4">The monitoring server</a></li><li><a href="#g:5">Defining metrics</a></li></ul></div></div><div id="description"><p class="caption">Description</p><div class="doc"><p>This module provides remote monitoring of a running process over
 HTTP.  It can be used to run an HTTP server that provides both a
 web-based user interface and a machine-readable API (e.g. JSON.)
 The former can be used by a human to get an overview of what the
 program is doing and the latter can be used by automated monitoring
 tools.</p><p>Typical usage is to start the monitoring server at program startup</p><pre>main = do
    forkServer &quot;localhost&quot; 8000
    ...</pre><p>and then periodically check the stats using a web browser or a
 command line tool (e.g. curl)</p><pre>$ curl -H &quot;Accept: application/json&quot; http://localhost:8000/</pre></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><span class="keyword">data</span> <a href="#t:Server">Server</a></li><li class="src short"><a href="#v:serverThreadId">serverThreadId</a> :: <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Concurrent.html#t:ThreadId" title="Control.Concurrent">ThreadId</a></li><li class="src short"><a href="#v:serverMetricStore">serverMetricStore</a> :: <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a> -&gt; <a href="../../ekg-core/html/System-Metrics.html#t:Store" title="System.Metrics">Store</a></li><li class="src short"><a href="#v:forkServer">forkServer</a> :: <a href="../../bytestring/html/Data-ByteString.html#t:ByteString" title="Data.ByteString">ByteString</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/Data-Int.html#t:Int" title="Data.Int">Int</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a></li><li class="src short"><a href="#v:forkServerWith">forkServerWith</a> :: <a href="../../ekg-core/html/System-Metrics.html#t:Store" title="System.Metrics">Store</a> -&gt; <a href="../../bytestring/html/Data-ByteString.html#t:ByteString" title="Data.ByteString">ByteString</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/Data-Int.html#t:Int" title="Data.Int">Int</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a></li><li class="src short"><a href="#v:getCounter">getCounter</a> :: <a href="../../text/html/Data-Text.html#t:Text" title="Data.Text">Text</a> -&gt; <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="System-Remote-Counter.html#t:Counter" title="System.Remote.Counter">Counter</a></li><li class="src short"><a href="#v:getGauge">getGauge</a> :: <a href="../../text/html/Data-Text.html#t:Text" title="Data.Text">Text</a> -&gt; <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="System-Remote-Gauge.html#t:Gauge" title="System.Remote.Gauge">Gauge</a></li><li class="src short"><a href="#v:getLabel">getLabel</a> :: <a href="../../text/html/Data-Text.html#t:Text" title="Data.Text">Text</a> -&gt; <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="System-Remote-Label.html#t:Label" title="System.Remote.Label">Label</a></li><li class="src short"><a href="#v:getDistribution">getDistribution</a> :: <a href="../../text/html/Data-Text.html#t:Text" title="Data.Text">Text</a> -&gt; <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="../../ekg-core/html/System-Metrics-Distribution.html#t:Distribution" title="System.Metrics.Distribution">Distribution</a></li></ul></details></div><div id="interface"><a href="#g:1" id="g:1"><h1>Required configuration</h1></a><div class="doc"><p>To make full use out of this module you must first enable GC
 statistics collection in the run-time system. To enable GC
 statistics collection, either run your program with</p><pre>+RTS -T</pre><p>or compile it with</p><pre>-with-rtsopts=-T</pre><p>The runtime overhead of <code>-T</code> is very small so it's safe to always
 leave it enabled.</p></div><a href="#g:2" id="g:2"><h1>Security considerations</h1></a><div class="doc"><p>Be aware that if the server started by <code><a href="System-Remote-Monitoring.html#v:forkServer" title="System.Remote.Monitoring">forkServer</a></code> is not bound to
 &quot;localhost&quot; (or equivalent) anyone on the network can access the
 monitoring server. Either make sure the network is secure or bind
 the server to &quot;localhost&quot;.</p></div><a href="#g:3" id="g:3"><h1>REST API</h1></a><div class="doc"><p>To use the machine-readable REST API, send an HTTP GET request to
 the host and port passed to <code><a href="System-Remote-Monitoring.html#v:forkServer" title="System.Remote.Monitoring">forkServer</a></code>.</p><p>The API is versioned to allow for API evolution. This document is
 for version 1. To ensure you're using this version, append <code>?v=1</code>
 to your resource URLs. Omitting the version number will give you
 the latest version of the API.</p><p>The following resources (i.e. URLs) are available:</p><dl><dt>/</dt><dd>JSON object containing all metrics. Metrics are stored as
 nested objects, with one new object layer per &quot;.&quot; in the metric
 name (see example below.) Content types: &quot;text/html&quot; (default),
 &quot;application/json&quot;</dd><dt>/&lt;namespace&gt;/&lt;metric&gt;</dt><dd>JSON object for a single metric. The
 metric name is created by converting all &quot;/&quot; to &quot;.&quot;. Example:
 &quot;/foo/bar&quot; corresponds to the metric &quot;foo.bar&quot;. Content
 types: &quot;application/json&quot;</dd></dl><p>Each metric is returned as an object containing a <code>type</code> field.  Available types
 are:</p><ul><li>&quot;c&quot; - <code><a href="System-Remote-Counter.html#t:Counter" title="System.Remote.Counter">Counter</a></code></li><li>&quot;g&quot; - <code><a href="System-Remote-Gauge.html#t:Gauge" title="System.Remote.Gauge">Gauge</a></code></li><li>&quot;l&quot; - <code><a href="System-Remote-Label.html#t:Label" title="System.Remote.Label">Label</a></code></li><li>&quot;d&quot; - <code><a href="../../ekg-core/html/System-Metrics-Distribution.html#t:Distribution" title="System.Metrics.Distribution">Distribution</a></code></li></ul><p>In addition to the <code>type</code> field, there are metric specific fields:</p><ul><li>Counters, gauges, and labels: the <code>val</code> field contains the
    actual value (i.e. an integer or a string).</li><li>Distributions: the <code>mean</code>, <code>variance</code>, <code>count</code>, <code>sum</code>, <code>min</code>,
    and <code>max</code> fields contain their statistical equivalents.</li></ul><p>Example of a response containing the metrics &quot;myapp.visitors&quot; and
 &quot;myapp.args&quot;:</p><pre>{
  &quot;myapp&quot;: {
    &quot;visitors&quot;: {
      &quot;val&quot;: 10,
      &quot;type&quot;: &quot;c&quot;
    },
    &quot;args&quot;: {
      &quot;val&quot;: &quot;--a-flag&quot;,
      &quot;type&quot;: &quot;l&quot;
    }
  }
}</pre></div><a href="#g:4" id="g:4"><h1>The monitoring server</h1></a><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:Server" class="def">Server</a> <a href="src/System.Remote.Monitoring.html#Server" class="link">Source</a> <a href="#t:Server" class="selflink">#</a></p><div class="doc"><p>A handle that can be used to control the monitoring server.
 Created by <code><a href="System-Remote-Monitoring.html#v:forkServer" title="System.Remote.Monitoring">forkServer</a></code>.</p></div></div><div class="top"><p class="src"><a id="v:serverThreadId" class="def">serverThreadId</a> :: <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a> -&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/Control-Concurrent.html#t:ThreadId" title="Control.Concurrent">ThreadId</a> <a href="src/System.Remote.Monitoring.html#serverThreadId" class="link">Source</a> <a href="#v:serverThreadId" class="selflink">#</a></p><div class="doc"><p>The thread ID of the server. You can kill the server by
 killing this thread (i.e. by throwing it an asynchronous
 exception.)</p></div></div><div class="top"><p class="src"><a id="v:serverMetricStore" class="def">serverMetricStore</a> :: <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a> -&gt; <a href="../../ekg-core/html/System-Metrics.html#t:Store" title="System.Metrics">Store</a> <a href="src/System.Remote.Monitoring.html#serverMetricStore" class="link">Source</a> <a href="#v:serverMetricStore" class="selflink">#</a></p><div class="doc"><p>The metric store associated with the server. If you want to
 add metric to the default store created by <code><a href="System-Remote-Monitoring.html#v:forkServer" title="System.Remote.Monitoring">forkServer</a></code> you
 need to use this function to retrieve it.</p></div></div><div class="top"><p class="src"><a id="v:forkServer" class="def">forkServer</a> <a href="src/System.Remote.Monitoring.html#forkServer" class="link">Source</a> <a href="#v:forkServer" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="../../bytestring/html/Data-ByteString.html#t:ByteString" title="Data.ByteString">ByteString</a></td><td class="doc"><p>Host to listen on (e.g. &quot;localhost&quot;)</p></td></tr><tr><td class="src">-&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/Data-Int.html#t:Int" title="Data.Int">Int</a></td><td class="doc"><p>Port to listen on (e.g. 8000)</p></td></tr><tr><td class="src">-&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Like <code><a href="System-Remote-Monitoring.html#v:forkServerWith" title="System.Remote.Monitoring">forkServerWith</a></code>, but creates a default metric store with
 some predefined metrics. The predefined metrics are those given in
 <code><a href="../../ekg-core/html/System-Metrics.html#v:registerGcMetrics" title="System.Metrics">registerGcMetrics</a></code>.</p></div></div><div class="top"><p class="src"><a id="v:forkServerWith" class="def">forkServerWith</a> <a href="src/System.Remote.Monitoring.html#forkServerWith" class="link">Source</a> <a href="#v:forkServerWith" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="../../ekg-core/html/System-Metrics.html#t:Store" title="System.Metrics">Store</a></td><td class="doc"><p>Metric store</p></td></tr><tr><td class="src">-&gt; <a href="../../bytestring/html/Data-ByteString.html#t:ByteString" title="Data.ByteString">ByteString</a></td><td class="doc"><p>Host to listen on (e.g. &quot;localhost&quot;)</p></td></tr><tr><td class="src">-&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/Data-Int.html#t:Int" title="Data.Int">Int</a></td><td class="doc"><p>Port to listen on (e.g. 8000)</p></td></tr><tr><td class="src">-&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Start an HTTP server in a new thread.  The server replies to GET
 requests to the given host and port.  The host argument can be
 either a numeric network address (dotted quad for IPv4,
 colon-separated hex for IPv6) or a hostname (e.g. &quot;localhost&quot;.)
 The client can control the Content-Type used in responses by
 setting the Accept header.  At the moment two content types are
 available: &quot;application/json&quot; and &quot;text/html&quot;.</p><p>Registers the following counter, used by the UI:</p><dl><dt><code>ekg.server_time_ms</code></dt><dd>The server time when the sample was taken,
 in milliseconds.</dd></dl><p>Note that this function, unlike <code><a href="System-Remote-Monitoring.html#v:forkServer" title="System.Remote.Monitoring">forkServer</a></code>, doesn't register any
 other predefined metrics. This allows other libraries to create and
 provide a metric store for use with this library. If the metric
 store isn't created by you and the creator doesn't register the
 metrics registered by <code><a href="System-Remote-Monitoring.html#v:forkServer" title="System.Remote.Monitoring">forkServer</a></code>, you might want to register them
 yourself.</p></div></div><a href="#g:5" id="g:5"><h1>Defining metrics</h1></a><div class="doc"><p>The monitoring server can store and serve integer-valued counters
 and gauges, string-valued labels, and statistical distributions. A
 counter is a monotonically increasing value (e.g. TCP connections
 established since program start.) A gauge is a variable value (e.g.
 the current number of concurrent connections.) A label is a
 free-form string value (e.g. exporting the command line arguments
 or host name.) A distribution is a statistic summary of events
 (e.g. processing time per request.) Each metric is associated with
 a name, which is used when it is displayed in the UI or returned in
 a JSON object.</p><p>Metrics share the same namespace so it's not possible to create
 e.g. a counter and a gauge with the same. Attempting to do so will
 result in an <code><a href="../../ghc/html/libraries/base-4.14.3.0/Prelude.html#v:error" title="Prelude">error</a></code>.</p><p>To create and use a counter, simply call <code><a href="System-Remote-Monitoring.html#v:getCounter" title="System.Remote.Monitoring">getCounter</a></code> to create it
 and then call e.g. <code><a href="System-Remote-Counter.html#v:inc" title="System.Remote.Counter">inc</a></code> or <code><a href="System-Remote-Counter.html#v:add" title="System.Remote.Counter">add</a></code> to modify its
 value. Example:</p><pre>main = do
    handle &lt;- forkServer &quot;localhost&quot; 8000
    counter &lt;- getCounter &quot;iterations&quot; handle
    let loop n = do
            inc counter
            loop
    loop</pre><p>To create a gauge, use <code><a href="System-Remote-Monitoring.html#v:getGauge" title="System.Remote.Monitoring">getGauge</a></code> instead of <code><a href="System-Remote-Monitoring.html#v:getCounter" title="System.Remote.Monitoring">getCounter</a></code> and then
 call e.g. <code><a href="System-Remote-Gauge.html#v:set" title="System.Remote.Gauge">set</a></code>. Similar for the other metric
 types.</p><p>It's also possible to register metrics directly using the
 <code>System.Metrics</code> module in the ekg-core package. This gives you a
 bit more control over how metric values are retrieved.</p></div><div class="top"><p class="src"><a id="v:getCounter" class="def">getCounter</a> <a href="src/System.Remote.Monitoring.html#getCounter" class="link">Source</a> <a href="#v:getCounter" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="../../text/html/Data-Text.html#t:Text" title="Data.Text">Text</a></td><td class="doc"><p>Counter name</p></td></tr><tr><td class="src">-&gt; <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a></td><td class="doc"><p>Server that will serve the counter</p></td></tr><tr><td class="src">-&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="System-Remote-Counter.html#t:Counter" title="System.Remote.Counter">Counter</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Return a new, zero-initialized counter associated with the given
 name and server. Multiple calls to <code><a href="System-Remote-Monitoring.html#v:getCounter" title="System.Remote.Monitoring">getCounter</a></code> with the same
 arguments will result in an <code><a href="../../ghc/html/libraries/base-4.14.3.0/Prelude.html#v:error" title="Prelude">error</a></code>.</p></div></div><div class="top"><p class="src"><a id="v:getGauge" class="def">getGauge</a> <a href="src/System.Remote.Monitoring.html#getGauge" class="link">Source</a> <a href="#v:getGauge" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="../../text/html/Data-Text.html#t:Text" title="Data.Text">Text</a></td><td class="doc"><p>Gauge name</p></td></tr><tr><td class="src">-&gt; <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a></td><td class="doc"><p>Server that will serve the gauge</p></td></tr><tr><td class="src">-&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="System-Remote-Gauge.html#t:Gauge" title="System.Remote.Gauge">Gauge</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Return a new, zero-initialized gauge associated with the given
 name and server. Multiple calls to <code><a href="System-Remote-Monitoring.html#v:getGauge" title="System.Remote.Monitoring">getGauge</a></code> with the same
 arguments will result in an <code><a href="../../ghc/html/libraries/base-4.14.3.0/Prelude.html#v:error" title="Prelude">error</a></code>.</p></div></div><div class="top"><p class="src"><a id="v:getLabel" class="def">getLabel</a> <a href="src/System.Remote.Monitoring.html#getLabel" class="link">Source</a> <a href="#v:getLabel" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="../../text/html/Data-Text.html#t:Text" title="Data.Text">Text</a></td><td class="doc"><p>Label name</p></td></tr><tr><td class="src">-&gt; <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a></td><td class="doc"><p>Server that will serve the label</p></td></tr><tr><td class="src">-&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="System-Remote-Label.html#t:Label" title="System.Remote.Label">Label</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Return a new, empty label associated with the given name and
 server. Multiple calls to <code><a href="System-Remote-Monitoring.html#v:getLabel" title="System.Remote.Monitoring">getLabel</a></code> with the same arguments will
 result in an <code><a href="../../ghc/html/libraries/base-4.14.3.0/Prelude.html#v:error" title="Prelude">error</a></code>.</p></div></div><div class="top"><p class="src"><a id="v:getDistribution" class="def">getDistribution</a> <a href="src/System.Remote.Monitoring.html#getDistribution" class="link">Source</a> <a href="#v:getDistribution" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="../../text/html/Data-Text.html#t:Text" title="Data.Text">Text</a></td><td class="doc"><p>Distribution name</p></td></tr><tr><td class="src">-&gt; <a href="System-Remote-Monitoring.html#t:Server" title="System.Remote.Monitoring">Server</a></td><td class="doc"><p>Server that will serve the distribution</p></td></tr><tr><td class="src">-&gt; <a href="../../ghc/html/libraries/base-4.14.3.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="../../ekg-core/html/System-Metrics-Distribution.html#t:Distribution" title="System.Metrics.Distribution">Distribution</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Return a new distribution associated with the given name and
 server. Multiple calls to <code><a href="System-Remote-Monitoring.html#v:getDistribution" title="System.Remote.Monitoring">getDistribution</a></code> with the same arguments
 will result in an <code><a href="../../ghc/html/libraries/base-4.14.3.0/Prelude.html#v:error" title="Prelude">error</a></code>.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.24.2</p></div></body></html>