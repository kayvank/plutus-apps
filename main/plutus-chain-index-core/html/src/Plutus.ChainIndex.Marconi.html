<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts    #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase          #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards     #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell     #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications    #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Plutus.ChainIndex.Marconi</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Cardano.Api</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">AddressInEra</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">AddressInEra</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">AddressTypeInEra</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">TxIx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">TxIx</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">toAddressAny</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier">Cardano.Api</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.BM.Trace</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Trace</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Concurrent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">MVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">newMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">putMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">takeMVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">Control.Lens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">Lens'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">_1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">folded</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">makeLenses</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">views</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&amp;)</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-operator">(.~)</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-operator">(^.)</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-operator">(^..)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">Control.Monad.Freer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">Eff</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">LastMember</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">Member</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">interpret</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="../../../../natural-transformation/html/src"><span class="hs-operator">(~&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">Control.Monad.Freer.Error</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">Error</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">runError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">throwError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../freer-extras/html/src"><span class="hs-identifier">Control.Monad.Freer.Extras</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../freer-extras/html/src"><span class="hs-identifier">Control.Monad.Freer.Extras.Pagination</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../freer-extras/html/src"><span class="hs-identifier">PageQuery</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-extras/html/src"><span class="hs-identifier">pageOf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">Control.Monad.Freer.Reader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">Reader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">ask</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">runReader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">Control.Monad.Freer.State</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Eff</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">State</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">get</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">put</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">runState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">Control.Monad.Freer.TH</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier">makeEffect</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad.IO.Class</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">MonadIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">liftIO</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">foldl'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">elems</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Address</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">CardanoAddress</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Tx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">CardanoTx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">CardanoTx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier">Marconi.ChainIndex.Indexers.Utxo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier">UtxoEvent</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableQuery</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier">UtxoByAddress</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier">UtxoHandle</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>                                         </span><span class="annot"><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier">getInputs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier">getUtxoResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier">getUtxos</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier">txId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier">txIx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier">urUtxo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Marconi.Core.Storable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">HasPoint</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">QueryInterval</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">QEverything</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">Queryable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">State</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableMonad</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorablePoint</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>                              </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">StorableResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">insertMany</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier">query</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Api.html"><span class="hs-identifier">Plutus.ChainIndex.Api</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.ChainIndex.Api.html#UtxosResponse"><span class="hs-identifier">UtxosResponse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.ChainIndex.Api.html#UtxosResponse"><span class="hs-identifier">UtxosResponse</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.ChainIndexError.html"><span class="hs-identifier">Plutus.ChainIndex.ChainIndexError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.ChainIndex.ChainIndexError.html#ChainIndexError"><span class="hs-identifier">ChainIndexError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.ChainIndexLog.html"><span class="hs-identifier">Plutus.ChainIndex.ChainIndexLog</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.ChainIndex.ChainIndexLog.html#ChainIndexLog"><span class="hs-identifier">ChainIndexLog</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Compatibility.html"><span class="hs-identifier">Plutus.ChainIndex.Compatibility</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.ChainIndex.Compatibility.html#toCardanoPoint"><span class="hs-identifier">toCardanoPoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Effects.html"><span class="hs-identifier">Plutus.ChainIndex.Effects</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.ChainIndex.Effects.html#ChainIndexControlEffect"><span class="hs-identifier">ChainIndexControlEffect</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.ChainIndex.Effects.html#AppendBlocks"><span class="hs-identifier">AppendBlocks</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Effects.html#ChainIndexQueryEffect"><span class="hs-identifier">ChainIndexQueryEffect</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.ChainIndex.Effects.html#UtxoSetAtAddress"><span class="hs-identifier">UtxoSetAtAddress</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Types.html"><span class="hs-identifier">Plutus.ChainIndex.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.ChainIndex.Types.html#ChainSyncBlock"><span class="hs-identifier">ChainSyncBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Types.html#Tip"><span class="hs-identifier">Tip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.ChainIndex.Types.html#TipAtGenesis"><span class="hs-identifier">TipAtGenesis</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Types.html#citxCardanoTx"><span class="hs-identifier">citxCardanoTx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Types.html#tipAsPoint"><span class="hs-identifier">tipAsPoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Contract.CardanoAPI.html"><span class="hs-identifier">Plutus.Contract.CardanoAPI</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">fromCardanoTxId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Monitoring.Util.html"><span class="hs-identifier">Plutus.Monitoring.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Monitoring.Util.html#PrettyObject"><span class="hs-identifier">PrettyObject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Monitoring.Util.html#PrettyObject"><span class="hs-identifier">PrettyObject</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Monitoring.Util.html#convertLog"><span class="hs-identifier">convertLog</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Monitoring.Util.html#runLogEffects"><span class="hs-identifier">runLogEffects</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Plutus.V2.Ledger.Api</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">TxOutRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">TxOutRef</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-comment">{- Handling ChainIndexEffects with Marconi - Developer notes:

    The general idea is to transform `ChainIndexQueryEffect` into a @MarconiEffect@ for an handler,
    and to resolve these effects afterwards with a bunch of calls to `handleMarconiQuery`.

    The  main reason for this is that we mutualise the code that queries the handlers (see @handleMarconiQuery@) and we have a
    uniform way to query the different indexers.

    And a minor one:

        * There's no need of different handlers for @MarconiEffect@ at this stage but we leave the door open to it.
          A possible use case might be to provide a simpler indexer backend for the emulator.

    How to add new indexer to support new effect?

        1. add the indexer MVar to `ChainIndexIndexersMvar` and the corresponding indexer to `ChainIndexIndexers`
        2. edit `getChainIndexIndexers` and `putChainIndexIndexers` accordingly
        3. handle the appropriate queries of `ChainIndexQueries` in `handleQuery`
        4. Add the indexer update in the control operations
-}</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-keyword">data</span><span> </span><span id="ChainIndexIndexers"><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexers"><span class="hs-identifier hs-var">ChainIndexIndexers</span></a></span></span><span> </span><span class="hs-comment">-- We don't use `newtype` since other indexers will be needed</span><span>
</span><span id="line-69"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="ChainIndexIndexers"><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexers"><span class="hs-identifier hs-var">ChainIndexIndexers</span></a></span></span><span>
</span><span id="line-70"></span><span>       </span><span class="hs-special">{</span><span> </span><span id="_utxosIndexer"><span class="annot"><span class="annottext">ChainIndexIndexers -&gt; State UtxoHandle
</span><a href="Plutus.ChainIndex.Marconi.html#_utxosIndexer"><span class="hs-identifier hs-var hs-var">_utxosIndexer</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier hs-type">UtxoHandle</span></a></span><span>
</span><span id="line-71"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span id="utxosIndexer"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">ChainIndexIndexers</span></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-keyword">data</span><span> </span><span id="ChainIndexIndexersMVar"><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexersMVar"><span class="hs-identifier hs-var">ChainIndexIndexersMVar</span></a></span></span><span> </span><span class="hs-comment">-- We don't use `newtype` since other indexers will be needed</span><span>
</span><span id="line-76"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="ChainIndexIndexersMVar"><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexersMVar"><span class="hs-identifier hs-var">ChainIndexIndexersMVar</span></a></span></span><span>
</span><span id="line-77"></span><span>       </span><span class="hs-special">{</span><span> </span><span id="_utxosIndexerMVar"><span class="annot"><span class="annottext">ChainIndexIndexersMVar -&gt; MVar (State UtxoHandle)
</span><a href="Plutus.ChainIndex.Marconi.html#_utxosIndexerMVar"><span class="hs-identifier hs-var hs-var">_utxosIndexerMVar</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier hs-type">UtxoHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#boxChainIndexIndexers"><span class="hs-identifier hs-type">boxChainIndexIndexers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexers"><span class="hs-identifier hs-type">ChainIndexIndexers</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexersMVar"><span class="hs-identifier hs-type">ChainIndexIndexersMVar</span></a></span><span>
</span><span id="line-81"></span><span id="boxChainIndexIndexers"><span class="annot"><span class="annottext">boxChainIndexIndexers :: ChainIndexIndexers -&gt; IO ChainIndexIndexersMVar
</span><a href="Plutus.ChainIndex.Marconi.html#boxChainIndexIndexers"><span class="hs-identifier hs-var hs-var">boxChainIndexIndexers</span></a></span></span><span> </span><span id="local-6989586621679764610"><span class="annot"><span class="annottext">ChainIndexIndexers
</span><a href="#local-6989586621679764610"><span class="hs-identifier hs-var">ci</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-82"></span><span>  </span><span class="annot"><span class="annottext">MVar (State UtxoHandle) -&gt; ChainIndexIndexersMVar
</span><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexersMVar"><span class="hs-identifier hs-var">ChainIndexIndexersMVar</span></a></span><span> </span><span class="annot"><span class="annottext">(MVar (State UtxoHandle) -&gt; ChainIndexIndexersMVar)
-&gt; IO (MVar (State UtxoHandle)) -&gt; IO ChainIndexIndexersMVar
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-83"></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State UtxoHandle -&gt; IO (MVar (State UtxoHandle))
forall a. a -&gt; IO (MVar a)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">newMVar</span></a></span><span> </span><span class="annot"><span class="annottext">(State UtxoHandle -&gt; IO (MVar (State UtxoHandle)))
-&gt; State UtxoHandle -&gt; IO (MVar (State UtxoHandle))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexers
</span><a href="#local-6989586621679764610"><span class="hs-identifier hs-var">ci</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexers
-&gt; Getting (State UtxoHandle) ChainIndexIndexers (State UtxoHandle)
-&gt; State UtxoHandle
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting (State UtxoHandle) ChainIndexIndexers (State UtxoHandle)
Iso' ChainIndexIndexers (State UtxoHandle)
</span><a href="Plutus.ChainIndex.Marconi.html#utxosIndexer"><span class="hs-identifier hs-var">utxosIndexer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span id="utxosIndexerMVar"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">ChainIndexIndexersMVar</span></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#getChainIndexIndexers"><span class="hs-identifier hs-type">getChainIndexIndexers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexersMVar"><span class="hs-identifier hs-type">ChainIndexIndexersMVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexers"><span class="hs-identifier hs-type">ChainIndexIndexers</span></a></span><span>
</span><span id="line-88"></span><span id="getChainIndexIndexers"><span class="annot"><span class="annottext">getChainIndexIndexers :: ChainIndexIndexersMVar -&gt; IO ChainIndexIndexers
</span><a href="Plutus.ChainIndex.Marconi.html#getChainIndexIndexers"><span class="hs-identifier hs-var hs-var">getChainIndexIndexers</span></a></span></span><span> </span><span id="local-6989586621679764606"><span class="annot"><span class="annottext">ChainIndexIndexersMVar
</span><a href="#local-6989586621679764606"><span class="hs-identifier hs-var">mvarCi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><span class="annottext">State UtxoHandle -&gt; ChainIndexIndexers
</span><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexers"><span class="hs-identifier hs-var">ChainIndexIndexers</span></a></span><span> </span><span class="annot"><span class="annottext">(State UtxoHandle -&gt; ChainIndexIndexers)
-&gt; IO (State UtxoHandle) -&gt; IO ChainIndexIndexers
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (State UtxoHandle) -&gt; IO (State UtxoHandle)
forall a. MVar a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">takeMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainIndexIndexersMVar
</span><a href="#local-6989586621679764606"><span class="hs-identifier hs-var">mvarCi</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexersMVar
-&gt; Getting
     (MVar (State UtxoHandle))
     ChainIndexIndexersMVar
     (MVar (State UtxoHandle))
-&gt; MVar (State UtxoHandle)
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting
  (MVar (State UtxoHandle))
  ChainIndexIndexersMVar
  (MVar (State UtxoHandle))
Iso' ChainIndexIndexersMVar (MVar (State UtxoHandle))
</span><a href="Plutus.ChainIndex.Marconi.html#utxosIndexerMVar"><span class="hs-identifier hs-var">utxosIndexerMVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#putChainIndexIndexers"><span class="hs-identifier hs-type">putChainIndexIndexers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexers"><span class="hs-identifier hs-type">ChainIndexIndexers</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexersMVar"><span class="hs-identifier hs-type">ChainIndexIndexersMVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span id="putChainIndexIndexers"><span class="annot"><span class="annottext">putChainIndexIndexers :: ChainIndexIndexers -&gt; ChainIndexIndexersMVar -&gt; IO ()
</span><a href="Plutus.ChainIndex.Marconi.html#putChainIndexIndexers"><span class="hs-identifier hs-var hs-var">putChainIndexIndexers</span></a></span></span><span> </span><span id="local-6989586621679764604"><span class="annot"><span class="annottext">ChainIndexIndexers
</span><a href="#local-6989586621679764604"><span class="hs-identifier hs-var">ci</span></a></span></span><span> </span><span id="local-6989586621679764603"><span class="annot"><span class="annottext">ChainIndexIndexersMVar
</span><a href="#local-6989586621679764603"><span class="hs-identifier hs-var">mvarCi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-93"></span><span>    </span><span class="annot"><span class="annottext">MVar (State UtxoHandle) -&gt; State UtxoHandle -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">putMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainIndexIndexersMVar
</span><a href="#local-6989586621679764603"><span class="hs-identifier hs-var">mvarCi</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexersMVar
-&gt; Getting
     (MVar (State UtxoHandle))
     ChainIndexIndexersMVar
     (MVar (State UtxoHandle))
-&gt; MVar (State UtxoHandle)
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting
  (MVar (State UtxoHandle))
  ChainIndexIndexersMVar
  (MVar (State UtxoHandle))
Iso' ChainIndexIndexersMVar (MVar (State UtxoHandle))
</span><a href="Plutus.ChainIndex.Marconi.html#utxosIndexerMVar"><span class="hs-identifier hs-var">utxosIndexerMVar</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainIndexIndexers
</span><a href="#local-6989586621679764604"><span class="hs-identifier hs-var">ci</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexers
-&gt; Getting (State UtxoHandle) ChainIndexIndexers (State UtxoHandle)
-&gt; State UtxoHandle
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting (State UtxoHandle) ChainIndexIndexers (State UtxoHandle)
Iso' ChainIndexIndexers (State UtxoHandle)
</span><a href="Plutus.ChainIndex.Marconi.html#utxosIndexer"><span class="hs-identifier hs-var">utxosIndexer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-keyword">data</span><span> </span><span id="MarconiEffect"><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#MarconiEffect"><span class="hs-identifier hs-var">MarconiEffect</span></a></span></span><span> </span><span id="local-6989586621679764602"><span class="annot"><a href="#local-6989586621679764602"><span class="hs-identifier hs-type">handle</span></a></span></span><span> </span><span id="local-6989586621679764601"><span class="annot"><a href="#local-6989586621679764601"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-98"></span><span>  </span><span id="local-6989586621679764783"><span id="QueryIndexer"><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#QueryIndexer"><span class="hs-identifier hs-var">QueryIndexer</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764783"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#MarconiEffect"><span class="hs-identifier hs-type">MarconiEffect</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764783"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764783"><span class="hs-identifier hs-type">handle</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span id="queryIndexer"><span id="local-6989586621679764782"><span id="local-6989586621679764783"><span class="hs-identifier">makeEffect</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">MarconiEffect</span></span></span></span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span id="local-6989586621679764690"><span id="local-6989586621679764691"><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#handleMarconiQuery"><span class="hs-identifier hs-type">handleMarconiQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">LastMember</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764691"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Member</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Eff.State</span></a></span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexers"><span class="hs-identifier hs-type">ChainIndexIndexers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679764691"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764690"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">HasPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764690"><span class="hs-identifier hs-type">handle</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764690"><span class="hs-identifier hs-type">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764690"><span class="hs-identifier hs-type">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">Queryable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764690"><span class="hs-identifier hs-type">handle</span></a></span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier hs-type">Lens'</span></a></span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexers"><span class="hs-identifier hs-type">ChainIndexIndexers</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764690"><span class="hs-identifier hs-type">handle</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#MarconiEffect"><span class="hs-identifier hs-type">MarconiEffect</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764690"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="../../../../natural-transformation/html/src"><span class="hs-operator hs-type">~&gt;</span></a></span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764691"><span class="hs-identifier hs-type">effs</span></a></span></span></span><span>
</span><span id="line-111"></span><span id="handleMarconiQuery"><span class="annot"><span class="annottext">handleMarconiQuery :: Lens' ChainIndexIndexers (State handle)
-&gt; MarconiEffect handle ~&gt; Eff effs
</span><a href="Plutus.ChainIndex.Marconi.html#handleMarconiQuery"><span class="hs-identifier hs-var hs-var">handleMarconiQuery</span></a></span></span><span> </span><span id="local-6989586621679764597"><span class="annot"><span class="annottext">Lens' ChainIndexIndexers (State handle)
</span><a href="#local-6989586621679764597"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#QueryIndexer"><span class="hs-identifier hs-type">QueryIndexer</span></a></span><span> </span><span id="local-6989586621679764596"><span class="annot"><span class="annottext">StorableQuery handle
</span><a href="#local-6989586621679764596"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-112"></span><span>  </span><span id="local-6989586621679764595"><span class="annot"><span class="annottext">ChainIndexIndexers
</span><a href="#local-6989586621679764595"><span class="hs-identifier hs-var">ci</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff effs ChainIndexIndexers
forall s (effs :: [* -&gt; *]). Member (State s) effs =&gt; Eff effs s
</span><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-var">Eff.get</span></a></span><span>
</span><span id="line-113"></span><span>  </span><span class="annot"><span class="annottext">IO x -&gt; Eff effs x
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO x -&gt; Eff effs x) -&gt; IO x -&gt; Eff effs x
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">QueryInterval (StorablePoint handle)
-&gt; State handle
-&gt; StorableQuery handle
-&gt; StorableMonad handle (StorableResult handle)
forall h.
(HasPoint (StorableEvent h) (StorablePoint h),
 Ord (StorablePoint h), Queryable h, PrimMonad (StorableMonad h)) =&gt;
QueryInterval (StorablePoint h)
-&gt; State h -&gt; StorableQuery h -&gt; StorableMonad h (StorableResult h)
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="annot"><span class="annottext">QueryInterval (StorablePoint handle)
forall p. QueryInterval p
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">QEverything</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainIndexIndexers
</span><a href="#local-6989586621679764595"><span class="hs-identifier hs-var">ci</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexers
-&gt; Getting (State handle) ChainIndexIndexers (State handle)
-&gt; State handle
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting (State handle) ChainIndexIndexers (State handle)
Lens' ChainIndexIndexers (State handle)
</span><a href="#local-6989586621679764597"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StorableQuery handle
</span><a href="#local-6989586621679764596"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#getUtxoSetAtAddress"><span class="hs-identifier hs-type">getUtxoSetAtAddress</span></a></span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679764689"><span class="annot"><a href="#local-6989586621679764689"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Member</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#MarconiEffect"><span class="hs-identifier hs-type">MarconiEffect</span></a></span><span> </span><span class="annot"><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier hs-type">UtxoHandle</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679764689"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../freer-extras/html/src"><span class="hs-identifier hs-type">PageQuery</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">TxOutRef</span></a></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">CardanoAddress</span></a></span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764689"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Api.html#UtxosResponse"><span class="hs-identifier hs-type">UtxosResponse</span></a></span><span>
</span><span id="line-122"></span><span id="getUtxoSetAtAddress"><span class="annot"><span class="annottext">getUtxoSetAtAddress :: PageQuery TxOutRef -&gt; CardanoAddress -&gt; Eff effs UtxosResponse
</span><a href="Plutus.ChainIndex.Marconi.html#getUtxoSetAtAddress"><span class="hs-identifier hs-var hs-var">getUtxoSetAtAddress</span></a></span></span><span> </span><span id="local-6989586621679764593"><span class="annot"><span class="annottext">PageQuery TxOutRef
</span><a href="#local-6989586621679764593"><span class="hs-identifier hs-var">pageQuery</span></a></span></span><span> </span><span id="local-6989586621679764592"><span class="annot"><span class="annottext">CardanoAddress
</span><a href="#local-6989586621679764592"><span class="hs-identifier hs-var">addrInEra</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-123"></span><span>    </span><span id="local-6989586621679764591"><span class="annot"><span class="annottext">toTxOutRef :: Utxo -&gt; TxOutRef
</span><a href="#local-6989586621679764591"><span class="hs-identifier hs-var hs-var">toTxOutRef</span></a></span></span><span> </span><span id="local-6989586621679764590"><span class="annot"><span class="annottext">Utxo
</span><a href="#local-6989586621679764590"><span class="hs-identifier hs-var">utxo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxId -&gt; Integer -&gt; TxOutRef
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">TxOutRef</span></a></span><span>
</span><span id="line-124"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxId -&gt; TxId
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">fromCardanoTxId</span></a></span><span> </span><span class="annot"><span class="annottext">(TxId -&gt; TxId) -&gt; TxId -&gt; TxId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Utxo
</span><a href="#local-6989586621679764590"><span class="hs-identifier hs-var">utxo</span></a></span><span> </span><span class="annot"><span class="annottext">Utxo -&gt; Getting TxId Utxo TxId -&gt; TxId
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting TxId Utxo TxId
Lens' Utxo TxId
</span><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier hs-var">txId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; Integer
forall a. Integral a =&gt; a -&gt; Integer
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">toInteger</span></a></span><span> </span><span class="annot"><span class="annottext">(Word -&gt; Integer) -&gt; (TxIx -&gt; Word) -&gt; TxIx -&gt; Integer
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">TxIx</span></a></span><span> </span><span id="local-6989586621679764588"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679764588"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679764588"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TxIx -&gt; Integer) -&gt; TxIx -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Utxo
</span><a href="#local-6989586621679764590"><span class="hs-identifier hs-var">utxo</span></a></span><span> </span><span class="annot"><span class="annottext">Utxo -&gt; Getting TxIx Utxo TxIx -&gt; TxIx
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting TxIx Utxo TxIx
Lens' Utxo TxIx
</span><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier hs-var">txIx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>    </span><span id="local-6989586621679764587"><span class="annot"><span class="annottext">addr :: AddressAny
</span><a href="#local-6989586621679764587"><span class="hs-identifier hs-var hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CardanoAddress
</span><a href="#local-6989586621679764592"><span class="hs-identifier hs-var">addrInEra</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-127"></span><span>                </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">AddressInEra</span></a></span><span> </span><span class="annot"><span class="annottext">AddressTypeInEra addrtype BabbageEra
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">ByronAddressInAnyEra</span></a></span><span> </span><span id="local-6989586621679764585"><span class="annot"><span class="annottext">Address addrtype
</span><a href="#local-6989586621679764585"><span class="hs-identifier hs-var">addr'</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Address addrtype -&gt; AddressAny
forall addr. Address addr -&gt; AddressAny
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">toAddressAny</span></a></span><span> </span><span class="annot"><span class="annottext">Address addrtype
</span><a href="#local-6989586621679764585"><span class="hs-identifier hs-var">addr'</span></a></span><span>
</span><span id="line-128"></span><span>                </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">AddressInEra</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">ShelleyAddressInEra</span></a></span><span> </span><span class="annot"><span class="annottext">ShelleyBasedEra BabbageEra
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679764583"><span class="annot"><span class="annottext">Address addrtype
</span><a href="#local-6989586621679764583"><span class="hs-identifier hs-var">addr'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Address addrtype -&gt; AddressAny
forall addr. Address addr -&gt; AddressAny
</span><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-var">toAddressAny</span></a></span><span> </span><span class="annot"><span class="annottext">Address addrtype
</span><a href="#local-6989586621679764583"><span class="hs-identifier hs-var">addr'</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Tip -&gt; Page TxOutRef -&gt; UtxosResponse
</span><a href="Plutus.ChainIndex.Api.html#UtxosResponse"><span class="hs-identifier hs-var">UtxosResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Tip
</span><a href="Plutus.ChainIndex.Types.html#TipAtGenesis"><span class="hs-identifier hs-var">TipAtGenesis</span></a></span><span>
</span><span id="line-130"></span><span>           </span><span class="annot"><span class="annottext">(Page TxOutRef -&gt; UtxosResponse)
-&gt; (StorableResult UtxoHandle -&gt; Page TxOutRef)
-&gt; StorableResult UtxoHandle
-&gt; UtxosResponse
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">PageQuery TxOutRef -&gt; Set TxOutRef -&gt; Page TxOutRef
forall a. Eq a =&gt; PageQuery a -&gt; Set a -&gt; Page a
</span><a href="../../../../freer-extras/html/src"><span class="hs-identifier hs-var">pageOf</span></a></span><span> </span><span class="annot"><span class="annottext">PageQuery TxOutRef
</span><a href="#local-6989586621679764593"><span class="hs-identifier hs-var">pageQuery</span></a></span><span>
</span><span id="line-131"></span><span>           </span><span class="annot"><span class="annottext">(Set TxOutRef -&gt; Page TxOutRef)
-&gt; (StorableResult UtxoHandle -&gt; Set TxOutRef)
-&gt; StorableResult UtxoHandle
-&gt; Page TxOutRef
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[TxOutRef] -&gt; Set TxOutRef
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span>
</span><span id="line-132"></span><span>           </span><span class="annot"><span class="annottext">([TxOutRef] -&gt; Set TxOutRef)
-&gt; (StorableResult UtxoHandle -&gt; [TxOutRef])
-&gt; StorableResult UtxoHandle
-&gt; Set TxOutRef
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(UtxoRow -&gt; TxOutRef) -&gt; [UtxoRow] -&gt; [TxOutRef]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LensLike' (Const TxOutRef) UtxoRow Utxo
-&gt; (Utxo -&gt; TxOutRef) -&gt; UtxoRow -&gt; TxOutRef
forall s (m :: * -&gt; *) r a.
MonadReader s m =&gt;
LensLike' (Const r) s a -&gt; (a -&gt; r) -&gt; m r
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">views</span></a></span><span> </span><span class="annot"><span class="annottext">LensLike' (Const TxOutRef) UtxoRow Utxo
Lens' UtxoRow Utxo
</span><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier hs-var">urUtxo</span></a></span><span> </span><span class="annot"><span class="annottext">Utxo -&gt; TxOutRef
</span><a href="#local-6989586621679764591"><span class="hs-identifier hs-var">toTxOutRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>           </span><span class="annot"><span class="annottext">([UtxoRow] -&gt; [TxOutRef])
-&gt; (StorableResult UtxoHandle -&gt; [UtxoRow])
-&gt; StorableResult UtxoHandle
-&gt; [TxOutRef]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">StorableResult UtxoHandle -&gt; [UtxoRow]
</span><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier hs-var hs-var">getUtxoResult</span></a></span><span>
</span><span id="line-134"></span><span>           </span><span class="annot"><span class="annottext">(StorableResult UtxoHandle -&gt; UtxosResponse)
-&gt; Eff effs (StorableResult UtxoHandle) -&gt; Eff effs UtxosResponse
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StorableQuery UtxoHandle -&gt; Eff effs (StorableResult UtxoHandle)
forall handle (effs :: [* -&gt; *]).
Member (MarconiEffect handle) effs =&gt;
StorableQuery handle -&gt; Eff effs (StorableResult handle)
</span><a href="Plutus.ChainIndex.Marconi.html#queryIndexer"><span class="hs-identifier hs-var">queryIndexer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddressAny -&gt; Maybe SlotNo -&gt; StorableQuery UtxoHandle
</span><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier hs-var">UtxoByAddress</span></a></span><span> </span><span class="annot"><span class="annottext">AddressAny
</span><a href="#local-6989586621679764587"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SlotNo
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#getUtxoEvents"><span class="hs-identifier hs-type">getUtxoEvents</span></a></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">CardanoTx</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-api/html/src"><span class="hs-identifier hs-type">C.ChainPoint</span></a></span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier hs-type">UtxoHandle</span></a></span><span> </span><span class="hs-comment">-- ^ UtxoEvents are stored in storage after conversion to UtxoRow</span><span>
</span><span id="line-141"></span><span id="getUtxoEvents"><span class="annot"><span class="annottext">getUtxoEvents :: [CardanoTx] -&gt; ChainPoint -&gt; StorableEvent UtxoHandle
</span><a href="Plutus.ChainIndex.Marconi.html#getUtxoEvents"><span class="hs-identifier hs-var hs-var">getUtxoEvents</span></a></span></span><span> </span><span id="local-6989586621679764580"><span class="annot"><span class="annottext">[CardanoTx]
</span><a href="#local-6989586621679764580"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span id="local-6989586621679764579"><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679764579"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679764578"><span class="annot"><span class="annottext">utxosFromCardanoTx :: CardanoTx -&gt; [Utxo]
</span><a href="#local-6989586621679764578"><span class="hs-identifier hs-var hs-var">utxosFromCardanoTx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">CardanoTx</span></a></span><span> </span><span id="local-6989586621679764577"><span class="annot"><span class="annottext">Tx era
</span><a href="#local-6989586621679764577"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="annot"><span class="annottext">EraInMode era CardanoMode
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map TxIn Utxo -&gt; [Utxo]
forall k a. Map k a -&gt; [a]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">elems</span></a></span><span> </span><span class="annot"><span class="annottext">(Map TxIn Utxo -&gt; [Utxo]) -&gt; Map TxIn Utxo -&gt; [Utxo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TargetAddresses -&gt; Tx era -&gt; Map TxIn Utxo
forall era.
IsCardanoEra era =&gt;
Maybe TargetAddresses -&gt; Tx era -&gt; Map TxIn Utxo
</span><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier hs-var">getUtxos</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TargetAddresses
forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">Tx era
</span><a href="#local-6989586621679764577"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-143"></span><span>      </span><span id="local-6989586621679764576"><span class="annot"><span class="annottext">inputsFromCardanoTx :: CardanoTx -&gt; Set TxIn
</span><a href="#local-6989586621679764576"><span class="hs-identifier hs-var hs-var">inputsFromCardanoTx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">CardanoTx</span></a></span><span> </span><span id="local-6989586621679764575"><span class="annot"><span class="annottext">Tx era
</span><a href="#local-6989586621679764575"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="annot"><span class="annottext">EraInMode era CardanoMode
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tx era -&gt; Set TxIn
forall era. Tx era -&gt; Set TxIn
</span><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier hs-var">getInputs</span></a></span><span> </span><span class="annot"><span class="annottext">Tx era
</span><a href="#local-6989586621679764575"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-144"></span><span>      </span><span id="local-6989586621679764574"><span class="annot"><span class="annottext">utxos :: Set Utxo
</span><a href="#local-6989586621679764574"><span class="hs-identifier hs-var hs-var">utxos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Utxo] -&gt; Set Utxo
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Utxo] -&gt; Set Utxo) -&gt; [Utxo] -&gt; Set Utxo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(CardanoTx -&gt; [Utxo]) -&gt; [CardanoTx] -&gt; [Utxo]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">concatMap</span></a></span><span> </span><span class="annot"><span class="annottext">CardanoTx -&gt; [Utxo]
</span><a href="#local-6989586621679764578"><span class="hs-identifier hs-var">utxosFromCardanoTx</span></a></span><span> </span><span class="annot"><span class="annottext">[CardanoTx]
</span><a href="#local-6989586621679764580"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-145"></span><span>      </span><span id="local-6989586621679764572"><span class="annot"><span class="annottext">ins :: Set TxIn
</span><a href="#local-6989586621679764572"><span class="hs-identifier hs-var hs-var">ins</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Set TxIn -&gt; Set TxIn -&gt; Set TxIn)
-&gt; Set TxIn -&gt; [Set TxIn] -&gt; Set TxIn
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">Set TxIn -&gt; Set TxIn -&gt; Set TxIn
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">Set TxIn
forall a. Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.empty</span></a></span><span> </span><span class="annot"><span class="annottext">([Set TxIn] -&gt; Set TxIn) -&gt; [Set TxIn] -&gt; Set TxIn
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CardanoTx -&gt; Set TxIn
</span><a href="#local-6989586621679764576"><span class="hs-identifier hs-var">inputsFromCardanoTx</span></a></span><span> </span><span class="annot"><span class="annottext">(CardanoTx -&gt; Set TxIn) -&gt; [CardanoTx] -&gt; [Set TxIn]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[CardanoTx]
</span><a href="#local-6989586621679764580"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Set Utxo -&gt; Set TxIn -&gt; ChainPoint -&gt; StorableEvent UtxoHandle
</span><a href="../../../../marconi-chain-index/html/src"><span class="hs-identifier hs-var">UtxoEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Set Utxo
</span><a href="#local-6989586621679764574"><span class="hs-identifier hs-var">utxos</span></a></span><span> </span><span class="annot"><span class="annottext">Set TxIn
</span><a href="#local-6989586621679764572"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679764579"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span class="hs-comment">-- | The required arguments to run the chain index effects.</span><span>
</span><span id="line-149"></span><span class="hs-keyword">data</span><span> </span><span id="RunRequirements"><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#RunRequirements"><span class="hs-identifier hs-var">RunRequirements</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RunRequirements"><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#RunRequirements"><span class="hs-identifier hs-var">RunRequirements</span></a></span></span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="trace"><span class="annot"><span class="annottext">RunRequirements -&gt; Trace IO (PrettyObject ChainIndexLog)
</span><a href="Plutus.ChainIndex.Marconi.html#trace"><span class="hs-identifier hs-var hs-var">trace</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Trace</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Monitoring.Util.html#PrettyObject"><span class="hs-identifier hs-type">PrettyObject</span></a></span><span> </span><span class="annot"><a href="Plutus.ChainIndex.ChainIndexLog.html#ChainIndexLog"><span class="hs-identifier hs-type">ChainIndexLog</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="indexers"><span class="annot"><span class="annottext">RunRequirements -&gt; ChainIndexIndexersMVar
</span><a href="Plutus.ChainIndex.Marconi.html#indexers"><span class="hs-identifier hs-var hs-var">indexers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexersMVar"><span class="hs-identifier hs-type">ChainIndexIndexersMVar</span></a></span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="hs-comment">-- | Run the chain index effects.</span><span>
</span><span id="line-156"></span><span id="local-6989586621679764566"><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#runChainIndexEffects"><span class="hs-identifier hs-type">runChainIndexEffects</span></a></span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#RunRequirements"><span class="hs-identifier hs-type">RunRequirements</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="annot"><a href="Plutus.ChainIndex.Effects.html#ChainIndexQueryEffect"><span class="hs-identifier hs-type">ChainIndexQueryEffect</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Effects.html#ChainIndexControlEffect"><span class="hs-identifier hs-type">ChainIndexControlEffect</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><a href="#local-6989586621679764566"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Plutus.ChainIndex.ChainIndexError.html#ChainIndexError"><span class="hs-identifier hs-type">ChainIndexError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764566"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-160"></span><span id="runChainIndexEffects"><span class="annot"><span class="annottext">runChainIndexEffects :: RunRequirements
-&gt; Eff '[ChainIndexQueryEffect, ChainIndexControlEffect] a
-&gt; IO (Either ChainIndexError a)
</span><a href="Plutus.ChainIndex.Marconi.html#runChainIndexEffects"><span class="hs-identifier hs-var hs-var">runChainIndexEffects</span></a></span></span><span> </span><span id="local-6989586621679764564"><span class="annot"><span class="annottext">RunRequirements
</span><a href="#local-6989586621679764564"><span class="hs-identifier hs-var">runReq</span></a></span></span><span> </span><span id="local-6989586621679764563"><span class="annot"><span class="annottext">Eff '[ChainIndexQueryEffect, ChainIndexControlEffect] a
</span><a href="#local-6989586621679764563"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-161"></span><span>    </span><span class="annot"><span class="annottext">Trace IO ChainIndexLog -&gt; Eff '[LogMsg ChainIndexLog, IO] ~&gt; IO
forall (m :: * -&gt; *) l.
MonadIO m =&gt;
Trace m l -&gt; Eff '[LogMsg l, m] ~&gt; m
</span><a href="Plutus.Monitoring.Util.html#runLogEffects"><span class="hs-identifier hs-var">runLogEffects</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ChainIndexLog -&gt; PrettyObject ChainIndexLog)
-&gt; Trace IO (PrettyObject ChainIndexLog) -&gt; Trace IO ChainIndexLog
forall a b (m :: * -&gt; *). (a -&gt; b) -&gt; Trace m b -&gt; Trace m a
</span><a href="Plutus.Monitoring.Util.html#convertLog"><span class="hs-identifier hs-var">convertLog</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexLog -&gt; PrettyObject ChainIndexLog
forall t. t -&gt; PrettyObject t
</span><a href="Plutus.Monitoring.Util.html#PrettyObject"><span class="hs-identifier hs-var">PrettyObject</span></a></span><span> </span><span class="annot"><span class="annottext">(Trace IO (PrettyObject ChainIndexLog) -&gt; Trace IO ChainIndexLog)
-&gt; Trace IO (PrettyObject ChainIndexLog) -&gt; Trace IO ChainIndexLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RunRequirements -&gt; Trace IO (PrettyObject ChainIndexLog)
</span><a href="Plutus.ChainIndex.Marconi.html#trace"><span class="hs-identifier hs-var hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">RunRequirements
</span><a href="#local-6989586621679764564"><span class="hs-identifier hs-var">runReq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>        </span><span class="annot"><span class="annottext">(Eff '[LogMsg ChainIndexLog, IO] (Either ChainIndexError a)
 -&gt; IO (Either ChainIndexError a))
-&gt; Eff '[LogMsg ChainIndexLog, IO] (Either ChainIndexError a)
-&gt; IO (Either ChainIndexError a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexersMVar
-&gt; Eff
     '[Reader ChainIndexIndexersMVar, LogMsg ChainIndexLog, IO]
     (Either ChainIndexError a)
-&gt; Eff '[LogMsg ChainIndexLog, IO] (Either ChainIndexError a)
forall r (effs :: [* -&gt; *]) a.
r -&gt; Eff (Reader r : effs) a -&gt; Eff effs a
</span><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-var">runReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RunRequirements -&gt; ChainIndexIndexersMVar
</span><a href="Plutus.ChainIndex.Marconi.html#indexers"><span class="hs-identifier hs-var hs-var">indexers</span></a></span><span> </span><span class="annot"><span class="annottext">RunRequirements
</span><a href="#local-6989586621679764564"><span class="hs-identifier hs-var">runReq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>        </span><span class="annot"><span class="annottext">(Eff
   '[Reader ChainIndexIndexersMVar, LogMsg ChainIndexLog, IO]
   (Either ChainIndexError a)
 -&gt; Eff '[LogMsg ChainIndexLog, IO] (Either ChainIndexError a))
-&gt; Eff
     '[Reader ChainIndexIndexersMVar, LogMsg ChainIndexLog, IO]
     (Either ChainIndexError a)
-&gt; Eff '[LogMsg ChainIndexLog, IO] (Either ChainIndexError a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Eff
  '[ChainIndexQueryEffect, ChainIndexControlEffect,
    Reader ChainIndexIndexersMVar, LogMsg ChainIndexLog, IO]
  a
-&gt; Eff
     '[Reader ChainIndexIndexersMVar, LogMsg ChainIndexLog, IO]
     (Either ChainIndexError a)
forall (effs :: [* -&gt; *]) a.
(LastMember IO effs,
 Member (Reader ChainIndexIndexersMVar) effs) =&gt;
Eff (ChainIndexQueryEffect : ChainIndexControlEffect : effs) a
-&gt; Eff effs (Either ChainIndexError a)
</span><a href="Plutus.ChainIndex.Marconi.html#handleChainIndexEffects"><span class="hs-identifier hs-var">handleChainIndexEffects</span></a></span><span>
</span><span id="line-164"></span><span>        </span><span class="annot"><span class="annottext">(Eff
   '[ChainIndexQueryEffect, ChainIndexControlEffect,
     Reader ChainIndexIndexersMVar, LogMsg ChainIndexLog, IO]
   a
 -&gt; Eff
      '[Reader ChainIndexIndexersMVar, LogMsg ChainIndexLog, IO]
      (Either ChainIndexError a))
-&gt; Eff
     '[ChainIndexQueryEffect, ChainIndexControlEffect,
       Reader ChainIndexIndexersMVar, LogMsg ChainIndexLog, IO]
     a
-&gt; Eff
     '[Reader ChainIndexIndexersMVar, LogMsg ChainIndexLog, IO]
     (Either ChainIndexError a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Eff '[ChainIndexQueryEffect, ChainIndexControlEffect] a
-&gt; Eff
     '[ChainIndexQueryEffect, ChainIndexControlEffect,
       Reader ChainIndexIndexersMVar, LogMsg ChainIndexLog, IO]
     a
forall (effs :: [* -&gt; *]) (as :: [* -&gt; *]).
CanWeakenEnd as effs =&gt;
Eff as ~&gt; Eff effs
</span><a href="../../../../freer-extras/html/src"><span class="hs-identifier hs-var">raiseEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Eff '[ChainIndexQueryEffect, ChainIndexControlEffect] a
</span><a href="#local-6989586621679764563"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span id="local-6989586621679764678"><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#handleControl"><span class="hs-identifier hs-type">handleControl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">LastMember</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764678"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Member</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Eff.State</span></a></span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexers"><span class="hs-identifier hs-type">ChainIndexIndexers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679764678"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Member</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Error</span></a></span><span> </span><span class="annot"><a href="Plutus.ChainIndex.ChainIndexError.html#ChainIndexError"><span class="hs-identifier hs-type">ChainIndexError</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679764678"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><a href="Plutus.ChainIndex.Effects.html#ChainIndexControlEffect"><span class="hs-identifier hs-type">ChainIndexControlEffect</span></a></span><span> </span><span class="annot"><a href="../../../../natural-transformation/html/src"><span class="hs-operator hs-type">~&gt;</span></a></span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764678"><span class="hs-identifier hs-type">effs</span></a></span></span><span>
</span><span id="line-172"></span><span id="handleControl"><span class="annot"><span class="annottext">handleControl :: ChainIndexControlEffect ~&gt; Eff effs
</span><a href="Plutus.ChainIndex.Marconi.html#handleControl"><span class="hs-identifier hs-var hs-var">handleControl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-173"></span><span>    </span><span class="annot"><a href="Plutus.ChainIndex.Effects.html#AppendBlocks"><span class="hs-identifier hs-type">AppendBlocks</span></a></span><span> </span><span id="local-6989586621679764559"><span class="annot"><span class="annottext">[ChainSyncBlock]
</span><a href="#local-6989586621679764559"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-174"></span><span>        </span><span id="local-6989586621679764558"><span class="annot"><span class="annottext">ChainIndexIndexers
</span><a href="#local-6989586621679764558"><span class="hs-identifier hs-var">ci</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff effs ChainIndexIndexers
forall s (effs :: [* -&gt; *]). Member (State s) effs =&gt; Eff effs s
</span><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-var">Eff.get</span></a></span><span>
</span><span id="line-175"></span><span>        </span><span id="local-6989586621679764557"><span class="annot"><span class="annottext">State UtxoHandle
</span><a href="#local-6989586621679764557"><span class="hs-identifier hs-var">utxosIndexer'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (State UtxoHandle) -&gt; Eff effs (State UtxoHandle)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (State UtxoHandle) -&gt; Eff effs (State UtxoHandle))
-&gt; IO (State UtxoHandle) -&gt; Eff effs (State UtxoHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent UtxoHandle]
-&gt; State UtxoHandle -&gt; StorableMonad UtxoHandle (State UtxoHandle)
forall (f :: * -&gt; *) h.
(Foldable f, Buffered h, PrimMonad (StorableMonad h)) =&gt;
f (StorableEvent h) -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="../../../../marconi-core/html/src"><span class="hs-identifier hs-var">insertMany</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSyncBlock -&gt; StorableEvent UtxoHandle
</span><a href="#local-6989586621679764556"><span class="hs-identifier hs-var">extractUtxosEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncBlock -&gt; StorableEvent UtxoHandle)
-&gt; [ChainSyncBlock] -&gt; [StorableEvent UtxoHandle]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainSyncBlock]
</span><a href="#local-6989586621679764559"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainIndexIndexers
</span><a href="#local-6989586621679764558"><span class="hs-identifier hs-var">ci</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexers
-&gt; Getting (State UtxoHandle) ChainIndexIndexers (State UtxoHandle)
-&gt; State UtxoHandle
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting (State UtxoHandle) ChainIndexIndexers (State UtxoHandle)
Iso' ChainIndexIndexers (State UtxoHandle)
</span><a href="Plutus.ChainIndex.Marconi.html#utxosIndexer"><span class="hs-identifier hs-var">utxosIndexer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>        </span><span class="annot"><span class="annottext">ChainIndexIndexers -&gt; Eff effs ()
forall s (effs :: [* -&gt; *]).
Member (State s) effs =&gt;
s -&gt; Eff effs ()
</span><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-var">Eff.put</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainIndexIndexers
</span><a href="#local-6989586621679764558"><span class="hs-identifier hs-var">ci</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexers
-&gt; (ChainIndexIndexers -&gt; ChainIndexIndexers) -&gt; ChainIndexIndexers
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(State UtxoHandle -&gt; Identity (State UtxoHandle))
-&gt; ChainIndexIndexers -&gt; Identity ChainIndexIndexers
Iso' ChainIndexIndexers (State UtxoHandle)
</span><a href="Plutus.ChainIndex.Marconi.html#utxosIndexer"><span class="hs-identifier hs-var">utxosIndexer</span></a></span><span> </span><span class="annot"><span class="annottext">((State UtxoHandle -&gt; Identity (State UtxoHandle))
 -&gt; ChainIndexIndexers -&gt; Identity ChainIndexIndexers)
-&gt; State UtxoHandle -&gt; ChainIndexIndexers -&gt; ChainIndexIndexers
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">.~</span></a></span><span> </span><span class="annot"><span class="annottext">State UtxoHandle
</span><a href="#local-6989586621679764557"><span class="hs-identifier hs-var">utxosIndexer'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>    </span><span id="local-6989586621679764555"><span class="annot"><span class="annottext">ChainIndexControlEffect x
</span><a href="#local-6989586621679764555"><span class="hs-identifier hs-var">_other</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainIndexError -&gt; Eff effs x
forall e (effs :: [* -&gt; *]) a.
Member (Error e) effs =&gt;
e -&gt; Eff effs a
</span><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexError
</span><a href="Plutus.ChainIndex.ChainIndexError.html#UnsupportedControlOperation"><span class="hs-identifier hs-var">UnsupportedControlOperation</span></a></span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-179"></span><span>        </span><span id="local-6989586621679764556"><span class="annot"><span class="annottext">extractUtxosEvent :: ChainSyncBlock -&gt; StorableEvent UtxoHandle
</span><a href="#local-6989586621679764556"><span class="hs-identifier hs-var hs-var">extractUtxosEvent</span></a></span></span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Types.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">{</span><span id="local-6989586621679764552"><span class="annot"><span class="annottext">Tip
blockTip :: ChainSyncBlock -&gt; Tip
blockTip :: Tip
</span><a href="Plutus.ChainIndex.Types.html#blockTip"><span class="hs-identifier hs-var hs-var">blockTip</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679764550"><span class="annot"><span class="annottext">[(ChainIndexTx, TxProcessOption)]
blockTxs :: ChainSyncBlock -&gt; [(ChainIndexTx, TxProcessOption)]
blockTxs :: [(ChainIndexTx, TxProcessOption)]
</span><a href="Plutus.ChainIndex.Types.html#blockTxs"><span class="hs-identifier hs-var hs-var">blockTxs</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-180"></span><span>            </span><span id="local-6989586621679764548"><span class="annot"><span class="annottext">point :: ChainPoint
</span><a href="#local-6989586621679764548"><span class="hs-identifier hs-var hs-var">point</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point -&gt; ChainPoint
</span><a href="Plutus.ChainIndex.Compatibility.html#toCardanoPoint"><span class="hs-identifier hs-var">toCardanoPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(Point -&gt; ChainPoint) -&gt; Point -&gt; ChainPoint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tip -&gt; Point
</span><a href="Plutus.ChainIndex.Types.html#tipAsPoint"><span class="hs-identifier hs-var">tipAsPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679764552"><span class="hs-identifier hs-var">blockTip</span></a></span><span>
</span><span id="line-181"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[CardanoTx] -&gt; ChainPoint -&gt; StorableEvent UtxoHandle
</span><a href="Plutus.ChainIndex.Marconi.html#getUtxoEvents"><span class="hs-identifier hs-var">getUtxoEvents</span></a></span><span>
</span><span id="line-182"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(ChainIndexTx, TxProcessOption)]
</span><a href="#local-6989586621679764550"><span class="hs-identifier hs-var">blockTxs</span></a></span><span> </span><span class="annot"><span class="annottext">[(ChainIndexTx, TxProcessOption)]
-&gt; Getting
     (Endo [CardanoTx]) [(ChainIndexTx, TxProcessOption)] CardanoTx
-&gt; [CardanoTx]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^..</span></a></span><span> </span><span class="annot"><span class="annottext">((ChainIndexTx, TxProcessOption)
 -&gt; Const (Endo [CardanoTx]) (ChainIndexTx, TxProcessOption))
-&gt; [(ChainIndexTx, TxProcessOption)]
-&gt; Const (Endo [CardanoTx]) [(ChainIndexTx, TxProcessOption)]
forall (f :: * -&gt; *) a. Foldable f =&gt; IndexedFold Int (f a) a
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">folded</span></a></span><span> </span><span class="annot"><span class="annottext">(((ChainIndexTx, TxProcessOption)
  -&gt; Const (Endo [CardanoTx]) (ChainIndexTx, TxProcessOption))
 -&gt; [(ChainIndexTx, TxProcessOption)]
 -&gt; Const (Endo [CardanoTx]) [(ChainIndexTx, TxProcessOption)])
-&gt; ((CardanoTx -&gt; Const (Endo [CardanoTx]) CardanoTx)
    -&gt; (ChainIndexTx, TxProcessOption)
    -&gt; Const (Endo [CardanoTx]) (ChainIndexTx, TxProcessOption))
-&gt; Getting
     (Endo [CardanoTx]) [(ChainIndexTx, TxProcessOption)] CardanoTx
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainIndexTx -&gt; Const (Endo [CardanoTx]) ChainIndexTx)
-&gt; (ChainIndexTx, TxProcessOption)
-&gt; Const (Endo [CardanoTx]) (ChainIndexTx, TxProcessOption)
forall s t a b. Field1 s t a b =&gt; Lens s t a b
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">_1</span></a></span><span> </span><span class="annot"><span class="annottext">((ChainIndexTx -&gt; Const (Endo [CardanoTx]) ChainIndexTx)
 -&gt; (ChainIndexTx, TxProcessOption)
 -&gt; Const (Endo [CardanoTx]) (ChainIndexTx, TxProcessOption))
-&gt; ((CardanoTx -&gt; Const (Endo [CardanoTx]) CardanoTx)
    -&gt; ChainIndexTx -&gt; Const (Endo [CardanoTx]) ChainIndexTx)
-&gt; (CardanoTx -&gt; Const (Endo [CardanoTx]) CardanoTx)
-&gt; (ChainIndexTx, TxProcessOption)
-&gt; Const (Endo [CardanoTx]) (ChainIndexTx, TxProcessOption)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe CardanoTx -&gt; Const (Endo [CardanoTx]) (Maybe CardanoTx))
-&gt; ChainIndexTx -&gt; Const (Endo [CardanoTx]) ChainIndexTx
Lens' ChainIndexTx (Maybe CardanoTx)
</span><a href="Plutus.ChainIndex.Types.html#citxCardanoTx"><span class="hs-identifier hs-var">citxCardanoTx</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe CardanoTx -&gt; Const (Endo [CardanoTx]) (Maybe CardanoTx))
 -&gt; ChainIndexTx -&gt; Const (Endo [CardanoTx]) ChainIndexTx)
-&gt; ((CardanoTx -&gt; Const (Endo [CardanoTx]) CardanoTx)
    -&gt; Maybe CardanoTx -&gt; Const (Endo [CardanoTx]) (Maybe CardanoTx))
-&gt; (CardanoTx -&gt; Const (Endo [CardanoTx]) CardanoTx)
-&gt; ChainIndexTx
-&gt; Const (Endo [CardanoTx]) ChainIndexTx
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(CardanoTx -&gt; Const (Endo [CardanoTx]) CardanoTx)
-&gt; Maybe CardanoTx -&gt; Const (Endo [CardanoTx]) (Maybe CardanoTx)
forall (f :: * -&gt; *) a. Foldable f =&gt; IndexedFold Int (f a) a
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">folded</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>                </span><span class="annot"><span class="annottext">ChainPoint
</span><a href="#local-6989586621679764548"><span class="hs-identifier hs-var">point</span></a></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span id="local-6989586621679764677"><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#handleQuery"><span class="hs-identifier hs-type">handleQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">LastMember</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764677"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Member</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Eff.State</span></a></span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexers"><span class="hs-identifier hs-type">ChainIndexIndexers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679764677"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Member</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Error</span></a></span><span> </span><span class="annot"><a href="Plutus.ChainIndex.ChainIndexError.html#ChainIndexError"><span class="hs-identifier hs-type">ChainIndexError</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679764677"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Effects.html#ChainIndexQueryEffect"><span class="hs-identifier hs-type">ChainIndexQueryEffect</span></a></span><span>
</span><span id="line-190"></span><span>    </span><span class="annot"><a href="../../../../natural-transformation/html/src"><span class="hs-operator hs-type">~&gt;</span></a></span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764677"><span class="hs-identifier hs-type">effs</span></a></span></span><span>
</span><span id="line-191"></span><span id="handleQuery"><span class="annot"><span class="annottext">handleQuery :: ChainIndexQueryEffect ~&gt; Eff effs
</span><a href="Plutus.ChainIndex.Marconi.html#handleQuery"><span class="hs-identifier hs-var hs-var">handleQuery</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-192"></span><span>    </span><span class="annot"><a href="Plutus.ChainIndex.Effects.html#UtxoSetAtAddress"><span class="hs-identifier hs-type">UtxoSetAtAddress</span></a></span><span> </span><span id="local-6989586621679764546"><span class="annot"><span class="annottext">PageQuery TxOutRef
</span><a href="#local-6989586621679764546"><span class="hs-identifier hs-var">pageQuery</span></a></span></span><span> </span><span id="local-6989586621679764545"><span class="annot"><span class="annottext">CardanoAddress
</span><a href="#local-6989586621679764545"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-193"></span><span>        </span><span class="annot"><span class="annottext">(MarconiEffect UtxoHandle ~&gt; Eff effs)
-&gt; Eff (MarconiEffect UtxoHandle : effs) ~&gt; Eff effs
forall (eff :: * -&gt; *) (effs :: [* -&gt; *]).
(eff ~&gt; Eff effs) -&gt; Eff (eff : effs) ~&gt; Eff effs
</span><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-var">interpret</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lens' ChainIndexIndexers (State UtxoHandle)
-&gt; MarconiEffect UtxoHandle ~&gt; Eff effs
forall (effs :: [* -&gt; *]) handle.
(LastMember IO effs, Member (State ChainIndexIndexers) effs,
 StorableMonad handle ~ IO,
 HasPoint (StorableEvent handle) (StorablePoint handle),
 Ord (StorablePoint handle), Queryable handle) =&gt;
Lens' ChainIndexIndexers (State handle)
-&gt; MarconiEffect handle ~&gt; Eff effs
</span><a href="Plutus.ChainIndex.Marconi.html#handleMarconiQuery"><span class="hs-identifier hs-var">handleMarconiQuery</span></a></span><span> </span><span class="annot"><span class="annottext">Lens' ChainIndexIndexers (State UtxoHandle)
Iso' ChainIndexIndexers (State UtxoHandle)
</span><a href="Plutus.ChainIndex.Marconi.html#utxosIndexer"><span class="hs-identifier hs-var">utxosIndexer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Eff (MarconiEffect UtxoHandle : effs) UtxosResponse
 -&gt; Eff effs UtxosResponse)
-&gt; Eff (MarconiEffect UtxoHandle : effs) UtxosResponse
-&gt; Eff effs UtxosResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PageQuery TxOutRef
-&gt; CardanoAddress
-&gt; Eff (MarconiEffect UtxoHandle : effs) UtxosResponse
forall (effs :: [* -&gt; *]).
Member (MarconiEffect UtxoHandle) effs =&gt;
PageQuery TxOutRef -&gt; CardanoAddress -&gt; Eff effs UtxosResponse
</span><a href="Plutus.ChainIndex.Marconi.html#getUtxoSetAtAddress"><span class="hs-identifier hs-var">getUtxoSetAtAddress</span></a></span><span> </span><span class="annot"><span class="annottext">PageQuery TxOutRef
</span><a href="#local-6989586621679764546"><span class="hs-identifier hs-var">pageQuery</span></a></span><span> </span><span class="annot"><span class="annottext">CardanoAddress
</span><a href="#local-6989586621679764545"><span class="hs-identifier hs-var">addr</span></a></span><span>
</span><span id="line-194"></span><span>    </span><span id="local-6989586621679764544"><span class="annot"><span class="annottext">ChainIndexQueryEffect x
</span><a href="#local-6989586621679764544"><span class="hs-identifier hs-var">_eff</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainIndexError -&gt; Eff effs x
forall e (effs :: [* -&gt; *]) a.
Member (Error e) effs =&gt;
e -&gt; Eff effs a
</span><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexError
</span><a href="Plutus.ChainIndex.ChainIndexError.html#UnsupportedQuery"><span class="hs-identifier hs-var">UnsupportedQuery</span></a></span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span class="hs-comment">-- | Handle the chain index effects from the set of all effects.</span><span>
</span><span id="line-197"></span><span id="local-6989586621679764735"><span id="local-6989586621679764737"><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#handleChainIndexEffects"><span class="hs-identifier hs-type">handleChainIndexEffects</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">LastMember</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764737"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Member</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Reader</span></a></span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Marconi.html#ChainIndexIndexersMVar"><span class="hs-identifier hs-type">ChainIndexIndexersMVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679764737"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.ChainIndex.Effects.html#ChainIndexQueryEffect"><span class="hs-identifier hs-type">ChainIndexQueryEffect</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="Plutus.ChainIndex.Effects.html#ChainIndexControlEffect"><span class="hs-identifier hs-type">ChainIndexControlEffect</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="#local-6989586621679764737"><span class="hs-identifier hs-type">effs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679764735"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-202"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-type">Eff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764737"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Plutus.ChainIndex.ChainIndexError.html#ChainIndexError"><span class="hs-identifier hs-type">ChainIndexError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679764735"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-203"></span><span id="handleChainIndexEffects"><span class="annot"><span class="annottext">handleChainIndexEffects :: Eff (ChainIndexQueryEffect : ChainIndexControlEffect : effs) a
-&gt; Eff effs (Either ChainIndexError a)
</span><a href="Plutus.ChainIndex.Marconi.html#handleChainIndexEffects"><span class="hs-identifier hs-var hs-var">handleChainIndexEffects</span></a></span></span><span> </span><span id="local-6989586621679764542"><span class="annot"><span class="annottext">Eff (ChainIndexQueryEffect : ChainIndexControlEffect : effs) a
</span><a href="#local-6989586621679764542"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-204"></span><span>    </span><span id="local-6989586621679764541"><span class="annot"><span class="annottext">ChainIndexIndexersMVar
</span><a href="#local-6989586621679764541"><span class="hs-identifier hs-var">mIndexers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff effs ChainIndexIndexersMVar
forall r (effs :: [* -&gt; *]). Member (Reader r) effs =&gt; Eff effs r
</span><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-var">ask</span></a></span><span>
</span><span id="line-205"></span><span>    </span><span id="local-6989586621679764540"><span class="annot"><span class="annottext">ChainIndexIndexers
</span><a href="#local-6989586621679764540"><span class="hs-identifier hs-var">indexers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ChainIndexIndexers -&gt; Eff effs ChainIndexIndexers
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ChainIndexIndexers -&gt; Eff effs ChainIndexIndexers)
-&gt; IO ChainIndexIndexers -&gt; Eff effs ChainIndexIndexers
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexersMVar -&gt; IO ChainIndexIndexers
</span><a href="Plutus.ChainIndex.Marconi.html#getChainIndexIndexers"><span class="hs-identifier hs-var">getChainIndexIndexers</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexersMVar
</span><a href="#local-6989586621679764541"><span class="hs-identifier hs-var">mIndexers</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679764539"><span class="annot"><span class="annottext">Either ChainIndexError a
</span><a href="#local-6989586621679764539"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679764538"><span class="annot"><span class="annottext">ChainIndexIndexers
</span><a href="#local-6989586621679764538"><span class="hs-identifier hs-var">indexers'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexers
-&gt; Eff (State ChainIndexIndexers : effs) (Either ChainIndexError a)
-&gt; Eff effs (Either ChainIndexError a, ChainIndexIndexers)
forall s (effs :: [* -&gt; *]) a.
s -&gt; Eff (State s : effs) a -&gt; Eff effs (a, s)
</span><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-var">Eff.runState</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexers
</span><a href="#local-6989586621679764540"><span class="hs-identifier hs-var">indexers</span></a></span><span>
</span><span id="line-207"></span><span>        </span><span class="annot"><span class="annottext">(Eff (State ChainIndexIndexers : effs) (Either ChainIndexError a)
 -&gt; Eff effs (Either ChainIndexError a, ChainIndexIndexers))
-&gt; Eff (State ChainIndexIndexers : effs) (Either ChainIndexError a)
-&gt; Eff effs (Either ChainIndexError a, ChainIndexIndexers)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (effs :: [* -&gt; *]) a.
Eff (Error ChainIndexError : effs) a
-&gt; Eff effs (Either ChainIndexError a)
forall e (effs :: [* -&gt; *]) a.
Eff (Error e : effs) a -&gt; Eff effs (Either e a)
</span><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-var">runError</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.ChainIndex.ChainIndexError.html#ChainIndexError"><span class="hs-identifier hs-type">ChainIndexError</span></a></span><span>
</span><span id="line-208"></span><span>        </span><span class="annot"><span class="annottext">(Eff (Error ChainIndexError : State ChainIndexIndexers : effs) a
 -&gt; Eff
      (State ChainIndexIndexers : effs) (Either ChainIndexError a))
-&gt; Eff (Error ChainIndexError : State ChainIndexIndexers : effs) a
-&gt; Eff (State ChainIndexIndexers : effs) (Either ChainIndexError a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainIndexControlEffect
 ~&gt; Eff (Error ChainIndexError : State ChainIndexIndexers : effs))
-&gt; Eff
     (ChainIndexControlEffect
        : Error ChainIndexError : State ChainIndexIndexers : effs)
   ~&gt; Eff (Error ChainIndexError : State ChainIndexIndexers : effs)
forall (eff :: * -&gt; *) (effs :: [* -&gt; *]).
(eff ~&gt; Eff effs) -&gt; Eff (eff : effs) ~&gt; Eff effs
</span><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-var">interpret</span></a></span><span> </span><span class="annot"><span class="annottext">forall (effs :: [* -&gt; *]).
(LastMember IO effs, Member (State ChainIndexIndexers) effs,
 Member (Error ChainIndexError) effs) =&gt;
ChainIndexControlEffect ~&gt; Eff effs
ChainIndexControlEffect
~&gt; Eff (Error ChainIndexError : State ChainIndexIndexers : effs)
</span><a href="Plutus.ChainIndex.Marconi.html#handleControl"><span class="hs-identifier hs-var">handleControl</span></a></span><span>
</span><span id="line-209"></span><span>        </span><span class="annot"><span class="annottext">(Eff
   (ChainIndexControlEffect
      : Error ChainIndexError : State ChainIndexIndexers : effs)
   a
 -&gt; Eff (Error ChainIndexError : State ChainIndexIndexers : effs) a)
-&gt; Eff
     (ChainIndexControlEffect
        : Error ChainIndexError : State ChainIndexIndexers : effs)
     a
-&gt; Eff (Error ChainIndexError : State ChainIndexIndexers : effs) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainIndexQueryEffect
 ~&gt; Eff
      (ChainIndexControlEffect
         : Error ChainIndexError : State ChainIndexIndexers : effs))
-&gt; Eff
     (ChainIndexQueryEffect
        : ChainIndexControlEffect : Error ChainIndexError
        : State ChainIndexIndexers : effs)
   ~&gt; Eff
        (ChainIndexControlEffect
           : Error ChainIndexError : State ChainIndexIndexers : effs)
forall (eff :: * -&gt; *) (effs :: [* -&gt; *]).
(eff ~&gt; Eff effs) -&gt; Eff (eff : effs) ~&gt; Eff effs
</span><a href="../../../../freer-simple/html/src"><span class="hs-identifier hs-var">interpret</span></a></span><span> </span><span class="annot"><span class="annottext">forall (effs :: [* -&gt; *]).
(LastMember IO effs, Member (State ChainIndexIndexers) effs,
 Member (Error ChainIndexError) effs) =&gt;
ChainIndexQueryEffect ~&gt; Eff effs
ChainIndexQueryEffect
~&gt; Eff
     (ChainIndexControlEffect
        : Error ChainIndexError : State ChainIndexIndexers : effs)
</span><a href="Plutus.ChainIndex.Marconi.html#handleQuery"><span class="hs-identifier hs-var">handleQuery</span></a></span><span>
</span><span id="line-210"></span><span>        </span><span class="annot"><span class="annottext">(Eff
   (ChainIndexQueryEffect
      : ChainIndexControlEffect : Error ChainIndexError
      : State ChainIndexIndexers : effs)
   a
 -&gt; Eff
      (ChainIndexControlEffect
         : Error ChainIndexError : State ChainIndexIndexers : effs)
      a)
-&gt; Eff
     (ChainIndexQueryEffect
        : ChainIndexControlEffect : Error ChainIndexError
        : State ChainIndexIndexers : effs)
     a
-&gt; Eff
     (ChainIndexControlEffect
        : Error ChainIndexError : State ChainIndexIndexers : effs)
     a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Eff ('[ChainIndexQueryEffect, ChainIndexControlEffect] :++: effs) a
-&gt; Eff
     ('[ChainIndexQueryEffect, ChainIndexControlEffect]
      :++: ('[Error ChainIndexError, State ChainIndexIndexers]
            :++: effs))
     a
forall (effs' :: [* -&gt; *]) (as :: [* -&gt; *]) (effs :: [* -&gt; *]).
(UnderN as, Weakens effs') =&gt;
Eff (as :++: effs) ~&gt; Eff (as :++: (effs' :++: effs))
</span><a href="../../../../freer-extras/html/src"><span class="hs-identifier hs-var">raiseMUnderN</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Eff (ChainIndexQueryEffect : ChainIndexControlEffect : effs) a
Eff ('[ChainIndexQueryEffect, ChainIndexControlEffect] :++: effs) a
</span><a href="#local-6989586621679764542"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; Eff effs ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Eff effs ()) -&gt; IO () -&gt; Eff effs ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexers -&gt; ChainIndexIndexersMVar -&gt; IO ()
</span><a href="Plutus.ChainIndex.Marconi.html#putChainIndexIndexers"><span class="hs-identifier hs-var">putChainIndexIndexers</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexers
</span><a href="#local-6989586621679764538"><span class="hs-identifier hs-var">indexers'</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexIndexersMVar
</span><a href="#local-6989586621679764541"><span class="hs-identifier hs-var">mIndexers</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span class="annot"><span class="annottext">Either ChainIndexError a -&gt; Eff effs (Either ChainIndexError a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Either ChainIndexError a
</span><a href="#local-6989586621679764539"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-213"></span></pre></body></html>